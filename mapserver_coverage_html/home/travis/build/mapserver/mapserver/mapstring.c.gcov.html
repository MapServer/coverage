<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - mapserver.info - /home/travis/build/mapserver/mapserver/mapstring.c</title>
  <link rel="stylesheet" type="text/css" href="../../../../../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../../../../../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../../../../../index.html">top level</a> - <a href="index.html">home/travis/build/mapserver/mapserver</a> - mapstring.c<span style="font-size: 80%;"> (source / <a href="mapstring.c.func.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">mapserver.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">428</td>
            <td class="headerCovTableEntry">767</td>
            <td class="headerCovTableEntryLo">55.8 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">XXXX-XX-XX</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">37</td>
            <td class="headerCovTableEntry">52</td>
            <td class="headerCovTableEntryLo">71.2 %</td>
          </tr>
          <tr>
            <td></td>
            <td></td>
            <td></td>
            <td class="headerItem">Branches:</td>
            <td class="headerCovTableEntry">277</td>
            <td class="headerCovTableEntry">574</td>
            <td class="headerCovTableEntryLo">48.3 %</td>
          </tr>
          <tr><td><img src="../../../../../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../../../../../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">           Branch data     Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>                :            : /******************************************************************************</a>
<span class="lineNum">       2 </span>                :            :  * $Id$
<span class="lineNum">       3 </span>                :            :  *
<span class="lineNum">       4 </span>                :            :  * Project:  MapServer
<span class="lineNum">       5 </span>                :            :  * Purpose:  Various string handling functions.
<span class="lineNum">       6 </span>                :            :  * Author:   Steve Lime and the MapServer team.
<span class="lineNum">       7 </span>                :            :  *
<span class="lineNum">       8 </span>                :            :  * Notes: A couple of string handling functions (strrstr, strlcat) were taken from
<span class="lineNum">       9 </span>                :            :  * other sources. Copyright notices accompany those functions below.
<span class="lineNum">      10 </span>                :            :  *
<span class="lineNum">      11 </span>                :            :  ******************************************************************************
<span class="lineNum">      12 </span>                :            :  * Copyright (c) 1996-2005 Regents of the University of Minnesota.
<span class="lineNum">      13 </span>                :            :  * Copyright (c) 1998 Todd C. Miller &lt;Todd.Miller@courtesan.com&gt;
<span class="lineNum">      14 </span>                :            :  *
<span class="lineNum">      15 </span>                :            :  * Permission is hereby granted, free of charge, to any person obtaining a
<span class="lineNum">      16 </span>                :            :  * copy of this software and associated documentation files (the &quot;Software&quot;),
<span class="lineNum">      17 </span>                :            :  * to deal in the Software without restriction, including without limitation
<span class="lineNum">      18 </span>                :            :  * the rights to use, copy, modify, merge, publish, distribute, sublicense,
<span class="lineNum">      19 </span>                :            :  * and/or sell copies of the Software, and to permit persons to whom the
<span class="lineNum">      20 </span>                :            :  * Software is furnished to do so, subject to the following conditions:
<span class="lineNum">      21 </span>                :            :  *
<span class="lineNum">      22 </span>                :            :  * The above copyright notice and this permission notice shall be included in
<span class="lineNum">      23 </span>                :            :  * all copies of this Software or works derived from this Software.
<span class="lineNum">      24 </span>                :            :  *
<span class="lineNum">      25 </span>                :            :  * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS
<span class="lineNum">      26 </span>                :            :  * OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
<span class="lineNum">      27 </span>                :            :  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL
<span class="lineNum">      28 </span>                :            :  * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
<span class="lineNum">      29 </span>                :            :  * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
<span class="lineNum">      30 </span>                :            :  * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
<span class="lineNum">      31 </span>                :            :  * DEALINGS IN THE SOFTWARE.
<span class="lineNum">      32 </span>                :            :  ****************************************************************************/
<span class="lineNum">      33 </span>                :            : 
<span class="lineNum">      34 </span>                :            : #include &quot;mapserver.h&quot;
<span class="lineNum">      35 </span>                :            : #include &quot;mapthread.h&quot;
<span class="lineNum">      36 </span>                :            : 
<span class="lineNum">      37 </span>                :            : 
<span class="lineNum">      38 </span>                :            : #include &lt;ctype.h&gt;
<span class="lineNum">      39 </span>                :            : #include &lt;string.h&gt;
<span class="lineNum">      40 </span>                :            : #include &lt;errno.h&gt;
<span class="lineNum">      41 </span>                :            : 
<span class="lineNum">      42 </span>                :            : /*
<span class="lineNum">      43 </span>                :            :  * Find the first occurrence of find in s, ignore case.
<span class="lineNum">      44 </span>                :            :  */
<span class="lineNum">      45 </span>                :            : 
<span class="lineNum">      46 </span>                :            : #ifdef USE_FRIBIDI
<span class="lineNum">      47 </span>                :            : #if (defined(_WIN32) &amp;&amp; !defined(__CYGWIN__)) || defined(HAVE_FRIBIDI2)
<span class="lineNum">      48 </span>                :            : #include &quot;fribidi.h&quot;
<span class="lineNum">      49 </span>                :            : #else
<span class="lineNum">      50 </span>                :            : #include &lt;fribidi/fribidi.h&gt;
<span class="lineNum">      51 </span>                :            : #endif
<span class="lineNum">      52 </span>                :            : #define MAX_STR_LEN 65000
<span class="lineNum">      53 </span>                :            : #endif
<span class="lineNum">      54 </span>                :            : 
<span class="lineNum">      55 </span>                :            : #ifdef USE_ICONV
<span class="lineNum">      56 </span>                :            : #include &lt;iconv.h&gt;
<span class="lineNum">      57 </span>                :            : #include &lt;wchar.h&gt;
<span class="lineNum">      58 </span>                :            : #endif
<span class="lineNum">      59 </span>                :            : 
<span class="lineNum">      60 </span>                :            : #include &quot;mapentities.h&quot;
<span class="lineNum">      61 </span>                :            : 
<span class="lineNum">      62 </span>                :            : #ifndef HAVE_STRRSTR
<span class="lineNum">      63 </span>                :            : /*
<span class="lineNum">      64 </span>                :            : ** Copyright (c) 2000-2004  University of Illinois Board of Trustees
<span class="lineNum">      65 </span>                :            : ** Copyright (c) 2000-2005  Mark D. Roth
<span class="lineNum">      66 </span>                :            : ** All rights reserved.
<span class="lineNum">      67 </span>                :            : **
<span class="lineNum">      68 </span>                :            : ** Developed by: Campus Information Technologies and Educational Services,
<span class="lineNum">      69 </span>                :            : ** University of Illinois at Urbana-Champaign
<span class="lineNum">      70 </span>                :            : **
<span class="lineNum">      71 </span>                :            : ** Permission is hereby granted, free of charge, to any person obtaining
<span class="lineNum">      72 </span>                :            : ** a copy of this software and associated documentation files (the
<span class="lineNum">      73 </span>                :            : ** ``Software''), to deal with the Software without restriction, including
<span class="lineNum">      74 </span>                :            : ** without limitation the rights to use, copy, modify, merge, publish,
<span class="lineNum">      75 </span>                :            : ** distribute, sublicense, and/or sell copies of the Software, and to
<span class="lineNum">      76 </span>                :            : ** permit persons to whom the Software is furnished to do so, subject to
<span class="lineNum">      77 </span>                :            : ** the following conditions:
<span class="lineNum">      78 </span>                :            : **
<span class="lineNum">      79 </span>                :            : ** * Redistributions of source code must retain the above copyright
<span class="lineNum">      80 </span>                :            : **   notice, this list of conditions and the following disclaimers.
<span class="lineNum">      81 </span>                :            : **
<span class="lineNum">      82 </span>                :            : ** * Redistributions in binary form must reproduce the above copyright
<span class="lineNum">      83 </span>                :            : **   notice, this list of conditions and the following disclaimers in the
<span class="lineNum">      84 </span>                :            : **   documentation and/or other materials provided with the distribution.
<span class="lineNum">      85 </span>                :            : **
<span class="lineNum">      86 </span>                :            : ** * Neither the names of Campus Information Technologies and Educational
<span class="lineNum">      87 </span>                :            : **   Services, University of Illinois at Urbana-Champaign, nor the names
<span class="lineNum">      88 </span>                :            : **   of its contributors may be used to endorse or promote products derived
<span class="lineNum">      89 </span>                :            : **   from this Software without specific prior written permission.
<span class="lineNum">      90 </span>                :            : **
<span class="lineNum">      91 </span>                :            : ** THE SOFTWARE IS PROVIDED ``AS IS'', WITHOUT WARRANTY OF ANY KIND,
<span class="lineNum">      92 </span>                :            : ** EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
<span class="lineNum">      93 </span>                :            : ** MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
<span class="lineNum">      94 </span>                :            : ** IN NO EVENT SHALL THE CONTRIBUTORS OR COPYRIGHT HOLDERS BE LIABLE FOR
<span class="lineNum">      95 </span>                :            : ** ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,
<span class="lineNum">      96 </span>                :            : ** TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE
<a name="97"><span class="lineNum">      97 </span>                :            : ** OR THE USE OR OTHER DEALINGS WITH THE SOFTWARE.</a>
<span class="lineNum">      98 </span>                :            : */
<span class="lineNum">      99 </span>                :<span class="lineCov">          1 : char *strrstr(char *string, char *find)</span>
<span class="lineNum">     100 </span>                :            : {
<span class="lineNum">     101 </span>                :            :   size_t stringlen, findlen;
<span class="lineNum">     102 </span>                :            :   char *cp;
<span class="lineNum">     103 </span>                :            : 
<span class="lineNum">     104 </span>                :<span class="lineCov">          1 :   findlen = strlen(find);</span>
<span class="lineNum">     105 </span>                :<span class="lineCov">          1 :   stringlen = strlen(string);</span>
<span class="lineNum">     106 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   if (findlen &gt; stringlen)</span>
<span class="lineNum">     107 </span>                :            :     return NULL;
<span class="lineNum">     108 </span>                :            : 
<span class="lineNum">     109 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   for (cp = string + stringlen - findlen; cp &gt;= string; cp--)</span>
<span class="lineNum">     110 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :     if (strncmp(cp, find, findlen) == 0)</span>
<span class="lineNum">     111 </span>                :            :       return cp;
<span class="lineNum">     112 </span>                :            : 
<span class="lineNum">     113 </span>                :            :   return NULL;
<span class="lineNum">     114 </span>                :            : }
<span class="lineNum">     115 </span>                :            : #endif
<span class="lineNum">     116 </span>                :            : 
<span class="lineNum">     117 </span>                :            : #ifndef HAVE_STRLCAT
<span class="lineNum">     118 </span>                :            : /*
<span class="lineNum">     119 </span>                :            :  * Copyright (c) 1998 Todd C. Miller &lt;Todd.Miller@courtesan.com&gt;
<span class="lineNum">     120 </span>                :            :  *
<span class="lineNum">     121 </span>                :            :  * Permission to use, copy, modify, and distribute this software for any
<span class="lineNum">     122 </span>                :            :  * purpose with or without fee is hereby granted, provided that the above
<span class="lineNum">     123 </span>                :            :  * copyright notice and this permission notice appear in all copies.
<span class="lineNum">     124 </span>                :            :  *
<span class="lineNum">     125 </span>                :            :  * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES
<span class="lineNum">     126 </span>                :            :  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
<span class="lineNum">     127 </span>                :            :  * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
<span class="lineNum">     128 </span>                :            :  * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
<span class="lineNum">     129 </span>                :            :  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
<span class="lineNum">     130 </span>                :            :  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
<span class="lineNum">     131 </span>                :            :  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
<span class="lineNum">     132 </span>                :            :  */
<span class="lineNum">     133 </span>                :            : 
<span class="lineNum">     134 </span>                :            : /*
<span class="lineNum">     135 </span>                :            :  * Appends src to string dst of size siz (unlike strncat, siz is the
<span class="lineNum">     136 </span>                :            :  * full size of dst, not space left).  At most siz-1 characters
<span class="lineNum">     137 </span>                :            :  * will be copied.  Always NUL terminates (unless siz &lt;= strlen(dst)).
<span class="lineNum">     138 </span>                :            :  * Returns strlen(src) + MIN(siz, strlen(initial dst)).
<a name="139"><span class="lineNum">     139 </span>                :            :  * If retval &gt;= siz, truncation occurred.</a>
<span class="lineNum">     140 </span>                :            :  */
<span class="lineNum">     141 </span>                :<span class="lineCov">          1 : size_t strlcat(char *dst, const char *src, size_t siz)</span>
<span class="lineNum">     142 </span>                :            : {
<span class="lineNum">     143 </span>                :            :   register char *d = dst;
<span class="lineNum">     144 </span>                :            :   register const char *s = src;
<span class="lineNum">     145 </span>                :            :   register size_t n = siz;
<span class="lineNum">     146 </span>                :            :   size_t dlen;
<span class="lineNum">     147 </span>                :            : 
<span class="lineNum">     148 </span>                :            :   /* Find the end of dst and adjust bytes left but don't go past end */
<span class="lineNum">     149 </span>[<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken X times"> + </span><span class="branchCov" title="Branch 3 was taken X times"> + </span>]:<span class="lineCov">          1 :   while (n-- != 0 &amp;&amp; *d != '\0')</span>
<span class="lineNum">     150 </span>                :<span class="lineCov">          1 :     d++;</span>
<span class="lineNum">     151 </span>                :<span class="lineCov">          1 :   dlen = d - dst;</span>
<span class="lineNum">     152 </span>                :<span class="lineCov">          1 :   n = siz - dlen;</span>
<span class="lineNum">     153 </span>                :            : 
<span class="lineNum">     154 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   if (n == 0)</span>
<span class="lineNum">     155 </span>                :<span class="lineNoCov">          0 :     return(dlen + strlen(s));</span>
<span class="lineNum">     156 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :   while (*s != '\0') {</span>
<span class="lineNum">     157 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :     if (n != 1) {</span>
<span class="lineNum">     158 </span>                :<span class="lineCov">          1 :       *d++ = *s;</span>
<span class="lineNum">     159 </span>                :<span class="lineCov">          1 :       n--;</span>
<span class="lineNum">     160 </span>                :            :     }
<span class="lineNum">     161 </span>                :<span class="lineCov">          1 :     s++;</span>
<span class="lineNum">     162 </span>                :            :   }
<span class="lineNum">     163 </span>                :<span class="lineCov">          1 :   *d = '\0';</span>
<span class="lineNum">     164 </span>                :            : 
<span class="lineNum">     165 </span>                :<span class="lineCov">          1 :   return(dlen + (s - src));/* count does not include NUL */</span>
<span class="lineNum">     166 </span>                :            : }
<span class="lineNum">     167 </span>                :            : #endif
<span class="lineNum">     168 </span>                :            : 
<span class="lineNum">     169 </span>                :            : #ifndef HAVE_STRLCPY
<span class="lineNum">     170 </span>                :            : /*
<span class="lineNum">     171 </span>                :            :  * Copyright (c) 1998 Todd C. Miller &lt;Todd.Miller@courtesan.com&gt;
<span class="lineNum">     172 </span>                :            :  * All rights reserved.
<span class="lineNum">     173 </span>                :            :  *
<span class="lineNum">     174 </span>                :            :  * Redistribution and use in source and binary forms, with or without
<span class="lineNum">     175 </span>                :            :  * modification, are permitted provided that the following conditions
<span class="lineNum">     176 </span>                :            :  * are met:
<span class="lineNum">     177 </span>                :            :  * 1. Redistributions of source code must retain the above copyright
<span class="lineNum">     178 </span>                :            :  *    notice, this list of conditions and the following disclaimer.
<span class="lineNum">     179 </span>                :            :  * 2. Redistributions in binary form must reproduce the above copyright
<span class="lineNum">     180 </span>                :            :  *    notice, this list of conditions and the following disclaimer in the
<span class="lineNum">     181 </span>                :            :  *    documentation and/or other materials provided with the distribution.
<span class="lineNum">     182 </span>                :            :  * 3. The name of the author may not be used to endorse or promote products
<span class="lineNum">     183 </span>                :            :  *    derived from this software without specific prior written permission.
<span class="lineNum">     184 </span>                :            :  *
<span class="lineNum">     185 </span>                :            :  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES,
<span class="lineNum">     186 </span>                :            :  * INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY
<span class="lineNum">     187 </span>                :            :  * AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL
<span class="lineNum">     188 </span>                :            :  * THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
<span class="lineNum">     189 </span>                :            :  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
<span class="lineNum">     190 </span>                :            :  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;
<span class="lineNum">     191 </span>                :            :  * OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
<span class="lineNum">     192 </span>                :            :  * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
<span class="lineNum">     193 </span>                :            :  * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
<span class="lineNum">     194 </span>                :            :  * ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
<span class="lineNum">     195 </span>                :            :  */
<span class="lineNum">     196 </span>                :            : 
<span class="lineNum">     197 </span>                :            : /*
<span class="lineNum">     198 </span>                :            :  * Copy src to string dst of size siz.  At most siz-1 characters
<span class="lineNum">     199 </span>                :            :  * will be copied.  Always NUL terminates (unless siz == 0).
<span class="lineNum">     200 </span>                :            :  * Returns strlen(src); if retval &gt;= siz, truncation occurred.
<a name="201"><span class="lineNum">     201 </span>                :            :  */</a>
<span class="lineNum">     202 </span>                :            : size_t
<span class="lineNum">     203 </span>                :<span class="lineCov">          1 : strlcpy(char *dst, const char *src, size_t siz)</span>
<span class="lineNum">     204 </span>                :            : {
<span class="lineNum">     205 </span>                :            :   register char *d = dst;
<span class="lineNum">     206 </span>                :            :   register const char *s = src;
<span class="lineNum">     207 </span>                :            :   register size_t n = siz;
<span class="lineNum">     208 </span>                :            : 
<span class="lineNum">     209 </span>                :            :   /* Copy as many bytes as will fit */
<span class="lineNum">     210 </span>[<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken X times"> + </span><span class="branchCov" title="Branch 3 was taken X times"> + </span>]:<span class="lineCov">          1 :   if (n != 0 &amp;&amp; --n != 0) {</span>
<span class="lineNum">     211 </span>                :            :     do {
<span class="lineNum">     212 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :       if ((*d++ = *s++) == 0)</span>
<span class="lineNum">     213 </span>                :            :         break;
<span class="lineNum">     214 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :     } while (--n != 0);</span>
<span class="lineNum">     215 </span>                :            :   }
<span class="lineNum">     216 </span>                :            : 
<span class="lineNum">     217 </span>                :            :   /* Not enough room in dst, add NUL and traverse rest of src */
<span class="lineNum">     218 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :   if (n == 0) {</span>
<span class="lineNum">     219 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :     if (siz != 0)</span>
<span class="lineNum">     220 </span>                :<span class="lineCov">          1 :       *d = '\0';              /* NUL-terminate dst */</span>
<span class="lineNum">     221 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :     while (*s++)</span>
<span class="lineNum">     222 </span>                :            :       ;
<span class="lineNum">     223 </span>                :            :   }
<span class="lineNum">     224 </span>                :            : 
<span class="lineNum">     225 </span>                :<span class="lineCov">          1 :   return(s - src - 1);    /* count does not include NUL */</span>
<span class="lineNum">     226 </span>                :            : }
<span class="lineNum">     227 </span>                :            : #endif
<span class="lineNum">     228 </span>                :            : 
<span class="lineNum">     229 </span>                :            : #ifndef HAVE_STRCASESTR
<span class="lineNum">     230 </span>                :            : /*-
<span class="lineNum">     231 </span>                :            :  * Copyright (c) 1990, 1993
<span class="lineNum">     232 </span>                :            :  *  The Regents of the University of California.  All rights reserved.
<span class="lineNum">     233 </span>                :            :  *
<span class="lineNum">     234 </span>                :            :  * This code is derived from software contributed to Berkeley by
<span class="lineNum">     235 </span>                :            :  * Chris Torek.
<span class="lineNum">     236 </span>                :            :  *
<span class="lineNum">     237 </span>                :            :  * Redistribution and use in source and binary forms, with or without
<span class="lineNum">     238 </span>                :            :  * modification, are permitted provided that the following conditions
<span class="lineNum">     239 </span>                :            :  * are met:
<span class="lineNum">     240 </span>                :            :  * 1. Redistributions of source code must retain the above copyright
<span class="lineNum">     241 </span>                :            :  *    notice, this list of conditions and the following disclaimer.
<span class="lineNum">     242 </span>                :            :  * 2. Redistributions in binary form must reproduce the above copyright
<span class="lineNum">     243 </span>                :            :  *    notice, this list of conditions and the following disclaimer in the
<span class="lineNum">     244 </span>                :            :  *    documentation and/or other materials provided with the distribution.
<span class="lineNum">     245 </span>                :            :  * 3. Neither the name of the University nor the names of its contributors
<span class="lineNum">     246 </span>                :            :  *    may be used to endorse or promote products derived from this software
<span class="lineNum">     247 </span>                :            :  *    without specific prior written permission.
<span class="lineNum">     248 </span>                :            :  *
<span class="lineNum">     249 </span>                :            :  * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
<span class="lineNum">     250 </span>                :            :  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
<span class="lineNum">     251 </span>                :            :  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
<span class="lineNum">     252 </span>                :            :  * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
<span class="lineNum">     253 </span>                :            :  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
<span class="lineNum">     254 </span>                :            :  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
<span class="lineNum">     255 </span>                :            :  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
<span class="lineNum">     256 </span>                :            :  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
<span class="lineNum">     257 </span>                :            :  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
<span class="lineNum">     258 </span>                :            :  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<span class="lineNum">     259 </span>                :            :  * SUCH DAMAGE.
<span class="lineNum">     260 </span>                :            :  */
<span class="lineNum">     261 </span>                :            : char *strcasestr(const char *s, const char *find)
<span class="lineNum">     262 </span>                :            : {
<span class="lineNum">     263 </span>                :            :   char c, sc;
<span class="lineNum">     264 </span>                :            :   size_t len;
<span class="lineNum">     265 </span>                :            : 
<span class="lineNum">     266 </span>                :            :   if ((c = *find++) != 0) {
<span class="lineNum">     267 </span>                :            :     c = tolower((unsigned char)c);
<span class="lineNum">     268 </span>                :            :     len = strlen(find);
<span class="lineNum">     269 </span>                :            :     do {
<span class="lineNum">     270 </span>                :            :       do {
<span class="lineNum">     271 </span>                :            :         if ((sc = *s++) == 0)
<span class="lineNum">     272 </span>                :            :           return (NULL);
<span class="lineNum">     273 </span>                :            :       } while ((char)tolower((unsigned char)sc) != c);
<span class="lineNum">     274 </span>                :            :     } while (strncasecmp(s, find, len) != 0);
<span class="lineNum">     275 </span>                :            :     s--;
<span class="lineNum">     276 </span>                :            :   }
<span class="lineNum">     277 </span>                :            :   return ((char *)s);
<span class="lineNum">     278 </span>                :            : }
<span class="lineNum">     279 </span>                :            : #endif
<span class="lineNum">     280 </span>                :            : 
<span class="lineNum">     281 </span>                :            : #ifndef HAVE_STRDUP
<span class="lineNum">     282 </span>                :            : char  *strdup(char *s)
<span class="lineNum">     283 </span>                :            : {
<span class="lineNum">     284 </span>                :            :   char  *s1;
<span class="lineNum">     285 </span>                :            : 
<span class="lineNum">     286 </span>                :            :   if(!s)
<span class="lineNum">     287 </span>                :            :     return(NULL);
<span class="lineNum">     288 </span>                :            :   s1 = (char *)malloc(strlen(s) + 1);
<span class="lineNum">     289 </span>                :            :   if(!s1)
<span class="lineNum">     290 </span>                :            :     return(NULL);
<span class="lineNum">     291 </span>                :            : 
<span class="lineNum">     292 </span>                :            :   strcpy(s1,s);
<span class="lineNum">     293 </span>                :            :   return(s1);
<span class="lineNum">     294 </span>                :            : }
<span class="lineNum">     295 </span>                :            : #endif
<span class="lineNum">     296 </span>                :            : 
<span class="lineNum">     297 </span>                :            : #ifndef HAVE_STRNCASECMP
<span class="lineNum">     298 </span>                :            : int strncasecmp(const char *s1, const char *s2, int len)
<span class="lineNum">     299 </span>                :            : {
<span class="lineNum">     300 </span>                :            :   register const char *cp1, *cp2;
<span class="lineNum">     301 </span>                :            :   int cmp = 0;
<span class="lineNum">     302 </span>                :            : 
<span class="lineNum">     303 </span>                :            :   cp1 = s1;
<span class="lineNum">     304 </span>                :            :   cp2 = s2;
<span class="lineNum">     305 </span>                :            : 
<span class="lineNum">     306 </span>                :            :   if(len == 0)
<span class="lineNum">     307 </span>                :            :     return(0);
<span class="lineNum">     308 </span>                :            : 
<span class="lineNum">     309 </span>                :            :   if (!*cp1)
<span class="lineNum">     310 </span>                :            :     return -1;
<span class="lineNum">     311 </span>                :            :   else if (!*cp2)
<span class="lineNum">     312 </span>                :            :     return 1;
<span class="lineNum">     313 </span>                :            : 
<span class="lineNum">     314 </span>                :            :   while(*cp1 &amp;&amp; *cp2 &amp;&amp; len) {
<span class="lineNum">     315 </span>                :            :     if((cmp = (toupper(*cp1) - toupper(*cp2))) != 0)
<span class="lineNum">     316 </span>                :            :       return(cmp);
<span class="lineNum">     317 </span>                :            :     cp1++;
<span class="lineNum">     318 </span>                :            :     cp2++;
<span class="lineNum">     319 </span>                :            :     len--;
<span class="lineNum">     320 </span>                :            :   }
<span class="lineNum">     321 </span>                :            : 
<span class="lineNum">     322 </span>                :            :   if(len == 0) {
<span class="lineNum">     323 </span>                :            :     return(0);
<span class="lineNum">     324 </span>                :            :   }
<span class="lineNum">     325 </span>                :            :   if(*cp1 || *cp2) {
<span class="lineNum">     326 </span>                :            :     if (*cp1)
<span class="lineNum">     327 </span>                :            :       return(1);
<span class="lineNum">     328 </span>                :            :     else
<span class="lineNum">     329 </span>                :            :       return (-1);
<span class="lineNum">     330 </span>                :            :   }
<span class="lineNum">     331 </span>                :            :   return(0);
<span class="lineNum">     332 </span>                :            : }
<span class="lineNum">     333 </span>                :            : #endif
<span class="lineNum">     334 </span>                :            : 
<span class="lineNum">     335 </span>                :            : #ifndef HAVE_STRCASECMP
<span class="lineNum">     336 </span>                :            : int strcasecmp(const char *s1, const char *s2)
<span class="lineNum">     337 </span>                :            : {
<span class="lineNum">     338 </span>                :            :   register const char *cp1, *cp2;
<span class="lineNum">     339 </span>                :            :   int cmp = 0;
<span class="lineNum">     340 </span>                :            : 
<span class="lineNum">     341 </span>                :            :   cp1 = s1;
<span class="lineNum">     342 </span>                :            :   cp2 = s2;
<span class="lineNum">     343 </span>                :            :   if ((!cp1) || (!cp2 )) {
<span class="lineNum">     344 </span>                :            :     return (0);
<span class="lineNum">     345 </span>                :            :   }
<span class="lineNum">     346 </span>                :            :   while(*cp1 &amp;&amp; *cp2) {
<span class="lineNum">     347 </span>                :            :     if((cmp = (toupper(*cp1) - toupper(*cp2))) != 0)
<span class="lineNum">     348 </span>                :            :       return(cmp);
<span class="lineNum">     349 </span>                :            :     cp1++;
<span class="lineNum">     350 </span>                :            :     cp2++;
<span class="lineNum">     351 </span>                :            :   }
<span class="lineNum">     352 </span>                :            :   if(*cp1 || *cp2) {
<span class="lineNum">     353 </span>                :            :     if (*cp1)
<span class="lineNum">     354 </span>                :            :       return(1);
<span class="lineNum">     355 </span>                :            :     else
<span class="lineNum">     356 </span>                :            :       return (-1);
<span class="lineNum">     357 </span>                :            :   }
<span class="lineNum">     358 </span>                :            : 
<span class="lineNum">     359 </span>                :            :   return(0);
<span class="lineNum">     360 </span>                :            : }
<a name="361"><span class="lineNum">     361 </span>                :            : #endif</a>
<span class="lineNum">     362 </span>                :            : 
<span class="lineNum">     363 </span>                :<span class="lineNoCov">          0 : char *msLongToString(long value)</span>
<span class="lineNum">     364 </span>                :            : {
<span class="lineNum">     365 </span>                :            :   size_t bufferSize = 256;
<span class="lineNum">     366 </span>                :<span class="lineNoCov">          0 :   char *buffer = (char*)msSmallMalloc(bufferSize);</span>
<span class="lineNum">     367 </span>                :            : 
<span class="lineNum">     368 </span>                :            :   snprintf(buffer, bufferSize, &quot;%ld&quot;, value);
<span class="lineNum">     369 </span>                :<span class="lineNoCov">          0 :   return(buffer);</span>
<a name="370"><span class="lineNum">     370 </span>                :            : }</a>
<span class="lineNum">     371 </span>                :            : 
<span class="lineNum">     372 </span>                :<span class="lineCov">          1 : char *msDoubleToString(double value, int force_f)</span>
<span class="lineNum">     373 </span>                :            : {
<span class="lineNum">     374 </span>                :            :   size_t bufferSize = 256;
<span class="lineNum">     375 </span>                :<span class="lineCov">          1 :   char *buffer = (char*)msSmallMalloc(bufferSize);</span>
<span class="lineNum">     376 </span>                :            : 
<span class="lineNum">     377 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   if (force_f == MS_TRUE)</span>
<span class="lineNum">     378 </span>                :            :     snprintf(buffer, bufferSize, &quot;%f&quot;, value);
<span class="lineNum">     379 </span>                :            :   else
<span class="lineNum">     380 </span>                :            :     snprintf(buffer, bufferSize, &quot;%g&quot;, value);
<span class="lineNum">     381 </span>                :<span class="lineCov">          1 :   return(buffer);</span>
<a name="382"><span class="lineNum">     382 </span>                :            : }</a>
<span class="lineNum">     383 </span>                :            : 
<span class="lineNum">     384 </span>                :<span class="lineCov">          1 : char *msIntToString(int value)</span>
<span class="lineNum">     385 </span>                :            : {
<span class="lineNum">     386 </span>                :            :   size_t bufferSize = 256;
<span class="lineNum">     387 </span>                :<span class="lineCov">          1 :   char *buffer = (char*)msSmallMalloc(bufferSize);</span>
<span class="lineNum">     388 </span>                :            : 
<span class="lineNum">     389 </span>                :            :   snprintf(buffer, bufferSize, &quot;%i&quot;, value);
<span class="lineNum">     390 </span>                :<span class="lineCov">          1 :   return(buffer);</span>
<a name="391"><span class="lineNum">     391 </span>                :            : }</a>
<span class="lineNum">     392 </span>                :            : 
<span class="lineNum">     393 </span>                :<span class="lineNoCov">          0 : void msStringToUpper(char *string)</span>
<span class="lineNum">     394 </span>                :            : {
<span class="lineNum">     395 </span>                :            :   int i;
<span class="lineNum">     396 </span>                :            : 
<span class="lineNum">     397 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :   if (string != NULL) {</span>
<span class="lineNum">     398 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     for (i = 0; i &lt; strlen(string); i++) {</span>
<span class="lineNum">     399 </span>                :<span class="lineNoCov">          0 :       string[i] = toupper(string[i]);</span>
<span class="lineNum">     400 </span>                :            :     }
<span class="lineNum">     401 </span>                :<span class="lineNoCov">          0 :     return;</span>
<span class="lineNum">     402 </span>                :            :   }
<a name="403"><span class="lineNum">     403 </span>                :            : }</a>
<span class="lineNum">     404 </span>                :            : 
<span class="lineNum">     405 </span>                :<span class="lineCov">          1 : void msStringToLower(char *string)</span>
<span class="lineNum">     406 </span>                :            : {
<span class="lineNum">     407 </span>                :            :   int i;
<span class="lineNum">     408 </span>                :            : 
<span class="lineNum">     409 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   if (string != NULL) {</span>
<span class="lineNum">     410 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :     for (i = 0; i &lt; strlen(string); i++) {</span>
<span class="lineNum">     411 </span>                :<span class="lineCov">          1 :       string[i] = tolower(string[i]);</span>
<span class="lineNum">     412 </span>                :            :     }
<span class="lineNum">     413 </span>                :<span class="lineCov">          1 :     return;</span>
<span class="lineNum">     414 </span>                :            :   }
<span class="lineNum">     415 </span>                :            : }
<span class="lineNum">     416 </span>                :            : 
<span class="lineNum">     417 </span>                :            : /**
<span class="lineNum">     418 </span>                :            :  * Force the first character to uppercase and the rest of the characters to
<a name="419"><span class="lineNum">     419 </span>                :            :  * lower case for EACH word in the string.</a>
<span class="lineNum">     420 </span>                :            :  */
<span class="lineNum">     421 </span>                :<span class="lineNoCov">          0 : void msStringInitCap(char *string)</span>
<span class="lineNum">     422 </span>                :            : {
<span class="lineNum">     423 </span>                :            :   int i;
<span class="lineNum">     424 </span>                :            :   int start = 1; 
<span class="lineNum">     425 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :   if (string != NULL) {</span>
<span class="lineNum">     426 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     for (i = 0; i &lt; (int)strlen(string); i++) {</span>
<span class="lineNum">     427 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :       if (string[i] == ' ')</span>
<span class="lineNum">     428 </span>                :            :         start = 1;
<span class="lineNum">     429 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :       else if (start) {</span>
<span class="lineNum">     430 </span>                :<span class="lineNoCov">          0 :         string[i] = toupper(string[i]);</span>
<span class="lineNum">     431 </span>                :            :         start = 0;
<span class="lineNum">     432 </span>                :            :       }
<span class="lineNum">     433 </span>                :            :       else {
<span class="lineNum">     434 </span>                :<span class="lineNoCov">          0 :         string[i] = tolower(string[i]);</span>
<span class="lineNum">     435 </span>                :            :       }
<span class="lineNum">     436 </span>                :            :     }
<span class="lineNum">     437 </span>                :            :   }
<span class="lineNum">     438 </span>                :<span class="lineNoCov">          0 : }</span>
<span class="lineNum">     439 </span>                :            : 
<span class="lineNum">     440 </span>                :            : /**
<span class="lineNum">     441 </span>                :            :  * Force the first character to uppercase for the FIRST word in the string
<a name="442"><span class="lineNum">     442 </span>                :            :  * and the rest of the characters to lower case.</a>
<span class="lineNum">     443 </span>                :            :  */
<span class="lineNum">     444 </span>                :<span class="lineNoCov">          0 : void msStringFirstCap(char *string)</span>
<span class="lineNum">     445 </span>                :            : {
<span class="lineNum">     446 </span>                :            :   int i;
<span class="lineNum">     447 </span>                :            :   int start = 1; 
<span class="lineNum">     448 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :   if (string != NULL) {</span>
<span class="lineNum">     449 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     for (i = 0; i &lt; (int)strlen(string); i++) {</span>
<span class="lineNum">     450 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :       if (string[i] != ' ') {</span>
<span class="lineNum">     451 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if (start) {</span>
<span class="lineNum">     452 </span>                :<span class="lineNoCov">          0 :           string[i] = toupper(string[i]);</span>
<span class="lineNum">     453 </span>                :            :           start = 0;
<span class="lineNum">     454 </span>                :            :         }
<span class="lineNum">     455 </span>                :            :         else
<span class="lineNum">     456 </span>                :<span class="lineNoCov">          0 :           string[i] = tolower(string[i]);</span>
<span class="lineNum">     457 </span>                :            :       }
<span class="lineNum">     458 </span>                :            :     }
<span class="lineNum">     459 </span>                :            :   }
<a name="460"><span class="lineNum">     460 </span>                :<span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     461 </span>                :            : 
<span class="lineNum">     462 </span>                :<span class="lineNoCov">          0 : char *msStringChop(char *string)</span>
<span class="lineNum">     463 </span>                :            : {
<span class="lineNum">     464 </span>                :            :   int n;
<span class="lineNum">     465 </span>                :            : 
<span class="lineNum">     466 </span>                :<span class="lineNoCov">          0 :   n = strlen(string);</span>
<span class="lineNum">     467 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :   if(n&gt;0)</span>
<span class="lineNum">     468 </span>                :<span class="lineNoCov">          0 :     string[n-1] = '\0';</span>
<span class="lineNum">     469 </span>                :            : 
<span class="lineNum">     470 </span>                :<span class="lineNoCov">          0 :   return(string);</span>
<span class="lineNum">     471 </span>                :            : }
<span class="lineNum">     472 </span>                :            : 
<span class="lineNum">     473 </span>                :            : /*
<a name="474"><span class="lineNum">     474 </span>                :            : ** Trim leading and trailing white space.</a>
<span class="lineNum">     475 </span>                :            : */
<span class="lineNum">     476 </span>                :<span class="lineCov">          1 : void msStringTrim(char *str)</span>
<span class="lineNum">     477 </span>                :            : {
<span class="lineNum">     478 </span>                :            :   int i;
<span class="lineNum">     479 </span>                :            : 
<span class="lineNum">     480 </span>                :            :   /* Send nulls home without supper. */
<span class="lineNum">     481 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   if( ! str ) return;</span>
<span class="lineNum">     482 </span>                :            : 
<span class="lineNum">     483 </span>                :            :   /* Move non-white string to the front. */
<span class="lineNum">     484 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   i = strspn(str, &quot; &quot;);</span>
<span class="lineNum">     485 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :   if(i) {</span>
<span class="lineNum">     486 </span>                :<span class="lineCov">          1 :     memmove(str, str + i, strlen(str) - i + 1);</span>
<span class="lineNum">     487 </span>                :            :   }
<span class="lineNum">     488 </span>                :            :   /* Nothing left? Exit. */
<span class="lineNum">     489 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   if(strlen(str) == 0) {</span>
<span class="lineNum">     490 </span>                :            :     return;
<span class="lineNum">     491 </span>                :            :   }
<span class="lineNum">     492 </span>                :            :   /* Null-terminate end of non-white string. */
<span class="lineNum">     493 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   for(i=strlen(str)-1; i&gt;=0; i--) { /* step backwards from end */</span>
<span class="lineNum">     494 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :     if(str[i] != ' ') {</span>
<span class="lineNum">     495 </span>                :<span class="lineCov">          1 :       str[i+1] = '\0';</span>
<span class="lineNum">     496 </span>                :<span class="lineCov">          1 :       return;</span>
<span class="lineNum">     497 </span>                :            :     }
<span class="lineNum">     498 </span>                :            :   }
<span class="lineNum">     499 </span>                :            :   return;
<span class="lineNum">     500 </span>                :            : }
<span class="lineNum">     501 </span>                :            : 
<span class="lineNum">     502 </span>                :            : /*
<a name="503"><span class="lineNum">     503 </span>                :            : ** Remove leading white spaces and shift everything to the left.</a>
<span class="lineNum">     504 </span>                :            : */
<span class="lineNum">     505 </span>                :<span class="lineCov">          1 : char *msStringTrimLeft(char *string)</span>
<span class="lineNum">     506 </span>                :            : {
<span class="lineNum">     507 </span>                :            :   char *read, *write;
<span class="lineNum">     508 </span>                :            :   int i, length;
<span class="lineNum">     509 </span>                :            : 
<span class="lineNum">     510 </span>[<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken X times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          1 :   if (string &amp;&amp; strlen(string) &gt; 0) {</span>
<span class="lineNum">     511 </span>                :<span class="lineCov">          1 :     length = strlen(string);</span>
<span class="lineNum">     512 </span>                :            :     read = string;
<span class="lineNum">     513 </span>                :            :     write = string;
<span class="lineNum">     514 </span>                :            : 
<span class="lineNum">     515 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :     for (i=0; i&lt;length; i++) {</span>
<span class="lineNum">     516 </span>        [<span class="branchNoCov" title="Branch 1 was not taken"> - </span><span class="branchCov" title="Branch 2 was taken X times"> + </span>]:<span class="lineCov">          1 :       if (isspace(string[i]))</span>
<span class="lineNum">     517 </span>                :<span class="lineNoCov">          0 :         read++;</span>
<span class="lineNum">     518 </span>                :            :       else
<span class="lineNum">     519 </span>                :            :         break;
<span class="lineNum">     520 </span>                :            :     }
<span class="lineNum">     521 </span>                :            : 
<span class="lineNum">     522 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :     if (read &gt; write) {</span>
<span class="lineNum">     523 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :       while (*read) {</span>
<span class="lineNum">     524 </span>                :<span class="lineNoCov">          0 :         *write = *read;</span>
<span class="lineNum">     525 </span>                :<span class="lineNoCov">          0 :         read++;</span>
<span class="lineNum">     526 </span>                :<span class="lineNoCov">          0 :         write++;</span>
<span class="lineNum">     527 </span>                :            :       }
<span class="lineNum">     528 </span>                :<span class="lineNoCov">          0 :       *write = '\0';</span>
<span class="lineNum">     529 </span>                :            :     }
<span class="lineNum">     530 </span>                :            :   }
<span class="lineNum">     531 </span>                :<span class="lineCov">          1 :   return string;</span>
<span class="lineNum">     532 </span>                :            : }
<span class="lineNum">     533 </span>                :            : 
<span class="lineNum">     534 </span>                :            : /* ------------------------------------------------------------------------------- */
<a name="535"><span class="lineNum">     535 </span>                :            : /*       Trims trailing blanks from a string                                        */</a>
<span class="lineNum">     536 </span>                :            : /* ------------------------------------------------------------------------------- */
<span class="lineNum">     537 </span>                :<span class="lineCov">          1 : void msStringTrimBlanks(char *string)</span>
<span class="lineNum">     538 </span>                :            : {
<span class="lineNum">     539 </span>                :            :   int i,n;
<span class="lineNum">     540 </span>                :            : 
<span class="lineNum">     541 </span>                :<span class="lineCov">          1 :   n = strlen(string);</span>
<span class="lineNum">     542 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :   for(i=n-1; i&gt;=0; i--) { /* step backwards through the string */</span>
<span class="lineNum">     543 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :     if(string[i] != ' ') {</span>
<span class="lineNum">     544 </span>                :<span class="lineCov">          1 :       string[i+1] = '\0';</span>
<span class="lineNum">     545 </span>                :<span class="lineCov">          1 :       return;</span>
<span class="lineNum">     546 </span>                :            :     }
<span class="lineNum">     547 </span>                :            :   }
<span class="lineNum">     548 </span>                :            : }
<span class="lineNum">     549 </span>                :            : 
<span class="lineNum">     550 </span>                :            : /* ------------------------------------------------------------------------------- */
<span class="lineNum">     551 </span>                :            : /*       Trims end-of-line marker from a string                                    */
<a name="552"><span class="lineNum">     552 </span>                :            : /*       Usefull in conjunction with fgets() calls                                 */</a>
<span class="lineNum">     553 </span>                :            : /* ------------------------------------------------------------------------------- */
<span class="lineNum">     554 </span>                :<span class="lineNoCov">          0 : void msStringTrimEOL(char *string)</span>
<span class="lineNum">     555 </span>                :            : {
<span class="lineNum">     556 </span>                :            :   int i;
<span class="lineNum">     557 </span>                :            : 
<span class="lineNum">     558 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :   for(i=0 ; string[i] != '\0'; i++) {</span>
<span class="lineNum">     559 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(string[i] == '\n') {</span>
<span class="lineNum">     560 </span>                :<span class="lineNoCov">          0 :       string[i] = '\0'; /* Terminate the string at the newline */</span>
<span class="lineNum">     561 </span>                :<span class="lineNoCov">          0 :       return;</span>
<span class="lineNum">     562 </span>                :            :     }
<span class="lineNum">     563 </span>                :            :   }
<span class="lineNum">     564 </span>                :            : }
<span class="lineNum">     565 </span>                :            : 
<span class="lineNum">     566 </span>                :            : /* ------------------------------------------------------------------------------- */
<span class="lineNum">     567 </span>                :            : /*       Replace all occurances of old with new in str.                            */
<a name="568"><span class="lineNum">     568 </span>                :            : /*       It is assumed that str was dynamically created using malloc.              */</a>
<span class="lineNum">     569 </span>                :            : /* ------------------------------------------------------------------------------- */
<span class="lineNum">     570 </span>                :<span class="lineCov">          1 : char *msReplaceSubstring(char *str, const char *old, const char *new)</span>
<span class="lineNum">     571 </span>                :            : {
<span class="lineNum">     572 </span>                :            :   size_t str_len, old_len, new_len, tmp_offset;
<span class="lineNum">     573 </span>                :            :   char *tmp_ptr;
<span class="lineNum">     574 </span>                :            : 
<span class="lineNum">     575 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :   if(new == NULL)</span>
<span class="lineNum">     576 </span>                :            :     new = &quot;&quot;;
<span class="lineNum">     577 </span>                :            : 
<span class="lineNum">     578 </span>                :            :   /*
<span class="lineNum">     579 </span>                :            :   ** If old is not found then leave str alone
<span class="lineNum">     580 </span>                :            :   */
<span class="lineNum">     581 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :   if( (tmp_ptr = strstr(str, old)) == NULL)</span>
<span class="lineNum">     582 </span>                :            :     return(str);
<span class="lineNum">     583 </span>                :            : 
<span class="lineNum">     584 </span>                :            :   /*
<span class="lineNum">     585 </span>                :            :   ** Grab some info about incoming strings
<span class="lineNum">     586 </span>                :            :   */
<span class="lineNum">     587 </span>                :<span class="lineCov">          1 :   str_len = strlen(str);</span>
<span class="lineNum">     588 </span>                :<span class="lineCov">          1 :   old_len = strlen(old);</span>
<span class="lineNum">     589 </span>                :<span class="lineCov">          1 :   new_len = strlen(new);</span>
<span class="lineNum">     590 </span>                :            : 
<span class="lineNum">     591 </span>                :            :   /*
<span class="lineNum">     592 </span>                :            :   ** Now loop until old is NOT found in new
<span class="lineNum">     593 </span>                :            :   */
<span class="lineNum">     594 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :   while( tmp_ptr != NULL ) {</span>
<span class="lineNum">     595 </span>                :            : 
<span class="lineNum">     596 </span>                :            :     /*
<span class="lineNum">     597 </span>                :            :     ** re-allocate memory for buf assuming 1 replacement of old with new
<span class="lineNum">     598 </span>                :            :           ** don't bother reallocating if old is larger than new)
<span class="lineNum">     599 </span>                :            :     */
<span class="lineNum">     600 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :     if (old_len &lt; new_len) {</span>
<span class="lineNum">     601 </span>                :<span class="lineCov">          1 :       tmp_offset = tmp_ptr - str;</span>
<span class="lineNum">     602 </span>                :<span class="lineCov">          1 :       str_len = str_len - old_len + new_len;</span>
<span class="lineNum">     603 </span>                :<span class="lineCov">          1 :       str = (char *)msSmallRealloc(str, (str_len + 1)); /* make new space for a copy */</span>
<span class="lineNum">     604 </span>                :<span class="lineCov">          1 :       tmp_ptr = str + tmp_offset;</span>
<span class="lineNum">     605 </span>                :            :     }
<span class="lineNum">     606 </span>                :            : 
<span class="lineNum">     607 </span>                :            :     /*
<span class="lineNum">     608 </span>                :            :     ** Move the trailing part of str to make some room unless old_len == new_len
<span class="lineNum">     609 </span>                :            :     */
<span class="lineNum">     610 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :     if (old_len != new_len) {</span>
<span class="lineNum">     611 </span>                :<span class="lineCov">          1 :       memmove(tmp_ptr+new_len, tmp_ptr+old_len, strlen(tmp_ptr)-old_len+1);</span>
<span class="lineNum">     612 </span>                :            :     }
<span class="lineNum">     613 </span>                :            : 
<span class="lineNum">     614 </span>                :            :     /*
<span class="lineNum">     615 </span>                :            :     ** Now copy new over old
<span class="lineNum">     616 </span>                :            :     */
<span class="lineNum">     617 </span>                :<span class="lineCov">          1 :     memcpy(tmp_ptr, new, new_len);</span>
<span class="lineNum">     618 </span>                :            : 
<span class="lineNum">     619 </span>                :            :     /*
<span class="lineNum">     620 </span>                :            :     ** And look for more matches in the rest of the string
<span class="lineNum">     621 </span>                :            :     */
<span class="lineNum">     622 </span>                :<span class="lineCov">          1 :     tmp_ptr = strstr(tmp_ptr + new_len, old);</span>
<span class="lineNum">     623 </span>                :            :   }
<span class="lineNum">     624 </span>                :            : 
<span class="lineNum">     625 </span>                :            :   return(str);
<span class="lineNum">     626 </span>                :            : }
<span class="lineNum">     627 </span>                :            : 
<span class="lineNum">     628 </span>                :            : /*
<span class="lineNum">     629 </span>                :            :  * same goal as msReplaceSubstring, but for the known case
<span class="lineNum">     630 </span>                :            :  * when we won't have to do reallocs etc
<a name="631"><span class="lineNum">     631 </span>                :            :  * used to replace the wrap characetr by a newline for labels</a>
<span class="lineNum">     632 </span>                :            :  */
<span class="lineNum">     633 </span>                :<span class="lineCov">          1 : void msReplaceChar(char *str, char old, char new)</span>
<span class="lineNum">     634 </span>                :            : {
<span class="lineNum">     635 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :   while(*(str++))</span>
<span class="lineNum">     636 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :     if(*str==old)</span>
<span class="lineNum">     637 </span>                :<span class="lineCov">          1 :       *str=new;</span>
<span class="lineNum">     638 </span>                :<span class="lineCov">          1 : }</span>
<span class="lineNum">     639 </span>                :            : 
<span class="lineNum">     640 </span>                :            : /*
<a name="641"><span class="lineNum">     641 </span>                :            : ** how many times does ch occur in str</a>
<span class="lineNum">     642 </span>                :            : */
<span class="lineNum">     643 </span>                :<span class="lineCov">          1 : int msCountChars(char *str, char ch)</span>
<span class="lineNum">     644 </span>                :            : {
<span class="lineNum">     645 </span>                :            :   int i, l, n=0;
<span class="lineNum">     646 </span>                :            : 
<span class="lineNum">     647 </span>                :<span class="lineCov">          1 :   l = strlen(str);</span>
<span class="lineNum">     648 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :   for(i=0; i&lt;l; i++)</span>
<span class="lineNum">     649 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :     if(str[i] == ch) n++;</span>
<span class="lineNum">     650 </span>                :            : 
<span class="lineNum">     651 </span>                :<span class="lineCov">          1 :   return(n);</span>
<span class="lineNum">     652 </span>                :            : }
<span class="lineNum">     653 </span>                :            : 
<span class="lineNum">     654 </span>                :            : /* ------------------------------------------------------------------------------- */
<a name="655"><span class="lineNum">     655 </span>                :            : /*       Strip filename from a full path                                           */</a>
<span class="lineNum">     656 </span>                :            : /* ------------------------------------------------------------------------------- */
<span class="lineNum">     657 </span>                :<span class="lineNoCov">          0 : char *msStripPath(char *fn)</span>
<span class="lineNum">     658 </span>                :            : {
<span class="lineNum">     659 </span>                :            :   char *pSlash;
<span class="lineNum">     660 </span>                :            :   char *pBackslash;
<span class="lineNum">     661 </span>                :            : 
<span class="lineNum">     662 </span>                :            :   /* try to locate both, the last slash or backslash */
<span class="lineNum">     663 </span>                :<span class="lineNoCov">          0 :   pSlash = strrchr(fn,'/');</span>
<span class="lineNum">     664 </span>                :<span class="lineNoCov">          0 :   pBackslash = strrchr(fn,'\\');</span>
<span class="lineNum">     665 </span>                :            : 
<span class="lineNum">     666 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :   if( pSlash != NULL &amp;&amp; pBackslash != NULL ) {</span>
<span class="lineNum">     667 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if( pSlash &lt; pBackslash )</span>
<span class="lineNum">     668 </span>                :<span class="lineNoCov">          0 :       return ++pBackslash;</span>
<span class="lineNum">     669 </span>                :            :     else
<span class="lineNum">     670 </span>                :<span class="lineNoCov">          0 :       return ++pSlash;</span>
<span class="lineNum">     671 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :   } else if ( pSlash != NULL )</span>
<span class="lineNum">     672 </span>                :<span class="lineNoCov">          0 :     return ++pSlash; /* skip past the &quot;slash&quot; */</span>
<span class="lineNum">     673 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :   else if ( pBackslash != NULL )</span>
<span class="lineNum">     674 </span>                :<span class="lineNoCov">          0 :     return ++pBackslash; /* skip past the &quot;backslash&quot; */</span>
<span class="lineNum">     675 </span>                :            :   else
<span class="lineNum">     676 </span>                :            :     return(fn);
<span class="lineNum">     677 </span>                :            : }
<span class="lineNum">     678 </span>                :            : 
<span class="lineNum">     679 </span>                :            : /*
<a name="680"><span class="lineNum">     680 </span>                :            : ** Returns the *path* portion of the filename fn. Memory is allocated using malloc.</a>
<span class="lineNum">     681 </span>                :            : */
<span class="lineNum">     682 </span>                :<span class="lineCov">          1 : char *msGetPath(char *fn)</span>
<span class="lineNum">     683 </span>                :            : {
<span class="lineNum">     684 </span>                :            :   char *str;
<span class="lineNum">     685 </span>                :            :   int i, length;
<span class="lineNum">     686 </span>                :            : 
<span class="lineNum">     687 </span>                :<span class="lineCov">          1 :   length = strlen(fn);</span>
<span class="lineNum">     688 </span>        [<span class="branchCov" title="Branch 1 was taken X times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          1 :   if((str = msStrdup(fn)) == NULL)</span>
<span class="lineNum">     689 </span>                :            :     return(NULL);
<span class="lineNum">     690 </span>                :            : 
<span class="lineNum">     691 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :   for(i=length-1; i&gt;=0; i--) { /* step backwards through the string */</span>
<span class="lineNum">     692 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :     if((str[i] == '/') || (str[i] == '\\')) {</span>
<span class="lineNum">     693 </span>                :<span class="lineCov">          1 :       str[i+1] = '\0';</span>
<span class="lineNum">     694 </span>                :<span class="lineCov">          1 :       break;</span>
<span class="lineNum">     695 </span>                :            :     }
<span class="lineNum">     696 </span>                :            :   }
<span class="lineNum">     697 </span>                :            : 
<span class="lineNum">     698 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :   if(strcmp(str, fn) == 0) {</span>
<span class="lineNum">     699 </span>                :<span class="lineCov">          1 :     msFree(str);</span>
<span class="lineNum">     700 </span>                :            : #if defined(_WIN32) &amp;&amp; !defined(__CYGWIN__)
<span class="lineNum">     701 </span>                :            :     str = msStrdup(&quot;.\\&quot;);
<span class="lineNum">     702 </span>                :            : #else
<span class="lineNum">     703 </span>                :<span class="lineCov">          1 :     str= msStrdup(&quot;./&quot;);</span>
<span class="lineNum">     704 </span>                :            : #endif
<span class="lineNum">     705 </span>                :            :   }
<span class="lineNum">     706 </span>                :            : 
<span class="lineNum">     707 </span>                :<span class="lineCov">          1 :   return(str);</span>
<span class="lineNum">     708 </span>                :            : }
<span class="lineNum">     709 </span>                :            : 
<span class="lineNum">     710 </span>                :            : /*
<span class="lineNum">     711 </span>                :            : ** Returns a *path* built from abs_path and path.
<span class="lineNum">     712 </span>                :            : ** The pszReturnPath must be declared by the caller function as an array
<a name="713"><span class="lineNum">     713 </span>                :            : ** of MS_MAXPATHLEN char</a>
<span class="lineNum">     714 </span>                :            : */
<span class="lineNum">     715 </span>                :<span class="lineCov">          1 : char *msBuildPath(char *pszReturnPath, const char *abs_path, const char *path)</span>
<span class="lineNum">     716 </span>                :            : {
<span class="lineNum">     717 </span>                :            :   int   abslen = 0;
<span class="lineNum">     718 </span>                :            :   int   pathlen = 0;
<span class="lineNum">     719 </span>                :            : 
<span class="lineNum">     720 </span>                :            : 
<span class="lineNum">     721 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :   if(path == NULL) {</span>
<span class="lineNum">     722 </span>                :<span class="lineNoCov">          0 :     msSetError(MS_IOERR, NULL, &quot;msBuildPath&quot;);</span>
<span class="lineNum">     723 </span>                :<span class="lineNoCov">          0 :     return NULL;</span>
<span class="lineNum">     724 </span>                :            :   }
<span class="lineNum">     725 </span>                :            : 
<span class="lineNum">     726 </span>                :<span class="lineCov">          1 :   pathlen = strlen(path);</span>
<span class="lineNum">     727 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :   if (abs_path)</span>
<span class="lineNum">     728 </span>                :<span class="lineCov">          1 :     abslen = strlen(abs_path);</span>
<span class="lineNum">     729 </span>                :            : 
<span class="lineNum">     730 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :   if((pathlen + abslen + 2) &gt; MS_MAXPATHLEN) {</span>
<span class="lineNum">     731 </span>                :<span class="lineNoCov">          0 :     msSetError(MS_IOERR, &quot;(%s%s): path is too long&quot;, &quot;msBuildPath()&quot;,</span>
<span class="lineNum">     732 </span>                :            :                abs_path, path);
<span class="lineNum">     733 </span>                :<span class="lineNoCov">          0 :     return NULL;</span>
<span class="lineNum">     734 </span>                :            :   }
<span class="lineNum">     735 </span>                :            : 
<span class="lineNum">     736 </span>                :            :   /* Check if path is absolute */
<span class="lineNum">     737 </span>[<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>][<span class="branchCov" title="Branch 2 was taken X times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          1 :   if((abs_path == NULL) || (abslen == 0) ||</span>
<span class="lineNum">     738 </span>[<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>][<span class="branchCov" title="Branch 2 was taken X times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          1 :       (path[0] == '\\') || (path[0] == '/') ||</span>
<span class="lineNum">     739 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :       (pathlen &gt; 1 &amp;&amp; (path[1] == ':'))) {</span>
<span class="lineNum">     740 </span>                :<span class="lineCov">          1 :     strlcpy(pszReturnPath, path, MS_MAXPATHLEN);</span>
<span class="lineNum">     741 </span>                :<span class="lineCov">          1 :     return(pszReturnPath);</span>
<span class="lineNum">     742 </span>                :            :   }
<span class="lineNum">     743 </span>                :            : 
<span class="lineNum">     744 </span>                :            :   /* else return abs_path/path */
<span class="lineNum">     745 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :   if((abs_path[abslen-1] == '/') || (abs_path[abslen-1] == '\\')) {</span>
<span class="lineNum">     746 </span>                :            :     snprintf(pszReturnPath, MS_MAXPATHLEN, &quot;%s%s&quot;, abs_path, path);
<span class="lineNum">     747 </span>                :            :   } else {
<span class="lineNum">     748 </span>                :            :     snprintf(pszReturnPath, MS_MAXPATHLEN, &quot;%s/%s&quot;, abs_path, path);
<span class="lineNum">     749 </span>                :            :   }
<span class="lineNum">     750 </span>                :            : 
<span class="lineNum">     751 </span>                :            :   return(pszReturnPath);
<span class="lineNum">     752 </span>                :            : }
<span class="lineNum">     753 </span>                :            : 
<span class="lineNum">     754 </span>                :            : /*
<span class="lineNum">     755 </span>                :            : ** Returns a *path* built from abs_path, path1 and path2.
<span class="lineNum">     756 </span>                :            : ** abs_path/path1/path2
<span class="lineNum">     757 </span>                :            : ** The pszReturnPath must be declared by the caller function as an array
<a name="758"><span class="lineNum">     758 </span>                :            : ** of MS_MAXPATHLEN char</a>
<span class="lineNum">     759 </span>                :            : */
<span class="lineNum">     760 </span>                :<span class="lineCov">          1 : char *msBuildPath3(char *pszReturnPath, const char *abs_path, const char *path1,const char *path2)</span>
<span class="lineNum">     761 </span>                :            : {
<span class="lineNum">     762 </span>                :            :   char szPath[MS_MAXPATHLEN];
<span class="lineNum">     763 </span>                :            : 
<span class="lineNum">     764 </span>                :<span class="lineCov">          1 :   return msBuildPath(pszReturnPath, abs_path,</span>
<span class="lineNum">     765 </span>                :<span class="lineCov">          1 :                      msBuildPath(szPath, path1, path2));</span>
<span class="lineNum">     766 </span>                :            : }
<span class="lineNum">     767 </span>                :            : 
<span class="lineNum">     768 </span>                :            : /*
<span class="lineNum">     769 </span>                :            : ** Similar to msBuildPath(), but the input path is only qualified by the
<span class="lineNum">     770 </span>                :            : ** absolute path if this will result in it pointing to a readable file.
<span class="lineNum">     771 </span>                :            : **
<span class="lineNum">     772 </span>                :            : ** Returns NULL if the resulting path doesn't point to a readable file.
<a name="773"><span class="lineNum">     773 </span>                :            : */</a>
<span class="lineNum">     774 </span>                :            : 
<span class="lineNum">     775 </span>                :<span class="lineCov">          1 : char *msTryBuildPath(char *szReturnPath, const char *abs_path, const char *path)</span>
<span class="lineNum">     776 </span>                :            : 
<span class="lineNum">     777 </span>                :            : {
<span class="lineNum">     778 </span>                :            :   FILE  *fp;
<span class="lineNum">     779 </span>                :            : 
<span class="lineNum">     780 </span>        [<span class="branchCov" title="Branch 1 was taken X times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          1 :   if( msBuildPath( szReturnPath, abs_path, path ) == NULL )</span>
<span class="lineNum">     781 </span>                :            :     return NULL;
<span class="lineNum">     782 </span>                :            : 
<span class="lineNum">     783 </span>                :<span class="lineCov">          1 :   fp = fopen( szReturnPath, &quot;r&quot; );</span>
<span class="lineNum">     784 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :   if( fp == NULL ) {</span>
<span class="lineNum">     785 </span>                :<span class="lineCov">          1 :     strlcpy( szReturnPath, path, MS_MAXPATHLEN);</span>
<span class="lineNum">     786 </span>                :<span class="lineCov">          1 :     return NULL;</span>
<span class="lineNum">     787 </span>                :            :   } else
<span class="lineNum">     788 </span>                :<span class="lineCov">          1 :     fclose( fp );</span>
<span class="lineNum">     789 </span>                :            : 
<span class="lineNum">     790 </span>                :<span class="lineCov">          1 :   return szReturnPath;</span>
<span class="lineNum">     791 </span>                :            : }
<span class="lineNum">     792 </span>                :            : 
<span class="lineNum">     793 </span>                :            : /*
<span class="lineNum">     794 </span>                :            : ** Similar to msBuildPath3(), but the input path is only qualified by the
<span class="lineNum">     795 </span>                :            : ** absolute path if this will result in it pointing to a readable file.
<span class="lineNum">     796 </span>                :            : **
<span class="lineNum">     797 </span>                :            : ** Returns NULL if the resulting path doesn't point to a readable file.
<a name="798"><span class="lineNum">     798 </span>                :            : */</a>
<span class="lineNum">     799 </span>                :            : 
<span class="lineNum">     800 </span>                :<span class="lineCov">          1 : char *msTryBuildPath3(char *szReturnPath, const char *abs_path, const char *path1, const char *path2)</span>
<span class="lineNum">     801 </span>                :            : 
<span class="lineNum">     802 </span>                :            : {
<span class="lineNum">     803 </span>                :            :   FILE  *fp;
<span class="lineNum">     804 </span>                :            : 
<span class="lineNum">     805 </span>        [<span class="branchCov" title="Branch 1 was taken X times"> + </span><span class="branchNoCov" title="Branch 2 was not taken"> - </span>]:<span class="lineCov">          1 :   if( msBuildPath3( szReturnPath, abs_path, path1, path2 ) == NULL )</span>
<span class="lineNum">     806 </span>                :            :     return NULL;
<span class="lineNum">     807 </span>                :            : 
<span class="lineNum">     808 </span>                :<span class="lineCov">          1 :   fp = fopen( szReturnPath, &quot;r&quot; );</span>
<span class="lineNum">     809 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :   if( fp == NULL ) {</span>
<span class="lineNum">     810 </span>                :<span class="lineCov">          1 :     strlcpy( szReturnPath, path2, MS_MAXPATHLEN);</span>
<span class="lineNum">     811 </span>                :<span class="lineCov">          1 :     return NULL;</span>
<span class="lineNum">     812 </span>                :            :   } else
<span class="lineNum">     813 </span>                :<span class="lineCov">          1 :     fclose( fp );</span>
<span class="lineNum">     814 </span>                :            : 
<span class="lineNum">     815 </span>                :<span class="lineCov">          1 :   return szReturnPath;</span>
<span class="lineNum">     816 </span>                :            : }
<span class="lineNum">     817 </span>                :            : 
<span class="lineNum">     818 </span>                :            : /*
<a name="819"><span class="lineNum">     819 </span>                :            : ** Splits a string into multiple strings based on ch. Consecutive ch's are ignored.</a>
<span class="lineNum">     820 </span>                :            : */
<span class="lineNum">     821 </span>                :<span class="lineCov">          1 : char **msStringSplit(const char *string, char ch, int *num_tokens)</span>
<span class="lineNum">     822 </span>                :            : {
<span class="lineNum">     823 </span>                :            :   int i,j,k;
<span class="lineNum">     824 </span>                :            :   int length,n;
<span class="lineNum">     825 </span>                :            :   char **token;
<span class="lineNum">     826 </span>                :            :   char last_ch='\0';
<span class="lineNum">     827 </span>                :            : 
<span class="lineNum">     828 </span>                :            :   n = 1; /* always at least 1 token, the string itself */
<span class="lineNum">     829 </span>                :<span class="lineCov">          1 :   length = strlen(string);</span>
<span class="lineNum">     830 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :   for(i=0; i&lt;length; i++) {</span>
<span class="lineNum">     831 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :     if(string[i] == ch &amp;&amp; last_ch != ch)</span>
<span class="lineNum">     832 </span>                :<span class="lineCov">          1 :       n++;</span>
<span class="lineNum">     833 </span>                :<span class="lineCov">          1 :     last_ch = string[i];</span>
<span class="lineNum">     834 </span>                :            :   }
<span class="lineNum">     835 </span>                :            : 
<span class="lineNum">     836 </span>                :<span class="lineCov">          1 :   token = (char **) msSmallMalloc(sizeof(char *)*n);</span>
<span class="lineNum">     837 </span>                :            : 
<span class="lineNum">     838 </span>                :            :   k = 0;
<span class="lineNum">     839 </span>                :<span class="lineCov">          1 :   token[k] = (char *)msSmallMalloc(sizeof(char)*(length+1));</span>
<span class="lineNum">     840 </span>                :            : 
<span class="lineNum">     841 </span>                :            :   j = 0;
<span class="lineNum">     842 </span>                :            :   last_ch='\0';
<span class="lineNum">     843 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :   for(i=0; i&lt;length; i++) {</span>
<span class="lineNum">     844 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :     if(string[i] == ch) {</span>
<span class="lineNum">     845 </span>                :            : 
<span class="lineNum">     846 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :       if(last_ch == ch)</span>
<span class="lineNum">     847 </span>                :<span class="lineCov">          1 :         continue;</span>
<span class="lineNum">     848 </span>                :            : 
<span class="lineNum">     849 </span>                :<span class="lineCov">          1 :       token[k][j] = '\0'; /* terminate current token */</span>
<span class="lineNum">     850 </span>                :            : 
<span class="lineNum">     851 </span>                :<span class="lineCov">          1 :       k++;</span>
<span class="lineNum">     852 </span>                :<span class="lineCov">          1 :       token[k] = (char *)msSmallMalloc(sizeof(char)*(length+1));</span>
<span class="lineNum">     853 </span>                :            : 
<span class="lineNum">     854 </span>                :            :       j = 0;
<span class="lineNum">     855 </span>                :            :     } else {
<span class="lineNum">     856 </span>                :<span class="lineCov">          1 :       token[k][j] = string[i];</span>
<span class="lineNum">     857 </span>                :<span class="lineCov">          1 :       j++;</span>
<span class="lineNum">     858 </span>                :            :     }
<span class="lineNum">     859 </span>                :            : 
<span class="lineNum">     860 </span>                :<span class="lineCov">          1 :     last_ch = string[i];</span>
<span class="lineNum">     861 </span>                :            :   }
<span class="lineNum">     862 </span>                :            : 
<span class="lineNum">     863 </span>                :<span class="lineCov">          1 :   token[k][j] = '\0'; /* terminate last token */</span>
<span class="lineNum">     864 </span>                :            : 
<span class="lineNum">     865 </span>                :<span class="lineCov">          1 :   *num_tokens = n;</span>
<span class="lineNum">     866 </span>                :            : 
<span class="lineNum">     867 </span>                :<span class="lineCov">          1 :   return(token);</span>
<span class="lineNum">     868 </span>                :            : }
<span class="lineNum">     869 </span>                :            : 
<span class="lineNum">     870 </span>                :            : /*
<span class="lineNum">     871 </span>                :            :  This function is a copy of CSLTokenizeString2() function of the CPL component.
<span class="lineNum">     872 </span>                :            :  See the port/cpl_string.cpp file in gdal source for the complete documentation.
<span class="lineNum">     873 </span>                :            :  Available Flags:
<span class="lineNum">     874 </span>                :            :  * - MS_ALLOWEMPTYTOKENS: allow the return of empty tokens when two
<span class="lineNum">     875 </span>                :            :  * delimiters in a row occur with no other text between them.  If not set,
<span class="lineNum">     876 </span>                :            :  * empty tokens will be discarded;
<span class="lineNum">     877 </span>                :            :  * - MS_STRIPLEADSPACES: strip leading space characters from the token (as
<span class="lineNum">     878 </span>                :            :  * reported by isspace());
<span class="lineNum">     879 </span>                :            :  * - MS_STRIPENDSPACES: strip ending space characters from the token (as
<span class="lineNum">     880 </span>                :            :  * reported by isspace());
<span class="lineNum">     881 </span>                :            :  * - MS_HONOURSTRINGS: double quotes can be used to hold values that should
<span class="lineNum">     882 </span>                :            :  * not be broken into multiple tokens;
<span class="lineNum">     883 </span>                :            :  * - MS_PRESERVEQUOTES: string quotes are carried into the tokens when this
<span class="lineNum">     884 </span>                :            :  * is set, otherwise they are removed;
<span class="lineNum">     885 </span>                :            :  * - MS_PRESERVEESCAPES: if set backslash escapes (for backslash itself,
<span class="lineNum">     886 </span>                :            :  * and for literal double quotes) will be preserved in the tokens, otherwise
<a name="887"><span class="lineNum">     887 </span>                :            :  * the backslashes will be removed in processing.</a>
<span class="lineNum">     888 </span>                :            :  */
<span class="lineNum">     889 </span>                :<span class="lineCov">          1 : char ** msStringSplitComplex( const char * pszString,</span>
<span class="lineNum">     890 </span>                :            :                               const char * pszDelimiters,
<span class="lineNum">     891 </span>                :            :                               int *num_tokens,
<span class="lineNum">     892 </span>                :            :                               int nFlags )
<span class="lineNum">     893 </span>                :            : 
<span class="lineNum">     894 </span>                :            : {
<span class="lineNum">     895 </span>                :            :   char        **papszRetList = NULL;
<span class="lineNum">     896 </span>                :            :   int         nRetMax = 0, nRetLen = 0;
<span class="lineNum">     897 </span>                :            :   char        *pszToken;
<span class="lineNum">     898 </span>                :            :   int         nTokenMax, nTokenLen;
<span class="lineNum">     899 </span>                :<span class="lineCov">          1 :   int         bHonourStrings = (nFlags &amp; MS_HONOURSTRINGS);</span>
<span class="lineNum">     900 </span>                :<span class="lineCov">          1 :   int         bAllowEmptyTokens = (nFlags &amp; MS_ALLOWEMPTYTOKENS);</span>
<span class="lineNum">     901 </span>                :<span class="lineCov">          1 :   int         bStripLeadSpaces = (nFlags &amp; MS_STRIPLEADSPACES);</span>
<span class="lineNum">     902 </span>                :<span class="lineCov">          1 :   int         bStripEndSpaces = (nFlags &amp; MS_STRIPENDSPACES);</span>
<span class="lineNum">     903 </span>                :            : 
<span class="lineNum">     904 </span>                :<span class="lineCov">          1 :   pszToken = (char *) msSmallMalloc(sizeof(char)*10);;</span>
<span class="lineNum">     905 </span>                :            :   nTokenMax = 10;
<span class="lineNum">     906 </span>                :            : 
<span class="lineNum">     907 </span>[<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken X times"> + </span><span class="branchCov" title="Branch 3 was taken X times"> + </span>]:<span class="lineCov">          1 :   while( pszString != NULL &amp;&amp; *pszString != '\0' ) {</span>
<span class="lineNum">     908 </span>                :            :     int     bInString = MS_FALSE;
<span class="lineNum">     909 </span>                :            :     int     bStartString = MS_TRUE;
<span class="lineNum">     910 </span>                :            : 
<span class="lineNum">     911 </span>                :            :     nTokenLen = 0;
<span class="lineNum">     912 </span>                :            : 
<span class="lineNum">     913 </span>                :            :     /* Try to find the next delimeter, marking end of token */
<span class="lineNum">     914 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :     for( ; *pszString != '\0'; pszString++ ) {</span>
<span class="lineNum">     915 </span>                :            : 
<span class="lineNum">     916 </span>                :            :       /* End if this is a delimeter skip it and break. */
<span class="lineNum">     917 </span>[<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken X times"> + </span>]:<span class="lineCov">          1 :       if( !bInString &amp;&amp; strchr(pszDelimiters, *pszString) != NULL ) {</span>
<span class="lineNum">         </span>[<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>][<span class="branchCov" title="Branch 7 was taken X times"> + </span><span class="branchCov" title="Branch 8 was taken X times"> + </span>]
<span class="lineNum">     918 </span>                :<span class="lineCov">          1 :         pszString++;</span>
<span class="lineNum">     919 </span>                :<span class="lineCov">          1 :         break;</span>
<span class="lineNum">     920 </span>                :            :       }
<span class="lineNum">     921 </span>                :            : 
<span class="lineNum">     922 </span>                :            :       /* If this is a quote, and we are honouring constant
<span class="lineNum">     923 </span>                :            :          strings, then process the constant strings, with out delim
<span class="lineNum">     924 </span>                :            :          but don't copy over the quotes */
<span class="lineNum">     925 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">          1 :       if( bHonourStrings &amp;&amp; *pszString == '&quot;' ) {</span>
<span class="lineNum">     926 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if( nFlags &amp; MS_PRESERVEQUOTES ) {</span>
<span class="lineNum">     927 </span>                :<span class="lineNoCov">          0 :           pszToken[nTokenLen] = *pszString;</span>
<span class="lineNum">     928 </span>                :<span class="lineNoCov">          0 :           nTokenLen++;</span>
<span class="lineNum">     929 </span>                :            :         }
<span class="lineNum">     930 </span>                :            : 
<span class="lineNum">     931 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if( bInString ) {</span>
<span class="lineNum">     932 </span>                :            :           bInString = MS_FALSE;
<span class="lineNum">     933 </span>                :<span class="lineNoCov">          0 :           continue;</span>
<span class="lineNum">     934 </span>                :            :         } else {
<span class="lineNum">     935 </span>                :            :           bInString = MS_TRUE;
<span class="lineNum">     936 </span>                :<span class="lineNoCov">          0 :           continue;</span>
<span class="lineNum">     937 </span>                :            :         }
<span class="lineNum">     938 </span>                :            :       }
<span class="lineNum">     939 </span>                :            : 
<span class="lineNum">     940 </span>                :            :       /*
<span class="lineNum">     941 </span>                :            :        * Within string constants we allow for escaped quotes, but in
<span class="lineNum">     942 </span>                :            :        * processing them we will unescape the quotes and \\ sequence
<span class="lineNum">     943 </span>                :            :        * reduces to \
<span class="lineNum">     944 </span>                :            :        */
<span class="lineNum">     945 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">          1 :       if( bInString &amp;&amp; pszString[0] == '\\' ) {</span>
<span class="lineNum">     946 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if ( pszString[1] == '&quot;' || pszString[1] == '\\' ) {</span>
<span class="lineNum">     947 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :           if( nFlags &amp; MS_PRESERVEESCAPES ) {</span>
<span class="lineNum">     948 </span>                :<span class="lineNoCov">          0 :             pszToken[nTokenLen] = *pszString;</span>
<span class="lineNum">     949 </span>                :<span class="lineNoCov">          0 :             nTokenLen++;</span>
<span class="lineNum">     950 </span>                :            :           }
<span class="lineNum">     951 </span>                :            : 
<span class="lineNum">     952 </span>                :<span class="lineNoCov">          0 :           pszString++;</span>
<span class="lineNum">     953 </span>                :            :         }
<span class="lineNum">     954 </span>                :            :       }
<span class="lineNum">     955 </span>                :            : 
<span class="lineNum">     956 </span>                :            :       /*
<span class="lineNum">     957 </span>                :            :        * Strip spaces at the token start if requested.
<span class="lineNum">     958 </span>                :            :        */
<span class="lineNum">     959 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :       if ( !bInString &amp;&amp; bStripLeadSpaces</span>
<span class="lineNum">     960 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :            &amp;&amp; bStartString &amp;&amp; isspace((unsigned char)*pszString) )</span>
<span class="lineNum">     961 </span>                :<span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">     962 </span>                :            : 
<span class="lineNum">     963 </span>                :            :       bStartString = MS_FALSE;
<span class="lineNum">     964 </span>                :            : 
<span class="lineNum">     965 </span>                :            :       /*
<span class="lineNum">     966 </span>                :            :        * Extend token buffer if we are running close to its end.
<span class="lineNum">     967 </span>                :            :        */
<span class="lineNum">     968 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :       if( nTokenLen &gt;= nTokenMax-3 ) {</span>
<span class="lineNum">     969 </span>                :<span class="lineCov">          1 :         nTokenMax = nTokenMax * 2 + 10;</span>
<span class="lineNum">     970 </span>                :<span class="lineCov">          1 :         pszToken = (char *) msSmallRealloc(pszToken, sizeof(char)*nTokenMax);</span>
<span class="lineNum">     971 </span>                :            :       }
<span class="lineNum">     972 </span>                :            : 
<span class="lineNum">     973 </span>                :<span class="lineCov">          1 :       pszToken[nTokenLen] = *pszString;</span>
<span class="lineNum">     974 </span>                :<span class="lineCov">          1 :       nTokenLen++;</span>
<span class="lineNum">     975 </span>                :            :     }
<span class="lineNum">     976 </span>                :            : 
<span class="lineNum">     977 </span>                :            :     /*
<span class="lineNum">     978 </span>                :            :      * Strip spaces at the token end if requested.
<span class="lineNum">     979 </span>                :            :      */
<span class="lineNum">     980 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :     if ( !bInString &amp;&amp; bStripEndSpaces ) {</span>
<span class="lineNum">     981 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :       while ( nTokenLen &amp;&amp; isspace((unsigned char)pszToken[nTokenLen - 1]) )</span>
<span class="lineNum">     982 </span>                :<span class="lineNoCov">          0 :         nTokenLen--;</span>
<span class="lineNum">     983 </span>                :            :     }
<span class="lineNum">     984 </span>                :            : 
<span class="lineNum">     985 </span>                :<span class="lineCov">          1 :     pszToken[nTokenLen] = '\0';</span>
<span class="lineNum">     986 </span>                :            : 
<span class="lineNum">     987 </span>                :            :     /*
<span class="lineNum">     988 </span>                :            :      * Add the token.
<span class="lineNum">     989 </span>                :            :      */
<span class="lineNum">     990 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :     if( pszToken[0] != '\0' || bAllowEmptyTokens ) {</span>
<span class="lineNum">     991 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :       if( nRetLen &gt;= nRetMax - 1 ) {</span>
<span class="lineNum">     992 </span>                :<span class="lineCov">          1 :         nRetMax = nRetMax * 2 + 10;</span>
<span class="lineNum">     993 </span>                :<span class="lineCov">          1 :         papszRetList = (char **) msSmallRealloc(papszRetList, sizeof(char*)*nRetMax);</span>
<span class="lineNum">     994 </span>                :            :       }
<span class="lineNum">     995 </span>                :            : 
<span class="lineNum">     996 </span>                :<span class="lineCov">          1 :       papszRetList[nRetLen++] = msStrdup( pszToken );</span>
<span class="lineNum">     997 </span>                :<span class="lineCov">          1 :       papszRetList[nRetLen] = NULL;</span>
<span class="lineNum">     998 </span>                :            :     }
<span class="lineNum">     999 </span>                :            :   }
<span class="lineNum">    1000 </span>                :            : 
<span class="lineNum">    1001 </span>                :            :   /*
<span class="lineNum">    1002 </span>                :            :    * If the last token was empty, then we need to capture
<span class="lineNum">    1003 </span>                :            :    * it now, as the loop would skip it.
<span class="lineNum">    1004 </span>                :            :    */
<span class="lineNum">    1005 </span>[<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken X times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          1 :   if( *pszString == '\0' &amp;&amp; bAllowEmptyTokens &amp;&amp; nRetLen &gt; 0</span>
<span class="lineNum">    1006 </span>[<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineCov">          1 :       &amp;&amp; strchr(pszDelimiters,*(pszString-1)) != NULL ) {</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 5 was taken X times"> + </span><span class="branchCov" title="Branch 6 was taken X times"> + </span>]
<span class="lineNum">    1007 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :     if( nRetLen &gt;= nRetMax - 1 ) {</span>
<span class="lineNum">    1008 </span>                :<span class="lineNoCov">          0 :       nRetMax = nRetMax * 2 + 10;</span>
<span class="lineNum">    1009 </span>                :<span class="lineNoCov">          0 :       papszRetList = (char **) msSmallRealloc(papszRetList, sizeof(char*)*nRetMax);</span>
<span class="lineNum">    1010 </span>                :            :     }
<span class="lineNum">    1011 </span>                :            : 
<span class="lineNum">    1012 </span>                :<span class="lineCov">          1 :     papszRetList[nRetLen++] = msStrdup(&quot;&quot;);</span>
<span class="lineNum">    1013 </span>                :<span class="lineCov">          1 :     papszRetList[nRetLen] = NULL;</span>
<span class="lineNum">    1014 </span>                :            :   }
<span class="lineNum">    1015 </span>                :            : 
<span class="lineNum">    1016 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :   if( papszRetList == NULL )</span>
<span class="lineNum">    1017 </span>                :<span class="lineNoCov">          0 :     papszRetList = (char **) msSmallMalloc(sizeof(char *)*1);</span>
<span class="lineNum">    1018 </span>                :            : 
<span class="lineNum">    1019 </span>                :<span class="lineCov">          1 :   *num_tokens = nRetLen;</span>
<span class="lineNum">    1020 </span>                :<span class="lineCov">          1 :   free(pszToken);</span>
<span class="lineNum">    1021 </span>                :            : 
<span class="lineNum">    1022 </span>                :<span class="lineCov">          1 :   return papszRetList;</span>
<span class="lineNum">    1023 </span>                :            : }
<span class="lineNum">    1024 </span>                :            : 
<a name="1025"><span class="lineNum">    1025 </span>                :            : /* This method is similar to msStringSplit but support quoted strings.</a>
<span class="lineNum">    1026 </span>                :            :    It also support multi-characters delimiter and allows to preserve quotes */
<span class="lineNum">    1027 </span>                :<span class="lineCov">          1 : char **msStringTokenize( const char *pszLine, const char *pszDelim,</span>
<span class="lineNum">    1028 </span>                :            :                          int *num_tokens, int preserve_quote )
<span class="lineNum">    1029 </span>                :            : {
<span class="lineNum">    1030 </span>                :            :   char **papszResult = NULL;
<span class="lineNum">    1031 </span>                :<span class="lineCov">          1 :   int n = 1, iChar, nLength = strlen(pszLine), iTokenChar = 0, bInQuotes = MS_FALSE;</span>
<span class="lineNum">    1032 </span>                :<span class="lineCov">          1 :   char *pszToken = (char *) msSmallMalloc(sizeof(char)*(nLength+1));</span>
<span class="lineNum">    1033 </span>                :<span class="lineCov">          1 :   int nDelimLen = strlen(pszDelim);</span>
<span class="lineNum">    1034 </span>                :            : 
<span class="lineNum">    1035 </span>                :            :   /* Compute the number of tokens */
<span class="lineNum">    1036 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :   for( iChar = 0; pszLine[iChar] != '\0'; iChar++ ) {</span>
<span class="lineNum">    1037 </span>[<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>][<span class="branchCov" title="Branch 2 was taken X times"> + </span><span class="branchCov" title="Branch 3 was taken X times"> + </span>]:<span class="lineCov">          1 :     if( bInQuotes &amp;&amp; pszLine[iChar] == '&quot;' &amp;&amp; pszLine[iChar+1] == '&quot;' ) {</span>
<span class="lineNum">         </span>        [<span class="branchNoCov" title="Branch 4 was not taken"> - </span><span class="branchCov" title="Branch 5 was taken X times"> + </span>]
<span class="lineNum">    1038 </span>                :<span class="lineNoCov">          0 :       iChar++;</span>
<span class="lineNum">    1039 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :     } else if( pszLine[iChar] == '&quot;' ) {</span>
<span class="lineNum">    1040 </span>                :<span class="lineCov">          1 :       bInQuotes = !bInQuotes;</span>
<span class="lineNum">    1041 </span>[<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>][<span class="branchCov" title="Branch 2 was taken X times"> + </span><span class="branchCov" title="Branch 3 was taken X times"> + </span>]:<span class="lineCov">          1 :     } else if ( !bInQuotes &amp;&amp; strncmp(pszLine+iChar,pszDelim,nDelimLen) == 0 ) {</span>
<span class="lineNum">    1042 </span>                :<span class="lineCov">          1 :       iChar += nDelimLen - 1;</span>
<span class="lineNum">    1043 </span>                :<span class="lineCov">          1 :       n++;</span>
<span class="lineNum">    1044 </span>                :            :     }
<span class="lineNum">    1045 </span>                :            :   }
<span class="lineNum">    1046 </span>                :            : 
<span class="lineNum">    1047 </span>                :<span class="lineCov">          1 :   papszResult = (char **) msSmallMalloc(sizeof(char *)*n);</span>
<span class="lineNum">    1048 </span>                :            :   n = iTokenChar = bInQuotes = 0;
<span class="lineNum">    1049 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :   for( iChar = 0; pszLine[iChar] != '\0'; iChar++ ) {</span>
<span class="lineNum">    1050 </span>[<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>][<span class="branchCov" title="Branch 2 was taken X times"> + </span><span class="branchCov" title="Branch 3 was taken X times"> + </span>]:<span class="lineCov">          1 :     if( bInQuotes &amp;&amp; pszLine[iChar] == '&quot;' &amp;&amp; pszLine[iChar+1] == '&quot;' ) {</span>
<span class="lineNum">         </span>        [<span class="branchNoCov" title="Branch 4 was not taken"> - </span><span class="branchCov" title="Branch 5 was taken X times"> + </span>]
<span class="lineNum">    1051 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :       if (preserve_quote == MS_TRUE)</span>
<span class="lineNum">    1052 </span>                :<span class="lineNoCov">          0 :         pszToken[iTokenChar++] = '&quot;';</span>
<span class="lineNum">    1053 </span>                :<span class="lineNoCov">          0 :       pszToken[iTokenChar++] = '&quot;';</span>
<span class="lineNum">    1054 </span>                :<span class="lineNoCov">          0 :       iChar++;</span>
<span class="lineNum">    1055 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :     } else if( pszLine[iChar] == '&quot;' ) {</span>
<span class="lineNum">    1056 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :       if (preserve_quote == MS_TRUE)</span>
<span class="lineNum">    1057 </span>                :<span class="lineCov">          1 :         pszToken[iTokenChar++] = '&quot;';</span>
<span class="lineNum">    1058 </span>                :<span class="lineCov">          1 :       bInQuotes = !bInQuotes;</span>
<span class="lineNum">    1059 </span>[<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>][<span class="branchCov" title="Branch 2 was taken X times"> + </span><span class="branchCov" title="Branch 3 was taken X times"> + </span>]:<span class="lineCov">          1 :     } else if( !bInQuotes &amp;&amp; strncmp(pszLine+iChar,pszDelim,nDelimLen) == 0 ) {</span>
<span class="lineNum">    1060 </span>                :<span class="lineCov">          1 :       pszToken[iTokenChar++] = '\0';</span>
<span class="lineNum">    1061 </span>                :<span class="lineCov">          1 :       papszResult[n] = pszToken;</span>
<span class="lineNum">    1062 </span>                :<span class="lineCov">          1 :       pszToken = (char *) msSmallMalloc(sizeof(char)*(nLength+1));</span>
<span class="lineNum">    1063 </span>                :<span class="lineCov">          1 :       iChar += nDelimLen - 1;</span>
<span class="lineNum">    1064 </span>                :            :       iTokenChar = 0;
<span class="lineNum">    1065 </span>                :<span class="lineCov">          1 :       n++;</span>
<span class="lineNum">    1066 </span>                :            :     } else {
<span class="lineNum">    1067 </span>                :<span class="lineCov">          1 :       pszToken[iTokenChar++] = pszLine[iChar];</span>
<span class="lineNum">    1068 </span>                :            :     }
<span class="lineNum">    1069 </span>                :            :   }
<span class="lineNum">    1070 </span>                :            : 
<span class="lineNum">    1071 </span>                :<span class="lineCov">          1 :   pszToken[iTokenChar++] = '\0';</span>
<span class="lineNum">    1072 </span>                :<span class="lineCov">          1 :   papszResult[n] = pszToken;</span>
<span class="lineNum">    1073 </span>                :            : 
<span class="lineNum">    1074 </span>                :<span class="lineCov">          1 :   *num_tokens = n+1;</span>
<span class="lineNum">    1075 </span>                :            : 
<span class="lineNum">    1076 </span>                :<span class="lineCov">          1 :   return papszResult;</span>
<span class="lineNum">    1077 </span>                :            : }
<span class="lineNum">    1078 </span>                :            : 
<span class="lineNum">    1079 </span>                :            : /**********************************************************************
<span class="lineNum">    1080 </span>                :            :  *                       msEncodeChar()
<span class="lineNum">    1081 </span>                :            :  *
<span class="lineNum">    1082 </span>                :            :  * Return 1 if the character argument should be encoded for safety
<span class="lineNum">    1083 </span>                :            :  * in URL use and 0 otherwise. Specific character map taken from
<span class="lineNum">    1084 </span>                :            :  * http://www.ietf.org/rfc/rfc2396.txt
<span class="lineNum">    1085 </span>                :            :  *
<a name="1086"><span class="lineNum">    1086 </span>                :            :  **********************************************************************/</a>
<span class="lineNum">    1087 </span>                :            : 
<span class="lineNum">    1088 </span>                :<span class="lineCov">          1 : int msEncodeChar(const char c)</span>
<span class="lineNum">    1089 </span>                :            : {
<span class="lineNum">    1090 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :   if (</span>
<span class="lineNum">    1091 </span>                :<span class="lineCov">          1 :     (c &gt;= 0x61 &amp;&amp; c &lt;= 0x7A ) ||   /* Letters a-z */</span>
<span class="lineNum">    1092 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :     (c &gt;= 0x41 &amp;&amp; c &lt;= 0x5A ) ||   /* Letters A-Z */</span>
<span class="lineNum">    1093 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :     (c &gt;= 0x30 &amp;&amp; c &lt;= 0x39 ) ||   /* Numbers 0-9 */</span>
<span class="lineNum">    1094 </span>                :<span class="lineCov">          1 :     (c &gt;= 0x27 &amp;&amp; c &lt;= 0x2A ) ||   /* * ' ( )     */</span>
<span class="lineNum">    1095 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :     (c &gt;= 0x2D &amp;&amp; c &lt;= 0x2E ) ||   /* - .         */</span>
<span class="lineNum">    1096 </span>                :<span class="lineCov">          1 :     (c == 0x5F ) ||                /* _           */</span>
<span class="lineNum">    1097 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :     (c == 0x21 ) ||                /* !           */</span>
<span class="lineNum">    1098 </span>                :<span class="lineCov">          1 :     (c == 0x7E ) ) {               /* ~           */</span>
<span class="lineNum">    1099 </span>                :            :     return(0);
<span class="lineNum">    1100 </span>                :            :   } else {
<span class="lineNum">    1101 </span>                :<span class="lineCov">          1 :     return(1);</span>
<span class="lineNum">    1102 </span>                :            :   }
<a name="1103"><span class="lineNum">    1103 </span>                :            : }</a>
<span class="lineNum">    1104 </span>                :            : 
<span class="lineNum">    1105 </span>                :<span class="lineCov">          1 : char *msEncodeUrl(const char *data)</span>
<span class="lineNum">    1106 </span>                :            : {
<span class="lineNum">    1107 </span>                :            :   /*
<span class="lineNum">    1108 </span>                :            :    * Delegate to msEncodeUrlExcept, with a null second argument
<span class="lineNum">    1109 </span>                :            :    * to render the except handling moot.
<span class="lineNum">    1110 </span>                :            :    */
<span class="lineNum">    1111 </span>                :<span class="lineCov">          1 :   return(msEncodeUrlExcept(data, '\0'));</span>
<span class="lineNum">    1112 </span>                :            : }
<span class="lineNum">    1113 </span>                :            : 
<span class="lineNum">    1114 </span>                :            : /**********************************************************************
<span class="lineNum">    1115 </span>                :            :  *                       msEncodeCharExcept()
<span class="lineNum">    1116 </span>                :            :  *
<span class="lineNum">    1117 </span>                :            :  * URL encoding, applies RFP2396 encoding to all characters
<span class="lineNum">    1118 </span>                :            :  * except the one exception character. An exception character
<span class="lineNum">    1119 </span>                :            :  * of '\0' implies no exception handling.
<span class="lineNum">    1120 </span>                :            :  *
<a name="1121"><span class="lineNum">    1121 </span>                :            :  **********************************************************************/</a>
<span class="lineNum">    1122 </span>                :            : 
<span class="lineNum">    1123 </span>                :<span class="lineCov">          1 : char *msEncodeUrlExcept(const char *data, const char except)</span>
<span class="lineNum">    1124 </span>                :            : {
<span class="lineNum">    1125 </span>                :            :   static const char *hex = &quot;0123456789ABCDEF&quot;;
<span class="lineNum">    1126 </span>                :            :   const char *i;
<span class="lineNum">    1127 </span>                :            :   char  *j, *code;
<span class="lineNum">    1128 </span>                :            :   int   inc;
<span class="lineNum">    1129 </span>                :            :   unsigned char ch;
<span class="lineNum">    1130 </span>                :            : 
<span class="lineNum">    1131 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :   for (inc=0, i=data; *i!='\0'; i++)</span>
<span class="lineNum">    1132 </span>        [<span class="branchCov" title="Branch 1 was taken X times"> + </span><span class="branchCov" title="Branch 2 was taken X times"> + </span>]:<span class="lineCov">          1 :     if (msEncodeChar(*i))</span>
<span class="lineNum">    1133 </span>                :<span class="lineCov">          1 :       inc += 2;</span>
<span class="lineNum">    1134 </span>                :            : 
<span class="lineNum">    1135 </span>                :<span class="lineCov">          1 :   code = (char*)msSmallMalloc(strlen(data)+inc+1);</span>
<span class="lineNum">    1136 </span>                :            : 
<span class="lineNum">    1137 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :   for (j=code, i=data; *i!='\0'; i++, j++) {</span>
<span class="lineNum">    1138 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :     if (*i == ' ')</span>
<span class="lineNum">    1139 </span>                :<span class="lineCov">          1 :       *j = '+';</span>
<span class="lineNum">    1140 </span>[<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>][<span class="branchCov" title="Branch 2 was taken X times"> + </span><span class="branchCov" title="Branch 3 was taken X times"> + </span>]:<span class="lineCov">          1 :     else if ( except != '\0' &amp;&amp; *i == except ) {</span>
<span class="lineNum">    1141 </span>                :<span class="lineCov">          1 :       *j = except;</span>
<span class="lineNum">    1142 </span>        [<span class="branchCov" title="Branch 1 was taken X times"> + </span><span class="branchCov" title="Branch 2 was taken X times"> + </span>]:<span class="lineCov">          1 :     } else if (msEncodeChar(*i)) {</span>
<span class="lineNum">    1143 </span>                :<span class="lineCov">          1 :       ch = *i;</span>
<span class="lineNum">    1144 </span>                :<span class="lineCov">          1 :       *j++ = '%';</span>
<span class="lineNum">    1145 </span>                :<span class="lineCov">          1 :       *j++ = hex[ch/16];</span>
<span class="lineNum">    1146 </span>                :<span class="lineCov">          1 :       *j   = hex[ch%16];</span>
<span class="lineNum">    1147 </span>                :            :     } else
<span class="lineNum">    1148 </span>                :<span class="lineCov">          1 :       *j = *i;</span>
<span class="lineNum">    1149 </span>                :            :   }
<span class="lineNum">    1150 </span>                :<span class="lineCov">          1 :   *j = '\0';</span>
<span class="lineNum">    1151 </span>                :            : 
<span class="lineNum">    1152 </span>                :<span class="lineCov">          1 :   return code;</span>
<span class="lineNum">    1153 </span>                :            : }
<span class="lineNum">    1154 </span>                :            : 
<span class="lineNum">    1155 </span>                :            : /************************************************************************/
<span class="lineNum">    1156 </span>                :            : /*                            msEscapeJSonString()                      */
<span class="lineNum">    1157 </span>                :            : /************************************************************************/
<span class="lineNum">    1158 </span>                :            : 
<a name="1159"><span class="lineNum">    1159 </span>                :            : /* The input (and output) string are not supposed to start/end with double */</a>
<span class="lineNum">    1160 </span>                :            : /* quote characters. It is the responsibility of the caller to do that. */
<span class="lineNum">    1161 </span>                :<span class="lineCov">          1 : char* msEscapeJSonString(const char* pszJSonString)</span>
<span class="lineNum">    1162 </span>                :            : {
<span class="lineNum">    1163 </span>                :            :     /* Worst case is one character to become \uABCD so 6 characters */
<span class="lineNum">    1164 </span>                :            :     char* pszRet;
<span class="lineNum">    1165 </span>                :            :     int i = 0, j = 0;
<span class="lineNum">    1166 </span>                :            :     static const char* pszHex = &quot;0123456789ABCDEF&quot;;
<span class="lineNum">    1167 </span>                :            :     
<span class="lineNum">    1168 </span>                :<span class="lineCov">          1 :     pszRet = (char*) msSmallMalloc(strlen(pszJSonString) * 6 + 1);</span>
<span class="lineNum">    1169 </span>                :            :     /* From http://www.json.org/ */
<span class="lineNum">    1170 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :     for(i = 0; pszJSonString[i] != '\0'; i++)</span>
<span class="lineNum">    1171 </span>                :            :     {
<span class="lineNum">    1172 </span>                :<span class="lineCov">          1 :         unsigned char ch = pszJSonString[i];</span>
<span class="lineNum">    1173 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :         if( ch == '\b' )</span>
<span class="lineNum">    1174 </span>                :            :         {
<span class="lineNum">    1175 </span>                :<span class="lineNoCov">          0 :             pszRet[j++] = '\\';</span>
<span class="lineNum">    1176 </span>                :<span class="lineNoCov">          0 :             pszRet[j++] = 'b';</span>
<span class="lineNum">    1177 </span>                :            :         }
<span class="lineNum">    1178 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :         else if( ch == '\f' )</span>
<span class="lineNum">    1179 </span>                :            :         {
<span class="lineNum">    1180 </span>                :<span class="lineNoCov">          0 :             pszRet[j++] = '\\';</span>
<span class="lineNum">    1181 </span>                :<span class="lineNoCov">          0 :             pszRet[j++] = 'f';</span>
<span class="lineNum">    1182 </span>                :            :         }
<span class="lineNum">    1183 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :         else if( ch == '\n' )</span>
<span class="lineNum">    1184 </span>                :            :         {
<span class="lineNum">    1185 </span>                :<span class="lineCov">          1 :             pszRet[j++] = '\\';</span>
<span class="lineNum">    1186 </span>                :<span class="lineCov">          1 :             pszRet[j++] = 'n';</span>
<span class="lineNum">    1187 </span>                :            :         }
<span class="lineNum">    1188 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :         else if( ch == '\r' )</span>
<span class="lineNum">    1189 </span>                :            :         {
<span class="lineNum">    1190 </span>                :<span class="lineNoCov">          0 :             pszRet[j++] = '\\';</span>
<span class="lineNum">    1191 </span>                :<span class="lineNoCov">          0 :             pszRet[j++] = 'r';</span>
<span class="lineNum">    1192 </span>                :            :         }
<span class="lineNum">    1193 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :         else if( ch == '\t' )</span>
<span class="lineNum">    1194 </span>                :            :         {
<span class="lineNum">    1195 </span>                :<span class="lineCov">          1 :             pszRet[j++] = '\\';</span>
<span class="lineNum">    1196 </span>                :<span class="lineCov">          1 :             pszRet[j++] = 't';</span>
<span class="lineNum">    1197 </span>                :            :         }
<span class="lineNum">    1198 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :         else if( ch &lt; 32 )</span>
<span class="lineNum">    1199 </span>                :            :         {
<span class="lineNum">    1200 </span>                :<span class="lineNoCov">          0 :             pszRet[j++] = '\\';</span>
<span class="lineNum">    1201 </span>                :<span class="lineNoCov">          0 :             pszRet[j++] = 'u';</span>
<span class="lineNum">    1202 </span>                :<span class="lineNoCov">          0 :             pszRet[j++] = '0';</span>
<span class="lineNum">    1203 </span>                :<span class="lineNoCov">          0 :             pszRet[j++] = '0';</span>
<span class="lineNum">    1204 </span>                :<span class="lineNoCov">          0 :             pszRet[j++] = pszHex[ch / 16];</span>
<span class="lineNum">    1205 </span>                :<span class="lineNoCov">          0 :             pszRet[j++] = pszHex[ch % 16];</span>
<span class="lineNum">    1206 </span>                :            :         }
<span class="lineNum">    1207 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :         else if( ch == '&quot;' )</span>
<span class="lineNum">    1208 </span>                :            :         {
<span class="lineNum">    1209 </span>                :<span class="lineCov">          1 :             pszRet[j++] = '\\';</span>
<span class="lineNum">    1210 </span>                :<span class="lineCov">          1 :             pszRet[j++] = '&quot;';</span>
<span class="lineNum">    1211 </span>                :            :         }
<span class="lineNum">    1212 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :         else if( ch == '\\' )</span>
<span class="lineNum">    1213 </span>                :            :         {
<span class="lineNum">    1214 </span>                :<span class="lineCov">          1 :             pszRet[j++] = '\\';</span>
<span class="lineNum">    1215 </span>                :<span class="lineCov">          1 :             pszRet[j++] = '\\';</span>
<span class="lineNum">    1216 </span>                :            :         }
<span class="lineNum">    1217 </span>                :            :         else
<span class="lineNum">    1218 </span>                :            :         {
<span class="lineNum">    1219 </span>                :<span class="lineCov">          1 :             pszRet[j++] = ch;</span>
<span class="lineNum">    1220 </span>                :            :         }
<span class="lineNum">    1221 </span>                :            :     }
<span class="lineNum">    1222 </span>                :<span class="lineCov">          1 :     pszRet[j] = '\0';</span>
<span class="lineNum">    1223 </span>                :<span class="lineCov">          1 :     return pszRet;</span>
<span class="lineNum">    1224 </span>                :            : }
<span class="lineNum">    1225 </span>                :            : 
<span class="lineNum">    1226 </span>                :            : /* msEncodeHTMLEntities()
<span class="lineNum">    1227 </span>                :            : **
<span class="lineNum">    1228 </span>                :            : ** Return a copy of string after replacing some problematic chars with their
<span class="lineNum">    1229 </span>                :            : ** HTML entity equivalents.
<span class="lineNum">    1230 </span>                :            : **
<span class="lineNum">    1231 </span>                :            : ** The replacements performed are:
<a name="1232"><span class="lineNum">    1232 </span>                :            : **  '&amp;' -&gt; &quot;&amp;amp;&quot;, '&quot;' -&gt; &quot;&amp;quot;&quot;, '&lt;' -&gt; &quot;&amp;lt;&quot; and '&gt;' -&gt; &quot;&amp;gt;&quot;</a>
<span class="lineNum">    1233 </span>                :            : **/
<span class="lineNum">    1234 </span>                :<span class="lineCov">          1 : char *msEncodeHTMLEntities(const char *string)</span>
<span class="lineNum">    1235 </span>                :            : {
<span class="lineNum">    1236 </span>                :            :   int buflen, i;
<span class="lineNum">    1237 </span>                :            :   char *newstring;
<span class="lineNum">    1238 </span>                :            :   const char *c;
<span class="lineNum">    1239 </span>                :            : 
<span class="lineNum">    1240 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   if(string == NULL)</span>
<span class="lineNum">    1241 </span>                :            :     return NULL;
<span class="lineNum">    1242 </span>                :            : 
<span class="lineNum">    1243 </span>                :            :   /* Start with 100 extra chars for replacements...  */
<span class="lineNum">    1244 </span>                :            :   /* should be good enough for most cases */
<span class="lineNum">    1245 </span>                :<span class="lineCov">          1 :   buflen = strlen(string) + 100;</span>
<span class="lineNum">    1246 </span>                :<span class="lineCov">          1 :   newstring = (char*)malloc(buflen+1);</span>
<span class="lineNum">    1247 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   MS_CHECK_ALLOC(newstring, buflen+1, NULL);</span>
<span class="lineNum">    1248 </span>                :            : 
<span class="lineNum">    1249 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :   for(i=0, c=string; *c != '\0'; c++) {</span>
<span class="lineNum">    1250 </span>                :            :     /* Need to realloc buffer? */
<span class="lineNum">    1251 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :     if (i+6 &gt; buflen) {</span>
<span class="lineNum">    1252 </span>                :            :       /* If we had to realloc then this string must contain several */
<span class="lineNum">    1253 </span>                :            :       /* entities... so let's go with twice the previous buffer size */
<span class="lineNum">    1254 </span>                :<span class="lineNoCov">          0 :       buflen *= 2;</span>
<span class="lineNum">    1255 </span>                :<span class="lineNoCov">          0 :       newstring = (char*)realloc(newstring, buflen+1);</span>
<span class="lineNum">    1256 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :       MS_CHECK_ALLOC(newstring, buflen+1, NULL);</span>
<span class="lineNum">    1257 </span>                :            :     }
<span class="lineNum">    1258 </span>                :            : 
<span class="lineNum">    1259 </span>  [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span><span class="branchCov" title="Branch 2 was taken X times"> + </span><span class="branchCov" title="Branch 3 was taken X times"> + </span> :<span class="lineCov">          1 :     switch(*c) {</span>
<span class="lineNum">         </span>         <span class="branchCov" title="Branch 4 was taken X times"> + </span><span class="branchCov" title="Branch 5 was taken X times"> + </span>]
<span class="lineNum">    1260 </span>                :            :       case '&amp;':
<span class="lineNum">    1261 </span>                :<span class="lineCov">          1 :         strcpy(newstring+i, &quot;&amp;amp;&quot;);</span>
<span class="lineNum">    1262 </span>                :<span class="lineCov">          1 :         i += 5;</span>
<span class="lineNum">    1263 </span>                :<span class="lineCov">          1 :         break;</span>
<span class="lineNum">    1264 </span>                :            :       case '&lt;':
<span class="lineNum">    1265 </span>                :<span class="lineCov">          1 :         strcpy(newstring+i, &quot;&amp;lt;&quot;);</span>
<span class="lineNum">    1266 </span>                :<span class="lineCov">          1 :         i += 4;</span>
<span class="lineNum">    1267 </span>                :<span class="lineCov">          1 :         break;</span>
<span class="lineNum">    1268 </span>                :            :       case '&gt;':
<span class="lineNum">    1269 </span>                :<span class="lineCov">          1 :         strcpy(newstring+i, &quot;&amp;gt;&quot;);</span>
<span class="lineNum">    1270 </span>                :<span class="lineCov">          1 :         i += 4;</span>
<span class="lineNum">    1271 </span>                :<span class="lineCov">          1 :         break;</span>
<span class="lineNum">    1272 </span>                :            :       case '&quot;':
<span class="lineNum">    1273 </span>                :<span class="lineCov">          1 :         strcpy(newstring+i, &quot;&amp;quot;&quot;);</span>
<span class="lineNum">    1274 </span>                :<span class="lineCov">          1 :         i += 6;</span>
<span class="lineNum">    1275 </span>                :<span class="lineCov">          1 :         break;</span>
<span class="lineNum">    1276 </span>                :            :       case '\'':
<span class="lineNum">    1277 </span>                :<span class="lineCov">          1 :         strcpy(newstring+i, &quot;&amp;#39;&quot;); /* changed from &amp;apos; and i += 6 (bug 1040) */</span>
<span class="lineNum">    1278 </span>                :<span class="lineCov">          1 :         i += 5;</span>
<span class="lineNum">    1279 </span>                :<span class="lineCov">          1 :         break;</span>
<span class="lineNum">    1280 </span>                :            :       default:
<span class="lineNum">    1281 </span>                :<span class="lineCov">          1 :         newstring[i++] = *c;</span>
<span class="lineNum">    1282 </span>                :            :     }
<span class="lineNum">    1283 </span>                :            :   }
<span class="lineNum">    1284 </span>                :            : 
<span class="lineNum">    1285 </span>                :<span class="lineCov">          1 :   newstring[i++] = '\0';</span>
<span class="lineNum">    1286 </span>                :            : 
<span class="lineNum">    1287 </span>                :<span class="lineCov">          1 :   return newstring;</span>
<span class="lineNum">    1288 </span>                :            : }
<span class="lineNum">    1289 </span>                :            : 
<span class="lineNum">    1290 </span>                :            : 
<span class="lineNum">    1291 </span>                :            : /* msDecodeHTMLEntities()
<span class="lineNum">    1292 </span>                :            : **
<span class="lineNum">    1293 </span>                :            : ** Modify the string to replace encoded characters by their true value
<span class="lineNum">    1294 </span>                :            : **
<span class="lineNum">    1295 </span>                :            : ** The replacements performed are:
<a name="1296"><span class="lineNum">    1296 </span>                :            : **  &quot;&amp;amp;&quot; -&gt; '&amp;', &quot;&amp;quot;&quot; -&gt; '&quot;', &quot;&amp;lt;&quot; -&gt; '&lt;' and &quot;&amp;gt;&quot; -&gt; '&gt;'</a>
<span class="lineNum">    1297 </span>                :            : **/
<span class="lineNum">    1298 </span>                :<span class="lineNoCov">          0 : void msDecodeHTMLEntities(const char *string)</span>
<span class="lineNum">    1299 </span>                :            : {
<span class="lineNum">    1300 </span>                :            :   char *pszAmp=NULL, *pszSemiColon=NULL, *pszReplace=NULL, *pszEnd=NULL;
<span class="lineNum">    1301 </span>                :            :   char *pszBuffer=NULL;
<span class="lineNum">    1302 </span>                :            :   size_t bufferSize = 0;
<span class="lineNum">    1303 </span>                :            : 
<span class="lineNum">    1304 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :   if(string == NULL)</span>
<span class="lineNum">    1305 </span>                :            :     return;
<span class="lineNum">    1306 </span>                :            :   else
<span class="lineNum">    1307 </span>                :            :     pszBuffer = (char*)string;
<span class="lineNum">    1308 </span>                :            : 
<span class="lineNum">    1309 </span>                :<span class="lineNoCov">          0 :   bufferSize = strlen(pszBuffer);</span>
<span class="lineNum">    1310 </span>                :<span class="lineNoCov">          0 :   pszReplace = (char*) msSmallMalloc(bufferSize+1);</span>
<span class="lineNum">    1311 </span>                :<span class="lineNoCov">          0 :   pszEnd = (char*) msSmallMalloc(bufferSize+1);</span>
<span class="lineNum">    1312 </span>                :            : 
<span class="lineNum">    1313 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :   while((pszAmp = strchr(pszBuffer, '&amp;')) != NULL) {</span>
<span class="lineNum">    1314 </span>                :            :     /* Get the &amp;...; */
<span class="lineNum">    1315 </span>                :<span class="lineNoCov">          0 :     strlcpy(pszReplace, pszAmp, bufferSize);</span>
<span class="lineNum">    1316 </span>                :<span class="lineNoCov">          0 :     pszSemiColon = strchr(pszReplace, ';');</span>
<span class="lineNum">    1317 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(pszSemiColon == NULL)</span>
<span class="lineNum">    1318 </span>                :            :       break;
<span class="lineNum">    1319 </span>                :            :     else
<span class="lineNum">    1320 </span>                :<span class="lineNoCov">          0 :       pszSemiColon++;</span>
<span class="lineNum">    1321 </span>                :            : 
<span class="lineNum">    1322 </span>                :            :     /* Get everything after the &amp;...; */
<span class="lineNum">    1323 </span>                :<span class="lineNoCov">          0 :     strlcpy(pszEnd, pszSemiColon, bufferSize);</span>
<span class="lineNum">    1324 </span>                :            : 
<span class="lineNum">    1325 </span>                :<span class="lineNoCov">          0 :     pszReplace[pszSemiColon-pszReplace] = '\0';</span>
<span class="lineNum">    1326 </span>                :            : 
<span class="lineNum">    1327 </span>                :            :     /* Replace the &amp;...; */
<span class="lineNum">    1328 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(strcasecmp(pszReplace, &quot;&amp;amp;&quot;) == 0) {</span>
<span class="lineNum">    1329 </span>                :<span class="lineNoCov">          0 :       pszBuffer[pszAmp - pszBuffer] = '&amp;';</span>
<span class="lineNum">    1330 </span>                :<span class="lineNoCov">          0 :       pszBuffer[pszAmp - pszBuffer + 1] = '\0';</span>
<span class="lineNum">    1331 </span>                :<span class="lineNoCov">          0 :       strcat(pszBuffer, pszEnd);</span>
<span class="lineNum">    1332 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     } else if(strcasecmp(pszReplace, &quot;&amp;lt;&quot;) == 0) {</span>
<span class="lineNum">    1333 </span>                :<span class="lineNoCov">          0 :       pszBuffer[pszAmp - pszBuffer] = '&lt;';</span>
<span class="lineNum">    1334 </span>                :<span class="lineNoCov">          0 :       pszBuffer[pszAmp - pszBuffer + 1] = '\0';</span>
<span class="lineNum">    1335 </span>                :<span class="lineNoCov">          0 :       strcat(pszBuffer, pszEnd);</span>
<span class="lineNum">    1336 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     } else if(strcasecmp(pszReplace, &quot;&amp;gt;&quot;) == 0) {</span>
<span class="lineNum">    1337 </span>                :<span class="lineNoCov">          0 :       pszBuffer[pszAmp - pszBuffer] = '&gt;';</span>
<span class="lineNum">    1338 </span>                :<span class="lineNoCov">          0 :       pszBuffer[pszAmp - pszBuffer + 1] = '\0';</span>
<span class="lineNum">    1339 </span>                :<span class="lineNoCov">          0 :       strcat(pszBuffer, pszEnd);</span>
<span class="lineNum">    1340 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     } else if(strcasecmp(pszReplace, &quot;&amp;quot;&quot;) == 0) {</span>
<span class="lineNum">    1341 </span>                :<span class="lineNoCov">          0 :       pszBuffer[pszAmp - pszBuffer] = '&quot;';</span>
<span class="lineNum">    1342 </span>                :<span class="lineNoCov">          0 :       pszBuffer[pszAmp - pszBuffer + 1] = '\0';</span>
<span class="lineNum">    1343 </span>                :<span class="lineNoCov">          0 :       strcat(pszBuffer, pszEnd);</span>
<span class="lineNum">    1344 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     } else if(strcasecmp(pszReplace, &quot;&amp;apos;&quot;) == 0) {</span>
<span class="lineNum">    1345 </span>                :<span class="lineNoCov">          0 :       pszBuffer[pszAmp - pszBuffer] = '\'';</span>
<span class="lineNum">    1346 </span>                :<span class="lineNoCov">          0 :       pszBuffer[pszAmp - pszBuffer + 1] = '\0';</span>
<span class="lineNum">    1347 </span>                :<span class="lineNoCov">          0 :       strcat(pszBuffer, pszEnd);</span>
<span class="lineNum">    1348 </span>                :            :     }
<span class="lineNum">    1349 </span>                :            : 
<span class="lineNum">    1350 </span>                :<span class="lineNoCov">          0 :     pszBuffer = pszAmp + 1;</span>
<span class="lineNum">    1351 </span>                :            :   }
<span class="lineNum">    1352 </span>                :            : 
<span class="lineNum">    1353 </span>                :<span class="lineNoCov">          0 :   free(pszReplace);</span>
<span class="lineNum">    1354 </span>                :<span class="lineNoCov">          0 :   free(pszEnd);</span>
<span class="lineNum">    1355 </span>                :            : 
<span class="lineNum">    1356 </span>                :<span class="lineNoCov">          0 :   return;</span>
<span class="lineNum">    1357 </span>                :            : }
<span class="lineNum">    1358 </span>                :            : 
<span class="lineNum">    1359 </span>                :            : /*
<span class="lineNum">    1360 </span>                :            : ** msIsXMLValid
<span class="lineNum">    1361 </span>                :            : **
<span class="lineNum">    1362 </span>                :            : ** Check if the string is an XML valid string. It should contains only
<span class="lineNum">    1363 </span>                :            : ** A-Z, a-z, 0-9, '_', '-', '.', and ':'
<a name="1364"><span class="lineNum">    1364 </span>                :            : ** Return MS_TRUE or MS_FALSE</a>
<span class="lineNum">    1365 </span>                :            : */
<span class="lineNum">    1366 </span>                :<span class="lineCov">          1 : int msIsXMLTagValid(const char *string)</span>
<span class="lineNum">    1367 </span>                :            : {
<span class="lineNum">    1368 </span>                :            :   int i, nLen;
<span class="lineNum">    1369 </span>                :            : 
<span class="lineNum">    1370 </span>                :<span class="lineCov">          1 :   nLen = strlen(string);</span>
<span class="lineNum">    1371 </span>                :            : 
<span class="lineNum">    1372 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :   for(i=0; i&lt;nLen; i++) {</span>
<span class="lineNum">    1373 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :     if( !( string[i] &gt;= 'A' &amp;&amp; string[i] &lt;= 'Z' ) &amp;&amp;</span>
<span class="lineNum">    1374 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :         !( string[i] &gt;= 'a' &amp;&amp; string[i] &lt;= 'z' ) &amp;&amp;</span>
<span class="lineNum">    1375 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :         !( string[i] &gt;= '0' &amp;&amp; string[i] &lt;= '9' ) &amp;&amp;</span>
<span class="lineNum">    1376 </span>[<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>][<span class="branchCov" title="Branch 2 was taken X times"> + </span><span class="branchCov" title="Branch 3 was taken X times"> + </span>]:<span class="lineCov">          1 :         string[i] != '-' &amp;&amp; string[i] != '.' &amp;&amp;</span>
<span class="lineNum">    1377 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :         string[i] != ':' &amp;&amp; string[i] != '_' )</span>
<span class="lineNum">    1378 </span>                :            :       return MS_FALSE;
<span class="lineNum">    1379 </span>                :            :   }
<span class="lineNum">    1380 </span>                :            : 
<span class="lineNum">    1381 </span>                :            :   return MS_TRUE;
<span class="lineNum">    1382 </span>                :            : }
<span class="lineNum">    1383 </span>                :            : 
<span class="lineNum">    1384 </span>                :            : 
<span class="lineNum">    1385 </span>                :            : /*
<a name="1386"><span class="lineNum">    1386 </span>                :            :  * Concatenate pszSrc to pszDest and reallocate memory if necessary.</a>
<span class="lineNum">    1387 </span>                :            : */
<span class="lineNum">    1388 </span>                :<span class="lineCov">          1 : char *msStringConcatenate(char *pszDest, const char *pszSrc)</span>
<span class="lineNum">    1389 </span>                :            : {
<span class="lineNum">    1390 </span>                :            :   int nLen;
<span class="lineNum">    1391 </span>                :            : 
<span class="lineNum">    1392 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :   if (pszSrc == NULL)</span>
<span class="lineNum">    1393 </span>                :            :     return pszDest;
<span class="lineNum">    1394 </span>                :            : 
<span class="lineNum">    1395 </span>                :            :   /* if destination is null, allocate memory */
<span class="lineNum">    1396 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :   if (pszDest == NULL) {</span>
<span class="lineNum">    1397 </span>                :<span class="lineCov">          1 :     pszDest = msStrdup(pszSrc);</span>
<span class="lineNum">    1398 </span>                :            :   } else { /* if dest is not null, reallocate memory */
<span class="lineNum">    1399 </span>                :            :     char *pszTemp;
<span class="lineNum">    1400 </span>                :            : 
<span class="lineNum">    1401 </span>                :<span class="lineCov">          1 :     nLen = strlen(pszDest) + strlen(pszSrc);</span>
<span class="lineNum">    1402 </span>                :            : 
<span class="lineNum">    1403 </span>                :<span class="lineCov">          1 :     pszTemp = (char*)realloc(pszDest, nLen + 1);</span>
<span class="lineNum">    1404 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :     if (pszTemp) {</span>
<span class="lineNum">    1405 </span>                :            :       pszDest = pszTemp;
<span class="lineNum">    1406 </span>                :            :       strcat(pszDest, pszSrc);
<span class="lineNum">    1407 </span>                :<span class="lineCov">          1 :       pszDest[nLen] = '\0';</span>
<span class="lineNum">    1408 </span>                :            :     } else {
<span class="lineNum">    1409 </span>                :<span class="lineNoCov">          0 :       msSetError(MS_MEMERR, &quot;Error while reallocating memory.&quot;, &quot;msStringConcatenate()&quot;);</span>
<span class="lineNum">    1410 </span>                :<span class="lineNoCov">          0 :       return NULL;</span>
<span class="lineNum">    1411 </span>                :            :     }
<span class="lineNum">    1412 </span>                :            :   }
<span class="lineNum">    1413 </span>                :            : 
<span class="lineNum">    1414 </span>                :<span class="lineCov">          1 :   return pszDest;</span>
<a name="1415"><span class="lineNum">    1415 </span>                :            : }</a>
<span class="lineNum">    1416 </span>                :            : 
<span class="lineNum">    1417 </span>                :<span class="lineNoCov">          0 : char *msJoinStrings(char **array, int arrayLength, const char *delimeter)</span>
<span class="lineNum">    1418 </span>                :            : {
<span class="lineNum">    1419 </span>                :            :   char *string;
<span class="lineNum">    1420 </span>                :            :   int stringLength=0;
<span class="lineNum">    1421 </span>                :            :   int delimeterLength;
<span class="lineNum">    1422 </span>                :            :   int i;
<span class="lineNum">    1423 </span>                :            : 
<span class="lineNum">    1424 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :   if(!array || arrayLength &lt;= 0 || !delimeter) return NULL;</span>
<span class="lineNum">    1425 </span>                :            : 
<span class="lineNum">    1426 </span>                :<span class="lineNoCov">          0 :   delimeterLength = strlen(delimeter);</span>
<span class="lineNum">    1427 </span>                :            : 
<span class="lineNum">    1428 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :   for(i=0; i&lt;arrayLength; i++)</span>
<span class="lineNum">    1429 </span>                :<span class="lineNoCov">          0 :     stringLength += strlen(array[i]) + delimeterLength;</span>
<span class="lineNum">    1430 </span>                :            : 
<span class="lineNum">    1431 </span>                :<span class="lineNoCov">          0 :   string = (char *)calloc(stringLength+1, sizeof(char));</span>
<span class="lineNum">    1432 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :   MS_CHECK_ALLOC(string, (stringLength+1)* sizeof(char), NULL);</span>
<span class="lineNum">    1433 </span>                :<span class="lineNoCov">          0 :   string[0] = '\0';</span>
<span class="lineNum">    1434 </span>                :            : 
<span class="lineNum">    1435 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :   for(i=0; i&lt;arrayLength-1; i++) {</span>
<span class="lineNum">    1436 </span>                :<span class="lineNoCov">          0 :     strlcat(string, array[i], stringLength);</span>
<span class="lineNum">    1437 </span>                :<span class="lineNoCov">          0 :     strlcat(string, delimeter, stringLength);</span>
<span class="lineNum">    1438 </span>                :            :   }
<span class="lineNum">    1439 </span>                :<span class="lineNoCov">          0 :   strlcat(string, array[i], stringLength); /* add last element, no delimiter */</span>
<span class="lineNum">    1440 </span>                :            : 
<span class="lineNum">    1441 </span>                :<span class="lineNoCov">          0 :   return string;</span>
<span class="lineNum">    1442 </span>                :            : }
<span class="lineNum">    1443 </span>                :            : 
<span class="lineNum">    1444 </span>                :            : #define HASH_SIZE  16
<span class="lineNum">    1445 </span>                :            : /*
<span class="lineNum">    1446 </span>                :            :  * Return a hashed string for a given input string.
<a name="1447"><span class="lineNum">    1447 </span>                :            :  * The caller should free the return value.</a>
<span class="lineNum">    1448 </span>                :            : */
<span class="lineNum">    1449 </span>                :<span class="lineNoCov">          0 : char *msHashString(const char *pszStr)</span>
<span class="lineNum">    1450 </span>                :            : {
<span class="lineNum">    1451 </span>                :<span class="lineNoCov">          0 :   unsigned char sums[HASH_SIZE] = {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};</span>
<span class="lineNum">    1452 </span>                :            :   char *pszOutBuf = NULL;
<span class="lineNum">    1453 </span>                :            :   size_t bufferSize = 0;
<span class="lineNum">    1454 </span>                :            :   int i=0;
<span class="lineNum">    1455 </span>                :            : 
<span class="lineNum">    1456 </span>                :            :   bufferSize = HASH_SIZE*2+1;
<span class="lineNum">    1457 </span>                :<span class="lineNoCov">          0 :   pszOutBuf = (char*)msSmallMalloc(bufferSize);</span>
<span class="lineNum">    1458 </span>                :            : 
<span class="lineNum">    1459 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :   for(i=0; pszStr &amp;&amp; pszStr[i]; i++) {</span>
<span class="lineNum">    1460 </span>                :<span class="lineNoCov">          0 :     sums[i%HASH_SIZE] += (unsigned char)(pszStr[i]);</span>
<span class="lineNum">    1461 </span>                :            :   }
<span class="lineNum">    1462 </span>                :            : 
<span class="lineNum">    1463 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :   for(i=0; i&lt;HASH_SIZE; i++) {</span>
<span class="lineNum">    1464 </span>                :<span class="lineNoCov">          0 :     snprintf(pszOutBuf + i*2, bufferSize-(i*2), &quot;%02x&quot;, sums[i]);</span>
<span class="lineNum">    1465 </span>                :            :   }
<span class="lineNum">    1466 </span>                :            : 
<span class="lineNum">    1467 </span>                :<span class="lineNoCov">          0 :   return pszOutBuf;</span>
<a name="1468"><span class="lineNum">    1468 </span>                :            : }</a>
<span class="lineNum">    1469 </span>                :            : 
<span class="lineNum">    1470 </span>                :<span class="lineNoCov">          0 : char *msCommifyString(char *str)</span>
<span class="lineNum">    1471 </span>                :            : {
<span class="lineNum">    1472 </span>                :            :   int i, j, old_length, new_length;
<span class="lineNum">    1473 </span>                :            :   int num_commas=0, num_decimal_points=0;
<span class="lineNum">    1474 </span>                :            :   int add_commas;
<span class="lineNum">    1475 </span>                :            : 
<span class="lineNum">    1476 </span>                :            :   char comma=',', decimal_point='.';
<span class="lineNum">    1477 </span>                :            : 
<span class="lineNum">    1478 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :   if(!str) return NULL;</span>
<span class="lineNum">    1479 </span>                :            : 
<span class="lineNum">    1480 </span>                :<span class="lineNoCov">          0 :   num_decimal_points = msCountChars(str, decimal_point);</span>
<span class="lineNum">    1481 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :   if(num_decimal_points &gt; 1) return str;</span>
<span class="lineNum">    1482 </span>                :            : 
<span class="lineNum">    1483 </span>                :<span class="lineNoCov">          0 :   old_length = strlen(str);</span>
<span class="lineNum">    1484 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :   if(num_decimal_points == 0) {</span>
<span class="lineNum">    1485 </span>                :<span class="lineNoCov">          0 :     num_commas =  floor((old_length - 1)/3);</span>
<span class="lineNum">    1486 </span>                :            :     add_commas=1; /* add commas right away */
<span class="lineNum">    1487 </span>                :            :   } else {
<span class="lineNum">    1488 </span>                :<span class="lineNoCov">          0 :     num_commas = floor(((old_length - strlen(strchr(str, decimal_point))) - 1)/3);</span>
<span class="lineNum">    1489 </span>                :            :     add_commas=0; /* wait until after the decimal point */
<span class="lineNum">    1490 </span>                :            :   }
<span class="lineNum">    1491 </span>                :            : 
<span class="lineNum">    1492 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :   if(num_commas &lt; 1) return str; /* nothing to add */</span>
<span class="lineNum">    1493 </span>                :            : 
<span class="lineNum">    1494 </span>                :<span class="lineNoCov">          0 :   new_length = old_length + num_commas;</span>
<span class="lineNum">    1495 </span>                :<span class="lineNoCov">          0 :   str = (char *) msSmallRealloc(str, new_length+1);</span>
<span class="lineNum">    1496 </span>                :<span class="lineNoCov">          0 :   str[new_length] = '\0';</span>
<span class="lineNum">    1497 </span>                :            : 
<span class="lineNum">    1498 </span>                :            :   j = 0;
<span class="lineNum">    1499 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :   for(i=new_length-1; i&gt;=0; i--) { /* step backwards through the string */</span>
<span class="lineNum">    1500 </span>                :            : 
<span class="lineNum">    1501 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(num_decimal_points == 1 &amp;&amp;  add_commas == 0) { /* to the right of the decimal point, no commas */</span>
<span class="lineNum">    1502 </span>                :<span class="lineNoCov">          0 :       str[i] = str[i-num_commas];</span>
<span class="lineNum">    1503 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :       if(str[i] == decimal_point) add_commas = 1;</span>
<span class="lineNum">    1504 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     } else if(add_commas == 1 &amp;&amp; j&gt;2) { /* need a comma */</span>
<span class="lineNum">    1505 </span>                :<span class="lineNoCov">          0 :       str[i] = comma;</span>
<span class="lineNum">    1506 </span>                :<span class="lineNoCov">          0 :       num_commas--; /* need one fewer now */</span>
<span class="lineNum">    1507 </span>                :            :       j = 0; /* reset */
<span class="lineNum">    1508 </span>                :            :     } else {
<span class="lineNum">    1509 </span>                :<span class="lineNoCov">          0 :       str[i] = str[i-num_commas]; /* shift to the right */</span>
<span class="lineNum">    1510 </span>                :<span class="lineNoCov">          0 :       j++;</span>
<span class="lineNum">    1511 </span>                :            :     }
<span class="lineNum">    1512 </span>                :            : 
<span class="lineNum">    1513 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(num_commas == 0) break; /* done, rest of string is ok &quot;as is&quot; */</span>
<span class="lineNum">    1514 </span>                :            :   }
<span class="lineNum">    1515 </span>                :            : 
<span class="lineNum">    1516 </span>                :            :   return str;
<span class="lineNum">    1517 </span>                :            : }
<span class="lineNum">    1518 </span>                :            : 
<span class="lineNum">    1519 </span>                :            : 
<span class="lineNum">    1520 </span>                :            : /* ------------------------------------------------------------------------------- */
<span class="lineNum">    1521 </span>                :            : /*       Replace all occurances of old with new in str.                            */
<span class="lineNum">    1522 </span>                :            : /*       It is assumed that str was dynamically created using malloc.              */
<a name="1523"><span class="lineNum">    1523 </span>                :            : /*       Same function as msReplaceSubstring but this is case incensitive                        */</a>
<span class="lineNum">    1524 </span>                :            : /* ------------------------------------------------------------------------------- */
<span class="lineNum">    1525 </span>                :<span class="lineCov">          1 : char *msCaseReplaceSubstring(char *str, const char *old, const char *new)</span>
<span class="lineNum">    1526 </span>                :            : {
<span class="lineNum">    1527 </span>                :            :   size_t str_len, old_len, new_len, tmp_offset;
<span class="lineNum">    1528 </span>                :            :   char *tmp_ptr;
<span class="lineNum">    1529 </span>                :            : 
<span class="lineNum">    1530 </span>                :            :   /*
<span class="lineNum">    1531 </span>                :            :   ** If old is not found then leave str alone
<span class="lineNum">    1532 </span>                :            :   */
<span class="lineNum">    1533 </span>        [<span class="branchCov" title="Branch 1 was taken X times"> + </span><span class="branchCov" title="Branch 2 was taken X times"> + </span>]:<span class="lineCov">          1 :   if( (tmp_ptr = (char *) strcasestr(str, old)) == NULL)</span>
<span class="lineNum">    1534 </span>                :            :     return(str);
<span class="lineNum">    1535 </span>                :            :   
<span class="lineNum">    1536 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :   if(new == NULL)</span>
<span class="lineNum">    1537 </span>                :            :     new = &quot;&quot;;
<span class="lineNum">    1538 </span>                :            : 
<span class="lineNum">    1539 </span>                :            : 
<span class="lineNum">    1540 </span>                :            :   /*
<span class="lineNum">    1541 </span>                :            :   ** Grab some info about incoming strings
<span class="lineNum">    1542 </span>                :            :   */
<span class="lineNum">    1543 </span>                :<span class="lineCov">          1 :   str_len = strlen(str);</span>
<span class="lineNum">    1544 </span>                :<span class="lineCov">          1 :   old_len = strlen(old);</span>
<span class="lineNum">    1545 </span>                :<span class="lineCov">          1 :   new_len = strlen(new);</span>
<span class="lineNum">    1546 </span>                :            : 
<span class="lineNum">    1547 </span>                :            :   /*
<span class="lineNum">    1548 </span>                :            :   ** Now loop until old is NOT found in new
<span class="lineNum">    1549 </span>                :            :   */
<span class="lineNum">    1550 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :   while( tmp_ptr != NULL ) {</span>
<span class="lineNum">    1551 </span>                :            : 
<span class="lineNum">    1552 </span>                :            :     /*
<span class="lineNum">    1553 </span>                :            :     ** re-allocate memory for buf assuming 1 replacement of old with new
<span class="lineNum">    1554 </span>                :            :           ** don't bother reallocating if old is larger than new)
<span class="lineNum">    1555 </span>                :            :     */
<span class="lineNum">    1556 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :     if (old_len &lt; new_len) {</span>
<span class="lineNum">    1557 </span>                :<span class="lineCov">          1 :       tmp_offset = tmp_ptr - str;</span>
<span class="lineNum">    1558 </span>                :<span class="lineCov">          1 :       str_len = str_len - old_len + new_len;</span>
<span class="lineNum">    1559 </span>                :<span class="lineCov">          1 :       str = (char *)msSmallRealloc(str, (str_len + 1)); /* make new space for a copy */</span>
<span class="lineNum">    1560 </span>                :<span class="lineCov">          1 :       tmp_ptr = str + tmp_offset;</span>
<span class="lineNum">    1561 </span>                :            :     }
<span class="lineNum">    1562 </span>                :            : 
<span class="lineNum">    1563 </span>                :            :     /*
<span class="lineNum">    1564 </span>                :            :     ** Move the trailing part of str to make some room unless old_len == new_len
<span class="lineNum">    1565 </span>                :            :     */
<span class="lineNum">    1566 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :     if (old_len != new_len) {</span>
<span class="lineNum">    1567 </span>                :<span class="lineCov">          1 :       memmove(tmp_ptr+new_len, tmp_ptr+old_len, strlen(tmp_ptr)-old_len+1);</span>
<span class="lineNum">    1568 </span>                :            :     }
<span class="lineNum">    1569 </span>                :            : 
<span class="lineNum">    1570 </span>                :            :     /*
<span class="lineNum">    1571 </span>                :            :     ** Now copy new over old
<span class="lineNum">    1572 </span>                :            :     */
<span class="lineNum">    1573 </span>                :<span class="lineCov">          1 :     memcpy(tmp_ptr, new, new_len);</span>
<span class="lineNum">    1574 </span>                :            : 
<span class="lineNum">    1575 </span>                :            :     /*
<span class="lineNum">    1576 </span>                :            :     ** And look for more matches in the rest of the string
<span class="lineNum">    1577 </span>                :            :     */
<span class="lineNum">    1578 </span>                :<span class="lineCov">          1 :     tmp_ptr = (char *) strcasestr(tmp_ptr + new_len, old);</span>
<span class="lineNum">    1579 </span>                :            :   }
<span class="lineNum">    1580 </span>                :            : 
<span class="lineNum">    1581 </span>                :            :   return(str);
<span class="lineNum">    1582 </span>                :            : }
<span class="lineNum">    1583 </span>                :            : 
<span class="lineNum">    1584 </span>                :            : /*
<a name="1585"><span class="lineNum">    1585 </span>                :            : ** Converts a 2 character hexidecimal string to an integer.</a>
<span class="lineNum">    1586 </span>                :            : */
<span class="lineNum">    1587 </span>                :<span class="lineCov">          1 : int msHexToInt(char *hex)</span>
<span class="lineNum">    1588 </span>                :            : {
<span class="lineNum">    1589 </span>                :            :   int number;
<span class="lineNum">    1590 </span>                :            : 
<span class="lineNum">    1591 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :   number = (hex[0] &gt;= 'A' ? ((hex[0] &amp; 0xdf) - 'A')+10 : (hex[0] - '0'));</span>
<span class="lineNum">    1592 </span>                :<span class="lineCov">          1 :   number *= 16;</span>
<span class="lineNum">    1593 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :   number += (hex[1] &gt;= 'A' ? ((hex[1] &amp; 0xdf) - 'A')+10 : (hex[1] - '0'));</span>
<span class="lineNum">    1594 </span>                :            : 
<span class="lineNum">    1595 </span>                :<span class="lineCov">          1 :   return(number);</span>
<span class="lineNum">    1596 </span>                :            : }
<span class="lineNum">    1597 </span>                :            : 
<span class="lineNum">    1598 </span>                :            : 
<span class="lineNum">    1599 </span>                :            : /*
<span class="lineNum">    1600 </span>                :            : ** Use FRIBIDI to encode the string.
<span class="lineNum">    1601 </span>                :            : ** The return value must be freed by the caller.
<a name="1602"><span class="lineNum">    1602 </span>                :            : */</a>
<span class="lineNum">    1603 </span>                :            : #ifdef USE_FRIBIDI
<span class="lineNum">    1604 </span>                :<span class="lineNoCov">          0 : char *msGetFriBidiEncodedString(const char *string, const char *encoding)</span>
<span class="lineNum">    1605 </span>                :            : {
<span class="lineNum">    1606 </span>                :            :   FriBidiChar logical[MAX_STR_LEN];
<span class="lineNum">    1607 </span>                :            :   FriBidiParType base;
<span class="lineNum">    1608 </span>                :            :   size_t len;
<span class="lineNum">    1609 </span>                :            : 
<span class="lineNum">    1610 </span>                :            : #ifdef FRIBIDI_NO_CHARSETS
<span class="lineNum">    1611 </span>                :            :   iconv_t to_ucs4, from_ucs4;
<span class="lineNum">    1612 </span>                :            : #else
<span class="lineNum">    1613 </span>                :            :   int to_char_set_num;
<span class="lineNum">    1614 </span>                :            :   int from_char_set_num;
<span class="lineNum">    1615 </span>                :            : #endif
<span class="lineNum">    1616 </span>                :            : 
<span class="lineNum">    1617 </span>                :<span class="lineNoCov">          0 :   len = strlen(string);</span>
<span class="lineNum">    1618 </span>                :            : 
<span class="lineNum">    1619 </span>                :            : #ifdef FRIBIDI_NO_CHARSETS
<span class="lineNum">    1620 </span>                :            :   to_ucs4 = iconv_open (&quot;WCHAR_T&quot;, encoding);
<span class="lineNum">    1621 </span>                :            :   from_ucs4 = iconv_open (&quot;UTF-8&quot;, &quot;WCHAR_T&quot;);
<span class="lineNum">    1622 </span>                :            : #else
<span class="lineNum">    1623 </span>                :<span class="lineNoCov">          0 :   to_char_set_num = fribidi_parse_charset ((char*)encoding);</span>
<span class="lineNum">    1624 </span>                :<span class="lineNoCov">          0 :   from_char_set_num = fribidi_parse_charset (&quot;UTF-8&quot;);</span>
<span class="lineNum">    1625 </span>                :            : #endif
<span class="lineNum">    1626 </span>                :            : 
<span class="lineNum">    1627 </span>                :            : #ifdef FRIBIDI_NO_CHARSETS
<span class="lineNum">    1628 </span>                :            :   if (to_ucs4 == (iconv_t) (-1) || from_ucs4 == (iconv_t) (-1))
<span class="lineNum">    1629 </span>                :            : #else
<span class="lineNum">    1630 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :   if (!to_char_set_num || !from_char_set_num)</span>
<span class="lineNum">    1631 </span>                :            : #endif
<span class="lineNum">    1632 </span>                :            :   {
<span class="lineNum">    1633 </span>                :<span class="lineNoCov">          0 :     msSetError(MS_IDENTERR, &quot;Encoding not supported (%s).&quot;,</span>
<span class="lineNum">    1634 </span>                :            :                &quot;msGetFriBidiEncodedString()&quot;, encoding);
<span class="lineNum">    1635 </span>                :<span class="lineNoCov">          0 :     return NULL;</span>
<span class="lineNum">    1636 </span>                :            :   }
<span class="lineNum">    1637 </span>                :            : 
<span class="lineNum">    1638 </span>                :            : #ifdef FRIBIDI_NO_CHARSETS
<span class="lineNum">    1639 </span>                :            :   {
<span class="lineNum">    1640 </span>                :            :     char *st = string, *ust = (char *) logical;
<span class="lineNum">    1641 </span>                :            :     int in_len = (int) len;
<span class="lineNum">    1642 </span>                :            :     len = sizeof logical;
<span class="lineNum">    1643 </span>                :            :     iconv (to_ucs4, &amp;st, &amp;in_len, &amp;ust, (int *) &amp;len);
<span class="lineNum">    1644 </span>                :            :     len = (FriBidiChar *) ust - logical;
<span class="lineNum">    1645 </span>                :            :   }
<span class="lineNum">    1646 </span>                :            : #else
<span class="lineNum">    1647 </span>                :<span class="lineNoCov">          0 :   len = fribidi_charset_to_unicode (to_char_set_num, (char*)string, len, logical);</span>
<span class="lineNum">    1648 </span>                :            : #endif
<span class="lineNum">    1649 </span>                :            : 
<span class="lineNum">    1650 </span>                :            :   {
<span class="lineNum">    1651 </span>                :            :     FriBidiChar *visual;
<span class="lineNum">    1652 </span>                :            :     char outstring[MAX_STR_LEN];
<span class="lineNum">    1653 </span>                :            :     FriBidiStrIndex *ltov, *vtol;
<span class="lineNum">    1654 </span>                :            :     FriBidiLevel *levels;
<span class="lineNum">    1655 </span>                :            :     FriBidiStrIndex new_len;
<span class="lineNum">    1656 </span>                :            :     fribidi_boolean log2vis;
<span class="lineNum">    1657 </span>                :            :     int i, j;
<span class="lineNum">    1658 </span>                :            : 
<span class="lineNum">    1659 </span>                :<span class="lineNoCov">          0 :     visual = (FriBidiChar *) msSmallMalloc (sizeof (FriBidiChar) * (len + 1));</span>
<span class="lineNum">    1660 </span>                :            :     ltov = NULL;
<span class="lineNum">    1661 </span>                :            :     vtol = NULL;
<span class="lineNum">    1662 </span>                :            :     levels = NULL;
<span class="lineNum">    1663 </span>                :            : 
<span class="lineNum">    1664 </span>                :            :     /* Create a bidi string. */
<span class="lineNum">    1665 </span>                :<span class="lineNoCov">          0 :     log2vis = fribidi_log2vis (logical, len, &amp;base,</span>
<span class="lineNum">    1666 </span>                :            :                                /* output */
<span class="lineNum">    1667 </span>                :            :                                visual, ltov, vtol, levels);
<span class="lineNum">    1668 </span>                :            : 
<span class="lineNum">    1669 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (!log2vis) {</span>
<span class="lineNum">    1670 </span>                :<span class="lineNoCov">          0 :       msSetError(MS_IDENTERR, &quot;Failed to create bidi string.&quot;,</span>
<span class="lineNum">    1671 </span>                :            :                  &quot;msGetFriBidiEncodedString()&quot;);
<span class="lineNum">    1672 </span>                :<span class="lineNoCov">          0 :       return NULL;</span>
<span class="lineNum">    1673 </span>                :            :     }
<span class="lineNum">    1674 </span>                :            : 
<span class="lineNum">    1675 </span>                :            :     new_len = len;
<span class="lineNum">    1676 </span>                :            : 
<span class="lineNum">    1677 </span>                :            :     /* Convert it to utf-8 for display. */
<span class="lineNum">    1678 </span>                :            : #ifdef FRIBIDI_NO_CHARSETS
<span class="lineNum">    1679 </span>                :            :     {
<span class="lineNum">    1680 </span>                :            :       char *str = outstring, *ust = (char *) visual;
<span class="lineNum">    1681 </span>                :            :       int in_len = len * sizeof visual[0];
<span class="lineNum">    1682 </span>                :            :       new_len = sizeof outstring;
<span class="lineNum">    1683 </span>                :            :       iconv (from_ucs4, &amp;ust, &amp;in_len, &amp;str, (int *) &amp;new_len);
<span class="lineNum">    1684 </span>                :            :       *str = '\0';
<span class="lineNum">    1685 </span>                :            :       new_len = str - outstring;
<span class="lineNum">    1686 </span>                :            :     }
<span class="lineNum">    1687 </span>                :            : #else
<span class="lineNum">    1688 </span>                :<span class="lineNoCov">          0 :     new_len =</span>
<span class="lineNum">    1689 </span>                :<span class="lineNoCov">          0 :       fribidi_unicode_to_charset (from_char_set_num,</span>
<span class="lineNum">    1690 </span>                :            :                                   visual, len, outstring);
<span class="lineNum">    1691 </span>                :            : 
<span class="lineNum">    1692 </span>                :            :     /* scan str and compress out FRIBIDI_CHAR_FILL UTF8 characters */
<span class="lineNum">    1693 </span>                :            : 
<span class="lineNum">    1694 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     for (i=0, j=0; i&lt;new_len; i++, j++) {</span>
<span class="lineNum">    1695 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :       if (outstring[i] == '\xef' &amp;&amp; outstring[i+1] == '\xbb' &amp;&amp; outstring[i+2] == '\xbf') {</span>
<span class="lineNum">         </span>        [<span class="branchNoExec" title="Branch 4 was not executed"> # </span><span class="branchNoExec" title="Branch 5 was not executed"> # </span>]
<span class="lineNum">    1696 </span>                :<span class="lineNoCov">          0 :         i += 3;</span>
<span class="lineNum">    1697 </span>                :            :       }
<span class="lineNum">    1698 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :       if (i != j) {</span>
<span class="lineNum">    1699 </span>                :<span class="lineNoCov">          0 :         outstring[j] = outstring[i];</span>
<span class="lineNum">    1700 </span>                :            :       }
<span class="lineNum">    1701 </span>                :            :     }
<span class="lineNum">    1702 </span>                :<span class="lineNoCov">          0 :     outstring[j] = '\0';</span>
<span class="lineNum">    1703 </span>                :            : 
<span class="lineNum">    1704 </span>                :            : #endif
<span class="lineNum">    1705 </span>                :            : 
<span class="lineNum">    1706 </span>                :<span class="lineNoCov">          0 :     free(visual);</span>
<span class="lineNum">    1707 </span>                :<span class="lineNoCov">          0 :     return msStrdup(outstring);</span>
<span class="lineNum">    1708 </span>                :            :   }
<span class="lineNum">    1709 </span>                :            : }
<span class="lineNum">    1710 </span>                :            : #endif
<span class="lineNum">    1711 </span>                :            : 
<span class="lineNum">    1712 </span>                :            : /*
<span class="lineNum">    1713 </span>                :            : ** Simple charset converter. Converts string from specified encoding to UTF-8.
<a name="1714"><span class="lineNum">    1714 </span>                :            : ** The return value must be freed by the caller.</a>
<span class="lineNum">    1715 </span>                :            : */
<span class="lineNum">    1716 </span>                :<span class="lineNoCov">          0 : char *msGetEncodedString(const char *string, const char *encoding)</span>
<span class="lineNum">    1717 </span>                :            : {
<span class="lineNum">    1718 </span>                :            : #ifdef USE_ICONV
<span class="lineNum">    1719 </span>                :            :   iconv_t cd = NULL;
<span class="lineNum">    1720 </span>                :            :   const char *inp;
<span class="lineNum">    1721 </span>                :            :   char *outp, *out = NULL;
<span class="lineNum">    1722 </span>                :            :   size_t len, bufsize, bufleft, iconv_status;
<span class="lineNum">    1723 </span>                :            :   assert(encoding);
<span class="lineNum">    1724 </span>                :            : 
<span class="lineNum">    1725 </span>                :            : #ifdef USE_FRIBIDI
<span class="lineNum">    1726 </span>                :<span class="lineNoCov">          0 :   msAcquireLock(TLOCK_FRIBIDI);</span>
<span class="lineNum">    1727 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :   if(fribidi_parse_charset ((char*)encoding)) {</span>
<span class="lineNum">    1728 </span>                :<span class="lineNoCov">          0 :     char *ret = msGetFriBidiEncodedString(string, encoding);</span>
<span class="lineNum">    1729 </span>                :<span class="lineNoCov">          0 :     msReleaseLock(TLOCK_FRIBIDI);</span>
<span class="lineNum">    1730 </span>                :<span class="lineNoCov">          0 :     return ret;</span>
<span class="lineNum">    1731 </span>                :            :   }
<span class="lineNum">    1732 </span>                :<span class="lineNoCov">          0 :   msReleaseLock(TLOCK_FRIBIDI);</span>
<span class="lineNum">    1733 </span>                :            : #endif
<span class="lineNum">    1734 </span>                :<span class="lineNoCov">          0 :   len = strlen(string);</span>
<span class="lineNum">    1735 </span>                :            : 
<span class="lineNum">    1736 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :   if (len == 0 || strcasecmp(encoding, &quot;UTF-8&quot;)==0)</span>
<span class="lineNum">    1737 </span>                :<span class="lineNoCov">          0 :     return msStrdup(string);    /* Nothing to do: string already in UTF-8 */</span>
<span class="lineNum">    1738 </span>                :            : 
<span class="lineNum">    1739 </span>                :<span class="lineNoCov">          0 :   cd = iconv_open(&quot;UTF-8&quot;, encoding);</span>
<span class="lineNum">    1740 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :   if(cd == (iconv_t)-1) {</span>
<span class="lineNum">    1741 </span>                :<span class="lineNoCov">          0 :     msSetError(MS_IDENTERR, &quot;Encoding not supported by libiconv (%s).&quot;,</span>
<span class="lineNum">    1742 </span>                :            :                &quot;msGetEncodedString()&quot;, encoding);
<span class="lineNum">    1743 </span>                :<span class="lineNoCov">          0 :     return NULL;</span>
<span class="lineNum">    1744 </span>                :            :   }
<span class="lineNum">    1745 </span>                :            : 
<span class="lineNum">    1746 </span>                :<span class="lineNoCov">          0 :   bufsize = len * 6 + 1; /* Each UTF-8 char can be up to 6 bytes */</span>
<span class="lineNum">    1747 </span>                :<span class="lineNoCov">          0 :   inp = string;</span>
<span class="lineNum">    1748 </span>                :<span class="lineNoCov">          0 :   out = (char*) malloc(bufsize);</span>
<span class="lineNum">    1749 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :   if(out == NULL) {</span>
<span class="lineNum">    1750 </span>                :<span class="lineNoCov">          0 :     msSetError(MS_MEMERR, NULL, &quot;msGetEncodedString()&quot;);</span>
<span class="lineNum">    1751 </span>                :<span class="lineNoCov">          0 :     iconv_close(cd);</span>
<span class="lineNum">    1752 </span>                :<span class="lineNoCov">          0 :     return NULL;</span>
<span class="lineNum">    1753 </span>                :            :   }
<span class="lineNum">    1754 </span>                :<span class="lineNoCov">          0 :   strlcpy(out, string, bufsize);</span>
<span class="lineNum">    1755 </span>                :<span class="lineNoCov">          0 :   outp = out;</span>
<span class="lineNum">    1756 </span>                :            : 
<span class="lineNum">    1757 </span>                :<span class="lineNoCov">          0 :   bufleft = bufsize;</span>
<span class="lineNum">    1758 </span>                :            :   iconv_status = -1;
<span class="lineNum">    1759 </span>                :            : 
<span class="lineNum">    1760 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :   while (len &gt; 0) {</span>
<span class="lineNum">    1761 </span>                :<span class="lineNoCov">          0 :     iconv_status = iconv(cd, (char**)&amp;inp, &amp;len, &amp;outp, &amp;bufleft);</span>
<span class="lineNum">    1762 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(iconv_status == -1) {</span>
<span class="lineNum">    1763 </span>                :<span class="lineNoCov">          0 :       msFree(out);</span>
<span class="lineNum">    1764 </span>                :<span class="lineNoCov">          0 :       iconv_close(cd);</span>
<span class="lineNum">    1765 </span>                :<span class="lineNoCov">          0 :       return msStrdup(string);</span>
<span class="lineNum">    1766 </span>                :            :     }
<span class="lineNum">    1767 </span>                :            :   }
<span class="lineNum">    1768 </span>                :<span class="lineNoCov">          0 :   out[bufsize - bufleft] = '\0';</span>
<span class="lineNum">    1769 </span>                :            : 
<span class="lineNum">    1770 </span>                :<span class="lineNoCov">          0 :   iconv_close(cd);</span>
<span class="lineNum">    1771 </span>                :            : 
<span class="lineNum">    1772 </span>                :<span class="lineNoCov">          0 :   return out;</span>
<span class="lineNum">    1773 </span>                :            : #else
<span class="lineNum">    1774 </span>                :            :   if (*string == '\0' || (encoding &amp;&amp; strcasecmp(encoding, &quot;UTF-8&quot;)==0))
<span class="lineNum">    1775 </span>                :            :     return msStrdup(string);    /* Nothing to do: string already in UTF-8 */
<span class="lineNum">    1776 </span>                :            : 
<span class="lineNum">    1777 </span>                :            :   msSetError(MS_MISCERR, &quot;Not implemeted since Iconv is not enabled.&quot;, &quot;msGetEncodedString()&quot;);
<span class="lineNum">    1778 </span>                :            :   return NULL;
<span class="lineNum">    1779 </span>                :            : #endif
<span class="lineNum">    1780 </span>                :            : }
<a name="1781"><span class="lineNum">    1781 </span>                :            : </a>
<span class="lineNum">    1782 </span>                :            : 
<span class="lineNum">    1783 </span>                :<span class="lineCov">          1 : char* msConvertWideStringToUTF8 (const wchar_t* string, const char* encoding)</span>
<span class="lineNum">    1784 </span>                :            : {
<span class="lineNum">    1785 </span>                :            : #ifdef USE_ICONV
<span class="lineNum">    1786 </span>                :            : 
<span class="lineNum">    1787 </span>                :            :   char* output = NULL;
<span class="lineNum">    1788 </span>                :            :   char* errormessage = NULL;
<span class="lineNum">    1789 </span>                :            :   iconv_t cd = NULL;
<span class="lineNum">    1790 </span>                :            :   size_t nStr;
<span class="lineNum">    1791 </span>                :            :   size_t nInSize;
<span class="lineNum">    1792 </span>                :            :   size_t nOutSize;
<span class="lineNum">    1793 </span>                :            :   size_t iconv_status = -1;
<span class="lineNum">    1794 </span>                :            :   size_t nBufferSize;
<span class="lineNum">    1795 </span>                :            : 
<span class="lineNum">    1796 </span>                :<span class="lineCov">          1 :   char* pszUTF8 = NULL;</span>
<span class="lineNum">    1797 </span>                :<span class="lineCov">          1 :   const wchar_t* pwszWide = NULL;</span>
<span class="lineNum">    1798 </span>                :            : 
<span class="lineNum">    1799 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   if (string != NULL) {</span>
<span class="lineNum">    1800 </span>                :<span class="lineCov">          1 :     nStr = wcslen (string);</span>
<span class="lineNum">    1801 </span>                :<span class="lineCov">          1 :     nBufferSize = ((nStr * 6) + 1);</span>
<span class="lineNum">    1802 </span>                :<span class="lineCov">          1 :     output = (char*) msSmallMalloc (nBufferSize);</span>
<span class="lineNum">    1803 </span>                :            : 
<span class="lineNum">    1804 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :     if (nStr == 0) {</span>
<span class="lineNum">    1805 </span>                :            :       /* return an empty 8 byte string */
<span class="lineNum">    1806 </span>                :<span class="lineNoCov">          0 :       output[0] = '\0';</span>
<span class="lineNum">    1807 </span>                :<span class="lineNoCov">          0 :       return output;</span>
<span class="lineNum">    1808 </span>                :            :     }
<span class="lineNum">    1809 </span>                :            : 
<span class="lineNum">    1810 </span>                :<span class="lineCov">          1 :     cd = iconv_open(&quot;UTF-8&quot;, encoding);</span>
<span class="lineNum">    1811 </span>                :            : 
<span class="lineNum">    1812 </span>                :<span class="lineCov">          1 :     nOutSize = nBufferSize;</span>
<span class="lineNum">    1813 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :     if ((iconv_t)-1 != cd) {</span>
<span class="lineNum">    1814 </span>                :<span class="lineCov">          1 :       nInSize = sizeof (wchar_t)*nStr;</span>
<span class="lineNum">    1815 </span>                :<span class="lineCov">          1 :       pszUTF8 = output;</span>
<span class="lineNum">    1816 </span>                :<span class="lineCov">          1 :       pwszWide = string;</span>
<span class="lineNum">    1817 </span>                :<span class="lineCov">          1 :       iconv_status = iconv(cd, (char **)&amp;pwszWide, &amp;nInSize, &amp;pszUTF8, &amp;nOutSize);</span>
<span class="lineNum">    1818 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :       if ((size_t)-1 == iconv_status) {</span>
<span class="lineNum">    1819 </span>  [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span><span class="branchNoExec" title="Branch 4 was not executed"> # </span>]:<span class="lineNoCov">          0 :         switch (errno) {</span>
<span class="lineNum">    1820 </span>                :            :           case E2BIG:
<span class="lineNum">    1821 </span>                :            :             errormessage = &quot;There is not sufficient room in buffer&quot;;
<span class="lineNum">    1822 </span>                :            :             break;
<span class="lineNum">    1823 </span>                :            :           case EILSEQ:
<span class="lineNum">    1824 </span>                :            :             errormessage = &quot;An invalid multibyte sequence has been encountered in the input&quot;;
<span class="lineNum">    1825 </span>                :<span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    1826 </span>                :            :           case EINVAL:
<span class="lineNum">    1827 </span>                :            :             errormessage = &quot;An incomplete multibyte sequence has been encountered in the input&quot;;
<span class="lineNum">    1828 </span>                :<span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    1829 </span>                :            :           default:
<span class="lineNum">    1830 </span>                :            :             errormessage = &quot;Unknown&quot;;
<span class="lineNum">    1831 </span>                :<span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    1832 </span>                :            :         }
<span class="lineNum">    1833 </span>                :<span class="lineNoCov">          0 :         msSetError(MS_MISCERR, &quot;Unable to convert string in encoding '%s' to UTF8 %s&quot;,</span>
<span class="lineNum">    1834 </span>                :            :                    &quot;msConvertWideStringToUTF8()&quot;,
<span class="lineNum">    1835 </span>                :            :                    encoding,errormessage);
<span class="lineNum">    1836 </span>                :<span class="lineNoCov">          0 :         iconv_close(cd);</span>
<span class="lineNum">    1837 </span>                :<span class="lineNoCov">          0 :         msFree(output);</span>
<span class="lineNum">    1838 </span>                :<span class="lineNoCov">          0 :         return NULL;</span>
<span class="lineNum">    1839 </span>                :            :       }
<span class="lineNum">    1840 </span>                :<span class="lineCov">          1 :       iconv_close(cd);</span>
<span class="lineNum">    1841 </span>                :            :     } else {
<span class="lineNum">    1842 </span>                :<span class="lineNoCov">          0 :       msSetError(MS_MISCERR, &quot;Encoding not supported by libiconv (%s).&quot;,</span>
<span class="lineNum">    1843 </span>                :            :                  &quot;msConvertWideStringToUTF8()&quot;,
<span class="lineNum">    1844 </span>                :            :                  encoding);
<span class="lineNum">    1845 </span>                :<span class="lineNoCov">          0 :       msFree(output);</span>
<span class="lineNum">    1846 </span>                :<span class="lineCov">          1 :       return NULL;</span>
<span class="lineNum">    1847 </span>                :            :     }
<span class="lineNum">    1848 </span>                :            : 
<span class="lineNum">    1849 </span>                :            :   } else {
<span class="lineNum">    1850 </span>                :            :     /* we were given a NULL wide string, nothing we can do here */
<span class="lineNum">    1851 </span>                :            :     return NULL;
<span class="lineNum">    1852 </span>                :            :   }
<span class="lineNum">    1853 </span>                :            : 
<span class="lineNum">    1854 </span>                :            :   /* NULL-terminate the output string */
<span class="lineNum">    1855 </span>                :<span class="lineCov">          1 :   output[nBufferSize - nOutSize] = '\0';</span>
<span class="lineNum">    1856 </span>                :<span class="lineCov">          1 :   return output;</span>
<span class="lineNum">    1857 </span>                :            : #else
<span class="lineNum">    1858 </span>                :            :   msSetError(MS_MISCERR, &quot;Not implemented since Iconv is not enabled.&quot;, &quot;msConvertWideStringToUTF8()&quot;);
<span class="lineNum">    1859 </span>                :            :   return NULL;
<span class="lineNum">    1860 </span>                :            : #endif
<span class="lineNum">    1861 </span>                :            : }
<span class="lineNum">    1862 </span>                :            : 
<span class="lineNum">    1863 </span>                :            : /*
<span class="lineNum">    1864 </span>                :            : ** Returns the next glyph in string and advances *in_ptr to the next
<span class="lineNum">    1865 </span>                :            : ** character.
<span class="lineNum">    1866 </span>                :            : **
<span class="lineNum">    1867 </span>                :            : ** If out_string is not NULL then the character (bytes) is copied to this
<span class="lineNum">    1868 </span>                :            : ** buffer and null-terminated. out_string must be a pre-allocated buffer of
<span class="lineNum">    1869 </span>                :            : ** at least 11 bytes.
<span class="lineNum">    1870 </span>                :            : **
<span class="lineNum">    1871 </span>                :            : ** The function returns the number of bytes in this glyph.
<span class="lineNum">    1872 </span>                :            : **
<span class="lineNum">    1873 </span>                :            : ** This function treats 3 types of glyph encodings:
<span class="lineNum">    1874 </span>                :            : *   - as an html entity, for example &amp;#123; , &amp;#x1af; , or &amp;eacute;
<span class="lineNum">    1875 </span>                :            : *   - as an utf8 encoded character
<span class="lineNum">    1876 </span>                :            : *   - if utf8 decoding fails, as a raw character
<span class="lineNum">    1877 </span>                :            : *
<span class="lineNum">    1878 </span>                :            : ** This function mimics the character decoding function used in gdft.c of
<span class="lineNum">    1879 </span>                :            : * libGD. It is necessary to have the same behaviour, as input strings must be
<span class="lineNum">    1880 </span>                :            : * split into the same glyphs as what gd does.
<span class="lineNum">    1881 </span>                :            : **
<span class="lineNum">    1882 </span>                :            : ** In UTF-8, the number of leading 1 bits in the first byte specifies the
<span class="lineNum">    1883 </span>                :            : ** number of bytes in the entire sequence.
<span class="lineNum">    1884 </span>                :            : ** Source: http://www.cl.cam.ac.uk/~mgk25/unicode.html#utf-8
<span class="lineNum">    1885 </span>                :            : **
<span class="lineNum">    1886 </span>                :            : ** U-00000000 U-0000007F: 0xxxxxxx
<span class="lineNum">    1887 </span>                :            : ** U-00000080 U-000007FF: 110xxxxx 10xxxxxx
<span class="lineNum">    1888 </span>                :            : ** U-00000800 U-0000FFFF: 1110xxxx 10xxxxxx 10xxxxxx
<span class="lineNum">    1889 </span>                :            : ** U-00010000 U-001FFFFF: 11110xxx 10xxxxxx 10xxxxxx 10xxxxxx
<span class="lineNum">    1890 </span>                :            : ** U-00200000 U-03FFFFFF: 111110xx 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx
<a name="1891"><span class="lineNum">    1891 </span>                :            : ** U-04000000 U-7FFFFFFF: 1111110x 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx</a>
<span class="lineNum">    1892 </span>                :            : */
<span class="lineNum">    1893 </span>                :<span class="lineNoCov">          0 : int msGetNextGlyph(const char **in_ptr, char *out_string)</span>
<span class="lineNum">    1894 </span>                :            : {
<span class="lineNum">    1895 </span>                :            :   unsigned char in;
<span class="lineNum">    1896 </span>                :            :   int numbytes=0;
<span class="lineNum">    1897 </span>                :            :   unsigned int unicode;
<span class="lineNum">    1898 </span>                :            :   int i;
<span class="lineNum">    1899 </span>                :            : 
<span class="lineNum">    1900 </span>                :<span class="lineNoCov">          0 :   in = (unsigned char)**in_ptr;</span>
<span class="lineNum">    1901 </span>                :            : 
<span class="lineNum">    1902 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :   if (in == 0)</span>
<span class="lineNum">    1903 </span>                :            :     return -1;  /* Empty string */
<span class="lineNum">    1904 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :   if((numbytes=msGetUnicodeEntity(*in_ptr,&amp;unicode))&gt;0) {</span>
<span class="lineNum">    1905 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if(out_string) {</span>
<span class="lineNum">    1906 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :       for(i=0; i&lt;numbytes; i++) {</span>
<span class="lineNum">    1907 </span>                :<span class="lineNoCov">          0 :         out_string[i]=(*in_ptr)[i];</span>
<span class="lineNum">    1908 </span>                :            :       }
<span class="lineNum">    1909 </span>                :<span class="lineNoCov">          0 :       out_string[numbytes]='\0';</span>
<span class="lineNum">    1910 </span>                :            :     }
<span class="lineNum">    1911 </span>                :<span class="lineNoCov">          0 :     *in_ptr+=numbytes;</span>
<span class="lineNum">    1912 </span>                :<span class="lineNoCov">          0 :     return numbytes;</span>
<span class="lineNum">    1913 </span>                :            :   }
<span class="lineNum">    1914 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :   if (in &lt; 0xC0) {</span>
<span class="lineNum">    1915 </span>                :            :     /*
<span class="lineNum">    1916 </span>                :            :     * Handles properly formed UTF-8 characters between
<span class="lineNum">    1917 </span>                :            :     * 0x01 and 0x7F.  Also treats \0 and naked trail
<span class="lineNum">    1918 </span>                :            :     * bytes 0x80 to 0xBF as valid characters representing
<span class="lineNum">    1919 </span>                :            :     * themselves.
<span class="lineNum">    1920 </span>                :            :     */
<span class="lineNum">    1921 </span>                :            :     /*goto end of loop to return just the char*/
<span class="lineNum">    1922 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :   } else if (in &lt; 0xE0) {</span>
<span class="lineNum">    1923 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (((*in_ptr)[1]&amp; 0xC0) == 0x80) {</span>
<span class="lineNum">    1924 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :       if(out_string) {</span>
<span class="lineNum">    1925 </span>                :<span class="lineNoCov">          0 :         out_string[0]=in;</span>
<span class="lineNum">    1926 </span>                :<span class="lineNoCov">          0 :         out_string[1]=(*in_ptr)[1];</span>
<span class="lineNum">    1927 </span>                :<span class="lineNoCov">          0 :         out_string[2]='\0';</span>
<span class="lineNum">    1928 </span>                :            :       }
<span class="lineNum">    1929 </span>                :<span class="lineNoCov">          0 :       *in_ptr+=2;</span>
<span class="lineNum">    1930 </span>                :<span class="lineNoCov">          0 :       return 2; /*110xxxxx 10xxxxxx*/</span>
<span class="lineNum">    1931 </span>                :            :     }
<span class="lineNum">    1932 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :   } else if (in &lt; 0xF0) {</span>
<span class="lineNum">    1933 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (((*in_ptr)[1]&amp; 0xC0) == 0x80 &amp;&amp; ((*in_ptr)[2]&amp; 0xC0) == 0x80) {</span>
<span class="lineNum">    1934 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :       if(out_string) {</span>
<span class="lineNum">    1935 </span>                :<span class="lineNoCov">          0 :         out_string[0]=in;</span>
<span class="lineNum">    1936 </span>                :<span class="lineNoCov">          0 :         *in_ptr+=numbytes;</span>
<span class="lineNum">    1937 </span>                :<span class="lineNoCov">          0 :         out_string[1]=(*in_ptr)[1];</span>
<span class="lineNum">    1938 </span>                :<span class="lineNoCov">          0 :         out_string[2]=(*in_ptr)[2];</span>
<span class="lineNum">    1939 </span>                :<span class="lineNoCov">          0 :         out_string[3]='\0';</span>
<span class="lineNum">    1940 </span>                :            :       }
<span class="lineNum">    1941 </span>                :<span class="lineNoCov">          0 :       *in_ptr+=3;</span>
<span class="lineNum">    1942 </span>                :<span class="lineNoCov">          0 :       return 3;   /* 1110xxxx 10xxxxxx 10xxxxxx */</span>
<span class="lineNum">    1943 </span>                :            :     }
<span class="lineNum">    1944 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :   } else if (in &lt; 0xF8) {</span>
<span class="lineNum">    1945 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (((*in_ptr)[1]&amp; 0xC0) == 0x80 &amp;&amp; ((*in_ptr)[2]&amp; 0xC0) == 0x80</span>
<span class="lineNum">    1946 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         &amp;&amp; ((*in_ptr)[3]&amp; 0xC0) == 0x80) {</span>
<span class="lineNum">    1947 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :       if(out_string) {</span>
<span class="lineNum">    1948 </span>                :<span class="lineNoCov">          0 :         out_string[0]=in;</span>
<span class="lineNum">    1949 </span>                :<span class="lineNoCov">          0 :         out_string[1]=(*in_ptr)[1];</span>
<span class="lineNum">    1950 </span>                :<span class="lineNoCov">          0 :         out_string[2]=(*in_ptr)[2];</span>
<span class="lineNum">    1951 </span>                :<span class="lineNoCov">          0 :         out_string[3]=(*in_ptr)[3];</span>
<span class="lineNum">    1952 </span>                :<span class="lineNoCov">          0 :         out_string[4]='\0';</span>
<span class="lineNum">    1953 </span>                :            :       }
<span class="lineNum">    1954 </span>                :<span class="lineNoCov">          0 :       *in_ptr+=4;</span>
<span class="lineNum">    1955 </span>                :<span class="lineNoCov">          0 :       return 4;   /* 11110xxx 10xxxxxx 10xxxxxx 10xxxxxx */</span>
<span class="lineNum">    1956 </span>                :            :     }
<span class="lineNum">    1957 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :   } else if (in &lt; 0xFC) {</span>
<span class="lineNum">    1958 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (((*in_ptr)[1]&amp; 0xC0) == 0x80 &amp;&amp; ((*in_ptr)[2]&amp; 0xC0) == 0x80</span>
<span class="lineNum">    1959 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         &amp;&amp; ((*in_ptr)[3]&amp; 0xC0) == 0x80 &amp;&amp; ((*in_ptr)[4]&amp; 0xC0) == 0x80) {</span>
<span class="lineNum">    1960 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :       if(out_string) {</span>
<span class="lineNum">    1961 </span>                :<span class="lineNoCov">          0 :         out_string[0]=in;</span>
<span class="lineNum">    1962 </span>                :<span class="lineNoCov">          0 :         out_string[1]=(*in_ptr)[1];</span>
<span class="lineNum">    1963 </span>                :<span class="lineNoCov">          0 :         out_string[2]=(*in_ptr)[2];</span>
<span class="lineNum">    1964 </span>                :<span class="lineNoCov">          0 :         out_string[3]=(*in_ptr)[3];</span>
<span class="lineNum">    1965 </span>                :<span class="lineNoCov">          0 :         out_string[4]=(*in_ptr)[4];</span>
<span class="lineNum">    1966 </span>                :<span class="lineNoCov">          0 :         out_string[5]='\0';</span>
<span class="lineNum">    1967 </span>                :            :       }
<span class="lineNum">    1968 </span>                :<span class="lineNoCov">          0 :       *in_ptr+=5;</span>
<span class="lineNum">    1969 </span>                :<span class="lineNoCov">          0 :       return 5;   /* 111110xx 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx */</span>
<span class="lineNum">    1970 </span>                :            :     }
<span class="lineNum">    1971 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :   } else if (in &lt; 0xFE) {</span>
<span class="lineNum">    1972 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :     if (((*in_ptr)[1]&amp; 0xC0) == 0x80 &amp;&amp; ((*in_ptr)[2]&amp; 0xC0) == 0x80</span>
<span class="lineNum">    1973 </span>[<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>][<span class="branchNoExec" title="Branch 2 was not executed"> # </span><span class="branchNoExec" title="Branch 3 was not executed"> # </span>]:<span class="lineNoCov">          0 :         &amp;&amp; ((*in_ptr)[3]&amp; 0xC0) == 0x80 &amp;&amp; ((*in_ptr)[4]&amp; 0xC0) == 0x80</span>
<span class="lineNum">    1974 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         &amp;&amp; ((*in_ptr)[5]&amp; 0xC0) == 0x80) {</span>
<span class="lineNum">    1975 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :       if(out_string) {</span>
<span class="lineNum">    1976 </span>                :<span class="lineNoCov">          0 :         out_string[0]=in;</span>
<span class="lineNum">    1977 </span>                :<span class="lineNoCov">          0 :         out_string[1]=(*in_ptr)[1];</span>
<span class="lineNum">    1978 </span>                :<span class="lineNoCov">          0 :         out_string[2]=(*in_ptr)[2];</span>
<span class="lineNum">    1979 </span>                :<span class="lineNoCov">          0 :         out_string[3]=(*in_ptr)[3];</span>
<span class="lineNum">    1980 </span>                :<span class="lineNoCov">          0 :         out_string[4]=(*in_ptr)[4];</span>
<span class="lineNum">    1981 </span>                :<span class="lineNoCov">          0 :         out_string[5]=(*in_ptr)[5];</span>
<span class="lineNum">    1982 </span>                :<span class="lineNoCov">          0 :         out_string[6]='\0';</span>
<span class="lineNum">    1983 </span>                :            :       }
<span class="lineNum">    1984 </span>                :<span class="lineNoCov">          0 :       *in_ptr+=6;</span>
<span class="lineNum">    1985 </span>                :<span class="lineNoCov">          0 :       return 6;   /* 1111110x 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx 10xxxxxx */</span>
<span class="lineNum">    1986 </span>                :            :     }
<span class="lineNum">    1987 </span>                :            :   }
<span class="lineNum">    1988 </span>                :            : 
<span class="lineNum">    1989 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :   if (out_string) {</span>
<span class="lineNum">    1990 </span>                :<span class="lineNoCov">          0 :     out_string[0]=in;</span>
<span class="lineNum">    1991 </span>                :<span class="lineNoCov">          0 :     out_string[1] = '\0';   /* 0xxxxxxx */</span>
<span class="lineNum">    1992 </span>                :            :   }
<span class="lineNum">    1993 </span>                :<span class="lineNoCov">          0 :   (*in_ptr)++;</span>
<span class="lineNum">    1994 </span>                :<span class="lineNoCov">          0 :   return 1;</span>
<span class="lineNum">    1995 </span>                :            : }
<span class="lineNum">    1996 </span>                :            : 
<span class="lineNum">    1997 </span>                :            : /*
<a name="1998"><span class="lineNum">    1998 </span>                :            : ** Returns the number of glyphs in string</a>
<span class="lineNum">    1999 </span>                :            : */
<span class="lineNum">    2000 </span>                :<span class="lineNoCov">          0 : int msGetNumGlyphs(const char *in_ptr)</span>
<span class="lineNum">    2001 </span>                :            : {
<span class="lineNum">    2002 </span>                :            :   int numchars=0;
<span class="lineNum">    2003 </span>                :            : 
<span class="lineNum">    2004 </span>        [<span class="branchNoExec" title="Branch 1 was not executed"> # </span><span class="branchNoExec" title="Branch 2 was not executed"> # </span>]:<span class="lineNoCov">          0 :   while( msGetNextGlyph(&amp;in_ptr, NULL) != -1 )</span>
<span class="lineNum">    2005 </span>                :<span class="lineNoCov">          0 :     numchars++;</span>
<span class="lineNum">    2006 </span>                :            : 
<span class="lineNum">    2007 </span>                :<span class="lineNoCov">          0 :   return numchars;</span>
<a name="2008"><span class="lineNum">    2008 </span>                :            : }</a>
<span class="lineNum">    2009 </span>                :            : 
<span class="lineNum">    2010 </span>                :<span class="lineCov">          1 : static int cmp_entities(const void *e1, const void *e2)</span>
<span class="lineNum">    2011 </span>                :            : {
<span class="lineNum">    2012 </span>                :            :   struct mapentities_s *en1 = (struct mapentities_s *) e1;
<span class="lineNum">    2013 </span>                :            :   struct mapentities_s *en2 = (struct mapentities_s *) e2;
<span class="lineNum">    2014 </span>                :<span class="lineCov">          1 :   return strcmp(en1-&gt;name, en2-&gt;name);</span>
<span class="lineNum">    2015 </span>                :            : }
<span class="lineNum">    2016 </span>                :            : /*
<span class="lineNum">    2017 </span>                :            :  * this function tests if the string pointed by inptr represents
<span class="lineNum">    2018 </span>                :            :  * an HTML entity, in decimal form ( e.g. &amp;#197;), in hexadecimal
<span class="lineNum">    2019 </span>                :            :  * form ( e.g. &amp;#x6C34; ), or from html 4.0 spec ( e.g. &amp;eacute; )
<span class="lineNum">    2020 </span>                :            :  * - returns returns 0 if the string doesn't represent such an entity.
<span class="lineNum">    2021 </span>                :            :  * - if the string does start with such entity,it returns the number of
<a name="2022"><span class="lineNum">    2022 </span>                :            :  * bytes occupied by said entity, and stores the unicode value in *unicode</a>
<span class="lineNum">    2023 </span>                :            :  */
<span class="lineNum">    2024 </span>                :<span class="lineCov">          1 : int msGetUnicodeEntity(const char *inptr, unsigned int *unicode)</span>
<span class="lineNum">    2025 </span>                :            : {
<span class="lineNum">    2026 </span>                :            :   unsigned char *in = (unsigned char*)inptr;
<span class="lineNum">    2027 </span>                :            :   int l,val=0;
<span class="lineNum">    2028 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   if(*in=='&amp;') {</span>
<span class="lineNum">    2029 </span>                :<span class="lineCov">          1 :     in++;</span>
<span class="lineNum">    2030 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :     if(*in=='#') {</span>
<span class="lineNum">    2031 </span>                :<span class="lineCov">          1 :       in++;</span>
<span class="lineNum">    2032 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :       if(*in=='x'||*in=='X') {</span>
<span class="lineNum">    2033 </span>                :<span class="lineNoCov">          0 :         in++;</span>
<span class="lineNum">    2034 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         for(l=3; l&lt;8; l++) {</span>
<span class="lineNum">    2035 </span>                :            :           char byte;
<span class="lineNum">    2036 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :           if(*in&gt;='0'&amp;&amp;*in&lt;='9')</span>
<span class="lineNum">    2037 </span>                :<span class="lineNoCov">          0 :             byte = *in - '0';</span>
<span class="lineNum">    2038 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :           else if(*in&gt;='a'&amp;&amp;*in&lt;='f')</span>
<span class="lineNum">    2039 </span>                :<span class="lineNoCov">          0 :             byte = *in - 'a' + 10;</span>
<span class="lineNum">    2040 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :           else if(*in&gt;='A'&amp;&amp;*in&lt;='F')</span>
<span class="lineNum">    2041 </span>                :<span class="lineNoCov">          0 :             byte = *in - 'A' + 10;</span>
<span class="lineNum">    2042 </span>                :            :           else
<span class="lineNum">    2043 </span>                :            :             break;
<span class="lineNum">    2044 </span>                :<span class="lineNoCov">          0 :           in++;</span>
<span class="lineNum">    2045 </span>                :<span class="lineNoCov">          0 :           val = (val * 16) + byte;</span>
<span class="lineNum">    2046 </span>                :            :         }
<span class="lineNum">    2047 </span>        [<span class="branchNoExec" title="Branch 0 was not executed"> # </span><span class="branchNoExec" title="Branch 1 was not executed"> # </span>]:<span class="lineNoCov">          0 :         if(*in==';' &amp;&amp; l&gt;3 ) {</span>
<span class="lineNum">    2048 </span>                :<span class="lineNoCov">          0 :           *unicode=val;</span>
<span class="lineNum">    2049 </span>                :<span class="lineNoCov">          0 :           return ++l;</span>
<span class="lineNum">    2050 </span>                :            :         }
<span class="lineNum">    2051 </span>                :            :       } else {
<span class="lineNum">    2052 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :         for(l=2; l&lt;8; l++) {</span>
<span class="lineNum">    2053 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :           if(*in&gt;='0'&amp;&amp;*in&lt;='9') {</span>
<span class="lineNum">    2054 </span>                :<span class="lineCov">          1 :             val = val*10+*in-'0';</span>
<span class="lineNum">    2055 </span>                :<span class="lineCov">          1 :             in++;</span>
<span class="lineNum">    2056 </span>                :            :           } else
<span class="lineNum">    2057 </span>                :            :             break;
<span class="lineNum">    2058 </span>                :            :         }
<span class="lineNum">    2059 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :         if(*in==';' &amp;&amp; l&gt;2 ) {</span>
<span class="lineNum">    2060 </span>                :<span class="lineCov">          1 :           *unicode=val;</span>
<span class="lineNum">    2061 </span>                :<span class="lineCov">          1 :           return ++l;</span>
<span class="lineNum">    2062 </span>                :            :         }
<span class="lineNum">    2063 </span>                :            :       }
<span class="lineNum">    2064 </span>                :            :     } else {
<span class="lineNum">    2065 </span>                :            :       char entity_name_buf[MAP_ENTITY_NAME_LENGTH_MAX+1];
<span class="lineNum">    2066 </span>                :            :       char *p;
<span class="lineNum">    2067 </span>                :            :       struct mapentities_s key, *res;
<span class="lineNum">    2068 </span>                :<span class="lineCov">          1 :       key.name = p = entity_name_buf;</span>
<span class="lineNum">    2069 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :       for (l = 1; l &lt;=  MAP_ENTITY_NAME_LENGTH_MAX+1; l++) {</span>
<span class="lineNum">    2070 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :         if (*in == '\0') /*end of string before possible entity: return*/</span>
<span class="lineNum">    2071 </span>                :            :           break;
<span class="lineNum">    2072 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :         if (*in == ';') { /*possible end of entity: do a lookup*/</span>
<span class="lineNum">    2073 </span>                :<span class="lineCov">          1 :           *p++ = '\0';</span>
<span class="lineNum">    2074 </span>                :<span class="lineCov">          1 :           res = bsearch(&amp;key, mapentities, MAP_NR_OF_ENTITIES,</span>
<span class="lineNum">    2075 </span>                :            :                         sizeof(mapentities[0]), *cmp_entities);
<span class="lineNum">    2076 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :           if (res) {</span>
<span class="lineNum">    2077 </span>                :<span class="lineCov">          1 :             *unicode = res-&gt;value;</span>
<span class="lineNum">    2078 </span>                :<span class="lineCov">          1 :             return ++l;</span>
<span class="lineNum">    2079 </span>                :            :           }
<span class="lineNum">    2080 </span>                :            :           break; /*the string was of the form of an entity but didn't correspond to an existing one: return*/
<span class="lineNum">    2081 </span>                :            :         }
<span class="lineNum">    2082 </span>                :<span class="lineCov">          1 :         *p++ = *in;</span>
<span class="lineNum">    2083 </span>                :<span class="lineCov">          1 :         in++;</span>
<span class="lineNum">    2084 </span>                :            :       }
<span class="lineNum">    2085 </span>                :            :     }
<span class="lineNum">    2086 </span>                :            :   }
<span class="lineNum">    2087 </span>                :            :   return 0;
<span class="lineNum">    2088 </span>                :            : }
<span class="lineNum">    2089 </span>                :            : 
<span class="lineNum">    2090 </span>                :            : /**
<span class="lineNum">    2091 </span>                :            :  * msStringIsInteger()
<span class="lineNum">    2092 </span>                :            :  *
<span class="lineNum">    2093 </span>                :            :  * determines whether a given string is an integer
<span class="lineNum">    2094 </span>                :            :  *
<span class="lineNum">    2095 </span>                :            :  * @param string the string to be tested
<span class="lineNum">    2096 </span>                :            :  *
<span class="lineNum">    2097 </span>                :            :  * @return MS_SUCCESS or MS_FAILURE
<a name="2098"><span class="lineNum">    2098 </span>                :            :  */</a>
<span class="lineNum">    2099 </span>                :            : 
<span class="lineNum">    2100 </span>                :<span class="lineCov">          1 : int msStringIsInteger(const char *string)</span>
<span class="lineNum">    2101 </span>                :            : {
<span class="lineNum">    2102 </span>                :            :   int length, i;
<span class="lineNum">    2103 </span>                :            : 
<span class="lineNum">    2104 </span>                :<span class="lineCov">          1 :   length = strlen(string);</span>
<span class="lineNum">    2105 </span>                :            : 
<span class="lineNum">    2106 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   if (length == 0)</span>
<span class="lineNum">    2107 </span>                :            :     return MS_FAILURE;
<span class="lineNum">    2108 </span>                :            : 
<span class="lineNum">    2109 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :   for(i=0; i&lt;length; i++) {</span>
<span class="lineNum">    2110 </span>        [<span class="branchCov" title="Branch 1 was taken X times"> + </span><span class="branchCov" title="Branch 2 was taken X times"> + </span>]:<span class="lineCov">          1 :     if (!isdigit(string[i]))</span>
<span class="lineNum">    2111 </span>                :            :       return MS_FAILURE;
<span class="lineNum">    2112 </span>                :            :   }
<span class="lineNum">    2113 </span>                :            : 
<span class="lineNum">    2114 </span>                :            :   return MS_SUCCESS;
<span class="lineNum">    2115 </span>                :            : }
<span class="lineNum">    2116 </span>                :            : 
<span class="lineNum">    2117 </span>                :            : /************************************************************************/
<span class="lineNum">    2118 </span>                :            : /*                             msStrdup()                               */
<span class="lineNum">    2119 </span>                :            : /************************************************************************/
<span class="lineNum">    2120 </span>                :            : 
<a name="2121"><span class="lineNum">    2121 </span>                :            : /* Safe version of msStrdup(). This function is taken from gdal/cpl. */</a>
<span class="lineNum">    2122 </span>                :            : 
<span class="lineNum">    2123 </span>                :<span class="lineCov">          1 : char *msStrdup( const char * pszString )</span>
<span class="lineNum">    2124 </span>                :            : {
<span class="lineNum">    2125 </span>                :            :   char        *pszReturn;
<span class="lineNum">    2126 </span>                :            : 
<span class="lineNum">    2127 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :   if( pszString == NULL )</span>
<span class="lineNum">    2128 </span>                :            :     pszString = &quot;&quot;;
<span class="lineNum">    2129 </span>                :            : 
<span class="lineNum">    2130 </span>                :<span class="lineCov">          1 :   pszReturn = strdup( pszString );</span>
<span class="lineNum">    2131 </span>                :            : 
<span class="lineNum">    2132 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :   if( pszReturn == NULL ) {</span>
<span class="lineNum">    2133 </span>                :<span class="lineNoCov">          0 :     fprintf(stderr, &quot;msSmallMsStrdup(): Out of memory allocating %ld bytes.\n&quot;,</span>
<span class="lineNum">    2134 </span>                :<span class="lineNoCov">          0 :             (long) strlen(pszString) );</span>
<span class="lineNum">    2135 </span>                :<span class="lineNoCov">          0 :     exit(1);</span>
<span class="lineNum">    2136 </span>                :            :   }
<span class="lineNum">    2137 </span>                :            : 
<span class="lineNum">    2138 </span>                :<span class="lineCov">          1 :   return( pszReturn );</span>
<span class="lineNum">    2139 </span>                :            : }
<span class="lineNum">    2140 </span>                :            : 
<span class="lineNum">    2141 </span>                :            : 
<span class="lineNum">    2142 </span>                :            : /************************************************************************/
<span class="lineNum">    2143 </span>                :            : /*                             msStringEscape()                         */
<span class="lineNum">    2144 </span>                :            : /************************************************************************/
<span class="lineNum">    2145 </span>                :            : 
<span class="lineNum">    2146 </span>                :            : /* Checks if a string contains single or double quotes and escape them.
<span class="lineNum">    2147 </span>                :            :    NOTE: the user must free the returned char* if it is different than the
<a name="2148"><span class="lineNum">    2148 </span>                :            :    one passed in */</a>
<span class="lineNum">    2149 </span>                :            : 
<span class="lineNum">    2150 </span>                :<span class="lineCov">          1 : char* msStringEscape( const char * pszString )</span>
<span class="lineNum">    2151 </span>                :            : {
<span class="lineNum">    2152 </span>                :            :   char *string_tmp, *string_ptr;
<span class="lineNum">    2153 </span>                :            :   int i,ncharstoescape=0;
<span class="lineNum">    2154 </span>                :            : 
<span class="lineNum">    2155 </span>[<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken X times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          1 :   if (pszString ==  NULL || strlen(pszString) == 0)</span>
<span class="lineNum">    2156 </span>                :<span class="lineNoCov">          0 :     return msStrdup(&quot;&quot;);</span>
<span class="lineNum">    2157 </span>                :            : 
<span class="lineNum">    2158 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :   for (i=0; pszString[i]; i++)</span>
<span class="lineNum">    2159 </span>                :<span class="lineCov">          1 :     ncharstoescape += ((pszString[i] == '\&quot;')||(pszString[i] == '\''));</span>
<span class="lineNum">    2160 </span>                :            :   
<span class="lineNum">    2161 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :   if(!ncharstoescape) {</span>
<span class="lineNum">    2162 </span>                :            :     return (char*)pszString;
<span class="lineNum">    2163 </span>                :            :   }
<span class="lineNum">    2164 </span>                :            : 
<span class="lineNum">    2165 </span>                :<span class="lineCov">          1 :   string_tmp = (char*)msSmallMalloc(strlen(pszString)+ncharstoescape+1);</span>
<span class="lineNum">    2166 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :   for (string_ptr=(char*)pszString,i=0; *string_ptr!='\0'; ++string_ptr,++i) {</span>
<span class="lineNum">    2167 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :     if ( (*string_ptr == '\&quot;') || (*string_ptr == '\'') ) {</span>
<span class="lineNum">    2168 </span>                :<span class="lineCov">          1 :       string_tmp[i] = '\\';</span>
<span class="lineNum">    2169 </span>                :<span class="lineCov">          1 :       ++i;</span>
<span class="lineNum">    2170 </span>                :            :     }
<span class="lineNum">    2171 </span>                :<span class="lineCov">          1 :     string_tmp[i] = *string_ptr;</span>
<span class="lineNum">    2172 </span>                :            :   }
<span class="lineNum">    2173 </span>                :            : 
<span class="lineNum">    2174 </span>                :<span class="lineCov">          1 :   string_tmp[i] = '\0';</span>
<span class="lineNum">    2175 </span>                :<span class="lineCov">          1 :   return string_tmp;</span>
<span class="lineNum">    2176 </span>                :            : }
<span class="lineNum">    2177 </span>                :            : 
<span class="lineNum">    2178 </span>                :            : /************************************************************************/
<span class="lineNum">    2179 </span>                :            : /*                             msStringInArray()                        */
<span class="lineNum">    2180 </span>                :            : /************************************************************************/
<a name="2181"><span class="lineNum">    2181 </span>                :            : </a>
<span class="lineNum">    2182 </span>                :            : /* Check if a string is in a array */
<span class="lineNum">    2183 </span>                :<span class="lineCov">          1 : int msStringInArray( const char * pszString, char **array, int numelements)</span>
<span class="lineNum">    2184 </span>                :            : {
<span class="lineNum">    2185 </span>                :            :   int i;
<span class="lineNum">    2186 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :   for (i=0; i&lt;numelements; ++i) {</span>
<span class="lineNum">    2187 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :     if (strcasecmp(pszString, array[i])==0)</span>
<span class="lineNum">    2188 </span>                :            :       return MS_TRUE;
<span class="lineNum">    2189 </span>                :            :   }
<span class="lineNum">    2190 </span>                :            :   return MS_FALSE;
<a name="2191"><span class="lineNum">    2191 </span>                :            : }</a>
<span class="lineNum">    2192 </span>                :            : 
<span class="lineNum">    2193 </span>                :<span class="lineCov">          1 : int msLayerEncodeShapeAttributes( layerObj *layer, shapeObj *shape) {</span>
<span class="lineNum">    2194 </span>                :            : 
<span class="lineNum">    2195 </span>                :            : #ifdef USE_ICONV
<span class="lineNum">    2196 </span>                :            :   iconv_t cd = NULL;
<span class="lineNum">    2197 </span>                :            :   const char *inp;
<span class="lineNum">    2198 </span>                :            :   char *outp, *out = NULL;
<span class="lineNum">    2199 </span>                :            :   size_t len, bufsize, bufleft, iconv_status;
<span class="lineNum">    2200 </span>                :            :   int i;
<span class="lineNum">    2201 </span>                :            : #endif
<span class="lineNum">    2202 </span>                :            : 
<span class="lineNum">    2203 </span>[<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchCov" title="Branch 2 was taken X times"> + </span><span class="branchNoCov" title="Branch 3 was not taken"> - </span>]:<span class="lineCov">          1 :   if( !layer-&gt;encoding || !*layer-&gt;encoding || !strcasecmp(layer-&gt;encoding, &quot;UTF-8&quot;))</span>
<span class="lineNum">         </span>        [<span class="branchCov" title="Branch 4 was taken X times"> + </span><span class="branchNoCov" title="Branch 5 was not taken"> - </span>]
<span class="lineNum">    2204 </span>                :            :     return MS_SUCCESS;
<span class="lineNum">    2205 </span>                :            : 
<span class="lineNum">    2206 </span>                :<span class="lineCov">          1 :   cd = iconv_open(&quot;UTF-8&quot;, layer-&gt;encoding);</span>
<span class="lineNum">    2207 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>]:<span class="lineCov">          1 :   if(cd == (iconv_t)-1) {</span>
<span class="lineNum">    2208 </span>                :<span class="lineNoCov">          0 :     msSetError(MS_IDENTERR, &quot;Encoding not supported by libiconv (%s).&quot;,</span>
<span class="lineNum">    2209 </span>                :            :                &quot;msGetEncodedString()&quot;, layer-&gt;encoding);
<span class="lineNum">    2210 </span>                :<span class="lineNoCov">          0 :     return MS_FAILURE;</span>
<span class="lineNum">    2211 </span>                :            :   }
<span class="lineNum">    2212 </span>                :            : 
<span class="lineNum">    2213 </span>                :            : #ifdef USE_ICONV
<span class="lineNum">    2214 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :   for(i=0;i &lt;shape-&gt;numvalues; i++) {</span>
<span class="lineNum">    2215 </span>[<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchNoCov" title="Branch 1 was not taken"> - </span>][<span class="branchNoCov" title="Branch 2 was not taken"> - </span><span class="branchCov" title="Branch 3 was taken X times"> + </span>]:<span class="lineCov">          1 :     if(!shape-&gt;values[i] || (len = strlen(shape-&gt;values[i]))==0) {</span>
<span class="lineNum">    2216 </span>                :<span class="lineNoCov">          0 :       continue;    /* Nothing to do */</span>
<span class="lineNum">    2217 </span>                :            :     }
<span class="lineNum">    2218 </span>                :            : 
<span class="lineNum">    2219 </span>                :<span class="lineCov">          1 :     bufsize = len * 6 + 1; /* Each UTF-8 char can be up to 6 bytes */</span>
<span class="lineNum">    2220 </span>                :<span class="lineCov">          1 :     inp = shape-&gt;values[i];</span>
<span class="lineNum">    2221 </span>                :<span class="lineCov">          1 :     out = (char*) msSmallMalloc(bufsize);</span>
<span class="lineNum">    2222 </span>                :            : 
<span class="lineNum">    2223 </span>                :<span class="lineCov">          1 :     strlcpy(out, shape-&gt;values[i], bufsize);</span>
<span class="lineNum">    2224 </span>                :<span class="lineCov">          1 :     outp = out;</span>
<span class="lineNum">    2225 </span>                :            : 
<span class="lineNum">    2226 </span>                :<span class="lineCov">          1 :     bufleft = bufsize;</span>
<span class="lineNum">    2227 </span>                :            :     iconv_status = -1;
<span class="lineNum">    2228 </span>                :            : 
<span class="lineNum">    2229 </span>        [<span class="branchCov" title="Branch 0 was taken X times"> + </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :     while (len &gt; 0) {</span>
<span class="lineNum">    2230 </span>                :<span class="lineCov">          1 :       iconv_status = iconv(cd, (char**)&amp;inp, &amp;len, &amp;outp, &amp;bufleft);</span>
<span class="lineNum">    2231 </span>        [<span class="branchNoCov" title="Branch 0 was not taken"> - </span><span class="branchCov" title="Branch 1 was taken X times"> + </span>]:<span class="lineCov">          1 :       if(iconv_status == -1) {</span>
<span class="lineNum">    2232 </span>                :<span class="lineNoCov">          0 :         msFree(out);</span>
<span class="lineNum">    2233 </span>                :<span class="lineCov">          1 :         continue; /* silently ignore failed conversions */</span>
<span class="lineNum">    2234 </span>                :            :       }
<span class="lineNum">    2235 </span>                :            :     }
<span class="lineNum">    2236 </span>                :<span class="lineCov">          1 :     out[bufsize - bufleft] = '\0';</span>
<span class="lineNum">    2237 </span>                :<span class="lineCov">          1 :     msFree(shape-&gt;values[i]);</span>
<span class="lineNum">    2238 </span>                :<span class="lineCov">          1 :     shape-&gt;values[i] = out;</span>
<span class="lineNum">    2239 </span>                :            :   }
<span class="lineNum">    2240 </span>                :<span class="lineCov">          1 :   iconv_close(cd);</span>
<span class="lineNum">    2241 </span>                :            : 
<span class="lineNum">    2242 </span>                :<span class="lineCov">          1 :   return MS_SUCCESS;</span>
<span class="lineNum">    2243 </span>                :            : #else
<span class="lineNum">    2244 </span>                :            :   msSetError(MS_MISCERR, &quot;Not implemented since Iconv is not enabled.&quot;, &quot;msGetEncodedString()&quot;);
<span class="lineNum">    2245 </span>                :            :   return MS_FAILURE;
<span class="lineNum">    2246 </span>                :            : #endif
<span class="lineNum">    2247 </span>                :            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../../../../../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.9</a></td></tr>
  </table>
  <br>

</body>
</html>

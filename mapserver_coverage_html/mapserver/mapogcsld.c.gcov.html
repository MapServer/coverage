<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - mapserver.info - mapserver/mapogcsld.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">mapserver</a> - mapogcsld.c<span style="font-size: 80%;"> (source / <a href="mapogcsld.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">mapserver.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">1736</td>
            <td class="headerCovTableEntry">2273</td>
            <td class="headerCovTableEntryMed">76.4 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2020-08-07 17:13:37</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">45</td>
            <td class="headerCovTableEntry">51</td>
            <td class="headerCovTableEntryMed">88.2 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /**********************************************************************</a>
<span class="lineNum">       2 </span>            :  * $Id$
<span class="lineNum">       3 </span>            :  *
<span class="lineNum">       4 </span>            :  * Project:  MapServer
<span class="lineNum">       5 </span>            :  * Purpose:  OGC SLD implementation
<span class="lineNum">       6 </span>            :  * Author:   Y. Assefa, DM Solutions Group (assefa@dmsolutions.ca)
<span class="lineNum">       7 </span>            :  *
<span class="lineNum">       8 </span>            :  **********************************************************************
<span class="lineNum">       9 </span>            :  * Copyright (c) 2003, Y. Assefa, DM Solutions Group Inc
<span class="lineNum">      10 </span>            :  *
<span class="lineNum">      11 </span>            :  * Permission is hereby granted, free of charge, to any person obtaining a
<span class="lineNum">      12 </span>            :  * copy of this software and associated documentation files (the &quot;Software&quot;),
<span class="lineNum">      13 </span>            :  * to deal in the Software without restriction, including without limitation
<span class="lineNum">      14 </span>            :  * the rights to use, copy, modify, merge, publish, distribute, sublicense,
<span class="lineNum">      15 </span>            :  * and/or sell copies of the Software, and to permit persons to whom the
<span class="lineNum">      16 </span>            :  * Software is furnished to do so, subject to the following conditions:
<span class="lineNum">      17 </span>            :  *
<span class="lineNum">      18 </span>            :  * The above copyright notice and this permission notice shall be included in
<span class="lineNum">      19 </span>            :  * all copies of this Software or works derived from this Software.
<span class="lineNum">      20 </span>            :  *
<span class="lineNum">      21 </span>            :  * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
<span class="lineNum">      22 </span>            :  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
<span class="lineNum">      23 </span>            :  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL
<span class="lineNum">      24 </span>            :  * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
<span class="lineNum">      25 </span>            :  * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
<span class="lineNum">      26 </span>            :  * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
<span class="lineNum">      27 </span>            :  ****************************************************************************/
<span class="lineNum">      28 </span>            : 
<span class="lineNum">      29 </span>            : #include &quot;mapogcsld.h&quot;
<span class="lineNum">      30 </span>            : #include &quot;mapogcfilter.h&quot;
<span class="lineNum">      31 </span>            : #include &quot;mapserver.h&quot;
<span class="lineNum">      32 </span>            : #include &quot;mapows.h&quot;
<span class="lineNum">      33 </span>            : #include &quot;mapcopy.h&quot;
<span class="lineNum">      34 </span>            : #include &quot;cpl_string.h&quot;
<span class="lineNum">      35 </span>            : 
<span class="lineNum">      36 </span>            : extern int yyparse(parseObj *);
<span class="lineNum">      37 </span>            : 
<span class="lineNum">      38 </span>            : #if defined(USE_CURL)
<span class="lineNum">      39 </span>            : static inline void IGUR_sizet(size_t ignored) { (void)ignored; }  /* Ignore GCC Unused Result */
<span class="lineNum">      40 </span>            : #endif
<span class="lineNum">      41 </span>            : 
<span class="lineNum">      42 </span>            : #define SLD_LINE_SYMBOL_NAME &quot;sld_line_symbol&quot;
<span class="lineNum">      43 </span>            : #define SLD_LINE_SYMBOL_DASH_NAME &quot;sld_line_symbol_dash&quot;
<span class="lineNum">      44 </span>            : #define SLD_MARK_SYMBOL_SQUARE &quot;sld_mark_symbol_square&quot;
<span class="lineNum">      45 </span>            : #define SLD_MARK_SYMBOL_SQUARE_FILLED &quot;sld_mark_symbol_square_filled&quot;
<span class="lineNum">      46 </span>            : #define SLD_MARK_SYMBOL_CIRCLE &quot;sld_mark_symbol_circle&quot;
<span class="lineNum">      47 </span>            : #define SLD_MARK_SYMBOL_CIRCLE_FILLED &quot;sld_mark_symbol_circle_filled&quot;
<span class="lineNum">      48 </span>            : #define SLD_MARK_SYMBOL_TRIANGLE &quot;sld_mark_symbol_triangle&quot;
<span class="lineNum">      49 </span>            : #define SLD_MARK_SYMBOL_TRIANGLE_FILLED &quot;sld_mark_symbol_triangle_filled&quot;
<span class="lineNum">      50 </span>            : #define SLD_MARK_SYMBOL_STAR &quot;sld_mark_symbol_star&quot;
<span class="lineNum">      51 </span>            : #define SLD_MARK_SYMBOL_STAR_FILLED &quot;sld_mark_symbol_star_filled&quot;
<span class="lineNum">      52 </span>            : #define SLD_MARK_SYMBOL_CROSS &quot;sld_mark_symbol_cross&quot;
<span class="lineNum">      53 </span>            : #define SLD_MARK_SYMBOL_CROSS_FILLED &quot;sld_mark_symbol_cross_filled&quot;
<span class="lineNum">      54 </span>            : #define SLD_MARK_SYMBOL_X &quot;sld_mark_symbol_x&quot;
<span class="lineNum">      55 </span>            : #define SLD_MARK_SYMBOL_X_FILLED &quot;sld_mark_symbol_x_filled&quot;
<span class="lineNum">      56 </span>            : 
<span class="lineNum">      57 </span>            : /************************************************************************/
<span class="lineNum">      58 </span>            : /*                             msSLDApplySLDURL                         */
<span class="lineNum">      59 </span>            : /*                                                                      */
<span class="lineNum">      60 </span>            : /*      Use the SLD document given through a URL and apply the SLD      */
<span class="lineNum">      61 </span>            : /*      on the map. Layer name and Named Layer's name parameter are     */
<a name="62"><span class="lineNum">      62 </span>            : /*      used to do the match.                                           */</a>
<span class="lineNum">      63 </span>            : /************************************************************************/
<span class="lineNum">      64 </span><span class="lineCov">          1 : int msSLDApplySLDURL(mapObj *map, const char *szURL, int iLayer,</span>
<span class="lineNum">      65 </span>            :                      const char *pszStyleLayerName,  char **ppszLayerNames)
<span class="lineNum">      66 </span>            : {
<span class="lineNum">      67 </span>            :   /* needed for libcurl function msHTTPGetFile in maphttp.c */
<span class="lineNum">      68 </span>            : #if defined(USE_CURL)
<span class="lineNum">      69 </span>            : 
<span class="lineNum">      70 </span>            :   char *pszSLDTmpFile = NULL;
<span class="lineNum">      71 </span><span class="lineCov">          1 :   int status = 0;</span>
<span class="lineNum">      72 </span>            :   char *pszSLDbuf=NULL;
<span class="lineNum">      73 </span>            :   FILE *fp = NULL;
<span class="lineNum">      74 </span>            :   int nStatus = MS_FAILURE;
<span class="lineNum">      75 </span>            : 
<span class="lineNum">      76 </span><span class="lineCov">          1 :   if (map &amp;&amp; szURL) {</span>
<span class="lineNum">      77 </span><span class="lineCov">          1 :     map-&gt;sldurl = (char*)szURL;</span>
<span class="lineNum">      78 </span><span class="lineCov">          1 :     pszSLDTmpFile = msTmpFile(map, map-&gt;mappath, NULL, &quot;sld.xml&quot;);</span>
<span class="lineNum">      79 </span><span class="lineCov">          1 :     if (pszSLDTmpFile == NULL) {</span>
<span class="lineNum">      80 </span><span class="lineNoCov">          0 :       pszSLDTmpFile = msTmpFile(map, NULL, NULL, &quot;sld.xml&quot; );</span>
<span class="lineNum">      81 </span>            :     }
<span class="lineNum">      82 </span><span class="lineCov">          1 :     if (pszSLDTmpFile == NULL) {</span>
<span class="lineNum">      83 </span><span class="lineNoCov">          0 :       msSetError(MS_WMSERR, &quot;Could not determine temporary file %s. Please make sure that the temporary path is set. The temporary path can be defined for example by setting TEMPPATH in the map file. Please check the MapServer documentation on temporary path settings.&quot;, &quot;msSLDApplySLDURL()&quot;, pszSLDTmpFile);</span>
<span class="lineNum">      84 </span>            :     } else {
<span class="lineNum">      85 </span>            :       int nMaxRemoteSLDBytes;
<span class="lineNum">      86 </span><span class="lineCov">          1 :       const char *pszMaxRemoteSLDBytes = msOWSLookupMetadata(&amp;(map-&gt;web.metadata), &quot;MO&quot;, &quot;remote_sld_max_bytes&quot;);</span>
<span class="lineNum">      87 </span><span class="lineCov">          1 :       if(!pszMaxRemoteSLDBytes) {</span>
<span class="lineNum">      88 </span>            :         nMaxRemoteSLDBytes = 1024*1024; /* 1 megaByte */
<span class="lineNum">      89 </span>            :       } else {
<span class="lineNum">      90 </span>            :         nMaxRemoteSLDBytes = atoi(pszMaxRemoteSLDBytes);
<span class="lineNum">      91 </span>            :       }
<span class="lineNum">      92 </span><span class="lineCov">          1 :       if (msHTTPGetFile(szURL, pszSLDTmpFile, &amp;status,-1, 0, 0, nMaxRemoteSLDBytes) ==  MS_SUCCESS) {</span>
<span class="lineNum">      93 </span><span class="lineCov">          1 :         if ((fp = fopen(pszSLDTmpFile, &quot;rb&quot;)) != NULL) {</span>
<span class="lineNum">      94 </span>            :           int   nBufsize=0;
<span class="lineNum">      95 </span><span class="lineCov">          1 :           fseek(fp, 0, SEEK_END);</span>
<span class="lineNum">      96 </span><span class="lineCov">          1 :           nBufsize = ftell(fp);</span>
<span class="lineNum">      97 </span><span class="lineCov">          1 :           if(nBufsize &gt; 0) {</span>
<span class="lineNum">      98 </span><span class="lineCov">          1 :             rewind(fp);</span>
<span class="lineNum">      99 </span><span class="lineCov">          1 :             pszSLDbuf = (char*)malloc((nBufsize+1)*sizeof(char));</span>
<span class="lineNum">     100 </span><span class="lineCov">          1 :             IGUR_sizet(fread(pszSLDbuf, 1, nBufsize, fp));</span>
<span class="lineNum">     101 </span><span class="lineCov">          1 :             pszSLDbuf[nBufsize] = '\0';</span>
<span class="lineNum">     102 </span>            :           } else {
<span class="lineNum">     103 </span><span class="lineNoCov">          0 :             msSetError(MS_WMSERR, &quot;Could not open SLD %s as it appears empty&quot;, &quot;msSLDApplySLDURL&quot;, szURL);</span>
<span class="lineNum">     104 </span>            :           }
<span class="lineNum">     105 </span><span class="lineCov">          1 :           fclose(fp);</span>
<span class="lineNum">     106 </span><span class="lineCov">          1 :           unlink(pszSLDTmpFile);</span>
<span class="lineNum">     107 </span>            :         }
<span class="lineNum">     108 </span>            :       } else {
<span class="lineNum">     109 </span><span class="lineCov">          1 :         unlink(pszSLDTmpFile);</span>
<span class="lineNum">     110 </span><span class="lineCov">          1 :         msSetError(MS_WMSERR, &quot;Could not open SLD %s and save it in a temporary file. Please make sure that the sld url is valid and that the temporary path is set. The temporary path can be defined for example by setting TEMPPATH in the map file. Please check the MapServer documentation on temporary path settings.&quot;, &quot;msSLDApplySLDURL&quot;, szURL);</span>
<span class="lineNum">     111 </span>            :       }
<span class="lineNum">     112 </span><span class="lineCov">          1 :       msFree(pszSLDTmpFile);</span>
<span class="lineNum">     113 </span><span class="lineCov">          1 :       if (pszSLDbuf)</span>
<span class="lineNum">     114 </span><span class="lineCov">          1 :         nStatus = msSLDApplySLD(map, pszSLDbuf, iLayer, pszStyleLayerName, ppszLayerNames);</span>
<span class="lineNum">     115 </span>            :     }
<span class="lineNum">     116 </span><span class="lineCov">          1 :     map-&gt;sldurl = NULL;</span>
<span class="lineNum">     117 </span>            :   }
<span class="lineNum">     118 </span>            : 
<span class="lineNum">     119 </span><span class="lineCov">          1 :   msFree(pszSLDbuf);</span>
<span class="lineNum">     120 </span>            : 
<span class="lineNum">     121 </span><span class="lineCov">          1 :   return nStatus;</span>
<span class="lineNum">     122 </span>            : 
<span class="lineNum">     123 </span>            : #else
<span class="lineNum">     124 </span>            :   msSetError(MS_MISCERR, &quot;WMS/WFS client support is not enabled .&quot;, &quot;msSLDApplySLDURL()&quot;);
<span class="lineNum">     125 </span>            :   return(MS_FAILURE);
<span class="lineNum">     126 </span>            : #endif
<span class="lineNum">     127 </span>            : }
<span class="lineNum">     128 </span>            : 
<span class="lineNum">     129 </span>            : /* -------------------------------------------------------------------- */
<span class="lineNum">     130 </span>            : /*      If the same layer is given more that once, we need to           */
<a name="131"><span class="lineNum">     131 </span>            : /*      duplicate it.                                                   */</a>
<span class="lineNum">     132 </span>            : /* -------------------------------------------------------------------- */
<span class="lineNum">     133 </span><span class="lineCov">          1 : static void msSLDApplySLD_DuplicateLayers(mapObj *map, int nSLDLayers, layerObj *pasSLDLayers)</span>
<span class="lineNum">     134 </span>            : {
<span class="lineNum">     135 </span>            :     int m;
<span class="lineNum">     136 </span><span class="lineCov">          1 :     for (m=0; m&lt;nSLDLayers; m++) {</span>
<span class="lineNum">     137 </span>            :       int l;
<span class="lineNum">     138 </span><span class="lineCov">          1 :       int nIndex = msGetLayerIndex(map, pasSLDLayers[m].name);</span>
<span class="lineNum">     139 </span><span class="lineCov">          1 :       if(pasSLDLayers[m].name == NULL) continue;</span>
<span class="lineNum">     140 </span><span class="lineCov">          1 :       if( nIndex &lt; 0 ) continue;</span>
<span class="lineNum">     141 </span><span class="lineCov">          1 :       for (l=m+1; l&lt;nSLDLayers; l++) {</span>
<span class="lineNum">     142 </span><span class="lineCov">          1 :         if(pasSLDLayers[l].name == NULL)</span>
<span class="lineNum">     143 </span><span class="lineNoCov">          0 :           continue;</span>
<span class="lineNum">     144 </span><span class="lineCov">          1 :         if (strcasecmp(pasSLDLayers[m].name, pasSLDLayers[l].name)== 0) {</span>
<span class="lineNum">     145 </span><span class="lineCov">          1 :           layerObj* psTmpLayer = (layerObj *) malloc(sizeof(layerObj));</span>
<span class="lineNum">     146 </span>            :           char tmpId[128];
<span class="lineNum">     147 </span>            : 
<span class="lineNum">     148 </span><span class="lineCov">          1 :           initLayer(psTmpLayer, map);</span>
<span class="lineNum">     149 </span><span class="lineCov">          1 :           msCopyLayer(psTmpLayer, GET_LAYER(map,nIndex));</span>
<span class="lineNum">     150 </span>            :           /* open the source layer */
<span class="lineNum">     151 </span><span class="lineCov">          1 :           if ( !psTmpLayer-&gt;vtable)</span>
<span class="lineNum">     152 </span><span class="lineCov">          1 :             msInitializeVirtualTable(psTmpLayer);</span>
<span class="lineNum">     153 </span>            : 
<span class="lineNum">     154 </span>            :           /*make the name unique*/
<span class="lineNum">     155 </span><span class="lineCov">          1 :           snprintf(tmpId, sizeof(tmpId), &quot;%lx_%x_%d&quot;,(long)time(NULL),(int)getpid(),</span>
<span class="lineNum">     156 </span>            :                    map-&gt;numlayers);
<span class="lineNum">     157 </span><span class="lineCov">          1 :           if (psTmpLayer-&gt;name)</span>
<span class="lineNum">     158 </span><span class="lineCov">          1 :             msFree(psTmpLayer-&gt;name);</span>
<span class="lineNum">     159 </span><span class="lineCov">          1 :           psTmpLayer-&gt;name = msStrdup(tmpId);</span>
<span class="lineNum">     160 </span><span class="lineCov">          1 :           msFree(pasSLDLayers[l].name);</span>
<span class="lineNum">     161 </span><span class="lineCov">          1 :           pasSLDLayers[l].name = msStrdup(tmpId);</span>
<span class="lineNum">     162 </span><span class="lineCov">          1 :           msInsertLayer(map, psTmpLayer, -1);</span>
<span class="lineNum">     163 </span><span class="lineCov">          1 :           MS_REFCNT_DECR(psTmpLayer);</span>
<span class="lineNum">     164 </span>            :         }
<span class="lineNum">     165 </span>            :       }
<span class="lineNum">     166 </span>            :     }
<span class="lineNum">     167 </span><span class="lineCov">          1 : }</span>
<span class="lineNum">     168 </span>            : 
<span class="lineNum">     169 </span>            : /************************************************************************/
<span class="lineNum">     170 </span>            : /*                              msSLDApplySLD                           */
<span class="lineNum">     171 </span>            : /*                                                                      */
<span class="lineNum">     172 </span>            : /*      Parses the SLD into array of layers. Go through the map and     */
<span class="lineNum">     173 </span>            : /*      compare the SLD layers and the map layers using the name. If    */
<span class="lineNum">     174 </span>            : /*      they have the same name, copy the classes associated with       */
<a name="175"><span class="lineNum">     175 </span>            : /*      the SLD layers onto the map layers.                             */</a>
<span class="lineNum">     176 </span>            : /************************************************************************/
<span class="lineNum">     177 </span><span class="lineCov">          1 : int msSLDApplySLD(mapObj *map, const char *psSLDXML, int iLayer, const char *pszStyleLayerName, char **ppszLayerNames)</span>
<span class="lineNum">     178 </span>            : {
<span class="lineNum">     179 </span>            : #if defined(USE_WMS_SVR) || defined (USE_WFS_SVR) || defined (USE_WCS_SVR) || defined(USE_SOS_SVR)
<span class="lineNum">     180 </span><span class="lineCov">          1 :   int nSLDLayers = 0;</span>
<span class="lineNum">     181 </span>            :   layerObj *pasSLDLayers = NULL;
<span class="lineNum">     182 </span>            :   int nStatus = MS_SUCCESS;
<span class="lineNum">     183 </span>            :   /*const char *pszSLDNotSupported = NULL;*/
<span class="lineNum">     184 </span>            : 
<span class="lineNum">     185 </span><span class="lineCov">          1 :   pasSLDLayers = msSLDParseSLD(map, psSLDXML, &amp;nSLDLayers);</span>
<span class="lineNum">     186 </span><span class="lineCov">          1 :   if( pasSLDLayers == NULL ) {</span>
<span class="lineNum">     187 </span><span class="lineCov">          1 :     errorObj* psError = msGetErrorObj();</span>
<span class="lineNum">     188 </span><span class="lineCov">          1 :     if( psError &amp;&amp; psError-&gt;code != MS_NOERR )</span>
<span class="lineNum">     189 </span>            :       return MS_FAILURE;
<span class="lineNum">     190 </span>            :   }
<span class="lineNum">     191 </span>            : 
<span class="lineNum">     192 </span><span class="lineCov">          1 :   if (pasSLDLayers &amp;&amp; nSLDLayers&gt;0) {</span>
<span class="lineNum">     193 </span>            :     int i;
<span class="lineNum">     194 </span>            : 
<span class="lineNum">     195 </span><span class="lineCov">          1 :     msSLDApplySLD_DuplicateLayers(map, nSLDLayers, pasSLDLayers);</span>
<span class="lineNum">     196 </span>            : 
<span class="lineNum">     197 </span><span class="lineCov">          1 :     for (i=0; i&lt;map-&gt;numlayers; i++) {</span>
<span class="lineNum">     198 </span>            :       layerObj *lp = NULL;
<span class="lineNum">     199 </span>            :       const char *pszWMSLayerName = NULL;
<span class="lineNum">     200 </span>            :       int j;
<span class="lineNum">     201 </span>            :       int bUseSpecificLayer = 0;
<span class="lineNum">     202 </span>            : 
<span class="lineNum">     203 </span><span class="lineCov">          1 :       if (iLayer &gt;=0 &amp;&amp; iLayer&lt; map-&gt;numlayers) {</span>
<span class="lineNum">     204 </span>            :         i = iLayer;
<span class="lineNum">     205 </span>            :         bUseSpecificLayer = 1;
<span class="lineNum">     206 </span>            :       }
<span class="lineNum">     207 </span>            : 
<span class="lineNum">     208 </span><span class="lineCov">          1 :       lp = GET_LAYER(map, i);</span>
<span class="lineNum">     209 </span>            : 
<span class="lineNum">     210 </span>            :       /* compare layer name to wms_name as well */
<span class="lineNum">     211 </span><span class="lineCov">          1 :       pszWMSLayerName = msOWSLookupMetadata(&amp;(lp-&gt;metadata), &quot;MO&quot;, &quot;name&quot;);</span>
<span class="lineNum">     212 </span>            : 
<span class="lineNum">     213 </span><span class="lineCov">          1 :       for (j=0; j&lt;nSLDLayers; j++) {</span>
<span class="lineNum">     214 </span><span class="lineCov">          1 :         layerObj* sldLayer = &amp;pasSLDLayers[j];</span>
<span class="lineNum">     215 </span>            : 
<span class="lineNum">     216 </span>            :         /* -------------------------------------------------------------------- */
<span class="lineNum">     217 </span>            :         /*      copy :  - class                                                 */
<span class="lineNum">     218 </span>            :         /*              - layer's labelitem                                     */
<span class="lineNum">     219 </span>            :         /* -------------------------------------------------------------------- */
<span class="lineNum">     220 </span><span class="lineCov">          1 :         if ((sldLayer-&gt;name &amp;&amp; pszStyleLayerName == NULL &amp;&amp;</span>
<span class="lineNum">     221 </span><span class="lineCov">          1 :              ((strcasecmp(lp-&gt;name, sldLayer-&gt;name) == 0 ||</span>
<span class="lineNum">     222 </span><span class="lineCov">          1 :                (pszWMSLayerName &amp;&amp; strcasecmp(pszWMSLayerName, sldLayer-&gt;name) == 0))||</span>
<span class="lineNum">     223 </span><span class="lineCov">          1 :               (lp-&gt;group &amp;&amp;</span>
<span class="lineNum">     224 </span><span class="lineCov">          1 :                strcasecmp(lp-&gt;group, sldLayer-&gt;name) == 0))) ||</span>
<span class="lineNum">     225 </span><span class="lineCov">          1 :             (bUseSpecificLayer &amp;&amp; pszStyleLayerName &amp;&amp; sldLayer-&gt;name &amp;&amp;</span>
<span class="lineNum">     226 </span><span class="lineNoCov">          0 :              strcasecmp(sldLayer-&gt;name, pszStyleLayerName) == 0)) {</span>
<span class="lineNum">     227 </span>            : #ifdef notdef
<span class="lineNum">     228 </span>            :           /*this is a test code if we decide to flag some layers as not supporting SLD*/
<span class="lineNum">     229 </span>            :           pszSLDNotSupported = msOWSLookupMetadata(&amp;(lp-&gt;metadata), &quot;M&quot;, &quot;SLD_NOT_SUPPORTED&quot;);
<span class="lineNum">     230 </span>            :           if (pszSLDNotSupported) {
<span class="lineNum">     231 </span>            :             msSetError(MS_WMSERR, &quot;Layer %s does not support SLD&quot;, &quot;msSLDApplySLD&quot;, sldLayer-&gt;name);
<span class="lineNum">     232 </span>            :             nsStatus = MS_FAILURE;
<span class="lineNum">     233 </span>            :             goto sld_cleanup;
<span class="lineNum">     234 </span>            :           }
<span class="lineNum">     235 </span>            : #endif
<span class="lineNum">     236 </span>            : 
<span class="lineNum">     237 </span><span class="lineCov">          1 :           if ( sldLayer-&gt;numclasses &gt; 0) {</span>
<span class="lineNum">     238 </span>            :             int iClass = 0;
<span class="lineNum">     239 </span>            :             int k;
<span class="lineNum">     240 </span>            :             int bSLDHasNamedClass = MS_FALSE;
<span class="lineNum">     241 </span>            : 
<span class="lineNum">     242 </span><span class="lineCov">          1 :             lp-&gt;type = sldLayer-&gt;type;</span>
<span class="lineNum">     243 </span><span class="lineCov">          1 :             lp-&gt;rendermode = MS_ALL_MATCHING_CLASSES;</span>
<span class="lineNum">     244 </span>            : 
<span class="lineNum">     245 </span><span class="lineCov">          1 :             for (k=0; k &lt; sldLayer-&gt;numclasses; k++) {</span>
<span class="lineNum">     246 </span><span class="lineCov">          1 :                 if( sldLayer-&gt;class[k]-&gt;group ) {</span>
<span class="lineNum">     247 </span>            :                     bSLDHasNamedClass = MS_TRUE;
<span class="lineNum">     248 </span>            :                     break;
<span class="lineNum">     249 </span>            :                 }
<span class="lineNum">     250 </span>            :             }
<span class="lineNum">     251 </span>            : 
<span class="lineNum">     252 </span><span class="lineCov">          1 :             for(k=0; k&lt;lp-&gt;numclasses; k++) {</span>
<span class="lineNum">     253 </span><span class="lineCov">          1 :               if (lp-&gt;class[k] != NULL) {</span>
<span class="lineNum">     254 </span><span class="lineCov">          1 :                 lp-&gt;class[k]-&gt;layer=NULL;</span>
<span class="lineNum">     255 </span><span class="lineCov">          1 :                 if (freeClass(lp-&gt;class[k]) == MS_SUCCESS ) {</span>
<span class="lineNum">     256 </span><span class="lineCov">          1 :                   msFree(lp-&gt;class[k]);</span>
<span class="lineNum">     257 </span><span class="lineCov">          1 :                   lp-&gt;class[k] = NULL;</span>
<span class="lineNum">     258 </span>            :                 }
<span class="lineNum">     259 </span>            :               }
<span class="lineNum">     260 </span>            :             }
<span class="lineNum">     261 </span><span class="lineCov">          1 :             lp-&gt;numclasses = 0;</span>
<span class="lineNum">     262 </span>            : 
<span class="lineNum">     263 </span><span class="lineCov">          1 :             if( bSLDHasNamedClass ) {</span>
<span class="lineNum">     264 </span><span class="lineCov">          1 :                 if( sldLayer-&gt;classgroup ) {</span>
<span class="lineNum">     265 </span>            :                     /* Set the class group to the class that has UserStyle.IsDefault */
<span class="lineNum">     266 </span><span class="lineCov">          1 :                     msFree( lp-&gt;classgroup);</span>
<span class="lineNum">     267 </span><span class="lineCov">          1 :                     lp-&gt;classgroup = msStrdup(sldLayer-&gt;classgroup);</span>
<span class="lineNum">     268 </span>            :                 }
<span class="lineNum">     269 </span>            :             }
<span class="lineNum">     270 </span>            :             else {
<span class="lineNum">     271 </span>            :                 /*unset the classgroup on the layer if it was set. This allows the layer to render
<span class="lineNum">     272 </span>            :                 with all the classes defined in the SLD*/
<span class="lineNum">     273 </span><span class="lineCov">          1 :                 msFree(lp-&gt;classgroup);</span>
<span class="lineNum">     274 </span><span class="lineCov">          1 :                 lp-&gt;classgroup = NULL;</span>
<span class="lineNum">     275 </span>            :             }
<span class="lineNum">     276 </span>            : 
<span class="lineNum">     277 </span><span class="lineCov">          1 :             for (k=0; k &lt; sldLayer-&gt;numclasses; k++) {</span>
<span class="lineNum">     278 </span><span class="lineCov">          1 :               if (msGrowLayerClasses(lp) == NULL)</span>
<span class="lineNum">     279 </span>            :                 return MS_FAILURE;
<span class="lineNum">     280 </span>            : 
<span class="lineNum">     281 </span><span class="lineCov">          1 :               initClass(lp-&gt;class[iClass]);</span>
<span class="lineNum">     282 </span><span class="lineCov">          1 :               msCopyClass(lp-&gt;class[iClass],</span>
<span class="lineNum">     283 </span><span class="lineCov">          1 :                           sldLayer-&gt;class[k], NULL);</span>
<span class="lineNum">     284 </span><span class="lineCov">          1 :               lp-&gt;class[iClass]-&gt;layer = lp;</span>
<span class="lineNum">     285 </span><span class="lineCov">          1 :               lp-&gt;numclasses++;</span>
<span class="lineNum">     286 </span>            : 
<span class="lineNum">     287 </span>            :               /*aliases may have been used as part of the sld text symbolizer for
<span class="lineNum">     288 </span>            :                 label element. Try to process it if that is the case #3114*/
<span class="lineNum">     289 </span><span class="lineCov">          1 :               if (msLayerOpen(lp) == MS_SUCCESS &amp;&amp;</span>
<span class="lineNum">     290 </span><span class="lineCov">          1 :                   msLayerGetItems(lp) == MS_SUCCESS) {</span>
<span class="lineNum">     291 </span><span class="lineCov">          1 :                 if (lp-&gt;class[iClass]-&gt;text.string) {</span>
<span class="lineNum">     292 </span>            :                   int z;
<span class="lineNum">     293 </span><span class="lineCov">          1 :                   for(z=0; z&lt;lp-&gt;numitems; z++) {</span>
<span class="lineNum">     294 </span>            :                     const char* pszFullName;
<span class="lineNum">     295 </span>            :                     char szTmp[512];
<span class="lineNum">     296 </span>            :                     char* pszTmp1;
<span class="lineNum">     297 </span><span class="lineCov">          1 :                     if (!lp-&gt;items[z] || strlen(lp-&gt;items[z]) &lt;= 0)</span>
<span class="lineNum">     298 </span><span class="lineNoCov">          0 :                       continue;</span>
<span class="lineNum">     299 </span>            :                     snprintf(szTmp, sizeof(szTmp), &quot;%s_alias&quot;, lp-&gt;items[z]);
<span class="lineNum">     300 </span><span class="lineCov">          1 :                     pszFullName = msOWSLookupMetadata(&amp;(lp-&gt;metadata), &quot;G&quot;, szTmp);</span>
<span class="lineNum">     301 </span><span class="lineCov">          1 :                     pszTmp1 = msStrdup( lp-&gt;class[iClass]-&gt;text.string);</span>
<span class="lineNum">     302 </span><span class="lineCov">          1 :                     if (pszFullName != NULL &amp;&amp; (strstr(pszTmp1, pszFullName) != NULL)) {</span>
<span class="lineNum">     303 </span><span class="lineCov">          1 :                       char *tmpstr1= msReplaceSubstring(pszTmp1, pszFullName, lp-&gt;items[z]);</span>
<span class="lineNum">     304 </span><span class="lineCov">          1 :                       char* pszTmp2 = (char *)malloc(sizeof(char)*(strlen(tmpstr1)+3));</span>
<span class="lineNum">     305 </span>            :                       sprintf(pszTmp2,&quot;(%s)&quot;,tmpstr1);
<span class="lineNum">     306 </span><span class="lineCov">          1 :                       msLoadExpressionString(&amp;(lp-&gt;class[iClass]-&gt;text), pszTmp2);</span>
<span class="lineNum">     307 </span><span class="lineCov">          1 :                       msFree(pszTmp2);</span>
<span class="lineNum">     308 </span>            :                     }
<span class="lineNum">     309 </span><span class="lineCov">          1 :                     msFree(pszTmp1);</span>
<span class="lineNum">     310 </span>            :                   }
<span class="lineNum">     311 </span>            :                 }
<span class="lineNum">     312 </span>            :               }
<span class="lineNum">     313 </span>            : 
<span class="lineNum">     314 </span><span class="lineCov">          1 :               iClass++;</span>
<span class="lineNum">     315 </span>            :             }
<span class="lineNum">     316 </span>            :           } else {
<span class="lineNum">     317 </span>            :             /*this is probably an SLD that uses Named styles*/
<span class="lineNum">     318 </span><span class="lineCov">          1 :             if (sldLayer-&gt;classgroup) {</span>
<span class="lineNum">     319 </span>            :               int k;
<span class="lineNum">     320 </span><span class="lineCov">          1 :               for (k=0; k&lt;lp-&gt;numclasses; k++) {</span>
<span class="lineNum">     321 </span><span class="lineCov">          1 :                 if (lp-&gt;class[k]-&gt;group &amp;&amp;</span>
<span class="lineNum">     322 </span><span class="lineCov">          1 :                     strcasecmp(lp-&gt;class[k]-&gt;group,</span>
<span class="lineNum">     323 </span>            :                                sldLayer-&gt;classgroup) == 0)
<span class="lineNum">     324 </span>            :                   break;
<span class="lineNum">     325 </span>            :               }
<span class="lineNum">     326 </span><span class="lineCov">          1 :               if (k &lt; lp-&gt;numclasses) {</span>
<span class="lineNum">     327 </span><span class="lineCov">          1 :                 msFree( lp-&gt;classgroup);</span>
<span class="lineNum">     328 </span><span class="lineCov">          1 :                 lp-&gt;classgroup = msStrdup(sldLayer-&gt;classgroup);</span>
<span class="lineNum">     329 </span>            :               } else {
<span class="lineNum">     330 </span>            :                 /* TODO  we throw an exception ?*/
<span class="lineNum">     331 </span>            :               }
<span class="lineNum">     332 </span>            :             }
<span class="lineNum">     333 </span>            :           }
<span class="lineNum">     334 </span><span class="lineCov">          1 :           if (sldLayer-&gt;labelitem) {</span>
<span class="lineNum">     335 </span><span class="lineNoCov">          0 :             if (lp-&gt;labelitem)</span>
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :               free(lp-&gt;labelitem);</span>
<span class="lineNum">     337 </span>            : 
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :             lp-&gt;labelitem = msStrdup(sldLayer-&gt;labelitem);</span>
<span class="lineNum">     339 </span>            :           }
<span class="lineNum">     340 </span>            : 
<span class="lineNum">     341 </span><span class="lineCov">          1 :           if (sldLayer-&gt;classitem) {</span>
<span class="lineNum">     342 </span><span class="lineNoCov">          0 :             if (lp-&gt;classitem)</span>
<span class="lineNum">     343 </span><span class="lineNoCov">          0 :               free(lp-&gt;classitem);</span>
<span class="lineNum">     344 </span>            : 
<span class="lineNum">     345 </span><span class="lineNoCov">          0 :             lp-&gt;classitem = msStrdup(sldLayer-&gt;classitem);</span>
<span class="lineNum">     346 </span>            :           }
<span class="lineNum">     347 </span>            : 
<span class="lineNum">     348 </span>            :           /* opacity for sld raster */
<span class="lineNum">     349 </span><span class="lineCov">          1 :           if (lp-&gt;type == MS_LAYER_RASTER &amp;&amp;</span>
<span class="lineNum">     350 </span><span class="lineNoCov">          0 :               sldLayer-&gt;compositer &amp;&amp; sldLayer-&gt;compositer-&gt;opacity != 100)</span>
<span class="lineNum">     351 </span><span class="lineNoCov">          0 :             msSetLayerOpacity(lp, sldLayer-&gt;compositer-&gt;opacity);</span>
<span class="lineNum">     352 </span>            : 
<span class="lineNum">     353 </span>            :           /* mark as auto-generate SLD */
<span class="lineNum">     354 </span><span class="lineCov">          1 :           if (lp-&gt;connectiontype == MS_WMS)</span>
<span class="lineNum">     355 </span><span class="lineNoCov">          0 :             msInsertHashTable(&amp;(lp-&gt;metadata),</span>
<span class="lineNum">     356 </span>            :                               &quot;wms_sld_body&quot;, &quot;auto&quot; );
<span class="lineNum">     357 </span>            : 
<span class="lineNum">     358 </span>            :           /* The SLD might have a FeatureTypeConstraint */
<span class="lineNum">     359 </span><span class="lineCov">          1 :           if( sldLayer-&gt;filter.type == MS_EXPRESSION )</span>
<span class="lineNum">     360 </span>            :           {
<span class="lineNum">     361 </span><span class="lineCov">          1 :                 if( lp-&gt;filter.string &amp;&amp; lp-&gt;filter.type == MS_EXPRESSION )</span>
<span class="lineNum">     362 </span><span class="lineCov">          1 :                 {</span>
<span class="lineNum">     363 </span><span class="lineCov">          1 :                     char* pszBuffer = msStringConcatenate(NULL, &quot;((&quot;);</span>
<span class="lineNum">     364 </span><span class="lineCov">          1 :                     pszBuffer = msStringConcatenate(pszBuffer, lp-&gt;filter.string);</span>
<span class="lineNum">     365 </span><span class="lineCov">          1 :                     pszBuffer = msStringConcatenate(pszBuffer, &quot;) AND (&quot;);</span>
<span class="lineNum">     366 </span><span class="lineCov">          1 :                     pszBuffer = msStringConcatenate(pszBuffer, sldLayer-&gt;filter.string);</span>
<span class="lineNum">     367 </span><span class="lineCov">          1 :                     pszBuffer = msStringConcatenate(pszBuffer, &quot;))&quot;);</span>
<span class="lineNum">     368 </span><span class="lineCov">          1 :                     msFreeExpression(&amp;lp-&gt;filter);</span>
<span class="lineNum">     369 </span><span class="lineCov">          1 :                     msInitExpression(&amp;lp-&gt;filter);</span>
<span class="lineNum">     370 </span><span class="lineCov">          1 :                     lp-&gt;filter.string = pszBuffer;</span>
<span class="lineNum">     371 </span><span class="lineCov">          1 :                     lp-&gt;filter.type = MS_EXPRESSION;</span>
<span class="lineNum">     372 </span>            :                 }
<span class="lineNum">     373 </span>            :                 else
<span class="lineNum">     374 </span>            :                 {
<span class="lineNum">     375 </span><span class="lineCov">          1 :                     msFreeExpression(&amp;lp-&gt;filter);</span>
<span class="lineNum">     376 </span><span class="lineCov">          1 :                     msInitExpression(&amp;lp-&gt;filter);</span>
<span class="lineNum">     377 </span><span class="lineCov">          1 :                     lp-&gt;filter.string = msStrdup(sldLayer-&gt;filter.string);</span>
<span class="lineNum">     378 </span><span class="lineCov">          1 :                     lp-&gt;filter.type = MS_EXPRESSION;</span>
<span class="lineNum">     379 </span>            :                 }
<span class="lineNum">     380 </span>            :           }
<span class="lineNum">     381 </span>            : 
<span class="lineNum">     382 </span>            : 
<span class="lineNum">     383 </span>            :           /*in some cases it would make sense to concatenate all the class
<span class="lineNum">     384 </span>            :             expressions and use it to set the filter on the layer. This
<span class="lineNum">     385 </span>            :             could increase performance. Will do it for db types layers #2840*/
<span class="lineNum">     386 </span><span class="lineCov">          1 :           if (lp-&gt;filter.string == NULL || (lp-&gt;filter.string &amp;&amp; lp-&gt;filter.type == MS_STRING &amp;&amp; !lp-&gt;filteritem)) {</span>
<span class="lineNum">     387 </span><span class="lineCov">          1 :               if (lp-&gt;connectiontype == MS_POSTGIS || lp-&gt;connectiontype ==  MS_ORACLESPATIAL || lp-&gt;connectiontype == MS_PLUGIN) {</span>
<span class="lineNum">     388 </span><span class="lineCov">          1 :                 if (lp-&gt;numclasses &gt; 0) {</span>
<span class="lineNum">     389 </span>            :                   /* check first that all classes have an expression type. That is
<span class="lineNum">     390 </span>            :                     the only way we can concatenate them and set the filter
<span class="lineNum">     391 </span>            :                     expression */
<span class="lineNum">     392 </span>            :                   int k;
<span class="lineNum">     393 </span><span class="lineCov">          1 :                   for (k=0; k&lt;lp-&gt;numclasses; k++) {</span>
<span class="lineNum">     394 </span><span class="lineCov">          1 :                     if (lp-&gt;class[k]-&gt;expression.type != MS_EXPRESSION)</span>
<span class="lineNum">     395 </span>            :                       break;
<span class="lineNum">     396 </span>            :                   }
<span class="lineNum">     397 </span><span class="lineCov">          1 :                   if (k == lp-&gt;numclasses) {</span>
<span class="lineNum">     398 </span>            :                     char szTmp[512];
<span class="lineNum">     399 </span>            :                     char* pszBuffer = NULL;
<span class="lineNum">     400 </span><span class="lineCov">          1 :                     for (k=0; k&lt;lp-&gt;numclasses; k++) {</span>
<span class="lineNum">     401 </span><span class="lineCov">          1 :                       if (pszBuffer == NULL)</span>
<span class="lineNum">     402 </span>            :                         snprintf(szTmp, sizeof(szTmp), &quot;%s&quot;, &quot;((&quot;); /* we a building a string expression, explicitly set type below */
<span class="lineNum">     403 </span>            :                       else
<span class="lineNum">     404 </span>            :                         snprintf(szTmp, sizeof(szTmp), &quot;%s&quot;, &quot; OR &quot;);
<span class="lineNum">     405 </span>            : 
<span class="lineNum">     406 </span><span class="lineCov">          1 :                       pszBuffer = msStringConcatenate(pszBuffer, szTmp);</span>
<span class="lineNum">     407 </span><span class="lineCov">          1 :                       pszBuffer = msStringConcatenate(pszBuffer, lp-&gt;class[k]-&gt;expression.string);</span>
<span class="lineNum">     408 </span>            :                     }
<span class="lineNum">     409 </span>            : 
<span class="lineNum">     410 </span>            :                     snprintf(szTmp, sizeof(szTmp), &quot;%s&quot;, &quot;))&quot;);
<span class="lineNum">     411 </span><span class="lineCov">          1 :                     pszBuffer =msStringConcatenate(pszBuffer, szTmp);</span>
<span class="lineNum">     412 </span>            : 
<span class="lineNum">     413 </span><span class="lineCov">          1 :                     msFreeExpression(&amp;lp-&gt;filter);</span>
<span class="lineNum">     414 </span><span class="lineCov">          1 :                     msInitExpression(&amp;lp-&gt;filter);</span>
<span class="lineNum">     415 </span><span class="lineCov">          1 :                     lp-&gt;filter.string = msStrdup(pszBuffer);</span>
<span class="lineNum">     416 </span><span class="lineCov">          1 :                     lp-&gt;filter.type = MS_EXPRESSION;</span>
<span class="lineNum">     417 </span>            : 
<span class="lineNum">     418 </span><span class="lineCov">          1 :                     msFree(pszBuffer);</span>
<span class="lineNum">     419 </span>            :                   }
<span class="lineNum">     420 </span>            :                 }
<span class="lineNum">     421 </span>            :               }
<span class="lineNum">     422 </span>            :           }
<span class="lineNum">     423 </span>            :           break;
<span class="lineNum">     424 </span>            :         }
<span class="lineNum">     425 </span>            :       }
<span class="lineNum">     426 </span><span class="lineCov">          1 :       if (bUseSpecificLayer)</span>
<span class="lineNum">     427 </span>            :         break;
<span class="lineNum">     428 </span>            :     }
<span class="lineNum">     429 </span>            : 
<span class="lineNum">     430 </span>            :     /* -------------------------------------------------------------------- */
<span class="lineNum">     431 </span>            :     /*      if needed return a comma separated list of the layers found     */
<span class="lineNum">     432 </span>            :     /*      in the sld.                                                     */
<span class="lineNum">     433 </span>            :     /* -------------------------------------------------------------------- */
<span class="lineNum">     434 </span><span class="lineCov">          1 :     if (ppszLayerNames) {</span>
<span class="lineNum">     435 </span>            :       char *pszTmp = NULL;
<span class="lineNum">     436 </span><span class="lineCov">          1 :       for (i=0; i&lt;nSLDLayers; i++) {</span>
<span class="lineNum">     437 </span><span class="lineCov">          1 :         if (pasSLDLayers[i].name) {</span>
<span class="lineNum">     438 </span><span class="lineCov">          1 :           if (pszTmp !=NULL)</span>
<span class="lineNum">     439 </span><span class="lineCov">          1 :             pszTmp = msStringConcatenate(pszTmp, &quot;,&quot;);</span>
<span class="lineNum">     440 </span><span class="lineCov">          1 :           pszTmp = msStringConcatenate(pszTmp, pasSLDLayers[i].name);</span>
<span class="lineNum">     441 </span>            : 
<span class="lineNum">     442 </span>            :         }
<span class="lineNum">     443 </span>            :       }
<span class="lineNum">     444 </span><span class="lineCov">          1 :       *ppszLayerNames = pszTmp;</span>
<span class="lineNum">     445 </span>            : 
<span class="lineNum">     446 </span>            :     }
<span class="lineNum">     447 </span>            :   }
<span class="lineNum">     448 </span>            : 
<span class="lineNum">     449 </span>            :   nStatus = MS_SUCCESS;
<span class="lineNum">     450 </span>            : 
<span class="lineNum">     451 </span>            : #ifdef notdef
<span class="lineNum">     452 </span>            : sld_cleanup:
<span class="lineNum">     453 </span>            : #endif
<span class="lineNum">     454 </span>            :   {
<span class="lineNum">     455 </span>            :     int i;
<span class="lineNum">     456 </span><span class="lineCov">          1 :     for (i=0; i&lt;nSLDLayers; i++)</span>
<span class="lineNum">     457 </span><span class="lineCov">          1 :         freeLayer(&amp;pasSLDLayers[i]);</span>
<span class="lineNum">     458 </span><span class="lineCov">          1 :     msFree(pasSLDLayers);</span>
<span class="lineNum">     459 </span>            :   }
<span class="lineNum">     460 </span>            : 
<span class="lineNum">     461 </span><span class="lineCov">          1 :   if(map-&gt;debug == MS_DEBUGLEVEL_VVV) {</span>
<span class="lineNum">     462 </span><span class="lineNoCov">          0 :     char* tmpfilename = msTmpFile(map, map-&gt;mappath, NULL, &quot;_sld.map&quot;);</span>
<span class="lineNum">     463 </span><span class="lineNoCov">          0 :     if (tmpfilename == NULL) {</span>
<span class="lineNum">     464 </span><span class="lineNoCov">          0 :       tmpfilename = msTmpFile(map, NULL, NULL, &quot;_sld.map&quot; );</span>
<span class="lineNum">     465 </span>            :     }
<span class="lineNum">     466 </span><span class="lineNoCov">          0 :     if (tmpfilename) {</span>
<span class="lineNum">     467 </span><span class="lineNoCov">          0 :       msSaveMap(map,tmpfilename);</span>
<span class="lineNum">     468 </span><span class="lineNoCov">          0 :       msDebug(&quot;msApplySLD(): Map file after SLD was applied %s&quot;, tmpfilename);</span>
<span class="lineNum">     469 </span><span class="lineNoCov">          0 :       msFree(tmpfilename);</span>
<span class="lineNum">     470 </span>            :     }
<span class="lineNum">     471 </span>            :   }
<span class="lineNum">     472 </span>            :   return nStatus;
<span class="lineNum">     473 </span>            : 
<span class="lineNum">     474 </span>            : #else
<span class="lineNum">     475 </span>            :   msSetError(MS_MISCERR, &quot;OWS support is not available.&quot;,
<span class="lineNum">     476 </span>            :              &quot;msSLDApplySLD()&quot;);
<span class="lineNum">     477 </span>            :   return(MS_FAILURE);
<span class="lineNum">     478 </span>            : #endif
<span class="lineNum">     479 </span>            : }
<span class="lineNum">     480 </span>            : 
<a name="481"><span class="lineNum">     481 </span>            : </a>
<span class="lineNum">     482 </span>            : 
<span class="lineNum">     483 </span><span class="lineCov">          1 : static CPLXMLNode* FindNextChild(CPLXMLNode* psNode, const char* pszChildName)</span>
<span class="lineNum">     484 </span>            : {
<span class="lineNum">     485 </span><span class="lineCov">          1 :     while( psNode )</span>
<span class="lineNum">     486 </span>            :     {
<span class="lineNum">     487 </span><span class="lineCov">          1 :         if( psNode-&gt;eType == CXT_Element &amp;&amp;</span>
<span class="lineNum">     488 </span><span class="lineCov">          1 :             strcasecmp(psNode-&gt;pszValue, pszChildName) == 0 )</span>
<span class="lineNum">     489 </span>            :         {
<span class="lineNum">     490 </span>            :             return psNode;
<span class="lineNum">     491 </span>            :         }
<span class="lineNum">     492 </span><span class="lineCov">          1 :         psNode = psNode-&gt;psNext;</span>
<span class="lineNum">     493 </span>            :     }
<span class="lineNum">     494 </span>            :     return NULL;
<span class="lineNum">     495 </span>            : }
<span class="lineNum">     496 </span>            : 
<span class="lineNum">     497 </span>            : #define LOOP_ON_CHILD_ELEMENT(psParent_, psChild_, pszChildName_) \
<span class="lineNum">     498 </span>            :     for( psChild_ = FindNextChild(psParent_-&gt;psChild, pszChildName_); \
<span class="lineNum">     499 </span>            :          psChild_ != NULL; \
<span class="lineNum">     500 </span>            :          psChild_ = FindNextChild(psChild_-&gt;psNext, pszChildName_) )
<span class="lineNum">     501 </span>            : 
<span class="lineNum">     502 </span>            : /************************************************************************/
<span class="lineNum">     503 </span>            : /*                              msSLDParseSLD                           */
<span class="lineNum">     504 </span>            : /*                                                                      */
<span class="lineNum">     505 </span>            : /*      Parse the sld document into layers : for each named layer       */
<span class="lineNum">     506 </span>            : /*      there is one mapserver layer created with appropriate           */
<span class="lineNum">     507 </span>            : /*      classes and styles.                                             */
<span class="lineNum">     508 </span>            : /*      Returns an array of mapserver layers. The pnLayres if           */
<a name="509"><span class="lineNum">     509 </span>            : /*      provided will indicate the size of the returned array.          */</a>
<span class="lineNum">     510 </span>            : /************************************************************************/
<span class="lineNum">     511 </span><span class="lineCov">          1 : layerObj  *msSLDParseSLD(mapObj *map, const char *psSLDXML, int *pnLayers)</span>
<span class="lineNum">     512 </span>            : {
<span class="lineNum">     513 </span>            :   CPLXMLNode *psRoot = NULL;
<span class="lineNum">     514 </span>            :   CPLXMLNode *psSLD, *psNamedLayer;
<span class="lineNum">     515 </span>            :   layerObj *pasLayers = NULL;
<span class="lineNum">     516 </span>            :   int iLayer = 0;
<span class="lineNum">     517 </span>            :   int nLayers = 0;
<span class="lineNum">     518 </span>            : 
<span class="lineNum">     519 </span>            : 
<span class="lineNum">     520 </span><span class="lineCov">          1 :   if (map == NULL || psSLDXML == NULL || strlen(psSLDXML) &lt;= 0 ||</span>
<span class="lineNum">     521 </span><span class="lineCov">          1 :       (strstr(psSLDXML, &quot;StyledLayerDescriptor&quot;) == NULL)) {</span>
<span class="lineNum">     522 </span><span class="lineNoCov">          0 :     msSetError(MS_WMSERR, &quot;Invalid SLD document&quot;, &quot;&quot;);</span>
<span class="lineNum">     523 </span><span class="lineNoCov">          0 :     return NULL;</span>
<span class="lineNum">     524 </span>            :   }
<span class="lineNum">     525 </span>            : 
<span class="lineNum">     526 </span><span class="lineCov">          1 :   psRoot = CPLParseXMLString(psSLDXML);</span>
<span class="lineNum">     527 </span><span class="lineCov">          1 :   if( psRoot == NULL) {</span>
<span class="lineNum">     528 </span><span class="lineNoCov">          0 :     msSetError(MS_WMSERR, &quot;Invalid SLD document : %s&quot;, &quot;&quot;, psSLDXML);</span>
<span class="lineNum">     529 </span><span class="lineNoCov">          0 :     return NULL;</span>
<span class="lineNum">     530 </span>            :   }
<span class="lineNum">     531 </span>            : 
<span class="lineNum">     532 </span>            :   /* strip namespaces ogc and sld and gml */
<span class="lineNum">     533 </span><span class="lineCov">          1 :   CPLStripXMLNamespace(psRoot, &quot;ogc&quot;, 1);</span>
<span class="lineNum">     534 </span><span class="lineCov">          1 :   CPLStripXMLNamespace(psRoot, &quot;sld&quot;, 1);</span>
<span class="lineNum">     535 </span><span class="lineCov">          1 :   CPLStripXMLNamespace(psRoot, &quot;gml&quot;, 1);</span>
<span class="lineNum">     536 </span><span class="lineCov">          1 :   CPLStripXMLNamespace(psRoot, &quot;se&quot;, 1);</span>
<span class="lineNum">     537 </span>            : 
<span class="lineNum">     538 </span>            : 
<span class="lineNum">     539 </span>            :   /* -------------------------------------------------------------------- */
<span class="lineNum">     540 </span>            :   /*      get the root element (StyledLayerDescriptor).                   */
<span class="lineNum">     541 </span>            :   /* -------------------------------------------------------------------- */
<span class="lineNum">     542 </span><span class="lineCov">          1 :   psSLD = CPLGetXMLNode(psRoot, &quot;=StyledLayerDescriptor&quot;);</span>
<span class="lineNum">     543 </span><span class="lineCov">          1 :   if (!psSLD) {</span>
<span class="lineNum">     544 </span><span class="lineNoCov">          0 :     msSetError(MS_WMSERR, &quot;Invalid SLD document : %s&quot;, &quot;&quot;, psSLDXML);</span>
<span class="lineNum">     545 </span><span class="lineNoCov">          0 :     return NULL;</span>
<span class="lineNum">     546 </span>            :   }
<span class="lineNum">     547 </span>            : 
<span class="lineNum">     548 </span>            :   /* -------------------------------------------------------------------- */
<span class="lineNum">     549 </span>            :   /*      Parse the named layers.                                         */
<span class="lineNum">     550 </span>            :   /* -------------------------------------------------------------------- */
<span class="lineNum">     551 </span><span class="lineCov">          1 :   LOOP_ON_CHILD_ELEMENT(psSLD, psNamedLayer, &quot;NamedLayer&quot;)</span>
<span class="lineNum">     552 </span>            :   {
<span class="lineNum">     553 </span><span class="lineCov">          1 :     nLayers++;</span>
<span class="lineNum">     554 </span>            :   }
<span class="lineNum">     555 </span>            : 
<span class="lineNum">     556 </span><span class="lineCov">          1 :   if (nLayers &gt; 0)</span>
<span class="lineNum">     557 </span><span class="lineCov">          1 :     pasLayers = (layerObj *)malloc(sizeof(layerObj)*nLayers);</span>
<span class="lineNum">     558 </span>            :   else
<span class="lineNum">     559 </span>            :     return NULL;
<span class="lineNum">     560 </span>            : 
<span class="lineNum">     561 </span><span class="lineCov">          1 :   LOOP_ON_CHILD_ELEMENT(psSLD, psNamedLayer, &quot;NamedLayer&quot;)</span>
<span class="lineNum">     562 </span>            :   {
<span class="lineNum">     563 </span><span class="lineCov">          1 :       CPLXMLNode* psName = CPLGetXMLNode(psNamedLayer, &quot;Name&quot;);</span>
<span class="lineNum">     564 </span><span class="lineCov">          1 :       initLayer(&amp;pasLayers[iLayer], map);</span>
<span class="lineNum">     565 </span>            : 
<span class="lineNum">     566 </span><span class="lineCov">          1 :       if (psName &amp;&amp; psName-&gt;psChild &amp;&amp;  psName-&gt;psChild-&gt;pszValue)</span>
<span class="lineNum">     567 </span><span class="lineCov">          1 :         pasLayers[iLayer].name = msStrdup(psName-&gt;psChild-&gt;pszValue);</span>
<span class="lineNum">     568 </span>            : 
<span class="lineNum">     569 </span><span class="lineCov">          1 :       if( msSLDParseNamedLayer(psNamedLayer, &amp;pasLayers[iLayer]) != MS_SUCCESS ) {</span>
<span class="lineNum">     570 </span>            :         int i;
<span class="lineNum">     571 </span><span class="lineCov">          1 :         for (i=0; i&lt;=iLayer; i++)</span>
<span class="lineNum">     572 </span><span class="lineCov">          1 :             freeLayer(&amp;pasLayers[i]);</span>
<span class="lineNum">     573 </span><span class="lineCov">          1 :         msFree(pasLayers);</span>
<span class="lineNum">     574 </span>            :         nLayers = 0;
<span class="lineNum">     575 </span>            :         pasLayers = NULL;
<span class="lineNum">     576 </span><span class="lineCov">          1 :         break;</span>
<span class="lineNum">     577 </span>            :       }
<span class="lineNum">     578 </span>            : 
<span class="lineNum">     579 </span><span class="lineCov">          1 :       iLayer++;</span>
<span class="lineNum">     580 </span>            :   }
<span class="lineNum">     581 </span>            : 
<span class="lineNum">     582 </span><span class="lineCov">          1 :   if (pnLayers)</span>
<span class="lineNum">     583 </span><span class="lineCov">          1 :     *pnLayers = nLayers;</span>
<span class="lineNum">     584 </span>            : 
<span class="lineNum">     585 </span>            :   if (psRoot)
<span class="lineNum">     586 </span><span class="lineCov">          1 :     CPLDestroyXMLNode(psRoot);</span>
<span class="lineNum">     587 </span>            : 
<span class="lineNum">     588 </span><span class="lineCov">          1 :   return pasLayers;</span>
<span class="lineNum">     589 </span>            : }
<span class="lineNum">     590 </span>            : 
<span class="lineNum">     591 </span>            : 
<span class="lineNum">     592 </span>            : /************************************************************************/
<span class="lineNum">     593 </span>            : /*                           _SLDApplyRuleValues                        */
<span class="lineNum">     594 </span>            : /*                                                                      */
<span class="lineNum">     595 </span>            : /*      Utility function to set the scale, title/name for the          */
<a name="596"><span class="lineNum">     596 </span>            : /*      classes created by a Rule.                                      */</a>
<span class="lineNum">     597 </span>            : /************************************************************************/
<span class="lineNum">     598 </span><span class="lineCov">          1 : void  _SLDApplyRuleValues(CPLXMLNode *psRule, layerObj *psLayer,</span>
<span class="lineNum">     599 </span>            :                           int nNewClasses)
<span class="lineNum">     600 </span>            : {
<span class="lineNum">     601 </span>            :   int         i=0;
<span class="lineNum">     602 </span>            :   CPLXMLNode *psMinScale=NULL, *psMaxScale=NULL;
<span class="lineNum">     603 </span>            :   CPLXMLNode *psName=NULL, *psTitle=NULL;
<span class="lineNum">     604 </span>            :   double dfMinScale=0, dfMaxScale=0;
<span class="lineNum">     605 </span>            :   char *pszName=NULL, *pszTitle=NULL;
<span class="lineNum">     606 </span>            : 
<span class="lineNum">     607 </span><span class="lineCov">          1 :   if (psRule &amp;&amp; psLayer &amp;&amp; nNewClasses &gt; 0) {</span>
<span class="lineNum">     608 </span>            :     /* -------------------------------------------------------------------- */
<span class="lineNum">     609 </span>            :     /*      parse minscale and maxscale.                                    */
<span class="lineNum">     610 </span>            :     /* -------------------------------------------------------------------- */
<span class="lineNum">     611 </span><span class="lineCov">          1 :     psMinScale = CPLGetXMLNode(psRule,</span>
<span class="lineNum">     612 </span>            :                                &quot;MinScaleDenominator&quot;);
<span class="lineNum">     613 </span><span class="lineCov">          1 :     if (psMinScale &amp;&amp; psMinScale-&gt;psChild &amp;&amp;</span>
<span class="lineNum">     614 </span><span class="lineNoCov">          0 :         psMinScale-&gt;psChild-&gt;pszValue)</span>
<span class="lineNum">     615 </span>            :       dfMinScale = atof(psMinScale-&gt;psChild-&gt;pszValue);
<span class="lineNum">     616 </span>            : 
<span class="lineNum">     617 </span><span class="lineCov">          1 :     psMaxScale = CPLGetXMLNode(psRule,</span>
<span class="lineNum">     618 </span>            :                                &quot;MaxScaleDenominator&quot;);
<span class="lineNum">     619 </span><span class="lineCov">          1 :     if (psMaxScale &amp;&amp; psMaxScale-&gt;psChild &amp;&amp;</span>
<span class="lineNum">     620 </span><span class="lineNoCov">          0 :         psMaxScale-&gt;psChild-&gt;pszValue)</span>
<span class="lineNum">     621 </span>            :       dfMaxScale = atof(psMaxScale-&gt;psChild-&gt;pszValue);
<span class="lineNum">     622 </span>            : 
<span class="lineNum">     623 </span>            :     /* -------------------------------------------------------------------- */
<span class="lineNum">     624 </span>            :     /*      parse name and title.                                           */
<span class="lineNum">     625 </span>            :     /* -------------------------------------------------------------------- */
<span class="lineNum">     626 </span><span class="lineCov">          1 :     psName = CPLGetXMLNode(psRule, &quot;Name&quot;);</span>
<span class="lineNum">     627 </span><span class="lineCov">          1 :     if (psName &amp;&amp; psName-&gt;psChild &amp;&amp;</span>
<span class="lineNum">     628 </span><span class="lineCov">          1 :         psName-&gt;psChild-&gt;pszValue)</span>
<span class="lineNum">     629 </span>            :       pszName = psName-&gt;psChild-&gt;pszValue;
<span class="lineNum">     630 </span>            : 
<span class="lineNum">     631 </span><span class="lineCov">          1 :     psTitle = CPLGetXMLNode(psRule, &quot;Title&quot;);</span>
<span class="lineNum">     632 </span><span class="lineCov">          1 :     if (psTitle &amp;&amp; psTitle-&gt;psChild &amp;&amp;</span>
<span class="lineNum">     633 </span><span class="lineCov">          1 :         psTitle-&gt;psChild-&gt;pszValue)</span>
<span class="lineNum">     634 </span>            :       pszTitle = psTitle-&gt;psChild-&gt;pszValue;
<span class="lineNum">     635 </span>            : 
<span class="lineNum">     636 </span>            :     /* -------------------------------------------------------------------- */
<span class="lineNum">     637 </span>            :     /*      set the scale to all the classes created by the rule.           */
<span class="lineNum">     638 </span>            :     /* -------------------------------------------------------------------- */
<span class="lineNum">     639 </span><span class="lineCov">          1 :     if (dfMinScale &gt; 0 || dfMaxScale &gt; 0) {</span>
<span class="lineNum">     640 </span><span class="lineNoCov">          0 :       for (i=0; i&lt;nNewClasses; i++) {</span>
<span class="lineNum">     641 </span><span class="lineNoCov">          0 :         if (dfMinScale &gt; 0)</span>
<span class="lineNum">     642 </span><span class="lineNoCov">          0 :           psLayer-&gt;class[psLayer-&gt;numclasses-1-i]-&gt;minscaledenom = dfMinScale;</span>
<span class="lineNum">     643 </span><span class="lineNoCov">          0 :         if (dfMaxScale)</span>
<span class="lineNum">     644 </span><span class="lineNoCov">          0 :           psLayer-&gt;class[psLayer-&gt;numclasses-1-i]-&gt;maxscaledenom = dfMaxScale;</span>
<span class="lineNum">     645 </span>            :       }
<span class="lineNum">     646 </span>            :     }
<span class="lineNum">     647 </span>            :     /* -------------------------------------------------------------------- */
<span class="lineNum">     648 </span>            :     /*      set name and title to the classes created by the rule.          */
<span class="lineNum">     649 </span>            :     /* -------------------------------------------------------------------- */
<span class="lineNum">     650 </span><span class="lineCov">          1 :     for (i=0; i&lt;nNewClasses; i++) {</span>
<span class="lineNum">     651 </span><span class="lineCov">          1 :       if (!psLayer-&gt;class[psLayer-&gt;numclasses-1-i]-&gt;name) {</span>
<span class="lineNum">     652 </span><span class="lineCov">          1 :         if (pszName)</span>
<span class="lineNum">     653 </span><span class="lineCov">          1 :           psLayer-&gt;class[psLayer-&gt;numclasses-1-i]-&gt;name = msStrdup(pszName);</span>
<span class="lineNum">     654 </span><span class="lineCov">          1 :         else if (pszTitle)</span>
<span class="lineNum">     655 </span><span class="lineCov">          1 :           psLayer-&gt;class[psLayer-&gt;numclasses-1-i]-&gt;name = msStrdup(pszTitle);</span>
<span class="lineNum">     656 </span>            :         else
<span class="lineNum">     657 </span>            :         {
<span class="lineNum">     658 </span>            :           // Build a name from layer and class info
<span class="lineNum">     659 </span>            :           char szTmp[256];
<span class="lineNum">     660 </span><span class="lineCov">          1 :           snprintf(szTmp, sizeof(szTmp), &quot;%s#%d&quot;, psLayer-&gt;name,</span>
<span class="lineNum">     661 </span>            :               psLayer-&gt;numclasses-1-i);
<span class="lineNum">     662 </span><span class="lineCov">          1 :           psLayer-&gt;class[psLayer-&gt;numclasses-1-i]-&gt;name = msStrdup(szTmp);</span>
<span class="lineNum">     663 </span>            :         }
<span class="lineNum">     664 </span>            :       }
<span class="lineNum">     665 </span>            :     }
<span class="lineNum">     666 </span><span class="lineCov">          1 :     if (pszTitle) {</span>
<span class="lineNum">     667 </span><span class="lineCov">          1 :       for (i=0; i&lt;nNewClasses; i++) {</span>
<span class="lineNum">     668 </span><span class="lineCov">          1 :         psLayer-&gt;class[psLayer-&gt;numclasses-1-i]-&gt;title =</span>
<span class="lineNum">     669 </span><span class="lineCov">          1 :               msStrdup(pszTitle);</span>
<span class="lineNum">     670 </span>            :       }
<span class="lineNum">     671 </span>            :     }
<span class="lineNum">     672 </span>            : 
<span class="lineNum">     673 </span>            :   }
<span class="lineNum">     674 </span>            : 
<span class="lineNum">     675 </span><span class="lineCov">          1 : }</span>
<span class="lineNum">     676 </span>            : 
<span class="lineNum">     677 </span>            : /************************************************************************/
<span class="lineNum">     678 </span>            : /*                     msSLDGetCommonExpressionFromFilter               */
<span class="lineNum">     679 </span>            : /*                                                                      */
<span class="lineNum">     680 </span>            : /*      Get a common expression valid from the filter valid for the    */
<a name="681"><span class="lineNum">     681 </span>            : /*      temporary layer.                                                */</a>
<span class="lineNum">     682 </span>            : /************************************************************************/
<span class="lineNum">     683 </span><span class="lineCov">          1 : static char* msSLDGetCommonExpressionFromFilter(CPLXMLNode* psFilter,</span>
<span class="lineNum">     684 </span>            :                                                 layerObj *psLayer)
<span class="lineNum">     685 </span>            : {
<span class="lineNum">     686 </span>            :     char *pszExpression = NULL;
<span class="lineNum">     687 </span>            :     CPLXMLNode *psTmpNextNode = NULL;
<span class="lineNum">     688 </span>            :     CPLXMLNode *psTmpNode = NULL;
<span class="lineNum">     689 </span>            :     FilterEncodingNode *psNode = NULL;
<span class="lineNum">     690 </span>            :     char *pszTmpFilter = NULL;
<span class="lineNum">     691 </span>            :     layerObj *psCurrentLayer = NULL;
<span class="lineNum">     692 </span>            :     const char *pszWmsName=NULL;
<span class="lineNum">     693 </span>            :     const char *key=NULL;
<span class="lineNum">     694 </span>            : 
<span class="lineNum">     695 </span>            :     /* clone the tree and set the next node to null */
<span class="lineNum">     696 </span>            :     /* so we only have the Filter node */
<span class="lineNum">     697 </span><span class="lineCov">          1 :     psTmpNode = CPLCloneXMLTree(psFilter);</span>
<span class="lineNum">     698 </span><span class="lineCov">          1 :     psTmpNextNode = psTmpNode-&gt;psNext;</span>
<span class="lineNum">     699 </span><span class="lineCov">          1 :     psTmpNode-&gt;psNext = NULL;</span>
<span class="lineNum">     700 </span><span class="lineCov">          1 :     pszTmpFilter = CPLSerializeXMLTree(psTmpNode);</span>
<span class="lineNum">     701 </span><span class="lineCov">          1 :     psTmpNode-&gt;psNext = psTmpNextNode;</span>
<span class="lineNum">     702 </span><span class="lineCov">          1 :     CPLDestroyXMLNode(psTmpNode);</span>
<span class="lineNum">     703 </span>            : 
<span class="lineNum">     704 </span><span class="lineCov">          1 :     if (pszTmpFilter) {</span>
<span class="lineNum">     705 </span><span class="lineCov">          1 :         psNode = FLTParseFilterEncoding(pszTmpFilter);</span>
<span class="lineNum">     706 </span>            : 
<span class="lineNum">     707 </span><span class="lineCov">          1 :         CPLFree(pszTmpFilter);</span>
<span class="lineNum">     708 </span>            :     }
<span class="lineNum">     709 </span>            : 
<span class="lineNum">     710 </span><span class="lineCov">          1 :     if (psNode) {</span>
<span class="lineNum">     711 </span>            :         int j;
<span class="lineNum">     712 </span>            : 
<span class="lineNum">     713 </span>            :         /*preparse the filter for possible gml aliases set on the layer's metadata:
<span class="lineNum">     714 </span>            :         &quot;gml_NA3DESC_alias&quot; &quot;alias_name&quot; and filter could be
<span class="lineNum">     715 </span>            :         &lt;ogc:PropertyName&gt;alias_name&lt;/ogc:PropertyName&gt; #3079*/
<span class="lineNum">     716 </span><span class="lineCov">          1 :         for (j=0; j&lt;psLayer-&gt;map-&gt;numlayers; j++) {</span>
<span class="lineNum">     717 </span><span class="lineCov">          1 :             psCurrentLayer = GET_LAYER(psLayer-&gt;map, j);</span>
<span class="lineNum">     718 </span>            : 
<span class="lineNum">     719 </span><span class="lineCov">          1 :             pszWmsName = msOWSLookupMetadata(&amp;(psCurrentLayer-&gt;metadata), &quot;MO&quot;, &quot;name&quot;);</span>
<span class="lineNum">     720 </span>            : 
<span class="lineNum">     721 </span><span class="lineCov">          1 :             if ((psCurrentLayer-&gt;name &amp;&amp; psLayer-&gt;name &amp;&amp;</span>
<span class="lineNum">     722 </span><span class="lineCov">          1 :                     strcasecmp(psCurrentLayer-&gt;name, psLayer-&gt;name) == 0) ||</span>
<span class="lineNum">     723 </span><span class="lineCov">          1 :                 (psCurrentLayer-&gt;group &amp;&amp; psLayer-&gt;name &amp;&amp;</span>
<span class="lineNum">     724 </span><span class="lineCov">          1 :                     strcasecmp(psCurrentLayer-&gt;group, psLayer-&gt;name) == 0) ||</span>
<span class="lineNum">     725 </span><span class="lineCov">          1 :                 (psLayer-&gt;name &amp;&amp; pszWmsName &amp;&amp;</span>
<span class="lineNum">     726 </span><span class="lineNoCov">          0 :                     strcasecmp(pszWmsName, psLayer-&gt;name) == 0))</span>
<span class="lineNum">     727 </span>            :                 break;
<span class="lineNum">     728 </span>            :         }
<span class="lineNum">     729 </span><span class="lineCov">          1 :         if (j &lt; psLayer-&gt;map-&gt;numlayers) {</span>
<span class="lineNum">     730 </span>            :             /*make sure that the tmp layer has all the metadata that
<span class="lineNum">     731 </span>            :             the original layer has, allowing to do parsing for
<span class="lineNum">     732 </span>            :             such things as gml_attribute_type #3052*/
<span class="lineNum">     733 </span>            :             while (1) {
<span class="lineNum">     734 </span><span class="lineCov">          1 :                 key = msNextKeyFromHashTable(&amp;psCurrentLayer-&gt;metadata, key);</span>
<span class="lineNum">     735 </span><span class="lineCov">          1 :                 if (!key)</span>
<span class="lineNum">     736 </span>            :                     break;
<span class="lineNum">     737 </span>            :                 else
<span class="lineNum">     738 </span><span class="lineCov">          1 :                     msInsertHashTable(&amp;psLayer-&gt;metadata, key,</span>
<span class="lineNum">     739 </span>            :                                     msLookupHashTable(&amp;psCurrentLayer-&gt;metadata, key));
<span class="lineNum">     740 </span>            :             }
<span class="lineNum">     741 </span><span class="lineCov">          1 :             FLTPreParseFilterForAliasAndGroup(psNode, psLayer-&gt;map, j, &quot;G&quot;);</span>
<span class="lineNum">     742 </span>            :         }
<span class="lineNum">     743 </span>            : 
<span class="lineNum">     744 </span><span class="lineCov">          1 :         pszExpression = FLTGetCommonExpression(psNode, psLayer);</span>
<span class="lineNum">     745 </span><span class="lineCov">          1 :         FLTFreeFilterEncodingNode(psNode);</span>
<span class="lineNum">     746 </span>            :     }
<span class="lineNum">     747 </span>            : 
<span class="lineNum">     748 </span><span class="lineCov">          1 :     return pszExpression;</span>
<span class="lineNum">     749 </span>            : }
<span class="lineNum">     750 </span>            : 
<span class="lineNum">     751 </span>            : /************************************************************************/
<span class="lineNum">     752 </span>            : /*                          msSLDParseUserStyle                         */
<span class="lineNum">     753 </span>            : /*                                                                      */
<span class="lineNum">     754 </span>            : /*      Parse UserStyle node.                                           */
<a name="755"><span class="lineNum">     755 </span>            : /************************************************************************/</a>
<span class="lineNum">     756 </span>            : 
<span class="lineNum">     757 </span><span class="lineCov">          1 : static void msSLDParseUserStyle(CPLXMLNode* psUserStyle, layerObj *psLayer)</span>
<span class="lineNum">     758 </span>            : {
<span class="lineNum">     759 </span>            :     CPLXMLNode *psFeatureTypeStyle;
<span class="lineNum">     760 </span><span class="lineCov">          1 :     const char* pszUserStyleName = CPLGetXMLValue(psUserStyle, &quot;Name&quot;, NULL);</span>
<span class="lineNum">     761 </span><span class="lineCov">          1 :     if( pszUserStyleName )</span>
<span class="lineNum">     762 </span>            :     {
<span class="lineNum">     763 </span><span class="lineCov">          1 :         const char* pszIsDefault = CPLGetXMLValue(psUserStyle, &quot;IsDefault&quot;, &quot;0&quot;);</span>
<span class="lineNum">     764 </span><span class="lineCov">          1 :         if( EQUAL(pszIsDefault, &quot;true&quot;) || EQUAL(pszIsDefault, &quot;1&quot;) )</span>
<span class="lineNum">     765 </span>            :         {
<span class="lineNum">     766 </span><span class="lineCov">          1 :             msFree(psLayer-&gt;classgroup);</span>
<span class="lineNum">     767 </span><span class="lineCov">          1 :             psLayer-&gt;classgroup = msStrdup(pszUserStyleName);</span>
<span class="lineNum">     768 </span>            :         }
<span class="lineNum">     769 </span>            :     }
<span class="lineNum">     770 </span>            : 
<span class="lineNum">     771 </span><span class="lineCov">          1 :     LOOP_ON_CHILD_ELEMENT(psUserStyle, psFeatureTypeStyle,</span>
<span class="lineNum">     772 </span>            :                           &quot;FeatureTypeStyle&quot;)
<span class="lineNum">     773 </span>            :     {
<span class="lineNum">     774 </span>            :         CPLXMLNode* psRule;
<span class="lineNum">     775 </span>            : 
<span class="lineNum">     776 </span>            :         /* -------------------------------------------------------------------- */
<span class="lineNum">     777 </span>            :         /*      Parse rules with no Else filter.                                */
<span class="lineNum">     778 </span>            :         /* -------------------------------------------------------------------- */
<span class="lineNum">     779 </span><span class="lineCov">          1 :         LOOP_ON_CHILD_ELEMENT(psFeatureTypeStyle, psRule, &quot;Rule&quot;)</span>
<span class="lineNum">     780 </span>            :         {
<span class="lineNum">     781 </span>            :           CPLXMLNode *psFilter = NULL;
<span class="lineNum">     782 </span>            :           CPLXMLNode *psElseFilter = NULL;
<span class="lineNum">     783 </span>            :           int nNewClasses=0, nClassBeforeFilter=0, nClassAfterFilter=0;
<span class="lineNum">     784 </span>            :           int nClassAfterRule=0, nClassBeforeRule=0;
<span class="lineNum">     785 </span>            : 
<span class="lineNum">     786 </span>            :           /* used for scale setting */
<span class="lineNum">     787 </span><span class="lineCov">          1 :           nClassBeforeRule = psLayer-&gt;numclasses;</span>
<span class="lineNum">     788 </span>            : 
<span class="lineNum">     789 </span><span class="lineCov">          1 :           psElseFilter = CPLGetXMLNode(psRule, &quot;ElseFilter&quot;);</span>
<span class="lineNum">     790 </span><span class="lineCov">          1 :           nClassBeforeFilter = psLayer-&gt;numclasses;</span>
<span class="lineNum">     791 </span><span class="lineCov">          1 :           if (psElseFilter == NULL)</span>
<span class="lineNum">     792 </span><span class="lineCov">          1 :             msSLDParseRule(psRule, psLayer, pszUserStyleName);</span>
<span class="lineNum">     793 </span><span class="lineCov">          1 :           nClassAfterFilter = psLayer-&gt;numclasses;</span>
<span class="lineNum">     794 </span>            : 
<span class="lineNum">     795 </span>            :           /* -------------------------------------------------------------------- */
<span class="lineNum">     796 </span>            :           /*      Parse the filter and apply it to the latest class created by    */
<span class="lineNum">     797 </span>            :           /*      the rule.                                                       */
<span class="lineNum">     798 </span>            :           /*      NOTE : Spatial Filter is not supported.                         */
<span class="lineNum">     799 </span>            :           /* -------------------------------------------------------------------- */
<span class="lineNum">     800 </span><span class="lineCov">          1 :           psFilter = CPLGetXMLNode(psRule, &quot;Filter&quot;);</span>
<span class="lineNum">     801 </span><span class="lineCov">          1 :           if (psFilter &amp;&amp; psFilter-&gt;psChild &amp;&amp; psFilter-&gt;psChild-&gt;pszValue) {</span>
<span class="lineNum">     802 </span><span class="lineCov">          1 :             char* pszExpression = msSLDGetCommonExpressionFromFilter(psFilter,</span>
<span class="lineNum">     803 </span>            :                                                                      psLayer);
<span class="lineNum">     804 </span><span class="lineCov">          1 :             if (pszExpression) {</span>
<span class="lineNum">     805 </span>            :                 int i;
<span class="lineNum">     806 </span><span class="lineCov">          1 :                 nNewClasses =</span>
<span class="lineNum">     807 </span>            :                   nClassAfterFilter - nClassBeforeFilter;
<span class="lineNum">     808 </span><span class="lineCov">          1 :                 for (i=0; i&lt;nNewClasses; i++) {</span>
<span class="lineNum">     809 </span><span class="lineCov">          1 :                   expressionObj* exp = &amp;(psLayer-&gt;</span>
<span class="lineNum">     810 </span><span class="lineCov">          1 :                                          class[psLayer-&gt;numclasses-1-i]-&gt;</span>
<span class="lineNum">     811 </span>            :                                          expression);
<span class="lineNum">     812 </span><span class="lineCov">          1 :                   msFreeExpression(exp);</span>
<span class="lineNum">     813 </span><span class="lineCov">          1 :                   msInitExpression(exp);</span>
<span class="lineNum">     814 </span><span class="lineCov">          1 :                   exp-&gt;string = msStrdup(pszExpression);</span>
<span class="lineNum">     815 </span><span class="lineCov">          1 :                   exp-&gt;type = MS_EXPRESSION;</span>
<span class="lineNum">     816 </span>            :                 }
<span class="lineNum">     817 </span><span class="lineCov">          1 :                 msFree(pszExpression);</span>
<span class="lineNum">     818 </span>            :                 pszExpression = NULL;
<span class="lineNum">     819 </span>            :             }
<span class="lineNum">     820 </span>            :           }
<span class="lineNum">     821 </span><span class="lineCov">          1 :           nClassAfterRule = psLayer-&gt;numclasses;</span>
<span class="lineNum">     822 </span><span class="lineCov">          1 :           nNewClasses = nClassAfterRule - nClassBeforeRule;</span>
<span class="lineNum">     823 </span>            : 
<span class="lineNum">     824 </span>            :           /* apply scale and title to newly created classes */
<span class="lineNum">     825 </span><span class="lineCov">          1 :           _SLDApplyRuleValues(psRule, psLayer, nNewClasses);</span>
<span class="lineNum">     826 </span>            : 
<span class="lineNum">     827 </span>            :           /* TODO : parse legendgraphic */
<span class="lineNum">     828 </span>            :         }
<span class="lineNum">     829 </span>            :         /* -------------------------------------------------------------------- */
<span class="lineNum">     830 </span>            :         /*      First parse rules with the else filter. These rules will        */
<span class="lineNum">     831 </span>            :         /*      create the classes that are placed at the end of class          */
<span class="lineNum">     832 </span>            :         /*      list. (See how classes are applied to layers in function        */
<span class="lineNum">     833 </span>            :         /*      msSLDApplySLD).                                                 */
<span class="lineNum">     834 </span>            :         /* -------------------------------------------------------------------- */
<span class="lineNum">     835 </span><span class="lineCov">          1 :         LOOP_ON_CHILD_ELEMENT(psFeatureTypeStyle, psRule, &quot;Rule&quot;)</span>
<span class="lineNum">     836 </span>            :         {
<span class="lineNum">     837 </span><span class="lineCov">          1 :           CPLXMLNode* psElseFilter = CPLGetXMLNode(psRule, &quot;ElseFilter&quot;);</span>
<span class="lineNum">     838 </span><span class="lineCov">          1 :           if (psElseFilter) {</span>
<span class="lineNum">     839 </span><span class="lineCov">          1 :             msSLDParseRule(psRule, psLayer, pszUserStyleName);</span>
<span class="lineNum">     840 </span><span class="lineCov">          1 :             _SLDApplyRuleValues(psRule, psLayer, 1);</span>
<span class="lineNum">     841 </span><span class="lineCov">          1 :             psLayer-&gt;class[psLayer-&gt;numclasses-1]-&gt;isfallback = TRUE;</span>
<span class="lineNum">     842 </span>            :           }
<span class="lineNum">     843 </span>            :         }
<span class="lineNum">     844 </span>            :     }
<span class="lineNum">     845 </span><span class="lineCov">          1 : }</span>
<span class="lineNum">     846 </span>            : 
<span class="lineNum">     847 </span>            : /************************************************************************/
<span class="lineNum">     848 </span>            : /*                           msSLDParseNamedLayer                       */
<span class="lineNum">     849 </span>            : /*                                                                      */
<a name="850"><span class="lineNum">     850 </span>            : /*      Parse NamedLayer root.                                          */</a>
<span class="lineNum">     851 </span>            : /************************************************************************/
<span class="lineNum">     852 </span><span class="lineCov">          1 : int msSLDParseNamedLayer(CPLXMLNode *psRoot, layerObj *psLayer)</span>
<span class="lineNum">     853 </span>            : {
<span class="lineNum">     854 </span>            :   CPLXMLNode *psLayerFeatureConstraints = NULL;
<span class="lineNum">     855 </span>            : 
<span class="lineNum">     856 </span><span class="lineCov">          1 :   if (!psRoot || !psLayer)</span>
<span class="lineNum">     857 </span>            :     return MS_FAILURE;
<span class="lineNum">     858 </span>            : 
<span class="lineNum">     859 </span><span class="lineCov">          1 :   if (CPLGetXMLNode(psRoot, &quot;UserStyle&quot;)) {</span>
<span class="lineNum">     860 </span>            :     CPLXMLNode *psUserStyle;
<span class="lineNum">     861 </span><span class="lineCov">          1 :     LOOP_ON_CHILD_ELEMENT(psRoot, psUserStyle, &quot;UserStyle&quot;)</span>
<span class="lineNum">     862 </span>            :     {
<span class="lineNum">     863 </span><span class="lineCov">          1 :         msSLDParseUserStyle(psUserStyle, psLayer);</span>
<span class="lineNum">     864 </span>            :     }
<span class="lineNum">     865 </span>            :   }
<span class="lineNum">     866 </span>            :   /* check for Named styles*/
<span class="lineNum">     867 </span>            :   else {
<span class="lineNum">     868 </span><span class="lineCov">          1 :     CPLXMLNode* psNamedStyle = CPLGetXMLNode(psRoot, &quot;NamedStyle&quot;);</span>
<span class="lineNum">     869 </span><span class="lineCov">          1 :     if (psNamedStyle) {</span>
<span class="lineNum">     870 </span><span class="lineCov">          1 :       CPLXMLNode* psSLDName = CPLGetXMLNode(psNamedStyle, &quot;Name&quot;);</span>
<span class="lineNum">     871 </span><span class="lineCov">          1 :       if (psSLDName &amp;&amp; psSLDName-&gt;psChild &amp;&amp;  psSLDName-&gt;psChild-&gt;pszValue) {</span>
<span class="lineNum">     872 </span><span class="lineCov">          1 :         msFree(psLayer-&gt;classgroup);</span>
<span class="lineNum">     873 </span><span class="lineCov">          1 :         psLayer-&gt;classgroup = msStrdup(psSLDName-&gt;psChild-&gt;pszValue);</span>
<span class="lineNum">     874 </span>            :       }
<span class="lineNum">     875 </span>            :     }
<span class="lineNum">     876 </span>            :   }
<span class="lineNum">     877 </span>            : 
<span class="lineNum">     878 </span>            :   /* Deal with LayerFeatureConstraints */
<span class="lineNum">     879 </span><span class="lineCov">          1 :   psLayerFeatureConstraints = CPLGetXMLNode(psRoot, &quot;LayerFeatureConstraints&quot;);</span>
<span class="lineNum">     880 </span><span class="lineCov">          1 :   if( psLayerFeatureConstraints != NULL ) {</span>
<span class="lineNum">     881 </span><span class="lineCov">          1 :     CPLXMLNode* psIter = psLayerFeatureConstraints-&gt;psChild;</span>
<span class="lineNum">     882 </span>            :     CPLXMLNode* psFeatureTypeConstraint = NULL;
<span class="lineNum">     883 </span><span class="lineCov">          1 :     for(; psIter != NULL; psIter = psIter-&gt;psNext ) {</span>
<span class="lineNum">     884 </span><span class="lineCov">          1 :       if( psIter-&gt;eType == CXT_Element &amp;&amp;</span>
<span class="lineNum">     885 </span><span class="lineCov">          1 :             strcmp(psIter-&gt;pszValue, &quot;FeatureTypeConstraint&quot;) == 0 )  {</span>
<span class="lineNum">     886 </span><span class="lineCov">          1 :         if( psFeatureTypeConstraint == NULL ) {</span>
<span class="lineNum">     887 </span>            :           psFeatureTypeConstraint = psIter;
<span class="lineNum">     888 </span>            :         } else {
<span class="lineNum">     889 </span><span class="lineCov">          1 :           msSetError(MS_WMSERR, &quot;Only one single FeatureTypeConstraint element &quot;</span>
<span class="lineNum">     890 </span>            :                     &quot;per LayerFeatureConstraints is supported&quot;, &quot;&quot;);
<span class="lineNum">     891 </span><span class="lineCov">          1 :           return MS_FAILURE;</span>
<span class="lineNum">     892 </span>            :         }
<span class="lineNum">     893 </span>            :       }
<span class="lineNum">     894 </span>            :     }
<span class="lineNum">     895 </span><span class="lineCov">          1 :     if( psFeatureTypeConstraint != NULL ) {</span>
<span class="lineNum">     896 </span>            :       CPLXMLNode* psFilter;
<span class="lineNum">     897 </span><span class="lineCov">          1 :       if( CPLGetXMLNode(psFeatureTypeConstraint, &quot;FeatureTypeName&quot;) != NULL ) {</span>
<span class="lineNum">     898 </span><span class="lineCov">          1 :         msSetError(MS_WMSERR, &quot;FeatureTypeName element is not &quot;</span>
<span class="lineNum">     899 </span>            :                     &quot;supported in FeatureTypeConstraint&quot;, &quot;&quot;);
<span class="lineNum">     900 </span><span class="lineCov">          1 :         return MS_FAILURE;</span>
<span class="lineNum">     901 </span>            :       }
<span class="lineNum">     902 </span><span class="lineCov">          1 :       if( CPLGetXMLNode(psFeatureTypeConstraint, &quot;Extent&quot;) != NULL ) {</span>
<span class="lineNum">     903 </span><span class="lineCov">          1 :         msSetError(MS_WMSERR, &quot;Extent element is not &quot;</span>
<span class="lineNum">     904 </span>            :                     &quot;supported in FeatureTypeConstraint&quot;, &quot;&quot;);
<span class="lineNum">     905 </span><span class="lineCov">          1 :         return MS_FAILURE;</span>
<span class="lineNum">     906 </span>            :       }
<span class="lineNum">     907 </span><span class="lineCov">          1 :       psFilter = CPLGetXMLNode(psFeatureTypeConstraint, &quot;Filter&quot;);</span>
<span class="lineNum">     908 </span><span class="lineCov">          1 :       if (psFilter &amp;&amp; psFilter-&gt;psChild &amp;&amp; psFilter-&gt;psChild-&gt;pszValue) {</span>
<span class="lineNum">     909 </span><span class="lineCov">          1 :         char* pszExpression = msSLDGetCommonExpressionFromFilter(psFilter,</span>
<span class="lineNum">     910 </span>            :                                                                     psLayer);
<span class="lineNum">     911 </span><span class="lineCov">          1 :         if (pszExpression) {</span>
<span class="lineNum">     912 </span><span class="lineCov">          1 :             msFreeExpression(&amp;psLayer-&gt;filter);</span>
<span class="lineNum">     913 </span><span class="lineCov">          1 :             msInitExpression(&amp;psLayer-&gt;filter);</span>
<span class="lineNum">     914 </span><span class="lineCov">          1 :             psLayer-&gt;filter.string = pszExpression;</span>
<span class="lineNum">     915 </span><span class="lineCov">          1 :             psLayer-&gt;filter.type = MS_EXPRESSION;</span>
<span class="lineNum">     916 </span>            :         }
<span class="lineNum">     917 </span>            :       }
<span class="lineNum">     918 </span>            :     }
<span class="lineNum">     919 </span>            :   }
<span class="lineNum">     920 </span>            : 
<span class="lineNum">     921 </span>            :   return MS_SUCCESS;
<span class="lineNum">     922 </span>            : }
<span class="lineNum">     923 </span>            : 
<span class="lineNum">     924 </span>            : 
<span class="lineNum">     925 </span>            : /************************************************************************/
<span class="lineNum">     926 </span>            : /*                      msSLDParseRule()                                */
<span class="lineNum">     927 </span>            : /*                                                                      */
<a name="928"><span class="lineNum">     928 </span>            : /*      Parse a Rule node into classes for a specific layer.            */</a>
<span class="lineNum">     929 </span>            : /************************************************************************/
<span class="lineNum">     930 </span><span class="lineCov">          1 : int msSLDParseRule(CPLXMLNode *psRoot, layerObj *psLayer, const char* pszUserStyleName)</span>
<span class="lineNum">     931 </span>            : {
<span class="lineNum">     932 </span>            :   CPLXMLNode *psLineSymbolizer = NULL;
<span class="lineNum">     933 </span>            :   CPLXMLNode *psPolygonSymbolizer = NULL;
<span class="lineNum">     934 </span>            :   CPLXMLNode *psPointSymbolizer = NULL;
<span class="lineNum">     935 </span>            :   CPLXMLNode *psTextSymbolizer = NULL;
<span class="lineNum">     936 </span>            :   CPLXMLNode *psRasterSymbolizer = NULL;
<span class="lineNum">     937 </span>            : 
<span class="lineNum">     938 </span>            :   int nSymbolizer=0;
<span class="lineNum">     939 </span>            : 
<span class="lineNum">     940 </span><span class="lineCov">          1 :   if (!psRoot || !psLayer)</span>
<span class="lineNum">     941 </span>            :     return MS_FAILURE;
<span class="lineNum">     942 </span>            : 
<span class="lineNum">     943 </span>            :   /* TODO : parse name of the rule */
<span class="lineNum">     944 </span>            :   /* ==================================================================== */
<span class="lineNum">     945 </span>            :   /*      For each rule a new class is created. If there are more than    */
<span class="lineNum">     946 </span>            :   /*      one symbolizer, a style is added in the same class.             */
<span class="lineNum">     947 </span>            :   /* ==================================================================== */
<span class="lineNum">     948 </span>            : 
<span class="lineNum">     949 </span>            :   /* Raster symbolizer */
<span class="lineNum">     950 </span><span class="lineCov">          1 :   LOOP_ON_CHILD_ELEMENT(psRoot, psRasterSymbolizer, &quot;RasterSymbolizer&quot;)</span>
<span class="lineNum">     951 </span>            :   {
<span class="lineNum">     952 </span><span class="lineNoCov">          0 :     msSLDParseRasterSymbolizer(psRasterSymbolizer, psLayer, pszUserStyleName);</span>
<span class="lineNum">     953 </span>            :     if (nSymbolizer == 0)
<span class="lineNum">     954 </span>            :     {
<span class="lineNum">     955 </span><span class="lineNoCov">          0 :       psLayer-&gt;type = MS_LAYER_RASTER;</span>
<span class="lineNum">     956 </span>            :     }
<span class="lineNum">     957 </span>            :   }
<span class="lineNum">     958 </span>            : 
<span class="lineNum">     959 </span>            :   /* Polygon symbolizer */
<span class="lineNum">     960 </span><span class="lineCov">          1 :   LOOP_ON_CHILD_ELEMENT(psRoot, psPolygonSymbolizer, &quot;PolygonSymbolizer&quot;)</span>
<span class="lineNum">     961 </span>            :   {
<span class="lineNum">     962 </span><span class="lineCov">          1 :     const int bNewClass = (nSymbolizer == 0);</span>
<span class="lineNum">     963 </span><span class="lineCov">          1 :     msSLDParsePolygonSymbolizer(psPolygonSymbolizer, psLayer,</span>
<span class="lineNum">     964 </span>            :                                 bNewClass, pszUserStyleName);
<span class="lineNum">     965 </span><span class="lineCov">          1 :     psLayer-&gt;type = MS_LAYER_POLYGON;</span>
<span class="lineNum">     966 </span><span class="lineCov">          1 :     nSymbolizer++;</span>
<span class="lineNum">     967 </span>            :   }
<span class="lineNum">     968 </span>            : 
<span class="lineNum">     969 </span>            :   /* line symbolizer */
<span class="lineNum">     970 </span><span class="lineCov">          1 :   LOOP_ON_CHILD_ELEMENT(psRoot, psLineSymbolizer, &quot;LineSymbolizer&quot;)</span>
<span class="lineNum">     971 </span>            :   {
<span class="lineNum">     972 </span><span class="lineCov">          1 :     const int bNewClass = (nSymbolizer == 0);</span>
<span class="lineNum">     973 </span><span class="lineCov">          1 :     msSLDParseLineSymbolizer(psLineSymbolizer, psLayer, bNewClass,</span>
<span class="lineNum">     974 </span>            :                              pszUserStyleName);
<span class="lineNum">     975 </span><span class="lineCov">          1 :     if (bNewClass)</span>
<span class="lineNum">     976 </span>            :     {
<span class="lineNum">     977 </span><span class="lineCov">          1 :       psLayer-&gt;type = MS_LAYER_LINE;</span>
<span class="lineNum">     978 </span>            :     }
<span class="lineNum">     979 </span><span class="lineCov">          1 :     if (psLayer-&gt;type == MS_LAYER_POLYGON)</span>
<span class="lineNum">     980 </span>            :     {
<span class="lineNum">     981 </span><span class="lineCov">          1 :       const int nClassId = psLayer-&gt;numclasses - 1;</span>
<span class="lineNum">     982 </span><span class="lineCov">          1 :       if (nClassId &gt;= 0)</span>
<span class="lineNum">     983 </span>            :       {
<span class="lineNum">     984 </span><span class="lineCov">          1 :         const int nStyleId = psLayer-&gt;class[nClassId]-&gt;numstyles - 1;</span>
<span class="lineNum">     985 </span><span class="lineCov">          1 :         if (nStyleId &gt;= 0)</span>
<span class="lineNum">     986 </span>            :         {
<span class="lineNum">     987 </span><span class="lineCov">          1 :           styleObj * psStyle = psLayer-&gt;class[nClassId]-&gt;styles[nStyleId];</span>
<span class="lineNum">     988 </span><span class="lineCov">          1 :           psStyle-&gt;outlinecolor = psStyle-&gt;color;</span>
<span class="lineNum">     989 </span><span class="lineCov">          1 :           MS_INIT_COLOR(psStyle-&gt;color,-1,-1,-1,255);</span>
<span class="lineNum">     990 </span><span class="lineCov">          1 :           MS_COPYSTRING(psStyle-&gt;exprBindings[MS_STYLE_BINDING_OUTLINECOLOR].string,</span>
<span class="lineNum">     991 </span>            :               psStyle-&gt;exprBindings[MS_STYLE_BINDING_COLOR].string);
<span class="lineNum">     992 </span><span class="lineCov">          1 :           psStyle-&gt;exprBindings[MS_STYLE_BINDING_OUTLINECOLOR].type =</span>
<span class="lineNum">     993 </span><span class="lineCov">          1 :             psStyle-&gt;exprBindings[MS_STYLE_BINDING_COLOR].type;</span>
<span class="lineNum">     994 </span><span class="lineCov">          1 :           msFreeExpression(&amp;(psStyle-&gt;exprBindings[MS_STYLE_BINDING_COLOR]));</span>
<span class="lineNum">     995 </span><span class="lineCov">          1 :           msInitExpression(&amp;(psStyle-&gt;exprBindings[MS_STYLE_BINDING_COLOR]));</span>
<span class="lineNum">     996 </span>            :         }
<span class="lineNum">     997 </span>            :       }
<span class="lineNum">     998 </span>            :     }
<span class="lineNum">     999 </span><span class="lineCov">          1 :     nSymbolizer++;</span>
<span class="lineNum">    1000 </span>            :   }
<span class="lineNum">    1001 </span>            : 
<span class="lineNum">    1002 </span>            :   /* Point Symbolizer */
<span class="lineNum">    1003 </span><span class="lineCov">          1 :   LOOP_ON_CHILD_ELEMENT(psRoot, psPointSymbolizer, &quot;PointSymbolizer&quot;)</span>
<span class="lineNum">    1004 </span>            :   {
<span class="lineNum">    1005 </span><span class="lineCov">          1 :     const int bNewClass = (nSymbolizer == 0);</span>
<span class="lineNum">    1006 </span><span class="lineCov">          1 :     msSLDParsePointSymbolizer(psPointSymbolizer, psLayer, bNewClass,</span>
<span class="lineNum">    1007 </span>            :                               pszUserStyleName);
<span class="lineNum">    1008 </span><span class="lineCov">          1 :     if (bNewClass)</span>
<span class="lineNum">    1009 </span>            :     {
<span class="lineNum">    1010 </span><span class="lineCov">          1 :       psLayer-&gt;type = MS_LAYER_POINT;</span>
<span class="lineNum">    1011 </span>            :     }
<span class="lineNum">    1012 </span><span class="lineCov">          1 :     if (psLayer-&gt;type == MS_LAYER_POLYGON</span>
<span class="lineNum">    1013 </span>            :         || psLayer-&gt;type == MS_LAYER_LINE
<span class="lineNum">    1014 </span><span class="lineCov">          1 :         || psLayer-&gt;type == MS_LAYER_RASTER)</span>
<span class="lineNum">    1015 </span>            :     {
<span class="lineNum">    1016 </span><span class="lineCov">          1 :       const int nClassId = psLayer-&gt;numclasses - 1;</span>
<span class="lineNum">    1017 </span><span class="lineCov">          1 :       if (nClassId &gt;= 0)</span>
<span class="lineNum">    1018 </span>            :       {
<span class="lineNum">    1019 </span><span class="lineCov">          1 :         const int nStyleId = psLayer-&gt;class[nClassId]-&gt;numstyles - 1;</span>
<span class="lineNum">    1020 </span><span class="lineCov">          1 :         if (nStyleId &gt;= 0)</span>
<span class="lineNum">    1021 </span>            :         {
<span class="lineNum">    1022 </span><span class="lineCov">          1 :           styleObj * psStyle = psLayer-&gt;class[nClassId]-&gt;styles[nStyleId];</span>
<span class="lineNum">    1023 </span><span class="lineCov">          1 :           msStyleSetGeomTransform(psStyle, &quot;centroid&quot;);</span>
<span class="lineNum">    1024 </span>            :         }
<span class="lineNum">    1025 </span>            :       }
<span class="lineNum">    1026 </span>            :     }
<span class="lineNum">    1027 </span><span class="lineCov">          1 :     nSymbolizer++;</span>
<span class="lineNum">    1028 </span>            :   }
<span class="lineNum">    1029 </span>            : 
<span class="lineNum">    1030 </span>            :   /* Text symbolizer */
<span class="lineNum">    1031 </span>            :   /* ==================================================================== */
<span class="lineNum">    1032 </span>            :   /*      For text symbolizer, here is how it is translated into          */
<span class="lineNum">    1033 </span>            :   /*      mapserver classes :                                             */
<span class="lineNum">    1034 </span>            :   /*        - If there are other symbolizers(line, polygon, symbol),      */
<span class="lineNum">    1035 </span>            :   /*      the label object created will be created in the same class      */
<span class="lineNum">    1036 </span>            :   /*      (the last class) as the  symbolizer. This allows to have for    */
<span class="lineNum">    1037 </span>            :   /*      example of point layer with labels.                             */
<span class="lineNum">    1038 </span>            :   /*        - If there are no other symbolizers, a new class will be      */
<span class="lineNum">    1039 </span>            :   /*      created to contain the label object.                            */
<span class="lineNum">    1040 </span>            :   /* ==================================================================== */
<span class="lineNum">    1041 </span><span class="lineCov">          1 :   LOOP_ON_CHILD_ELEMENT(psRoot, psTextSymbolizer, &quot;TextSymbolizer&quot;)</span>
<span class="lineNum">    1042 </span>            :   {
<span class="lineNum">    1043 </span><span class="lineCov">          1 :     if (nSymbolizer == 0)</span>
<span class="lineNum">    1044 </span><span class="lineCov">          1 :       psLayer-&gt;type = MS_LAYER_POINT;</span>
<span class="lineNum">    1045 </span><span class="lineCov">          1 :     msSLDParseTextSymbolizer(psTextSymbolizer, psLayer, nSymbolizer &gt; 0, pszUserStyleName);</span>
<span class="lineNum">    1046 </span>            :   }
<span class="lineNum">    1047 </span>            : 
<span class="lineNum">    1048 </span>            :   return MS_SUCCESS;
<span class="lineNum">    1049 </span>            : }
<span class="lineNum">    1050 </span>            : 
<span class="lineNum">    1051 </span>            : /************************************************************************/
<span class="lineNum">    1052 </span>            : /*                            getClassId()                              */
<a name="1053"><span class="lineNum">    1053 </span>            : /************************************************************************/</a>
<span class="lineNum">    1054 </span>            : 
<span class="lineNum">    1055 </span><span class="lineCov">          1 : static int getClassId(layerObj *psLayer,</span>
<span class="lineNum">    1056 </span>            :                       int bNewClass,
<span class="lineNum">    1057 </span>            :                       const char* pszUserStyleName)
<span class="lineNum">    1058 </span>            : {
<span class="lineNum">    1059 </span>            :     int nClassId;
<span class="lineNum">    1060 </span><span class="lineCov">          1 :     if (bNewClass || psLayer-&gt;numclasses &lt;= 0) {</span>
<span class="lineNum">    1061 </span><span class="lineCov">          1 :       if (msGrowLayerClasses(psLayer) == NULL)</span>
<span class="lineNum">    1062 </span>            :         return -1;
<span class="lineNum">    1063 </span><span class="lineCov">          1 :       initClass(psLayer-&gt;class[psLayer-&gt;numclasses]);</span>
<span class="lineNum">    1064 </span><span class="lineCov">          1 :       nClassId = psLayer-&gt;numclasses;</span>
<span class="lineNum">    1065 </span><span class="lineCov">          1 :       if( pszUserStyleName )</span>
<span class="lineNum">    1066 </span><span class="lineCov">          1 :         psLayer-&gt;class[nClassId]-&gt;group = msStrdup(pszUserStyleName);</span>
<span class="lineNum">    1067 </span><span class="lineCov">          1 :       psLayer-&gt;numclasses++;</span>
<span class="lineNum">    1068 </span>            :     } else {
<span class="lineNum">    1069 </span><span class="lineCov">          1 :       nClassId = psLayer-&gt;numclasses-1;</span>
<span class="lineNum">    1070 </span>            :     }
<span class="lineNum">    1071 </span>            :     return nClassId;
<span class="lineNum">    1072 </span>            : }
<span class="lineNum">    1073 </span>            : 
<span class="lineNum">    1074 </span>            : /************************************************************************/
<span class="lineNum">    1075 </span>            : /*                      msSLDParseUomAttribute()                        */
<a name="1076"><span class="lineNum">    1076 </span>            : /************************************************************************/</a>
<span class="lineNum">    1077 </span>            : 
<span class="lineNum">    1078 </span><span class="lineCov">          1 : int msSLDParseUomAttribute(CPLXMLNode *node, enum MS_UNITS * sizeunits)</span>
<span class="lineNum">    1079 </span>            : {
<span class="lineNum">    1080 </span>            :   const struct
<span class="lineNum">    1081 </span>            :   {
<span class="lineNum">    1082 </span>            :     enum MS_UNITS unit;
<span class="lineNum">    1083 </span>            :     char * values[10];
<span class="lineNum">    1084 </span><span class="lineCov">          1 :   } known_uoms[] =</span>
<span class="lineNum">    1085 </span>            :   {
<span class="lineNum">    1086 </span>            :     { MS_INCHES, { &quot;inch&quot;, &quot;inches&quot;, NULL } },
<span class="lineNum">    1087 </span>            :     { MS_FEET, { &quot;foot&quot;, &quot;feet&quot;, &quot;http://www.opengeospatial.org/se/units/foot&quot;, NULL } },
<span class="lineNum">    1088 </span>            :     { MS_MILES, { &quot;mile&quot;, &quot;miles&quot;, NULL } },
<span class="lineNum">    1089 </span>            :     { MS_METERS, { &quot;meter&quot;, &quot;meters&quot;, &quot;metre&quot;, &quot;metres&quot;, &quot;http://www.opengeospatial.org/se/units/metre&quot;, NULL } },
<span class="lineNum">    1090 </span>            :     { MS_KILOMETERS, { &quot;kilometer&quot;, &quot;kilometers&quot;, &quot;kilometre&quot;, &quot;kilometres&quot;, NULL } },
<span class="lineNum">    1091 </span>            :     { MS_DD, { &quot;dd&quot;, NULL } },
<span class="lineNum">    1092 </span>            :     { MS_PIXELS, { &quot;pixel&quot;, &quot;pixels&quot;, &quot;px&quot;, &quot;http://www.opengeospatial.org/se/units/pixel&quot;, NULL } },
<span class="lineNum">    1093 </span>            :     { MS_PERCENTAGES, { &quot;percent&quot;, &quot;percents&quot;, &quot;percentage&quot;, &quot;percentages&quot;, NULL } },
<span class="lineNum">    1094 </span>            :     { MS_NAUTICALMILES, { &quot;nauticalmile&quot;, &quot;nauticalmiles&quot;, &quot;nautical_mile&quot;, &quot;nautical_miles&quot;, NULL } },
<span class="lineNum">    1095 </span>            :     { 0, { NULL } }
<span class="lineNum">    1096 </span>            :   };
<span class="lineNum">    1097 </span>            : 
<span class="lineNum">    1098 </span><span class="lineCov">          1 :   const char * uom = CPLGetXMLValue(node, &quot;uom&quot;, NULL);</span>
<span class="lineNum">    1099 </span><span class="lineCov">          1 :   if (uom)</span>
<span class="lineNum">    1100 </span>            :   {
<span class="lineNum">    1101 </span><span class="lineCov">          1 :     for (int i=0 ; known_uoms[i].values[0] ; i++)</span>
<span class="lineNum">    1102 </span><span class="lineCov">          1 :       for (int j=0 ; known_uoms[i].values[j] ; j++)</span>
<span class="lineNum">    1103 </span><span class="lineCov">          1 :         if (strcmp(uom,known_uoms[i].values[j]) == 0)</span>
<span class="lineNum">    1104 </span>            :         {
<span class="lineNum">    1105 </span>            :           // Match found
<span class="lineNum">    1106 </span><span class="lineCov">          1 :           *sizeunits = known_uoms[i].unit;</span>
<span class="lineNum">    1107 </span><span class="lineCov">          1 :           return MS_SUCCESS;</span>
<span class="lineNum">    1108 </span>            :         }
<span class="lineNum">    1109 </span>            :     // No match was found
<span class="lineNum">    1110 </span>            :     return MS_FAILURE;
<span class="lineNum">    1111 </span>            :   }
<span class="lineNum">    1112 </span>            :   // No uom was found
<span class="lineNum">    1113 </span><span class="lineCov">          1 :   *sizeunits = MS_PIXELS;</span>
<span class="lineNum">    1114 </span><span class="lineCov">          1 :   return MS_SUCCESS;</span>
<span class="lineNum">    1115 </span>            : }
<span class="lineNum">    1116 </span>            : 
<span class="lineNum">    1117 </span>            : 
<span class="lineNum">    1118 </span>            : /************************************************************************/
<span class="lineNum">    1119 </span>            : /*                 msSLDParseLineSymbolizer()                           */
<span class="lineNum">    1120 </span>            : /*                                                                      */
<span class="lineNum">    1121 </span>            : /*      Parses the LineSymbolizer rule and creates a class in the       */
<span class="lineNum">    1122 </span>            : /*      layer.                                                          */
<span class="lineNum">    1123 </span>            : /*                                                                      */
<span class="lineNum">    1124 </span>            : /*      &lt;xs:element name=&quot;LineSymbolizer&quot;&gt;                              */
<span class="lineNum">    1125 </span>            : /*      &lt;xs:complexType&gt;                                                */
<span class="lineNum">    1126 </span>            : /*      &lt;xs:sequence&gt;                                                   */
<span class="lineNum">    1127 </span>            : /*      &lt;xs:element ref=&quot;sld:Geometry&quot; minOccurs=&quot;0&quot;/&gt;                  */
<span class="lineNum">    1128 </span>            : /*      &lt;xs:element ref=&quot;sld:Stroke&quot; minOccurs=&quot;0&quot;/&gt;                    */
<span class="lineNum">    1129 </span>            : /*      &lt;/xs:sequence&gt;                                                  */
<span class="lineNum">    1130 </span>            : /*      &lt;/xs:complexType&gt;                                               */
<span class="lineNum">    1131 </span>            : /*      &lt;/xs:element&gt;                                                   */
<span class="lineNum">    1132 </span>            : /*                                                                      */
<span class="lineNum">    1133 </span>            : /*      &lt;xs:element name=&quot;Stroke&quot;&gt;                                      */
<span class="lineNum">    1134 </span>            : /*      &lt;xs:complexType&gt;                                                */
<span class="lineNum">    1135 </span>            : /*      &lt;xs:sequence&gt;                                                   */
<span class="lineNum">    1136 </span>            : /*      &lt;xs:choice minOccurs=&quot;0&quot;&gt;                                       */
<span class="lineNum">    1137 </span>            : /*      &lt;xs:element ref=&quot;sld:GraphicFill&quot;/&gt;                             */
<span class="lineNum">    1138 </span>            : /*      &lt;xs:element ref=&quot;sld:GraphicStroke&quot;/&gt;                           */
<span class="lineNum">    1139 </span>            : /*      &lt;/xs:choice&gt;                                                    */
<span class="lineNum">    1140 </span>            : /*      &lt;xs:element ref=&quot;sld:CssParameter&quot; minOccurs=&quot;0&quot;                */
<span class="lineNum">    1141 </span>            : /*      maxOccurs=&quot;unbounded&quot;/&gt;                                         */
<span class="lineNum">    1142 </span>            : /*      &lt;/xs:sequence&gt;                                                  */
<span class="lineNum">    1143 </span>            : /*      &lt;/xs:complexType&gt;                                               */
<span class="lineNum">    1144 </span>            : /*      &lt;/xs:element&gt;                                                   */
<span class="lineNum">    1145 </span>            : /*                                                                      */
<span class="lineNum">    1146 </span>            : /*      Example of a rule :                                             */
<span class="lineNum">    1147 </span>            : /*      ...                                                             */
<span class="lineNum">    1148 </span>            : /*      &lt;Rule&gt;                                                          */
<span class="lineNum">    1149 </span>            : /*      &lt;LineSymbolizer&gt;                                                */
<span class="lineNum">    1150 </span>            : /*      &lt;Geometry&gt;                                                      */
<span class="lineNum">    1151 </span>            : /*      &lt;ogc:PropertyName&gt;center-line&lt;/ogc:PropertyName&gt;                */
<span class="lineNum">    1152 </span>            : /*      &lt;/Geometry&gt;                                                     */
<span class="lineNum">    1153 </span>            : /*      &lt;Stroke&gt;                                                        */
<span class="lineNum">    1154 </span>            : /*      &lt;CssParameter name=&quot;stroke&quot;&gt;#0000ff&lt;/CssParameter&gt;              */
<span class="lineNum">    1155 </span>            : /*      &lt;CssParameter name=&quot;stroke-width&quot;&gt;5.0&lt;/CssParameter&gt;            */
<span class="lineNum">    1156 </span>            : /*      &lt;CssParameter name=&quot;stroke-dasharray&quot;&gt;10.0 5 5 10&lt;/CssParameter&gt;*/
<span class="lineNum">    1157 </span>            : /*      &lt;/Stroke&gt;                                                       */
<span class="lineNum">    1158 </span>            : /*      &lt;/LineSymbolizer&gt;                                               */
<span class="lineNum">    1159 </span>            : /*      &lt;/Rule&gt;                                                         */
<a name="1160"><span class="lineNum">    1160 </span>            : /*       ...                                                            */</a>
<span class="lineNum">    1161 </span>            : /************************************************************************/
<span class="lineNum">    1162 </span><span class="lineCov">          1 : int msSLDParseLineSymbolizer(CPLXMLNode *psRoot, layerObj *psLayer,</span>
<span class="lineNum">    1163 </span>            :                              int bNewClass, const char* pszUserStyleName)
<span class="lineNum">    1164 </span>            : {
<span class="lineNum">    1165 </span>            :   CPLXMLNode *psStroke=NULL, *psOffset=NULL;
<span class="lineNum">    1166 </span>            :   int iStyle = 0;
<span class="lineNum">    1167 </span>            : 
<span class="lineNum">    1168 </span><span class="lineCov">          1 :   if (!psRoot || !psLayer)</span>
<span class="lineNum">    1169 </span>            :     return MS_FAILURE;
<span class="lineNum">    1170 </span>            : 
<span class="lineNum">    1171 </span>            :   // Get uom if any, defaults to MS_PIXELS
<span class="lineNum">    1172 </span><span class="lineCov">          1 :   enum MS_UNITS sizeunits = MS_PIXELS;</span>
<span class="lineNum">    1173 </span><span class="lineCov">          1 :   if (msSLDParseUomAttribute(psRoot, &amp;sizeunits) != MS_SUCCESS)</span>
<span class="lineNum">    1174 </span>            :   {
<span class="lineNum">    1175 </span><span class="lineNoCov">          0 :     msSetError(MS_WMSERR, &quot;Invalid uom attribute value.&quot;, &quot;msSLDParsePolygonSymbolizer()&quot;);</span>
<span class="lineNum">    1176 </span><span class="lineNoCov">          0 :     return MS_FAILURE;</span>
<span class="lineNum">    1177 </span>            :   }
<span class="lineNum">    1178 </span>            : 
<span class="lineNum">    1179 </span><span class="lineCov">          1 :   psStroke =  CPLGetXMLNode(psRoot, &quot;Stroke&quot;);</span>
<span class="lineNum">    1180 </span><span class="lineCov">          1 :   if (psStroke) {</span>
<span class="lineNum">    1181 </span><span class="lineCov">          1 :     int nClassId = getClassId(psLayer, bNewClass, pszUserStyleName);</span>
<span class="lineNum">    1182 </span><span class="lineCov">          1 :     if( nClassId &lt; 0 )</span>
<span class="lineNum">    1183 </span>            :         return MS_FAILURE;
<span class="lineNum">    1184 </span>            : 
<span class="lineNum">    1185 </span><span class="lineCov">          1 :     iStyle = psLayer-&gt;class[nClassId]-&gt;numstyles;</span>
<span class="lineNum">    1186 </span><span class="lineCov">          1 :     msMaybeAllocateClassStyle(psLayer-&gt;class[nClassId], iStyle);</span>
<span class="lineNum">    1187 </span><span class="lineCov">          1 :     psLayer-&gt;class[nClassId]-&gt;styles[iStyle]-&gt;sizeunits = sizeunits;</span>
<span class="lineNum">    1188 </span>            : 
<span class="lineNum">    1189 </span><span class="lineCov">          1 :     msSLDParseStroke(psStroke, psLayer-&gt;class[nClassId]-&gt;styles[iStyle],</span>
<span class="lineNum">    1190 </span><span class="lineCov">          1 :                      psLayer-&gt;map, 0);</span>
<span class="lineNum">    1191 </span>            : 
<span class="lineNum">    1192 </span>            :     /*parse PerpendicularOffset SLD 1.1.10*/
<span class="lineNum">    1193 </span><span class="lineCov">          1 :     psOffset = CPLGetXMLNode(psRoot, &quot;PerpendicularOffset&quot;);</span>
<span class="lineNum">    1194 </span><span class="lineCov">          1 :     if (psOffset &amp;&amp; psOffset-&gt;psChild &amp;&amp; psOffset-&gt;psChild-&gt;pszValue) {</span>
<span class="lineNum">    1195 </span><span class="lineNoCov">          0 :       psLayer-&gt;class[nClassId]-&gt;styles[iStyle]-&gt;offsetx = atoi(psOffset-&gt;psChild-&gt;pszValue);</span>
<span class="lineNum">    1196 </span><span class="lineNoCov">          0 :       psLayer-&gt;class[nClassId]-&gt;styles[iStyle]-&gt;offsety = MS_STYLE_SINGLE_SIDED_OFFSET;</span>
<span class="lineNum">    1197 </span>            :     }
<span class="lineNum">    1198 </span>            :   }
<span class="lineNum">    1199 </span>            : 
<span class="lineNum">    1200 </span>            :   return MS_SUCCESS;
<span class="lineNum">    1201 </span>            : }
<span class="lineNum">    1202 </span>            : 
<span class="lineNum">    1203 </span>            : 
<span class="lineNum">    1204 </span>            : 
<span class="lineNum">    1205 </span>            : /************************************************************************/
<span class="lineNum">    1206 </span>            : /*           void msSLDParseStroke(CPLXMLNode *psStroke, styleObj       */
<span class="lineNum">    1207 </span>            : /*      *psStyle, int iColorParam)                                      */
<span class="lineNum">    1208 </span>            : /*                                                                      */
<span class="lineNum">    1209 </span>            : /*      Parse Stroke content into a style object.                       */
<span class="lineNum">    1210 </span>            : /*      The iColorParm is used to indicate which color object to use    */
<span class="lineNum">    1211 </span>            : /*      :                                                               */
<span class="lineNum">    1212 </span>            : /*        0 : for color                                                 */
<a name="1213"><span class="lineNum">    1213 </span>            : /*        1 : outlinecolor                                              */</a>
<span class="lineNum">    1214 </span>            : /************************************************************************/
<span class="lineNum">    1215 </span><span class="lineCov">          1 : int msSLDParseStroke(CPLXMLNode *psStroke, styleObj *psStyle,</span>
<span class="lineNum">    1216 </span>            :                      mapObj *map, int iColorParam)
<span class="lineNum">    1217 </span>            : {
<span class="lineNum">    1218 </span>            :   CPLXMLNode *psCssParam = NULL, *psGraphicFill=NULL;
<span class="lineNum">    1219 </span>            :   char *psStrkName = NULL;
<span class="lineNum">    1220 </span>            :   char *pszDashValue = NULL;
<span class="lineNum">    1221 </span>            : 
<span class="lineNum">    1222 </span><span class="lineCov">          1 :   if (!psStroke || !psStyle)</span>
<span class="lineNum">    1223 </span>            :     return MS_FAILURE;
<span class="lineNum">    1224 </span>            : 
<span class="lineNum">    1225 </span>            :   /* parse css parameters */
<span class="lineNum">    1226 </span><span class="lineCov">          1 :   psCssParam =  CPLGetXMLNode(psStroke, &quot;CssParameter&quot;);</span>
<span class="lineNum">    1227 </span>            :   /*sld 1.1 used SvgParameter*/
<span class="lineNum">    1228 </span><span class="lineCov">          1 :   if (psCssParam == NULL)</span>
<span class="lineNum">    1229 </span><span class="lineCov">          1 :     psCssParam =  CPLGetXMLNode(psStroke, &quot;SvgParameter&quot;);</span>
<span class="lineNum">    1230 </span>            : 
<span class="lineNum">    1231 </span><span class="lineCov">          1 :   while (psCssParam &amp;&amp; psCssParam-&gt;pszValue &amp;&amp;</span>
<span class="lineNum">    1232 </span><span class="lineCov">          1 :          (strcasecmp(psCssParam-&gt;pszValue, &quot;CssParameter&quot;) == 0 ||</span>
<span class="lineNum">    1233 </span><span class="lineCov">          1 :           strcasecmp(psCssParam-&gt;pszValue, &quot;SvgParameter&quot;) == 0)) {</span>
<span class="lineNum">    1234 </span><span class="lineCov">          1 :     psStrkName = (char*)CPLGetXMLValue(psCssParam, &quot;name&quot;, NULL);</span>
<span class="lineNum">    1235 </span>            : 
<span class="lineNum">    1236 </span><span class="lineCov">          1 :     if (psStrkName) {</span>
<span class="lineNum">    1237 </span><span class="lineCov">          1 :       if (strcasecmp(psStrkName, &quot;stroke&quot;) == 0) {</span>
<span class="lineNum">    1238 </span><span class="lineCov">          1 :         if(psCssParam-&gt;psChild &amp;&amp; psCssParam-&gt;psChild-&gt;psNext)</span>
<span class="lineNum">    1239 </span>            :         {
<span class="lineNum">    1240 </span><span class="lineCov">          1 :           switch (iColorParam) {</span>
<span class="lineNum">    1241 </span><span class="lineCov">          1 :             case 0:</span>
<span class="lineNum">    1242 </span><span class="lineCov">          1 :               msSLDParseOgcExpression(psCssParam-&gt;psChild-&gt;psNext,</span>
<span class="lineNum">    1243 </span>            :                   psStyle, MS_STYLE_BINDING_COLOR, MS_OBJ_STYLE);
<span class="lineNum">    1244 </span><span class="lineCov">          1 :               break;</span>
<span class="lineNum">    1245 </span><span class="lineCov">          1 :             case 1:</span>
<span class="lineNum">    1246 </span><span class="lineCov">          1 :               msSLDParseOgcExpression(psCssParam-&gt;psChild-&gt;psNext,</span>
<span class="lineNum">    1247 </span>            :                   psStyle, MS_STYLE_BINDING_OUTLINECOLOR, MS_OBJ_STYLE);
<span class="lineNum">    1248 </span><span class="lineCov">          1 :               break;</span>
<span class="lineNum">    1249 </span>            :           }
<span class="lineNum">    1250 </span>            :         }
<span class="lineNum">    1251 </span><span class="lineCov">          1 :       } else if (strcasecmp(psStrkName, &quot;stroke-width&quot;) == 0) {</span>
<span class="lineNum">    1252 </span><span class="lineCov">          1 :         if(psCssParam-&gt;psChild &amp;&amp;  psCssParam-&gt;psChild-&gt;psNext)</span>
<span class="lineNum">    1253 </span>            :         {
<span class="lineNum">    1254 </span><span class="lineCov">          1 :           msSLDParseOgcExpression(psCssParam-&gt;psChild-&gt;psNext, psStyle,</span>
<span class="lineNum">    1255 </span>            :                                   MS_STYLE_BINDING_WIDTH, MS_OBJ_STYLE);
<span class="lineNum">    1256 </span>            :         }
<span class="lineNum">    1257 </span><span class="lineCov">          1 :       } else if (strcasecmp(psStrkName, &quot;stroke-dasharray&quot;) == 0) {</span>
<span class="lineNum">    1258 </span><span class="lineCov">          1 :         if(psCssParam-&gt;psChild &amp;&amp; psCssParam-&gt;psChild-&gt;psNext &amp;&amp;</span>
<span class="lineNum">    1259 </span><span class="lineCov">          1 :             psCssParam-&gt;psChild-&gt;psNext-&gt;pszValue) {</span>
<span class="lineNum">    1260 </span><span class="lineCov">          1 :           int nDash = 0, i;</span>
<span class="lineNum">    1261 </span>            :           char **aszValues = NULL;
<span class="lineNum">    1262 </span>            :           int nMaxDash;
<span class="lineNum">    1263 </span><span class="lineCov">          1 :           if(pszDashValue) free(pszDashValue); /* free previous if multiple stroke-dasharray attributes were found */</span>
<span class="lineNum">    1264 </span><span class="lineCov">          1 :           pszDashValue =</span>
<span class="lineNum">    1265 </span><span class="lineCov">          1 :             msStrdup(psCssParam-&gt;psChild-&gt;psNext-&gt;pszValue);</span>
<span class="lineNum">    1266 </span><span class="lineCov">          1 :           aszValues = msStringSplit(pszDashValue, ' ', &amp;nDash);</span>
<span class="lineNum">    1267 </span><span class="lineCov">          1 :           if (nDash &gt; 0) {</span>
<span class="lineNum">    1268 </span>            :             nMaxDash = nDash;
<span class="lineNum">    1269 </span><span class="lineCov">          1 :             if (nDash &gt; MS_MAXPATTERNLENGTH)</span>
<span class="lineNum">    1270 </span>            :               nMaxDash =  MS_MAXPATTERNLENGTH;
<span class="lineNum">    1271 </span>            : 
<span class="lineNum">    1272 </span><span class="lineCov">          1 :             psStyle-&gt;patternlength = nMaxDash;</span>
<span class="lineNum">    1273 </span><span class="lineCov">          1 :             for (i=0; i&lt;nMaxDash; i++)</span>
<span class="lineNum">    1274 </span><span class="lineCov">          1 :               psStyle-&gt;pattern[i] = atof(aszValues[i]);</span>
<span class="lineNum">    1275 </span>            : 
<span class="lineNum">    1276 </span><span class="lineCov">          1 :             psStyle-&gt;linecap = MS_CJC_BUTT;</span>
<span class="lineNum">    1277 </span>            :           }
<span class="lineNum">    1278 </span><span class="lineCov">          1 :           msFreeCharArray(aszValues, nDash);</span>
<span class="lineNum">    1279 </span>            :         }
<span class="lineNum">    1280 </span><span class="lineCov">          1 :       } else if (strcasecmp(psStrkName, &quot;stroke-opacity&quot;) == 0) {</span>
<span class="lineNum">    1281 </span><span class="lineCov">          1 :         if(psCssParam-&gt;psChild &amp;&amp;  psCssParam-&gt;psChild-&gt;psNext)</span>
<span class="lineNum">    1282 </span>            :         {
<span class="lineNum">    1283 </span><span class="lineCov">          1 :           msSLDParseOgcExpression(psCssParam-&gt;psChild-&gt;psNext,</span>
<span class="lineNum">    1284 </span>            :               psStyle, MS_STYLE_BINDING_OPACITY, MS_OBJ_STYLE);
<span class="lineNum">    1285 </span>            :         }
<span class="lineNum">    1286 </span>            :       }
<span class="lineNum">    1287 </span>            :     }
<span class="lineNum">    1288 </span><span class="lineCov">          1 :     psCssParam = psCssParam-&gt;psNext;</span>
<span class="lineNum">    1289 </span>            :   }
<span class="lineNum">    1290 </span>            : 
<span class="lineNum">    1291 </span>            :   /* parse graphic fill or stroke */
<span class="lineNum">    1292 </span>            :   /* graphic fill and graphic stroke pare parsed the same way :  */
<span class="lineNum">    1293 </span>            :   /* TODO : It seems inconsistent to me since the only difference */
<span class="lineNum">    1294 </span>            :   /* between them seems to be fill (fill) or not fill (stroke). And */
<span class="lineNum">    1295 </span>            :   /* then again the fill parameter can be used inside both elements. */
<span class="lineNum">    1296 </span><span class="lineCov">          1 :   psGraphicFill =  CPLGetXMLNode(psStroke, &quot;GraphicFill&quot;);</span>
<span class="lineNum">    1297 </span><span class="lineCov">          1 :   if (psGraphicFill)</span>
<span class="lineNum">    1298 </span><span class="lineNoCov">          0 :     msSLDParseGraphicFillOrStroke(psGraphicFill, pszDashValue, psStyle, map);</span>
<span class="lineNum">    1299 </span><span class="lineCov">          1 :   psGraphicFill =  CPLGetXMLNode(psStroke, &quot;GraphicStroke&quot;);</span>
<span class="lineNum">    1300 </span><span class="lineCov">          1 :   if (psGraphicFill)</span>
<span class="lineNum">    1301 </span><span class="lineCov">          1 :     msSLDParseGraphicFillOrStroke(psGraphicFill, pszDashValue, psStyle, map);</span>
<span class="lineNum">    1302 </span>            : 
<span class="lineNum">    1303 </span><span class="lineCov">          1 :   if (pszDashValue)</span>
<span class="lineNum">    1304 </span><span class="lineCov">          1 :     free(pszDashValue);</span>
<span class="lineNum">    1305 </span>            : 
<span class="lineNum">    1306 </span>            :   return MS_SUCCESS;
<span class="lineNum">    1307 </span>            : }
<span class="lineNum">    1308 </span>            : 
<span class="lineNum">    1309 </span>            : 
<span class="lineNum">    1310 </span>            : 
<span class="lineNum">    1311 </span>            : /************************************************************************/
<span class="lineNum">    1312 </span>            : /*  int msSLDParseOgcExpression(CPLXMLNode *psRoot, styleObj *psStyle,  */
<span class="lineNum">    1313 </span>            : /*                              enum MS_STYLE_BINDING_ENUM binding)     */
<span class="lineNum">    1314 </span>            : /*                                                                      */
<a name="1315"><span class="lineNum">    1315 </span>            : /*              Parse an OGC expression in a &lt;SvgParameter&gt;             */</a>
<span class="lineNum">    1316 </span>            : /************************************************************************/
<span class="lineNum">    1317 </span><span class="lineCov">          1 : int msSLDParseOgcExpression(CPLXMLNode *psRoot, void *psObj, int binding,</span>
<span class="lineNum">    1318 </span>            :                             enum objType objtype)
<span class="lineNum">    1319 </span>            : {
<span class="lineNum">    1320 </span>            :   int status = MS_FAILURE;
<span class="lineNum">    1321 </span>            :   const char * ops = &quot;Add+Sub-Mul*Div/&quot;;
<span class="lineNum">    1322 </span>            :   styleObj * psStyle = psObj;
<span class="lineNum">    1323 </span>            :   labelObj * psLabel = psObj;
<span class="lineNum">    1324 </span>            :   int lbinding;
<span class="lineNum">    1325 </span>            :   expressionObj *exprBindings;
<span class="lineNum">    1326 </span>            :   int *nexprbindings;
<span class="lineNum">    1327 </span>            :   enum { MS_STYLE_BASE = 0, MS_LABEL_BASE = 100 };
<span class="lineNum">    1328 </span>            : 
<span class="lineNum">    1329 </span><span class="lineCov">          1 :   switch (objtype)</span>
<span class="lineNum">    1330 </span>            :   {
<span class="lineNum">    1331 </span><span class="lineCov">          1 :     case MS_OBJ_STYLE:</span>
<span class="lineNum">    1332 </span>            :       lbinding = binding + MS_STYLE_BASE;
<span class="lineNum">    1333 </span><span class="lineCov">          1 :       exprBindings = psStyle-&gt;exprBindings;</span>
<span class="lineNum">    1334 </span><span class="lineCov">          1 :       nexprbindings = &amp;psStyle-&gt;nexprbindings;</span>
<span class="lineNum">    1335 </span><span class="lineCov">          1 :       break;</span>
<span class="lineNum">    1336 </span><span class="lineCov">          1 :     case MS_OBJ_LABEL:</span>
<span class="lineNum">    1337 </span><span class="lineCov">          1 :       lbinding = binding + MS_LABEL_BASE;</span>
<span class="lineNum">    1338 </span><span class="lineCov">          1 :       exprBindings = psLabel-&gt;exprBindings;</span>
<span class="lineNum">    1339 </span><span class="lineCov">          1 :       nexprbindings = &amp;psLabel-&gt;nexprbindings;</span>
<span class="lineNum">    1340 </span><span class="lineCov">          1 :       break;</span>
<span class="lineNum">    1341 </span>            :     default:
<span class="lineNum">    1342 </span>            :       return MS_FAILURE;
<span class="lineNum">    1343 </span>            :       break;
<span class="lineNum">    1344 </span>            :   }
<span class="lineNum">    1345 </span>            : 
<span class="lineNum">    1346 </span><span class="lineCov">          1 :   switch (psRoot-&gt;eType)</span>
<span class="lineNum">    1347 </span>            :   {
<span class="lineNum">    1348 </span><span class="lineCov">          1 :     case CXT_Text:</span>
<span class="lineNum">    1349 </span>            :       // Parse a raw value
<span class="lineNum">    1350 </span>            :       {
<span class="lineNum">    1351 </span><span class="lineCov">          1 :         msStringBuffer * literal = msStringBufferAlloc();</span>
<span class="lineNum">    1352 </span><span class="lineCov">          1 :         msStringBufferAppend(literal, &quot;(&quot;);</span>
<span class="lineNum">    1353 </span><span class="lineCov">          1 :         msStringBufferAppend(literal, psRoot-&gt;pszValue);</span>
<span class="lineNum">    1354 </span><span class="lineCov">          1 :         msStringBufferAppend(literal, &quot;)&quot;);</span>
<span class="lineNum">    1355 </span><span class="lineCov">          1 :         msFreeExpression(&amp;(exprBindings[binding]));</span>
<span class="lineNum">    1356 </span><span class="lineCov">          1 :         msInitExpression(&amp;(exprBindings[binding]));</span>
<span class="lineNum">    1357 </span><span class="lineCov">          1 :         exprBindings[binding].string =</span>
<span class="lineNum">    1358 </span><span class="lineCov">          1 :             msStringBufferReleaseStringAndFree(literal);</span>
<span class="lineNum">    1359 </span><span class="lineCov">          1 :         exprBindings[binding].type = MS_STRING;</span>
<span class="lineNum">    1360 </span>            :       }
<span class="lineNum">    1361 </span><span class="lineCov">          1 :       switch (lbinding)</span>
<span class="lineNum">    1362 </span>            :       {
<span class="lineNum">    1363 </span><span class="lineCov">          1 :         case MS_STYLE_BASE + MS_STYLE_BINDING_OFFSET_X:</span>
<span class="lineNum">    1364 </span><span class="lineCov">          1 :           psStyle-&gt;offsetx = atoi(psRoot-&gt;pszValue);</span>
<span class="lineNum">    1365 </span>            :           status = MS_SUCCESS;
<span class="lineNum">    1366 </span><span class="lineCov">          1 :           break;</span>
<span class="lineNum">    1367 </span><span class="lineCov">          1 :         case MS_STYLE_BASE + MS_STYLE_BINDING_OFFSET_Y:</span>
<span class="lineNum">    1368 </span><span class="lineCov">          1 :           psStyle-&gt;offsety = atoi(psRoot-&gt;pszValue);</span>
<span class="lineNum">    1369 </span>            :           status = MS_SUCCESS;
<span class="lineNum">    1370 </span><span class="lineCov">          1 :           break;</span>
<span class="lineNum">    1371 </span><span class="lineCov">          1 :         case MS_STYLE_BASE + MS_STYLE_BINDING_ANGLE:</span>
<span class="lineNum">    1372 </span><span class="lineCov">          1 :           psStyle-&gt;angle = atof(psRoot-&gt;pszValue);</span>
<span class="lineNum">    1373 </span>            :           status = MS_SUCCESS;
<span class="lineNum">    1374 </span><span class="lineCov">          1 :           break;</span>
<span class="lineNum">    1375 </span><span class="lineCov">          1 :         case MS_STYLE_BASE + MS_STYLE_BINDING_SIZE:</span>
<span class="lineNum">    1376 </span><span class="lineCov">          1 :           psStyle-&gt;size = atof(psRoot-&gt;pszValue);</span>
<span class="lineNum">    1377 </span>            :           status = MS_SUCCESS;
<span class="lineNum">    1378 </span><span class="lineCov">          1 :           break;</span>
<span class="lineNum">    1379 </span><span class="lineCov">          1 :         case MS_STYLE_BASE + MS_STYLE_BINDING_WIDTH:</span>
<span class="lineNum">    1380 </span><span class="lineCov">          1 :           psStyle-&gt;width = atof(psRoot-&gt;pszValue);</span>
<span class="lineNum">    1381 </span>            :           status = MS_SUCCESS;
<span class="lineNum">    1382 </span><span class="lineCov">          1 :           break;</span>
<span class="lineNum">    1383 </span><span class="lineCov">          1 :         case MS_STYLE_BASE + MS_STYLE_BINDING_OPACITY:</span>
<span class="lineNum">    1384 </span><span class="lineCov">          1 :           psStyle-&gt;opacity = atof(psRoot-&gt;pszValue)*100;</span>
<span class="lineNum">    1385 </span>            :           status = MS_SUCCESS;
<span class="lineNum">    1386 </span>            :           // Apply opacity as the alpha channel color(s)
<span class="lineNum">    1387 </span><span class="lineCov">          1 :           if(psStyle-&gt;opacity &lt; 100)</span>
<span class="lineNum">    1388 </span>            :           {
<span class="lineNum">    1389 </span><span class="lineCov">          1 :             int alpha = MS_NINT(psStyle-&gt;opacity*2.55);</span>
<span class="lineNum">    1390 </span><span class="lineCov">          1 :             psStyle-&gt;color.alpha = alpha;</span>
<span class="lineNum">    1391 </span><span class="lineCov">          1 :             psStyle-&gt;outlinecolor.alpha = alpha;</span>
<span class="lineNum">    1392 </span><span class="lineCov">          1 :             psStyle-&gt;backgroundcolor.alpha = alpha;</span>
<span class="lineNum">    1393 </span><span class="lineCov">          1 :             psStyle-&gt;mincolor.alpha = alpha;</span>
<span class="lineNum">    1394 </span><span class="lineCov">          1 :             psStyle-&gt;maxcolor.alpha = alpha;</span>
<span class="lineNum">    1395 </span>            :           }
<span class="lineNum">    1396 </span>            :           break;
<span class="lineNum">    1397 </span><span class="lineCov">          1 :         case MS_STYLE_BASE + MS_STYLE_BINDING_COLOR:</span>
<span class="lineNum">    1398 </span><span class="lineCov">          1 :           if (strlen(psRoot-&gt;pszValue) == 7 &amp;&amp; psRoot-&gt;pszValue[0] == '#')</span>
<span class="lineNum">    1399 </span>            :           {
<span class="lineNum">    1400 </span><span class="lineCov">          1 :             psStyle-&gt;color.red = msHexToInt(psRoot-&gt;pszValue+1);</span>
<span class="lineNum">    1401 </span><span class="lineCov">          1 :             psStyle-&gt;color.green = msHexToInt(psRoot-&gt;pszValue+3);</span>
<span class="lineNum">    1402 </span><span class="lineCov">          1 :             psStyle-&gt;color.blue = msHexToInt(psRoot-&gt;pszValue+5);</span>
<span class="lineNum">    1403 </span>            :             status = MS_SUCCESS;
<span class="lineNum">    1404 </span>            :           }
<span class="lineNum">    1405 </span>            :           break;
<span class="lineNum">    1406 </span><span class="lineCov">          1 :         case MS_STYLE_BASE + MS_STYLE_BINDING_OUTLINECOLOR:</span>
<span class="lineNum">    1407 </span><span class="lineCov">          1 :           if (strlen(psRoot-&gt;pszValue) == 7 &amp;&amp; psRoot-&gt;pszValue[0] == '#')</span>
<span class="lineNum">    1408 </span>            :           {
<span class="lineNum">    1409 </span><span class="lineCov">          1 :             psStyle-&gt;outlinecolor.red = msHexToInt(psRoot-&gt;pszValue+1);</span>
<span class="lineNum">    1410 </span><span class="lineCov">          1 :             psStyle-&gt;outlinecolor.green = msHexToInt(psRoot-&gt;pszValue+3);</span>
<span class="lineNum">    1411 </span><span class="lineCov">          1 :             psStyle-&gt;outlinecolor.blue = msHexToInt(psRoot-&gt;pszValue+5);</span>
<span class="lineNum">    1412 </span>            :             status = MS_SUCCESS;
<span class="lineNum">    1413 </span>            :           }
<span class="lineNum">    1414 </span>            :           break;
<span class="lineNum">    1415 </span>            : 
<span class="lineNum">    1416 </span><span class="lineCov">          1 :         case MS_LABEL_BASE + MS_LABEL_BINDING_SIZE:</span>
<span class="lineNum">    1417 </span><span class="lineCov">          1 :           psLabel-&gt;size = atof(psRoot-&gt;pszValue);</span>
<span class="lineNum">    1418 </span><span class="lineCov">          1 :           if (psLabel-&gt;size &lt;= 0.0)</span>
<span class="lineNum">    1419 </span>            :           {
<span class="lineNum">    1420 </span><span class="lineNoCov">          0 :             psLabel-&gt;size = 10.0;</span>
<span class="lineNum">    1421 </span>            :           }
<span class="lineNum">    1422 </span>            :           status = MS_SUCCESS;
<span class="lineNum">    1423 </span>            :           break;
<span class="lineNum">    1424 </span><span class="lineCov">          1 :         case MS_LABEL_BASE + MS_LABEL_BINDING_ANGLE:</span>
<span class="lineNum">    1425 </span><span class="lineCov">          1 :           psLabel-&gt;angle = atof(psRoot-&gt;pszValue);</span>
<span class="lineNum">    1426 </span>            :           status = MS_SUCCESS;
<span class="lineNum">    1427 </span><span class="lineCov">          1 :           break;</span>
<span class="lineNum">    1428 </span><span class="lineCov">          1 :         case MS_LABEL_BASE + MS_LABEL_BINDING_COLOR:</span>
<span class="lineNum">    1429 </span><span class="lineCov">          1 :           if (strlen(psRoot-&gt;pszValue) == 7 &amp;&amp; psRoot-&gt;pszValue[0] == '#')</span>
<span class="lineNum">    1430 </span>            :           {
<span class="lineNum">    1431 </span><span class="lineCov">          1 :             psLabel-&gt;color.red = msHexToInt(psRoot-&gt;pszValue+1);</span>
<span class="lineNum">    1432 </span><span class="lineCov">          1 :             psLabel-&gt;color.green = msHexToInt(psRoot-&gt;pszValue+3);</span>
<span class="lineNum">    1433 </span><span class="lineCov">          1 :             psLabel-&gt;color.blue= msHexToInt(psRoot-&gt;pszValue+5);</span>
<span class="lineNum">    1434 </span>            :             status = MS_SUCCESS;
<span class="lineNum">    1435 </span>            :           }
<span class="lineNum">    1436 </span>            :           break;
<span class="lineNum">    1437 </span><span class="lineCov">          1 :         case MS_LABEL_BASE + MS_LABEL_BINDING_OUTLINECOLOR:</span>
<span class="lineNum">    1438 </span><span class="lineCov">          1 :           if (strlen(psRoot-&gt;pszValue) == 7 &amp;&amp; psRoot-&gt;pszValue[0] == '#')</span>
<span class="lineNum">    1439 </span>            :           {
<span class="lineNum">    1440 </span><span class="lineCov">          1 :             psLabel-&gt;outlinecolor.red = msHexToInt(psRoot-&gt;pszValue+1);</span>
<span class="lineNum">    1441 </span><span class="lineCov">          1 :             psLabel-&gt;outlinecolor.green = msHexToInt(psRoot-&gt;pszValue+3);</span>
<span class="lineNum">    1442 </span><span class="lineCov">          1 :             psLabel-&gt;outlinecolor.blue= msHexToInt(psRoot-&gt;pszValue+5);</span>
<span class="lineNum">    1443 </span>            :             status = MS_SUCCESS;
<span class="lineNum">    1444 </span>            :           }
<span class="lineNum">    1445 </span>            :           break;
<span class="lineNum">    1446 </span>            :         default:
<span class="lineNum">    1447 </span>            :           break;
<span class="lineNum">    1448 </span>            :       }
<span class="lineNum">    1449 </span>            :       break;
<span class="lineNum">    1450 </span><span class="lineCov">          1 :     case CXT_Element:</span>
<span class="lineNum">    1451 </span><span class="lineCov">          1 :       if (strcasecmp(psRoot-&gt;pszValue,&quot;Literal&quot;) == 0 &amp;&amp; psRoot-&gt;psChild)</span>
<span class="lineNum">    1452 </span>            :       {
<span class="lineNum">    1453 </span>            :         // Parse a &lt;ogc:Literal&gt; element
<span class="lineNum">    1454 </span><span class="lineCov">          1 :         status = msSLDParseOgcExpression(psRoot-&gt;psChild, psObj, binding, objtype);</span>
<span class="lineNum">    1455 </span>            :       }
<span class="lineNum">    1456 </span><span class="lineCov">          1 :       else if (strcasecmp(psRoot-&gt;pszValue,&quot;PropertyName&quot;) == 0</span>
<span class="lineNum">    1457 </span><span class="lineCov">          1 :           &amp;&amp; psRoot-&gt;psChild)</span>
<span class="lineNum">    1458 </span><span class="lineCov">          1 :       {</span>
<span class="lineNum">    1459 </span>            :         // Parse a &lt;ogc:PropertyName&gt; element
<span class="lineNum">    1460 </span><span class="lineCov">          1 :         msStringBuffer * property = msStringBufferAlloc();</span>
<span class="lineNum">    1461 </span>            :         char * strDelim = &quot;&quot;;
<span class="lineNum">    1462 </span>            : 
<span class="lineNum">    1463 </span><span class="lineCov">          1 :         switch (lbinding)</span>
<span class="lineNum">    1464 </span>            :         {
<span class="lineNum">    1465 </span><span class="lineCov">          1 :           case MS_STYLE_BASE + MS_STYLE_BINDING_COLOR:</span>
<span class="lineNum">    1466 </span>            :           case MS_STYLE_BASE + MS_STYLE_BINDING_OUTLINECOLOR:
<span class="lineNum">    1467 </span>            :           case MS_LABEL_BASE + MS_LABEL_BINDING_COLOR:
<span class="lineNum">    1468 </span>            :           case MS_LABEL_BASE + MS_LABEL_BINDING_OUTLINECOLOR:
<span class="lineNum">    1469 </span>            :             strDelim = &quot;\&quot;&quot;;
<span class="lineNum">    1470 </span><span class="lineCov">          1 :           default:</span>
<span class="lineNum">    1471 </span><span class="lineCov">          1 :             msStringBufferAppend(property, strDelim);</span>
<span class="lineNum">    1472 </span><span class="lineCov">          1 :             msStringBufferAppend(property, &quot;[&quot;);</span>
<span class="lineNum">    1473 </span><span class="lineCov">          1 :             msStringBufferAppend(property, psRoot-&gt;psChild-&gt;pszValue);</span>
<span class="lineNum">    1474 </span><span class="lineCov">          1 :             msStringBufferAppend(property, &quot;]&quot;);</span>
<span class="lineNum">    1475 </span><span class="lineCov">          1 :             msStringBufferAppend(property, strDelim);</span>
<span class="lineNum">    1476 </span><span class="lineCov">          1 :             msInitExpression(&amp;(exprBindings[binding]));</span>
<span class="lineNum">    1477 </span><span class="lineCov">          1 :             exprBindings[binding].string =</span>
<span class="lineNum">    1478 </span><span class="lineCov">          1 :             msStringBufferReleaseStringAndFree(property);</span>
<span class="lineNum">    1479 </span><span class="lineCov">          1 :             exprBindings[binding].type = MS_EXPRESSION;</span>
<span class="lineNum">    1480 </span><span class="lineCov">          1 :             (*nexprbindings)++;</span>
<span class="lineNum">    1481 </span>            :             break;
<span class="lineNum">    1482 </span>            :         }
<span class="lineNum">    1483 </span>            :         status = MS_SUCCESS;
<span class="lineNum">    1484 </span>            :       }
<span class="lineNum">    1485 </span><span class="lineCov">          1 :       else if (strcasecmp(psRoot-&gt;pszValue,&quot;Function&quot;) == 0</span>
<span class="lineNum">    1486 </span><span class="lineCov">          1 :           &amp;&amp; CPLGetXMLValue(psRoot,&quot;name&quot;,NULL)</span>
<span class="lineNum">    1487 </span><span class="lineCov">          1 :           &amp;&amp; psRoot-&gt;psChild-&gt;psNext)</span>
<span class="lineNum">    1488 </span><span class="lineCov">          1 :       {</span>
<span class="lineNum">    1489 </span>            :         // Parse a &lt;ogc:Function&gt; element
<span class="lineNum">    1490 </span><span class="lineCov">          1 :         msStringBuffer * function = msStringBufferAlloc();</span>
<span class="lineNum">    1491 </span>            : 
<span class="lineNum">    1492 </span>            :         // Parse function name
<span class="lineNum">    1493 </span><span class="lineCov">          1 :         const char * funcname = CPLGetXMLValue(psRoot,&quot;name&quot;,NULL);</span>
<span class="lineNum">    1494 </span><span class="lineCov">          1 :         msStringBufferAppend(function, funcname);</span>
<span class="lineNum">    1495 </span><span class="lineCov">          1 :         msStringBufferAppend(function, &quot;(&quot;);</span>
<span class="lineNum">    1496 </span><span class="lineCov">          1 :         msInitExpression(&amp;(exprBindings[binding]));</span>
<span class="lineNum">    1497 </span>            : 
<span class="lineNum">    1498 </span>            :         // Parse arguments
<span class="lineNum">    1499 </span>            :         char * sep =&quot;&quot;;
<span class="lineNum">    1500 </span><span class="lineCov">          1 :         for (CPLXMLNode * argument = psRoot-&gt;psChild-&gt;psNext ; argument ; argument = argument-&gt;psNext)</span>
<span class="lineNum">    1501 </span>            :         {
<span class="lineNum">    1502 </span><span class="lineCov">          1 :           status = msSLDParseOgcExpression(argument, psObj, binding, objtype);</span>
<span class="lineNum">    1503 </span><span class="lineCov">          1 :           if (status != MS_SUCCESS)</span>
<span class="lineNum">    1504 </span>            :             break;
<span class="lineNum">    1505 </span><span class="lineCov">          1 :           msStringBufferAppend(function, sep);</span>
<span class="lineNum">    1506 </span><span class="lineCov">          1 :           msStringBufferAppend(function, exprBindings[binding].string);</span>
<span class="lineNum">    1507 </span><span class="lineCov">          1 :           msFree(exprBindings[binding].string);</span>
<span class="lineNum">    1508 </span><span class="lineCov">          1 :           msInitExpression(&amp;(exprBindings[binding]));</span>
<span class="lineNum">    1509 </span>            :           sep = &quot;,&quot;;
<span class="lineNum">    1510 </span>            :         }
<span class="lineNum">    1511 </span><span class="lineCov">          1 :         msStringBufferAppend(function, &quot;)&quot;);</span>
<span class="lineNum">    1512 </span><span class="lineCov">          1 :         exprBindings[binding].string =</span>
<span class="lineNum">    1513 </span><span class="lineCov">          1 :             msStringBufferReleaseStringAndFree(function);</span>
<span class="lineNum">    1514 </span><span class="lineCov">          1 :         exprBindings[binding].type = MS_EXPRESSION;</span>
<span class="lineNum">    1515 </span><span class="lineCov">          1 :         (*nexprbindings)++;</span>
<span class="lineNum">    1516 </span>            :         status = MS_SUCCESS;
<span class="lineNum">    1517 </span>            :       }
<span class="lineNum">    1518 </span><span class="lineCov">          1 :       else if (strstr(ops, psRoot-&gt;pszValue)</span>
<span class="lineNum">    1519 </span><span class="lineCov">          1 :           &amp;&amp; psRoot-&gt;psChild &amp;&amp; psRoot-&gt;psChild-&gt;psNext)</span>
<span class="lineNum">    1520 </span>            :       {
<span class="lineNum">    1521 </span>            :         // Parse an arithmetic element &lt;ogc:Add&gt;, &lt;ogc:Sub&gt;, &lt;ogc:Mul&gt;, &lt;ogc:Div&gt;
<span class="lineNum">    1522 </span><span class="lineCov">          1 :         const char operator[2] = { *(strstr(ops, psRoot-&gt;pszValue)+3), '\0' };</span>
<span class="lineNum">    1523 </span><span class="lineCov">          1 :         msStringBuffer * expression = msStringBufferAlloc();</span>
<span class="lineNum">    1524 </span>            : 
<span class="lineNum">    1525 </span>            :         // Parse first operand
<span class="lineNum">    1526 </span><span class="lineCov">          1 :         msStringBufferAppend(expression, &quot;(&quot;);</span>
<span class="lineNum">    1527 </span><span class="lineCov">          1 :         msInitExpression(&amp;(exprBindings[binding]));</span>
<span class="lineNum">    1528 </span><span class="lineCov">          1 :         status = msSLDParseOgcExpression(psRoot-&gt;psChild, psObj, binding, objtype);</span>
<span class="lineNum">    1529 </span>            : 
<span class="lineNum">    1530 </span>            :         // Parse second operand
<span class="lineNum">    1531 </span><span class="lineCov">          1 :         if (status == MS_SUCCESS)</span>
<span class="lineNum">    1532 </span>            :         {
<span class="lineNum">    1533 </span><span class="lineCov">          1 :           msStringBufferAppend(expression, exprBindings[binding].string);</span>
<span class="lineNum">    1534 </span><span class="lineCov">          1 :           msStringBufferAppend(expression, operator);</span>
<span class="lineNum">    1535 </span><span class="lineCov">          1 :           msFree(exprBindings[binding].string);</span>
<span class="lineNum">    1536 </span><span class="lineCov">          1 :           msInitExpression(&amp;(exprBindings[binding]));</span>
<span class="lineNum">    1537 </span><span class="lineCov">          1 :           status = msSLDParseOgcExpression(psRoot-&gt;psChild-&gt;psNext,</span>
<span class="lineNum">    1538 </span>            :               psObj, binding, objtype);
<span class="lineNum">    1539 </span><span class="lineCov">          1 :           if (status == MS_SUCCESS)</span>
<span class="lineNum">    1540 </span>            :           {
<span class="lineNum">    1541 </span><span class="lineCov">          1 :             msStringBufferAppend(expression, exprBindings[binding].string);</span>
<span class="lineNum">    1542 </span><span class="lineCov">          1 :             msStringBufferAppend(expression, &quot;)&quot;);</span>
<span class="lineNum">    1543 </span><span class="lineCov">          1 :             msFree(exprBindings[binding].string);</span>
<span class="lineNum">    1544 </span><span class="lineCov">          1 :             exprBindings[binding].string =</span>
<span class="lineNum">    1545 </span><span class="lineCov">          1 :                 msStringBufferReleaseStringAndFree(expression);</span>
<span class="lineNum">    1546 </span><span class="lineCov">          1 :             exprBindings[binding].type = MS_EXPRESSION;</span>
<span class="lineNum">    1547 </span><span class="lineCov">          1 :             (*nexprbindings)++;</span>
<span class="lineNum">    1548 </span>            :           }
<span class="lineNum">    1549 </span>            :         }
<span class="lineNum">    1550 </span><span class="lineCov">          1 :         if (status == MS_FAILURE)</span>
<span class="lineNum">    1551 </span>            :         {
<span class="lineNum">    1552 </span><span class="lineNoCov">          0 :           msStringBufferFree(expression);</span>
<span class="lineNum">    1553 </span><span class="lineNoCov">          0 :           msInitExpression(&amp;(exprBindings[binding]));</span>
<span class="lineNum">    1554 </span>            :         }
<span class="lineNum">    1555 </span>            :       }
<span class="lineNum">    1556 </span>            :       break;
<span class="lineNum">    1557 </span>            :     default:
<span class="lineNum">    1558 </span>            :       break;
<span class="lineNum">    1559 </span>            :   }
<span class="lineNum">    1560 </span>            : 
<span class="lineNum">    1561 </span>            :   return status;
<span class="lineNum">    1562 </span>            : }
<span class="lineNum">    1563 </span>            : 
<span class="lineNum">    1564 </span>            : 
<span class="lineNum">    1565 </span>            : /************************************************************************/
<span class="lineNum">    1566 </span>            : /*                      msSLDParsePolygonSymbolizer()                   */
<span class="lineNum">    1567 </span>            : /*                                                                      */
<span class="lineNum">    1568 </span>            : /*      &lt;xs:element name=&quot;PolygonSymbolizer&quot;&gt;                           */
<span class="lineNum">    1569 </span>            : /*      &lt;xs:complexType&gt;                                                */
<span class="lineNum">    1570 </span>            : /*      &lt;xs:sequence&gt;                                                   */
<span class="lineNum">    1571 </span>            : /*      &lt;xs:element ref=&quot;sld:Geometry&quot; minOccurs=&quot;0&quot;/&gt;                  */
<span class="lineNum">    1572 </span>            : /*      &lt;xs:element ref=&quot;sld:Fill&quot; minOccurs=&quot;0&quot;/&gt;                      */
<span class="lineNum">    1573 </span>            : /*      &lt;xs:element ref=&quot;sld:Stroke&quot; minOccurs=&quot;0&quot;/&gt;                    */
<span class="lineNum">    1574 </span>            : /*      &lt;/xs:sequence&gt;                                                  */
<span class="lineNum">    1575 </span>            : /*      &lt;/xs:complexType&gt;                                               */
<span class="lineNum">    1576 </span>            : /*      &lt;/xs:element&gt;                                                   */
<span class="lineNum">    1577 </span>            : /*                                                                      */
<span class="lineNum">    1578 </span>            : /*                                                                      */
<span class="lineNum">    1579 </span>            : /*      &lt;xs:element name=&quot;Fill&quot;&gt;                                        */
<span class="lineNum">    1580 </span>            : /*      &lt;xs:complexType&gt;                                                */
<span class="lineNum">    1581 </span>            : /*      &lt;xs:sequence&gt;                                                   */
<span class="lineNum">    1582 </span>            : /*      &lt;xs:element ref=&quot;sld:GraphicFill&quot; minOccurs=&quot;0&quot;/&gt;               */
<span class="lineNum">    1583 </span>            : /*      &lt;xs:element ref=&quot;sld:CssParameter&quot; minOccurs=&quot;0&quot;                */
<span class="lineNum">    1584 </span>            : /*      maxOccurs=&quot;unbounded&quot;/&gt;                                         */
<span class="lineNum">    1585 </span>            : /*      &lt;/xs:sequence&gt;                                                  */
<span class="lineNum">    1586 </span>            : /*      &lt;/xs:complexType&gt;                                               */
<span class="lineNum">    1587 </span>            : /*      &lt;/xs:element&gt;                                                   */
<span class="lineNum">    1588 </span>            : /*                                                                      */
<span class="lineNum">    1589 </span>            : /*      Here, the CssParameter names are fill instead of stroke and     */
<span class="lineNum">    1590 </span>            : /*      fill-opacity instead of stroke-opacity. None of the other CssParameters*/
<span class="lineNum">    1591 </span>            : /*      in Stroke are available for filling and the default value for the fill color in this context is 50% gray (value #808080).*/
<span class="lineNum">    1592 </span>            : /*                                                                      */
<span class="lineNum">    1593 </span>            : /*                                                                      */
<span class="lineNum">    1594 </span>            : /*      &lt;xs:element name=&quot;GraphicFill&quot;&gt;                                 */
<span class="lineNum">    1595 </span>            : /*      &lt;xs:complexType&gt;                                                */
<span class="lineNum">    1596 </span>            : /*      &lt;xs:sequence&gt;                                                   */
<span class="lineNum">    1597 </span>            : /*      &lt;xs:element ref=&quot;sld:Graphic&quot;/&gt;                                 */
<span class="lineNum">    1598 </span>            : /*      &lt;/xs:sequence&gt;                                                  */
<span class="lineNum">    1599 </span>            : /*      &lt;/xs:complexType&gt;                                               */
<span class="lineNum">    1600 </span>            : /*      &lt;/xs:element&gt;                                                   */
<span class="lineNum">    1601 </span>            : /*                                                                      */
<span class="lineNum">    1602 </span>            : /*                                                                      */
<span class="lineNum">    1603 </span>            : /*      &lt;xs:element name=&quot;Graphic&quot;&gt;                                     */
<span class="lineNum">    1604 </span>            : /*      &lt;xs:complexType&gt;                                                */
<span class="lineNum">    1605 </span>            : /*      &lt;xs:sequence&gt;                                                   */
<span class="lineNum">    1606 </span>            : /*      &lt;xs:choice minOccurs=&quot;0&quot; maxOccurs=&quot;unbounded&quot;&gt;                 */
<span class="lineNum">    1607 </span>            : /*      &lt;xs:element ref=&quot;sld:ExternalGraphic&quot;/&gt;                         */
<span class="lineNum">    1608 </span>            : /*      &lt;xs:element ref=&quot;sld:Mark&quot;/&gt;                                    */
<span class="lineNum">    1609 </span>            : /*      &lt;/xs:choice&gt;                                                    */
<span class="lineNum">    1610 </span>            : /*      &lt;xs:sequence&gt;                                                   */
<span class="lineNum">    1611 </span>            : /*      &lt;xs:element ref=&quot;sld:Opacity&quot; minOccurs=&quot;0&quot;/&gt;                   */
<span class="lineNum">    1612 </span>            : /*      &lt;xs:element ref=&quot;sld:Size&quot; minOccurs=&quot;0&quot;/&gt;                      */
<span class="lineNum">    1613 </span>            : /*      &lt;xs:element ref=&quot;sld:Rotation&quot; minOccurs=&quot;0&quot;/&gt;                  */
<span class="lineNum">    1614 </span>            : /*      &lt;/xs:sequence&gt;                                                  */
<span class="lineNum">    1615 </span>            : /*      &lt;/xs:sequence&gt;                                                  */
<span class="lineNum">    1616 </span>            : /*      &lt;/xs:complexType&gt;                                               */
<span class="lineNum">    1617 </span>            : /*      &lt;/xs:element&gt;                                                   */
<span class="lineNum">    1618 </span>            : /*                                                                      */
<span class="lineNum">    1619 </span>            : /*      The default if neither an ExternalGraphic nor a Mark is specified is to use the default*/
<span class="lineNum">    1620 </span>            : /*      mark of a square with a 50%-gray fill and a black outline, with a size of 6 pixels.*/
<span class="lineNum">    1621 </span>            : /*                                                                      */
<span class="lineNum">    1622 </span>            : /*                                                                      */
<span class="lineNum">    1623 </span>            : /*      &lt;xs:element name=&quot;Mark&quot;&gt;                                        */
<span class="lineNum">    1624 </span>            : /*      &lt;xs:complexType&gt;                                                */
<span class="lineNum">    1625 </span>            : /*      &lt;xs:sequence&gt;                                                   */
<span class="lineNum">    1626 </span>            : /*      &lt;xs:element ref=&quot;sld:WellKnownName&quot; minOccurs=&quot;0&quot;/&gt;             */
<span class="lineNum">    1627 </span>            : /*      &lt;xs:element ref=&quot;sld:Fill&quot; minOccurs=&quot;0&quot;/&gt;                      */
<span class="lineNum">    1628 </span>            : /*      &lt;xs:element ref=&quot;sld:Stroke&quot; minOccurs=&quot;0&quot;/&gt;                    */
<span class="lineNum">    1629 </span>            : /*      &lt;/xs:sequence&gt;                                                  */
<span class="lineNum">    1630 </span>            : /*      &lt;/xs:complexType&gt;                                               */
<span class="lineNum">    1631 </span>            : /*      &lt;xs:element name=&quot;WellKnownName&quot; type=&quot;xs:string&quot;/&gt;             */
<span class="lineNum">    1632 </span>            : /*                                                                      */
<span class="lineNum">    1633 </span>            : /*      The WellKnownName element gives the well-known name of the shape of the mark.*/
<span class="lineNum">    1634 </span>            : /*      Allowed values include at least square, circle, triangle, star, cross,*/
<span class="lineNum">    1635 </span>            : /*      and x, though map servers may draw a different symbol instead if they don't have a*/
<span class="lineNum">    1636 </span>            : /*      shape for all of these. The default WellKnownName is square. Renderings of these*/
<span class="lineNum">    1637 </span>            : /*      marks may be made solid or hollow depending on Fill and Stroke elements.*/
<a name="1638"><span class="lineNum">    1638 </span>            : /*                                                                      */</a>
<span class="lineNum">    1639 </span>            : /************************************************************************/
<span class="lineNum">    1640 </span><span class="lineCov">          1 : int msSLDParsePolygonSymbolizer(CPLXMLNode *psRoot, layerObj *psLayer,</span>
<span class="lineNum">    1641 </span>            :                                 int bNewClass, const char* pszUserStyleName)
<span class="lineNum">    1642 </span>            : {
<span class="lineNum">    1643 </span>            :   CPLXMLNode *psFill, *psStroke;
<span class="lineNum">    1644 </span>            :   int nClassId=0, iStyle=0;
<span class="lineNum">    1645 </span>            :   CPLXMLNode *psDisplacement=NULL, *psDisplacementX=NULL, *psDisplacementY=NULL;
<span class="lineNum">    1646 </span>            :   int nOffsetX=-1, nOffsetY=-1;
<span class="lineNum">    1647 </span>            : 
<span class="lineNum">    1648 </span><span class="lineCov">          1 :   if (!psRoot || !psLayer)</span>
<span class="lineNum">    1649 </span>            :     return MS_FAILURE;
<span class="lineNum">    1650 </span>            : 
<span class="lineNum">    1651 </span>            :   // Get uom if any, defaults to MS_PIXELS
<span class="lineNum">    1652 </span><span class="lineCov">          1 :   enum MS_UNITS sizeunits = MS_PIXELS;</span>
<span class="lineNum">    1653 </span><span class="lineCov">          1 :   if (msSLDParseUomAttribute(psRoot, &amp;sizeunits) != MS_SUCCESS)</span>
<span class="lineNum">    1654 </span>            :   {
<span class="lineNum">    1655 </span><span class="lineNoCov">          0 :     msSetError(MS_WMSERR, &quot;Invalid uom attribute value.&quot;, &quot;msSLDParsePolygonSymbolizer()&quot;);</span>
<span class="lineNum">    1656 </span><span class="lineNoCov">          0 :     return MS_FAILURE;</span>
<span class="lineNum">    1657 </span>            :   }
<span class="lineNum">    1658 </span>            : 
<span class="lineNum">    1659 </span>            :   /*parse displacement for SLD 1.1.0*/
<span class="lineNum">    1660 </span><span class="lineCov">          1 :   psDisplacement = CPLGetXMLNode(psRoot, &quot;Displacement&quot;);</span>
<span class="lineNum">    1661 </span><span class="lineCov">          1 :   if (psDisplacement) {</span>
<span class="lineNum">    1662 </span><span class="lineNoCov">          0 :     psDisplacementX = CPLGetXMLNode(psDisplacement, &quot;DisplacementX&quot;);</span>
<span class="lineNum">    1663 </span><span class="lineNoCov">          0 :     psDisplacementY = CPLGetXMLNode(psDisplacement, &quot;DisplacementY&quot;);</span>
<span class="lineNum">    1664 </span>            :     /* psCssParam-&gt;psChild-&gt;psNext-&gt;pszValue) */
<span class="lineNum">    1665 </span><span class="lineNoCov">          0 :     if (psDisplacementX &amp;&amp;</span>
<span class="lineNum">    1666 </span><span class="lineNoCov">          0 :         psDisplacementX-&gt;psChild &amp;&amp;</span>
<span class="lineNum">    1667 </span><span class="lineNoCov">          0 :         psDisplacementX-&gt;psChild-&gt;pszValue &amp;&amp;</span>
<span class="lineNum">    1668 </span><span class="lineNoCov">          0 :         psDisplacementY &amp;&amp;</span>
<span class="lineNum">    1669 </span><span class="lineNoCov">          0 :         psDisplacementY-&gt;psChild &amp;&amp;</span>
<span class="lineNum">    1670 </span><span class="lineNoCov">          0 :         psDisplacementY-&gt;psChild-&gt;pszValue) {</span>
<span class="lineNum">    1671 </span>            :       nOffsetX = atoi(psDisplacementX-&gt;psChild-&gt;pszValue);
<span class="lineNum">    1672 </span><span class="lineNoCov">          0 :       nOffsetY = atoi(psDisplacementY-&gt;psChild-&gt;pszValue);</span>
<span class="lineNum">    1673 </span>            :     }
<span class="lineNum">    1674 </span>            :   }
<span class="lineNum">    1675 </span>            : 
<span class="lineNum">    1676 </span><span class="lineCov">          1 :   psFill =  CPLGetXMLNode(psRoot, &quot;Fill&quot;);</span>
<span class="lineNum">    1677 </span><span class="lineCov">          1 :   if (psFill) {</span>
<span class="lineNum">    1678 </span><span class="lineCov">          1 :     nClassId = getClassId(psLayer, bNewClass, pszUserStyleName);</span>
<span class="lineNum">    1679 </span><span class="lineCov">          1 :     if( nClassId &lt; 0 )</span>
<span class="lineNum">    1680 </span>            :         return MS_FAILURE;
<span class="lineNum">    1681 </span>            : 
<span class="lineNum">    1682 </span><span class="lineCov">          1 :     iStyle = psLayer-&gt;class[nClassId]-&gt;numstyles;</span>
<span class="lineNum">    1683 </span><span class="lineCov">          1 :     msMaybeAllocateClassStyle(psLayer-&gt;class[nClassId], iStyle);</span>
<span class="lineNum">    1684 </span><span class="lineCov">          1 :     psLayer-&gt;class[nClassId]-&gt;styles[iStyle]-&gt;sizeunits = sizeunits;</span>
<span class="lineNum">    1685 </span>            : 
<span class="lineNum">    1686 </span><span class="lineCov">          1 :     msSLDParsePolygonFill(psFill, psLayer-&gt;class[nClassId]-&gt;styles[iStyle],</span>
<span class="lineNum">    1687 </span><span class="lineCov">          1 :                           psLayer-&gt;map);</span>
<span class="lineNum">    1688 </span>            : 
<span class="lineNum">    1689 </span><span class="lineCov">          1 :     if (nOffsetX &gt; 0 &amp;&amp; nOffsetY &gt; 0) {</span>
<span class="lineNum">    1690 </span><span class="lineNoCov">          0 :       psLayer-&gt;class[nClassId]-&gt;styles[iStyle]-&gt;offsetx = nOffsetX;</span>
<span class="lineNum">    1691 </span><span class="lineNoCov">          0 :       psLayer-&gt;class[nClassId]-&gt;styles[iStyle]-&gt;offsety = nOffsetY;</span>
<span class="lineNum">    1692 </span>            :     }
<span class="lineNum">    1693 </span>            :   }
<span class="lineNum">    1694 </span>            :   /* stroke which corresponds to the outline in mapserver */
<span class="lineNum">    1695 </span>            :   /* is drawn after the fill */
<span class="lineNum">    1696 </span><span class="lineCov">          1 :   psStroke =  CPLGetXMLNode(psRoot, &quot;Stroke&quot;);</span>
<span class="lineNum">    1697 </span><span class="lineCov">          1 :   if (psStroke) {</span>
<span class="lineNum">    1698 </span>            :     /* -------------------------------------------------------------------- */
<span class="lineNum">    1699 </span>            :     /*      there was a fill so add a style to the last class created       */
<span class="lineNum">    1700 </span>            :     /*      by the fill                                                     */
<span class="lineNum">    1701 </span>            :     /* -------------------------------------------------------------------- */
<span class="lineNum">    1702 </span><span class="lineCov">          1 :     if (psFill &amp;&amp; psLayer-&gt;numclasses &gt; 0) {</span>
<span class="lineNum">    1703 </span><span class="lineCov">          1 :       nClassId =psLayer-&gt;numclasses-1;</span>
<span class="lineNum">    1704 </span><span class="lineCov">          1 :       iStyle = psLayer-&gt;class[nClassId]-&gt;numstyles;</span>
<span class="lineNum">    1705 </span><span class="lineCov">          1 :       msMaybeAllocateClassStyle(psLayer-&gt;class[nClassId], iStyle);</span>
<span class="lineNum">    1706 </span><span class="lineCov">          1 :       psLayer-&gt;class[nClassId]-&gt;styles[iStyle]-&gt;sizeunits = sizeunits;</span>
<span class="lineNum">    1707 </span>            :     } else {
<span class="lineNum">    1708 </span><span class="lineNoCov">          0 :       nClassId = getClassId(psLayer, bNewClass, pszUserStyleName);</span>
<span class="lineNum">    1709 </span><span class="lineNoCov">          0 :       if( nClassId &lt; 0 )</span>
<span class="lineNum">    1710 </span>            :         return MS_FAILURE;
<span class="lineNum">    1711 </span>            : 
<span class="lineNum">    1712 </span><span class="lineNoCov">          0 :       iStyle = psLayer-&gt;class[nClassId]-&gt;numstyles;</span>
<span class="lineNum">    1713 </span><span class="lineNoCov">          0 :       msMaybeAllocateClassStyle(psLayer-&gt;class[nClassId], iStyle);</span>
<span class="lineNum">    1714 </span><span class="lineNoCov">          0 :       psLayer-&gt;class[nClassId]-&gt;styles[iStyle]-&gt;sizeunits = sizeunits;</span>
<span class="lineNum">    1715 </span>            : 
<span class="lineNum">    1716 </span>            :     }
<span class="lineNum">    1717 </span><span class="lineCov">          1 :     msSLDParseStroke(psStroke, psLayer-&gt;class[nClassId]-&gt;styles[iStyle],</span>
<span class="lineNum">    1718 </span><span class="lineCov">          1 :                      psLayer-&gt;map, 1);</span>
<span class="lineNum">    1719 </span>            : 
<span class="lineNum">    1720 </span><span class="lineCov">          1 :     if (nOffsetX &gt; 0 &amp;&amp; nOffsetY &gt; 0) {</span>
<span class="lineNum">    1721 </span><span class="lineNoCov">          0 :       psLayer-&gt;class[nClassId]-&gt;styles[iStyle]-&gt;offsetx = nOffsetX;</span>
<span class="lineNum">    1722 </span><span class="lineNoCov">          0 :       psLayer-&gt;class[nClassId]-&gt;styles[iStyle]-&gt;offsety = nOffsetY;</span>
<span class="lineNum">    1723 </span>            :     }
<span class="lineNum">    1724 </span>            :   }
<span class="lineNum">    1725 </span>            : 
<span class="lineNum">    1726 </span>            :   return MS_SUCCESS;
<span class="lineNum">    1727 </span>            : }
<span class="lineNum">    1728 </span>            : 
<span class="lineNum">    1729 </span>            : 
<span class="lineNum">    1730 </span>            : /************************************************************************/
<span class="lineNum">    1731 </span>            : /*    void msSLDParsePolygonFill(CPLXMLNode *psFill, styleObj *psStyle, */
<span class="lineNum">    1732 </span>            : /*                                 mapObj *map)                         */
<span class="lineNum">    1733 </span>            : /*                                                                      */
<a name="1734"><span class="lineNum">    1734 </span>            : /*      Parse the Fill node for a polygon into a style.                 */</a>
<span class="lineNum">    1735 </span>            : /************************************************************************/
<span class="lineNum">    1736 </span><span class="lineCov">          1 : int msSLDParsePolygonFill(CPLXMLNode *psFill, styleObj *psStyle,</span>
<span class="lineNum">    1737 </span>            :                           mapObj *map)
<span class="lineNum">    1738 </span>            : {
<span class="lineNum">    1739 </span>            :   CPLXMLNode *psCssParam, *psGraphicFill;
<span class="lineNum">    1740 </span>            :   char *psFillName=NULL;
<span class="lineNum">    1741 </span>            : 
<span class="lineNum">    1742 </span><span class="lineCov">          1 :   if (!psFill || !psStyle || !map)</span>
<span class="lineNum">    1743 </span>            :     return MS_FAILURE;
<span class="lineNum">    1744 </span>            : 
<span class="lineNum">    1745 </span>            :   /* sets the default fill color defined in the spec #808080 */
<span class="lineNum">    1746 </span><span class="lineCov">          1 :   psStyle-&gt;color.red = 128;</span>
<span class="lineNum">    1747 </span><span class="lineCov">          1 :   psStyle-&gt;color.green = 128;</span>
<span class="lineNum">    1748 </span><span class="lineCov">          1 :   psStyle-&gt;color.blue = 128;</span>
<span class="lineNum">    1749 </span>            : 
<span class="lineNum">    1750 </span><span class="lineCov">          1 :   psCssParam =  CPLGetXMLNode(psFill, &quot;CssParameter&quot;);</span>
<span class="lineNum">    1751 </span>            :   /*sld 1.1 used SvgParameter*/
<span class="lineNum">    1752 </span><span class="lineCov">          1 :   if (psCssParam == NULL)</span>
<span class="lineNum">    1753 </span><span class="lineCov">          1 :     psCssParam =  CPLGetXMLNode(psFill, &quot;SvgParameter&quot;);</span>
<span class="lineNum">    1754 </span>            : 
<span class="lineNum">    1755 </span><span class="lineCov">          1 :   while (psCssParam &amp;&amp; psCssParam-&gt;pszValue &amp;&amp;</span>
<span class="lineNum">    1756 </span><span class="lineCov">          1 :          (strcasecmp(psCssParam-&gt;pszValue, &quot;CssParameter&quot;) == 0 ||</span>
<span class="lineNum">    1757 </span><span class="lineCov">          1 :           strcasecmp(psCssParam-&gt;pszValue, &quot;SvgParameter&quot;) == 0)) {</span>
<span class="lineNum">    1758 </span><span class="lineCov">          1 :     psFillName = (char*)CPLGetXMLValue(psCssParam, &quot;name&quot;, NULL);</span>
<span class="lineNum">    1759 </span><span class="lineCov">          1 :     if (psFillName) {</span>
<span class="lineNum">    1760 </span><span class="lineCov">          1 :       if (strcasecmp(psFillName, &quot;fill&quot;) == 0) {</span>
<span class="lineNum">    1761 </span><span class="lineCov">          1 :         if(psCssParam-&gt;psChild &amp;&amp; psCssParam-&gt;psChild-&gt;psNext)</span>
<span class="lineNum">    1762 </span>            :         {
<span class="lineNum">    1763 </span><span class="lineCov">          1 :           msSLDParseOgcExpression(psCssParam-&gt;psChild-&gt;psNext,</span>
<span class="lineNum">    1764 </span>            :               psStyle, MS_STYLE_BINDING_COLOR, MS_OBJ_STYLE);
<span class="lineNum">    1765 </span>            :         }
<span class="lineNum">    1766 </span><span class="lineCov">          1 :       } else if (strcasecmp(psFillName, &quot;fill-opacity&quot;) == 0) {</span>
<span class="lineNum">    1767 </span><span class="lineCov">          1 :         if(psCssParam-&gt;psChild &amp;&amp;  psCssParam-&gt;psChild-&gt;psNext)</span>
<span class="lineNum">    1768 </span>            :         {
<span class="lineNum">    1769 </span><span class="lineCov">          1 :           msSLDParseOgcExpression(psCssParam-&gt;psChild-&gt;psNext,</span>
<span class="lineNum">    1770 </span>            :               psStyle, MS_STYLE_BINDING_OPACITY, MS_OBJ_STYLE);
<span class="lineNum">    1771 </span>            :         }
<span class="lineNum">    1772 </span>            :       }
<span class="lineNum">    1773 </span>            :     }
<span class="lineNum">    1774 </span><span class="lineCov">          1 :     psCssParam = psCssParam-&gt;psNext;</span>
<span class="lineNum">    1775 </span>            :   }
<span class="lineNum">    1776 </span>            : 
<span class="lineNum">    1777 </span>            :   /* graphic fill and graphic stroke pare parsed the same way :  */
<span class="lineNum">    1778 </span>            :   /* TODO : It seems inconsistent to me since the only diffrence */
<span class="lineNum">    1779 </span>            :   /* between them seems to be fill (fill) or not fill (stroke). And */
<span class="lineNum">    1780 </span>            :   /* then again the fill parameter can be used inside both elements. */
<span class="lineNum">    1781 </span><span class="lineCov">          1 :   psGraphicFill =  CPLGetXMLNode(psFill, &quot;GraphicFill&quot;);</span>
<span class="lineNum">    1782 </span><span class="lineCov">          1 :   if (psGraphicFill)</span>
<span class="lineNum">    1783 </span><span class="lineCov">          1 :     msSLDParseGraphicFillOrStroke(psGraphicFill, NULL, psStyle, map);</span>
<span class="lineNum">    1784 </span><span class="lineCov">          1 :   psGraphicFill =  CPLGetXMLNode(psFill, &quot;GraphicStroke&quot;);</span>
<span class="lineNum">    1785 </span><span class="lineCov">          1 :   if (psGraphicFill)</span>
<span class="lineNum">    1786 </span><span class="lineNoCov">          0 :     msSLDParseGraphicFillOrStroke(psGraphicFill, NULL, psStyle, map);</span>
<span class="lineNum">    1787 </span>            : 
<span class="lineNum">    1788 </span>            : 
<span class="lineNum">    1789 </span>            :   return MS_SUCCESS;
<span class="lineNum">    1790 </span>            : }
<span class="lineNum">    1791 </span>            : 
<span class="lineNum">    1792 </span>            : 
<span class="lineNum">    1793 </span>            : /************************************************************************/
<span class="lineNum">    1794 </span>            : /*                      msSLDParseGraphicFillOrStroke                   */
<span class="lineNum">    1795 </span>            : /*                                                                      */
<span class="lineNum">    1796 </span>            : /*      Parse the GraphicFill Or GraphicStroke node : look for a        */
<a name="1797"><span class="lineNum">    1797 </span>            : /*      Marker symbol and set the style for that symbol.                */</a>
<span class="lineNum">    1798 </span>            : /************************************************************************/
<span class="lineNum">    1799 </span><span class="lineCov">          1 : int msSLDParseGraphicFillOrStroke(CPLXMLNode *psRoot,</span>
<span class="lineNum">    1800 </span>            :                                   char *pszDashValue,
<span class="lineNum">    1801 </span>            :                                   styleObj *psStyle, mapObj *map)
<span class="lineNum">    1802 </span>            : {
<span class="lineNum">    1803 </span>            :   CPLXMLNode  *psCssParam, *psGraphic, *psExternalGraphic, *psMark, *psSize, *psGap, *psInitialGap;
<span class="lineNum">    1804 </span>            :   CPLXMLNode *psWellKnownName, *psStroke, *psFill;
<span class="lineNum">    1805 </span>            :   CPLXMLNode *psDisplacement=NULL, *psDisplacementX=NULL, *psDisplacementY=NULL;
<span class="lineNum">    1806 </span>            :   CPLXMLNode *psOpacity=NULL, *psRotation=NULL;
<span class="lineNum">    1807 </span>            :   char *psName=NULL, *psValue = NULL;
<span class="lineNum">    1808 </span>            :   char *pszSymbolName = NULL;
<span class="lineNum">    1809 </span>            :   int bFilled = 0;
<span class="lineNum">    1810 </span>            : 
<span class="lineNum">    1811 </span><span class="lineCov">          1 :   if (!psRoot || !psStyle || !map)</span>
<span class="lineNum">    1812 </span>            :     return MS_FAILURE;
<span class="lineNum">    1813 </span>            :   /* ==================================================================== */
<span class="lineNum">    1814 </span>            :   /*      This a definition taken from the specification (11.3.2) :       */
<span class="lineNum">    1815 </span>            :   /*      Graphics can either be referenced from an external URL in a common format (such as*/
<span class="lineNum">    1816 </span>            :   /*      GIF or SVG) or may be derived from a Mark. Multiple external URLs and marks may be*/
<span class="lineNum">    1817 </span>            :   /*      referenced with the semantic that they all provide the equivalent graphic in different*/
<span class="lineNum">    1818 </span>            :   /*      formats.                                                        */
<span class="lineNum">    1819 </span>            :   /*                                                                      */
<span class="lineNum">    1820 </span>            :   /*      For this reason, we only need to support one Mark and one       */
<span class="lineNum">    1821 </span>            :   /*      ExtrnalGraphic ????                                             */
<span class="lineNum">    1822 </span>            :   /* ==================================================================== */
<span class="lineNum">    1823 </span><span class="lineCov">          1 :   psGraphic =  CPLGetXMLNode(psRoot, &quot;Graphic&quot;);</span>
<span class="lineNum">    1824 </span><span class="lineCov">          1 :   if (psGraphic) {</span>
<span class="lineNum">    1825 </span>            :     /* extract symbol size */
<span class="lineNum">    1826 </span><span class="lineCov">          1 :     psSize = CPLGetXMLNode(psGraphic, &quot;Size&quot;);</span>
<span class="lineNum">    1827 </span><span class="lineCov">          1 :     if (psSize &amp;&amp; psSize-&gt;psChild)</span>
<span class="lineNum">    1828 </span>            :     {
<span class="lineNum">    1829 </span><span class="lineCov">          1 :       msSLDParseOgcExpression(psSize-&gt;psChild,</span>
<span class="lineNum">    1830 </span>            :           psStyle, MS_STYLE_BINDING_SIZE, MS_OBJ_STYLE);
<span class="lineNum">    1831 </span>            :     }
<span class="lineNum">    1832 </span>            :     else {
<span class="lineNum">    1833 </span>            :       /*do not set a default for external symbols #2305*/
<span class="lineNum">    1834 </span><span class="lineNoCov">          0 :       psExternalGraphic =  CPLGetXMLNode(psGraphic, &quot;ExternalGraphic&quot;);</span>
<span class="lineNum">    1835 </span><span class="lineNoCov">          0 :       if (!psExternalGraphic)</span>
<span class="lineNum">    1836 </span><span class="lineNoCov">          0 :         psStyle-&gt;size = 6; /* default value */</span>
<span class="lineNum">    1837 </span>            :     }
<span class="lineNum">    1838 </span>            : 
<span class="lineNum">    1839 </span>            :     /*SLD 1.1.0 extract opacity, rotation, displacement*/
<span class="lineNum">    1840 </span><span class="lineCov">          1 :     psOpacity = CPLGetXMLNode(psGraphic, &quot;Opacity&quot;);</span>
<span class="lineNum">    1841 </span><span class="lineCov">          1 :     if (psOpacity &amp;&amp; psOpacity-&gt;psChild)</span>
<span class="lineNum">    1842 </span>            :     {
<span class="lineNum">    1843 </span><span class="lineCov">          1 :       msSLDParseOgcExpression(psOpacity-&gt;psChild,</span>
<span class="lineNum">    1844 </span>            :           psStyle, MS_STYLE_BINDING_OPACITY, MS_OBJ_STYLE);
<span class="lineNum">    1845 </span>            :     }
<span class="lineNum">    1846 </span>            : 
<span class="lineNum">    1847 </span><span class="lineCov">          1 :     psRotation = CPLGetXMLNode(psGraphic, &quot;Rotation&quot;);</span>
<span class="lineNum">    1848 </span><span class="lineCov">          1 :     if (psRotation &amp;&amp; psRotation-&gt;psChild)</span>
<span class="lineNum">    1849 </span>            :     {
<span class="lineNum">    1850 </span><span class="lineCov">          1 :       msSLDParseOgcExpression(psRotation-&gt;psChild,</span>
<span class="lineNum">    1851 </span>            :           psStyle, MS_STYLE_BINDING_ANGLE, MS_OBJ_STYLE);
<span class="lineNum">    1852 </span>            :     }
<span class="lineNum">    1853 </span><span class="lineCov">          1 :     psDisplacement = CPLGetXMLNode(psGraphic, &quot;Displacement&quot;);</span>
<span class="lineNum">    1854 </span><span class="lineCov">          1 :     if (psDisplacement &amp;&amp; psDisplacement-&gt;psChild)</span>
<span class="lineNum">    1855 </span>            :     {
<span class="lineNum">    1856 </span><span class="lineCov">          1 :       psDisplacementX = CPLGetXMLNode(psDisplacement, &quot;DisplacementX&quot;);</span>
<span class="lineNum">    1857 </span><span class="lineCov">          1 :       if (psDisplacementX &amp;&amp; psDisplacementX-&gt;psChild)</span>
<span class="lineNum">    1858 </span>            :       {
<span class="lineNum">    1859 </span><span class="lineCov">          1 :         msSLDParseOgcExpression(psDisplacementX-&gt;psChild,</span>
<span class="lineNum">    1860 </span>            :             psStyle, MS_STYLE_BINDING_OFFSET_X, MS_OBJ_STYLE);
<span class="lineNum">    1861 </span>            :       }
<span class="lineNum">    1862 </span><span class="lineCov">          1 :       psDisplacementY = CPLGetXMLNode(psDisplacement, &quot;DisplacementY&quot;);</span>
<span class="lineNum">    1863 </span><span class="lineCov">          1 :       if (psDisplacementY &amp;&amp; psDisplacementY-&gt;psChild)</span>
<span class="lineNum">    1864 </span>            :       {
<span class="lineNum">    1865 </span><span class="lineCov">          1 :         msSLDParseOgcExpression(psDisplacementY-&gt;psChild,</span>
<span class="lineNum">    1866 </span>            :             psStyle, MS_STYLE_BINDING_OFFSET_Y, MS_OBJ_STYLE);
<span class="lineNum">    1867 </span>            :       }
<span class="lineNum">    1868 </span>            :     }
<span class="lineNum">    1869 </span>            :     /* extract symbol */
<span class="lineNum">    1870 </span><span class="lineCov">          1 :     psMark =  CPLGetXMLNode(psGraphic, &quot;Mark&quot;);</span>
<span class="lineNum">    1871 </span><span class="lineCov">          1 :     if (psMark) {</span>
<span class="lineNum">    1872 </span>            :       pszSymbolName = NULL;
<span class="lineNum">    1873 </span><span class="lineCov">          1 :       psWellKnownName =  CPLGetXMLNode(psMark, &quot;WellKnownName&quot;);</span>
<span class="lineNum">    1874 </span><span class="lineCov">          1 :       if (psWellKnownName &amp;&amp; psWellKnownName-&gt;psChild &amp;&amp;</span>
<span class="lineNum">    1875 </span><span class="lineCov">          1 :           psWellKnownName-&gt;psChild-&gt;pszValue)</span>
<span class="lineNum">    1876 </span><span class="lineCov">          1 :         pszSymbolName =</span>
<span class="lineNum">    1877 </span>            :           msStrdup(psWellKnownName-&gt;psChild-&gt;pszValue);
<span class="lineNum">    1878 </span>            : 
<span class="lineNum">    1879 </span>            :       /* default symbol is square */
<span class="lineNum">    1880 </span>            : 
<span class="lineNum">    1881 </span><span class="lineCov">          1 :       if (!pszSymbolName || !*pszSymbolName ||</span>
<span class="lineNum">    1882 </span><span class="lineCov">          1 :           (strcasecmp(pszSymbolName, &quot;square&quot;) != 0 &amp;&amp;</span>
<span class="lineNum">    1883 </span><span class="lineCov">          1 :            strcasecmp(pszSymbolName, &quot;circle&quot;) != 0 &amp;&amp;</span>
<span class="lineNum">    1884 </span><span class="lineCov">          1 :            strcasecmp(pszSymbolName, &quot;triangle&quot;) != 0 &amp;&amp;</span>
<span class="lineNum">    1885 </span><span class="lineCov">          1 :            strcasecmp(pszSymbolName, &quot;star&quot;) != 0 &amp;&amp;</span>
<span class="lineNum">    1886 </span><span class="lineNoCov">          0 :            strcasecmp(pszSymbolName, &quot;cross&quot;) != 0 &amp;&amp;</span>
<span class="lineNum">    1887 </span><span class="lineNoCov">          0 :            strcasecmp(pszSymbolName, &quot;x&quot;) != 0)) {</span>
<span class="lineNum">    1888 </span><span class="lineNoCov">          0 :         if (!pszSymbolName || !*pszSymbolName || msGetSymbolIndex(&amp;map-&gt;symbolset, pszSymbolName,  MS_FALSE) &lt; 0) {</span>
<span class="lineNum">    1889 </span><span class="lineNoCov">          0 :           msFree(pszSymbolName);</span>
<span class="lineNum">    1890 </span><span class="lineNoCov">          0 :           pszSymbolName = msStrdup(&quot;square&quot;);</span>
<span class="lineNum">    1891 </span>            :         }
<span class="lineNum">    1892 </span>            :       }
<span class="lineNum">    1893 </span>            : 
<span class="lineNum">    1894 </span>            : 
<span class="lineNum">    1895 </span>            :       /* check if the symbol should be filled or not */
<span class="lineNum">    1896 </span><span class="lineCov">          1 :       psFill = CPLGetXMLNode(psMark, &quot;Fill&quot;);</span>
<span class="lineNum">    1897 </span><span class="lineCov">          1 :       psStroke = CPLGetXMLNode(psMark, &quot;Stroke&quot;);</span>
<span class="lineNum">    1898 </span>            : 
<span class="lineNum">    1899 </span><span class="lineCov">          1 :       if (psFill || psStroke) {</span>
<span class="lineNum">    1900 </span><span class="lineCov">          1 :         if (psFill)</span>
<span class="lineNum">    1901 </span>            :           bFilled = 1;
<span class="lineNum">    1902 </span>            :         else
<span class="lineNum">    1903 </span>            :           bFilled = 0;
<span class="lineNum">    1904 </span>            : 
<span class="lineNum">    1905 </span><span class="lineCov">          1 :         if (psFill) {</span>
<span class="lineNum">    1906 </span><span class="lineCov">          1 :           psCssParam =  CPLGetXMLNode(psFill, &quot;CssParameter&quot;);</span>
<span class="lineNum">    1907 </span>            :           /*sld 1.1 used SvgParameter*/
<span class="lineNum">    1908 </span><span class="lineCov">          1 :           if (psCssParam == NULL)</span>
<span class="lineNum">    1909 </span><span class="lineCov">          1 :             psCssParam =  CPLGetXMLNode(psFill, &quot;SvgParameter&quot;);</span>
<span class="lineNum">    1910 </span>            : 
<span class="lineNum">    1911 </span><span class="lineCov">          1 :           while (psCssParam &amp;&amp; psCssParam-&gt;pszValue &amp;&amp;</span>
<span class="lineNum">    1912 </span><span class="lineCov">          1 :                  (strcasecmp(psCssParam-&gt;pszValue, &quot;CssParameter&quot;) == 0 ||</span>
<span class="lineNum">    1913 </span><span class="lineCov">          1 :                   strcasecmp(psCssParam-&gt;pszValue, &quot;SvgParameter&quot;) == 0)) {</span>
<span class="lineNum">    1914 </span><span class="lineCov">          1 :             psName =</span>
<span class="lineNum">    1915 </span>            :               (char*)CPLGetXMLValue(psCssParam, &quot;name&quot;, NULL);
<span class="lineNum">    1916 </span><span class="lineCov">          1 :             if (psName &amp;&amp;</span>
<span class="lineNum">    1917 </span><span class="lineCov">          1 :                 strcasecmp(psName, &quot;fill&quot;) == 0) {</span>
<span class="lineNum">    1918 </span><span class="lineCov">          1 :               if(psCssParam-&gt;psChild &amp;&amp; psCssParam-&gt;psChild-&gt;psNext)</span>
<span class="lineNum">    1919 </span>            :               {
<span class="lineNum">    1920 </span><span class="lineCov">          1 :                 msSLDParseOgcExpression(psCssParam-&gt;psChild-&gt;psNext,</span>
<span class="lineNum">    1921 </span>            :                     psStyle, MS_STYLE_BINDING_COLOR, MS_OBJ_STYLE);
<span class="lineNum">    1922 </span>            :               }
<span class="lineNum">    1923 </span><span class="lineCov">          1 :             } else if (psName &amp;&amp;</span>
<span class="lineNum">    1924 </span><span class="lineCov">          1 :                        strcasecmp(psName, &quot;fill-opacity&quot;) == 0) {</span>
<span class="lineNum">    1925 </span><span class="lineCov">          1 :               if(psCssParam-&gt;psChild &amp;&amp; psCssParam-&gt;psChild-&gt;psNext)</span>
<span class="lineNum">    1926 </span>            :               {
<span class="lineNum">    1927 </span><span class="lineCov">          1 :                 psValue = psCssParam-&gt;psChild-&gt;psNext-&gt;pszValue;</span>
<span class="lineNum">    1928 </span><span class="lineCov">          1 :                 if (psValue) {</span>
<span class="lineNum">    1929 </span><span class="lineCov">          1 :                   psStyle-&gt;color.alpha = (int)(atof(psValue)*255);</span>
<span class="lineNum">    1930 </span>            :                 }
<span class="lineNum">    1931 </span>            :               }
<span class="lineNum">    1932 </span>            :             }
<span class="lineNum">    1933 </span>            : 
<span class="lineNum">    1934 </span><span class="lineCov">          1 :             psCssParam = psCssParam-&gt;psNext;</span>
<span class="lineNum">    1935 </span>            :           }
<span class="lineNum">    1936 </span>            :         }
<span class="lineNum">    1937 </span><span class="lineCov">          1 :         if (psStroke) {</span>
<span class="lineNum">    1938 </span><span class="lineCov">          1 :           psCssParam =  CPLGetXMLNode(psStroke, &quot;CssParameter&quot;);</span>
<span class="lineNum">    1939 </span>            :           /*sld 1.1 used SvgParameter*/
<span class="lineNum">    1940 </span><span class="lineCov">          1 :           if (psCssParam == NULL)</span>
<span class="lineNum">    1941 </span><span class="lineCov">          1 :             psCssParam =  CPLGetXMLNode(psStroke, &quot;SvgParameter&quot;);</span>
<span class="lineNum">    1942 </span>            : 
<span class="lineNum">    1943 </span><span class="lineCov">          1 :           while (psCssParam &amp;&amp; psCssParam-&gt;pszValue &amp;&amp;</span>
<span class="lineNum">    1944 </span><span class="lineCov">          1 :                  (strcasecmp(psCssParam-&gt;pszValue, &quot;CssParameter&quot;) == 0 ||</span>
<span class="lineNum">    1945 </span><span class="lineCov">          1 :                   strcasecmp(psCssParam-&gt;pszValue, &quot;SvgParameter&quot;) == 0)) {</span>
<span class="lineNum">    1946 </span><span class="lineCov">          1 :             psName =</span>
<span class="lineNum">    1947 </span>            :               (char*)CPLGetXMLValue(psCssParam, &quot;name&quot;, NULL);
<span class="lineNum">    1948 </span><span class="lineCov">          1 :             if (psName &amp;&amp;</span>
<span class="lineNum">    1949 </span><span class="lineCov">          1 :                 strcasecmp(psName, &quot;stroke&quot;) == 0) {</span>
<span class="lineNum">    1950 </span><span class="lineCov">          1 :               if(psCssParam-&gt;psChild &amp;&amp; psCssParam-&gt;psChild-&gt;psNext)</span>
<span class="lineNum">    1951 </span>            :               {
<span class="lineNum">    1952 </span><span class="lineCov">          1 :                 if (bFilled) {</span>
<span class="lineNum">    1953 </span><span class="lineCov">          1 :                   msSLDParseOgcExpression(psCssParam-&gt;psChild-&gt;psNext,</span>
<span class="lineNum">    1954 </span>            :                       psStyle, MS_STYLE_BINDING_OUTLINECOLOR, MS_OBJ_STYLE);
<span class="lineNum">    1955 </span>            :                 } else {
<span class="lineNum">    1956 </span><span class="lineCov">          1 :                   msSLDParseOgcExpression(psCssParam-&gt;psChild-&gt;psNext,</span>
<span class="lineNum">    1957 </span>            :                       psStyle, MS_STYLE_BINDING_COLOR, MS_OBJ_STYLE);
<span class="lineNum">    1958 </span>            :                 }
<span class="lineNum">    1959 </span>            :               }
<span class="lineNum">    1960 </span><span class="lineCov">          1 :             } else if (psName &amp;&amp;</span>
<span class="lineNum">    1961 </span><span class="lineCov">          1 :                        strcasecmp(psName, &quot;stroke-opacity&quot;) == 0) {</span>
<span class="lineNum">    1962 </span><span class="lineCov">          1 :               if(psCssParam-&gt;psChild &amp;&amp; psCssParam-&gt;psChild-&gt;psNext)</span>
<span class="lineNum">    1963 </span>            :               {
<span class="lineNum">    1964 </span><span class="lineCov">          1 :                 psValue = psCssParam-&gt;psChild-&gt;psNext-&gt;pszValue;</span>
<span class="lineNum">    1965 </span><span class="lineCov">          1 :                 if (psValue) {</span>
<span class="lineNum">    1966 </span><span class="lineCov">          1 :                   if (bFilled) {</span>
<span class="lineNum">    1967 </span><span class="lineCov">          1 :                     psStyle-&gt;outlinecolor.alpha = (int)(atof(psValue)*255);</span>
<span class="lineNum">    1968 </span>            :                   } else {
<span class="lineNum">    1969 </span><span class="lineNoCov">          0 :                     psStyle-&gt;color.alpha = (int)(atof(psValue)*255);</span>
<span class="lineNum">    1970 </span>            :                   }
<span class="lineNum">    1971 </span>            :                 }
<span class="lineNum">    1972 </span>            :               }
<span class="lineNum">    1973 </span><span class="lineCov">          1 :             } else if (psName &amp;&amp;</span>
<span class="lineNum">    1974 </span><span class="lineCov">          1 :                        strcasecmp(psName, &quot;stroke-width&quot;) == 0) {</span>
<span class="lineNum">    1975 </span><span class="lineCov">          1 :               if(psCssParam-&gt;psChild &amp;&amp; psCssParam-&gt;psChild-&gt;psNext)</span>
<span class="lineNum">    1976 </span>            :               {
<span class="lineNum">    1977 </span><span class="lineCov">          1 :                 msSLDParseOgcExpression(psCssParam-&gt;psChild-&gt;psNext,</span>
<span class="lineNum">    1978 </span>            :                     psStyle, MS_STYLE_BINDING_WIDTH, MS_OBJ_STYLE);
<span class="lineNum">    1979 </span>            :               }
<span class="lineNum">    1980 </span>            :             }
<span class="lineNum">    1981 </span>            : 
<span class="lineNum">    1982 </span><span class="lineCov">          1 :             psCssParam = psCssParam-&gt;psNext;</span>
<span class="lineNum">    1983 </span>            :           }
<span class="lineNum">    1984 </span>            :         }
<span class="lineNum">    1985 </span>            : 
<span class="lineNum">    1986 </span>            :       }
<span class="lineNum">    1987 </span>            :       /* set the default color if color is not not already set */
<span class="lineNum">    1988 </span><span class="lineCov">          1 :       if ((psStyle-&gt;color.red &lt; 0 ||</span>
<span class="lineNum">    1989 </span><span class="lineCov">          1 :            psStyle-&gt;color.green == -1 ||</span>
<span class="lineNum">    1990 </span><span class="lineCov">          1 :            psStyle-&gt;color.blue == -1) &amp;&amp;</span>
<span class="lineNum">    1991 </span><span class="lineCov">          1 :           (psStyle-&gt;outlinecolor.red == -1 ||</span>
<span class="lineNum">    1992 </span><span class="lineCov">          1 :            psStyle-&gt;outlinecolor.green == -1 ||</span>
<span class="lineNum">    1993 </span><span class="lineCov">          1 :            psStyle-&gt;outlinecolor.blue == -1)) {</span>
<span class="lineNum">    1994 </span><span class="lineNoCov">          0 :         psStyle-&gt;color.red = 128;</span>
<span class="lineNum">    1995 </span><span class="lineNoCov">          0 :         psStyle-&gt;color.green = 128;</span>
<span class="lineNum">    1996 </span><span class="lineNoCov">          0 :         psStyle-&gt;color.blue = 128;</span>
<span class="lineNum">    1997 </span>            :       }
<span class="lineNum">    1998 </span>            : 
<span class="lineNum">    1999 </span>            : 
<span class="lineNum">    2000 </span>            :       /* Get the corresponding symbol id  */
<span class="lineNum">    2001 </span><span class="lineCov">          1 :       psStyle-&gt;symbol = msSLDGetMarkSymbol(map, pszSymbolName, bFilled);</span>
<span class="lineNum">    2002 </span><span class="lineCov">          1 :       if (psStyle-&gt;symbol &gt; 0 &amp;&amp;</span>
<span class="lineNum">    2003 </span><span class="lineCov">          1 :           psStyle-&gt;symbol &lt; map-&gt;symbolset.numsymbols)</span>
<span class="lineNum">    2004 </span><span class="lineCov">          1 :         psStyle-&gt;symbolname =</span>
<span class="lineNum">    2005 </span><span class="lineCov">          1 :           msStrdup(map-&gt;symbolset.symbol[psStyle-&gt;symbol]-&gt;name);</span>
<span class="lineNum">    2006 </span>            : 
<span class="lineNum">    2007 </span>            :     } else {
<span class="lineNum">    2008 </span><span class="lineCov">          1 :       psExternalGraphic =  CPLGetXMLNode(psGraphic, &quot;ExternalGraphic&quot;);</span>
<span class="lineNum">    2009 </span><span class="lineCov">          1 :       if (psExternalGraphic)</span>
<span class="lineNum">    2010 </span><span class="lineCov">          1 :         msSLDParseExternalGraphic(psExternalGraphic, psStyle, map);</span>
<span class="lineNum">    2011 </span>            :     }
<span class="lineNum">    2012 </span><span class="lineCov">          1 :     msFree(pszSymbolName);</span>
<span class="lineNum">    2013 </span>            :   }
<span class="lineNum">    2014 </span><span class="lineCov">          1 :   psGap =  CPLGetXMLNode(psRoot, &quot;Gap&quot;);</span>
<span class="lineNum">    2015 </span><span class="lineCov">          1 :   if (psGap &amp;&amp; psGap-&gt;psChild &amp;&amp; psGap-&gt;psChild-&gt;pszValue) {</span>
<span class="lineNum">    2016 </span><span class="lineCov">          1 :     psStyle-&gt;gap = atof(psGap-&gt;psChild-&gt;pszValue);</span>
<span class="lineNum">    2017 </span>            :   }
<span class="lineNum">    2018 </span><span class="lineCov">          1 :   psInitialGap =  CPLGetXMLNode(psRoot, &quot;InitialGap&quot;);</span>
<span class="lineNum">    2019 </span><span class="lineCov">          1 :   if (psInitialGap &amp;&amp; psInitialGap-&gt;psChild &amp;&amp; psInitialGap-&gt;psChild-&gt;pszValue) {</span>
<span class="lineNum">    2020 </span><span class="lineCov">          1 :     psStyle-&gt;initialgap = atof(psInitialGap-&gt;psChild-&gt;pszValue);</span>
<span class="lineNum">    2021 </span>            :   }
<span class="lineNum">    2022 </span>            : 
<span class="lineNum">    2023 </span>            :   return MS_SUCCESS;
<span class="lineNum">    2024 </span>            : }
<span class="lineNum">    2025 </span>            : 
<span class="lineNum">    2026 </span>            : 
<span class="lineNum">    2027 </span>            : /************************************************************************/
<span class="lineNum">    2028 </span>            : /*                            msSLDGetMarkSymbol                        */
<span class="lineNum">    2029 </span>            : /*                                                                      */
<span class="lineNum">    2030 </span>            : /*      Get a Mark symbol using the name. Mark symbols can be           */
<span class="lineNum">    2031 </span>            : /*      square, circle, triangle, star, cross, x.                       */
<a name="2032"><span class="lineNum">    2032 </span>            : /*      If the symbol does not exist add it to the symbol list.        */</a>
<span class="lineNum">    2033 </span>            : /************************************************************************/
<span class="lineNum">    2034 </span><span class="lineCov">          1 : int msSLDGetMarkSymbol(mapObj *map, char *pszSymbolName, int bFilled)</span>
<span class="lineNum">    2035 </span>            : {
<span class="lineNum">    2036 </span>            :   int nSymbolId = 0;
<span class="lineNum">    2037 </span>            :   symbolObj *psSymbol = NULL;
<span class="lineNum">    2038 </span>            : 
<span class="lineNum">    2039 </span><span class="lineCov">          1 :   if (!map || !pszSymbolName)</span>
<span class="lineNum">    2040 </span>            :     return 0;
<span class="lineNum">    2041 </span>            : 
<span class="lineNum">    2042 </span><span class="lineCov">          1 :   if (strcasecmp(pszSymbolName, &quot;square&quot;) == 0) {</span>
<span class="lineNum">    2043 </span><span class="lineNoCov">          0 :     if (bFilled)</span>
<span class="lineNum">    2044 </span><span class="lineNoCov">          0 :       nSymbolId = msGetSymbolIndex(&amp;map-&gt;symbolset,</span>
<span class="lineNum">    2045 </span>            :                                    SLD_MARK_SYMBOL_SQUARE_FILLED,
<span class="lineNum">    2046 </span>            :                                    MS_FALSE);
<span class="lineNum">    2047 </span>            :     else
<span class="lineNum">    2048 </span><span class="lineNoCov">          0 :       nSymbolId = msGetSymbolIndex(&amp;map-&gt;symbolset,</span>
<span class="lineNum">    2049 </span>            :                                    SLD_MARK_SYMBOL_SQUARE,
<span class="lineNum">    2050 </span>            :                                    MS_FALSE);
<span class="lineNum">    2051 </span><span class="lineCov">          1 :   } else if (strcasecmp(pszSymbolName, &quot;circle&quot;) == 0) {</span>
<span class="lineNum">    2052 </span>            : 
<span class="lineNum">    2053 </span><span class="lineCov">          1 :     if (bFilled)</span>
<span class="lineNum">    2054 </span><span class="lineCov">          1 :       nSymbolId = msGetSymbolIndex(&amp;map-&gt;symbolset,</span>
<span class="lineNum">    2055 </span>            :                                    SLD_MARK_SYMBOL_CIRCLE_FILLED,
<span class="lineNum">    2056 </span>            :                                    MS_FALSE);
<span class="lineNum">    2057 </span>            :     else
<span class="lineNum">    2058 </span><span class="lineCov">          1 :       nSymbolId = msGetSymbolIndex(&amp;map-&gt;symbolset,</span>
<span class="lineNum">    2059 </span>            :                                    SLD_MARK_SYMBOL_CIRCLE,
<span class="lineNum">    2060 </span>            :                                    MS_FALSE);
<span class="lineNum">    2061 </span><span class="lineCov">          1 :   } else if (strcasecmp(pszSymbolName, &quot;triangle&quot;) == 0) {</span>
<span class="lineNum">    2062 </span>            : 
<span class="lineNum">    2063 </span><span class="lineNoCov">          0 :     if (bFilled)</span>
<span class="lineNum">    2064 </span><span class="lineNoCov">          0 :       nSymbolId = msGetSymbolIndex(&amp;map-&gt;symbolset,</span>
<span class="lineNum">    2065 </span>            :                                    SLD_MARK_SYMBOL_TRIANGLE_FILLED,
<span class="lineNum">    2066 </span>            :                                    MS_FALSE);
<span class="lineNum">    2067 </span>            :     else
<span class="lineNum">    2068 </span><span class="lineNoCov">          0 :       nSymbolId = msGetSymbolIndex(&amp;map-&gt;symbolset,</span>
<span class="lineNum">    2069 </span>            :                                    SLD_MARK_SYMBOL_TRIANGLE,
<span class="lineNum">    2070 </span>            :                                    MS_FALSE);
<span class="lineNum">    2071 </span><span class="lineCov">          1 :   } else if (strcasecmp(pszSymbolName, &quot;star&quot;) == 0) {</span>
<span class="lineNum">    2072 </span>            : 
<span class="lineNum">    2073 </span><span class="lineCov">          1 :     if (bFilled)</span>
<span class="lineNum">    2074 </span><span class="lineCov">          1 :       nSymbolId = msGetSymbolIndex(&amp;map-&gt;symbolset,</span>
<span class="lineNum">    2075 </span>            :                                    SLD_MARK_SYMBOL_STAR_FILLED,
<span class="lineNum">    2076 </span>            :                                    MS_FALSE);
<span class="lineNum">    2077 </span>            :     else
<span class="lineNum">    2078 </span><span class="lineNoCov">          0 :       nSymbolId = msGetSymbolIndex(&amp;map-&gt;symbolset,</span>
<span class="lineNum">    2079 </span>            :                                    SLD_MARK_SYMBOL_STAR,
<span class="lineNum">    2080 </span>            :                                    MS_FALSE);
<span class="lineNum">    2081 </span><span class="lineNoCov">          0 :   } else if (strcasecmp(pszSymbolName, &quot;cross&quot;) == 0) {</span>
<span class="lineNum">    2082 </span>            : 
<span class="lineNum">    2083 </span><span class="lineNoCov">          0 :     if (bFilled)</span>
<span class="lineNum">    2084 </span><span class="lineNoCov">          0 :       nSymbolId = msGetSymbolIndex(&amp;map-&gt;symbolset,</span>
<span class="lineNum">    2085 </span>            :                                    SLD_MARK_SYMBOL_CROSS_FILLED,
<span class="lineNum">    2086 </span>            :                                    MS_FALSE);
<span class="lineNum">    2087 </span>            :     else
<span class="lineNum">    2088 </span><span class="lineNoCov">          0 :       nSymbolId = msGetSymbolIndex(&amp;map-&gt;symbolset,</span>
<span class="lineNum">    2089 </span>            :                                    SLD_MARK_SYMBOL_CROSS,
<span class="lineNum">    2090 </span>            :                                    MS_FALSE);
<span class="lineNum">    2091 </span><span class="lineNoCov">          0 :   } else if (strcasecmp(pszSymbolName, &quot;x&quot;) == 0) {</span>
<span class="lineNum">    2092 </span>            : 
<span class="lineNum">    2093 </span><span class="lineNoCov">          0 :     if (bFilled)</span>
<span class="lineNum">    2094 </span><span class="lineNoCov">          0 :       nSymbolId = msGetSymbolIndex(&amp;map-&gt;symbolset,</span>
<span class="lineNum">    2095 </span>            :                                    SLD_MARK_SYMBOL_X_FILLED,
<span class="lineNum">    2096 </span>            :                                    MS_FALSE);
<span class="lineNum">    2097 </span>            :     else
<span class="lineNum">    2098 </span><span class="lineNoCov">          0 :       nSymbolId = msGetSymbolIndex(&amp;map-&gt;symbolset,</span>
<span class="lineNum">    2099 </span>            :                                    SLD_MARK_SYMBOL_X,
<span class="lineNum">    2100 </span>            :                                    MS_FALSE);
<span class="lineNum">    2101 </span>            :   } else {
<span class="lineNum">    2102 </span><span class="lineNoCov">          0 :     nSymbolId = msGetSymbolIndex(&amp;map-&gt;symbolset,</span>
<span class="lineNum">    2103 </span>            :                                  pszSymbolName,
<span class="lineNum">    2104 </span>            :                                  MS_FALSE);
<span class="lineNum">    2105 </span>            :   }
<span class="lineNum">    2106 </span>            : 
<span class="lineNum">    2107 </span><span class="lineCov">          1 :   if (nSymbolId &lt;= 0) {</span>
<span class="lineNum">    2108 </span><span class="lineCov">          1 :     if( (psSymbol = msGrowSymbolSet(&amp;(map-&gt;symbolset))) == NULL)</span>
<span class="lineNum">    2109 </span>            :       return 0; /* returns 0 for no symbol */
<span class="lineNum">    2110 </span>            : 
<span class="lineNum">    2111 </span><span class="lineCov">          1 :     nSymbolId = map-&gt;symbolset.numsymbols;</span>
<span class="lineNum">    2112 </span><span class="lineCov">          1 :     map-&gt;symbolset.numsymbols++;</span>
<span class="lineNum">    2113 </span><span class="lineCov">          1 :     initSymbol(psSymbol);</span>
<span class="lineNum">    2114 </span><span class="lineCov">          1 :     psSymbol-&gt;inmapfile = MS_TRUE;</span>
<span class="lineNum">    2115 </span><span class="lineCov">          1 :     psSymbol-&gt;sizex = 1;</span>
<span class="lineNum">    2116 </span><span class="lineCov">          1 :     psSymbol-&gt;sizey = 1;</span>
<span class="lineNum">    2117 </span>            : 
<span class="lineNum">    2118 </span><span class="lineCov">          1 :     if (strcasecmp(pszSymbolName, &quot;square&quot;) == 0) {</span>
<span class="lineNum">    2119 </span><span class="lineNoCov">          0 :       if (bFilled)</span>
<span class="lineNum">    2120 </span><span class="lineNoCov">          0 :         psSymbol-&gt;name = msStrdup(SLD_MARK_SYMBOL_SQUARE_FILLED);</span>
<span class="lineNum">    2121 </span>            :       else
<span class="lineNum">    2122 </span><span class="lineNoCov">          0 :         psSymbol-&gt;name = msStrdup(SLD_MARK_SYMBOL_SQUARE);</span>
<span class="lineNum">    2123 </span>            : 
<span class="lineNum">    2124 </span><span class="lineNoCov">          0 :       psSymbol-&gt;type = MS_SYMBOL_VECTOR;</span>
<span class="lineNum">    2125 </span><span class="lineNoCov">          0 :       if (bFilled)</span>
<span class="lineNum">    2126 </span><span class="lineNoCov">          0 :         psSymbol-&gt;filled = MS_TRUE;</span>
<span class="lineNum">    2127 </span><span class="lineNoCov">          0 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].x = 0;</span>
<span class="lineNum">    2128 </span><span class="lineNoCov">          0 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].y = 1;</span>
<span class="lineNum">    2129 </span><span class="lineNoCov">          0 :       psSymbol-&gt;numpoints++;</span>
<span class="lineNum">    2130 </span><span class="lineNoCov">          0 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].x = 0;</span>
<span class="lineNum">    2131 </span><span class="lineNoCov">          0 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].y = 0;</span>
<span class="lineNum">    2132 </span><span class="lineNoCov">          0 :       psSymbol-&gt;numpoints++;</span>
<span class="lineNum">    2133 </span><span class="lineNoCov">          0 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].x = 1;</span>
<span class="lineNum">    2134 </span><span class="lineNoCov">          0 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].y = 0;</span>
<span class="lineNum">    2135 </span><span class="lineNoCov">          0 :       psSymbol-&gt;numpoints++;</span>
<span class="lineNum">    2136 </span><span class="lineNoCov">          0 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].x = 1;</span>
<span class="lineNum">    2137 </span><span class="lineNoCov">          0 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].y = 1;</span>
<span class="lineNum">    2138 </span><span class="lineNoCov">          0 :       psSymbol-&gt;numpoints++;</span>
<span class="lineNum">    2139 </span><span class="lineNoCov">          0 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].x = 0;</span>
<span class="lineNum">    2140 </span><span class="lineNoCov">          0 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].y = 1;</span>
<span class="lineNum">    2141 </span><span class="lineNoCov">          0 :       psSymbol-&gt;numpoints++;</span>
<span class="lineNum">    2142 </span><span class="lineCov">          1 :     } else if (strcasecmp(pszSymbolName, &quot;circle&quot;) == 0) {</span>
<span class="lineNum">    2143 </span><span class="lineCov">          1 :       if (bFilled)</span>
<span class="lineNum">    2144 </span><span class="lineCov">          1 :         psSymbol-&gt;name = msStrdup(SLD_MARK_SYMBOL_CIRCLE_FILLED);</span>
<span class="lineNum">    2145 </span>            :       else
<span class="lineNum">    2146 </span><span class="lineCov">          1 :         psSymbol-&gt;name = msStrdup(SLD_MARK_SYMBOL_CIRCLE);</span>
<span class="lineNum">    2147 </span>            : 
<span class="lineNum">    2148 </span><span class="lineCov">          1 :       psSymbol-&gt;type = MS_SYMBOL_ELLIPSE;</span>
<span class="lineNum">    2149 </span><span class="lineCov">          1 :       if (bFilled)</span>
<span class="lineNum">    2150 </span><span class="lineCov">          1 :         psSymbol-&gt;filled = MS_TRUE;</span>
<span class="lineNum">    2151 </span>            : 
<span class="lineNum">    2152 </span><span class="lineCov">          1 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].x = 1;</span>
<span class="lineNum">    2153 </span><span class="lineCov">          1 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].y = 1;</span>
<span class="lineNum">    2154 </span><span class="lineCov">          1 :       psSymbol-&gt;sizex = 1;</span>
<span class="lineNum">    2155 </span><span class="lineCov">          1 :       psSymbol-&gt;sizey = 1;</span>
<span class="lineNum">    2156 </span><span class="lineCov">          1 :       psSymbol-&gt;numpoints++;</span>
<span class="lineNum">    2157 </span><span class="lineCov">          1 :     } else if (strcasecmp(pszSymbolName, &quot;triangle&quot;) == 0) {</span>
<span class="lineNum">    2158 </span><span class="lineNoCov">          0 :       if (bFilled)</span>
<span class="lineNum">    2159 </span><span class="lineNoCov">          0 :         psSymbol-&gt;name = msStrdup(SLD_MARK_SYMBOL_TRIANGLE_FILLED);</span>
<span class="lineNum">    2160 </span>            :       else
<span class="lineNum">    2161 </span><span class="lineNoCov">          0 :         psSymbol-&gt;name = msStrdup(SLD_MARK_SYMBOL_TRIANGLE);</span>
<span class="lineNum">    2162 </span>            : 
<span class="lineNum">    2163 </span><span class="lineNoCov">          0 :       psSymbol-&gt;type = MS_SYMBOL_VECTOR;</span>
<span class="lineNum">    2164 </span><span class="lineNoCov">          0 :       if (bFilled)</span>
<span class="lineNum">    2165 </span><span class="lineNoCov">          0 :         psSymbol-&gt;filled = MS_TRUE;</span>
<span class="lineNum">    2166 </span>            : 
<span class="lineNum">    2167 </span><span class="lineNoCov">          0 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].x = 0;</span>
<span class="lineNum">    2168 </span><span class="lineNoCov">          0 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].y = 1;</span>
<span class="lineNum">    2169 </span><span class="lineNoCov">          0 :       psSymbol-&gt;numpoints++;</span>
<span class="lineNum">    2170 </span><span class="lineNoCov">          0 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].x = 0.5;</span>
<span class="lineNum">    2171 </span><span class="lineNoCov">          0 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].y = 0;</span>
<span class="lineNum">    2172 </span><span class="lineNoCov">          0 :       psSymbol-&gt;numpoints++;</span>
<span class="lineNum">    2173 </span><span class="lineNoCov">          0 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].x = 1;</span>
<span class="lineNum">    2174 </span><span class="lineNoCov">          0 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].y = 1;</span>
<span class="lineNum">    2175 </span><span class="lineNoCov">          0 :       psSymbol-&gt;numpoints++;</span>
<span class="lineNum">    2176 </span><span class="lineNoCov">          0 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].x = 0;</span>
<span class="lineNum">    2177 </span><span class="lineNoCov">          0 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].y = 1;</span>
<span class="lineNum">    2178 </span><span class="lineNoCov">          0 :       psSymbol-&gt;numpoints++;</span>
<span class="lineNum">    2179 </span>            : 
<span class="lineNum">    2180 </span><span class="lineCov">          1 :     } else if (strcasecmp(pszSymbolName, &quot;star&quot;) == 0) {</span>
<span class="lineNum">    2181 </span><span class="lineCov">          1 :       if (bFilled)</span>
<span class="lineNum">    2182 </span><span class="lineCov">          1 :         psSymbol-&gt;name = msStrdup(SLD_MARK_SYMBOL_STAR_FILLED);</span>
<span class="lineNum">    2183 </span>            :       else
<span class="lineNum">    2184 </span><span class="lineNoCov">          0 :         psSymbol-&gt;name = msStrdup(SLD_MARK_SYMBOL_STAR);</span>
<span class="lineNum">    2185 </span>            : 
<span class="lineNum">    2186 </span><span class="lineCov">          1 :       psSymbol-&gt;type = MS_SYMBOL_VECTOR;</span>
<span class="lineNum">    2187 </span><span class="lineCov">          1 :       if (bFilled)</span>
<span class="lineNum">    2188 </span><span class="lineCov">          1 :         psSymbol-&gt;filled = MS_TRUE;</span>
<span class="lineNum">    2189 </span>            : 
<span class="lineNum">    2190 </span><span class="lineCov">          1 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].x = 0;</span>
<span class="lineNum">    2191 </span><span class="lineCov">          1 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].y = 0.375;</span>
<span class="lineNum">    2192 </span><span class="lineCov">          1 :       psSymbol-&gt;numpoints++;</span>
<span class="lineNum">    2193 </span><span class="lineCov">          1 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].x = 0.35;</span>
<span class="lineNum">    2194 </span><span class="lineCov">          1 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].y = 0.375;</span>
<span class="lineNum">    2195 </span><span class="lineCov">          1 :       psSymbol-&gt;numpoints++;</span>
<span class="lineNum">    2196 </span><span class="lineCov">          1 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].x = 0.5;</span>
<span class="lineNum">    2197 </span><span class="lineCov">          1 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].y = 0;</span>
<span class="lineNum">    2198 </span><span class="lineCov">          1 :       psSymbol-&gt;numpoints++;</span>
<span class="lineNum">    2199 </span><span class="lineCov">          1 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].x = 0.65;</span>
<span class="lineNum">    2200 </span><span class="lineCov">          1 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].y = 0.375;</span>
<span class="lineNum">    2201 </span><span class="lineCov">          1 :       psSymbol-&gt;numpoints++;</span>
<span class="lineNum">    2202 </span><span class="lineCov">          1 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].x = 1;</span>
<span class="lineNum">    2203 </span><span class="lineCov">          1 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].y = 0.375;</span>
<span class="lineNum">    2204 </span><span class="lineCov">          1 :       psSymbol-&gt;numpoints++;</span>
<span class="lineNum">    2205 </span><span class="lineCov">          1 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].x = 0.75;</span>
<span class="lineNum">    2206 </span><span class="lineCov">          1 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].y = 0.625;</span>
<span class="lineNum">    2207 </span><span class="lineCov">          1 :       psSymbol-&gt;numpoints++;</span>
<span class="lineNum">    2208 </span><span class="lineCov">          1 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].x = 0.875;</span>
<span class="lineNum">    2209 </span><span class="lineCov">          1 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].y = 1;</span>
<span class="lineNum">    2210 </span><span class="lineCov">          1 :       psSymbol-&gt;numpoints++;</span>
<span class="lineNum">    2211 </span><span class="lineCov">          1 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].x = 0.5;</span>
<span class="lineNum">    2212 </span><span class="lineCov">          1 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].y = 0.75;</span>
<span class="lineNum">    2213 </span><span class="lineCov">          1 :       psSymbol-&gt;numpoints++;</span>
<span class="lineNum">    2214 </span><span class="lineCov">          1 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].x = 0.125;</span>
<span class="lineNum">    2215 </span><span class="lineCov">          1 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].y = 1;</span>
<span class="lineNum">    2216 </span><span class="lineCov">          1 :       psSymbol-&gt;numpoints++;</span>
<span class="lineNum">    2217 </span><span class="lineCov">          1 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].x = 0.25;</span>
<span class="lineNum">    2218 </span><span class="lineCov">          1 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].y = 0.625;</span>
<span class="lineNum">    2219 </span><span class="lineCov">          1 :       psSymbol-&gt;numpoints++;</span>
<span class="lineNum">    2220 </span>            :     }
<span class="lineNum">    2221 </span>            :     /* cross is like plus (+) since there is also X symbol ?? */
<span class="lineNum">    2222 </span><span class="lineNoCov">          0 :     else if (strcasecmp(pszSymbolName, &quot;cross&quot;) == 0) {</span>
<span class="lineNum">    2223 </span>            :       /* NEVER FILL CROSS */
<span class="lineNum">    2224 </span>            :       /* if (bFilled) */
<span class="lineNum">    2225 </span>            :       /* psSymbol-&gt;name = msStrdup(SLD_MARK_SYMBOL_CROSS_FILLED); */
<span class="lineNum">    2226 </span>            :       /* else */
<span class="lineNum">    2227 </span><span class="lineNoCov">          0 :       psSymbol-&gt;name = msStrdup(SLD_MARK_SYMBOL_CROSS);</span>
<span class="lineNum">    2228 </span>            : 
<span class="lineNum">    2229 </span><span class="lineNoCov">          0 :       psSymbol-&gt;type = MS_SYMBOL_VECTOR;</span>
<span class="lineNum">    2230 </span>            :       /* if (bFilled) */
<span class="lineNum">    2231 </span>            :       /* psSymbol-&gt;filled = MS_TRUE; */
<span class="lineNum">    2232 </span>            : 
<span class="lineNum">    2233 </span><span class="lineNoCov">          0 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].x = 0.5;</span>
<span class="lineNum">    2234 </span><span class="lineNoCov">          0 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].y = 0;</span>
<span class="lineNum">    2235 </span><span class="lineNoCov">          0 :       psSymbol-&gt;numpoints++;</span>
<span class="lineNum">    2236 </span><span class="lineNoCov">          0 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].x = 0.5;</span>
<span class="lineNum">    2237 </span><span class="lineNoCov">          0 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].y = 1;</span>
<span class="lineNum">    2238 </span><span class="lineNoCov">          0 :       psSymbol-&gt;numpoints++;</span>
<span class="lineNum">    2239 </span><span class="lineNoCov">          0 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].x = -99;</span>
<span class="lineNum">    2240 </span><span class="lineNoCov">          0 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].y = -99;</span>
<span class="lineNum">    2241 </span><span class="lineNoCov">          0 :       psSymbol-&gt;numpoints++;</span>
<span class="lineNum">    2242 </span><span class="lineNoCov">          0 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].x = 0;</span>
<span class="lineNum">    2243 </span><span class="lineNoCov">          0 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].y = 0.5;</span>
<span class="lineNum">    2244 </span><span class="lineNoCov">          0 :       psSymbol-&gt;numpoints++;</span>
<span class="lineNum">    2245 </span><span class="lineNoCov">          0 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].x = 1;</span>
<span class="lineNum">    2246 </span><span class="lineNoCov">          0 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].y = 0.5;</span>
<span class="lineNum">    2247 </span><span class="lineNoCov">          0 :       psSymbol-&gt;numpoints++;</span>
<span class="lineNum">    2248 </span><span class="lineNoCov">          0 :     } else if (strcasecmp(pszSymbolName, &quot;x&quot;) == 0) {</span>
<span class="lineNum">    2249 </span>            :       /* NEVER FILL X */
<span class="lineNum">    2250 </span>            :       /* if (bFilled) */
<span class="lineNum">    2251 </span>            :       /* psSymbol-&gt;name = msStrdup(SLD_MARK_SYMBOL_X_FILLED); */
<span class="lineNum">    2252 </span>            :       /* else */
<span class="lineNum">    2253 </span><span class="lineNoCov">          0 :       psSymbol-&gt;name = msStrdup(SLD_MARK_SYMBOL_X);</span>
<span class="lineNum">    2254 </span>            : 
<span class="lineNum">    2255 </span><span class="lineNoCov">          0 :       psSymbol-&gt;type = MS_SYMBOL_VECTOR;</span>
<span class="lineNum">    2256 </span>            :       /* if (bFilled) */
<span class="lineNum">    2257 </span>            :       /* psSymbol-&gt;filled = MS_TRUE; */
<span class="lineNum">    2258 </span><span class="lineNoCov">          0 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].x = 0;</span>
<span class="lineNum">    2259 </span><span class="lineNoCov">          0 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].y = 0;</span>
<span class="lineNum">    2260 </span><span class="lineNoCov">          0 :       psSymbol-&gt;numpoints++;</span>
<span class="lineNum">    2261 </span><span class="lineNoCov">          0 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].x = 1;</span>
<span class="lineNum">    2262 </span><span class="lineNoCov">          0 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].y = 1;</span>
<span class="lineNum">    2263 </span><span class="lineNoCov">          0 :       psSymbol-&gt;numpoints++;</span>
<span class="lineNum">    2264 </span><span class="lineNoCov">          0 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].x = -99;</span>
<span class="lineNum">    2265 </span><span class="lineNoCov">          0 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].y = -99;</span>
<span class="lineNum">    2266 </span><span class="lineNoCov">          0 :       psSymbol-&gt;numpoints++;</span>
<span class="lineNum">    2267 </span><span class="lineNoCov">          0 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].x = 0;</span>
<span class="lineNum">    2268 </span><span class="lineNoCov">          0 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].y = 1;</span>
<span class="lineNum">    2269 </span><span class="lineNoCov">          0 :       psSymbol-&gt;numpoints++;</span>
<span class="lineNum">    2270 </span><span class="lineNoCov">          0 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].x = 1;</span>
<span class="lineNum">    2271 </span><span class="lineNoCov">          0 :       psSymbol-&gt;points[psSymbol-&gt;numpoints].y = 0;</span>
<span class="lineNum">    2272 </span><span class="lineNoCov">          0 :       psSymbol-&gt;numpoints++;</span>
<span class="lineNum">    2273 </span>            :     }
<span class="lineNum">    2274 </span>            : 
<span class="lineNum">    2275 </span>            :   }
<span class="lineNum">    2276 </span>            : 
<span class="lineNum">    2277 </span>            :   return nSymbolId;
<span class="lineNum">    2278 </span>            : }
<span class="lineNum">    2279 </span>            : 
<span class="lineNum">    2280 </span>            : /************************************************************************/
<span class="lineNum">    2281 </span>            : /*                          msSLDGetGraphicSymbol                       */
<span class="lineNum">    2282 </span>            : /*                                                                      */
<span class="lineNum">    2283 </span>            : /*      Create a symbol entry for an inmap pixmap symbol. Returns       */
<a name="2284"><span class="lineNum">    2284 </span>            : /*      the symbol id.                                                  */</a>
<span class="lineNum">    2285 </span>            : /************************************************************************/
<span class="lineNum">    2286 </span><span class="lineNoCov">          0 : int msSLDGetGraphicSymbol(mapObj *map, char *pszFileName,  char* extGraphicName,</span>
<span class="lineNum">    2287 </span>            :                           int nGap)
<span class="lineNum">    2288 </span>            : {
<span class="lineNum">    2289 </span>            :   int nSymbolId = 0;
<span class="lineNum">    2290 </span>            :   symbolObj *psSymbol = NULL;
<span class="lineNum">    2291 </span>            : 
<span class="lineNum">    2292 </span>            : 
<span class="lineNum">    2293 </span><span class="lineNoCov">          0 :   if (map &amp;&amp; pszFileName) {</span>
<span class="lineNum">    2294 </span><span class="lineNoCov">          0 :     if( (psSymbol = msGrowSymbolSet(&amp;(map-&gt;symbolset))) == NULL)</span>
<span class="lineNum">    2295 </span>            :       return 0; /* returns 0 for no symbol */
<span class="lineNum">    2296 </span><span class="lineNoCov">          0 :     nSymbolId = map-&gt;symbolset.numsymbols;</span>
<span class="lineNum">    2297 </span><span class="lineNoCov">          0 :     map-&gt;symbolset.numsymbols++;</span>
<span class="lineNum">    2298 </span><span class="lineNoCov">          0 :     initSymbol(psSymbol);</span>
<span class="lineNum">    2299 </span><span class="lineNoCov">          0 :     psSymbol-&gt;inmapfile = MS_TRUE;</span>
<span class="lineNum">    2300 </span><span class="lineNoCov">          0 :     psSymbol-&gt;type = MS_SYMBOL_PIXMAP;</span>
<span class="lineNum">    2301 </span><span class="lineNoCov">          0 :     psSymbol-&gt;name = msStrdup(extGraphicName);</span>
<span class="lineNum">    2302 </span><span class="lineNoCov">          0 :     psSymbol-&gt;imagepath = msStrdup(pszFileName);</span>
<span class="lineNum">    2303 </span><span class="lineNoCov">          0 :     psSymbol-&gt;full_pixmap_path = msStrdup(pszFileName);</span>
<span class="lineNum">    2304 </span>            :   }
<span class="lineNum">    2305 </span>            :   return nSymbolId;
<span class="lineNum">    2306 </span>            : }
<span class="lineNum">    2307 </span>            : 
<span class="lineNum">    2308 </span>            : 
<span class="lineNum">    2309 </span>            : /************************************************************************/
<span class="lineNum">    2310 </span>            : /*      msSLDParsePointSymbolizer                                       */
<span class="lineNum">    2311 </span>            : /*                                                                      */
<span class="lineNum">    2312 </span>            : /*      Parse point symbolizer.                                         */
<span class="lineNum">    2313 </span>            : /*                                                                      */
<span class="lineNum">    2314 </span>            : /*      &lt;xs:element name=&quot;PointSymbolizer&quot;&gt;                             */
<span class="lineNum">    2315 </span>            : /*      &lt;xs:complexType&gt;                                                */
<span class="lineNum">    2316 </span>            : /*      &lt;xs:sequence&gt;                                                   */
<span class="lineNum">    2317 </span>            : /*      &lt;xs:element ref=&quot;sld:Geometry&quot; minOccurs=&quot;0&quot;/&gt;                  */
<span class="lineNum">    2318 </span>            : /*      &lt;xs:element ref=&quot;sld:Graphic&quot; minOccurs=&quot;0&quot;/&gt;                   */
<span class="lineNum">    2319 </span>            : /*      &lt;/xs:sequence&gt;                                                  */
<span class="lineNum">    2320 </span>            : /*      &lt;/xs:complexType&gt;                                               */
<a name="2321"><span class="lineNum">    2321 </span>            : /*      &lt;/xs:element&gt;                                                   */</a>
<span class="lineNum">    2322 </span>            : /************************************************************************/
<span class="lineNum">    2323 </span><span class="lineCov">          1 : int msSLDParsePointSymbolizer(CPLXMLNode *psRoot, layerObj *psLayer,</span>
<span class="lineNum">    2324 </span>            :                               int bNewClass, const char* pszUserStyleName)
<span class="lineNum">    2325 </span>            : {
<span class="lineNum">    2326 </span>            :   int nClassId = 0;
<span class="lineNum">    2327 </span>            :   int iStyle = 0;
<span class="lineNum">    2328 </span>            : 
<span class="lineNum">    2329 </span><span class="lineCov">          1 :   if (!psRoot || !psLayer)</span>
<span class="lineNum">    2330 </span>            :     return MS_FAILURE;
<span class="lineNum">    2331 </span>            : 
<span class="lineNum">    2332 </span><span class="lineCov">          1 :   nClassId = getClassId(psLayer, bNewClass, pszUserStyleName);</span>
<span class="lineNum">    2333 </span><span class="lineCov">          1 :   if( nClassId &lt; 0 )</span>
<span class="lineNum">    2334 </span>            :     return MS_FAILURE;
<span class="lineNum">    2335 </span>            : 
<span class="lineNum">    2336 </span>            :   // Get uom if any, defaults to MS_PIXELS
<span class="lineNum">    2337 </span><span class="lineCov">          1 :   enum MS_UNITS sizeunits = MS_PIXELS;</span>
<span class="lineNum">    2338 </span><span class="lineCov">          1 :   if (msSLDParseUomAttribute(psRoot, &amp;sizeunits) != MS_SUCCESS)</span>
<span class="lineNum">    2339 </span>            :   {
<span class="lineNum">    2340 </span><span class="lineNoCov">          0 :     msSetError(MS_WMSERR, &quot;Invalid uom attribute value.&quot;, &quot;msSLDParsePolygonSymbolizer()&quot;);</span>
<span class="lineNum">    2341 </span><span class="lineNoCov">          0 :     return MS_FAILURE;</span>
<span class="lineNum">    2342 </span>            :   }
<span class="lineNum">    2343 </span>            : 
<span class="lineNum">    2344 </span><span class="lineCov">          1 :   iStyle = psLayer-&gt;class[nClassId]-&gt;numstyles;</span>
<span class="lineNum">    2345 </span><span class="lineCov">          1 :   msMaybeAllocateClassStyle(psLayer-&gt;class[nClassId], iStyle);</span>
<span class="lineNum">    2346 </span><span class="lineCov">          1 :   psLayer-&gt;class[nClassId]-&gt;styles[iStyle]-&gt;sizeunits = sizeunits;</span>
<span class="lineNum">    2347 </span>            : 
<span class="lineNum">    2348 </span><span class="lineCov">          1 :   msSLDParseGraphicFillOrStroke(psRoot, NULL,</span>
<span class="lineNum">    2349 </span>            :                                 psLayer-&gt;class[nClassId]-&gt;styles[iStyle],
<span class="lineNum">    2350 </span><span class="lineCov">          1 :                                 psLayer-&gt;map);</span>
<span class="lineNum">    2351 </span>            : 
<span class="lineNum">    2352 </span><span class="lineCov">          1 :   return MS_SUCCESS;</span>
<span class="lineNum">    2353 </span>            : }
<span class="lineNum">    2354 </span>            : 
<span class="lineNum">    2355 </span>            : 
<span class="lineNum">    2356 </span>            : /************************************************************************/
<span class="lineNum">    2357 </span>            : /*                        msSLDParseExternalGraphic                     */
<span class="lineNum">    2358 </span>            : /*                                                                      */
<span class="lineNum">    2359 </span>            : /*      Parse external graphic node : download the symbol referenced    */
<span class="lineNum">    2360 </span>            : /*      by the URL and create a PIXMAP inmap symbol. Only GIF and       */
<a name="2361"><span class="lineNum">    2361 </span>            : /*      PNG are supported.                                              */</a>
<span class="lineNum">    2362 </span>            : /************************************************************************/
<span class="lineNum">    2363 </span><span class="lineCov">          1 : int msSLDParseExternalGraphic(CPLXMLNode *psExternalGraphic,</span>
<span class="lineNum">    2364 </span>            :                               styleObj *psStyle,  mapObj *map)
<span class="lineNum">    2365 </span>            : {
<span class="lineNum">    2366 </span>            :   char *pszFormat = NULL;
<span class="lineNum">    2367 </span>            :   CPLXMLNode *psURL=NULL, *psFormat=NULL, *psTmp=NULL;
<span class="lineNum">    2368 </span>            :   char *pszURL=NULL;
<span class="lineNum">    2369 </span>            : 
<span class="lineNum">    2370 </span><span class="lineCov">          1 :   if (!psExternalGraphic || !psStyle || !map)</span>
<span class="lineNum">    2371 </span>            :     return MS_FAILURE;
<span class="lineNum">    2372 </span>            : 
<span class="lineNum">    2373 </span><span class="lineCov">          1 :   psFormat = CPLGetXMLNode(psExternalGraphic, &quot;Format&quot;);</span>
<span class="lineNum">    2374 </span><span class="lineCov">          1 :   if (psFormat &amp;&amp; psFormat-&gt;psChild &amp;&amp; psFormat-&gt;psChild-&gt;pszValue)</span>
<span class="lineNum">    2375 </span>            :     pszFormat = psFormat-&gt;psChild-&gt;pszValue;
<span class="lineNum">    2376 </span>            : 
<span class="lineNum">    2377 </span>            :   /* supports GIF and PNG and SVG */
<span class="lineNum">    2378 </span><span class="lineCov">          1 :   if (pszFormat &amp;&amp;</span>
<span class="lineNum">    2379 </span><span class="lineCov">          1 :       (strcasecmp(pszFormat, &quot;GIF&quot;) == 0 ||</span>
<span class="lineNum">    2380 </span><span class="lineCov">          1 :        strcasecmp(pszFormat, &quot;image/gif&quot;) == 0 ||</span>
<span class="lineNum">    2381 </span><span class="lineCov">          1 :        strcasecmp(pszFormat, &quot;PNG&quot;) == 0 ||</span>
<span class="lineNum">    2382 </span><span class="lineCov">          1 :        strcasecmp(pszFormat, &quot;image/png&quot;) == 0 ||</span>
<span class="lineNum">    2383 </span><span class="lineCov">          1 :        strcasecmp(pszFormat, &quot;image/svg+xml&quot;) == 0)) {</span>
<span class="lineNum">    2384 </span>            : 
<span class="lineNum">    2385 </span>            :     /* &lt;OnlineResource xmlns:xlink=&quot;http://www.w3.org/1999/xlink&quot; xlink:type=&quot;simple&quot; xlink:href=&quot;http://www.vendor.com/geosym/2267.svg&quot;/&gt; */
<span class="lineNum">    2386 </span><span class="lineCov">          1 :     psURL = CPLGetXMLNode(psExternalGraphic, &quot;OnlineResource&quot;);</span>
<span class="lineNum">    2387 </span><span class="lineCov">          1 :     if (psURL &amp;&amp; psURL-&gt;psChild) {</span>
<span class="lineNum">    2388 </span>            :       psTmp =  psURL-&gt;psChild;
<span class="lineNum">    2389 </span><span class="lineCov">          1 :       while (psTmp != NULL &amp;&amp;</span>
<span class="lineNum">    2390 </span><span class="lineCov">          1 :              psTmp-&gt;pszValue &amp;&amp;</span>
<span class="lineNum">    2391 </span><span class="lineCov">          1 :              strcasecmp(psTmp-&gt;pszValue, &quot;xlink:href&quot;) != 0) {</span>
<span class="lineNum">    2392 </span><span class="lineCov">          1 :         psTmp = psTmp-&gt;psNext;</span>
<span class="lineNum">    2393 </span>            :       }
<span class="lineNum">    2394 </span><span class="lineCov">          1 :       if (psTmp &amp;&amp; psTmp-&gt;psChild) {</span>
<span class="lineNum">    2395 </span><span class="lineCov">          1 :         pszURL = (char*)psTmp-&gt;psChild-&gt;pszValue;</span>
<span class="lineNum">    2396 </span>            : 
<span class="lineNum">    2397 </span>            :         char *symbolurl = NULL;
<span class="lineNum">    2398 </span>            :         // Handle relative URL for ExternalGraphic
<span class="lineNum">    2399 </span><span class="lineCov">          1 :         if (map-&gt;sldurl &amp;&amp; !strstr(pszURL,&quot;://&quot;))</span>
<span class="lineNum">    2400 </span><span class="lineCov">          1 :         {</span>
<span class="lineNum">    2401 </span>            :           char *baseurl = NULL;
<span class="lineNum">    2402 </span>            :           char *relpath = NULL;
<span class="lineNum">    2403 </span><span class="lineCov">          1 :           symbolurl = malloc(sizeof(char)*MS_MAXPATHLEN);</span>
<span class="lineNum">    2404 </span><span class="lineCov">          1 :           if (pszURL[0] != '/') {</span>
<span class="lineNum">    2405 </span>            :             // Symbol file is relative to SLD file
<span class="lineNum">    2406 </span>            :             // e.g. SLD   : http://example.com/path/to/sld.xml
<span class="lineNum">    2407 </span>            :             //  and symbol: assets/symbol.svg
<span class="lineNum">    2408 </span>            :             //     lead to: http://example.com/path/to/assets/symbol.svg
<span class="lineNum">    2409 </span><span class="lineNoCov">          0 :             baseurl = msGetPath(map-&gt;sldurl);</span>
<span class="lineNum">    2410 </span>            :             relpath = pszURL;
<span class="lineNum">    2411 </span>            :           }
<span class="lineNum">    2412 </span>            :           else
<span class="lineNum">    2413 </span>            :           {
<span class="lineNum">    2414 </span>            :             // Symbol file is relative to the root of SLD server
<span class="lineNum">    2415 </span>            :             // e.g. SLD   : http://example.com/path/to/sld.xml
<span class="lineNum">    2416 </span>            :             //  and symbol: /path/to/assets/symbol.svg
<span class="lineNum">    2417 </span>            :             //     lead to: http://example.com/path/to/assets/symbol.svg
<span class="lineNum">    2418 </span><span class="lineCov">          1 :             baseurl = msStrdup(map-&gt;sldurl);</span>
<span class="lineNum">    2419 </span><span class="lineCov">          1 :             relpath = pszURL+1;</span>
<span class="lineNum">    2420 </span><span class="lineCov">          1 :             char * sep = strstr(baseurl,&quot;://&quot;);</span>
<span class="lineNum">    2421 </span><span class="lineCov">          1 :             if (sep)</span>
<span class="lineNum">    2422 </span><span class="lineCov">          1 :               sep += 3;</span>
<span class="lineNum">    2423 </span>            :             else
<span class="lineNum">    2424 </span>            :               sep = baseurl;
<span class="lineNum">    2425 </span><span class="lineCov">          1 :             sep = strchr(sep,'/');</span>
<span class="lineNum">    2426 </span><span class="lineCov">          1 :             if (!sep)</span>
<span class="lineNum">    2427 </span><span class="lineNoCov">          0 :               sep = baseurl + strlen(baseurl);</span>
<span class="lineNum">    2428 </span><span class="lineCov">          1 :             sep[1] = '\0';</span>
<span class="lineNum">    2429 </span>            :           }
<span class="lineNum">    2430 </span><span class="lineCov">          1 :           msBuildPath(symbolurl,baseurl,relpath);</span>
<span class="lineNum">    2431 </span><span class="lineCov">          1 :           msFree(baseurl);</span>
<span class="lineNum">    2432 </span>            :         }
<span class="lineNum">    2433 </span>            :         else
<span class="lineNum">    2434 </span>            :         {
<span class="lineNum">    2435 </span>            :           // Absolute URL
<span class="lineNum">    2436 </span>            :           // e.g. symbol: http://example.com/path/to/assets/symbol.svg
<span class="lineNum">    2437 </span><span class="lineCov">          1 :           symbolurl = msStrdup(pszURL);</span>
<span class="lineNum">    2438 </span>            :         }
<span class="lineNum">    2439 </span>            : 
<span class="lineNum">    2440 </span>            :         /* validate the ExternalGraphic parameter */
<span class="lineNum">    2441 </span><span class="lineCov">          1 :         if(msValidateParameter(symbolurl, msLookupHashTable(&amp;(map-&gt;web.validation), &quot;sld_external_graphic&quot;),</span>
<span class="lineNum">    2442 </span>            :                                NULL, NULL, NULL) != MS_SUCCESS) {
<span class="lineNum">    2443 </span><span class="lineCov">          1 :           msSetError(MS_WEBERR, &quot;SLD ExternalGraphic OnlineResource value fails to validate against sld_external_graphic VALIDATION&quot;, &quot;mapserv()&quot;);</span>
<span class="lineNum">    2444 </span><span class="lineCov">          1 :           msFree(symbolurl);</span>
<span class="lineNum">    2445 </span><span class="lineCov">          1 :           return MS_FAILURE;</span>
<span class="lineNum">    2446 </span>            :         }
<span class="lineNum">    2447 </span>            : 
<span class="lineNum">    2448 </span>            : 
<span class="lineNum">    2449 </span>            :         /*external symbols using http will be automaticallly downloaded. The file should be
<span class="lineNum">    2450 </span>            :           saved in a temporary directory (msAddImageSymbol) #2305*/
<span class="lineNum">    2451 </span><span class="lineCov">          1 :         psStyle-&gt;symbol = msGetSymbolIndex(&amp;map-&gt;symbolset,</span>
<span class="lineNum">    2452 </span>            :                                            symbolurl,
<span class="lineNum">    2453 </span>            :                                            MS_TRUE);
<span class="lineNum">    2454 </span><span class="lineCov">          1 :         msFree(symbolurl);</span>
<span class="lineNum">    2455 </span>            : 
<span class="lineNum">    2456 </span><span class="lineCov">          1 :         if (psStyle-&gt;symbol &gt; 0 &amp;&amp; psStyle-&gt;symbol &lt; map-&gt;symbolset.numsymbols)</span>
<span class="lineNum">    2457 </span><span class="lineCov">          1 :           psStyle-&gt;symbolname = msStrdup(map-&gt;symbolset.symbol[psStyle-&gt;symbol]-&gt;name);</span>
<span class="lineNum">    2458 </span>            : 
<span class="lineNum">    2459 </span>            :         /* set the color parameter if not set. Does not make sense */
<span class="lineNum">    2460 </span>            :         /* for pixmap but mapserver needs it. */
<span class="lineNum">    2461 </span><span class="lineCov">          1 :         if (psStyle-&gt;color.red == -1 || psStyle-&gt;color.green || psStyle-&gt;color.blue) {</span>
<span class="lineNum">    2462 </span><span class="lineCov">          1 :           psStyle-&gt;color.red = 0;</span>
<span class="lineNum">    2463 </span><span class="lineCov">          1 :           psStyle-&gt;color.green = 0;</span>
<span class="lineNum">    2464 </span><span class="lineCov">          1 :           psStyle-&gt;color.blue = 0;</span>
<span class="lineNum">    2465 </span>            :         }
<span class="lineNum">    2466 </span>            :       }
<span class="lineNum">    2467 </span>            :     }
<span class="lineNum">    2468 </span>            :   }
<span class="lineNum">    2469 </span>            : 
<span class="lineNum">    2470 </span>            :   return MS_SUCCESS;
<span class="lineNum">    2471 </span>            : }
<span class="lineNum">    2472 </span>            : 
<span class="lineNum">    2473 </span>            : 
<span class="lineNum">    2474 </span>            : /************************************************************************/
<span class="lineNum">    2475 </span>            : /*                         msSLDParseTextSymbolizer                     */
<span class="lineNum">    2476 </span>            : /*                                                                      */
<span class="lineNum">    2477 </span>            : /*      Parse text symbolizer.                                          */
<span class="lineNum">    2478 </span>            : /*                                                                      */
<span class="lineNum">    2479 </span>            : /*      &lt;xs:element name=&quot;TextSymbolizer&quot;&gt;                              */
<span class="lineNum">    2480 </span>            : /*      &lt;xs:complexType&gt;                                                */
<span class="lineNum">    2481 </span>            : /*      &lt;xs:sequence&gt;                                                   */
<span class="lineNum">    2482 </span>            : /*      &lt;xs:element ref=&quot;sld:Geometry&quot; minOccurs=&quot;0&quot;/&gt;                  */
<span class="lineNum">    2483 </span>            : /*      &lt;xs:element ref=&quot;sld:Label&quot; minOccurs=&quot;0&quot;/&gt;                     */
<span class="lineNum">    2484 </span>            : /*      &lt;xs:element ref=&quot;sld:Font&quot; minOccurs=&quot;0&quot;/&gt;                      */
<span class="lineNum">    2485 </span>            : /*      &lt;xs:element ref=&quot;sld:LabelPlacement&quot; minOccurs=&quot;0&quot;/&gt;            */
<span class="lineNum">    2486 </span>            : /*      &lt;xs:element ref=&quot;sld:Halo&quot; minOccurs=&quot;0&quot;/&gt;                      */
<span class="lineNum">    2487 </span>            : /*      &lt;xs:element ref=&quot;sld:Fill&quot; minOccurs=&quot;0&quot;/&gt;                      */
<span class="lineNum">    2488 </span>            : /*      &lt;/xs:sequence&gt;                                                  */
<span class="lineNum">    2489 </span>            : /*      &lt;/xs:complexType&gt;                                               */
<span class="lineNum">    2490 </span>            : /*      &lt;/xs:element&gt;                                                   */
<span class="lineNum">    2491 </span>            : /*                                                                      */
<span class="lineNum">    2492 </span>            : /*      &lt;xs:element name=&quot;Label&quot; type=&quot;sld:ParameterValueType&quot;/         */
<span class="lineNum">    2493 </span>            : /*                                                                      */
<span class="lineNum">    2494 </span>            : /*      &lt;xs:element name=&quot;Font&quot;&gt;                                        */
<span class="lineNum">    2495 </span>            : /*      &lt;xs:complexType&gt;                                                */
<span class="lineNum">    2496 </span>            : /*      &lt;xs:sequence&gt;                                                   */
<span class="lineNum">    2497 </span>            : /*      &lt;xs:element ref=&quot;sld:CssParameter&quot; minOccurs=&quot;0&quot;                */
<span class="lineNum">    2498 </span>            : /*      maxOccurs=&quot;unbounded&quot;/&gt;                                         */
<span class="lineNum">    2499 </span>            : /*      &lt;/xs:sequence&gt;                                                  */
<span class="lineNum">    2500 </span>            : /*      &lt;/xs:complexType&gt;                                               */
<span class="lineNum">    2501 </span>            : /*      &lt;/xs:element&gt;                                                   */
<span class="lineNum">    2502 </span>            : /*                                                                      */
<span class="lineNum">    2503 </span>            : /*      Four types of CssParameter are allowed, font-family, font-style,*/
<span class="lineNum">    2504 </span>            : /*      fontweight,and font-size.                                       */
<span class="lineNum">    2505 </span>            : /*                                                                      */
<span class="lineNum">    2506 </span>            : /*      &lt;xs:element name=&quot;LabelPlacement&quot;&gt;                              */
<span class="lineNum">    2507 </span>            : /*      &lt;xs:complexType&gt;                                                */
<span class="lineNum">    2508 </span>            : /*      &lt;xs:choice&gt;                                                     */
<span class="lineNum">    2509 </span>            : /*      &lt;xs:element ref=&quot;sld:PointPlacement&quot;/&gt;                          */
<span class="lineNum">    2510 </span>            : /*      &lt;xs:element ref=&quot;sld:LinePlacement&quot;/&gt;                           */
<span class="lineNum">    2511 </span>            : /*      &lt;/xs:choice&gt;                                                    */
<span class="lineNum">    2512 </span>            : /*      &lt;/xs:complexType&gt;                                               */
<span class="lineNum">    2513 </span>            : /*      &lt;/xs:element&gt;                                                   */
<span class="lineNum">    2514 </span>            : /*                                                                      */
<span class="lineNum">    2515 </span>            : /*      &lt;xs:element name=&quot;PointPlacement&quot;&gt;                              */
<span class="lineNum">    2516 </span>            : /*      &lt;xs:complexType&gt;                                                */
<span class="lineNum">    2517 </span>            : /*      &lt;xs:sequence&gt;                                                   */
<span class="lineNum">    2518 </span>            : /*      &lt;xs:element ref=&quot;sld:AnchorPoint&quot; minOccurs=&quot;0&quot;/&gt;               */
<span class="lineNum">    2519 </span>            : /*      &lt;xs:element ref=&quot;sld:Displacement&quot; minOccurs=&quot;0&quot;/&gt;              */
<span class="lineNum">    2520 </span>            : /*      &lt;xs:element ref=&quot;sld:Rotation&quot; minOccurs=&quot;0&quot;/&gt;                  */
<span class="lineNum">    2521 </span>            : /*      &lt;/xs:sequence&gt;                                                  */
<span class="lineNum">    2522 </span>            : /*      &lt;/xs:complexType&gt;                                               */
<span class="lineNum">    2523 </span>            : /*      &lt;/xs:element&gt;                                                   */
<span class="lineNum">    2524 </span>            : /*                                                                      */
<span class="lineNum">    2525 </span>            : /*      &lt;xs:element name=&quot;AnchorPoint&quot;&gt;                                 */
<span class="lineNum">    2526 </span>            : /*      &lt;xs:complexType&gt;                                                */
<span class="lineNum">    2527 </span>            : /*      &lt;xs:sequence&gt;                                                   */
<span class="lineNum">    2528 </span>            : /*      &lt;xs:element ref=&quot;sld:AnchorPointX&quot;/&gt;                            */
<span class="lineNum">    2529 </span>            : /*      &lt;xs:element ref=&quot;sld:AnchorPointY&quot;/&gt;                            */
<span class="lineNum">    2530 </span>            : /*      &lt;/xs:sequence&gt;                                                  */
<span class="lineNum">    2531 </span>            : /*      &lt;/xs:complexType&gt;                                               */
<span class="lineNum">    2532 </span>            : /*      &lt;/xs:element&gt;                                                   */
<span class="lineNum">    2533 </span>            : /*      &lt;xs:element name=&quot;AnchorPointX&quot; type=&quot;sld:ParameterValueType&quot;/&gt; */
<span class="lineNum">    2534 </span>            : /*      &lt;xs:element name=&quot;AnchorPointY&quot;                                 */
<span class="lineNum">    2535 </span>            : /*      type=&quot;sld:ParameterValueType&quot;/&gt;                                 */
<span class="lineNum">    2536 </span>            : /*                                                                      */
<span class="lineNum">    2537 </span>            : /*      The coordinates are given as two floating-point numbers in      */
<span class="lineNum">    2538 </span>            : /*      the AnchorPointX and AnchorPointY elements each with values     */
<span class="lineNum">    2539 </span>            : /*      between 0.0 and 1.0 inclusive. The bounding box of the label    */
<span class="lineNum">    2540 </span>            : /*      to be rendered is considered to be in a coorindate space        */
<span class="lineNum">    2541 </span>            : /*      from 0.0 (lowerleft corner) to 1.0 (upper-right corner), and    */
<span class="lineNum">    2542 </span>            : /*      the anchor position is specified as a point in  this            */
<span class="lineNum">    2543 </span>            : /*      space. The default point is X=0, Y=0.5, which is at the         */
<span class="lineNum">    2544 </span>            : /*      middle height of the lefthand side of the label.                */
<span class="lineNum">    2545 </span>            : /*                                                                      */
<span class="lineNum">    2546 </span>            : /*      &lt;xs:element name=&quot;Displacement&quot;&gt;                                */
<span class="lineNum">    2547 </span>            : /*      &lt;xs:complexType&gt;                                                */
<span class="lineNum">    2548 </span>            : /*      &lt;xs:sequence&gt;                                                   */
<span class="lineNum">    2549 </span>            : /*      &lt;xs:element ref=&quot;sld:DisplacementX&quot;/&gt;                           */
<span class="lineNum">    2550 </span>            : /*      &lt;xs:element ref=&quot;sld:DisplacementY&quot;/&gt;                           */
<span class="lineNum">    2551 </span>            : /*      &lt;/xs:sequence&gt;                                                  */
<span class="lineNum">    2552 </span>            : /*      &lt;/xs:complexType&gt;                                               */
<span class="lineNum">    2553 </span>            : /*      &lt;/xs:element&gt;                                                   */
<span class="lineNum">    2554 </span>            : /*      &lt;xs:element name=&quot;DisplacementX&quot; type=&quot;sld:ParameterValueType&quot;/&gt;*/
<span class="lineNum">    2555 </span>            : /*      &lt;xs:element name=&quot;DisplacementY&quot;                                */
<span class="lineNum">    2556 </span>            : /*      type=&quot;sld:ParameterValueType&quot;/&gt;                                 */
<span class="lineNum">    2557 </span>            : /*                                                                      */
<span class="lineNum">    2558 </span>            : /*      &lt;xs:element name=&quot;LinePlacement&quot;&gt;                               */
<span class="lineNum">    2559 </span>            : /*      &lt;xs:complexType&gt;                                                */
<span class="lineNum">    2560 </span>            : /*      &lt;xs:sequence&gt;                                                   */
<span class="lineNum">    2561 </span>            : /*      &lt;xs:element ref=&quot;sld:PerpendicularOffset&quot; minOccurs=&quot;0&quot;/&gt;       */
<span class="lineNum">    2562 </span>            : /*      &lt;/xs:sequence&gt;                                                  */
<span class="lineNum">    2563 </span>            : /*      &lt;/xs:complexType&gt;                                               */
<a name="2564"><span class="lineNum">    2564 </span>            : /*      &lt;/xs:element&gt;                                                   */</a>
<span class="lineNum">    2565 </span>            : /************************************************************************/
<span class="lineNum">    2566 </span><span class="lineCov">          1 : int msSLDParseTextSymbolizer(CPLXMLNode *psRoot, layerObj *psLayer,</span>
<span class="lineNum">    2567 </span>            :                              int bOtherSymboliser, const char* pszUserStyleName)
<span class="lineNum">    2568 </span>            : {
<span class="lineNum">    2569 </span>            :   int nStyleId=0, nClassId=0;
<span class="lineNum">    2570 </span>            : 
<span class="lineNum">    2571 </span><span class="lineCov">          1 :   if (!psRoot || !psLayer)</span>
<span class="lineNum">    2572 </span>            :     return MS_FAILURE;
<span class="lineNum">    2573 </span>            : 
<span class="lineNum">    2574 </span><span class="lineCov">          1 :   if (!bOtherSymboliser) {</span>
<span class="lineNum">    2575 </span><span class="lineCov">          1 :     if (msGrowLayerClasses(psLayer) == NULL)</span>
<span class="lineNum">    2576 </span>            :       return MS_FAILURE;
<span class="lineNum">    2577 </span><span class="lineCov">          1 :     initClass(psLayer-&gt;class[psLayer-&gt;numclasses]);</span>
<span class="lineNum">    2578 </span><span class="lineCov">          1 :     nClassId = psLayer-&gt;numclasses;</span>
<span class="lineNum">    2579 </span><span class="lineCov">          1 :     if( pszUserStyleName )</span>
<span class="lineNum">    2580 </span><span class="lineNoCov">          0 :         psLayer-&gt;class[nClassId]-&gt;group = msStrdup(pszUserStyleName);</span>
<span class="lineNum">    2581 </span><span class="lineCov">          1 :     psLayer-&gt;numclasses++;</span>
<span class="lineNum">    2582 </span><span class="lineCov">          1 :     msMaybeAllocateClassStyle(psLayer-&gt;class[nClassId], 0);</span>
<span class="lineNum">    2583 </span>            :     nStyleId = 0;
<span class="lineNum">    2584 </span>            :   } else {
<span class="lineNum">    2585 </span><span class="lineCov">          1 :     nClassId = psLayer-&gt;numclasses - 1;</span>
<span class="lineNum">    2586 </span><span class="lineCov">          1 :     if (nClassId &gt;= 0)/* should always be true */</span>
<span class="lineNum">    2587 </span><span class="lineCov">          1 :       nStyleId = psLayer-&gt;class[nClassId]-&gt;numstyles -1;</span>
<span class="lineNum">    2588 </span>            :   }
<span class="lineNum">    2589 </span>            : 
<span class="lineNum">    2590 </span><span class="lineCov">          1 :   if (nStyleId &gt;= 0 &amp;&amp; nClassId &gt;= 0) /* should always be true */</span>
<span class="lineNum">    2591 </span><span class="lineCov">          1 :     msSLDParseTextParams(psRoot, psLayer,</span>
<span class="lineNum">    2592 </span><span class="lineCov">          1 :                          psLayer-&gt;class[nClassId]);</span>
<span class="lineNum">    2593 </span>            : 
<span class="lineNum">    2594 </span>            :   return MS_SUCCESS;
<span class="lineNum">    2595 </span>            : }
<span class="lineNum">    2596 </span>            : 
<span class="lineNum">    2597 </span>            : 
<span class="lineNum">    2598 </span>            : 
<span class="lineNum">    2599 </span>            : /************************************************************************/
<span class="lineNum">    2600 </span>            : /*                        msSLDParseRasterSymbolizer                    */
<span class="lineNum">    2601 </span>            : /*                                                                      */
<span class="lineNum">    2602 </span>            : /*      Supports the ColorMap parameter in a Raster Symbolizer. In      */
<span class="lineNum">    2603 </span>            : /*      the ColorMap, only color and quantity are used here.            */
<span class="lineNum">    2604 </span>            : /*                                                                      */
<span class="lineNum">    2605 </span>            : /*      &lt;xs:element name=&quot;RasterSymbolizer&quot;&gt;                            */
<span class="lineNum">    2606 </span>            : /*      &lt;xs:complexType&gt;                                                */
<span class="lineNum">    2607 </span>            : /*      &lt;xs:sequence&gt;                                                   */
<span class="lineNum">    2608 </span>            : /*      &lt;xs:element ref=&quot;sld:Geometry&quot; minOccurs=&quot;0&quot;/&gt;                  */
<span class="lineNum">    2609 </span>            : /*      &lt;xs:element ref=&quot;sld:Opacity&quot; minOccurs=&quot;0&quot;/&gt;                   */
<span class="lineNum">    2610 </span>            : /*      &lt;xs:element ref=&quot;sld:ChannelSelection&quot; minOccurs=&quot;0&quot;/&gt;          */
<span class="lineNum">    2611 </span>            : /*      &lt;xs:element ref=&quot;sld:OverlapBehavior&quot; minOccurs=&quot;0&quot;/&gt;           */
<span class="lineNum">    2612 </span>            : /*      &lt;xs:element ref=&quot;sld:ColorMap&quot; minOccurs=&quot;0&quot;/&gt;                  */
<span class="lineNum">    2613 </span>            : /*      &lt;xs:element ref=&quot;sld:ContrastEnhancement&quot; minOccurs=&quot;0&quot;/&gt;       */
<span class="lineNum">    2614 </span>            : /*      &lt;xs:element ref=&quot;sld:ShadedRelief&quot; minOccurs=&quot;0&quot;/&gt;              */
<span class="lineNum">    2615 </span>            : /*      &lt;xs:element ref=&quot;sld:ImageOutline&quot; minOccurs=&quot;0&quot;/&gt;              */
<span class="lineNum">    2616 </span>            : /*      &lt;/xs:sequence&gt;                                                  */
<span class="lineNum">    2617 </span>            : /*      &lt;/xs:complexType&gt;                                               */
<span class="lineNum">    2618 </span>            : /*      &lt;/xs:element&gt;                                                   */
<span class="lineNum">    2619 </span>            : /*                                                                      */
<span class="lineNum">    2620 </span>            : /*      &lt;xs:element name=&quot;ColorMap&quot;&gt;                                    */
<span class="lineNum">    2621 </span>            : /*      &lt;xs:complexType&gt;                                                */
<span class="lineNum">    2622 </span>            : /*      &lt;xs:choice minOccurs=&quot;0&quot; maxOccurs=&quot;unbounded&quot;&gt;                 */
<span class="lineNum">    2623 </span>            : /*      &lt;xs:element ref=&quot;sld:ColorMapEntry&quot;/&gt;                           */
<span class="lineNum">    2624 </span>            : /*      &lt;/xs:choice&gt;                                                    */
<span class="lineNum">    2625 </span>            : /*      &lt;/xs:complexType&gt;                                               */
<span class="lineNum">    2626 </span>            : /*      &lt;/xs:element&gt;                                                   */
<span class="lineNum">    2627 </span>            : /*      &lt;xs:element name=&quot;ColorMapEntry&quot;&gt;                               */
<span class="lineNum">    2628 </span>            : /*      &lt;xs:complexType&gt;                                                */
<span class="lineNum">    2629 </span>            : /*      &lt;xs:attribute name=&quot;color&quot; type=&quot;xs:string&quot; use=&quot;required&quot;/&gt;    */
<span class="lineNum">    2630 </span>            : /*      &lt;xs:attribute name=&quot;opacity&quot; type=&quot;xs:double&quot;/&gt;                 */
<span class="lineNum">    2631 </span>            : /*      &lt;xs:attribute name=&quot;quantity&quot; type=&quot;xs:double&quot;/&gt;                */
<span class="lineNum">    2632 </span>            : /*      &lt;xs:attribute name=&quot;label&quot; type=&quot;xs:string&quot;/&gt;                   */
<span class="lineNum">    2633 </span>            : /*      &lt;/xs:complexType&gt;                                               */
<span class="lineNum">    2634 </span>            : /*      &lt;/xs:element&gt;                                                   */
<span class="lineNum">    2635 </span>            : /*                                                                      */
<span class="lineNum">    2636 </span>            : /*      SLD 1.1                                                         */
<span class="lineNum">    2637 </span>            : /*                                                                      */
<span class="lineNum">    2638 </span>            : /*      &lt;xsd:element name=&quot;RasterSymbolizer&quot; type=&quot;se:RasterSymbolizerType&quot; substitutionGroup=&quot;se:Symbolizer&quot;/&gt;*/
<span class="lineNum">    2639 </span>            : /*      &lt;xsd:complexType name=&quot;RasterSymbolizerType&quot;&gt;                   */
<span class="lineNum">    2640 </span>            : /*      &lt;xsd:complexContent&gt;                                            */
<span class="lineNum">    2641 </span>            : /*      &lt;xsd:extension base=&quot;se:SymbolizerType&quot;&gt;                        */
<span class="lineNum">    2642 </span>            : /*      &lt;xsd:sequence&gt;                                                  */
<span class="lineNum">    2643 </span>            : /*      &lt;xsd:element ref=&quot;se:Geometry&quot; minOccurs=&quot;0&quot;/&gt;                  */
<span class="lineNum">    2644 </span>            : /*      &lt;xsd:element ref=&quot;se:Opacity&quot; minOccurs=&quot;0&quot;/&gt;                   */
<span class="lineNum">    2645 </span>            : /*      &lt;xsd:element ref=&quot;se:ChannelSelection&quot; minOccurs=&quot;0&quot;/&gt;          */
<span class="lineNum">    2646 </span>            : /*      &lt;xsd:element ref=&quot;se:OverlapBehavior&quot; minOccurs=&quot;0&quot;/&gt;           */
<span class="lineNum">    2647 </span>            : /*      &lt;xsd:element ref=&quot;se:ColorMap&quot; minOccurs=&quot;0&quot;/&gt;                  */
<span class="lineNum">    2648 </span>            : /*      &lt;xsd:element ref=&quot;se:ContrastEnhancement&quot; minOccurs=&quot;0&quot;/&gt;       */
<span class="lineNum">    2649 </span>            : /*      &lt;xsd:element ref=&quot;se:ShadedRelief&quot; minOccurs=&quot;0&quot;/&gt;              */
<span class="lineNum">    2650 </span>            : /*      &lt;xsd:element ref=&quot;se:ImageOutline&quot; minOccurs=&quot;0&quot;/&gt;              */
<span class="lineNum">    2651 </span>            : /*      &lt;/xsd:sequence&gt;                                                 */
<span class="lineNum">    2652 </span>            : /*      &lt;/xsd:extension&gt;                                                */
<span class="lineNum">    2653 </span>            : /*      &lt;/xsd:complexContent&gt;                                           */
<span class="lineNum">    2654 </span>            : /*      &lt;/xsd:complexType&gt;                                              */
<span class="lineNum">    2655 </span>            : /*                                                                      */
<span class="lineNum">    2656 </span>            : /*      &lt;xsd:element name=&quot;ColorMap&quot; type=&quot;se:ColorMapType&quot;/&gt;           */
<span class="lineNum">    2657 </span>            : /*      &lt;xsd:complexType name=&quot;ColorMapType&quot;&gt;                           */
<span class="lineNum">    2658 </span>            : /*      &lt;xsd:choice&gt;                                                    */
<span class="lineNum">    2659 </span>            : /*      &lt;xsd:element ref=&quot;se:Categorize&quot;/&gt;                              */
<span class="lineNum">    2660 </span>            : /*      &lt;xsd:element ref=&quot;se:Interpolate&quot;/&gt;                             */
<span class="lineNum">    2661 </span>            : /*      &lt;/xsd:choice&gt;                                                   */
<span class="lineNum">    2662 </span>            : /*      &lt;/xsd:complexType&gt;                                              */
<span class="lineNum">    2663 </span>            : /*                                                                      */
<span class="lineNum">    2664 </span>            : /*      &lt;xsd:element name=&quot;Categorize&quot; type=&quot;se:CategorizeType&quot; substitutionGroup=&quot;se:Function&quot;/&gt;*/
<span class="lineNum">    2665 </span>            : /*      &lt;xsd:complexType name=&quot;CategorizeType&quot;&gt;                         */
<span class="lineNum">    2666 </span>            : /*      &lt;xsd:complexContent&gt;                                            */
<span class="lineNum">    2667 </span>            : /*      &lt;xsd:extension base=&quot;se:FunctionType&quot;&gt;                          */
<span class="lineNum">    2668 </span>            : /*      &lt;xsd:sequence&gt;                                                  */
<span class="lineNum">    2669 </span>            : /*      &lt;xsd:element ref=&quot;se:LookupValue&quot;/&gt;                             */
<span class="lineNum">    2670 </span>            : /*      &lt;xsd:element ref=&quot;se:Value&quot;/&gt;                                   */
<span class="lineNum">    2671 </span>            : /*      &lt;xsd:sequence minOccurs=&quot;0&quot; maxOccurs=&quot;unbounded&quot;&gt;              */
<span class="lineNum">    2672 </span>            : /*      &lt;xsd:element ref=&quot;se:Threshold&quot;/&gt;                               */
<span class="lineNum">    2673 </span>            : /*      &lt;xsd:element ref=&quot;se:Value&quot;/&gt;                                   */
<span class="lineNum">    2674 </span>            : /*      &lt;/xsd:sequence&gt;                                                 */
<span class="lineNum">    2675 </span>            : /*      &lt;/xsd:sequence&gt;                                                 */
<span class="lineNum">    2676 </span>            : /*      &lt;xsd:attribute name=&quot;threshholdsBelongTo&quot; type=&quot;se:ThreshholdsBelongToType&quot; use=&quot;optional&quot;/&gt;*/
<span class="lineNum">    2677 </span>            : /*      &lt;/xsd:extension&gt;                                                */
<span class="lineNum">    2678 </span>            : /*      &lt;/xsd:complexContent&gt;                                           */
<span class="lineNum">    2679 </span>            : /*      &lt;/xsd:complexType&gt;                                              */
<span class="lineNum">    2680 </span>            : /*      &lt;xsd:element name=&quot;LookupValue&quot; type=&quot;se:ParameterValueType&quot;/&gt;  */
<span class="lineNum">    2681 </span>            : /*      &lt;xsd:element name=&quot;Value&quot; type=&quot; se:ParameterValueType&quot;/&gt;       */
<span class="lineNum">    2682 </span>            : /*      &lt;xsd:element name=&quot;Threshold&quot; type=&quot; se:ParameterValueType&quot;/&gt;   */
<span class="lineNum">    2683 </span>            : /*      &lt;xsd:simpleType name=&quot;ThreshholdsBelongToType&quot;&gt;                 */
<span class="lineNum">    2684 </span>            : /*      &lt;xsd:restriction base=&quot;xsd:token&quot;&gt;                              */
<span class="lineNum">    2685 </span>            : /*      &lt;xsd:enumeration value=&quot;succeeding&quot;/&gt;                           */
<span class="lineNum">    2686 </span>            : /*      &lt;xsd:enumeration value=&quot;preceding&quot;/&gt;                            */
<span class="lineNum">    2687 </span>            : /*      &lt;/xsd:restriction&gt;                                              */
<span class="lineNum">    2688 </span>            : /*      &lt;/xsd:simpleType&gt;                                               */
<a name="2689"><span class="lineNum">    2689 </span>            : /*                                                                      */</a>
<span class="lineNum">    2690 </span>            : /************************************************************************/
<span class="lineNum">    2691 </span><span class="lineNoCov">          0 : int msSLDParseRasterSymbolizer(CPLXMLNode *psRoot, layerObj *psLayer,</span>
<span class="lineNum">    2692 </span>            :                                const char* pszUserStyleName)
<span class="lineNum">    2693 </span>            : {
<span class="lineNum">    2694 </span>            :   CPLXMLNode  *psColorMap = NULL, *psColorEntry = NULL, *psOpacity=NULL;
<span class="lineNum">    2695 </span>            :   char *pszColor=NULL, *pszQuantity=NULL;
<span class="lineNum">    2696 </span>            :   char *pszPreviousColor=NULL, *pszPreviousQuality=NULL;
<span class="lineNum">    2697 </span>            :   colorObj sColor;
<span class="lineNum">    2698 </span>            :   char szExpression[100];
<span class="lineNum">    2699 </span>            :   int nClassId = 0;
<span class="lineNum">    2700 </span>            :   double dfOpacity = 1.0;
<span class="lineNum">    2701 </span>            :   char *pszLabel = NULL,  *pszPreviousLabel = NULL;
<span class="lineNum">    2702 </span>            :   char *pch = NULL, *pchPrevious=NULL;
<span class="lineNum">    2703 </span>            : 
<span class="lineNum">    2704 </span>            :   CPLXMLNode  *psNode=NULL, *psCategorize=NULL;
<span class="lineNum">    2705 </span>            :   char *pszTmp = NULL;
<span class="lineNum">    2706 </span>            :   int nValues=0, nThresholds=0;
<span class="lineNum">    2707 </span>            :   int i,nMaxValues= 100, nMaxThreshold=100;
<span class="lineNum">    2708 </span>            : 
<span class="lineNum">    2709 </span><span class="lineNoCov">          0 :   if (!psRoot || !psLayer)</span>
<span class="lineNum">    2710 </span>            :     return MS_FAILURE;
<span class="lineNum">    2711 </span>            : 
<span class="lineNum">    2712 </span><span class="lineNoCov">          0 :   psOpacity = CPLGetXMLNode(psRoot, &quot;Opacity&quot;);</span>
<span class="lineNum">    2713 </span><span class="lineNoCov">          0 :   if (psOpacity) {</span>
<span class="lineNum">    2714 </span><span class="lineNoCov">          0 :     if (psOpacity-&gt;psChild &amp;&amp; psOpacity-&gt;psChild-&gt;pszValue)</span>
<span class="lineNum">    2715 </span>            :       dfOpacity = atof(psOpacity-&gt;psChild-&gt;pszValue);
<span class="lineNum">    2716 </span>            : 
<span class="lineNum">    2717 </span>            :     /* values in sld goes from 0.0 (for transparent) to 1.0 (for full opacity); */
<span class="lineNum">    2718 </span><span class="lineNoCov">          0 :     if (dfOpacity &gt;=0.0 &amp;&amp; dfOpacity &lt;=1.0)</span>
<span class="lineNum">    2719 </span><span class="lineNoCov">          0 :       msSetLayerOpacity(psLayer,(int)(dfOpacity * 100));</span>
<span class="lineNum">    2720 </span>            :     else {
<span class="lineNum">    2721 </span><span class="lineNoCov">          0 :       msSetError(MS_WMSERR, &quot;Invalid opacity value. Values should be between 0.0 and 1.0&quot;, &quot;msSLDParseRasterSymbolizer()&quot;);</span>
<span class="lineNum">    2722 </span><span class="lineNoCov">          0 :       return MS_FAILURE;</span>
<span class="lineNum">    2723 </span>            :     }
<span class="lineNum">    2724 </span>            :   }
<span class="lineNum">    2725 </span><span class="lineNoCov">          0 :   psColorMap = CPLGetXMLNode(psRoot, &quot;ColorMap&quot;);</span>
<span class="lineNum">    2726 </span><span class="lineNoCov">          0 :   if (psColorMap) {</span>
<span class="lineNum">    2727 </span><span class="lineNoCov">          0 :     psColorEntry = CPLGetXMLNode(psColorMap, &quot;ColorMapEntry&quot;);</span>
<span class="lineNum">    2728 </span>            : 
<span class="lineNum">    2729 </span><span class="lineNoCov">          0 :     if (psColorEntry) { /*SLD 1.0*/</span>
<span class="lineNum">    2730 </span><span class="lineNoCov">          0 :       while (psColorEntry &amp;&amp; psColorEntry-&gt;pszValue &amp;&amp;</span>
<span class="lineNum">    2731 </span><span class="lineNoCov">          0 :              strcasecmp(psColorEntry-&gt;pszValue, &quot;ColorMapEntry&quot;) == 0) {</span>
<span class="lineNum">    2732 </span><span class="lineNoCov">          0 :         pszColor = (char *)CPLGetXMLValue(psColorEntry, &quot;color&quot;, NULL);</span>
<span class="lineNum">    2733 </span><span class="lineNoCov">          0 :         pszQuantity = (char *)CPLGetXMLValue(psColorEntry, &quot;quantity&quot;, NULL);</span>
<span class="lineNum">    2734 </span><span class="lineNoCov">          0 :         pszLabel = (char *)CPLGetXMLValue(psColorEntry, &quot;label&quot;, NULL);</span>
<span class="lineNum">    2735 </span>            : 
<span class="lineNum">    2736 </span><span class="lineNoCov">          0 :         if (pszColor &amp;&amp; pszQuantity) {</span>
<span class="lineNum">    2737 </span><span class="lineNoCov">          0 :           if (pszPreviousColor &amp;&amp; pszPreviousQuality) {</span>
<span class="lineNum">    2738 </span><span class="lineNoCov">          0 :             if (strlen(pszPreviousColor) == 7 &amp;&amp;</span>
<span class="lineNum">    2739 </span><span class="lineNoCov">          0 :                 pszPreviousColor[0] == '#' &amp;&amp;</span>
<span class="lineNum">    2740 </span><span class="lineNoCov">          0 :                 strlen(pszColor) == 7 &amp;&amp; pszColor[0] == '#') {</span>
<span class="lineNum">    2741 </span><span class="lineNoCov">          0 :               sColor.red = msHexToInt(pszPreviousColor+1);</span>
<span class="lineNum">    2742 </span><span class="lineNoCov">          0 :               sColor.green= msHexToInt(pszPreviousColor+3);</span>
<span class="lineNum">    2743 </span><span class="lineNoCov">          0 :               sColor.blue = msHexToInt(pszPreviousColor+5);</span>
<span class="lineNum">    2744 </span>            : 
<span class="lineNum">    2745 </span>            :               /* pszQuantity and pszPreviousQuality may be integer or float */
<span class="lineNum">    2746 </span><span class="lineNoCov">          0 :               pchPrevious=strchr(pszPreviousQuality,'.');</span>
<span class="lineNum">    2747 </span><span class="lineNoCov">          0 :               pch=strchr(pszQuantity,'.');</span>
<span class="lineNum">    2748 </span><span class="lineNoCov">          0 :               if (pchPrevious==NULL &amp;&amp; pch==NULL) {</span>
<span class="lineNum">    2749 </span>            :                 snprintf(szExpression, sizeof(szExpression),
<span class="lineNum">    2750 </span>            :                          &quot;([pixel] &gt;= %d AND [pixel] &lt; %d)&quot;,
<span class="lineNum">    2751 </span>            :                          atoi(pszPreviousQuality),
<span class="lineNum">    2752 </span>            :                          atoi(pszQuantity));
<span class="lineNum">    2753 </span><span class="lineNoCov">          0 :               } else if (pchPrevious != NULL &amp;&amp; pch==NULL) {</span>
<span class="lineNum">    2754 </span>            :                 snprintf(szExpression, sizeof(szExpression),
<span class="lineNum">    2755 </span>            :                          &quot;([pixel] &gt;= %f AND [pixel] &lt; %d)&quot;,
<span class="lineNum">    2756 </span>            :                          atof(pszPreviousQuality),
<span class="lineNum">    2757 </span>            :                          atoi(pszQuantity));
<span class="lineNum">    2758 </span><span class="lineNoCov">          0 :               } else if (pchPrevious == NULL &amp;&amp; pch != NULL) {</span>
<span class="lineNum">    2759 </span>            :                 snprintf(szExpression, sizeof(szExpression),
<span class="lineNum">    2760 </span>            :                          &quot;([pixel] &gt;= %d AND [pixel] &lt; %f)&quot;,
<span class="lineNum">    2761 </span>            :                          atoi(pszPreviousQuality),
<span class="lineNum">    2762 </span>            :                          atof(pszQuantity));
<span class="lineNum">    2763 </span>            :               } else {
<span class="lineNum">    2764 </span>            :                 snprintf(szExpression, sizeof(szExpression),
<span class="lineNum">    2765 </span>            :                          &quot;([pixel] &gt;= %f AND [pixel] &lt; %f)&quot;,
<span class="lineNum">    2766 </span>            :                          atof(pszPreviousQuality),
<span class="lineNum">    2767 </span>            :                          atof(pszQuantity));
<span class="lineNum">    2768 </span>            :               }
<span class="lineNum">    2769 </span>            : 
<span class="lineNum">    2770 </span>            : 
<span class="lineNum">    2771 </span><span class="lineNoCov">          0 :               if (msGrowLayerClasses(psLayer) == NULL)</span>
<span class="lineNum">    2772 </span>            :                 return MS_FAILURE;
<span class="lineNum">    2773 </span>            :               else {
<span class="lineNum">    2774 </span><span class="lineNoCov">          0 :                 initClass(psLayer-&gt;class[psLayer-&gt;numclasses]);</span>
<span class="lineNum">    2775 </span><span class="lineNoCov">          0 :                 psLayer-&gt;numclasses++;</span>
<span class="lineNum">    2776 </span>            :                 nClassId = psLayer-&gt;numclasses-1;
<span class="lineNum">    2777 </span><span class="lineNoCov">          0 :                 if( pszUserStyleName )</span>
<span class="lineNum">    2778 </span><span class="lineNoCov">          0 :                     psLayer-&gt;class[nClassId]-&gt;group = msStrdup(pszUserStyleName);</span>
<span class="lineNum">    2779 </span>            : 
<span class="lineNum">    2780 </span>            :                 /*set the class name using the label. If label not defined
<span class="lineNum">    2781 </span>            :                   set it with the quantity*/
<span class="lineNum">    2782 </span><span class="lineNoCov">          0 :                 if (pszPreviousLabel)</span>
<span class="lineNum">    2783 </span><span class="lineNoCov">          0 :                   psLayer-&gt;class[nClassId]-&gt;name = msStrdup(pszPreviousLabel);</span>
<span class="lineNum">    2784 </span>            :                 else
<span class="lineNum">    2785 </span><span class="lineNoCov">          0 :                   psLayer-&gt;class[nClassId]-&gt;name = msStrdup(pszPreviousQuality);</span>
<span class="lineNum">    2786 </span>            : 
<span class="lineNum">    2787 </span><span class="lineNoCov">          0 :                 msMaybeAllocateClassStyle(psLayer-&gt;class[nClassId], 0);</span>
<span class="lineNum">    2788 </span>            : 
<span class="lineNum">    2789 </span><span class="lineNoCov">          0 :                 psLayer-&gt;class[nClassId]-&gt;styles[0]-&gt;color.red =</span>
<span class="lineNum">    2790 </span>            :                       sColor.red;
<span class="lineNum">    2791 </span><span class="lineNoCov">          0 :               psLayer-&gt;class[nClassId]-&gt;styles[0]-&gt;color.green =</span>
<span class="lineNum">    2792 </span>            :                       sColor.green;
<span class="lineNum">    2793 </span><span class="lineNoCov">          0 :               psLayer-&gt;class[nClassId]-&gt;styles[0]-&gt;color.blue =</span>
<span class="lineNum">    2794 </span>            :                       sColor.blue;
<span class="lineNum">    2795 </span>            : 
<span class="lineNum">    2796 </span><span class="lineNoCov">          0 :                 if (psLayer-&gt;classitem &amp;&amp;</span>
<span class="lineNum">    2797 </span><span class="lineNoCov">          0 :                     strcasecmp(psLayer-&gt;classitem, &quot;[pixel]&quot;) != 0)</span>
<span class="lineNum">    2798 </span><span class="lineNoCov">          0 :                   free(psLayer-&gt;classitem);</span>
<span class="lineNum">    2799 </span><span class="lineNoCov">          0 :                 psLayer-&gt;classitem = msStrdup(&quot;[pixel]&quot;);</span>
<span class="lineNum">    2800 </span>            : 
<span class="lineNum">    2801 </span><span class="lineNoCov">          0 :                 msLoadExpressionString(&amp;psLayer-&gt;class[nClassId]-&gt;expression,</span>
<span class="lineNum">    2802 </span>            :                                        szExpression);
<span class="lineNum">    2803 </span>            : 
<span class="lineNum">    2804 </span>            : 
<span class="lineNum">    2805 </span>            :               }
<span class="lineNum">    2806 </span>            :             } else {
<span class="lineNum">    2807 </span><span class="lineNoCov">          0 :               msSetError(MS_WMSERR,</span>
<span class="lineNum">    2808 </span>            :                          &quot;Invalid ColorMap Entry.&quot;,
<span class="lineNum">    2809 </span>            :                          &quot;msSLDParseRasterSymbolizer()&quot;);
<span class="lineNum">    2810 </span><span class="lineNoCov">          0 :               return MS_FAILURE;</span>
<span class="lineNum">    2811 </span>            :             }
<span class="lineNum">    2812 </span>            : 
<span class="lineNum">    2813 </span>            :           }
<span class="lineNum">    2814 </span>            : 
<span class="lineNum">    2815 </span>            :           pszPreviousColor = pszColor;
<span class="lineNum">    2816 </span>            :           pszPreviousQuality = pszQuantity;
<span class="lineNum">    2817 </span>            :           pszPreviousLabel = pszLabel;
<span class="lineNum">    2818 </span>            : 
<span class="lineNum">    2819 </span>            :         }
<span class="lineNum">    2820 </span><span class="lineNoCov">          0 :         psColorEntry = psColorEntry-&gt;psNext;</span>
<span class="lineNum">    2821 </span>            :       }
<span class="lineNum">    2822 </span>            :       /* do the last Color Map Entry */
<span class="lineNum">    2823 </span><span class="lineNoCov">          0 :       if (pszColor &amp;&amp; pszQuantity) {</span>
<span class="lineNum">    2824 </span><span class="lineNoCov">          0 :         if (strlen(pszColor) == 7 &amp;&amp; pszColor[0] == '#') {</span>
<span class="lineNum">    2825 </span><span class="lineNoCov">          0 :           sColor.red = msHexToInt(pszColor+1);</span>
<span class="lineNum">    2826 </span><span class="lineNoCov">          0 :           sColor.green= msHexToInt(pszColor+3);</span>
<span class="lineNum">    2827 </span><span class="lineNoCov">          0 :           sColor.blue = msHexToInt(pszColor+5);</span>
<span class="lineNum">    2828 </span>            : 
<span class="lineNum">    2829 </span>            :           /* pszQuantity may be integer or float */
<span class="lineNum">    2830 </span><span class="lineNoCov">          0 :           pch=strchr(pszQuantity,'.');</span>
<span class="lineNum">    2831 </span><span class="lineNoCov">          0 :           if (pch==NULL) {</span>
<span class="lineNum">    2832 </span>            :             snprintf(szExpression, sizeof(szExpression), &quot;([pixel] = %d)&quot;, atoi(pszQuantity));
<span class="lineNum">    2833 </span>            :           } else {
<span class="lineNum">    2834 </span>            :             snprintf(szExpression, sizeof(szExpression), &quot;([pixel] = %f)&quot;, atof(pszQuantity));
<span class="lineNum">    2835 </span>            :           }
<span class="lineNum">    2836 </span>            : 
<span class="lineNum">    2837 </span><span class="lineNoCov">          0 :           if (msGrowLayerClasses(psLayer) == NULL)</span>
<span class="lineNum">    2838 </span>            :             return MS_FAILURE;
<span class="lineNum">    2839 </span>            :           else {
<span class="lineNum">    2840 </span><span class="lineNoCov">          0 :             initClass(psLayer-&gt;class[psLayer-&gt;numclasses]);</span>
<span class="lineNum">    2841 </span><span class="lineNoCov">          0 :             psLayer-&gt;numclasses++;</span>
<span class="lineNum">    2842 </span>            :             nClassId = psLayer-&gt;numclasses-1;
<span class="lineNum">    2843 </span><span class="lineNoCov">          0 :             if( pszUserStyleName )</span>
<span class="lineNum">    2844 </span><span class="lineNoCov">          0 :                 psLayer-&gt;class[nClassId]-&gt;group = msStrdup(pszUserStyleName);</span>
<span class="lineNum">    2845 </span>            : 
<span class="lineNum">    2846 </span><span class="lineNoCov">          0 :             msMaybeAllocateClassStyle(psLayer-&gt;class[nClassId], 0);</span>
<span class="lineNum">    2847 </span><span class="lineNoCov">          0 :             if (pszLabel)</span>
<span class="lineNum">    2848 </span><span class="lineNoCov">          0 :               psLayer-&gt;class[nClassId]-&gt;name = msStrdup(pszLabel);</span>
<span class="lineNum">    2849 </span>            :             else
<span class="lineNum">    2850 </span><span class="lineNoCov">          0 :               psLayer-&gt;class[nClassId]-&gt;name = msStrdup(pszQuantity);</span>
<span class="lineNum">    2851 </span><span class="lineNoCov">          0 :             psLayer-&gt;class[nClassId]-&gt;numstyles = 1;</span>
<span class="lineNum">    2852 </span><span class="lineNoCov">          0 :             psLayer-&gt;class[nClassId]-&gt;styles[0]-&gt;color.red =</span>
<span class="lineNum">    2853 </span>            :                   sColor.red;
<span class="lineNum">    2854 </span><span class="lineNoCov">          0 :           psLayer-&gt;class[nClassId]-&gt;styles[0]-&gt;color.green =</span>
<span class="lineNum">    2855 </span>            :                   sColor.green;
<span class="lineNum">    2856 </span><span class="lineNoCov">          0 :           psLayer-&gt;class[nClassId]-&gt;styles[0]-&gt;color.blue =</span>
<span class="lineNum">    2857 </span>            :                   sColor.blue;
<span class="lineNum">    2858 </span>            : 
<span class="lineNum">    2859 </span><span class="lineNoCov">          0 :             if (psLayer-&gt;classitem &amp;&amp;</span>
<span class="lineNum">    2860 </span><span class="lineNoCov">          0 :                 strcasecmp(psLayer-&gt;classitem, &quot;[pixel]&quot;) != 0)</span>
<span class="lineNum">    2861 </span><span class="lineNoCov">          0 :               free(psLayer-&gt;classitem);</span>
<span class="lineNum">    2862 </span><span class="lineNoCov">          0 :             psLayer-&gt;classitem = msStrdup(&quot;[pixel]&quot;);</span>
<span class="lineNum">    2863 </span>            : 
<span class="lineNum">    2864 </span><span class="lineNoCov">          0 :             msLoadExpressionString(&amp;psLayer-&gt;class[nClassId]-&gt;expression,</span>
<span class="lineNum">    2865 </span>            :                                    szExpression);
<span class="lineNum">    2866 </span>            :           }
<span class="lineNum">    2867 </span>            :         }
<span class="lineNum">    2868 </span>            :       }
<span class="lineNum">    2869 </span><span class="lineNoCov">          0 :     } else if ((psCategorize = CPLGetXMLNode(psColorMap, &quot;Categorize&quot;))) {</span>
<span class="lineNum">    2870 </span><span class="lineNoCov">          0 :       char** papszValues = (char **)malloc(sizeof(char*)*nMaxValues);</span>
<span class="lineNum">    2871 </span><span class="lineNoCov">          0 :       char** papszThresholds = (char **)malloc(sizeof(char*)*nMaxThreshold);</span>
<span class="lineNum">    2872 </span><span class="lineNoCov">          0 :       psNode =  CPLGetXMLNode(psCategorize, &quot;Value&quot;);</span>
<span class="lineNum">    2873 </span><span class="lineNoCov">          0 :       while (psNode &amp;&amp; psNode-&gt;pszValue &amp;&amp;</span>
<span class="lineNum">    2874 </span><span class="lineNoCov">          0 :              psNode-&gt;psChild &amp;&amp; psNode-&gt;psChild-&gt;pszValue)</span>
<span class="lineNum">    2875 </span>            : 
<span class="lineNum">    2876 </span>            :       {
<span class="lineNum">    2877 </span><span class="lineNoCov">          0 :         if (strcasecmp(psNode-&gt;pszValue, &quot;Value&quot;) == 0) {</span>
<span class="lineNum">    2878 </span><span class="lineNoCov">          0 :           papszValues[nValues] =  psNode-&gt;psChild-&gt;pszValue;</span>
<span class="lineNum">    2879 </span><span class="lineNoCov">          0 :           nValues++;</span>
<span class="lineNum">    2880 </span><span class="lineNoCov">          0 :           if (nValues == nMaxValues) {</span>
<span class="lineNum">    2881 </span><span class="lineNoCov">          0 :             nMaxValues +=100;</span>
<span class="lineNum">    2882 </span><span class="lineNoCov">          0 :             papszValues = (char **)realloc(papszValues, sizeof(char*)*nMaxValues);</span>
<span class="lineNum">    2883 </span>            :           }
<span class="lineNum">    2884 </span><span class="lineNoCov">          0 :         } else if (strcasecmp(psNode-&gt;pszValue, &quot;Threshold&quot;) == 0) {</span>
<span class="lineNum">    2885 </span><span class="lineNoCov">          0 :           papszThresholds[nThresholds] =  psNode-&gt;psChild-&gt;pszValue;</span>
<span class="lineNum">    2886 </span><span class="lineNoCov">          0 :           nThresholds++;</span>
<span class="lineNum">    2887 </span><span class="lineNoCov">          0 :           if (nValues == nMaxThreshold) {</span>
<span class="lineNum">    2888 </span><span class="lineNoCov">          0 :             nMaxThreshold += 100;</span>
<span class="lineNum">    2889 </span><span class="lineNoCov">          0 :             papszThresholds = (char **)realloc(papszThresholds, sizeof(char*)*nMaxThreshold);</span>
<span class="lineNum">    2890 </span>            :           }
<span class="lineNum">    2891 </span>            :         }
<span class="lineNum">    2892 </span><span class="lineNoCov">          0 :         psNode = psNode-&gt;psNext;</span>
<span class="lineNum">    2893 </span>            :       }
<span class="lineNum">    2894 </span>            : 
<span class="lineNum">    2895 </span><span class="lineNoCov">          0 :       if (nThresholds &gt; 0 &amp;&amp; nValues == nThresholds+1) {</span>
<span class="lineNum">    2896 </span>            :         /*free existing classes*/
<span class="lineNum">    2897 </span><span class="lineNoCov">          0 :         for(i=0; i&lt;psLayer-&gt;numclasses; i++) {</span>
<span class="lineNum">    2898 </span><span class="lineNoCov">          0 :           if (psLayer-&gt;class[i] != NULL) {</span>
<span class="lineNum">    2899 </span><span class="lineNoCov">          0 :             psLayer-&gt;class[i]-&gt;layer=NULL;</span>
<span class="lineNum">    2900 </span><span class="lineNoCov">          0 :             if ( freeClass(psLayer-&gt;class[i]) == MS_SUCCESS ) {</span>
<span class="lineNum">    2901 </span><span class="lineNoCov">          0 :               msFree(psLayer-&gt;class[i]);</span>
<span class="lineNum">    2902 </span><span class="lineNoCov">          0 :               psLayer-&gt;class[i]=NULL;</span>
<span class="lineNum">    2903 </span>            :             }
<span class="lineNum">    2904 </span>            :           }
<span class="lineNum">    2905 </span>            :         }
<span class="lineNum">    2906 </span><span class="lineNoCov">          0 :         psLayer-&gt;numclasses=0;</span>
<span class="lineNum">    2907 </span><span class="lineNoCov">          0 :         for (i=0; i&lt;nValues; i++) {</span>
<span class="lineNum">    2908 </span><span class="lineNoCov">          0 :           pszTmp = (papszValues[i]);</span>
<span class="lineNum">    2909 </span><span class="lineNoCov">          0 :           if (pszTmp &amp;&amp; strlen(pszTmp) == 7 &amp;&amp; pszTmp[0] == '#') {</span>
<span class="lineNum">    2910 </span><span class="lineNoCov">          0 :             sColor.red = msHexToInt(pszTmp+1);</span>
<span class="lineNum">    2911 </span><span class="lineNoCov">          0 :             sColor.green= msHexToInt(pszTmp+3);</span>
<span class="lineNum">    2912 </span><span class="lineNoCov">          0 :             sColor.blue = msHexToInt(pszTmp+5);</span>
<span class="lineNum">    2913 </span><span class="lineNoCov">          0 :             if (i == 0) {</span>
<span class="lineNum">    2914 </span><span class="lineNoCov">          0 :               if (strchr(papszThresholds[i],'.'))</span>
<span class="lineNum">    2915 </span>            :                 snprintf(szExpression, sizeof(szExpression), &quot;([pixel] &lt; %f)&quot;, atof(papszThresholds[i]));
<span class="lineNum">    2916 </span>            :               else
<span class="lineNum">    2917 </span>            :                 snprintf(szExpression, sizeof(szExpression), &quot;([pixel] &lt; %d)&quot;, atoi(papszThresholds[i]));
<span class="lineNum">    2918 </span>            : 
<span class="lineNum">    2919 </span><span class="lineNoCov">          0 :             } else if (i &lt; nValues-1) {</span>
<span class="lineNum">    2920 </span><span class="lineNoCov">          0 :               if (strchr(papszThresholds[i],'.'))</span>
<span class="lineNum">    2921 </span><span class="lineNoCov">          0 :                 snprintf(szExpression,  sizeof(szExpression),</span>
<span class="lineNum">    2922 </span>            :                          &quot;([pixel] &gt;= %f AND [pixel] &lt; %f)&quot;,
<span class="lineNum">    2923 </span><span class="lineNoCov">          0 :                          atof(papszThresholds[i-1]),</span>
<span class="lineNum">    2924 </span>            :                          atof(papszThresholds[i]));
<span class="lineNum">    2925 </span>            :               else
<span class="lineNum">    2926 </span><span class="lineNoCov">          0 :                 snprintf(szExpression, sizeof(szExpression),</span>
<span class="lineNum">    2927 </span>            :                          &quot;([pixel] &gt;= %d AND [pixel] &lt; %d)&quot;,
<span class="lineNum">    2928 </span><span class="lineNoCov">          0 :                          atoi(papszThresholds[i-1]),</span>
<span class="lineNum">    2929 </span>            :                          atoi(papszThresholds[i]));
<span class="lineNum">    2930 </span>            :             } else {
<span class="lineNum">    2931 </span><span class="lineNoCov">          0 :               if (strchr(papszThresholds[i-1],'.'))</span>
<span class="lineNum">    2932 </span>            :                 snprintf(szExpression, sizeof(szExpression), &quot;([pixel] &gt;= %f)&quot;, atof(papszThresholds[i-1]));
<span class="lineNum">    2933 </span>            :               else
<span class="lineNum">    2934 </span>            :                 snprintf(szExpression, sizeof(szExpression), &quot;([pixel] &gt;= %d)&quot;, atoi(papszThresholds[i-1]));
<span class="lineNum">    2935 </span>            :             }
<span class="lineNum">    2936 </span><span class="lineNoCov">          0 :             if (msGrowLayerClasses(psLayer)) {</span>
<span class="lineNum">    2937 </span><span class="lineNoCov">          0 :               initClass(psLayer-&gt;class[psLayer-&gt;numclasses]);</span>
<span class="lineNum">    2938 </span><span class="lineNoCov">          0 :               psLayer-&gt;numclasses++;</span>
<span class="lineNum">    2939 </span>            :               nClassId = psLayer-&gt;numclasses-1;
<span class="lineNum">    2940 </span><span class="lineNoCov">          0 :               if( pszUserStyleName )</span>
<span class="lineNum">    2941 </span><span class="lineNoCov">          0 :                 psLayer-&gt;class[nClassId]-&gt;group = msStrdup(pszUserStyleName);</span>
<span class="lineNum">    2942 </span><span class="lineNoCov">          0 :               msMaybeAllocateClassStyle(psLayer-&gt;class[nClassId], 0);</span>
<span class="lineNum">    2943 </span><span class="lineNoCov">          0 :               psLayer-&gt;class[nClassId]-&gt;numstyles = 1;</span>
<span class="lineNum">    2944 </span><span class="lineNoCov">          0 :               psLayer-&gt;class[nClassId]-&gt;styles[0]-&gt;color.red =</span>
<span class="lineNum">    2945 </span>            :                     sColor.red;
<span class="lineNum">    2946 </span><span class="lineNoCov">          0 :             psLayer-&gt;class[nClassId]-&gt;styles[0]-&gt;color.green =</span>
<span class="lineNum">    2947 </span>            :                     sColor.green;
<span class="lineNum">    2948 </span><span class="lineNoCov">          0 :             psLayer-&gt;class[nClassId]-&gt;styles[0]-&gt;color.blue =</span>
<span class="lineNum">    2949 </span>            :                     sColor.blue;
<span class="lineNum">    2950 </span><span class="lineNoCov">          0 :               if (psLayer-&gt;classitem &amp;&amp;</span>
<span class="lineNum">    2951 </span><span class="lineNoCov">          0 :                   strcasecmp(psLayer-&gt;classitem, &quot;[pixel]&quot;) != 0)</span>
<span class="lineNum">    2952 </span><span class="lineNoCov">          0 :                 free(psLayer-&gt;classitem);</span>
<span class="lineNum">    2953 </span><span class="lineNoCov">          0 :               psLayer-&gt;classitem = msStrdup(&quot;[pixel]&quot;);</span>
<span class="lineNum">    2954 </span><span class="lineNoCov">          0 :               msLoadExpressionString(&amp;psLayer-&gt;class[nClassId]-&gt;expression,</span>
<span class="lineNum">    2955 </span>            :                                      szExpression);
<span class="lineNum">    2956 </span>            :             }
<span class="lineNum">    2957 </span>            : 
<span class="lineNum">    2958 </span>            :           }
<span class="lineNum">    2959 </span>            :         }
<span class="lineNum">    2960 </span>            :       }
<span class="lineNum">    2961 </span><span class="lineNoCov">          0 :       free(papszValues);</span>
<span class="lineNum">    2962 </span><span class="lineNoCov">          0 :       free(papszThresholds);</span>
<span class="lineNum">    2963 </span>            : 
<span class="lineNum">    2964 </span>            : 
<span class="lineNum">    2965 </span>            :     } else {
<span class="lineNum">    2966 </span><span class="lineNoCov">          0 :       msSetError(MS_WMSERR, &quot;Invalid SLD document. msSLDParseRaster&quot;, &quot;&quot;);</span>
<span class="lineNum">    2967 </span><span class="lineNoCov">          0 :       return MS_FAILURE;</span>
<span class="lineNum">    2968 </span>            :     }
<span class="lineNum">    2969 </span>            :   }
<span class="lineNum">    2970 </span>            : 
<span class="lineNum">    2971 </span>            :   return MS_SUCCESS;
<span class="lineNum">    2972 </span>            : }
<span class="lineNum">    2973 </span>            : /************************************************************************/
<span class="lineNum">    2974 </span>            : /*                           msSLDParseTextParams                       */
<span class="lineNum">    2975 </span>            : /*                                                                      */
<a name="2976"><span class="lineNum">    2976 </span>            : /*      Parse text parameters like font, placement and color.           */</a>
<span class="lineNum">    2977 </span>            : /************************************************************************/
<span class="lineNum">    2978 </span><span class="lineCov">          1 : int msSLDParseTextParams(CPLXMLNode *psRoot, layerObj *psLayer,</span>
<span class="lineNum">    2979 </span>            :                          classObj *psClass)
<span class="lineNum">    2980 </span>            : {
<span class="lineNum">    2981 </span>            :   char szFontName[100];
<span class="lineNum">    2982 </span>            : 
<span class="lineNum">    2983 </span>            :   CPLXMLNode *psLabel=NULL, *psFont=NULL;
<span class="lineNum">    2984 </span>            :   CPLXMLNode *psCssParam = NULL;
<span class="lineNum">    2985 </span>            :   char *pszName=NULL, *pszFontFamily=NULL, *pszFontStyle=NULL;
<span class="lineNum">    2986 </span>            :   char *pszFontWeight=NULL;
<span class="lineNum">    2987 </span>            :   CPLXMLNode *psLabelPlacement=NULL, *psPointPlacement=NULL, *psLinePlacement=NULL;
<span class="lineNum">    2988 </span>            :   CPLXMLNode *psFill = NULL, *psHalo=NULL, *psHaloRadius=NULL, *psHaloFill=NULL;
<span class="lineNum">    2989 </span>            :   labelObj *psLabelObj = NULL;
<span class="lineNum">    2990 </span><span class="lineCov">          1 :   szFontName[0]='\0';</span>
<span class="lineNum">    2991 </span>            : 
<span class="lineNum">    2992 </span><span class="lineCov">          1 :   if (!psRoot || !psClass || !psLayer)</span>
<span class="lineNum">    2993 </span>            :     return MS_FAILURE;
<span class="lineNum">    2994 </span>            : 
<span class="lineNum">    2995 </span><span class="lineCov">          1 :   if(psClass-&gt;numlabels == 0) {</span>
<span class="lineNum">    2996 </span><span class="lineCov">          1 :     if(msGrowClassLabels(psClass) == NULL) return(MS_FAILURE);</span>
<span class="lineNum">    2997 </span><span class="lineCov">          1 :     initLabel(psClass-&gt;labels[0]);</span>
<span class="lineNum">    2998 </span><span class="lineCov">          1 :     psClass-&gt;numlabels++;</span>
<span class="lineNum">    2999 </span>            :   }
<span class="lineNum">    3000 </span><span class="lineCov">          1 :   psLabelObj = psClass-&gt;labels[0];</span>
<span class="lineNum">    3001 </span>            : 
<span class="lineNum">    3002 </span>            :   /*set the angle by default to auto. the angle can be
<span class="lineNum">    3003 </span>            :     modified Label Placement #2806*/
<span class="lineNum">    3004 </span><span class="lineCov">          1 :   psLabelObj-&gt;anglemode = MS_AUTO;</span>
<span class="lineNum">    3005 </span>            : 
<span class="lineNum">    3006 </span>            : 
<span class="lineNum">    3007 </span>            :   /* label  */
<span class="lineNum">    3008 </span>            :   /* support literal expression  and  propertyname
<span class="lineNum">    3009 </span>            :    - &lt;TextSymbolizer&gt;&lt;Label&gt;MY_COLUMN&lt;/Label&gt;
<span class="lineNum">    3010 </span>            :    - &lt;TextSymbolizer&gt;&lt;Label&gt;&lt;ogc:PropertyName&gt;MY_COLUMN&lt;/ogc:PropertyName&gt;&lt;/Label&gt;
<span class="lineNum">    3011 </span>            :   Bug 1857 */
<span class="lineNum">    3012 </span><span class="lineCov">          1 :   psLabel = CPLGetXMLNode(psRoot, &quot;Label&quot;);</span>
<span class="lineNum">    3013 </span><span class="lineCov">          1 :   if (psLabel)</span>
<span class="lineNum">    3014 </span>            :   {
<span class="lineNum">    3015 </span>            :     char * sep = &quot;&quot;;
<span class="lineNum">    3016 </span><span class="lineCov">          1 :     msStringBuffer * classtext = msStringBufferAlloc();</span>
<span class="lineNum">    3017 </span><span class="lineCov">          1 :     msStringBufferAppend(classtext, &quot;(&quot;);</span>
<span class="lineNum">    3018 </span><span class="lineCov">          1 :     for (CPLXMLNode * psTmpNode = psLabel-&gt;psChild ; psTmpNode ; psTmpNode = psTmpNode-&gt;psNext)</span>
<span class="lineNum">    3019 </span>            :     {
<span class="lineNum">    3020 </span><span class="lineCov">          1 :       if (psTmpNode-&gt;eType == CXT_Text &amp;&amp; psTmpNode-&gt;pszValue)</span>
<span class="lineNum">    3021 </span>            :       {
<span class="lineNum">    3022 </span><span class="lineCov">          1 :         msStringBufferAppend(classtext, sep);</span>
<span class="lineNum">    3023 </span><span class="lineCov">          1 :         msStringBufferAppend(classtext, &quot;\&quot;&quot;);</span>
<span class="lineNum">    3024 </span><span class="lineCov">          1 :         msStringBufferAppend(classtext, psTmpNode-&gt;pszValue);</span>
<span class="lineNum">    3025 </span><span class="lineCov">          1 :         msStringBufferAppend(classtext, &quot;\&quot;&quot;);</span>
<span class="lineNum">    3026 </span><span class="lineCov">          1 :         sep = &quot;+&quot;;</span>
<span class="lineNum">    3027 </span>            :       }
<span class="lineNum">    3028 </span><span class="lineCov">          1 :       else if (psTmpNode-&gt;eType == CXT_Element</span>
<span class="lineNum">    3029 </span><span class="lineCov">          1 :                &amp;&amp; strcasecmp(psTmpNode-&gt;pszValue,&quot;Literal&quot;) == 0</span>
<span class="lineNum">    3030 </span><span class="lineCov">          1 :                &amp;&amp; psTmpNode-&gt;psChild)</span>
<span class="lineNum">    3031 </span>            :       {
<span class="lineNum">    3032 </span><span class="lineCov">          1 :         msStringBufferAppend(classtext, sep);</span>
<span class="lineNum">    3033 </span><span class="lineCov">          1 :         msStringBufferAppend(classtext, &quot;\&quot;&quot;);</span>
<span class="lineNum">    3034 </span><span class="lineCov">          1 :         msStringBufferAppend(classtext, psTmpNode-&gt;psChild-&gt;pszValue);</span>
<span class="lineNum">    3035 </span><span class="lineCov">          1 :         msStringBufferAppend(classtext, &quot;\&quot;&quot;);</span>
<span class="lineNum">    3036 </span><span class="lineCov">          1 :         sep = &quot;+&quot;;</span>
<span class="lineNum">    3037 </span>            :       }
<span class="lineNum">    3038 </span><span class="lineCov">          1 :       else if (psTmpNode-&gt;eType == CXT_Element</span>
<span class="lineNum">    3039 </span><span class="lineCov">          1 :                &amp;&amp; strcasecmp(psTmpNode-&gt;pszValue,&quot;PropertyName&quot;) == 0</span>
<span class="lineNum">    3040 </span><span class="lineCov">          1 :                &amp;&amp; psTmpNode-&gt;psChild)</span>
<span class="lineNum">    3041 </span>            :       {
<span class="lineNum">    3042 </span><span class="lineCov">          1 :         msStringBufferAppend(classtext, sep);</span>
<span class="lineNum">    3043 </span><span class="lineCov">          1 :         msStringBufferAppend(classtext, &quot;\&quot;[&quot;);</span>
<span class="lineNum">    3044 </span><span class="lineCov">          1 :         msStringBufferAppend(classtext, psTmpNode-&gt;psChild-&gt;pszValue);</span>
<span class="lineNum">    3045 </span><span class="lineCov">          1 :         msStringBufferAppend(classtext, &quot;]\&quot;&quot;);</span>
<span class="lineNum">    3046 </span><span class="lineCov">          1 :         sep = &quot;+&quot;;</span>
<span class="lineNum">    3047 </span>            :       }
<span class="lineNum">    3048 </span><span class="lineCov">          1 :       else if (psTmpNode-&gt;eType == CXT_Element</span>
<span class="lineNum">    3049 </span><span class="lineCov">          1 :                &amp;&amp; strcasecmp(psTmpNode-&gt;pszValue,&quot;Function&quot;) == 0</span>
<span class="lineNum">    3050 </span><span class="lineCov">          1 :                &amp;&amp; psTmpNode-&gt;psChild)</span>
<span class="lineNum">    3051 </span>            :       {
<span class="lineNum">    3052 </span><span class="lineCov">          1 :         msStringBufferAppend(classtext, sep);</span>
<span class="lineNum">    3053 </span><span class="lineCov">          1 :         msStringBufferAppend(classtext, &quot;tostring(&quot;);</span>
<span class="lineNum">    3054 </span>            : 
<span class="lineNum">    3055 </span>            :         labelObj tempExpressionCollector;
<span class="lineNum">    3056 </span><span class="lineCov">          1 :         initLabel(&amp;tempExpressionCollector);</span>
<span class="lineNum">    3057 </span><span class="lineCov">          1 :         msSLDParseOgcExpression(psTmpNode,&amp;tempExpressionCollector,MS_LABEL_BINDING_SIZE,MS_OBJ_LABEL);</span>
<span class="lineNum">    3058 </span><span class="lineCov">          1 :         msStringBufferAppend(classtext,tempExpressionCollector.exprBindings[MS_LABEL_BINDING_SIZE].string);</span>
<span class="lineNum">    3059 </span><span class="lineCov">          1 :         freeLabel(&amp;tempExpressionCollector);</span>
<span class="lineNum">    3060 </span>            : 
<span class="lineNum">    3061 </span><span class="lineCov">          1 :         msStringBufferAppend(classtext, &quot;,\&quot;%g\&quot;)&quot;);</span>
<span class="lineNum">    3062 </span>            :         sep = &quot;+&quot;;
<span class="lineNum">    3063 </span>            :       }
<span class="lineNum">    3064 </span>            :     }
<span class="lineNum">    3065 </span><span class="lineCov">          1 :     msStringBufferAppend(classtext, &quot;)&quot;);</span>
<span class="lineNum">    3066 </span><span class="lineCov">          1 :     const char * expressionstring = msStringBufferGetString(classtext);</span>
<span class="lineNum">    3067 </span><span class="lineCov">          1 :     if (strlen(expressionstring) &gt; 2)</span>
<span class="lineNum">    3068 </span>            :     {
<span class="lineNum">    3069 </span><span class="lineCov">          1 :       msLoadExpressionString(&amp;psClass-&gt;text, (char*)expressionstring);</span>
<span class="lineNum">    3070 </span>            :     }
<span class="lineNum">    3071 </span><span class="lineCov">          1 :     msStringBufferFree(classtext);</span>
<span class="lineNum">    3072 </span>            : 
<span class="lineNum">    3073 </span>            :     {
<span class="lineNum">    3074 </span>            :       /* font */
<span class="lineNum">    3075 </span><span class="lineCov">          1 :       psFont = CPLGetXMLNode(psRoot, &quot;Font&quot;);</span>
<span class="lineNum">    3076 </span><span class="lineCov">          1 :       if (psFont) {</span>
<span class="lineNum">    3077 </span><span class="lineCov">          1 :         psCssParam =  CPLGetXMLNode(psFont, &quot;CssParameter&quot;);</span>
<span class="lineNum">    3078 </span>            :         /*sld 1.1 used SvgParameter*/
<span class="lineNum">    3079 </span><span class="lineCov">          1 :         if (psCssParam == NULL)</span>
<span class="lineNum">    3080 </span><span class="lineCov">          1 :           psCssParam =  CPLGetXMLNode(psFont, &quot;SvgParameter&quot;);</span>
<span class="lineNum">    3081 </span>            : 
<span class="lineNum">    3082 </span><span class="lineCov">          1 :         while (psCssParam &amp;&amp; psCssParam-&gt;pszValue &amp;&amp;</span>
<span class="lineNum">    3083 </span><span class="lineCov">          1 :                (strcasecmp(psCssParam-&gt;pszValue, &quot;CssParameter&quot;) == 0 ||</span>
<span class="lineNum">    3084 </span><span class="lineCov">          1 :                 strcasecmp(psCssParam-&gt;pszValue, &quot;SvgParameter&quot;) == 0)) {</span>
<span class="lineNum">    3085 </span><span class="lineCov">          1 :           pszName = (char*)CPLGetXMLValue(psCssParam, &quot;name&quot;, NULL);</span>
<span class="lineNum">    3086 </span><span class="lineCov">          1 :           if (pszName) {</span>
<span class="lineNum">    3087 </span><span class="lineCov">          1 :             if (strcasecmp(pszName, &quot;font-family&quot;) == 0) {</span>
<span class="lineNum">    3088 </span><span class="lineCov">          1 :               if(psCssParam-&gt;psChild &amp;&amp; psCssParam-&gt;psChild-&gt;psNext &amp;&amp;</span>
<span class="lineNum">    3089 </span><span class="lineCov">          1 :                   psCssParam-&gt;psChild-&gt;psNext-&gt;pszValue)</span>
<span class="lineNum">    3090 </span>            :                 pszFontFamily = psCssParam-&gt;psChild-&gt;psNext-&gt;pszValue;
<span class="lineNum">    3091 </span>            :             }
<span class="lineNum">    3092 </span>            :             /* normal, italic, oblique */
<span class="lineNum">    3093 </span><span class="lineCov">          1 :             else if (strcasecmp(pszName, &quot;font-style&quot;) == 0) {</span>
<span class="lineNum">    3094 </span><span class="lineCov">          1 :               if(psCssParam-&gt;psChild &amp;&amp; psCssParam-&gt;psChild-&gt;psNext &amp;&amp;</span>
<span class="lineNum">    3095 </span><span class="lineCov">          1 :                   psCssParam-&gt;psChild-&gt;psNext-&gt;pszValue)</span>
<span class="lineNum">    3096 </span>            :                 pszFontStyle = psCssParam-&gt;psChild-&gt;psNext-&gt;pszValue;
<span class="lineNum">    3097 </span>            :             }
<span class="lineNum">    3098 </span>            :             /* normal or bold */
<span class="lineNum">    3099 </span><span class="lineCov">          1 :             else if (strcasecmp(pszName, &quot;font-weight&quot;) == 0) {</span>
<span class="lineNum">    3100 </span><span class="lineCov">          1 :               if(psCssParam-&gt;psChild &amp;&amp; psCssParam-&gt;psChild-&gt;psNext &amp;&amp;</span>
<span class="lineNum">    3101 </span><span class="lineCov">          1 :                   psCssParam-&gt;psChild-&gt;psNext-&gt;pszValue)</span>
<span class="lineNum">    3102 </span>            :                 pszFontWeight = psCssParam-&gt;psChild-&gt;psNext-&gt;pszValue;
<span class="lineNum">    3103 </span>            :             }
<span class="lineNum">    3104 </span>            :             /* default is 10 pix */
<span class="lineNum">    3105 </span><span class="lineCov">          1 :             else if (strcasecmp(pszName, &quot;font-size&quot;) == 0) {</span>
<span class="lineNum">    3106 </span><span class="lineCov">          1 :               if(psCssParam-&gt;psChild &amp;&amp; psCssParam-&gt;psChild-&gt;psNext)</span>
<span class="lineNum">    3107 </span>            :               {
<span class="lineNum">    3108 </span><span class="lineCov">          1 :                 msSLDParseOgcExpression(psCssParam-&gt;psChild-&gt;psNext,</span>
<span class="lineNum">    3109 </span>            :                     psLabelObj, MS_LABEL_BINDING_SIZE, MS_OBJ_LABEL);
<span class="lineNum">    3110 </span>            :               }
<span class="lineNum">    3111 </span>            :             }
<span class="lineNum">    3112 </span>            :           }
<span class="lineNum">    3113 </span><span class="lineCov">          1 :           psCssParam = psCssParam-&gt;psNext;</span>
<span class="lineNum">    3114 </span>            :         }
<span class="lineNum">    3115 </span>            :       }
<span class="lineNum">    3116 </span>            : 
<span class="lineNum">    3117 </span>            :       /* -------------------------------------------------------------------- */
<span class="lineNum">    3118 </span>            :       /*      parse the label placement.                                      */
<span class="lineNum">    3119 </span>            :       /* -------------------------------------------------------------------- */
<span class="lineNum">    3120 </span><span class="lineCov">          1 :       psLabelPlacement = CPLGetXMLNode(psRoot, &quot;LabelPlacement&quot;);</span>
<span class="lineNum">    3121 </span><span class="lineCov">          1 :       if (psLabelPlacement) {</span>
<span class="lineNum">    3122 </span><span class="lineCov">          1 :         psPointPlacement = CPLGetXMLNode(psLabelPlacement,</span>
<span class="lineNum">    3123 </span>            :                                          &quot;PointPlacement&quot;);
<span class="lineNum">    3124 </span><span class="lineCov">          1 :         psLinePlacement = CPLGetXMLNode(psLabelPlacement,</span>
<span class="lineNum">    3125 </span>            :                                         &quot;LinePlacement&quot;);
<span class="lineNum">    3126 </span><span class="lineCov">          1 :         if (psPointPlacement)</span>
<span class="lineNum">    3127 </span><span class="lineCov">          1 :           ParseTextPointPlacement(psPointPlacement, psClass);</span>
<span class="lineNum">    3128 </span><span class="lineCov">          1 :         if (psLinePlacement)</span>
<span class="lineNum">    3129 </span><span class="lineNoCov">          0 :           ParseTextLinePlacement(psLinePlacement, psClass);</span>
<span class="lineNum">    3130 </span>            :       }
<span class="lineNum">    3131 </span>            : 
<span class="lineNum">    3132 </span>            :       /* -------------------------------------------------------------------- */
<span class="lineNum">    3133 </span>            :       /*      build the font name using the font font-family, font-style      */
<span class="lineNum">    3134 </span>            :       /*      and font-weight. The name building uses a - between these       */
<span class="lineNum">    3135 </span>            :       /*      parameters and the resulting name is compared to the list of    */
<span class="lineNum">    3136 </span>            :       /*      available fonts. If the name exists, it will be used else we    */
<span class="lineNum">    3137 </span>            :       /*      go to the bitmap fonts.                                         */
<span class="lineNum">    3138 </span>            :       /* -------------------------------------------------------------------- */
<span class="lineNum">    3139 </span><span class="lineCov">          1 :       if (pszFontFamily) {</span>
<span class="lineNum">    3140 </span>            :         snprintf(szFontName, sizeof(szFontName), &quot;%s&quot;, pszFontFamily);
<span class="lineNum">    3141 </span><span class="lineCov">          1 :         if (pszFontWeight &amp;&amp; strcasecmp(pszFontWeight, &quot;normal&quot;) != 0) {</span>
<span class="lineNum">    3142 </span><span class="lineCov">          1 :           strlcat(szFontName, &quot;-&quot;, sizeof(szFontName));</span>
<span class="lineNum">    3143 </span><span class="lineCov">          1 :           strlcat(szFontName, pszFontWeight, sizeof(szFontName));</span>
<span class="lineNum">    3144 </span>            :         }
<span class="lineNum">    3145 </span><span class="lineCov">          1 :         if (pszFontStyle &amp;&amp; strcasecmp(pszFontStyle, &quot;normal&quot;) != 0) {</span>
<span class="lineNum">    3146 </span><span class="lineCov">          1 :           strlcat(szFontName, &quot;-&quot;, sizeof(szFontName));</span>
<span class="lineNum">    3147 </span><span class="lineCov">          1 :           strlcat(szFontName, pszFontStyle, sizeof(szFontName));</span>
<span class="lineNum">    3148 </span>            :         }
<span class="lineNum">    3149 </span>            : 
<span class="lineNum">    3150 </span><span class="lineCov">          1 :         if ((msLookupHashTable(&amp;(psLayer-&gt;map-&gt;fontset.fonts), szFontName) !=NULL)) {</span>
<span class="lineNum">    3151 </span><span class="lineCov">          1 :           psLabelObj-&gt;font = msStrdup(szFontName);</span>
<span class="lineNum">    3152 </span>            :         }
<span class="lineNum">    3153 </span>            :       }
<span class="lineNum">    3154 </span>            : 
<span class="lineNum">    3155 </span>            :       /* -------------------------------------------------------------------- */
<span class="lineNum">    3156 </span>            :       /*      parse the halo parameter.                                       */
<span class="lineNum">    3157 </span>            :       /* -------------------------------------------------------------------- */
<span class="lineNum">    3158 </span><span class="lineCov">          1 :       psHalo = CPLGetXMLNode(psRoot, &quot;Halo&quot;);</span>
<span class="lineNum">    3159 </span><span class="lineCov">          1 :       if (psHalo) {</span>
<span class="lineNum">    3160 </span><span class="lineCov">          1 :         psHaloRadius =  CPLGetXMLNode(psHalo, &quot;Radius&quot;);</span>
<span class="lineNum">    3161 </span><span class="lineCov">          1 :         if (psHaloRadius &amp;&amp; psHaloRadius-&gt;psChild &amp;&amp; psHaloRadius-&gt;psChild-&gt;pszValue)</span>
<span class="lineNum">    3162 </span><span class="lineCov">          1 :           psLabelObj-&gt;outlinewidth = atoi(psHaloRadius-&gt;psChild-&gt;pszValue);</span>
<span class="lineNum">    3163 </span>            : 
<span class="lineNum">    3164 </span><span class="lineCov">          1 :         psHaloFill =  CPLGetXMLNode(psHalo, &quot;Fill&quot;);</span>
<span class="lineNum">    3165 </span><span class="lineCov">          1 :         if (psHaloFill) {</span>
<span class="lineNum">    3166 </span><span class="lineCov">          1 :           psCssParam =  CPLGetXMLNode(psHaloFill, &quot;CssParameter&quot;);</span>
<span class="lineNum">    3167 </span>            :           /*sld 1.1 used SvgParameter*/
<span class="lineNum">    3168 </span><span class="lineCov">          1 :           if (psCssParam == NULL)</span>
<span class="lineNum">    3169 </span><span class="lineCov">          1 :             psCssParam =  CPLGetXMLNode(psHaloFill, &quot;SvgParameter&quot;);</span>
<span class="lineNum">    3170 </span>            : 
<span class="lineNum">    3171 </span><span class="lineCov">          1 :           while (psCssParam &amp;&amp; psCssParam-&gt;pszValue &amp;&amp;</span>
<span class="lineNum">    3172 </span><span class="lineCov">          1 :                  (strcasecmp(psCssParam-&gt;pszValue, &quot;CssParameter&quot;) == 0 ||</span>
<span class="lineNum">    3173 </span><span class="lineCov">          1 :                   strcasecmp(psCssParam-&gt;pszValue, &quot;SvgParameter&quot;) == 0)) {</span>
<span class="lineNum">    3174 </span><span class="lineCov">          1 :             pszName = (char*)CPLGetXMLValue(psCssParam, &quot;name&quot;, NULL);</span>
<span class="lineNum">    3175 </span><span class="lineCov">          1 :             if (pszName) {</span>
<span class="lineNum">    3176 </span><span class="lineCov">          1 :               if (strcasecmp(pszName, &quot;fill&quot;) == 0) {</span>
<span class="lineNum">    3177 </span><span class="lineCov">          1 :                 if(psCssParam-&gt;psChild &amp;&amp; psCssParam-&gt;psChild-&gt;psNext)</span>
<span class="lineNum">    3178 </span>            :                 {
<span class="lineNum">    3179 </span><span class="lineCov">          1 :                   msSLDParseOgcExpression(psCssParam-&gt;psChild-&gt;psNext, psLabelObj,</span>
<span class="lineNum">    3180 </span>            :                       MS_LABEL_BINDING_OUTLINECOLOR, MS_OBJ_LABEL);
<span class="lineNum">    3181 </span>            :                 }
<span class="lineNum">    3182 </span>            :               }
<span class="lineNum">    3183 </span>            :             }
<span class="lineNum">    3184 </span><span class="lineCov">          1 :             psCssParam = psCssParam-&gt;psNext;</span>
<span class="lineNum">    3185 </span>            :           }
<span class="lineNum">    3186 </span>            : 
<span class="lineNum">    3187 </span>            :         }
<span class="lineNum">    3188 </span>            : 
<span class="lineNum">    3189 </span>            :       }
<span class="lineNum">    3190 </span>            :       /* -------------------------------------------------------------------- */
<span class="lineNum">    3191 </span>            :       /*      Parse the color                                                 */
<span class="lineNum">    3192 </span>            :       /* -------------------------------------------------------------------- */
<span class="lineNum">    3193 </span><span class="lineCov">          1 :       psFill = CPLGetXMLNode(psRoot, &quot;Fill&quot;);</span>
<span class="lineNum">    3194 </span><span class="lineCov">          1 :       if (psFill) {</span>
<span class="lineNum">    3195 </span><span class="lineCov">          1 :         psCssParam =  CPLGetXMLNode(psFill, &quot;CssParameter&quot;);</span>
<span class="lineNum">    3196 </span>            :         /*sld 1.1 used SvgParameter*/
<span class="lineNum">    3197 </span><span class="lineCov">          1 :         if (psCssParam == NULL)</span>
<span class="lineNum">    3198 </span><span class="lineCov">          1 :           psCssParam =  CPLGetXMLNode(psFill, &quot;SvgParameter&quot;);</span>
<span class="lineNum">    3199 </span>            : 
<span class="lineNum">    3200 </span><span class="lineCov">          1 :         while (psCssParam &amp;&amp; psCssParam-&gt;pszValue &amp;&amp;</span>
<span class="lineNum">    3201 </span><span class="lineCov">          1 :                (strcasecmp(psCssParam-&gt;pszValue, &quot;CssParameter&quot;) == 0 ||</span>
<span class="lineNum">    3202 </span><span class="lineCov">          1 :                 strcasecmp(psCssParam-&gt;pszValue, &quot;SvgParameter&quot;) == 0)) {</span>
<span class="lineNum">    3203 </span><span class="lineCov">          1 :           pszName = (char*)CPLGetXMLValue(psCssParam, &quot;name&quot;, NULL);</span>
<span class="lineNum">    3204 </span><span class="lineCov">          1 :           if (pszName) {</span>
<span class="lineNum">    3205 </span><span class="lineCov">          1 :             if (strcasecmp(pszName, &quot;fill&quot;) == 0) {</span>
<span class="lineNum">    3206 </span><span class="lineCov">          1 :               if(psCssParam-&gt;psChild &amp;&amp; psCssParam-&gt;psChild-&gt;psNext)</span>
<span class="lineNum">    3207 </span>            :               {
<span class="lineNum">    3208 </span><span class="lineCov">          1 :                 msSLDParseOgcExpression(psCssParam-&gt;psChild-&gt;psNext, psLabelObj,</span>
<span class="lineNum">    3209 </span>            :                     MS_LABEL_BINDING_COLOR, MS_OBJ_LABEL);
<span class="lineNum">    3210 </span>            :               }
<span class="lineNum">    3211 </span>            :             }
<span class="lineNum">    3212 </span>            :           }
<span class="lineNum">    3213 </span><span class="lineCov">          1 :           psCssParam = psCssParam-&gt;psNext;</span>
<span class="lineNum">    3214 </span>            :         }
<span class="lineNum">    3215 </span>            :       }
<span class="lineNum">    3216 </span>            : 
<span class="lineNum">    3217 </span>            :     }
<span class="lineNum">    3218 </span>            :   }
<span class="lineNum">    3219 </span>            : 
<span class="lineNum">    3220 </span>            :   return MS_SUCCESS;
<span class="lineNum">    3221 </span>            : }
<span class="lineNum">    3222 </span>            : 
<span class="lineNum">    3223 </span>            : /************************************************************************/
<span class="lineNum">    3224 </span>            : /*                         ParseTextPointPlacement                      */
<span class="lineNum">    3225 </span>            : /*                                                                      */
<a name="3226"><span class="lineNum">    3226 </span>            : /*      point placement node for the text symbolizer.                  */</a>
<span class="lineNum">    3227 </span>            : /************************************************************************/
<span class="lineNum">    3228 </span><span class="lineCov">          1 : int ParseTextPointPlacement(CPLXMLNode *psRoot, classObj *psClass)</span>
<span class="lineNum">    3229 </span>            : {
<span class="lineNum">    3230 </span>            :   CPLXMLNode *psAnchor, *psAnchorX, *psAnchorY;
<span class="lineNum">    3231 </span>            :   double dfAnchorX=0, dfAnchorY=0;
<span class="lineNum">    3232 </span>            :   CPLXMLNode *psDisplacement, *psDisplacementX, *psDisplacementY;
<span class="lineNum">    3233 </span>            :   CPLXMLNode *psRotation=NULL;
<span class="lineNum">    3234 </span>            :   labelObj *psLabelObj = NULL;
<span class="lineNum">    3235 </span>            : 
<span class="lineNum">    3236 </span><span class="lineCov">          1 :   if (!psRoot || !psClass)</span>
<span class="lineNum">    3237 </span>            :     return MS_FAILURE;
<span class="lineNum">    3238 </span><span class="lineCov">          1 :   if(psClass-&gt;numlabels == 0) {</span>
<span class="lineNum">    3239 </span><span class="lineNoCov">          0 :     if(msGrowClassLabels(psClass) == NULL) return(MS_FAILURE);</span>
<span class="lineNum">    3240 </span><span class="lineNoCov">          0 :     initLabel(psClass-&gt;labels[0]);</span>
<span class="lineNum">    3241 </span><span class="lineNoCov">          0 :     psClass-&gt;numlabels++;</span>
<span class="lineNum">    3242 </span>            :   }
<span class="lineNum">    3243 </span><span class="lineCov">          1 :   psLabelObj = psClass-&gt;labels[0];</span>
<span class="lineNum">    3244 </span>            : 
<span class="lineNum">    3245 </span>            :   /* init the label with the default position */
<span class="lineNum">    3246 </span><span class="lineCov">          1 :   psLabelObj-&gt;position = MS_CL;</span>
<span class="lineNum">    3247 </span>            : 
<span class="lineNum">    3248 </span>            :   /* -------------------------------------------------------------------- */
<span class="lineNum">    3249 </span>            :   /*      parse anchor point. see function msSLDParseTextSymbolizer       */
<span class="lineNum">    3250 </span>            :   /*      for documentation.                                              */
<span class="lineNum">    3251 </span>            :   /* -------------------------------------------------------------------- */
<span class="lineNum">    3252 </span><span class="lineCov">          1 :   psAnchor = CPLGetXMLNode(psRoot, &quot;AnchorPoint&quot;);</span>
<span class="lineNum">    3253 </span><span class="lineCov">          1 :   if (psAnchor) {</span>
<span class="lineNum">    3254 </span><span class="lineCov">          1 :     psAnchorX = CPLGetXMLNode(psAnchor, &quot;AnchorPointX&quot;);</span>
<span class="lineNum">    3255 </span><span class="lineCov">          1 :     psAnchorY = CPLGetXMLNode(psAnchor, &quot;AnchorPointY&quot;);</span>
<span class="lineNum">    3256 </span>            :     /* psCssParam-&gt;psChild-&gt;psNext-&gt;pszValue) */
<span class="lineNum">    3257 </span><span class="lineCov">          1 :     if (psAnchorX &amp;&amp;</span>
<span class="lineNum">    3258 </span><span class="lineCov">          1 :         psAnchorX-&gt;psChild &amp;&amp;</span>
<span class="lineNum">    3259 </span><span class="lineCov">          1 :         psAnchorX-&gt;psChild-&gt;pszValue &amp;&amp;</span>
<span class="lineNum">    3260 </span><span class="lineCov">          1 :         psAnchorY &amp;&amp;</span>
<span class="lineNum">    3261 </span><span class="lineCov">          1 :         psAnchorY-&gt;psChild &amp;&amp;</span>
<span class="lineNum">    3262 </span><span class="lineCov">          1 :         psAnchorY-&gt;psChild-&gt;pszValue) {</span>
<span class="lineNum">    3263 </span>            :       dfAnchorX = atof(psAnchorX-&gt;psChild-&gt;pszValue);
<span class="lineNum">    3264 </span><span class="lineCov">          1 :       dfAnchorY = atof(psAnchorY-&gt;psChild-&gt;pszValue);</span>
<span class="lineNum">    3265 </span>            : 
<span class="lineNum">    3266 </span><span class="lineCov">          1 :       if ((dfAnchorX == 0 || dfAnchorX == 0.5 || dfAnchorX == 1) &amp;&amp;</span>
<span class="lineNum">    3267 </span><span class="lineCov">          1 :           (dfAnchorY == 0 || dfAnchorY == 0.5 || dfAnchorY == 1)) {</span>
<span class="lineNum">    3268 </span><span class="lineCov">          1 :         if (dfAnchorX == 0 &amp;&amp; dfAnchorY == 0)</span>
<span class="lineNum">    3269 </span><span class="lineCov">          1 :           psLabelObj-&gt;position = MS_LL;</span>
<span class="lineNum">    3270 </span><span class="lineCov">          1 :         if (dfAnchorX == 0 &amp;&amp; dfAnchorY == 0.5)</span>
<span class="lineNum">    3271 </span><span class="lineNoCov">          0 :           psLabelObj-&gt;position = MS_CL;</span>
<span class="lineNum">    3272 </span><span class="lineCov">          1 :         if (dfAnchorX == 0 &amp;&amp; dfAnchorY == 1)</span>
<span class="lineNum">    3273 </span><span class="lineNoCov">          0 :           psLabelObj-&gt;position = MS_UL;</span>
<span class="lineNum">    3274 </span>            : 
<span class="lineNum">    3275 </span><span class="lineCov">          1 :         if (dfAnchorX == 0.5 &amp;&amp; dfAnchorY == 0)</span>
<span class="lineNum">    3276 </span><span class="lineNoCov">          0 :           psLabelObj-&gt;position = MS_LC;</span>
<span class="lineNum">    3277 </span><span class="lineCov">          1 :         if (dfAnchorX == 0.5 &amp;&amp; dfAnchorY == 0.5)</span>
<span class="lineNum">    3278 </span><span class="lineCov">          1 :           psLabelObj-&gt;position = MS_CC;</span>
<span class="lineNum">    3279 </span><span class="lineCov">          1 :         if (dfAnchorX == 0.5 &amp;&amp; dfAnchorY == 1)</span>
<span class="lineNum">    3280 </span><span class="lineNoCov">          0 :           psLabelObj-&gt;position = MS_UC;</span>
<span class="lineNum">    3281 </span>            : 
<span class="lineNum">    3282 </span><span class="lineCov">          1 :         if (dfAnchorX == 1 &amp;&amp; dfAnchorY == 0)</span>
<span class="lineNum">    3283 </span><span class="lineNoCov">          0 :           psLabelObj-&gt;position = MS_LR;</span>
<span class="lineNum">    3284 </span><span class="lineCov">          1 :         if (dfAnchorX == 1 &amp;&amp; dfAnchorY == 0.5)</span>
<span class="lineNum">    3285 </span><span class="lineNoCov">          0 :           psLabelObj-&gt;position = MS_CR;</span>
<span class="lineNum">    3286 </span><span class="lineCov">          1 :         if (dfAnchorX == 1 &amp;&amp; dfAnchorY == 1)</span>
<span class="lineNum">    3287 </span><span class="lineNoCov">          0 :           psLabelObj-&gt;position = MS_UR;</span>
<span class="lineNum">    3288 </span>            :       }
<span class="lineNum">    3289 </span>            :     }
<span class="lineNum">    3290 </span>            :   }
<span class="lineNum">    3291 </span>            : 
<span class="lineNum">    3292 </span>            :   /* -------------------------------------------------------------------- */
<span class="lineNum">    3293 </span>            :   /*      Parse displacement                                              */
<span class="lineNum">    3294 </span>            :   /* -------------------------------------------------------------------- */
<span class="lineNum">    3295 </span><span class="lineCov">          1 :   psDisplacement = CPLGetXMLNode(psRoot, &quot;Displacement&quot;);</span>
<span class="lineNum">    3296 </span><span class="lineCov">          1 :   if (psDisplacement) {</span>
<span class="lineNum">    3297 </span><span class="lineCov">          1 :     psDisplacementX = CPLGetXMLNode(psDisplacement, &quot;DisplacementX&quot;);</span>
<span class="lineNum">    3298 </span><span class="lineCov">          1 :     psDisplacementY = CPLGetXMLNode(psDisplacement, &quot;DisplacementY&quot;);</span>
<span class="lineNum">    3299 </span>            :     /* psCssParam-&gt;psChild-&gt;psNext-&gt;pszValue) */
<span class="lineNum">    3300 </span><span class="lineCov">          1 :     if (psDisplacementX &amp;&amp;</span>
<span class="lineNum">    3301 </span><span class="lineCov">          1 :         psDisplacementX-&gt;psChild &amp;&amp;</span>
<span class="lineNum">    3302 </span><span class="lineCov">          1 :         psDisplacementX-&gt;psChild-&gt;pszValue &amp;&amp;</span>
<span class="lineNum">    3303 </span><span class="lineCov">          1 :         psDisplacementY &amp;&amp;</span>
<span class="lineNum">    3304 </span><span class="lineCov">          1 :         psDisplacementY-&gt;psChild &amp;&amp;</span>
<span class="lineNum">    3305 </span><span class="lineCov">          1 :         psDisplacementY-&gt;psChild-&gt;pszValue) {</span>
<span class="lineNum">    3306 </span><span class="lineCov">          1 :       psLabelObj-&gt;offsetx = atoi(psDisplacementX-&gt;psChild-&gt;pszValue);</span>
<span class="lineNum">    3307 </span><span class="lineCov">          1 :       psLabelObj-&gt;offsety = atoi(psDisplacementY-&gt;psChild-&gt;pszValue);</span>
<span class="lineNum">    3308 </span>            :     }
<span class="lineNum">    3309 </span>            :   }
<span class="lineNum">    3310 </span>            : 
<span class="lineNum">    3311 </span>            :   /* -------------------------------------------------------------------- */
<span class="lineNum">    3312 </span>            :   /*      parse rotation.                                                 */
<span class="lineNum">    3313 </span>            :   /* -------------------------------------------------------------------- */
<span class="lineNum">    3314 </span><span class="lineCov">          1 :   psRotation = CPLGetXMLNode(psRoot, &quot;Rotation&quot;);</span>
<span class="lineNum">    3315 </span><span class="lineCov">          1 :   if (psRotation &amp;&amp; psRotation-&gt;psChild)</span>
<span class="lineNum">    3316 </span>            :   {
<span class="lineNum">    3317 </span><span class="lineCov">          1 :     msSLDParseOgcExpression(psRotation-&gt;psChild, psLabelObj,</span>
<span class="lineNum">    3318 </span>            :         MS_LABEL_BINDING_ANGLE, MS_OBJ_LABEL);
<span class="lineNum">    3319 </span>            :   }
<span class="lineNum">    3320 </span>            : 
<span class="lineNum">    3321 </span>            :   return MS_SUCCESS;
<span class="lineNum">    3322 </span>            : }
<span class="lineNum">    3323 </span>            : 
<span class="lineNum">    3324 </span>            : /************************************************************************/
<span class="lineNum">    3325 </span>            : /*                          ParseTextLinePlacement                      */
<span class="lineNum">    3326 </span>            : /*                                                                      */
<a name="3327"><span class="lineNum">    3327 </span>            : /*      Lineplacement node fro the text symbolizer.                     */</a>
<span class="lineNum">    3328 </span>            : /************************************************************************/
<span class="lineNum">    3329 </span><span class="lineNoCov">          0 : int ParseTextLinePlacement(CPLXMLNode *psRoot, classObj *psClass)</span>
<span class="lineNum">    3330 </span>            : {
<span class="lineNum">    3331 </span>            :   CPLXMLNode *psOffset = NULL, *psAligned=NULL;
<span class="lineNum">    3332 </span>            :   labelObj *psLabelObj = NULL;
<span class="lineNum">    3333 </span>            : 
<span class="lineNum">    3334 </span><span class="lineNoCov">          0 :   if (!psRoot || !psClass)</span>
<span class="lineNum">    3335 </span>            :     return MS_FAILURE;
<span class="lineNum">    3336 </span>            : 
<span class="lineNum">    3337 </span><span class="lineNoCov">          0 :   if(psClass-&gt;numlabels == 0) {</span>
<span class="lineNum">    3338 </span><span class="lineNoCov">          0 :     if(msGrowClassLabels(psClass) == NULL) return(MS_FAILURE);</span>
<span class="lineNum">    3339 </span><span class="lineNoCov">          0 :     initLabel(psClass-&gt;labels[0]);</span>
<span class="lineNum">    3340 </span><span class="lineNoCov">          0 :     psClass-&gt;numlabels++;</span>
<span class="lineNum">    3341 </span>            :   }
<span class="lineNum">    3342 </span><span class="lineNoCov">          0 :   psLabelObj = psClass-&gt;labels[0];</span>
<span class="lineNum">    3343 </span>            : 
<span class="lineNum">    3344 </span>            :   /*if there is a line placement, we will assume that the
<span class="lineNum">    3345 </span>            :     best setting for mapserver would be for the text to follow
<span class="lineNum">    3346 </span>            :     the line #2806*/
<span class="lineNum">    3347 </span><span class="lineNoCov">          0 :   psLabelObj-&gt;anglemode = MS_FOLLOW;</span>
<span class="lineNum">    3348 </span>            : 
<span class="lineNum">    3349 </span>            :   /*sld 1.1.0 has a parameter IsAligned. default value is true*/
<span class="lineNum">    3350 </span><span class="lineNoCov">          0 :   psAligned = CPLGetXMLNode(psRoot, &quot;IsAligned&quot;);</span>
<span class="lineNum">    3351 </span><span class="lineNoCov">          0 :   if (psAligned &amp;&amp; psAligned-&gt;psChild &amp;&amp; psAligned-&gt;psChild-&gt;pszValue &amp;&amp;</span>
<span class="lineNum">    3352 </span><span class="lineNoCov">          0 :       strcasecmp(psAligned-&gt;psChild-&gt;pszValue, &quot;false&quot;) == 0) {</span>
<span class="lineNum">    3353 </span><span class="lineNoCov">          0 :     psLabelObj-&gt;anglemode = MS_NONE;</span>
<span class="lineNum">    3354 </span>            :   }
<span class="lineNum">    3355 </span><span class="lineNoCov">          0 :   psOffset = CPLGetXMLNode(psRoot, &quot;PerpendicularOffset&quot;);</span>
<span class="lineNum">    3356 </span><span class="lineNoCov">          0 :   if (psOffset &amp;&amp; psOffset-&gt;psChild &amp;&amp; psOffset-&gt;psChild-&gt;pszValue) {</span>
<span class="lineNum">    3357 </span><span class="lineNoCov">          0 :     psLabelObj-&gt;offsetx = atoi(psOffset-&gt;psChild-&gt;pszValue);</span>
<span class="lineNum">    3358 </span><span class="lineNoCov">          0 :     psLabelObj-&gt;offsety = MS_LABEL_PERPENDICULAR_OFFSET;</span>
<span class="lineNum">    3359 </span>            : 
<span class="lineNum">    3360 </span>            :     /*if there is a PerpendicularOffset, we will assume that the
<span class="lineNum">    3361 </span>            :       best setting for mapserver would be to use angle=0 and the
<span class="lineNum">    3362 </span>            :       the offset #2806*/
<span class="lineNum">    3363 </span>            :     /* since sld 1.1.0 introduces the IsAligned parameter, only
<span class="lineNum">    3364 </span>            :        set the angles if the parameter is not set*/
<span class="lineNum">    3365 </span><span class="lineNoCov">          0 :     if (!psAligned) {</span>
<span class="lineNum">    3366 </span><span class="lineNoCov">          0 :       psLabelObj-&gt;anglemode = MS_NONE;</span>
<span class="lineNum">    3367 </span><span class="lineNoCov">          0 :       psLabelObj-&gt;offsety = psLabelObj-&gt;offsetx;</span>
<span class="lineNum">    3368 </span>            :     }
<span class="lineNum">    3369 </span>            :   }
<span class="lineNum">    3370 </span>            : 
<span class="lineNum">    3371 </span>            :   return MS_SUCCESS;
<span class="lineNum">    3372 </span>            : }
<span class="lineNum">    3373 </span>            : 
<span class="lineNum">    3374 </span>            : 
<span class="lineNum">    3375 </span>            : /************************************************************************/
<span class="lineNum">    3376 </span>            : /*           void msSLDSetColorObject(char *psHexColor, colorObj        */
<span class="lineNum">    3377 </span>            : /*      *psColor)                                                       */
<span class="lineNum">    3378 </span>            : /*                                                                      */
<span class="lineNum">    3379 </span>            : /*      Utility function to extract rgb values from an hexadecimal     */
<span class="lineNum">    3380 </span>            : /*      color string (format is : #aaff08) and set it in the color      */
<a name="3381"><span class="lineNum">    3381 </span>            : /*      object.                                                         */</a>
<span class="lineNum">    3382 </span>            : /************************************************************************/
<span class="lineNum">    3383 </span><span class="lineNoCov">          0 : int msSLDSetColorObject(char *psHexColor, colorObj *psColor)</span>
<span class="lineNum">    3384 </span>            : {
<span class="lineNum">    3385 </span><span class="lineNoCov">          0 :   if (psHexColor &amp;&amp; psColor &amp;&amp; strlen(psHexColor)== 7 &amp;&amp;</span>
<span class="lineNum">    3386 </span><span class="lineNoCov">          0 :       psHexColor[0] == '#') {</span>
<span class="lineNum">    3387 </span>            : 
<span class="lineNum">    3388 </span><span class="lineNoCov">          0 :     psColor-&gt;red = msHexToInt(psHexColor+1);</span>
<span class="lineNum">    3389 </span><span class="lineNoCov">          0 :     psColor-&gt;green = msHexToInt(psHexColor+3);</span>
<span class="lineNum">    3390 </span><span class="lineNoCov">          0 :     psColor-&gt;blue= msHexToInt(psHexColor+5);</span>
<span class="lineNum">    3391 </span>            :   }
<span class="lineNum">    3392 </span>            : 
<span class="lineNum">    3393 </span><span class="lineNoCov">          0 :   return MS_SUCCESS;</span>
<span class="lineNum">    3394 </span>            : }
<span class="lineNum">    3395 </span>            : 
<span class="lineNum">    3396 </span>            : /* -------------------------------------------------------------------- */
<span class="lineNum">    3397 </span>            : /*      client sld support functions                                    */
<span class="lineNum">    3398 </span>            : /* -------------------------------------------------------------------- */
<span class="lineNum">    3399 </span>            : 
<span class="lineNum">    3400 </span>            : /************************************************************************/
<span class="lineNum">    3401 </span>            : /*                msSLDGenerateSLD(mapObj *map, int iLayer)             */
<span class="lineNum">    3402 </span>            : /*                                                                      */
<span class="lineNum">    3403 </span>            : /*      Return an SLD document for all layers that are on or            */
<span class="lineNum">    3404 </span>            : /*      default. The second argument should be set to -1 to generate    */
<span class="lineNum">    3405 </span>            : /*      on all layers. Or set to the layer index to generate an SLD     */
<span class="lineNum">    3406 </span>            : /*      for a specific layer.                                           */
<span class="lineNum">    3407 </span>            : /*                                                                      */
<a name="3408"><span class="lineNum">    3408 </span>            : /*      The caller should free the returned string.                     */</a>
<span class="lineNum">    3409 </span>            : /************************************************************************/
<span class="lineNum">    3410 </span><span class="lineCov">          1 : char *msSLDGenerateSLD(mapObj *map, int iLayer, const char *pszVersion)</span>
<span class="lineNum">    3411 </span>            : {
<span class="lineNum">    3412 </span>            : #if defined(USE_WMS_SVR) || defined (USE_WFS_SVR) || defined (USE_WCS_SVR) || defined(USE_SOS_SVR)
<span class="lineNum">    3413 </span>            : 
<span class="lineNum">    3414 </span>            :   char szTmp[500];
<span class="lineNum">    3415 </span>            :   int i = 0;
<span class="lineNum">    3416 </span>            :   char *pszTmp = NULL;
<span class="lineNum">    3417 </span>            :   char *pszSLD = NULL;
<span class="lineNum">    3418 </span>            :   char *schemalocation = NULL;
<span class="lineNum">    3419 </span>            :   int sld_version = OWS_VERSION_NOTSET;
<span class="lineNum">    3420 </span>            : 
<span class="lineNum">    3421 </span><span class="lineCov">          1 :   sld_version = msOWSParseVersionString(pszVersion);</span>
<span class="lineNum">    3422 </span>            : 
<span class="lineNum">    3423 </span><span class="lineCov">          1 :   if (sld_version == OWS_VERSION_NOTSET ||</span>
<span class="lineNum">    3424 </span><span class="lineCov">          1 :       (sld_version!= OWS_1_0_0 &amp;&amp; sld_version!= OWS_1_1_0))</span>
<span class="lineNum">    3425 </span>            :     sld_version = OWS_1_0_0;
<span class="lineNum">    3426 </span>            : 
<span class="lineNum">    3427 </span><span class="lineCov">          1 :   if (map) {</span>
<span class="lineNum">    3428 </span><span class="lineCov">          1 :     schemalocation = msEncodeHTMLEntities(msOWSGetSchemasLocation(map));</span>
<span class="lineNum">    3429 </span><span class="lineCov">          1 :     if (sld_version ==  OWS_1_0_0)</span>
<span class="lineNum">    3430 </span>            :       snprintf(szTmp, sizeof(szTmp), &quot;&lt;StyledLayerDescriptor version=\&quot;1.0.0\&quot; xmlns=\&quot;http://www.opengis.net/sld\&quot; xmlns:gml=\&quot;http://www.opengis.net/gml\&quot; xmlns:ogc=\&quot;http://www.opengis.net/ogc\&quot; xmlns:xlink=\&quot;http://www.w3.org/1999/xlink\&quot; xmlns:xsi=\&quot;http://www.w3.org/2001/XMLSchema-instance\&quot; xsi:schemaLocation=\&quot;http://www.opengis.net/sld %s/sld/1.0.0/StyledLayerDescriptor.xsd\&quot;&gt;\n&quot;,schemalocation );
<span class="lineNum">    3431 </span>            :     else
<span class="lineNum">    3432 </span>            :       snprintf(szTmp, sizeof(szTmp), &quot;&lt;StyledLayerDescriptor version=\&quot;1.1.0\&quot; xsi:schemaLocation=\&quot;http://www.opengis.net/sld %s/sld/1.1.0/StyledLayerDescriptor.xsd\&quot; xmlns=\&quot;http://www.opengis.net/sld\&quot; xmlns:ogc=\&quot;http://www.opengis.net/ogc\&quot; xmlns:se=\&quot;http://www.opengis.net/se\&quot; xmlns:xlink=\&quot;http://www.w3.org/1999/xlink\&quot; xmlns:xsi=\&quot;http://www.w3.org/2001/XMLSchema-instance\&quot;&gt;\n&quot;, schemalocation);
<span class="lineNum">    3433 </span>            : 
<span class="lineNum">    3434 </span><span class="lineCov">          1 :     free(schemalocation);</span>
<span class="lineNum">    3435 </span>            : 
<span class="lineNum">    3436 </span><span class="lineCov">          1 :     pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    3437 </span><span class="lineCov">          1 :     if (iLayer &lt; 0 || iLayer &gt; map-&gt;numlayers -1) {</span>
<span class="lineNum">    3438 </span><span class="lineCov">          1 :       for (i=0; i&lt;map-&gt;numlayers; i++) {</span>
<span class="lineNum">    3439 </span><span class="lineCov">          1 :         pszTmp = msSLDGenerateSLDLayer(GET_LAYER(map, i), sld_version);</span>
<span class="lineNum">    3440 </span><span class="lineCov">          1 :         if (pszTmp) {</span>
<span class="lineNum">    3441 </span><span class="lineCov">          1 :           pszSLD= msStringConcatenate(pszSLD, pszTmp);</span>
<span class="lineNum">    3442 </span><span class="lineCov">          1 :           free(pszTmp);</span>
<span class="lineNum">    3443 </span>            :         }
<span class="lineNum">    3444 </span>            :       }
<span class="lineNum">    3445 </span>            :     } else {
<span class="lineNum">    3446 </span><span class="lineNoCov">          0 :       pszTmp = msSLDGenerateSLDLayer(GET_LAYER(map, iLayer), sld_version);</span>
<span class="lineNum">    3447 </span><span class="lineNoCov">          0 :       if (pszTmp) {</span>
<span class="lineNum">    3448 </span><span class="lineNoCov">          0 :         pszSLD = msStringConcatenate(pszSLD, pszTmp);</span>
<span class="lineNum">    3449 </span><span class="lineNoCov">          0 :         free(pszTmp);</span>
<span class="lineNum">    3450 </span>            :       }
<span class="lineNum">    3451 </span>            :     }
<span class="lineNum">    3452 </span>            :     snprintf(szTmp, sizeof(szTmp), &quot;%s&quot;, &quot;&lt;/StyledLayerDescriptor&gt;\n&quot;);
<span class="lineNum">    3453 </span><span class="lineCov">          1 :     pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    3454 </span>            :   }
<span class="lineNum">    3455 </span>            : 
<span class="lineNum">    3456 </span><span class="lineCov">          1 :   return pszSLD;</span>
<span class="lineNum">    3457 </span>            : 
<span class="lineNum">    3458 </span>            : #else
<span class="lineNum">    3459 </span>            :   msSetError(MS_MISCERR, &quot;OWS support is not available.&quot;,
<span class="lineNum">    3460 </span>            :              &quot;msSLDGenerateSLDLayer()&quot;);
<span class="lineNum">    3461 </span>            :   return NULL;
<span class="lineNum">    3462 </span>            : 
<span class="lineNum">    3463 </span>            : #endif
<span class="lineNum">    3464 </span>            : }
<span class="lineNum">    3465 </span>            : 
<span class="lineNum">    3466 </span>            : 
<span class="lineNum">    3467 </span>            : 
<span class="lineNum">    3468 </span>            : /************************************************************************/
<span class="lineNum">    3469 </span>            : /*                            msSLDGetGraphicSLD                        */
<span class="lineNum">    3470 </span>            : /*                                                                      */
<a name="3471"><span class="lineNum">    3471 </span>            : /*      Get an SLD for a style containing a symbol (Mark or external).  */</a>
<span class="lineNum">    3472 </span>            : /************************************************************************/
<span class="lineNum">    3473 </span><span class="lineCov">          1 : char *msSLDGetGraphicSLD(styleObj *psStyle, layerObj *psLayer,</span>
<span class="lineNum">    3474 </span>            :                          int bNeedMarkSybol, int nVersion)
<span class="lineNum">    3475 </span>            : {
<span class="lineNum">    3476 </span>            : #if defined(USE_WMS_SVR) || defined (USE_WFS_SVR) || defined (USE_WCS_SVR) || defined(USE_SOS_SVR)
<span class="lineNum">    3477 </span>            : 
<span class="lineNum">    3478 </span><span class="lineCov">          1 :   msStringBuffer * sldString = msStringBufferAlloc();</span>
<span class="lineNum">    3479 </span>            :   int nSymbol = -1;
<span class="lineNum">    3480 </span>            :   symbolObj *psSymbol = NULL;
<span class="lineNum">    3481 </span>            :   char szTmp[512];
<span class="lineNum">    3482 </span>            :   char szFormat[4];
<span class="lineNum">    3483 </span>            :   int i = 0, nLength = 0;
<span class="lineNum">    3484 </span>            :   int bColorAvailable=0;
<span class="lineNum">    3485 </span>            :   int bGenerateDefaultSymbol = 0;
<span class="lineNum">    3486 </span>            :   char *pszSymbolName= NULL;
<span class="lineNum">    3487 </span>            :   char sNameSpace[10];
<span class="lineNum">    3488 </span>            :   char sCssParam[30];
<span class="lineNum">    3489 </span>            : 
<span class="lineNum">    3490 </span><span class="lineCov">          1 :   sCssParam[0] = '\0';</span>
<span class="lineNum">    3491 </span><span class="lineCov">          1 :   if (nVersion &gt; OWS_1_0_0)</span>
<span class="lineNum">    3492 </span>            :     strcpy(sCssParam, &quot;se:SvgParameter&quot;);
<span class="lineNum">    3493 </span>            :   else
<span class="lineNum">    3494 </span>            :     strcpy(sCssParam, &quot;CssParameter&quot;);
<span class="lineNum">    3495 </span>            : 
<span class="lineNum">    3496 </span><span class="lineCov">          1 :   sNameSpace[0] = '\0';</span>
<span class="lineNum">    3497 </span><span class="lineCov">          1 :   if (nVersion &gt; OWS_1_0_0)</span>
<span class="lineNum">    3498 </span>            :     strcpy(sNameSpace, &quot;se:&quot;);
<span class="lineNum">    3499 </span>            : 
<span class="lineNum">    3500 </span><span class="lineCov">          1 :   if (psStyle &amp;&amp; psLayer &amp;&amp; psLayer-&gt;map) {</span>
<span class="lineNum">    3501 </span>            :     nSymbol = -1;
<span class="lineNum">    3502 </span><span class="lineCov">          1 :     if (psStyle-&gt;symbol &gt; 0)</span>
<span class="lineNum">    3503 </span>            :       nSymbol = psStyle-&gt;symbol;
<span class="lineNum">    3504 </span><span class="lineCov">          1 :     else if (psStyle-&gt;symbolname)</span>
<span class="lineNum">    3505 </span><span class="lineNoCov">          0 :       nSymbol = msGetSymbolIndex(&amp;psLayer-&gt;map-&gt;symbolset,</span>
<span class="lineNum">    3506 </span>            :                                  psStyle-&gt;symbolname, MS_FALSE);
<span class="lineNum">    3507 </span>            : 
<span class="lineNum">    3508 </span>            :     bGenerateDefaultSymbol = 0;
<span class="lineNum">    3509 </span>            : 
<span class="lineNum">    3510 </span><span class="lineCov">          1 :     if (bNeedMarkSybol &amp;&amp;</span>
<span class="lineNum">    3511 </span><span class="lineCov">          1 :         (nSymbol &lt;=0 || nSymbol &gt;=  psLayer-&gt;map-&gt;symbolset.numsymbols))</span>
<span class="lineNum">    3512 </span>            :       bGenerateDefaultSymbol = 1;
<span class="lineNum">    3513 </span>            : 
<span class="lineNum">    3514 </span><span class="lineCov">          1 :     if (nSymbol &gt; 0 &amp;&amp; nSymbol &lt; psLayer-&gt;map-&gt;symbolset.numsymbols) {</span>
<span class="lineNum">    3515 </span><span class="lineCov">          1 :       psSymbol =  psLayer-&gt;map-&gt;symbolset.symbol[nSymbol];</span>
<span class="lineNum">    3516 </span><span class="lineCov">          1 :       if (psSymbol-&gt;type == MS_SYMBOL_VECTOR ||</span>
<span class="lineNum">    3517 </span>            :           psSymbol-&gt;type == MS_SYMBOL_ELLIPSE) {
<span class="lineNum">    3518 </span>            :         /* Mark symbol */
<span class="lineNum">    3519 </span><span class="lineCov">          1 :         if (psSymbol-&gt;name)</span>
<span class="lineNum">    3520 </span>            : 
<span class="lineNum">    3521 </span>            :         {
<span class="lineNum">    3522 </span><span class="lineCov">          1 :           if (strcasecmp(psSymbol-&gt;name, &quot;square&quot;) == 0 ||</span>
<span class="lineNum">    3523 </span><span class="lineCov">          1 :               strcasecmp(psSymbol-&gt;name, &quot;circle&quot;) == 0 ||</span>
<span class="lineNum">    3524 </span><span class="lineCov">          1 :               strcasecmp(psSymbol-&gt;name, &quot;triangle&quot;) == 0 ||</span>
<span class="lineNum">    3525 </span><span class="lineCov">          1 :               strcasecmp(psSymbol-&gt;name, &quot;star&quot;) == 0 ||</span>
<span class="lineNum">    3526 </span><span class="lineCov">          1 :               strcasecmp(psSymbol-&gt;name, &quot;cross&quot;) == 0 ||</span>
<span class="lineNum">    3527 </span><span class="lineCov">          1 :               strcasecmp(psSymbol-&gt;name, &quot;x&quot;) == 0)</span>
<span class="lineNum">    3528 </span><span class="lineCov">          1 :             pszSymbolName = msStrdup(psSymbol-&gt;name);</span>
<span class="lineNum">    3529 </span><span class="lineCov">          1 :           else if (strncasecmp(psSymbol-&gt;name,</span>
<span class="lineNum">    3530 </span>            :                                &quot;sld_mark_symbol_square&quot;, 22) == 0)
<span class="lineNum">    3531 </span><span class="lineNoCov">          0 :             pszSymbolName = msStrdup(&quot;square&quot;);</span>
<span class="lineNum">    3532 </span><span class="lineCov">          1 :           else if (strncasecmp(psSymbol-&gt;name,</span>
<span class="lineNum">    3533 </span>            :                                &quot;sld_mark_symbol_triangle&quot;, 24) == 0)
<span class="lineNum">    3534 </span><span class="lineNoCov">          0 :             pszSymbolName = msStrdup(&quot;triangle&quot;);</span>
<span class="lineNum">    3535 </span><span class="lineCov">          1 :           else if (strncasecmp(psSymbol-&gt;name,</span>
<span class="lineNum">    3536 </span>            :                                &quot;sld_mark_symbol_circle&quot;, 22) == 0)
<span class="lineNum">    3537 </span><span class="lineNoCov">          0 :             pszSymbolName = msStrdup(&quot;circle&quot;);</span>
<span class="lineNum">    3538 </span><span class="lineCov">          1 :           else if (strncasecmp(psSymbol-&gt;name,</span>
<span class="lineNum">    3539 </span>            :                                &quot;sld_mark_symbol_star&quot;, 20) == 0)
<span class="lineNum">    3540 </span><span class="lineCov">          1 :             pszSymbolName = msStrdup(&quot;star&quot;);</span>
<span class="lineNum">    3541 </span><span class="lineNoCov">          0 :           else if (strncasecmp(psSymbol-&gt;name,</span>
<span class="lineNum">    3542 </span>            :                                &quot;sld_mark_symbol_cross&quot;, 21) == 0)
<span class="lineNum">    3543 </span><span class="lineNoCov">          0 :             pszSymbolName = msStrdup(&quot;cross&quot;);</span>
<span class="lineNum">    3544 </span><span class="lineNoCov">          0 :           else if (strncasecmp(psSymbol-&gt;name,</span>
<span class="lineNum">    3545 </span>            :                                &quot;sld_mark_symbol_x&quot;, 17) == 0)
<span class="lineNum">    3546 </span><span class="lineNoCov">          0 :             pszSymbolName = msStrdup(&quot;X&quot;);</span>
<span class="lineNum">    3547 </span>            : 
<span class="lineNum">    3548 </span>            : 
<span class="lineNum">    3549 </span>            : 
<span class="lineNum">    3550 </span><span class="lineCov">          1 :           if (pszSymbolName) {</span>
<span class="lineNum">    3551 </span>            :             colorObj sTmpFillColor = { 128, 128, 128, 255 };
<span class="lineNum">    3552 </span>            :             colorObj sTmpStrokeColor = { 0, 0, 0, 255 };
<span class="lineNum">    3553 </span>            :             int hasFillColor = 0;
<span class="lineNum">    3554 </span>            :             int hasStrokeColor = 0;
<span class="lineNum">    3555 </span>            : 
<span class="lineNum">    3556 </span>            :             snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sGraphic&gt;\n&quot;, sNameSpace);
<span class="lineNum">    3557 </span><span class="lineCov">          1 :             msStringBufferAppend(sldString, szTmp);</span>
<span class="lineNum">    3558 </span>            : 
<span class="lineNum">    3559 </span>            :             snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sMark&gt;\n&quot;, sNameSpace);
<span class="lineNum">    3560 </span><span class="lineCov">          1 :             msStringBufferAppend(sldString, szTmp);</span>
<span class="lineNum">    3561 </span>            : 
<span class="lineNum">    3562 </span>            :             snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sWellKnownName&gt;%s&lt;/%sWellKnownName&gt;\n&quot;,
<span class="lineNum">    3563 </span>            :                 sNameSpace, pszSymbolName, sNameSpace);
<span class="lineNum">    3564 </span><span class="lineCov">          1 :             msStringBufferAppend(sldString, szTmp);</span>
<span class="lineNum">    3565 </span>            : 
<span class="lineNum">    3566 </span><span class="lineCov">          1 :             if (psStyle-&gt;color.red != -1 &amp;&amp;</span>
<span class="lineNum">    3567 </span><span class="lineCov">          1 :                 psStyle-&gt;color.green != -1 &amp;&amp;</span>
<span class="lineNum">    3568 </span><span class="lineCov">          1 :                 psStyle-&gt;color.blue != -1)</span>
<span class="lineNum">    3569 </span>            :             {
<span class="lineNum">    3570 </span>            :               sTmpFillColor.red = psStyle-&gt;color.red;
<span class="lineNum">    3571 </span>            :               sTmpFillColor.green = psStyle-&gt;color.green;
<span class="lineNum">    3572 </span>            :               sTmpFillColor.blue = psStyle-&gt;color.blue;
<span class="lineNum">    3573 </span><span class="lineCov">          1 :               sTmpFillColor.alpha = psStyle-&gt;color.alpha;</span>
<span class="lineNum">    3574 </span>            :               hasFillColor = 1;
<span class="lineNum">    3575 </span>            :             }
<span class="lineNum">    3576 </span><span class="lineCov">          1 :             if (psStyle-&gt;outlinecolor.red != -1 &amp;&amp;</span>
<span class="lineNum">    3577 </span><span class="lineCov">          1 :                 psStyle-&gt;outlinecolor.green != -1 &amp;&amp;</span>
<span class="lineNum">    3578 </span><span class="lineCov">          1 :                 psStyle-&gt;outlinecolor.blue != -1)</span>
<span class="lineNum">    3579 </span>            :             {
<span class="lineNum">    3580 </span>            :               sTmpStrokeColor.red = psStyle-&gt;outlinecolor.red;
<span class="lineNum">    3581 </span>            :               sTmpStrokeColor.green = psStyle-&gt;outlinecolor.green;
<span class="lineNum">    3582 </span>            :               sTmpStrokeColor.blue = psStyle-&gt;outlinecolor.blue;
<span class="lineNum">    3583 </span><span class="lineCov">          1 :               sTmpStrokeColor.alpha = psStyle-&gt;outlinecolor.alpha;</span>
<span class="lineNum">    3584 </span>            :               hasStrokeColor = 1;
<span class="lineNum">    3585 </span>            :               // Make defaults implicit
<span class="lineNum">    3586 </span><span class="lineCov">          1 :               if (sTmpStrokeColor.red == 0 &amp;&amp;</span>
<span class="lineNum">    3587 </span><span class="lineCov">          1 :                   sTmpStrokeColor.green == 0 &amp;&amp;</span>
<span class="lineNum">    3588 </span><span class="lineCov">          1 :                   sTmpStrokeColor.blue == 0 &amp;&amp;</span>
<span class="lineNum">    3589 </span><span class="lineCov">          1 :                   sTmpStrokeColor.alpha == 255 &amp;&amp;</span>
<span class="lineNum">    3590 </span><span class="lineCov">          1 :                   psStyle-&gt;width == 1)</span>
<span class="lineNum">    3591 </span>            :               {
<span class="lineNum">    3592 </span>            :                 hasStrokeColor = 0;
<span class="lineNum">    3593 </span>            :               }
<span class="lineNum">    3594 </span>            :             }
<span class="lineNum">    3595 </span><span class="lineCov">          1 :             if (!hasFillColor &amp;&amp; !hasStrokeColor)</span>
<span class="lineNum">    3596 </span>            :             {
<span class="lineNum">    3597 </span>            :               sTmpFillColor.red = 128;
<span class="lineNum">    3598 </span>            :               sTmpFillColor.green = 128;
<span class="lineNum">    3599 </span>            :               sTmpFillColor.blue = 128;
<span class="lineNum">    3600 </span>            :               sTmpFillColor.alpha = 255;
<span class="lineNum">    3601 </span>            :               hasFillColor = 1;
<span class="lineNum">    3602 </span>            :             }
<span class="lineNum">    3603 </span>            : 
<span class="lineNum">    3604 </span><span class="lineCov">          1 :             if (hasFillColor) {</span>
<span class="lineNum">    3605 </span>            :               snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sFill&gt;\n&quot;, sNameSpace);
<span class="lineNum">    3606 </span><span class="lineCov">          1 :               msStringBufferAppend(sldString, szTmp);</span>
<span class="lineNum">    3607 </span>            :               snprintf(szTmp, sizeof(szTmp), &quot;&lt;%s name=\&quot;fill\&quot;&gt;#%02x%02x%02x&lt;/%s&gt;\n&quot;,
<span class="lineNum">    3608 </span>            :                   sCssParam,
<span class="lineNum">    3609 </span>            :                   sTmpFillColor.red,
<span class="lineNum">    3610 </span>            :                   sTmpFillColor.green,
<span class="lineNum">    3611 </span>            :                   sTmpFillColor.blue,
<span class="lineNum">    3612 </span>            :                   sCssParam);
<span class="lineNum">    3613 </span><span class="lineCov">          1 :               msStringBufferAppend(sldString, szTmp);</span>
<span class="lineNum">    3614 </span><span class="lineCov">          1 :               if (sTmpFillColor.alpha != 255 &amp;&amp; sTmpFillColor.alpha != -1)</span>
<span class="lineNum">    3615 </span>            :               {
<span class="lineNum">    3616 </span><span class="lineCov">          1 :                 snprintf(szTmp, sizeof(szTmp), &quot;&lt;%s name=\&quot;fill-opacity\&quot;&gt;%.2f&lt;/%s&gt;\n&quot;,</span>
<span class="lineNum">    3617 </span>            :                     sCssParam,
<span class="lineNum">    3618 </span><span class="lineCov">          1 :                     (float)sTmpFillColor.alpha/255.0,</span>
<span class="lineNum">    3619 </span>            :                     sCssParam);
<span class="lineNum">    3620 </span><span class="lineCov">          1 :                 msStringBufferAppend(sldString, szTmp);</span>
<span class="lineNum">    3621 </span>            :               }
<span class="lineNum">    3622 </span>            :               snprintf(szTmp, sizeof(szTmp), &quot;&lt;/%sFill&gt;\n&quot;, sNameSpace);
<span class="lineNum">    3623 </span><span class="lineCov">          1 :               msStringBufferAppend(sldString, szTmp);</span>
<span class="lineNum">    3624 </span>            :             }
<span class="lineNum">    3625 </span><span class="lineCov">          1 :             if (hasStrokeColor) {</span>
<span class="lineNum">    3626 </span>            :               snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sStroke&gt;\n&quot;, sNameSpace);
<span class="lineNum">    3627 </span><span class="lineCov">          1 :               msStringBufferAppend(sldString, szTmp);</span>
<span class="lineNum">    3628 </span>            :               snprintf(szTmp, sizeof(szTmp), &quot;&lt;%s name=\&quot;stroke\&quot;&gt;#%02x%02x%02x&lt;/%s&gt;\n&quot;,
<span class="lineNum">    3629 </span>            :                   sCssParam,
<span class="lineNum">    3630 </span>            :                   sTmpStrokeColor.red,
<span class="lineNum">    3631 </span>            :                   sTmpStrokeColor.green,
<span class="lineNum">    3632 </span>            :                   sTmpStrokeColor.blue,
<span class="lineNum">    3633 </span>            :                   sCssParam);
<span class="lineNum">    3634 </span><span class="lineCov">          1 :               msStringBufferAppend(sldString, szTmp);</span>
<span class="lineNum">    3635 </span><span class="lineCov">          1 :               if (psStyle-&gt;width &gt; 0)</span>
<span class="lineNum">    3636 </span>            :               {
<span class="lineNum">    3637 </span>            :                 snprintf(szTmp, sizeof(szTmp), &quot;&lt;%s name=\&quot;stroke-width\&quot;&gt;%g&lt;/%s&gt;\n&quot;,
<span class="lineNum">    3638 </span>            :                     sCssParam,
<span class="lineNum">    3639 </span>            :                     psStyle-&gt;width,
<span class="lineNum">    3640 </span>            :                     sCssParam);
<span class="lineNum">    3641 </span><span class="lineCov">          1 :                 msStringBufferAppend(sldString, szTmp);</span>
<span class="lineNum">    3642 </span>            :               }
<span class="lineNum">    3643 </span><span class="lineCov">          1 :               if (sTmpStrokeColor.alpha != 255 &amp;&amp; sTmpStrokeColor.alpha != -1)</span>
<span class="lineNum">    3644 </span>            :               {
<span class="lineNum">    3645 </span><span class="lineCov">          1 :                 snprintf(szTmp, sizeof(szTmp), &quot;&lt;%s name=\&quot;stroke-opacity\&quot;&gt;%.2f&lt;/%s&gt;\n&quot;,</span>
<span class="lineNum">    3646 </span>            :                     sCssParam,
<span class="lineNum">    3647 </span><span class="lineCov">          1 :                     (float)sTmpStrokeColor.alpha/255.0,</span>
<span class="lineNum">    3648 </span>            :                     sCssParam);
<span class="lineNum">    3649 </span><span class="lineCov">          1 :                 msStringBufferAppend(sldString, szTmp);</span>
<span class="lineNum">    3650 </span>            :               }
<span class="lineNum">    3651 </span>            :               snprintf(szTmp, sizeof(szTmp), &quot;&lt;/%sStroke&gt;\n&quot;, sNameSpace);
<span class="lineNum">    3652 </span><span class="lineCov">          1 :               msStringBufferAppend(sldString, szTmp);</span>
<span class="lineNum">    3653 </span>            :             }
<span class="lineNum">    3654 </span>            : 
<span class="lineNum">    3655 </span>            :             snprintf(szTmp, sizeof(szTmp), &quot;&lt;/%sMark&gt;\n&quot;, sNameSpace);
<span class="lineNum">    3656 </span><span class="lineCov">          1 :             msStringBufferAppend(sldString, szTmp);</span>
<span class="lineNum">    3657 </span>            : 
<span class="lineNum">    3658 </span><span class="lineCov">          1 :             if (psStyle-&gt;size &gt; 0) {</span>
<span class="lineNum">    3659 </span>            :               snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sSize&gt;%g&lt;/%sSize&gt;\n&quot;,
<span class="lineNum">    3660 </span>            :                   sNameSpace, psStyle-&gt;size, sNameSpace);
<span class="lineNum">    3661 </span><span class="lineCov">          1 :               msStringBufferAppend(sldString, szTmp);</span>
<span class="lineNum">    3662 </span>            :             }
<span class="lineNum">    3663 </span>            : 
<span class="lineNum">    3664 </span><span class="lineCov">          1 :             if (fmod(psStyle-&gt;angle, 360))</span>
<span class="lineNum">    3665 </span>            :             {
<span class="lineNum">    3666 </span><span class="lineCov">          1 :               snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sRotation&gt;%g&lt;/%sRotation&gt;\n&quot;,</span>
<span class="lineNum">    3667 </span>            :                   sNameSpace, psStyle-&gt;angle, sNameSpace);
<span class="lineNum">    3668 </span><span class="lineCov">          1 :               msStringBufferAppend(sldString, szTmp);</span>
<span class="lineNum">    3669 </span>            :             }
<span class="lineNum">    3670 </span>            :          // Style opacity is already reported to alpha channel of color and outlinecolor
<span class="lineNum">    3671 </span>            :          // if (psStyle-&gt;opacity &lt; 100)
<span class="lineNum">    3672 </span>            :          // {
<span class="lineNum">    3673 </span>            :          //   snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sOpacity&gt;%g&lt;/%sOpacity&gt;\n&quot;,
<span class="lineNum">    3674 </span>            :          //       sNameSpace, psStyle-&gt;opacity/100.0, sNameSpace);
<span class="lineNum">    3675 </span>            :          //   pszSLD = msStringConcatenate(pszSLD, szTmp);
<span class="lineNum">    3676 </span>            :          // }
<span class="lineNum">    3677 </span>            : 
<span class="lineNum">    3678 </span><span class="lineCov">          1 :             if (psStyle-&gt;offsetx != 0 || psStyle-&gt;offsety != 0)</span>
<span class="lineNum">    3679 </span>            :             {
<span class="lineNum">    3680 </span>            :               snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sDisplacement&gt;\n&quot;, sNameSpace);
<span class="lineNum">    3681 </span><span class="lineCov">          1 :               msStringBufferAppend(sldString, szTmp);</span>
<span class="lineNum">    3682 </span><span class="lineCov">          1 :               snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sDisplacementX&gt;%g&lt;/%sDisplacementX&gt;\n&quot;,</span>
<span class="lineNum">    3683 </span>            :                   sNameSpace, psStyle-&gt;offsetx, sNameSpace);
<span class="lineNum">    3684 </span><span class="lineCov">          1 :               msStringBufferAppend(sldString, szTmp);</span>
<span class="lineNum">    3685 </span><span class="lineCov">          1 :               snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sDisplacementY&gt;%g&lt;/%sDisplacementY&gt;\n&quot;,</span>
<span class="lineNum">    3686 </span>            :                   sNameSpace, psStyle-&gt;offsety, sNameSpace);
<span class="lineNum">    3687 </span><span class="lineCov">          1 :               msStringBufferAppend(sldString, szTmp);</span>
<span class="lineNum">    3688 </span>            :               snprintf(szTmp, sizeof(szTmp), &quot;&lt;/%sDisplacement&gt;\n&quot;, sNameSpace);
<span class="lineNum">    3689 </span><span class="lineCov">          1 :               msStringBufferAppend(sldString, szTmp);</span>
<span class="lineNum">    3690 </span>            :             }
<span class="lineNum">    3691 </span>            : 
<span class="lineNum">    3692 </span>            :             snprintf(szTmp, sizeof(szTmp), &quot;&lt;/%sGraphic&gt;\n&quot;, sNameSpace);
<span class="lineNum">    3693 </span><span class="lineCov">          1 :             msStringBufferAppend(sldString, szTmp);</span>
<span class="lineNum">    3694 </span>            : 
<span class="lineNum">    3695 </span>            :             if (pszSymbolName)
<span class="lineNum">    3696 </span><span class="lineCov">          1 :               free(pszSymbolName);</span>
<span class="lineNum">    3697 </span>            :           }
<span class="lineNum">    3698 </span>            :         } else
<span class="lineNum">    3699 </span>            :           bGenerateDefaultSymbol =1;
<span class="lineNum">    3700 </span><span class="lineNoCov">          0 :       } else if (psSymbol-&gt;type == MS_SYMBOL_PIXMAP || psSymbol-&gt;type == MS_SYMBOL_SVG) {</span>
<span class="lineNum">    3701 </span><span class="lineNoCov">          0 :         if (psSymbol-&gt;name) {</span>
<span class="lineNum">    3702 </span><span class="lineNoCov">          0 :           const char *pszURL = msLookupHashTable(&amp;(psLayer-&gt;metadata), &quot;WMS_SLD_SYMBOL_URL&quot;);</span>
<span class="lineNum">    3703 </span><span class="lineNoCov">          0 :           if (!pszURL)</span>
<span class="lineNum">    3704 </span><span class="lineNoCov">          0 :             pszURL = msLookupHashTable(&amp;(psLayer-&gt;map-&gt;web.metadata), &quot;WMS_SLD_SYMBOL_URL&quot;);</span>
<span class="lineNum">    3705 </span>            : 
<span class="lineNum">    3706 </span><span class="lineNoCov">          0 :           if (pszURL) {</span>
<span class="lineNum">    3707 </span>            :             snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sGraphic&gt;\n&quot;, sNameSpace);
<span class="lineNum">    3708 </span><span class="lineNoCov">          0 :             msStringBufferAppend(sldString, szTmp);</span>
<span class="lineNum">    3709 </span>            : 
<span class="lineNum">    3710 </span>            : 
<span class="lineNum">    3711 </span>            : 
<span class="lineNum">    3712 </span>            :             snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sExternalGraphic&gt;\n&quot;, sNameSpace);
<span class="lineNum">    3713 </span><span class="lineNoCov">          0 :             msStringBufferAppend(sldString, szTmp);</span>
<span class="lineNum">    3714 </span>            : 
<span class="lineNum">    3715 </span><span class="lineNoCov">          0 :             snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sOnlineResource xmlns:xlink=\&quot;http://www.w3.org/1999/xlink\&quot; xlink:type=\&quot;simple\&quot; xlink:href=\&quot;%s%s\&quot;/&gt;\n&quot;, sNameSpace,</span>
<span class="lineNum">    3716 </span>            :                      pszURL,psSymbol-&gt;imagepath);
<span class="lineNum">    3717 </span><span class="lineNoCov">          0 :             msStringBufferAppend(sldString, szTmp);</span>
<span class="lineNum">    3718 </span>            :             /* TODO : extract format from symbol */
<span class="lineNum">    3719 </span>            : 
<span class="lineNum">    3720 </span><span class="lineNoCov">          0 :             szFormat[0] = '\0';</span>
<span class="lineNum">    3721 </span><span class="lineNoCov">          0 :             nLength = strlen(psSymbol-&gt;imagepath);</span>
<span class="lineNum">    3722 </span><span class="lineNoCov">          0 :             if (nLength &gt; 3) {</span>
<span class="lineNum">    3723 </span><span class="lineNoCov">          0 :               for (i=0; i&lt;=2; i++)</span>
<span class="lineNum">    3724 </span><span class="lineNoCov">          0 :                 szFormat[2-i] = psSymbol-&gt;imagepath[nLength-1-i];</span>
<span class="lineNum">    3725 </span><span class="lineNoCov">          0 :               szFormat[3] = '\0';</span>
<span class="lineNum">    3726 </span>            :             }
<span class="lineNum">    3727 </span><span class="lineNoCov">          0 :             if (strlen(szFormat) &gt; 0 &amp;&amp;</span>
<span class="lineNum">    3728 </span><span class="lineNoCov">          0 :                 ((strcasecmp (szFormat, &quot;GIF&quot;) == 0) ||</span>
<span class="lineNum">    3729 </span><span class="lineNoCov">          0 :                  (strcasecmp (szFormat, &quot;PNG&quot;) == 0))) {</span>
<span class="lineNum">    3730 </span><span class="lineNoCov">          0 :               if (strcasecmp (szFormat, &quot;GIF&quot;) == 0)</span>
<span class="lineNum">    3731 </span>            :                 snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sFormat&gt;image/gif&lt;/%sFormat&gt;\n&quot;,
<span class="lineNum">    3732 </span>            :                          sNameSpace, sNameSpace);
<span class="lineNum">    3733 </span>            :               else
<span class="lineNum">    3734 </span>            :                 snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sFormat&gt;image/png&lt;/%sFormat&gt;\n&quot;,
<span class="lineNum">    3735 </span>            :                          sNameSpace, sNameSpace);
<span class="lineNum">    3736 </span>            :             } else
<span class="lineNum">    3737 </span><span class="lineNoCov">          0 :               snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sFormat&gt;%s&lt;/%sFormat&gt;\n&quot;, sNameSpace,</span>
<span class="lineNum">    3738 </span><span class="lineNoCov">          0 :                             (psSymbol-&gt;type ==MS_SYMBOL_SVG)?&quot;image/svg+xml&quot;:&quot;image/gif&quot;,sNameSpace);</span>
<span class="lineNum">    3739 </span>            : 
<span class="lineNum">    3740 </span><span class="lineNoCov">          0 :             msStringBufferAppend(sldString, szTmp);</span>
<span class="lineNum">    3741 </span>            : 
<span class="lineNum">    3742 </span>            :             snprintf(szTmp, sizeof(szTmp), &quot;&lt;/%sExternalGraphic&gt;\n&quot;,  sNameSpace);
<span class="lineNum">    3743 </span><span class="lineNoCov">          0 :             msStringBufferAppend(sldString, szTmp);</span>
<span class="lineNum">    3744 </span>            : 
<span class="lineNum">    3745 </span><span class="lineNoCov">          0 :             if (psStyle-&gt;size &gt; 0)</span>
<span class="lineNum">    3746 </span>            :               snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sSize&gt;%g&lt;/%sSize&gt;\n&quot;, sNameSpace, psStyle-&gt;size,
<span class="lineNum">    3747 </span>            :                        sNameSpace);
<span class="lineNum">    3748 </span><span class="lineNoCov">          0 :             msStringBufferAppend(sldString, szTmp);</span>
<span class="lineNum">    3749 </span>            : 
<span class="lineNum">    3750 </span>            :             snprintf(szTmp, sizeof(szTmp), &quot;&lt;/%sGraphic&gt;\n&quot;, sNameSpace);
<span class="lineNum">    3751 </span><span class="lineNoCov">          0 :             msStringBufferAppend(sldString, szTmp);</span>
<span class="lineNum">    3752 </span>            : 
<span class="lineNum">    3753 </span>            :           }
<span class="lineNum">    3754 </span>            :         }
<span class="lineNum">    3755 </span>            : 
<span class="lineNum">    3756 </span>            :       }
<span class="lineNum">    3757 </span>            :     }
<span class="lineNum">    3758 </span><span class="lineCov">          1 :     if (bGenerateDefaultSymbol) { /* generate a default square symbol */</span>
<span class="lineNum">    3759 </span>            :       snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sGraphic&gt;\n&quot;, sNameSpace);
<span class="lineNum">    3760 </span><span class="lineCov">          1 :       msStringBufferAppend(sldString, szTmp);</span>
<span class="lineNum">    3761 </span>            : 
<span class="lineNum">    3762 </span>            : 
<span class="lineNum">    3763 </span>            : 
<span class="lineNum">    3764 </span>            :       snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sMark&gt;\n&quot;, sNameSpace);
<span class="lineNum">    3765 </span><span class="lineCov">          1 :       msStringBufferAppend(sldString, szTmp);</span>
<span class="lineNum">    3766 </span>            : 
<span class="lineNum">    3767 </span>            :       snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sWellKnownName&gt;%s&lt;/%sWellKnownName&gt;\n&quot;,
<span class="lineNum">    3768 </span>            :                sNameSpace, &quot;square&quot;, sNameSpace);
<span class="lineNum">    3769 </span><span class="lineCov">          1 :       msStringBufferAppend(sldString, szTmp);</span>
<span class="lineNum">    3770 </span>            : 
<span class="lineNum">    3771 </span>            :       bColorAvailable = 0;
<span class="lineNum">    3772 </span><span class="lineCov">          1 :       if (psStyle-&gt;color.red != -1 &amp;&amp;</span>
<span class="lineNum">    3773 </span><span class="lineCov">          1 :           psStyle-&gt;color.green != -1 &amp;&amp;</span>
<span class="lineNum">    3774 </span><span class="lineCov">          1 :           psStyle-&gt;color.blue != -1) {</span>
<span class="lineNum">    3775 </span>            :         snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sFill&gt;\n&quot;, sNameSpace);
<span class="lineNum">    3776 </span><span class="lineCov">          1 :         msStringBufferAppend(sldString, szTmp);</span>
<span class="lineNum">    3777 </span><span class="lineCov">          1 :         snprintf(szTmp, sizeof(szTmp), &quot;&lt;%s name=\&quot;fill\&quot;&gt;#%02x%02x%02x&lt;/%s&gt;\n&quot;,</span>
<span class="lineNum">    3778 </span>            :                  sCssParam,
<span class="lineNum">    3779 </span>            :                  psStyle-&gt;color.red,
<span class="lineNum">    3780 </span>            :                  psStyle-&gt;color.green,
<span class="lineNum">    3781 </span>            :                  psStyle-&gt;color.blue,
<span class="lineNum">    3782 </span>            :                  sCssParam);
<span class="lineNum">    3783 </span><span class="lineCov">          1 :         msStringBufferAppend(sldString, szTmp);</span>
<span class="lineNum">    3784 </span>            :         snprintf(szTmp, sizeof(szTmp), &quot;&lt;/%sFill&gt;\n&quot;, sNameSpace);
<span class="lineNum">    3785 </span><span class="lineCov">          1 :         msStringBufferAppend(sldString, szTmp);</span>
<span class="lineNum">    3786 </span>            :         bColorAvailable = 1;
<span class="lineNum">    3787 </span>            :       }
<span class="lineNum">    3788 </span><span class="lineCov">          1 :       if (psStyle-&gt;outlinecolor.red != -1 &amp;&amp;</span>
<span class="lineNum">    3789 </span><span class="lineNoCov">          0 :           psStyle-&gt;outlinecolor.green != -1 &amp;&amp;</span>
<span class="lineNum">    3790 </span><span class="lineNoCov">          0 :           psStyle-&gt;outlinecolor.blue != -1) {</span>
<span class="lineNum">    3791 </span>            :         snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sStroke&gt;\n&quot;, sNameSpace);
<span class="lineNum">    3792 </span><span class="lineNoCov">          0 :         msStringBufferAppend(sldString, szTmp);</span>
<span class="lineNum">    3793 </span><span class="lineNoCov">          0 :         snprintf(szTmp, sizeof(szTmp), &quot;&lt;%s name=\&quot;Stroke\&quot;&gt;#%02x%02x%02x&lt;/%s&gt;\n&quot;,</span>
<span class="lineNum">    3794 </span>            :                  sCssParam,
<span class="lineNum">    3795 </span>            :                  psStyle-&gt;outlinecolor.red,
<span class="lineNum">    3796 </span>            :                  psStyle-&gt;outlinecolor.green,
<span class="lineNum">    3797 </span>            :                  psStyle-&gt;outlinecolor.blue,
<span class="lineNum">    3798 </span>            :                  sCssParam);
<span class="lineNum">    3799 </span><span class="lineNoCov">          0 :         msStringBufferAppend(sldString, szTmp);</span>
<span class="lineNum">    3800 </span>            :         snprintf(szTmp, sizeof(szTmp), &quot;&lt;/%sStroke&gt;\n&quot;, sNameSpace);
<span class="lineNum">    3801 </span><span class="lineNoCov">          0 :         msStringBufferAppend(sldString, szTmp);</span>
<span class="lineNum">    3802 </span>            :         bColorAvailable = 1;
<span class="lineNum">    3803 </span>            :       }
<span class="lineNum">    3804 </span><span class="lineCov">          1 :       if (!bColorAvailable) {</span>
<span class="lineNum">    3805 </span>            :         /* default color */
<span class="lineNum">    3806 </span>            :         snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sFill&gt;\n&quot;, sNameSpace);
<span class="lineNum">    3807 </span><span class="lineCov">          1 :         msStringBufferAppend(sldString, szTmp);</span>
<span class="lineNum">    3808 </span>            :         snprintf(szTmp, sizeof(szTmp),
<span class="lineNum">    3809 </span>            :                  &quot;&lt;%s name=\&quot;fill\&quot;&gt;%s&lt;/%s&gt;\n&quot;,
<span class="lineNum">    3810 </span>            :                  sCssParam, &quot;#808080&quot;, sCssParam);
<span class="lineNum">    3811 </span><span class="lineCov">          1 :         msStringBufferAppend(sldString, szTmp);</span>
<span class="lineNum">    3812 </span>            :         snprintf(szTmp, sizeof(szTmp), &quot;&lt;/%sFill&gt;\n&quot;, sNameSpace);
<span class="lineNum">    3813 </span><span class="lineCov">          1 :         msStringBufferAppend(sldString, szTmp);</span>
<span class="lineNum">    3814 </span>            :       }
<span class="lineNum">    3815 </span>            : 
<span class="lineNum">    3816 </span>            :       snprintf(szTmp, sizeof(szTmp), &quot;&lt;/%sMark&gt;\n&quot;, sNameSpace);
<span class="lineNum">    3817 </span><span class="lineCov">          1 :       msStringBufferAppend(sldString, szTmp);</span>
<span class="lineNum">    3818 </span>            : 
<span class="lineNum">    3819 </span><span class="lineCov">          1 :       if (psStyle-&gt;size &gt; 0)</span>
<span class="lineNum">    3820 </span>            :         snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sSize&gt;%g&lt;/%sSize&gt;\n&quot;, sNameSpace,
<span class="lineNum">    3821 </span>            :                  psStyle-&gt;size, sNameSpace);
<span class="lineNum">    3822 </span>            :       else
<span class="lineNum">    3823 </span>            :         snprintf(szTmp,  sizeof(szTmp), &quot;&lt;%sSize&gt;%d&lt;/%sSize&gt;\n&quot;, sNameSpace,1,sNameSpace);
<span class="lineNum">    3824 </span><span class="lineCov">          1 :       msStringBufferAppend(sldString, szTmp);</span>
<span class="lineNum">    3825 </span>            : 
<span class="lineNum">    3826 </span>            :       snprintf(szTmp, sizeof(szTmp), &quot;&lt;/%sGraphic&gt;\n&quot;, sNameSpace);
<span class="lineNum">    3827 </span><span class="lineCov">          1 :       msStringBufferAppend(sldString, szTmp);</span>
<span class="lineNum">    3828 </span>            : 
<span class="lineNum">    3829 </span>            : 
<span class="lineNum">    3830 </span>            :     }
<span class="lineNum">    3831 </span>            :   }
<span class="lineNum">    3832 </span>            : 
<span class="lineNum">    3833 </span><span class="lineCov">          1 :   return msStringBufferReleaseStringAndFree(sldString);</span>
<span class="lineNum">    3834 </span>            : 
<span class="lineNum">    3835 </span>            : #else
<span class="lineNum">    3836 </span>            :   return NULL;
<span class="lineNum">    3837 </span>            : 
<span class="lineNum">    3838 </span>            : #endif
<span class="lineNum">    3839 </span>            : 
<span class="lineNum">    3840 </span>            : }
<span class="lineNum">    3841 </span>            : 
<span class="lineNum">    3842 </span>            : 
<span class="lineNum">    3843 </span>            : 
<span class="lineNum">    3844 </span>            : 
<span class="lineNum">    3845 </span>            : /************************************************************************/
<span class="lineNum">    3846 </span>            : /*                           msSLDGenerateLineSLD                       */
<span class="lineNum">    3847 </span>            : /*                                                                      */
<a name="3848"><span class="lineNum">    3848 </span>            : /*      Generate SLD for a Line layer.                                  */</a>
<span class="lineNum">    3849 </span>            : /************************************************************************/
<span class="lineNum">    3850 </span><span class="lineCov">          1 : char *msSLDGenerateLineSLD(styleObj *psStyle, layerObj *psLayer, int nVersion)</span>
<span class="lineNum">    3851 </span>            : {
<span class="lineNum">    3852 </span>            : #if defined(USE_WMS_SVR) || defined (USE_WFS_SVR) || defined (USE_WCS_SVR) || defined(USE_SOS_SVR)
<span class="lineNum">    3853 </span>            : 
<span class="lineNum">    3854 </span>            :   char *pszSLD = NULL;
<span class="lineNum">    3855 </span>            :   char szTmp[100];
<span class="lineNum">    3856 </span>            :   char szHexColor[7];
<span class="lineNum">    3857 </span>            :   int nSymbol = -1;
<span class="lineNum">    3858 </span>            :   int i = 0;
<span class="lineNum">    3859 </span>            :   double dfSize = 1.0;
<span class="lineNum">    3860 </span>            :   char *pszDashArray = NULL;
<span class="lineNum">    3861 </span>            :   char *pszGraphicSLD = NULL;
<span class="lineNum">    3862 </span>            :   char sCssParam[30];
<span class="lineNum">    3863 </span>            :   char sNameSpace[10];
<span class="lineNum">    3864 </span>            : 
<span class="lineNum">    3865 </span><span class="lineCov">          1 :   if ( msCheckParentPointer(psLayer-&gt;map,&quot;map&quot;)==MS_FAILURE )</span>
<span class="lineNum">    3866 </span>            :     return NULL;
<span class="lineNum">    3867 </span>            : 
<span class="lineNum">    3868 </span><span class="lineCov">          1 :   sCssParam[0] = '\0';</span>
<span class="lineNum">    3869 </span><span class="lineCov">          1 :   if (nVersion &gt; OWS_1_0_0)</span>
<span class="lineNum">    3870 </span>            :     strcpy( sCssParam, &quot;se:SvgParameter&quot;);
<span class="lineNum">    3871 </span>            :   else
<span class="lineNum">    3872 </span>            :     strcpy( sCssParam, &quot;CssParameter&quot;);
<span class="lineNum">    3873 </span>            : 
<span class="lineNum">    3874 </span><span class="lineCov">          1 :   sNameSpace[0] = '\0';</span>
<span class="lineNum">    3875 </span><span class="lineCov">          1 :   if (nVersion &gt; OWS_1_0_0)</span>
<span class="lineNum">    3876 </span>            :     strcpy(sNameSpace, &quot;se:&quot;);
<span class="lineNum">    3877 </span>            : 
<span class="lineNum">    3878 </span>            :   snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sLineSymbolizer&gt;\n&quot;,  sNameSpace);
<span class="lineNum">    3879 </span>            : 
<span class="lineNum">    3880 </span><span class="lineCov">          1 :   pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    3881 </span>            : 
<span class="lineNum">    3882 </span>            :   snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sStroke&gt;\n&quot;,  sNameSpace);
<span class="lineNum">    3883 </span>            : 
<span class="lineNum">    3884 </span><span class="lineCov">          1 :   pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    3885 </span>            : 
<span class="lineNum">    3886 </span><span class="lineCov">          1 :   pszGraphicSLD = msSLDGetGraphicSLD(psStyle, psLayer, 0, nVersion);</span>
<span class="lineNum">    3887 </span><span class="lineCov">          1 :   if (pszGraphicSLD) {</span>
<span class="lineNum">    3888 </span>            :     snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sGraphicStroke&gt;\n&quot;,  sNameSpace);
<span class="lineNum">    3889 </span>            : 
<span class="lineNum">    3890 </span><span class="lineCov">          1 :     pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    3891 </span>            : 
<span class="lineNum">    3892 </span><span class="lineCov">          1 :     pszSLD = msStringConcatenate(pszSLD, pszGraphicSLD);</span>
<span class="lineNum">    3893 </span>            : 
<span class="lineNum">    3894 </span><span class="lineCov">          1 :     if(nVersion &gt;= OWS_1_1_0) {</span>
<span class="lineNum">    3895 </span><span class="lineCov">          1 :       if(psStyle-&gt;gap &gt; 0) {</span>
<span class="lineNum">    3896 </span>            :         snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sGap&gt;%.2f&lt;/%sGap&gt;\n&quot;,  sNameSpace,psStyle-&gt;gap,sNameSpace);
<span class="lineNum">    3897 </span>            :       }
<span class="lineNum">    3898 </span><span class="lineCov">          1 :       if(psStyle-&gt;initialgap &gt; 0) {</span>
<span class="lineNum">    3899 </span>            :         snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sInitialGap&gt;%.2f&lt;/%sInitialGap&gt;\n&quot;,  sNameSpace,psStyle-&gt;initialgap,sNameSpace);
<span class="lineNum">    3900 </span>            :       }
<span class="lineNum">    3901 </span>            :     }
<span class="lineNum">    3902 </span>            : 
<span class="lineNum">    3903 </span>            :     snprintf(szTmp, sizeof(szTmp), &quot;&lt;/%sGraphicStroke&gt;\n&quot;,  sNameSpace);
<span class="lineNum">    3904 </span>            : 
<span class="lineNum">    3905 </span><span class="lineCov">          1 :     pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    3906 </span>            : 
<span class="lineNum">    3907 </span><span class="lineCov">          1 :     free(pszGraphicSLD);</span>
<span class="lineNum">    3908 </span>            :     pszGraphicSLD = NULL;
<span class="lineNum">    3909 </span>            :   }
<span class="lineNum">    3910 </span>            : 
<span class="lineNum">    3911 </span><span class="lineCov">          1 :   if (psStyle-&gt;color.red != -1 &amp;&amp;</span>
<span class="lineNum">    3912 </span><span class="lineCov">          1 :       psStyle-&gt;color.green != -1 &amp;&amp;</span>
<span class="lineNum">    3913 </span><span class="lineCov">          1 :       psStyle-&gt;color.blue != -1)</span>
<span class="lineNum">    3914 </span>            :     sprintf(szHexColor,&quot;%02x%02x%02x&quot;,psStyle-&gt;color.red,
<span class="lineNum">    3915 </span>            :             psStyle-&gt;color.green,psStyle-&gt;color.blue);
<span class="lineNum">    3916 </span>            :   else
<span class="lineNum">    3917 </span><span class="lineNoCov">          0 :     sprintf(szHexColor,&quot;%02x%02x%02x&quot;,psStyle-&gt;outlinecolor.red,</span>
<span class="lineNum">    3918 </span>            :             psStyle-&gt;outlinecolor.green,psStyle-&gt;outlinecolor.blue);
<span class="lineNum">    3919 </span>            : 
<span class="lineNum">    3920 </span>            :   snprintf(szTmp,  sizeof(szTmp),
<span class="lineNum">    3921 </span>            :            &quot;&lt;%s name=\&quot;stroke\&quot;&gt;#%s&lt;/%s&gt;\n&quot;,
<span class="lineNum">    3922 </span>            :            sCssParam, szHexColor, sCssParam);
<span class="lineNum">    3923 </span><span class="lineCov">          1 :   pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    3924 </span>            : 
<span class="lineNum">    3925 </span><span class="lineCov">          1 :   if(psStyle-&gt;color.alpha != 255 &amp;&amp; psStyle-&gt;color.alpha!=-1) {</span>
<span class="lineNum">    3926 </span><span class="lineCov">          1 :     snprintf(szTmp, sizeof(szTmp),</span>
<span class="lineNum">    3927 </span>            :              &quot;&lt;%s name=\&quot;stroke-opacity\&quot;&gt;%.2f&lt;/%s&gt;\n&quot;,
<span class="lineNum">    3928 </span><span class="lineCov">          1 :              sCssParam, (float)psStyle-&gt;color.alpha/255.0, sCssParam);</span>
<span class="lineNum">    3929 </span><span class="lineCov">          1 :     pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    3930 </span>            :   }
<span class="lineNum">    3931 </span>            : 
<span class="lineNum">    3932 </span>            : 
<span class="lineNum">    3933 </span>            :   nSymbol = -1;
<span class="lineNum">    3934 </span>            : 
<span class="lineNum">    3935 </span><span class="lineCov">          1 :   if (psStyle-&gt;symbol &gt;= 0)</span>
<span class="lineNum">    3936 </span>            :     nSymbol = psStyle-&gt;symbol;
<span class="lineNum">    3937 </span><span class="lineNoCov">          0 :   else if (psStyle-&gt;symbolname)</span>
<span class="lineNum">    3938 </span><span class="lineNoCov">          0 :     nSymbol = msGetSymbolIndex(&amp;psLayer-&gt;map-&gt;symbolset,</span>
<span class="lineNum">    3939 </span>            :                                psStyle-&gt;symbolname, MS_FALSE);
<span class="lineNum">    3940 </span>            : 
<span class="lineNum">    3941 </span><span class="lineCov">          1 :   if (nSymbol &lt;0)</span>
<span class="lineNum">    3942 </span>            :     dfSize = 1.0;
<span class="lineNum">    3943 </span>            :   else {
<span class="lineNum">    3944 </span><span class="lineCov">          1 :     if (psStyle-&gt;size &gt; 0)</span>
<span class="lineNum">    3945 </span>            :       dfSize = psStyle-&gt;size;
<span class="lineNum">    3946 </span><span class="lineCov">          1 :     else if (psStyle-&gt;width &gt; 0)</span>
<span class="lineNum">    3947 </span>            :       dfSize = psStyle-&gt;width;
<span class="lineNum">    3948 </span>            :     else
<span class="lineNum">    3949 </span>            :       dfSize = 1;
<span class="lineNum">    3950 </span>            :   }
<span class="lineNum">    3951 </span>            : 
<span class="lineNum">    3952 </span>            :   snprintf(szTmp, sizeof(szTmp),
<span class="lineNum">    3953 </span>            :            &quot;&lt;%s name=\&quot;stroke-width\&quot;&gt;%.2f&lt;/%s&gt;\n&quot;,
<span class="lineNum">    3954 </span>            :            sCssParam, dfSize, sCssParam);
<span class="lineNum">    3955 </span><span class="lineCov">          1 :   pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    3956 </span>            : 
<span class="lineNum">    3957 </span>            :   /* -------------------------------------------------------------------- */
<span class="lineNum">    3958 </span>            :   /*      dash array                                                      */
<span class="lineNum">    3959 </span>            :   /* -------------------------------------------------------------------- */
<span class="lineNum">    3960 </span>            : 
<span class="lineNum">    3961 </span>            : 
<span class="lineNum">    3962 </span><span class="lineCov">          1 :   if (psStyle-&gt;patternlength &gt; 0) {</span>
<span class="lineNum">    3963 </span><span class="lineNoCov">          0 :     for (i=0; i&lt;psStyle-&gt;patternlength; i++) {</span>
<span class="lineNum">    3964 </span><span class="lineNoCov">          0 :       snprintf(szTmp, sizeof(szTmp), &quot;%.2f &quot;, psStyle-&gt;pattern[i]);</span>
<span class="lineNum">    3965 </span><span class="lineNoCov">          0 :       pszDashArray = msStringConcatenate(pszDashArray, szTmp);</span>
<span class="lineNum">    3966 </span>            :     }
<span class="lineNum">    3967 </span>            :     snprintf(szTmp, sizeof(szTmp),
<span class="lineNum">    3968 </span>            :              &quot;&lt;%s name=\&quot;stroke-dasharray\&quot;&gt;%s&lt;/%s&gt;\n&quot;,
<span class="lineNum">    3969 </span>            :              sCssParam, pszDashArray, sCssParam);
<span class="lineNum">    3970 </span><span class="lineNoCov">          0 :     pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    3971 </span><span class="lineNoCov">          0 :     msFree(pszDashArray);</span>
<span class="lineNum">    3972 </span>            :   }
<span class="lineNum">    3973 </span>            : 
<span class="lineNum">    3974 </span>            :   snprintf(szTmp, sizeof(szTmp), &quot;&lt;/%sStroke&gt;\n&quot;,  sNameSpace);
<span class="lineNum">    3975 </span>            : 
<span class="lineNum">    3976 </span><span class="lineCov">          1 :   pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    3977 </span>            : 
<span class="lineNum">    3978 </span>            :   snprintf(szTmp, sizeof(szTmp), &quot;&lt;/%sLineSymbolizer&gt;\n&quot;,  sNameSpace);
<span class="lineNum">    3979 </span>            : 
<span class="lineNum">    3980 </span><span class="lineCov">          1 :   pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    3981 </span>            : 
<span class="lineNum">    3982 </span><span class="lineCov">          1 :   return pszSLD;</span>
<span class="lineNum">    3983 </span>            : 
<span class="lineNum">    3984 </span>            : #else
<span class="lineNum">    3985 </span>            :   return NULL;
<span class="lineNum">    3986 </span>            : #endif
<span class="lineNum">    3987 </span>            : }
<span class="lineNum">    3988 </span>            : 
<span class="lineNum">    3989 </span>            : 
<span class="lineNum">    3990 </span>            : /************************************************************************/
<span class="lineNum">    3991 </span>            : /*                         msSLDGeneratePolygonSLD                      */
<span class="lineNum">    3992 </span>            : /*                                                                      */
<a name="3993"><span class="lineNum">    3993 </span>            : /*       Generate SLD for a Polygon layer.                              */</a>
<span class="lineNum">    3994 </span>            : /************************************************************************/
<span class="lineNum">    3995 </span><span class="lineCov">          1 : char *msSLDGeneratePolygonSLD(styleObj *psStyle, layerObj *psLayer, int nVersion)</span>
<span class="lineNum">    3996 </span>            : {
<span class="lineNum">    3997 </span>            : #if defined(USE_WMS_SVR) || defined (USE_WFS_SVR) || defined (USE_WCS_SVR) || defined(USE_SOS_SVR)
<span class="lineNum">    3998 </span>            : 
<span class="lineNum">    3999 </span>            :   char szTmp[100];
<span class="lineNum">    4000 </span>            :   char *pszSLD = NULL;
<span class="lineNum">    4001 </span>            :   char szHexColor[7];
<span class="lineNum">    4002 </span>            :   char *pszGraphicSLD = NULL;
<span class="lineNum">    4003 </span>            :   double dfSize;
<span class="lineNum">    4004 </span>            :   char sCssParam[30];
<span class="lineNum">    4005 </span>            :   char sNameSpace[10];
<span class="lineNum">    4006 </span>            : 
<span class="lineNum">    4007 </span><span class="lineCov">          1 :   sCssParam[0] = '\0';</span>
<span class="lineNum">    4008 </span><span class="lineCov">          1 :   if (nVersion &gt; OWS_1_0_0)</span>
<span class="lineNum">    4009 </span>            :     strcpy(sCssParam, &quot;se:SvgParameter&quot;);
<span class="lineNum">    4010 </span>            :   else
<span class="lineNum">    4011 </span>            :     strcpy(sCssParam, &quot;CssParameter&quot;);
<span class="lineNum">    4012 </span>            : 
<span class="lineNum">    4013 </span><span class="lineCov">          1 :   sNameSpace[0] = '\0';</span>
<span class="lineNum">    4014 </span><span class="lineCov">          1 :   if (nVersion &gt; OWS_1_0_0)</span>
<span class="lineNum">    4015 </span>            :     strcpy(sNameSpace, &quot;se:&quot;);
<span class="lineNum">    4016 </span>            : 
<span class="lineNum">    4017 </span>            :   snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sPolygonSymbolizer&gt;\n&quot;,  sNameSpace);
<span class="lineNum">    4018 </span>            : 
<span class="lineNum">    4019 </span><span class="lineCov">          1 :   pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4020 </span>            :   /* fill */
<span class="lineNum">    4021 </span><span class="lineCov">          1 :   if (psStyle-&gt;color.red != -1 &amp;&amp; psStyle-&gt;color.green != -1 &amp;&amp;</span>
<span class="lineNum">    4022 </span><span class="lineCov">          1 :       psStyle-&gt;color.blue != -1) {</span>
<span class="lineNum">    4023 </span>            : 
<span class="lineNum">    4024 </span>            :     snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sFill&gt;\n&quot;,  sNameSpace);
<span class="lineNum">    4025 </span>            : 
<span class="lineNum">    4026 </span><span class="lineCov">          1 :     pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4027 </span>            : 
<span class="lineNum">    4028 </span><span class="lineCov">          1 :     pszGraphicSLD = msSLDGetGraphicSLD(psStyle, psLayer, 0, nVersion);</span>
<span class="lineNum">    4029 </span><span class="lineCov">          1 :     if (pszGraphicSLD) {</span>
<span class="lineNum">    4030 </span>            :       snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sGraphicFill&gt;\n&quot;,  sNameSpace);
<span class="lineNum">    4031 </span>            : 
<span class="lineNum">    4032 </span><span class="lineCov">          1 :       pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4033 </span>            : 
<span class="lineNum">    4034 </span><span class="lineCov">          1 :       pszSLD = msStringConcatenate(pszSLD, pszGraphicSLD);</span>
<span class="lineNum">    4035 </span>            : 
<span class="lineNum">    4036 </span>            :       snprintf(szTmp, sizeof(szTmp), &quot;&lt;/%sGraphicFill&gt;\n&quot;,  sNameSpace);
<span class="lineNum">    4037 </span>            : 
<span class="lineNum">    4038 </span><span class="lineCov">          1 :       pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4039 </span>            : 
<span class="lineNum">    4040 </span><span class="lineCov">          1 :       free(pszGraphicSLD);</span>
<span class="lineNum">    4041 </span>            :       pszGraphicSLD = NULL;
<span class="lineNum">    4042 </span>            :     }
<span class="lineNum">    4043 </span>            : 
<span class="lineNum">    4044 </span><span class="lineCov">          1 :     sprintf(szHexColor,&quot;%02x%02x%02x&quot;,psStyle-&gt;color.red,</span>
<span class="lineNum">    4045 </span>            :             psStyle-&gt;color.green,psStyle-&gt;color.blue);
<span class="lineNum">    4046 </span>            : 
<span class="lineNum">    4047 </span>            :     snprintf(szTmp, sizeof(szTmp),
<span class="lineNum">    4048 </span>            :              &quot;&lt;%s name=\&quot;fill\&quot;&gt;#%s&lt;/%s&gt;\n&quot;,
<span class="lineNum">    4049 </span>            :              sCssParam, szHexColor, sCssParam);
<span class="lineNum">    4050 </span><span class="lineCov">          1 :     pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4051 </span>            : 
<span class="lineNum">    4052 </span><span class="lineCov">          1 :     if(psStyle-&gt;color.alpha != 255 &amp;&amp; psStyle-&gt;color.alpha!=-1) {</span>
<span class="lineNum">    4053 </span><span class="lineCov">          1 :       snprintf(szTmp, sizeof(szTmp),</span>
<span class="lineNum">    4054 </span>            :                &quot;&lt;%s name=\&quot;fill-opacity\&quot;&gt;%.2f&lt;/%s&gt;\n&quot;,
<span class="lineNum">    4055 </span><span class="lineCov">          1 :                sCssParam, (float)psStyle-&gt;color.alpha/255, sCssParam);</span>
<span class="lineNum">    4056 </span><span class="lineCov">          1 :       pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4057 </span>            :     }
<span class="lineNum">    4058 </span>            : 
<span class="lineNum">    4059 </span>            : 
<span class="lineNum">    4060 </span>            :     snprintf(szTmp, sizeof(szTmp), &quot;&lt;/%sFill&gt;\n&quot;,  sNameSpace);
<span class="lineNum">    4061 </span>            : 
<span class="lineNum">    4062 </span><span class="lineCov">          1 :     pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4063 </span>            :   }
<span class="lineNum">    4064 </span>            :   /* stroke */
<span class="lineNum">    4065 </span><span class="lineCov">          1 :   if (psStyle-&gt;outlinecolor.red != -1 &amp;&amp;</span>
<span class="lineNum">    4066 </span><span class="lineCov">          1 :       psStyle-&gt;outlinecolor.green != -1 &amp;&amp;</span>
<span class="lineNum">    4067 </span><span class="lineCov">          1 :       psStyle-&gt;outlinecolor.blue != -1) {</span>
<span class="lineNum">    4068 </span>            :     snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sStroke&gt;\n&quot;,  sNameSpace);
<span class="lineNum">    4069 </span><span class="lineCov">          1 :     pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4070 </span>            : 
<span class="lineNum">    4071 </span>            : 
<span class="lineNum">    4072 </span>            : 
<span class="lineNum">    4073 </span>            :     /* If there is a symbol to be used for stroke, the color in the */
<span class="lineNum">    4074 </span>            :     /* style should be set to -1. Else It won't apply here. */
<span class="lineNum">    4075 </span><span class="lineCov">          1 :     if (psStyle-&gt;color.red == -1 &amp;&amp; psStyle-&gt;color.green == -1 &amp;&amp;</span>
<span class="lineNum">    4076 </span>            :         psStyle-&gt;color.blue == -1) {
<span class="lineNum">    4077 </span><span class="lineCov">          1 :       pszGraphicSLD = msSLDGetGraphicSLD(psStyle, psLayer, 0, nVersion);</span>
<span class="lineNum">    4078 </span><span class="lineCov">          1 :       if (pszGraphicSLD) {</span>
<span class="lineNum">    4079 </span>            :         snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sGraphicFill&gt;\n&quot;,  sNameSpace);
<span class="lineNum">    4080 </span><span class="lineNoCov">          0 :         pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4081 </span>            : 
<span class="lineNum">    4082 </span><span class="lineNoCov">          0 :         pszSLD = msStringConcatenate(pszSLD, pszGraphicSLD);</span>
<span class="lineNum">    4083 </span>            :         snprintf(szTmp, sizeof(szTmp), &quot;&lt;/%sGraphicFill&gt;\n&quot;,  sNameSpace);
<span class="lineNum">    4084 </span><span class="lineNoCov">          0 :         pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4085 </span>            : 
<span class="lineNum">    4086 </span><span class="lineNoCov">          0 :         free(pszGraphicSLD);</span>
<span class="lineNum">    4087 </span>            :         pszGraphicSLD = NULL;
<span class="lineNum">    4088 </span>            :       }
<span class="lineNum">    4089 </span>            :     }
<span class="lineNum">    4090 </span>            : 
<span class="lineNum">    4091 </span><span class="lineCov">          1 :     sprintf(szHexColor,&quot;%02x%02x%02x&quot;,psStyle-&gt;outlinecolor.red,</span>
<span class="lineNum">    4092 </span>            :             psStyle-&gt;outlinecolor.green,
<span class="lineNum">    4093 </span>            :             psStyle-&gt;outlinecolor.blue);
<span class="lineNum">    4094 </span>            : 
<span class="lineNum">    4095 </span>            :     snprintf(szTmp, sizeof(szTmp),
<span class="lineNum">    4096 </span>            :              &quot;&lt;%s name=\&quot;stroke\&quot;&gt;#%s&lt;/%s&gt;\n&quot;,
<span class="lineNum">    4097 </span>            :              sCssParam, szHexColor, sCssParam);
<span class="lineNum">    4098 </span><span class="lineCov">          1 :     pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4099 </span>            : 
<span class="lineNum">    4100 </span>            :     dfSize = 1.0;
<span class="lineNum">    4101 </span><span class="lineCov">          1 :     if (psStyle-&gt;size &gt; 0)</span>
<span class="lineNum">    4102 </span>            :       dfSize = psStyle-&gt;size;
<span class="lineNum">    4103 </span><span class="lineCov">          1 :     else if (psStyle-&gt;width &gt; 0)</span>
<span class="lineNum">    4104 </span>            :       dfSize = psStyle-&gt;width;
<span class="lineNum">    4105 </span>            : 
<span class="lineNum">    4106 </span>            :     snprintf(szTmp, sizeof(szTmp),
<span class="lineNum">    4107 </span>            :              &quot;&lt;%s name=\&quot;stroke-width\&quot;&gt;%.2f&lt;/%s&gt;\n&quot;,
<span class="lineNum">    4108 </span>            :              sCssParam,dfSize,sCssParam);
<span class="lineNum">    4109 </span><span class="lineCov">          1 :     pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4110 </span>            : 
<span class="lineNum">    4111 </span><span class="lineCov">          1 :     if(psStyle-&gt;outlinecolor.alpha != 255 &amp;&amp; psStyle-&gt;outlinecolor.alpha != -1)</span>
<span class="lineNum">    4112 </span>            :     {
<span class="lineNum">    4113 </span><span class="lineCov">          1 :       snprintf(szTmp, sizeof(szTmp),</span>
<span class="lineNum">    4114 </span>            :           &quot;&lt;%s name=\&quot;stroke-opacity\&quot;&gt;%.2f&lt;/%s&gt;\n&quot;,
<span class="lineNum">    4115 </span>            :           sCssParam, psStyle-&gt;outlinecolor.alpha/255.0, sCssParam);
<span class="lineNum">    4116 </span><span class="lineCov">          1 :       pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4117 </span>            :     }
<span class="lineNum">    4118 </span>            : 
<span class="lineNum">    4119 </span>            :     snprintf(szTmp, sizeof(szTmp), &quot;&lt;/%sStroke&gt;\n&quot;,  sNameSpace);
<span class="lineNum">    4120 </span><span class="lineCov">          1 :     pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4121 </span>            :   }
<span class="lineNum">    4122 </span>            : 
<span class="lineNum">    4123 </span>            :   snprintf(szTmp, sizeof(szTmp), &quot;&lt;/%sPolygonSymbolizer&gt;\n&quot;, sNameSpace);
<span class="lineNum">    4124 </span><span class="lineCov">          1 :   pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4125 </span>            : 
<span class="lineNum">    4126 </span><span class="lineCov">          1 :   return pszSLD;</span>
<span class="lineNum">    4127 </span>            : 
<span class="lineNum">    4128 </span>            : #else
<span class="lineNum">    4129 </span>            :   return NULL;
<span class="lineNum">    4130 </span>            : #endif
<span class="lineNum">    4131 </span>            : }
<span class="lineNum">    4132 </span>            : 
<span class="lineNum">    4133 </span>            : /************************************************************************/
<span class="lineNum">    4134 </span>            : /*                          msSLDGeneratePointSLD                       */
<span class="lineNum">    4135 </span>            : /*                                                                      */
<a name="4136"><span class="lineNum">    4136 </span>            : /*      Generate SLD for a Point layer.                                 */</a>
<span class="lineNum">    4137 </span>            : /************************************************************************/
<span class="lineNum">    4138 </span><span class="lineCov">          1 : char *msSLDGeneratePointSLD(styleObj *psStyle, layerObj *psLayer, int nVersion)</span>
<span class="lineNum">    4139 </span>            : {
<span class="lineNum">    4140 </span>            : #if defined(USE_WMS_SVR) || defined (USE_WFS_SVR) || defined (USE_WCS_SVR) || defined(USE_SOS_SVR)
<span class="lineNum">    4141 </span>            :   char *pszSLD = NULL;
<span class="lineNum">    4142 </span>            :   char *pszGraphicSLD = NULL;
<span class="lineNum">    4143 </span>            :   char szTmp[100];
<span class="lineNum">    4144 </span>            :   char sNameSpace[10];
<span class="lineNum">    4145 </span>            : 
<span class="lineNum">    4146 </span><span class="lineCov">          1 :   sNameSpace[0] = '\0';</span>
<span class="lineNum">    4147 </span><span class="lineCov">          1 :   if (nVersion &gt; OWS_1_0_0)</span>
<span class="lineNum">    4148 </span>            :     strcpy(sNameSpace, &quot;se:&quot;);
<span class="lineNum">    4149 </span>            : 
<span class="lineNum">    4150 </span>            :   snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sPointSymbolizer&gt;\n&quot;,  sNameSpace);
<span class="lineNum">    4151 </span><span class="lineCov">          1 :   pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4152 </span>            : 
<span class="lineNum">    4153 </span><span class="lineCov">          1 :   pszGraphicSLD = msSLDGetGraphicSLD(psStyle, psLayer, 1, nVersion);</span>
<span class="lineNum">    4154 </span><span class="lineCov">          1 :   if (pszGraphicSLD) {</span>
<span class="lineNum">    4155 </span><span class="lineCov">          1 :     pszSLD = msStringConcatenate(pszSLD, pszGraphicSLD);</span>
<span class="lineNum">    4156 </span><span class="lineCov">          1 :     free(pszGraphicSLD);</span>
<span class="lineNum">    4157 </span>            :   }
<span class="lineNum">    4158 </span>            : 
<span class="lineNum">    4159 </span>            :   snprintf(szTmp, sizeof(szTmp), &quot;&lt;/%sPointSymbolizer&gt;\n&quot;,  sNameSpace);
<span class="lineNum">    4160 </span><span class="lineCov">          1 :   pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4161 </span>            : 
<span class="lineNum">    4162 </span><span class="lineCov">          1 :   return pszSLD;</span>
<span class="lineNum">    4163 </span>            : 
<span class="lineNum">    4164 </span>            : #else
<span class="lineNum">    4165 </span>            :   return NULL;
<span class="lineNum">    4166 </span>            : 
<span class="lineNum">    4167 </span>            : #endif
<span class="lineNum">    4168 </span>            : }
<span class="lineNum">    4169 </span>            : 
<span class="lineNum">    4170 </span>            : 
<span class="lineNum">    4171 </span>            : 
<span class="lineNum">    4172 </span>            : /************************************************************************/
<span class="lineNum">    4173 </span>            : /*                           msSLDGenerateTextSLD                       */
<span class="lineNum">    4174 </span>            : /*                                                                      */
<span class="lineNum">    4175 </span>            : /*      Generate a TextSymboliser SLD xml based on the class's label    */
<a name="4176"><span class="lineNum">    4176 </span>            : /*      object.                                                         */</a>
<span class="lineNum">    4177 </span>            : /************************************************************************/
<span class="lineNum">    4178 </span><span class="lineCov">          1 : char *msSLDGenerateTextSLD(classObj *psClass, layerObj *psLayer, int nVersion)</span>
<span class="lineNum">    4179 </span>            : {
<span class="lineNum">    4180 </span>            : #if defined(USE_WMS_SVR) || defined (USE_WFS_SVR) || defined (USE_WCS_SVR) || defined(USE_SOS_SVR)
<span class="lineNum">    4181 </span>            :   char *pszSLD = NULL;
<span class="lineNum">    4182 </span>            : 
<span class="lineNum">    4183 </span>            :   char szTmp[1000];
<span class="lineNum">    4184 </span>            :   char **aszFontsParts = NULL;
<span class="lineNum">    4185 </span><span class="lineCov">          1 :   int nFontParts = 0;</span>
<span class="lineNum">    4186 </span>            :   char szHexColor[7];
<span class="lineNum">    4187 </span>            :   double dfAnchorX = 0.5, dfAnchorY = 0.5;
<span class="lineNum">    4188 </span>            :   int i = 0;
<span class="lineNum">    4189 </span>            :   int lid;
<span class="lineNum">    4190 </span>            :   char sCssParam[30];
<span class="lineNum">    4191 </span>            :   char sNameSpace[10];
<span class="lineNum">    4192 </span>            :   labelObj *psLabelObj = NULL;
<span class="lineNum">    4193 </span>            : 
<span class="lineNum">    4194 </span><span class="lineCov">          1 :   sCssParam[0] = '\0';</span>
<span class="lineNum">    4195 </span><span class="lineCov">          1 :   if (nVersion &gt; OWS_1_0_0)</span>
<span class="lineNum">    4196 </span>            :     strcpy(sCssParam, &quot;se:SvgParameter&quot;);
<span class="lineNum">    4197 </span>            :   else
<span class="lineNum">    4198 </span>            :     strcpy(sCssParam, &quot;CssParameter&quot;);
<span class="lineNum">    4199 </span>            : 
<span class="lineNum">    4200 </span><span class="lineCov">          1 :   sNameSpace[0] = '\0';</span>
<span class="lineNum">    4201 </span><span class="lineCov">          1 :   if (nVersion &gt; OWS_1_0_0)</span>
<span class="lineNum">    4202 </span>            :     strcpy(sNameSpace, &quot;se:&quot;);
<span class="lineNum">    4203 </span>            : 
<span class="lineNum">    4204 </span>            : 
<span class="lineNum">    4205 </span><span class="lineCov">          1 :   if (!psLayer || !psClass) return pszSLD;</span>
<span class="lineNum">    4206 </span>            : 
<span class="lineNum">    4207 </span><span class="lineCov">          1 :   for (lid=0 ; lid &lt; psClass-&gt;numlabels ; lid++)</span>
<span class="lineNum">    4208 </span>            :   {
<span class="lineNum">    4209 </span>            :     char * psLabelText;
<span class="lineNum">    4210 </span>            :     expressionObj psLabelExpr;
<span class="lineNum">    4211 </span>            :     parseObj p;
<span class="lineNum">    4212 </span>            : 
<span class="lineNum">    4213 </span><span class="lineCov">          1 :     msInitExpression(&amp;psLabelExpr);</span>
<span class="lineNum">    4214 </span><span class="lineCov">          1 :     psLabelObj = psClass-&gt;labels[lid];</span>
<span class="lineNum">    4215 </span>            : 
<span class="lineNum">    4216 </span><span class="lineCov">          1 :     if (psLabelObj-&gt;text.string)</span>
<span class="lineNum">    4217 </span>            :     {
<span class="lineNum">    4218 </span><span class="lineCov">          1 :       psLabelExpr.string = msStrdup(psLabelObj-&gt;text.string);</span>
<span class="lineNum">    4219 </span><span class="lineCov">          1 :       psLabelExpr.type = psLabelObj-&gt;text.type;</span>
<span class="lineNum">    4220 </span>            :     }
<span class="lineNum">    4221 </span><span class="lineCov">          1 :     else if (psClass-&gt;text.string)</span>
<span class="lineNum">    4222 </span>            :     {
<span class="lineNum">    4223 </span><span class="lineCov">          1 :       psLabelExpr.string = msStrdup(psClass-&gt;text.string);</span>
<span class="lineNum">    4224 </span><span class="lineCov">          1 :       psLabelExpr.type = psClass-&gt;text.type;</span>
<span class="lineNum">    4225 </span>            :     }
<span class="lineNum">    4226 </span><span class="lineCov">          1 :     else if (psLayer-&gt;labelitem)</span>
<span class="lineNum">    4227 </span>            :     {
<span class="lineNum">    4228 </span><span class="lineNoCov">          0 :       psLabelExpr.string = msStrdup(psLayer-&gt;labelitem);</span>
<span class="lineNum">    4229 </span><span class="lineNoCov">          0 :       psLabelExpr.type = MS_STRING;</span>
<span class="lineNum">    4230 </span>            :     }
<span class="lineNum">    4231 </span>            :     else
<span class="lineNum">    4232 </span>            :     {
<span class="lineNum">    4233 </span><span class="lineCov">          1 :       msFreeExpression(&amp;psLabelExpr);</span>
<span class="lineNum">    4234 </span><span class="lineCov">          1 :       continue; // Can't find text content for this &lt;Label&gt;</span>
<span class="lineNum">    4235 </span>            :     }
<span class="lineNum">    4236 </span>            : 
<span class="lineNum">    4237 </span><span class="lineCov">          1 :     if (psLabelExpr.type == MS_STRING)</span>
<span class="lineNum">    4238 </span>            :     {
<span class="lineNum">    4239 </span>            :       // Rewrite string to an expression so that literal strings and attributes
<span class="lineNum">    4240 </span>            :       // are explicitely concatenated, e.g.:
<span class="lineNum">    4241 </span>            :       //   &quot;area is: [area]&quot; becomes (&quot;area is: &quot;+&quot;[area]&quot;+&quot;&quot;)
<span class="lineNum">    4242 </span>            :       //             ^^^^^^                     ^^^^^^^^^^^^
<span class="lineNum">    4243 </span>            :       char *result;
<span class="lineNum">    4244 </span><span class="lineCov">          1 :       result = msStrdup(&quot;\&quot;&quot;);</span>
<span class="lineNum">    4245 </span><span class="lineCov">          1 :       result = msStringConcatenate(result, psLabelExpr.string);</span>
<span class="lineNum">    4246 </span><span class="lineCov">          1 :       result = msStringConcatenate(result, &quot;\&quot;&quot;);</span>
<span class="lineNum">    4247 </span><span class="lineCov">          1 :       msTokenizeExpression(&amp;psLabelExpr, NULL, NULL);</span>
<span class="lineNum">    4248 </span><span class="lineCov">          1 :       for (tokenListNodeObjPtr t = psLabelExpr.tokens ; t ; t=t-&gt;next)</span>
<span class="lineNum">    4249 </span>            :       {
<span class="lineNum">    4250 </span><span class="lineCov">          1 :         if (t-&gt;token == MS_TOKEN_BINDING_DOUBLE ||</span>
<span class="lineNum">    4251 </span><span class="lineCov">          1 :             t-&gt;token == MS_TOKEN_BINDING_INTEGER ||</span>
<span class="lineNum">    4252 </span>            :             t-&gt;token == MS_TOKEN_BINDING_STRING)
<span class="lineNum">    4253 </span>            :         {
<span class="lineNum">    4254 </span><span class="lineCov">          1 :           char * target = msSmallMalloc(strlen(t-&gt;tokenval.bindval.item) + 3);</span>
<span class="lineNum">    4255 </span><span class="lineCov">          1 :           char * replacement = msSmallMalloc(strlen(t-&gt;tokenval.bindval.item) + 9);</span>
<span class="lineNum">    4256 </span><span class="lineCov">          1 :           sprintf(target, &quot;[%s]&quot;, t-&gt;tokenval.bindval.item);</span>
<span class="lineNum">    4257 </span><span class="lineCov">          1 :           sprintf(replacement, &quot;\&quot;+\&quot;[%s]\&quot;+\&quot;&quot;, t-&gt;tokenval.bindval.item);</span>
<span class="lineNum">    4258 </span><span class="lineCov">          1 :           result = msReplaceSubstring(result,target,replacement);</span>
<span class="lineNum">    4259 </span><span class="lineCov">          1 :           msFree(target);</span>
<span class="lineNum">    4260 </span><span class="lineCov">          1 :           msFree(replacement);</span>
<span class="lineNum">    4261 </span>            :         }
<span class="lineNum">    4262 </span>            :       }
<span class="lineNum">    4263 </span><span class="lineCov">          1 :       msFreeExpression(&amp;psLabelExpr);</span>
<span class="lineNum">    4264 </span><span class="lineCov">          1 :       psLabelExpr.string = msStrdup(result);</span>
<span class="lineNum">    4265 </span><span class="lineCov">          1 :       psLabelExpr.type = MS_EXPRESSION;</span>
<span class="lineNum">    4266 </span><span class="lineCov">          1 :       msFree(result);</span>
<span class="lineNum">    4267 </span>            :     }
<span class="lineNum">    4268 </span>            : 
<span class="lineNum">    4269 </span>            :     // Parse label expression to generate SLD tags from MapFile syntax
<span class="lineNum">    4270 </span><span class="lineCov">          1 :     msTokenizeExpression(&amp;psLabelExpr, NULL, NULL);</span>
<span class="lineNum">    4271 </span><span class="lineCov">          1 :     p.expr = &amp;psLabelExpr;</span>
<span class="lineNum">    4272 </span><span class="lineCov">          1 :     p.shape = NULL;</span>
<span class="lineNum">    4273 </span><span class="lineCov">          1 :     p.type = MS_PARSE_TYPE_SLD;</span>
<span class="lineNum">    4274 </span><span class="lineCov">          1 :     yyparse(&amp;p);</span>
<span class="lineNum">    4275 </span><span class="lineCov">          1 :     psLabelText = msStrdup(p.result.strval);</span>
<span class="lineNum">    4276 </span><span class="lineCov">          1 :     msFree(p.result.strval);</span>
<span class="lineNum">    4277 </span><span class="lineCov">          1 :     msFreeExpression(&amp;psLabelExpr);</span>
<span class="lineNum">    4278 </span>            : 
<span class="lineNum">    4279 </span>            :     snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sTextSymbolizer&gt;\n&quot;,  sNameSpace);
<span class="lineNum">    4280 </span><span class="lineCov">          1 :     pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4281 </span>            : 
<span class="lineNum">    4282 </span>            :     snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sLabel&gt;\n%s&lt;/%sLabel&gt;\n&quot;,
<span class="lineNum">    4283 </span>            :         sNameSpace, psLabelText, sNameSpace);
<span class="lineNum">    4284 </span><span class="lineCov">          1 :     pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4285 </span>            : 
<span class="lineNum">    4286 </span>            :     /* -------------------------------------------------------------------- */
<span class="lineNum">    4287 </span>            :     /*      only true type fonts are exported. Font name should be          */
<span class="lineNum">    4288 </span>            :     /*      something like arial-bold-italic. There are 3 parts to the      */
<span class="lineNum">    4289 </span>            :     /*      name font-family, font-style (italic, oblique, normal),         */
<span class="lineNum">    4290 </span>            :     /*      font-weight (bold, normal). These 3 elements are separated      */
<span class="lineNum">    4291 </span>            :     /*      with -.                                                         */
<span class="lineNum">    4292 </span>            :     /* -------------------------------------------------------------------- */
<span class="lineNum">    4293 </span><span class="lineCov">          1 :     if (psLabelObj-&gt;font) {</span>
<span class="lineNum">    4294 </span><span class="lineCov">          1 :       aszFontsParts = msStringSplit(psLabelObj-&gt;font, '-', &amp;nFontParts);</span>
<span class="lineNum">    4295 </span><span class="lineCov">          1 :       if (nFontParts &gt; 0) {</span>
<span class="lineNum">    4296 </span>            :         snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sFont&gt;\n&quot;,  sNameSpace);
<span class="lineNum">    4297 </span><span class="lineCov">          1 :         pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4298 </span>            : 
<span class="lineNum">    4299 </span>            :         /* assuming first one is font-family */
<span class="lineNum">    4300 </span><span class="lineCov">          1 :         snprintf(szTmp, sizeof(szTmp),</span>
<span class="lineNum">    4301 </span>            :             &quot;&lt;%s name=\&quot;font-family\&quot;&gt;%s&lt;/%s&gt;\n&quot;,
<span class="lineNum">    4302 </span>            :             sCssParam, aszFontsParts[0], sCssParam);
<span class="lineNum">    4303 </span><span class="lineCov">          1 :         pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4304 </span><span class="lineCov">          1 :         for (i=1; i&lt;nFontParts; i++) {</span>
<span class="lineNum">    4305 </span><span class="lineCov">          1 :           if (strcasecmp(aszFontsParts[i], &quot;italic&quot;) == 0 ||</span>
<span class="lineNum">    4306 </span><span class="lineCov">          1 :               strcasecmp(aszFontsParts[i], &quot;oblique&quot;) == 0) {</span>
<span class="lineNum">    4307 </span>            :             snprintf(szTmp, sizeof(szTmp),
<span class="lineNum">    4308 </span>            :                 &quot;&lt;%s name=\&quot;font-style\&quot;&gt;%s&lt;/%s&gt;\n&quot;,
<span class="lineNum">    4309 </span>            :                 sCssParam, aszFontsParts[i], sCssParam);
<span class="lineNum">    4310 </span><span class="lineNoCov">          0 :             pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4311 </span><span class="lineCov">          1 :           } else if (strcasecmp(aszFontsParts[i], &quot;bold&quot;) == 0) {</span>
<span class="lineNum">    4312 </span>            :             snprintf(szTmp, sizeof(szTmp),
<span class="lineNum">    4313 </span>            :                 &quot;&lt;%s name=\&quot;font-weight\&quot;&gt;%s&lt;/%s&gt;\n&quot;,
<span class="lineNum">    4314 </span>            :                 sCssParam,
<span class="lineNum">    4315 </span>            :                 aszFontsParts[i], sCssParam);
<span class="lineNum">    4316 </span><span class="lineCov">          1 :             pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4317 </span>            :           }
<span class="lineNum">    4318 </span>            :         }
<span class="lineNum">    4319 </span>            :         /* size */
<span class="lineNum">    4320 </span><span class="lineCov">          1 :         if (psLabelObj-&gt;size &gt; 0) {</span>
<span class="lineNum">    4321 </span>            :           snprintf(szTmp, sizeof(szTmp),
<span class="lineNum">    4322 </span>            :               &quot;&lt;%s name=\&quot;font-size\&quot;&gt;%d&lt;/%s&gt;\n&quot;,
<span class="lineNum">    4323 </span>            :               sCssParam, psLabelObj-&gt;size, sCssParam);
<span class="lineNum">    4324 </span><span class="lineCov">          1 :           pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4325 </span>            :         }
<span class="lineNum">    4326 </span>            :         snprintf(szTmp, sizeof(szTmp), &quot;&lt;/%sFont&gt;\n&quot;,  sNameSpace);
<span class="lineNum">    4327 </span><span class="lineCov">          1 :         pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4328 </span>            :       }
<span class="lineNum">    4329 </span><span class="lineCov">          1 :       msFreeCharArray(aszFontsParts, nFontParts);</span>
<span class="lineNum">    4330 </span>            :     }
<span class="lineNum">    4331 </span>            : 
<span class="lineNum">    4332 </span>            : 
<span class="lineNum">    4333 </span>            :     /* label placement */
<span class="lineNum">    4334 </span>            :     snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sLabelPlacement&gt;\n&lt;%sPointPlacement&gt;\n&quot;,
<span class="lineNum">    4335 </span>            :         sNameSpace, sNameSpace  );
<span class="lineNum">    4336 </span><span class="lineCov">          1 :     pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4337 </span>            : 
<span class="lineNum">    4338 </span>            :     snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sAnchorPoint&gt;\n&quot;, sNameSpace);
<span class="lineNum">    4339 </span><span class="lineCov">          1 :     pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4340 </span>            : 
<span class="lineNum">    4341 </span><span class="lineCov">          1 :     if (psLabelObj-&gt;position == MS_LL) {</span>
<span class="lineNum">    4342 </span>            :       dfAnchorX =0;
<span class="lineNum">    4343 </span>            :       dfAnchorY = 0;
<span class="lineNum">    4344 </span><span class="lineCov">          1 :     } else if (psLabelObj-&gt;position == MS_CL) {</span>
<span class="lineNum">    4345 </span>            :       dfAnchorX =0;
<span class="lineNum">    4346 </span>            :       dfAnchorY = 0.5;
<span class="lineNum">    4347 </span><span class="lineCov">          1 :     } else if (psLabelObj-&gt;position == MS_UL) {</span>
<span class="lineNum">    4348 </span>            :       dfAnchorX =0;
<span class="lineNum">    4349 </span>            :       dfAnchorY = 1;
<span class="lineNum">    4350 </span>            :     }
<span class="lineNum">    4351 </span>            : 
<span class="lineNum">    4352 </span><span class="lineCov">          1 :     else if (psLabelObj-&gt;position == MS_LC) {</span>
<span class="lineNum">    4353 </span>            :       dfAnchorX =0.5;
<span class="lineNum">    4354 </span>            :       dfAnchorY = 0;
<span class="lineNum">    4355 </span><span class="lineCov">          1 :     } else if (psLabelObj-&gt;position == MS_CC) {</span>
<span class="lineNum">    4356 </span>            :       dfAnchorX =0.5;
<span class="lineNum">    4357 </span>            :       dfAnchorY = 0.5;
<span class="lineNum">    4358 </span><span class="lineNoCov">          0 :     } else if (psLabelObj-&gt;position == MS_UC) {</span>
<span class="lineNum">    4359 </span>            :       dfAnchorX =0.5;
<span class="lineNum">    4360 </span>            :       dfAnchorY = 1;
<span class="lineNum">    4361 </span>            :     }
<span class="lineNum">    4362 </span>            : 
<span class="lineNum">    4363 </span><span class="lineNoCov">          0 :     else if (psLabelObj-&gt;position == MS_LR) {</span>
<span class="lineNum">    4364 </span>            :       dfAnchorX =1;
<span class="lineNum">    4365 </span>            :       dfAnchorY = 0;
<span class="lineNum">    4366 </span><span class="lineNoCov">          0 :     } else if (psLabelObj-&gt;position == MS_CR) {</span>
<span class="lineNum">    4367 </span>            :       dfAnchorX =1;
<span class="lineNum">    4368 </span>            :       dfAnchorY = 0.5;
<span class="lineNum">    4369 </span><span class="lineNoCov">          0 :     } else if (psLabelObj-&gt;position == MS_UR) {</span>
<span class="lineNum">    4370 </span>            :       dfAnchorX =1;
<span class="lineNum">    4371 </span>            :       dfAnchorY = 1;
<span class="lineNum">    4372 </span>            :     }
<span class="lineNum">    4373 </span>            :     snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sAnchorPointX&gt;%.1f&lt;/%sAnchorPointX&gt;\n&quot;,
<span class="lineNum">    4374 </span>            :         sNameSpace, dfAnchorX, sNameSpace);
<span class="lineNum">    4375 </span><span class="lineCov">          1 :     pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4376 </span>            :     snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sAnchorPointY&gt;%.1f&lt;/%sAnchorPointY&gt;\n&quot;, sNameSpace,
<span class="lineNum">    4377 </span>            :         dfAnchorY, sNameSpace);
<span class="lineNum">    4378 </span><span class="lineCov">          1 :     pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4379 </span>            : 
<span class="lineNum">    4380 </span>            :     snprintf(szTmp, sizeof(szTmp), &quot;&lt;/%sAnchorPoint&gt;\n&quot;,  sNameSpace);
<span class="lineNum">    4381 </span><span class="lineCov">          1 :     pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4382 </span>            : 
<span class="lineNum">    4383 </span>            :     /* displacement */
<span class="lineNum">    4384 </span><span class="lineCov">          1 :     if (psLabelObj-&gt;offsetx &gt; 0 || psLabelObj-&gt;offsety &gt; 0) {</span>
<span class="lineNum">    4385 </span>            :       snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sDisplacement&gt;\n&quot;,  sNameSpace);
<span class="lineNum">    4386 </span><span class="lineCov">          1 :       pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4387 </span>            : 
<span class="lineNum">    4388 </span><span class="lineCov">          1 :       if (psLabelObj-&gt;offsetx &gt; 0) {</span>
<span class="lineNum">    4389 </span>            :         snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sDisplacementX&gt;%d&lt;/%sDisplacementX&gt;\n&quot;,
<span class="lineNum">    4390 </span>            :             sNameSpace, psLabelObj-&gt;offsetx, sNameSpace);
<span class="lineNum">    4391 </span><span class="lineCov">          1 :         pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4392 </span>            :       }
<span class="lineNum">    4393 </span><span class="lineCov">          1 :       if (psLabelObj-&gt;offsety &gt; 0) {</span>
<span class="lineNum">    4394 </span>            :         snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sDisplacementY&gt;%d&lt;/%sDisplacementY&gt;\n&quot;,
<span class="lineNum">    4395 </span>            :             sNameSpace, psLabelObj-&gt;offsety, sNameSpace);
<span class="lineNum">    4396 </span><span class="lineCov">          1 :         pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4397 </span>            :       }
<span class="lineNum">    4398 </span>            : 
<span class="lineNum">    4399 </span>            :       snprintf(szTmp,  sizeof(szTmp), &quot;&lt;/%sDisplacement&gt;\n&quot;,  sNameSpace);
<span class="lineNum">    4400 </span><span class="lineCov">          1 :       pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4401 </span>            :     }
<span class="lineNum">    4402 </span>            : 
<span class="lineNum">    4403 </span>            :     /* rotation */
<span class="lineNum">    4404 </span><span class="lineCov">          1 :     if (psLabelObj-&gt;angle &gt; 0) {</span>
<span class="lineNum">    4405 </span>            :       snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sRotation&gt;%.2f&lt;/%sRotation&gt;\n&quot;,
<span class="lineNum">    4406 </span>            :           sNameSpace, psLabelObj-&gt;angle, sNameSpace);
<span class="lineNum">    4407 </span><span class="lineCov">          1 :       pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4408 </span>            :     }
<span class="lineNum">    4409 </span>            : 
<span class="lineNum">    4410 </span>            :     snprintf(szTmp, sizeof(szTmp), &quot;&lt;/%sPointPlacement&gt;\n&lt;/%sLabelPlacement&gt;\n&quot;,
<span class="lineNum">    4411 </span>            :         sNameSpace, sNameSpace);
<span class="lineNum">    4412 </span><span class="lineCov">          1 :     pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4413 </span>            : 
<span class="lineNum">    4414 </span><span class="lineCov">          1 :     if (psLabelObj-&gt;outlinecolor.red != -1 &amp;&amp;</span>
<span class="lineNum">    4415 </span><span class="lineCov">          1 :         psLabelObj-&gt;outlinecolor.green != -1 &amp;&amp;</span>
<span class="lineNum">    4416 </span><span class="lineCov">          1 :         psLabelObj-&gt;outlinecolor.blue != -1)</span>
<span class="lineNum">    4417 </span>            :     {
<span class="lineNum">    4418 </span>            :       snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sHalo&gt;\n&quot;, sNameSpace);
<span class="lineNum">    4419 </span><span class="lineCov">          1 :       pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4420 </span><span class="lineCov">          1 :       snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sRadius&gt;%d&lt;/%sRadius&gt;\n&quot;,</span>
<span class="lineNum">    4421 </span>            :           sNameSpace, psLabelObj-&gt;outlinewidth, sNameSpace);
<span class="lineNum">    4422 </span><span class="lineCov">          1 :       pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4423 </span>            :       snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sFill&gt;\n&quot;, sNameSpace);
<span class="lineNum">    4424 </span><span class="lineCov">          1 :       pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4425 </span><span class="lineCov">          1 :       snprintf(szTmp, sizeof(szTmp), &quot;&lt;%s name=\&quot;fill\&quot;&gt;#%02x%02x%02x&lt;/%s&gt;\n&quot;,</span>
<span class="lineNum">    4426 </span>            :           sCssParam,
<span class="lineNum">    4427 </span>            :           psLabelObj-&gt;outlinecolor.red,
<span class="lineNum">    4428 </span>            :           psLabelObj-&gt;outlinecolor.green,
<span class="lineNum">    4429 </span>            :           psLabelObj-&gt;outlinecolor.blue,
<span class="lineNum">    4430 </span>            :           sCssParam);
<span class="lineNum">    4431 </span><span class="lineCov">          1 :       pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4432 </span>            :       snprintf(szTmp, sizeof(szTmp), &quot;&lt;/%sFill&gt;\n&quot;, sNameSpace);
<span class="lineNum">    4433 </span><span class="lineCov">          1 :       pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4434 </span>            :       snprintf(szTmp, sizeof(szTmp), &quot;&lt;/%sHalo&gt;\n&quot;, sNameSpace);
<span class="lineNum">    4435 </span><span class="lineCov">          1 :       pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4436 </span>            :     }
<span class="lineNum">    4437 </span>            : 
<span class="lineNum">    4438 </span>            :     /* color */
<span class="lineNum">    4439 </span><span class="lineCov">          1 :     if (psLabelObj-&gt;color.red != -1 &amp;&amp;</span>
<span class="lineNum">    4440 </span><span class="lineCov">          1 :         psLabelObj-&gt;color.green != -1 &amp;&amp;</span>
<span class="lineNum">    4441 </span><span class="lineCov">          1 :         psLabelObj-&gt;color.blue != -1)</span>
<span class="lineNum">    4442 </span>            :     {
<span class="lineNum">    4443 </span>            :       snprintf(szTmp, sizeof(szTmp), &quot;&lt;%sFill&gt;\n&quot;, sNameSpace );
<span class="lineNum">    4444 </span><span class="lineCov">          1 :       pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4445 </span>            : 
<span class="lineNum">    4446 </span>            :       sprintf(szHexColor,&quot;%02hhx%02hhx%02hhx&quot;,
<span class="lineNum">    4447 </span><span class="lineCov">          1 :           (unsigned char)psLabelObj-&gt;color.red,</span>
<span class="lineNum">    4448 </span><span class="lineCov">          1 :           (unsigned char)psLabelObj-&gt;color.green,</span>
<span class="lineNum">    4449 </span><span class="lineCov">          1 :           (unsigned char)psLabelObj-&gt;color.blue);</span>
<span class="lineNum">    4450 </span>            : 
<span class="lineNum">    4451 </span>            :       snprintf(szTmp, sizeof(szTmp),
<span class="lineNum">    4452 </span>            :           &quot;&lt;%s name=\&quot;fill\&quot;&gt;#%s&lt;/%s&gt;\n&quot;,
<span class="lineNum">    4453 </span>            :           sCssParam, szHexColor, sCssParam);
<span class="lineNum">    4454 </span><span class="lineCov">          1 :       pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4455 </span>            : 
<span class="lineNum">    4456 </span>            :       snprintf(szTmp, sizeof(szTmp), &quot;&lt;/%sFill&gt;\n&quot;,  sNameSpace);
<span class="lineNum">    4457 </span><span class="lineCov">          1 :       pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4458 </span>            :     }
<span class="lineNum">    4459 </span>            : 
<span class="lineNum">    4460 </span>            :     snprintf(szTmp, sizeof(szTmp), &quot;&lt;/%sTextSymbolizer&gt;\n&quot;,  sNameSpace);
<span class="lineNum">    4461 </span><span class="lineCov">          1 :     pszSLD = msStringConcatenate(pszSLD, szTmp);</span>
<span class="lineNum">    4462 </span>            : 
<span class="lineNum">    4463 </span><span class="lineCov">          1 :     msFree(psLabelText);</span>
<span class="lineNum">    4464 </span>            :   }
<span class="lineNum">    4465 </span>            :   return pszSLD;
<span class="lineNum">    4466 </span>            : 
<span class="lineNum">    4467 </span>            : #else
<span class="lineNum">    4468 </span>            :   return NULL;
<span class="lineNum">    4469 </span>            : #endif
<span class="lineNum">    4470 </span>            : }
<span class="lineNum">    4471 </span>            : 
<a name="4472"><span class="lineNum">    4472 </span>            : #if (defined(USE_WMS_SVR) || defined (USE_WFS_SVR) || defined (USE_WCS_SVR) || defined(USE_SOS_SVR))</a>
<span class="lineNum">    4473 </span>            : 
<span class="lineNum">    4474 </span><span class="lineCov">          1 : static void msSLDAppendName(msStringBuffer* sb, const char* pszName, int nVersion)</span>
<span class="lineNum">    4475 </span>            : {
<span class="lineNum">    4476 </span><span class="lineCov">          1 :     char* pszEncoded = msEncodeHTMLEntities(pszName);</span>
<span class="lineNum">    4477 </span><span class="lineCov">          1 :     msStringBufferAppend(sb, (nVersion &gt; OWS_1_0_0) ? &quot;&lt;se:Name&gt;&quot; : &quot;&lt;Name&gt;&quot;);</span>
<span class="lineNum">    4478 </span><span class="lineCov">          1 :     msStringBufferAppend(sb, pszEncoded);</span>
<span class="lineNum">    4479 </span><span class="lineCov">          1 :     msStringBufferAppend(sb, (nVersion &gt; OWS_1_0_0) ? &quot;&lt;/se:Name&gt;\n&quot; : &quot;&lt;/Name&gt;\n&quot;);</span>
<span class="lineNum">    4480 </span><span class="lineCov">          1 :     msFree(pszEncoded);</span>
<a name="4481"><span class="lineNum">    4481 </span><span class="lineCov">          1 : }</span></a>
<span class="lineNum">    4482 </span>            : 
<span class="lineNum">    4483 </span><span class="lineCov">          1 : static void msSLDGenerateUserStyle(msStringBuffer* sb, layerObj *psLayer, int nVersion,</span>
<span class="lineNum">    4484 </span>            :                                    const char* pszTargetGroup)
<span class="lineNum">    4485 </span>            : {
<span class="lineNum">    4486 </span>            :     const char* pszWfsFilter;
<span class="lineNum">    4487 </span>            : 
<span class="lineNum">    4488 </span><span class="lineCov">          1 :     msStringBufferAppend(sb, &quot;&lt;UserStyle&gt;\n&quot;);</span>
<span class="lineNum">    4489 </span>            : 
<span class="lineNum">    4490 </span><span class="lineCov">          1 :     if( pszTargetGroup )</span>
<span class="lineNum">    4491 </span>            :     {
<span class="lineNum">    4492 </span><span class="lineCov">          1 :         msSLDAppendName(sb, pszTargetGroup, nVersion);</span>
<span class="lineNum">    4493 </span><span class="lineCov">          1 :         if( psLayer-&gt;classgroup &amp;&amp;</span>
<span class="lineNum">    4494 </span><span class="lineCov">          1 :             strcmp(psLayer-&gt;classgroup, pszTargetGroup) == 0 )</span>
<span class="lineNum">    4495 </span>            :         {
<span class="lineNum">    4496 </span><span class="lineCov">          1 :             msStringBufferAppend(sb, nVersion &gt; OWS_1_0_0 ?</span>
<span class="lineNum">    4497 </span>            :                                         &quot;&lt;se:IsDefault&gt;true&lt;/se:IsDefault&gt;\n&quot; :
<span class="lineNum">    4498 </span>            :                                         &quot;&lt;IsDefault&gt;true&lt;/IsDefault&gt;\n&quot;);
<span class="lineNum">    4499 </span>            :         }
<span class="lineNum">    4500 </span>            :     }
<span class="lineNum">    4501 </span>            : 
<span class="lineNum">    4502 </span><span class="lineCov">          1 :     msStringBufferAppend(sb, nVersion &gt; OWS_1_0_0 ?</span>
<span class="lineNum">    4503 </span>            :         &quot;&lt;se:FeatureTypeStyle&gt;\n&quot; : &quot;&lt;FeatureTypeStyle&gt;\n&quot;);
<span class="lineNum">    4504 </span>            : 
<span class="lineNum">    4505 </span><span class="lineCov">          1 :     pszWfsFilter = msLookupHashTable(&amp;(psLayer-&gt;metadata), &quot;wfs_filter&quot;);</span>
<span class="lineNum">    4506 </span><span class="lineCov">          1 :     if (psLayer-&gt;numclasses &gt; 0) {</span>
<span class="lineNum">    4507 </span>            :       int i;
<span class="lineNum">    4508 </span><span class="lineCov">          1 :       for (i=0; i&lt;psLayer-&gt;numclasses; i++) {</span>
<span class="lineNum">    4509 </span>            :         char* pszFilter;
<span class="lineNum">    4510 </span>            :         double dfMinScale =-1, dfMaxScale = -1;
<span class="lineNum">    4511 </span>            : 
<span class="lineNum">    4512 </span>            :         /* Only write down classes that match the group of interest */
<span class="lineNum">    4513 </span><span class="lineCov">          1 :         if( psLayer-&gt;class[i]-&gt;group )</span>
<span class="lineNum">    4514 </span>            :         {
<span class="lineNum">    4515 </span><span class="lineCov">          1 :             if( pszTargetGroup == NULL ||</span>
<span class="lineNum">    4516 </span><span class="lineCov">          1 :                 strcmp(psLayer-&gt;class[i]-&gt;group, pszTargetGroup) != 0 )</span>
<span class="lineNum">    4517 </span>            :             {
<span class="lineNum">    4518 </span><span class="lineCov">          1 :                 continue;</span>
<span class="lineNum">    4519 </span>            :             }
<span class="lineNum">    4520 </span>            :         }
<span class="lineNum">    4521 </span><span class="lineCov">          1 :         else if( pszTargetGroup != NULL )</span>
<span class="lineNum">    4522 </span>            :         {
<span class="lineNum">    4523 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">    4524 </span>            :         }
<span class="lineNum">    4525 </span>            : 
<span class="lineNum">    4526 </span><span class="lineCov">          1 :         msStringBufferAppend(sb, nVersion &gt; OWS_1_0_0 ? &quot;&lt;se:Rule&gt;\n&quot; : &quot;&lt;Rule&gt;\n&quot; );</span>
<span class="lineNum">    4527 </span>            : 
<span class="lineNum">    4528 </span>            :         /* if class has a name, use it as the RULE name */
<span class="lineNum">    4529 </span><span class="lineCov">          1 :         if (psLayer-&gt;class[i]-&gt;name) {</span>
<span class="lineNum">    4530 </span><span class="lineCov">          1 :           msSLDAppendName(sb, psLayer-&gt;class[i]-&gt;name, nVersion);</span>
<span class="lineNum">    4531 </span>            :         }
<span class="lineNum">    4532 </span>            :         /* -------------------------------------------------------------------- */
<span class="lineNum">    4533 </span>            :         /*      get the Filter if there is a class expression.                  */
<span class="lineNum">    4534 </span>            :         /* -------------------------------------------------------------------- */
<span class="lineNum">    4535 </span><span class="lineCov">          1 :         pszFilter = msSLDGetFilter(psLayer-&gt;class[i] ,</span>
<span class="lineNum">    4536 </span>            :                                    pszWfsFilter);
<span class="lineNum">    4537 </span>            : 
<span class="lineNum">    4538 </span><span class="lineCov">          1 :         if (pszFilter) {</span>
<span class="lineNum">    4539 </span><span class="lineCov">          1 :           msStringBufferAppend(sb, pszFilter);</span>
<span class="lineNum">    4540 </span><span class="lineCov">          1 :           free(pszFilter);</span>
<span class="lineNum">    4541 </span>            :         }
<span class="lineNum">    4542 </span>            :         /* -------------------------------------------------------------------- */
<span class="lineNum">    4543 </span>            :         /*      generate the min/max scale.                                     */
<span class="lineNum">    4544 </span>            :         /* -------------------------------------------------------------------- */
<span class="lineNum">    4545 </span>            :         dfMinScale = -1.0;
<span class="lineNum">    4546 </span><span class="lineCov">          1 :         if (psLayer-&gt;class[i]-&gt;minscaledenom &gt; 0)</span>
<span class="lineNum">    4547 </span>            :           dfMinScale = psLayer-&gt;class[i]-&gt;minscaledenom;
<span class="lineNum">    4548 </span><span class="lineCov">          1 :         else if (psLayer-&gt;minscaledenom &gt; 0)</span>
<span class="lineNum">    4549 </span>            :           dfMinScale = psLayer-&gt;minscaledenom;
<span class="lineNum">    4550 </span><span class="lineCov">          1 :         else if (psLayer-&gt;map &amp;&amp; psLayer-&gt;map-&gt;web.minscaledenom &gt; 0)</span>
<span class="lineNum">    4551 </span>            :           dfMinScale = psLayer-&gt;map-&gt;web.minscaledenom;
<span class="lineNum">    4552 </span><span class="lineCov">          1 :         if (dfMinScale &gt; 0) {</span>
<span class="lineNum">    4553 </span>            :           char szTmp[100];
<span class="lineNum">    4554 </span><span class="lineCov">          1 :           if (nVersion &gt; OWS_1_0_0)</span>
<span class="lineNum">    4555 </span>            :             snprintf(szTmp, sizeof(szTmp), &quot;&lt;se:MinScaleDenominator&gt;%f&lt;/se:MinScaleDenominator&gt;\n&quot;,
<span class="lineNum">    4556 </span>            :                      dfMinScale);
<span class="lineNum">    4557 </span>            :           else
<span class="lineNum">    4558 </span>            :             snprintf(szTmp, sizeof(szTmp), &quot;&lt;MinScaleDenominator&gt;%f&lt;/MinScaleDenominator&gt;\n&quot;,
<span class="lineNum">    4559 </span>            :                      dfMinScale);
<span class="lineNum">    4560 </span>            : 
<span class="lineNum">    4561 </span><span class="lineCov">          1 :           msStringBufferAppend(sb, szTmp);</span>
<span class="lineNum">    4562 </span>            :         }
<span class="lineNum">    4563 </span>            : 
<span class="lineNum">    4564 </span>            :         dfMaxScale = -1.0;
<span class="lineNum">    4565 </span><span class="lineCov">          1 :         if (psLayer-&gt;class[i]-&gt;maxscaledenom &gt; 0)</span>
<span class="lineNum">    4566 </span>            :           dfMaxScale = psLayer-&gt;class[i]-&gt;maxscaledenom;
<span class="lineNum">    4567 </span><span class="lineCov">          1 :         else if (psLayer-&gt;maxscaledenom &gt; 0)</span>
<span class="lineNum">    4568 </span>            :           dfMaxScale = psLayer-&gt;maxscaledenom;
<span class="lineNum">    4569 </span><span class="lineCov">          1 :         else if (psLayer-&gt;map &amp;&amp; psLayer-&gt;map-&gt;web.maxscaledenom &gt; 0)</span>
<span class="lineNum">    4570 </span>            :           dfMaxScale = psLayer-&gt;map-&gt;web.maxscaledenom;
<span class="lineNum">    4571 </span><span class="lineCov">          1 :         if (dfMaxScale &gt; 0) {</span>
<span class="lineNum">    4572 </span>            :           char szTmp[100];
<span class="lineNum">    4573 </span><span class="lineNoCov">          0 :           if (nVersion &gt; OWS_1_0_0)</span>
<span class="lineNum">    4574 </span>            :             snprintf(szTmp, sizeof(szTmp), &quot;&lt;se:MaxScaleDenominator&gt;%f&lt;/se:MaxScaleDenominator&gt;\n&quot;,
<span class="lineNum">    4575 </span>            :                      dfMaxScale);
<span class="lineNum">    4576 </span>            :           else
<span class="lineNum">    4577 </span>            :             snprintf(szTmp, sizeof(szTmp), &quot;&lt;MaxScaleDenominator&gt;%f&lt;/MaxScaleDenominator&gt;\n&quot;,
<span class="lineNum">    4578 </span>            :                      dfMaxScale);
<span class="lineNum">    4579 </span>            : 
<span class="lineNum">    4580 </span><span class="lineNoCov">          0 :           msStringBufferAppend(sb, szTmp);</span>
<span class="lineNum">    4581 </span>            :         }
<span class="lineNum">    4582 </span>            : 
<span class="lineNum">    4583 </span>            : 
<span class="lineNum">    4584 </span>            : 
<span class="lineNum">    4585 </span>            :         /* -------------------------------------------------------------------- */
<span class="lineNum">    4586 </span>            :         /*      Line symbolizer.                                                */
<span class="lineNum">    4587 </span>            :         /*                                                                      */
<span class="lineNum">    4588 </span>            :         /*      Right now only generates a stroke element containing css        */
<span class="lineNum">    4589 </span>            :         /*      parameters.                                                     */
<span class="lineNum">    4590 </span>            :         /*      Lines using symbols TODO (specially for dash lines)             */
<span class="lineNum">    4591 </span>            :         /* -------------------------------------------------------------------- */
<span class="lineNum">    4592 </span><span class="lineCov">          1 :         if (psLayer-&gt;type == MS_LAYER_LINE) {</span>
<span class="lineNum">    4593 </span>            :           int j;
<span class="lineNum">    4594 </span><span class="lineCov">          1 :           for (j=0; j&lt;psLayer-&gt;class[i]-&gt;numstyles; j++) {</span>
<span class="lineNum">    4595 </span><span class="lineCov">          1 :             styleObj* psStyle = psLayer-&gt;class[i]-&gt;styles[j];</span>
<span class="lineNum">    4596 </span><span class="lineCov">          1 :             char* pszSLD = msSLDGenerateLineSLD(psStyle, psLayer, nVersion);</span>
<span class="lineNum">    4597 </span><span class="lineCov">          1 :             if (pszSLD) {</span>
<span class="lineNum">    4598 </span><span class="lineCov">          1 :               msStringBufferAppend(sb, pszSLD);</span>
<span class="lineNum">    4599 </span><span class="lineCov">          1 :               free(pszSLD);</span>
<span class="lineNum">    4600 </span>            :             }
<span class="lineNum">    4601 </span>            :           }
<span class="lineNum">    4602 </span>            : 
<span class="lineNum">    4603 </span><span class="lineCov">          1 :         } else if (psLayer-&gt;type == MS_LAYER_POLYGON) {</span>
<span class="lineNum">    4604 </span>            :           int j;
<span class="lineNum">    4605 </span><span class="lineCov">          1 :           for (j=0; j&lt;psLayer-&gt;class[i]-&gt;numstyles; j++) {</span>
<span class="lineNum">    4606 </span><span class="lineCov">          1 :             styleObj* psStyle = psLayer-&gt;class[i]-&gt;styles[j];</span>
<span class="lineNum">    4607 </span><span class="lineCov">          1 :             char* pszSLD = msSLDGeneratePolygonSLD(psStyle, psLayer, nVersion);</span>
<span class="lineNum">    4608 </span><span class="lineCov">          1 :             if (pszSLD) {</span>
<span class="lineNum">    4609 </span><span class="lineCov">          1 :               msStringBufferAppend(sb, pszSLD);</span>
<span class="lineNum">    4610 </span><span class="lineCov">          1 :               free(pszSLD);</span>
<span class="lineNum">    4611 </span>            :             }
<span class="lineNum">    4612 </span>            :           }
<span class="lineNum">    4613 </span>            : 
<span class="lineNum">    4614 </span><span class="lineCov">          1 :         } else if (psLayer-&gt;type == MS_LAYER_POINT) {</span>
<span class="lineNum">    4615 </span>            :           int j;
<span class="lineNum">    4616 </span><span class="lineCov">          1 :           for (j=0; j&lt;psLayer-&gt;class[i]-&gt;numstyles; j++) {</span>
<span class="lineNum">    4617 </span><span class="lineCov">          1 :             styleObj* psStyle = psLayer-&gt;class[i]-&gt;styles[j];</span>
<span class="lineNum">    4618 </span><span class="lineCov">          1 :             char* pszSLD = msSLDGeneratePointSLD(psStyle, psLayer, nVersion);</span>
<span class="lineNum">    4619 </span><span class="lineCov">          1 :             if (pszSLD) {</span>
<span class="lineNum">    4620 </span><span class="lineCov">          1 :               msStringBufferAppend(sb, pszSLD);</span>
<span class="lineNum">    4621 </span><span class="lineCov">          1 :               free(pszSLD);</span>
<span class="lineNum">    4622 </span>            :             }
<span class="lineNum">    4623 </span>            :           }
<span class="lineNum">    4624 </span>            : 
<span class="lineNum">    4625 </span>            :         }
<span class="lineNum">    4626 </span>            :         {
<span class="lineNum">    4627 </span>            :           /* label if it exists */
<span class="lineNum">    4628 </span><span class="lineCov">          1 :           char* pszSLD = msSLDGenerateTextSLD(psLayer-&gt;class[i], psLayer, nVersion);</span>
<span class="lineNum">    4629 </span><span class="lineCov">          1 :           if (pszSLD) {</span>
<span class="lineNum">    4630 </span><span class="lineCov">          1 :             msStringBufferAppend(sb, pszSLD);</span>
<span class="lineNum">    4631 </span><span class="lineCov">          1 :             free(pszSLD);</span>
<span class="lineNum">    4632 </span>            :           }
<span class="lineNum">    4633 </span>            :         }
<span class="lineNum">    4634 </span><span class="lineCov">          1 :         msStringBufferAppend(sb, nVersion &gt; OWS_1_0_0 ? &quot;&lt;/se:Rule&gt;\n&quot; : &quot;&lt;/Rule&gt;\n&quot;);</span>
<span class="lineNum">    4635 </span>            :       }
<span class="lineNum">    4636 </span>            :     }
<span class="lineNum">    4637 </span>            : 
<span class="lineNum">    4638 </span><span class="lineCov">          1 :     msStringBufferAppend(sb, nVersion &gt; OWS_1_0_0 ? &quot;&lt;/se:FeatureTypeStyle&gt;\n&quot; : &quot;&lt;/FeatureTypeStyle&gt;\n&quot;);</span>
<span class="lineNum">    4639 </span><span class="lineCov">          1 :     msStringBufferAppend(sb, &quot;&lt;/UserStyle&gt;\n&quot;);</span>
<span class="lineNum">    4640 </span><span class="lineCov">          1 : }</span>
<span class="lineNum">    4641 </span>            : 
<span class="lineNum">    4642 </span>            : #endif
<span class="lineNum">    4643 </span>            : 
<span class="lineNum">    4644 </span>            : /************************************************************************/
<span class="lineNum">    4645 </span>            : /*                          msSLDGenerateSLDLayer                       */
<span class="lineNum">    4646 </span>            : /*                                                                      */
<a name="4647"><span class="lineNum">    4647 </span>            : /*      Generate an SLD XML string based on the layer's classes.        */</a>
<span class="lineNum">    4648 </span>            : /************************************************************************/
<span class="lineNum">    4649 </span><span class="lineCov">          1 : char *msSLDGenerateSLDLayer(layerObj *psLayer, int nVersion)</span>
<span class="lineNum">    4650 </span>            : {
<span class="lineNum">    4651 </span>            : #if defined(USE_WMS_SVR) || defined (USE_WFS_SVR) || defined (USE_WCS_SVR) || defined(USE_SOS_SVR)
<span class="lineNum">    4652 </span>            : 
<span class="lineNum">    4653 </span>            :   const char *pszWMSLayerName = NULL;
<span class="lineNum">    4654 </span><span class="lineCov">          1 :   msStringBuffer* sb = msStringBufferAlloc();</span>
<span class="lineNum">    4655 </span>            : 
<span class="lineNum">    4656 </span><span class="lineCov">          1 :   if (psLayer &amp;&amp;</span>
<span class="lineNum">    4657 </span><span class="lineCov">          1 :       (psLayer-&gt;status == MS_ON || psLayer-&gt;status == MS_DEFAULT) &amp;&amp;</span>
<span class="lineNum">    4658 </span><span class="lineCov">          1 :       (psLayer-&gt;type == MS_LAYER_POINT ||</span>
<span class="lineNum">    4659 </span>            :        psLayer-&gt;type == MS_LAYER_LINE ||
<span class="lineNum">    4660 </span>            :        psLayer-&gt;type == MS_LAYER_POLYGON )) {
<span class="lineNum">    4661 </span>            : 
<span class="lineNum">    4662 </span>            :     int i;
<span class="lineNum">    4663 </span>            :     int numClassGroupNames = 0;
<span class="lineNum">    4664 </span><span class="lineCov">          1 :     char** papszClassGroupNames =</span>
<span class="lineNum">    4665 </span><span class="lineCov">          1 :                 (char**) msSmallMalloc(sizeof(char*) * psLayer-&gt;numclasses);</span>
<span class="lineNum">    4666 </span><span class="lineCov">          1 :     for (i=0; i&lt;psLayer-&gt;numclasses; i++) {</span>
<span class="lineNum">    4667 </span><span class="lineCov">          1 :         const char* group = psLayer-&gt;class[i]-&gt;group;</span>
<span class="lineNum">    4668 </span>            :         int j;
<span class="lineNum">    4669 </span><span class="lineCov">          1 :         for( j = 0; j &lt; numClassGroupNames; j++ )</span>
<span class="lineNum">    4670 </span>            :         {
<span class="lineNum">    4671 </span><span class="lineCov">          1 :             if( group == NULL )</span>
<span class="lineNum">    4672 </span>            :             {
<span class="lineNum">    4673 </span><span class="lineCov">          1 :                 if( papszClassGroupNames[j] == NULL )</span>
<span class="lineNum">    4674 </span>            :                     break;
<span class="lineNum">    4675 </span>            :             }
<span class="lineNum">    4676 </span><span class="lineCov">          1 :             else if( papszClassGroupNames[j] != NULL &amp;&amp;</span>
<span class="lineNum">    4677 </span><span class="lineCov">          1 :                      strcmp(papszClassGroupNames[j], group) == 0 )</span>
<span class="lineNum">    4678 </span>            :             {
<span class="lineNum">    4679 </span>            :                 break;
<span class="lineNum">    4680 </span>            :             }
<span class="lineNum">    4681 </span>            :         }
<span class="lineNum">    4682 </span><span class="lineCov">          1 :         if( j &gt;= numClassGroupNames )</span>
<span class="lineNum">    4683 </span>            :         {
<span class="lineNum">    4684 </span><span class="lineCov">          1 :             papszClassGroupNames[numClassGroupNames] = group ? msStrdup(group) : NULL;</span>
<span class="lineNum">    4685 </span><span class="lineCov">          1 :             numClassGroupNames ++;</span>
<span class="lineNum">    4686 </span>            :         }
<span class="lineNum">    4687 </span>            :     }
<span class="lineNum">    4688 </span>            : 
<span class="lineNum">    4689 </span><span class="lineCov">          1 :     msStringBufferAppend(sb, &quot;&lt;NamedLayer&gt;\n&quot;);</span>
<span class="lineNum">    4690 </span>            : 
<span class="lineNum">    4691 </span><span class="lineCov">          1 :     pszWMSLayerName = msOWSLookupMetadata(&amp;(psLayer-&gt;metadata), &quot;MO&quot;, &quot;name&quot;);</span>
<span class="lineNum">    4692 </span><span class="lineCov">          1 :     msSLDAppendName(sb,</span>
<span class="lineNum">    4693 </span>            :                     pszWMSLayerName ? pszWMSLayerName :
<span class="lineNum">    4694 </span><span class="lineCov">          1 :                     psLayer-&gt;name ? psLayer-&gt;name :</span>
<span class="lineNum">    4695 </span>            :                     &quot;NamedLayer&quot;,
<span class="lineNum">    4696 </span>            :                     nVersion);
<span class="lineNum">    4697 </span>            : 
<span class="lineNum">    4698 </span><span class="lineCov">          1 :     for (i=0; i&lt;numClassGroupNames; i++) {</span>
<span class="lineNum">    4699 </span><span class="lineCov">          1 :         msSLDGenerateUserStyle(sb, psLayer, nVersion, papszClassGroupNames[i]);</span>
<span class="lineNum">    4700 </span><span class="lineCov">          1 :         msFree(papszClassGroupNames[i]);</span>
<span class="lineNum">    4701 </span>            :     }
<span class="lineNum">    4702 </span><span class="lineCov">          1 :     msFree(papszClassGroupNames);</span>
<span class="lineNum">    4703 </span>            : 
<span class="lineNum">    4704 </span><span class="lineCov">          1 :     msStringBufferAppend(sb, &quot;&lt;/NamedLayer&gt;\n&quot;);</span>
<span class="lineNum">    4705 </span>            :   }
<span class="lineNum">    4706 </span><span class="lineCov">          1 :   return msStringBufferReleaseStringAndFree(sb);</span>
<span class="lineNum">    4707 </span>            : 
<span class="lineNum">    4708 </span>            : #else
<span class="lineNum">    4709 </span>            :   msSetError(MS_MISCERR, &quot;OWS support is not available.&quot;,
<span class="lineNum">    4710 </span>            :              &quot;msSLDGenerateSLDLayer()&quot;);
<span class="lineNum">    4711 </span>            :   return NULL;
<span class="lineNum">    4712 </span>            : #endif
<span class="lineNum">    4713 </span>            : }
<a name="4714"><span class="lineNum">    4714 </span>            : </a>
<span class="lineNum">    4715 </span>            : 
<span class="lineNum">    4716 </span><span class="lineCov">          1 : char *msSLDGetComparisonValue(char *pszExpression)</span>
<span class="lineNum">    4717 </span>            : {
<span class="lineNum">    4718 </span>            :   char *pszValue = NULL;
<span class="lineNum">    4719 </span><span class="lineCov">          1 :   if (!pszExpression)</span>
<span class="lineNum">    4720 </span>            :     return NULL;
<span class="lineNum">    4721 </span>            : 
<span class="lineNum">    4722 </span><span class="lineCov">          1 :   if (strstr(pszExpression, &quot;&lt;=&quot;) || strstr(pszExpression, &quot; le &quot;))</span>
<span class="lineNum">    4723 </span><span class="lineCov">          1 :     pszValue = msStrdup(&quot;PropertyIsLessThanOrEqualTo&quot;);</span>
<span class="lineNum">    4724 </span><span class="lineCov">          1 :   else if (strstr(pszExpression, &quot;=~&quot;))</span>
<span class="lineNum">    4725 </span><span class="lineNoCov">          0 :     pszValue = msStrdup(&quot;PropertyIsLike&quot;);</span>
<span class="lineNum">    4726 </span><span class="lineCov">          1 :   else if (strstr(pszExpression, &quot;~*&quot;))</span>
<span class="lineNum">    4727 </span><span class="lineNoCov">          0 :     pszValue = msStrdup(&quot;PropertyIsLike&quot;);</span>
<span class="lineNum">    4728 </span><span class="lineCov">          1 :   else if (strstr(pszExpression, &quot;&gt;=&quot;) || strstr(pszExpression, &quot; ge &quot;))</span>
<span class="lineNum">    4729 </span><span class="lineNoCov">          0 :     pszValue = msStrdup(&quot;PropertyIsGreaterThanOrEqualTo&quot;);</span>
<span class="lineNum">    4730 </span><span class="lineCov">          1 :   else if (strstr(pszExpression, &quot;!=&quot;) || strstr(pszExpression, &quot; ne &quot;))</span>
<span class="lineNum">    4731 </span><span class="lineNoCov">          0 :     pszValue = msStrdup(&quot;PropertyIsNotEqualTo&quot;);</span>
<span class="lineNum">    4732 </span><span class="lineCov">          1 :   else if (strstr(pszExpression, &quot;=&quot;) || strstr(pszExpression, &quot; eq &quot;))</span>
<span class="lineNum">    4733 </span><span class="lineCov">          1 :     pszValue = msStrdup(&quot;PropertyIsEqualTo&quot;);</span>
<span class="lineNum">    4734 </span><span class="lineCov">          1 :   else if (strstr(pszExpression, &quot;&lt;&quot;) || strstr(pszExpression, &quot; lt &quot;))</span>
<span class="lineNum">    4735 </span><span class="lineNoCov">          0 :     pszValue = msStrdup(&quot;PropertyIsLessThan&quot;);</span>
<span class="lineNum">    4736 </span><span class="lineCov">          1 :   else if (strstr(pszExpression, &quot;&gt;&quot;) || strstr(pszExpression, &quot; gt &quot;))</span>
<span class="lineNum">    4737 </span><span class="lineCov">          1 :     pszValue = msStrdup(&quot;PropertyIsGreaterThan&quot;);</span>
<span class="lineNum">    4738 </span>            : 
<span class="lineNum">    4739 </span>            : 
<span class="lineNum">    4740 </span>            :   return pszValue;
<a name="4741"><span class="lineNum">    4741 </span>            : }</a>
<span class="lineNum">    4742 </span>            : 
<span class="lineNum">    4743 </span><span class="lineCov">          1 : char *msSLDGetLogicalOperator(char *pszExpression)</span>
<span class="lineNum">    4744 </span>            : {
<span class="lineNum">    4745 </span>            : 
<span class="lineNum">    4746 </span><span class="lineCov">          1 :   if (!pszExpression)</span>
<span class="lineNum">    4747 </span>            :     return NULL;
<span class="lineNum">    4748 </span>            : 
<span class="lineNum">    4749 </span><span class="lineCov">          1 :   if(strcasestr(pszExpression, &quot; AND &quot;) || strcasestr(pszExpression, &quot;AND(&quot;))</span>
<span class="lineNum">    4750 </span><span class="lineCov">          1 :     return msStrdup(&quot;And&quot;);</span>
<span class="lineNum">    4751 </span>            : 
<span class="lineNum">    4752 </span><span class="lineCov">          1 :   if(strcasestr(pszExpression, &quot; OR &quot;) || strcasestr(pszExpression, &quot;OR(&quot;))</span>
<span class="lineNum">    4753 </span><span class="lineCov">          1 :     return msStrdup(&quot;Or&quot;);</span>
<span class="lineNum">    4754 </span>            : 
<span class="lineNum">    4755 </span><span class="lineCov">          1 :   if(strcasestr(pszExpression, &quot;NOT &quot;) || strcasestr(pszExpression, &quot;NOT(&quot;))</span>
<span class="lineNum">    4756 </span><span class="lineCov">          1 :     return msStrdup(&quot;Not&quot;);</span>
<span class="lineNum">    4757 </span>            : 
<span class="lineNum">    4758 </span>            :   return NULL;
<a name="4759"><span class="lineNum">    4759 </span>            : }</a>
<span class="lineNum">    4760 </span>            : 
<span class="lineNum">    4761 </span><span class="lineCov">          1 : char *msSLDGetRightExpressionOfOperator(char *pszExpression)</span>
<span class="lineNum">    4762 </span>            : {
<span class="lineNum">    4763 </span>            :   char *pszAnd = NULL, *pszOr = NULL, *pszNot=NULL;
<span class="lineNum">    4764 </span>            : 
<span class="lineNum">    4765 </span><span class="lineCov">          1 :   pszAnd = strcasestr(pszExpression, &quot; AND &quot;);</span>
<span class="lineNum">    4766 </span>            : 
<span class="lineNum">    4767 </span><span class="lineCov">          1 :   if (!pszAnd){</span>
<span class="lineNum">    4768 </span><span class="lineCov">          1 :       pszAnd = strcasestr(pszExpression, &quot;AND(&quot;);</span>
<span class="lineNum">    4769 </span>            :   }
<span class="lineNum">    4770 </span>            : 
<span class="lineNum">    4771 </span><span class="lineCov">          1 :   if (pszAnd)</span>
<span class="lineNum">    4772 </span><span class="lineCov">          1 :     return msStrdup(pszAnd+4);</span>
<span class="lineNum">    4773 </span>            :   else {
<span class="lineNum">    4774 </span><span class="lineCov">          1 :     pszOr = strcasestr(pszExpression, &quot; OR &quot;);</span>
<span class="lineNum">    4775 </span>            : 
<span class="lineNum">    4776 </span><span class="lineCov">          1 :     if (!pszOr){</span>
<span class="lineNum">    4777 </span><span class="lineCov">          1 :         pszOr = strcasestr(pszExpression, &quot;OR(&quot;);</span>
<span class="lineNum">    4778 </span>            :     }
<span class="lineNum">    4779 </span>            : 
<span class="lineNum">    4780 </span><span class="lineCov">          1 :     if (pszOr)</span>
<span class="lineNum">    4781 </span><span class="lineCov">          1 :       return msStrdup(pszOr+3);</span>
<span class="lineNum">    4782 </span>            :     else {
<span class="lineNum">    4783 </span><span class="lineCov">          1 :       pszNot = strcasestr(pszExpression, &quot;NOT &quot;);</span>
<span class="lineNum">    4784 </span>            : 
<span class="lineNum">    4785 </span><span class="lineCov">          1 :       if (!pszNot)</span>
<span class="lineNum">    4786 </span><span class="lineCov">          1 :         pszNot = strcasestr(pszExpression, &quot;NOT(&quot;);</span>
<span class="lineNum">    4787 </span>            : 
<span class="lineNum">    4788 </span><span class="lineCov">          1 :       if (pszNot)</span>
<span class="lineNum">    4789 </span><span class="lineCov">          1 :         return msStrdup(pszNot+4);</span>
<span class="lineNum">    4790 </span>            :     }
<span class="lineNum">    4791 </span>            :   }
<span class="lineNum">    4792 </span>            :   return NULL;
<span class="lineNum">    4793 </span>            : 
<a name="4794"><span class="lineNum">    4794 </span>            : }</a>
<span class="lineNum">    4795 </span>            : 
<span class="lineNum">    4796 </span><span class="lineCov">          1 : char *msSLDGetLeftExpressionOfOperator(char *pszExpression)</span>
<span class="lineNum">    4797 </span>            : {
<span class="lineNum">    4798 </span>            :   char *pszReturn = NULL;
<span class="lineNum">    4799 </span>            :   int nLength = 0, i =0, iReturn=0;
<span class="lineNum">    4800 </span>            : 
<span class="lineNum">    4801 </span><span class="lineCov">          1 :   if (!pszExpression || (nLength = strlen(pszExpression)) &lt;=0)</span>
<span class="lineNum">    4802 </span>            :     return NULL;
<span class="lineNum">    4803 </span>            : 
<span class="lineNum">    4804 </span><span class="lineCov">          1 :   pszReturn = (char *)malloc(sizeof(char)*(nLength+1));</span>
<span class="lineNum">    4805 </span><span class="lineCov">          1 :   pszReturn[0] = '\0';</span>
<span class="lineNum">    4806 </span><span class="lineCov">          1 :   if (strcasestr(pszExpression, &quot; AND &quot;)) {</span>
<span class="lineNum">    4807 </span><span class="lineCov">          1 :     for (i=0; i&lt;nLength-5; i++) {</span>
<span class="lineNum">    4808 </span><span class="lineCov">          1 :       if (pszExpression[i] == ' ' &amp;&amp;</span>
<span class="lineNum">    4809 </span><span class="lineCov">          1 :           (toupper(pszExpression[i+1]) == 'A') &amp;&amp;</span>
<span class="lineNum">    4810 </span><span class="lineCov">          1 :           (toupper(pszExpression[i+2]) == 'N') &amp;&amp;</span>
<span class="lineNum">    4811 </span><span class="lineCov">          1 :           (toupper(pszExpression[i+3]) == 'D') &amp;&amp;</span>
<span class="lineNum">    4812 </span><span class="lineCov">          1 :           (pszExpression[i+4] == ' '))</span>
<span class="lineNum">    4813 </span>            :         break;
<span class="lineNum">    4814 </span>            :       else {
<span class="lineNum">    4815 </span><span class="lineCov">          1 :         pszReturn[iReturn++] = pszExpression[i];</span>
<span class="lineNum">    4816 </span>            :       }
<span class="lineNum">    4817 </span><span class="lineCov">          1 :       pszReturn[iReturn] = '\0';</span>
<span class="lineNum">    4818 </span>            :     }
<span class="lineNum">    4819 </span><span class="lineCov">          1 :   } else if (strcasestr(pszExpression, &quot;AND(&quot;)) {</span>
<span class="lineNum">    4820 </span><span class="lineCov">          1 :     for (i=0; i&lt;nLength-4; i++) {</span>
<span class="lineNum">    4821 </span><span class="lineCov">          1 :       if ((toupper(pszExpression[i]) == 'A') &amp;&amp;</span>
<span class="lineNum">    4822 </span><span class="lineCov">          1 :           (toupper(pszExpression[i+1]) == 'N') &amp;&amp;</span>
<span class="lineNum">    4823 </span><span class="lineCov">          1 :           (toupper(pszExpression[i+2]) == 'D') &amp;&amp;</span>
<span class="lineNum">    4824 </span><span class="lineCov">          1 :           (pszExpression[i+3] == '('))</span>
<span class="lineNum">    4825 </span>            :         break;
<span class="lineNum">    4826 </span>            :       else {
<span class="lineNum">    4827 </span><span class="lineCov">          1 :         pszReturn[iReturn++] = pszExpression[i];</span>
<span class="lineNum">    4828 </span>            :       }
<span class="lineNum">    4829 </span><span class="lineCov">          1 :       pszReturn[iReturn] = '\0';</span>
<span class="lineNum">    4830 </span>            :     }
<span class="lineNum">    4831 </span><span class="lineCov">          1 :   } else if (strcasestr(pszExpression, &quot; OR &quot;)) {</span>
<span class="lineNum">    4832 </span><span class="lineCov">          1 :     for (i=0; i&lt;nLength-4; i++) {</span>
<span class="lineNum">    4833 </span><span class="lineCov">          1 :       if (pszExpression[i] == ' ' &amp;&amp;</span>
<span class="lineNum">    4834 </span><span class="lineCov">          1 :           (toupper(pszExpression[i+1]) == 'O') &amp;&amp;</span>
<span class="lineNum">    4835 </span><span class="lineCov">          1 :           (toupper(pszExpression[i+2]) == 'R') &amp;&amp;</span>
<span class="lineNum">    4836 </span><span class="lineCov">          1 :           pszExpression[i+3] == ' ')</span>
<span class="lineNum">    4837 </span>            :         break;
<span class="lineNum">    4838 </span>            :       else {
<span class="lineNum">    4839 </span><span class="lineCov">          1 :         pszReturn[iReturn++] = pszExpression[i];</span>
<span class="lineNum">    4840 </span>            :       }
<span class="lineNum">    4841 </span><span class="lineCov">          1 :       pszReturn[iReturn] = '\0';</span>
<span class="lineNum">    4842 </span>            :     }
<span class="lineNum">    4843 </span><span class="lineCov">          1 :   } else if (strcasestr(pszExpression, &quot;OR(&quot;)) {</span>
<span class="lineNum">    4844 </span><span class="lineCov">          1 :     for (i=0; i&lt;nLength-3; i++) {</span>
<span class="lineNum">    4845 </span><span class="lineCov">          1 :       if ((toupper(pszExpression[i]) == 'O') &amp;&amp;</span>
<span class="lineNum">    4846 </span><span class="lineCov">          1 :           (toupper(pszExpression[i+1]) == 'R') &amp;&amp;</span>
<span class="lineNum">    4847 </span><span class="lineCov">          1 :           pszExpression[i+2] == '(')</span>
<span class="lineNum">    4848 </span>            :         break;
<span class="lineNum">    4849 </span>            :       else {
<span class="lineNum">    4850 </span><span class="lineCov">          1 :         pszReturn[iReturn++] = pszExpression[i];</span>
<span class="lineNum">    4851 </span>            :       }
<span class="lineNum">    4852 </span><span class="lineCov">          1 :       pszReturn[iReturn] = '\0';</span>
<span class="lineNum">    4853 </span>            :     }
<span class="lineNum">    4854 </span>            :   } else {
<span class="lineNum">    4855 </span><span class="lineCov">          1 :     msFree(pszReturn);</span>
<span class="lineNum">    4856 </span><span class="lineCov">          1 :     return NULL;</span>
<span class="lineNum">    4857 </span>            :   }
<span class="lineNum">    4858 </span>            : 
<span class="lineNum">    4859 </span>            :   return pszReturn;
<span class="lineNum">    4860 </span>            : }
<a name="4861"><span class="lineNum">    4861 </span>            : </a>
<span class="lineNum">    4862 </span>            : 
<span class="lineNum">    4863 </span><span class="lineCov">          1 : int msSLDNumberOfLogicalOperators(char *pszExpression)</span>
<span class="lineNum">    4864 </span>            : {
<span class="lineNum">    4865 </span>            :   char *pszAnd = NULL;
<span class="lineNum">    4866 </span>            :   char *pszOr = NULL;
<span class="lineNum">    4867 </span>            :   char *pszNot = NULL;
<span class="lineNum">    4868 </span>            :   char *pszSecondAnd=NULL, *pszSecondOr=NULL;
<span class="lineNum">    4869 </span><span class="lineCov">          1 :   if (!pszExpression)</span>
<span class="lineNum">    4870 </span>            :     return 0;
<span class="lineNum">    4871 </span>            : 
<span class="lineNum">    4872 </span>            :   /* -------------------------------------------------------------------- */
<span class="lineNum">    4873 </span>            :   /*      tests here are minimal to be able to parse simple expression    */
<span class="lineNum">    4874 </span>            :   /*      like A AND B, A OR B, NOT A.                                    */
<span class="lineNum">    4875 </span>            :   /* -------------------------------------------------------------------- */
<span class="lineNum">    4876 </span><span class="lineCov">          1 :   pszAnd = strcasestr(pszExpression, &quot; AND &quot;);</span>
<span class="lineNum">    4877 </span><span class="lineCov">          1 :   pszOr = strcasestr(pszExpression, &quot; OR &quot;);</span>
<span class="lineNum">    4878 </span><span class="lineCov">          1 :   pszNot = strcasestr(pszExpression, &quot;NOT &quot;);</span>
<span class="lineNum">    4879 </span>            : 
<span class="lineNum">    4880 </span><span class="lineCov">          1 :   if (!pszAnd &amp;&amp; !pszOr) {</span>
<span class="lineNum">    4881 </span><span class="lineCov">          1 :     pszAnd = strcasestr(pszExpression, &quot;AND(&quot;);</span>
<span class="lineNum">    4882 </span><span class="lineCov">          1 :     pszOr = strcasestr(pszExpression, &quot;OR(&quot;);</span>
<span class="lineNum">    4883 </span>            :   }
<span class="lineNum">    4884 </span>            : 
<span class="lineNum">    4885 </span><span class="lineCov">          1 :   if (!pszNot) {</span>
<span class="lineNum">    4886 </span><span class="lineCov">          1 :     pszNot = strcasestr(pszExpression, &quot;NOT(&quot;);</span>
<span class="lineNum">    4887 </span>            :   }
<span class="lineNum">    4888 </span>            : 
<span class="lineNum">    4889 </span><span class="lineCov">          1 :   if (!pszAnd &amp;&amp; !pszOr &amp;&amp; !pszNot)</span>
<span class="lineNum">    4890 </span>            :     return 0;
<span class="lineNum">    4891 </span>            : 
<span class="lineNum">    4892 </span>            :   /* doen not matter how many exactly if there are 2 or more */
<span class="lineNum">    4893 </span><span class="lineCov">          1 :   if ((pszAnd &amp;&amp; pszOr) || (pszAnd &amp;&amp; pszNot) || (pszOr &amp;&amp; pszNot))</span>
<span class="lineNum">    4894 </span>            :     return 2;
<span class="lineNum">    4895 </span>            : 
<span class="lineNum">    4896 </span><span class="lineCov">          1 :   if (pszAnd) {</span>
<span class="lineNum">    4897 </span><span class="lineCov">          1 :     pszSecondAnd = strcasestr(pszAnd+3, &quot; AND &quot;);</span>
<span class="lineNum">    4898 </span><span class="lineCov">          1 :     pszSecondOr = strcasestr(pszAnd+3, &quot; OR &quot;);</span>
<span class="lineNum">    4899 </span><span class="lineCov">          1 :   } else if (pszOr) {</span>
<span class="lineNum">    4900 </span><span class="lineCov">          1 :     pszSecondAnd = strcasestr(pszOr+2, &quot; AND &quot;);</span>
<span class="lineNum">    4901 </span><span class="lineCov">          1 :     pszSecondOr = strcasestr(pszOr+2, &quot; OR &quot;);</span>
<span class="lineNum">    4902 </span>            :   }
<span class="lineNum">    4903 </span>            : 
<span class="lineNum">    4904 </span><span class="lineCov">          1 :   if (!pszSecondAnd &amp;&amp; !pszSecondOr)</span>
<span class="lineNum">    4905 </span>            :     return 1;
<span class="lineNum">    4906 </span>            :   else
<span class="lineNum">    4907 </span><span class="lineNoCov">          0 :     return 2;</span>
<span class="lineNum">    4908 </span>            : }
<a name="4909"><span class="lineNum">    4909 </span>            : </a>
<span class="lineNum">    4910 </span>            : 
<span class="lineNum">    4911 </span><span class="lineCov">          1 : char *msSLDGetAttributeNameOrValue(char *pszExpression,</span>
<span class="lineNum">    4912 </span>            :                                    char *pszComparionValue,
<span class="lineNum">    4913 </span>            :                                    int bReturnName)
<span class="lineNum">    4914 </span>            : {
<span class="lineNum">    4915 </span>            :   char **aszValues = NULL;
<span class="lineNum">    4916 </span>            :   char *pszAttributeName = NULL;
<span class="lineNum">    4917 </span>            :   char *pszAttributeValue = NULL;
<span class="lineNum">    4918 </span>            :   char cCompare = '=';
<span class="lineNum">    4919 </span>            :   char szCompare[3] = {0};
<span class="lineNum">    4920 </span>            :   char szCompare2[3] = {0};
<span class="lineNum">    4921 </span><span class="lineCov">          1 :   int bOneCharCompare = -1, nTokens = 0, nLength =0;</span>
<span class="lineNum">    4922 </span>            :   int iValue=0, i=0, iValueIndex =0;
<span class="lineNum">    4923 </span>            :   int bStartCopy=0, iAtt=0;
<span class="lineNum">    4924 </span>            :   char *pszFinalAttributeName=NULL, *pszFinalAttributeValue=NULL;
<span class="lineNum">    4925 </span>            :   int bSingleQuote = 0, bDoubleQuote = 0;
<span class="lineNum">    4926 </span>            : 
<span class="lineNum">    4927 </span><span class="lineCov">          1 :   if (!pszExpression || !pszComparionValue || strlen(pszExpression) &lt;=0)</span>
<span class="lineNum">    4928 </span>            :     return NULL;
<span class="lineNum">    4929 </span>            : 
<span class="lineNum">    4930 </span>            :   szCompare[0] = '\0';
<span class="lineNum">    4931 </span>            :   szCompare2[0] = '\0';
<span class="lineNum">    4932 </span>            : 
<span class="lineNum">    4933 </span>            : 
<span class="lineNum">    4934 </span><span class="lineCov">          1 :   if (strcasecmp(pszComparionValue, &quot;PropertyIsEqualTo&quot;) == 0) {</span>
<span class="lineNum">    4935 </span>            :     cCompare = '=';
<span class="lineNum">    4936 </span>            :     szCompare[0] = 'e';
<span class="lineNum">    4937 </span>            :     szCompare[1] = 'q';
<span class="lineNum">    4938 </span>            :     szCompare[2] = '\0';
<span class="lineNum">    4939 </span>            : 
<span class="lineNum">    4940 </span>            :     bOneCharCompare =1;
<span class="lineNum">    4941 </span>            :   }
<span class="lineNum">    4942 </span><span class="lineCov">          1 :   if (strcasecmp(pszComparionValue, &quot;PropertyIsNotEqualTo&quot;) == 0) {</span>
<span class="lineNum">    4943 </span>            :     szCompare[0] = 'n';
<span class="lineNum">    4944 </span>            :     szCompare[1] = 'e';
<span class="lineNum">    4945 </span>            :     szCompare[2] = '\0';
<span class="lineNum">    4946 </span>            : 
<span class="lineNum">    4947 </span>            :     szCompare2[0] = '!';
<span class="lineNum">    4948 </span>            :     szCompare2[1] = '=';
<span class="lineNum">    4949 </span>            :     szCompare2[2] = '\0';
<span class="lineNum">    4950 </span>            : 
<span class="lineNum">    4951 </span>            :     bOneCharCompare =0;
<span class="lineNum">    4952 </span><span class="lineCov">          1 :   } else if (strcasecmp(pszComparionValue, &quot;PropertyIsLike&quot;) == 0) {</span>
<span class="lineNum">    4953 </span>            :     szCompare[0] = '=';
<span class="lineNum">    4954 </span>            :     szCompare[1] = '~';
<span class="lineNum">    4955 </span>            :     szCompare[2] = '\0';
<span class="lineNum">    4956 </span>            : 
<span class="lineNum">    4957 </span>            :     szCompare2[0] = '~';
<span class="lineNum">    4958 </span>            :     szCompare2[1] = '*';
<span class="lineNum">    4959 </span>            :     szCompare2[2] = '\0';
<span class="lineNum">    4960 </span>            : 
<span class="lineNum">    4961 </span>            :     bOneCharCompare =0;
<span class="lineNum">    4962 </span><span class="lineCov">          1 :   } else if (strcasecmp(pszComparionValue, &quot;PropertyIsLessThan&quot;) == 0) {</span>
<span class="lineNum">    4963 </span>            :     cCompare = '&lt;';
<span class="lineNum">    4964 </span>            :     szCompare[0] = 'l';
<span class="lineNum">    4965 </span>            :     szCompare[1] = 't';
<span class="lineNum">    4966 </span>            :     szCompare[2] = '\0';
<span class="lineNum">    4967 </span>            :     bOneCharCompare =1;
<span class="lineNum">    4968 </span><span class="lineCov">          1 :   } else if (strcasecmp(pszComparionValue, &quot;PropertyIsLessThanOrEqualTo&quot;) == 0) {</span>
<span class="lineNum">    4969 </span>            :     szCompare[0] = 'l';
<span class="lineNum">    4970 </span>            :     szCompare[1] = 'e';
<span class="lineNum">    4971 </span>            :     szCompare[2] = '\0';
<span class="lineNum">    4972 </span>            : 
<span class="lineNum">    4973 </span>            :     szCompare2[0] = '&lt;';
<span class="lineNum">    4974 </span>            :     szCompare2[1] = '=';
<span class="lineNum">    4975 </span>            :     szCompare2[2] = '\0';
<span class="lineNum">    4976 </span>            : 
<span class="lineNum">    4977 </span>            :     bOneCharCompare =0;
<span class="lineNum">    4978 </span><span class="lineCov">          1 :   } else if (strcasecmp(pszComparionValue, &quot;PropertyIsGreaterThan&quot;) == 0) {</span>
<span class="lineNum">    4979 </span>            :     cCompare = '&gt;';
<span class="lineNum">    4980 </span>            :     szCompare[0] = 'g';
<span class="lineNum">    4981 </span>            :     szCompare[1] = 't';
<span class="lineNum">    4982 </span>            :     szCompare[2] = '\0';
<span class="lineNum">    4983 </span>            :     bOneCharCompare =1;
<span class="lineNum">    4984 </span><span class="lineCov">          1 :   } else if (strcasecmp(pszComparionValue, &quot;PropertyIsGreaterThanOrEqualTo&quot;) == 0) {</span>
<span class="lineNum">    4985 </span>            :     szCompare[0] = 'g';
<span class="lineNum">    4986 </span>            :     szCompare[1] = 'e';
<span class="lineNum">    4987 </span>            :     szCompare[2] = '\0';
<span class="lineNum">    4988 </span>            : 
<span class="lineNum">    4989 </span>            :     szCompare2[0] = '&gt;';
<span class="lineNum">    4990 </span>            :     szCompare2[1] = '=';
<span class="lineNum">    4991 </span>            :     szCompare2[2] = '\0';
<span class="lineNum">    4992 </span>            : 
<span class="lineNum">    4993 </span>            :     bOneCharCompare =0;
<span class="lineNum">    4994 </span>            :   }
<span class="lineNum">    4995 </span>            : 
<span class="lineNum">    4996 </span><span class="lineCov">          1 :   if (bOneCharCompare == 1) {</span>
<span class="lineNum">    4997 </span><span class="lineCov">          1 :     aszValues= msStringSplit (pszExpression, cCompare, &amp;nTokens);</span>
<span class="lineNum">    4998 </span><span class="lineCov">          1 :     if (nTokens &gt; 1) {</span>
<span class="lineNum">    4999 </span><span class="lineCov">          1 :       pszAttributeName = msStrdup(aszValues[0]);</span>
<span class="lineNum">    5000 </span><span class="lineCov">          1 :       pszAttributeValue =  msStrdup(aszValues[1]);</span>
<span class="lineNum">    5001 </span>            :     } else {
<span class="lineNum">    5002 </span><span class="lineNoCov">          0 :       nLength = strlen(pszExpression);</span>
<span class="lineNum">    5003 </span><span class="lineNoCov">          0 :       pszAttributeName = (char *)malloc(sizeof(char)*(nLength+1));</span>
<span class="lineNum">    5004 </span>            :       iValue = 0;
<span class="lineNum">    5005 </span><span class="lineNoCov">          0 :       for (i=0; i&lt;nLength-2; i++) {</span>
<span class="lineNum">    5006 </span><span class="lineNoCov">          0 :         if (pszExpression[i] != szCompare[0] &amp;&amp;</span>
<span class="lineNum">    5007 </span><span class="lineNoCov">          0 :             pszExpression[i] != toupper(szCompare[0])) {</span>
<span class="lineNum">    5008 </span><span class="lineNoCov">          0 :           pszAttributeName[iValue++] = pszExpression[i];</span>
<span class="lineNum">    5009 </span>            :         } else {
<span class="lineNum">    5010 </span><span class="lineNoCov">          0 :           if ((pszExpression[i+1] == szCompare[1] ||</span>
<span class="lineNum">    5011 </span><span class="lineNoCov">          0 :                pszExpression[i+1] == toupper(szCompare[1])) &amp;&amp;</span>
<span class="lineNum">    5012 </span><span class="lineNoCov">          0 :               (pszExpression[i+2] == ' ')) {</span>
<span class="lineNum">    5013 </span><span class="lineNoCov">          0 :             iValueIndex = i+3;</span>
<span class="lineNum">    5014 </span><span class="lineNoCov">          0 :             pszAttributeValue = msStrdup(pszExpression+iValueIndex);</span>
<span class="lineNum">    5015 </span><span class="lineNoCov">          0 :             break;</span>
<span class="lineNum">    5016 </span>            :           } else
<span class="lineNum">    5017 </span><span class="lineNoCov">          0 :             pszAttributeName[iValue++] = pszExpression[i];</span>
<span class="lineNum">    5018 </span>            :         }
<span class="lineNum">    5019 </span><span class="lineNoCov">          0 :         pszAttributeName[iValue] = '\0';</span>
<span class="lineNum">    5020 </span>            :       }
<span class="lineNum">    5021 </span>            :     }
<span class="lineNum">    5022 </span><span class="lineCov">          1 :     msFreeCharArray(aszValues, nTokens);</span>
<span class="lineNum">    5023 </span><span class="lineCov">          1 :   } else if (bOneCharCompare == 0) {</span>
<span class="lineNum">    5024 </span><span class="lineCov">          1 :     nLength = strlen(pszExpression);</span>
<span class="lineNum">    5025 </span><span class="lineCov">          1 :     pszAttributeName = (char *)malloc(sizeof(char)*(nLength+1));</span>
<span class="lineNum">    5026 </span>            :     iValue = 0;
<span class="lineNum">    5027 </span><span class="lineCov">          1 :     for (i=0; i&lt;nLength-2; i++) {</span>
<span class="lineNum">    5028 </span><span class="lineCov">          1 :       if ((pszExpression[i] != szCompare[0] ||</span>
<span class="lineNum">    5029 </span><span class="lineCov">          1 :            pszExpression[i] != toupper(szCompare[0])) &amp;&amp;</span>
<span class="lineNum">    5030 </span><span class="lineCov">          1 :           (pszExpression[i] != szCompare2[0] ||</span>
<span class="lineNum">    5031 </span><span class="lineCov">          1 :            pszExpression[i] != toupper(szCompare2[0])))</span>
<span class="lineNum">    5032 </span>            : 
<span class="lineNum">    5033 </span>            :       {
<span class="lineNum">    5034 </span><span class="lineCov">          1 :         pszAttributeName[iValue++] = pszExpression[i];</span>
<span class="lineNum">    5035 </span>            :       } else {
<span class="lineNum">    5036 </span><span class="lineCov">          1 :         if (((pszExpression[i+1] == szCompare[1] ||</span>
<span class="lineNum">    5037 </span><span class="lineCov">          1 :               pszExpression[i+1] == toupper(szCompare[1])) ||</span>
<span class="lineNum">    5038 </span><span class="lineNoCov">          0 :              (pszExpression[i+1] == szCompare2[1] ||</span>
<span class="lineNum">    5039 </span><span class="lineCov">          1 :               pszExpression[i+1] == toupper(szCompare2[1]))) &amp;&amp;</span>
<span class="lineNum">    5040 </span><span class="lineCov">          1 :             (pszExpression[i+2] == ' ')) {</span>
<span class="lineNum">    5041 </span><span class="lineCov">          1 :           iValueIndex = i+3;</span>
<span class="lineNum">    5042 </span><span class="lineCov">          1 :           pszAttributeValue = msStrdup(pszExpression+iValueIndex);</span>
<span class="lineNum">    5043 </span><span class="lineCov">          1 :           break;</span>
<span class="lineNum">    5044 </span>            :         } else
<span class="lineNum">    5045 </span><span class="lineNoCov">          0 :           pszAttributeName[iValue++] = pszExpression[i];</span>
<span class="lineNum">    5046 </span>            :       }
<span class="lineNum">    5047 </span><span class="lineCov">          1 :       pszAttributeName[iValue] = '\0';</span>
<span class="lineNum">    5048 </span>            :     }
<span class="lineNum">    5049 </span>            :   }
<span class="lineNum">    5050 </span>            : 
<span class="lineNum">    5051 </span>            :   /* -------------------------------------------------------------------- */
<span class="lineNum">    5052 </span>            :   /*      Return the name of the attribute : It is supposed to be         */
<span class="lineNum">    5053 </span>            :   /*      inside []                                                       */
<span class="lineNum">    5054 </span>            :   /* -------------------------------------------------------------------- */
<span class="lineNum">    5055 </span><span class="lineCov">          1 :   if (bReturnName) {</span>
<span class="lineNum">    5056 </span><span class="lineCov">          1 :     if (!pszAttributeName) {</span>
<span class="lineNum">    5057 </span><span class="lineNoCov">          0 :       msFree(pszAttributeValue);</span>
<span class="lineNum">    5058 </span><span class="lineNoCov">          0 :       return NULL;</span>
<span class="lineNum">    5059 </span>            :     }
<span class="lineNum">    5060 </span>            : 
<span class="lineNum">    5061 </span><span class="lineCov">          1 :     nLength = strlen(pszAttributeName);</span>
<span class="lineNum">    5062 </span><span class="lineCov">          1 :     pszFinalAttributeName = (char *)malloc(sizeof(char)*(nLength+1));</span>
<span class="lineNum">    5063 </span>            :     bStartCopy= 0;
<span class="lineNum">    5064 </span>            :     iAtt = 0;
<span class="lineNum">    5065 </span><span class="lineCov">          1 :     for (i=0; i&lt;nLength; i++) {</span>
<span class="lineNum">    5066 </span><span class="lineCov">          1 :       if (pszAttributeName[i] == ' ' &amp;&amp; bStartCopy == 0)</span>
<span class="lineNum">    5067 </span><span class="lineCov">          1 :         continue;</span>
<span class="lineNum">    5068 </span>            : 
<span class="lineNum">    5069 </span><span class="lineCov">          1 :       if (pszAttributeName[i] == '[') {</span>
<span class="lineNum">    5070 </span>            :         bStartCopy = 1;
<span class="lineNum">    5071 </span><span class="lineCov">          1 :         continue;</span>
<span class="lineNum">    5072 </span>            :       }
<span class="lineNum">    5073 </span><span class="lineCov">          1 :       if (pszAttributeName[i] == ']')</span>
<span class="lineNum">    5074 </span>            :         break;
<span class="lineNum">    5075 </span><span class="lineCov">          1 :       if (bStartCopy) {</span>
<span class="lineNum">    5076 </span><span class="lineCov">          1 :         pszFinalAttributeName[iAtt++] = pszAttributeName[i];</span>
<span class="lineNum">    5077 </span>            :       }
<span class="lineNum">    5078 </span><span class="lineCov">          1 :       pszFinalAttributeName[iAtt] = '\0';</span>
<span class="lineNum">    5079 </span>            :     }
<span class="lineNum">    5080 </span>            : 
<span class="lineNum">    5081 </span><span class="lineCov">          1 :     msFree(pszAttributeName);</span>
<span class="lineNum">    5082 </span><span class="lineCov">          1 :     msFree(pszAttributeValue);</span>
<span class="lineNum">    5083 </span><span class="lineCov">          1 :     return pszFinalAttributeName;</span>
<span class="lineNum">    5084 </span>            :   } else {
<span class="lineNum">    5085 </span>            : 
<span class="lineNum">    5086 </span><span class="lineCov">          1 :     if (!pszAttributeValue) {</span>
<span class="lineNum">    5087 </span><span class="lineNoCov">          0 :       msFree(pszAttributeName);</span>
<span class="lineNum">    5088 </span><span class="lineNoCov">          0 :       return NULL;</span>
<span class="lineNum">    5089 </span>            :     }
<span class="lineNum">    5090 </span><span class="lineCov">          1 :     nLength = strlen(pszAttributeValue);</span>
<span class="lineNum">    5091 </span><span class="lineCov">          1 :     pszFinalAttributeValue = (char *)malloc(sizeof(char)*(nLength+1));</span>
<span class="lineNum">    5092 </span><span class="lineCov">          1 :     pszFinalAttributeValue[0] = '\0';</span>
<span class="lineNum">    5093 </span>            :     bStartCopy= 0;
<span class="lineNum">    5094 </span>            :     iAtt = 0;
<span class="lineNum">    5095 </span><span class="lineCov">          1 :     for (i=0; i&lt;nLength; i++) {</span>
<span class="lineNum">    5096 </span><span class="lineCov">          1 :       if (pszAttributeValue[i] == ' ' &amp;&amp; bStartCopy == 0)</span>
<span class="lineNum">    5097 </span><span class="lineCov">          1 :         continue;</span>
<span class="lineNum">    5098 </span>            : 
<span class="lineNum">    5099 </span><span class="lineCov">          1 :       if (pszAttributeValue[i] == '\'' &amp;&amp; bStartCopy == 0) {</span>
<span class="lineNum">    5100 </span>            :         bSingleQuote = 1;
<span class="lineNum">    5101 </span>            :         bStartCopy = 1;
<span class="lineNum">    5102 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">    5103 </span><span class="lineCov">          1 :       } else if (pszAttributeValue[i] == '&quot;' &amp;&amp; bStartCopy == 0) {</span>
<span class="lineNum">    5104 </span>            :         bDoubleQuote = 1;
<span class="lineNum">    5105 </span>            :         bStartCopy = 1;
<span class="lineNum">    5106 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">    5107 </span>            :       } else
<span class="lineNum">    5108 </span>            :         bStartCopy =1;
<span class="lineNum">    5109 </span>            : 
<span class="lineNum">    5110 </span>            :       if (bStartCopy) {
<span class="lineNum">    5111 </span><span class="lineCov">          1 :         if (pszAttributeValue[i] == '\'' &amp;&amp; bSingleQuote)</span>
<span class="lineNum">    5112 </span>            :           break;
<span class="lineNum">    5113 </span><span class="lineCov">          1 :         else if (pszAttributeValue[i] == '&quot;' &amp;&amp; bDoubleQuote)</span>
<span class="lineNum">    5114 </span>            :           break;
<span class="lineNum">    5115 </span><span class="lineCov">          1 :         else if (pszAttributeValue[i] == ')')</span>
<span class="lineNum">    5116 </span>            :           break;
<span class="lineNum">    5117 </span><span class="lineCov">          1 :         pszFinalAttributeValue[iAtt++] = pszAttributeValue[i];</span>
<span class="lineNum">    5118 </span>            :       }
<span class="lineNum">    5119 </span><span class="lineCov">          1 :       pszFinalAttributeValue[iAtt] = '\0';</span>
<span class="lineNum">    5120 </span>            :     }
<span class="lineNum">    5121 </span>            : 
<span class="lineNum">    5122 </span>            :     /*trim  for regular expressions*/
<span class="lineNum">    5123 </span><span class="lineCov">          1 :     if (strlen(pszFinalAttributeValue) &gt; 2 &amp;&amp; strcasecmp(pszComparionValue, &quot;PropertyIsLike&quot;) == 0) {</span>
<span class="lineNum">    5124 </span><span class="lineNoCov">          0 :       int len = strlen(pszFinalAttributeValue);</span>
<span class="lineNum">    5125 </span><span class="lineNoCov">          0 :       msStringTrimBlanks(pszFinalAttributeValue);</span>
<span class="lineNum">    5126 </span><span class="lineNoCov">          0 :       if (pszFinalAttributeValue[0] == '/' &amp;&amp;</span>
<span class="lineNum">    5127 </span><span class="lineNoCov">          0 :           (pszFinalAttributeValue[len-1] == '/' ||</span>
<span class="lineNum">    5128 </span><span class="lineNoCov">          0 :            (pszFinalAttributeValue[len-1] == 'i' &amp;&amp;</span>
<span class="lineNum">    5129 </span><span class="lineNoCov">          0 :             pszFinalAttributeValue[len-2] == '/'))) {</span>
<span class="lineNum">    5130 </span><span class="lineNoCov">          0 :         if (pszFinalAttributeValue[len-1] == '/')</span>
<span class="lineNum">    5131 </span><span class="lineNoCov">          0 :           pszFinalAttributeValue[len-1] = '\0';</span>
<span class="lineNum">    5132 </span>            :         else
<span class="lineNum">    5133 </span><span class="lineNoCov">          0 :           pszFinalAttributeValue[len-2] = '\0';</span>
<span class="lineNum">    5134 </span>            : 
<span class="lineNum">    5135 </span><span class="lineNoCov">          0 :         memmove(pszFinalAttributeValue, pszFinalAttributeValue +</span>
<span class="lineNum">    5136 </span><span class="lineNoCov">          0 :                 ((pszFinalAttributeValue[1] == '^') ? 2 : 1), len-1);</span>
<span class="lineNum">    5137 </span>            : 
<span class="lineNum">    5138 </span>            :         /*replace wild card string .* with * */
<span class="lineNum">    5139 </span><span class="lineNoCov">          0 :         pszFinalAttributeValue = msReplaceSubstring(pszFinalAttributeValue, &quot;.*&quot;, &quot;*&quot;);</span>
<span class="lineNum">    5140 </span>            :       }
<span class="lineNum">    5141 </span>            :     }
<span class="lineNum">    5142 </span><span class="lineCov">          1 :     msFree(pszAttributeName);</span>
<span class="lineNum">    5143 </span><span class="lineCov">          1 :     msFree(pszAttributeValue);</span>
<span class="lineNum">    5144 </span><span class="lineCov">          1 :     return pszFinalAttributeValue;</span>
<span class="lineNum">    5145 </span>            :   }
<span class="lineNum">    5146 </span>            : }
<a name="5147"><span class="lineNum">    5147 </span>            : </a>
<span class="lineNum">    5148 </span>            : 
<span class="lineNum">    5149 </span><span class="lineCov">          1 : char *msSLDGetAttributeName(char *pszExpression,</span>
<span class="lineNum">    5150 </span>            :                             char *pszComparionValue)
<span class="lineNum">    5151 </span>            : {
<span class="lineNum">    5152 </span><span class="lineCov">          1 :   return msSLDGetAttributeNameOrValue(pszExpression, pszComparionValue, 1);</span>
<a name="5153"><span class="lineNum">    5153 </span>            : }</a>
<span class="lineNum">    5154 </span>            : 
<span class="lineNum">    5155 </span><span class="lineCov">          1 : char *msSLDGetAttributeValue(char *pszExpression,</span>
<span class="lineNum">    5156 </span>            :                              char *pszComparionValue)
<span class="lineNum">    5157 </span>            : {
<span class="lineNum">    5158 </span><span class="lineCov">          1 :   return msSLDGetAttributeNameOrValue(pszExpression, pszComparionValue, 0);</span>
<span class="lineNum">    5159 </span>            : }
<span class="lineNum">    5160 </span>            : 
<span class="lineNum">    5161 </span>            : 
<span class="lineNum">    5162 </span>            : 
<span class="lineNum">    5163 </span>            : /************************************************************************/
<span class="lineNum">    5164 </span>            : /*                           BuildExpressionTree                        */
<span class="lineNum">    5165 </span>            : /*                                                                      */
<span class="lineNum">    5166 </span>            : /*      Build a filter expression node based on mapserver's class       */
<span class="lineNum">    5167 </span>            : /*      expression. This is limited to simple expressions like :        */
<span class="lineNum">    5168 </span>            : /*        A = B, A &lt; B, A &lt;= B, A &gt; B, A &gt;= B, A != B                   */
<span class="lineNum">    5169 </span>            : /*       It also handles one level of logical expressions :             */
<span class="lineNum">    5170 </span>            : /*        A AND B                                                       */
<span class="lineNum">    5171 </span>            : /*        A OR B                                                        */
<a name="5172"><span class="lineNum">    5172 </span>            : /*        NOT A                                                         */</a>
<span class="lineNum">    5173 </span>            : /************************************************************************/
<span class="lineNum">    5174 </span><span class="lineCov">          1 : FilterEncodingNode *BuildExpressionTree(char *pszExpression,</span>
<span class="lineNum">    5175 </span>            :                                         FilterEncodingNode *psNode)
<span class="lineNum">    5176 </span>            : {
<span class="lineNum">    5177 </span>            :   int nLength = 0;
<span class="lineNum">    5178 </span>            :   int nOperators=0;
<span class="lineNum">    5179 </span>            :   char *pszComparionValue=NULL, *pszAttibuteName=NULL;
<span class="lineNum">    5180 </span>            :   char *pszAttibuteValue=NULL;
<span class="lineNum">    5181 </span>            :   char *pszLeftExpression=NULL, *pszRightExpression=NULL, *pszOperator=NULL;
<span class="lineNum">    5182 </span>            : 
<span class="lineNum">    5183 </span><span class="lineCov">          1 :   if (!pszExpression || (nLength = strlen(pszExpression)) &lt;=0)</span>
<span class="lineNum">    5184 </span>            :     return NULL;
<span class="lineNum">    5185 </span>            : 
<span class="lineNum">    5186 </span>            :   /* -------------------------------------------------------------------- */
<span class="lineNum">    5187 </span>            :   /*      First we check how many logical operators are there :           */
<span class="lineNum">    5188 </span>            :   /*       - if none : It means It is a comparison operator (like =,      */
<span class="lineNum">    5189 </span>            :   /*      &gt;, &gt;= .... We get the comparison value as well as the           */
<span class="lineNum">    5190 </span>            :   /*      attribute and the attribute's value and assign it to the node   */
<span class="lineNum">    5191 </span>            :   /*      passed in argument.                                             */
<span class="lineNum">    5192 </span>            :   /*       - if there is one operator, we assign the operator to the      */
<span class="lineNum">    5193 </span>            :   /*      node and adds the expressions into the left and right nodes.    */
<span class="lineNum">    5194 </span>            :   /* -------------------------------------------------------------------- */
<span class="lineNum">    5195 </span><span class="lineCov">          1 :   nOperators = msSLDNumberOfLogicalOperators(pszExpression);</span>
<span class="lineNum">    5196 </span><span class="lineCov">          1 :   if (nOperators == 0) {</span>
<span class="lineNum">    5197 </span><span class="lineCov">          1 :     if (!psNode)</span>
<span class="lineNum">    5198 </span><span class="lineCov">          1 :       psNode = FLTCreateFilterEncodingNode();</span>
<span class="lineNum">    5199 </span>            : 
<span class="lineNum">    5200 </span><span class="lineCov">          1 :     pszComparionValue = msSLDGetComparisonValue(pszExpression);</span>
<span class="lineNum">    5201 </span><span class="lineCov">          1 :     pszAttibuteName = msSLDGetAttributeName(pszExpression, pszComparionValue);</span>
<span class="lineNum">    5202 </span><span class="lineCov">          1 :     pszAttibuteValue = msSLDGetAttributeValue(pszExpression, pszComparionValue);</span>
<span class="lineNum">    5203 </span><span class="lineCov">          1 :     if (pszComparionValue &amp;&amp; pszAttibuteName &amp;&amp; pszAttibuteValue) {</span>
<span class="lineNum">    5204 </span><span class="lineCov">          1 :       psNode-&gt;eType = FILTER_NODE_TYPE_COMPARISON;</span>
<span class="lineNum">    5205 </span><span class="lineCov">          1 :       psNode-&gt;pszValue = msStrdup(pszComparionValue);</span>
<span class="lineNum">    5206 </span>            : 
<span class="lineNum">    5207 </span><span class="lineCov">          1 :       psNode-&gt;psLeftNode = FLTCreateFilterEncodingNode();</span>
<span class="lineNum">    5208 </span><span class="lineCov">          1 :       psNode-&gt;psLeftNode-&gt;eType = FILTER_NODE_TYPE_PROPERTYNAME;</span>
<span class="lineNum">    5209 </span><span class="lineCov">          1 :       psNode-&gt;psLeftNode-&gt;pszValue = msStrdup(pszAttibuteName);</span>
<span class="lineNum">    5210 </span>            : 
<span class="lineNum">    5211 </span><span class="lineCov">          1 :       psNode-&gt;psRightNode = FLTCreateFilterEncodingNode();</span>
<span class="lineNum">    5212 </span><span class="lineCov">          1 :       psNode-&gt;psRightNode-&gt;eType = FILTER_NODE_TYPE_LITERAL;</span>
<span class="lineNum">    5213 </span><span class="lineCov">          1 :       psNode-&gt;psRightNode-&gt;pszValue = msStrdup(pszAttibuteValue);</span>
<span class="lineNum">    5214 </span>            : 
<span class="lineNum">    5215 </span><span class="lineCov">          1 :       if (strcasecmp(pszComparionValue, &quot;PropertyIsLike&quot;) == 0) {</span>
<span class="lineNum">    5216 </span><span class="lineNoCov">          0 :         psNode-&gt;pOther = (FEPropertyIsLike *)malloc(sizeof(FEPropertyIsLike));</span>
<span class="lineNum">    5217 </span><span class="lineNoCov">          0 :         ((FEPropertyIsLike *)psNode-&gt;pOther)-&gt;bCaseInsensitive = 0;</span>
<span class="lineNum">    5218 </span><span class="lineNoCov">          0 :         ((FEPropertyIsLike *)psNode-&gt;pOther)-&gt;pszWildCard = msStrdup(&quot;*&quot;);</span>
<span class="lineNum">    5219 </span><span class="lineNoCov">          0 :         ((FEPropertyIsLike *)psNode-&gt;pOther)-&gt;pszSingleChar = msStrdup(&quot;#&quot;);</span>
<span class="lineNum">    5220 </span><span class="lineNoCov">          0 :         ((FEPropertyIsLike *)psNode-&gt;pOther)-&gt;pszEscapeChar = msStrdup(&quot;!&quot;);</span>
<span class="lineNum">    5221 </span>            :       }
<span class="lineNum">    5222 </span><span class="lineCov">          1 :       free(pszComparionValue);</span>
<span class="lineNum">    5223 </span><span class="lineCov">          1 :       free(pszAttibuteName);</span>
<span class="lineNum">    5224 </span><span class="lineCov">          1 :       free(pszAttibuteValue);</span>
<span class="lineNum">    5225 </span>            :     }
<span class="lineNum">    5226 </span>            :     return psNode;
<span class="lineNum">    5227 </span>            : 
<span class="lineNum">    5228 </span><span class="lineCov">          1 :   } else if (nOperators == 1) {</span>
<span class="lineNum">    5229 </span><span class="lineCov">          1 :     pszOperator = msSLDGetLogicalOperator(pszExpression);</span>
<span class="lineNum">    5230 </span><span class="lineCov">          1 :     if (pszOperator) {</span>
<span class="lineNum">    5231 </span><span class="lineCov">          1 :       if (!psNode)</span>
<span class="lineNum">    5232 </span><span class="lineCov">          1 :         psNode = FLTCreateFilterEncodingNode();</span>
<span class="lineNum">    5233 </span>            : 
<span class="lineNum">    5234 </span><span class="lineCov">          1 :       psNode-&gt;eType = FILTER_NODE_TYPE_LOGICAL;</span>
<span class="lineNum">    5235 </span><span class="lineCov">          1 :       psNode-&gt;pszValue = msStrdup(pszOperator);</span>
<span class="lineNum">    5236 </span><span class="lineCov">          1 :       free(pszOperator);</span>
<span class="lineNum">    5237 </span>            : 
<span class="lineNum">    5238 </span><span class="lineCov">          1 :       pszLeftExpression = msSLDGetLeftExpressionOfOperator(pszExpression);</span>
<span class="lineNum">    5239 </span><span class="lineCov">          1 :       pszRightExpression = msSLDGetRightExpressionOfOperator(pszExpression);</span>
<span class="lineNum">    5240 </span>            : 
<span class="lineNum">    5241 </span><span class="lineCov">          1 :       if (pszLeftExpression || pszRightExpression) {</span>
<span class="lineNum">    5242 </span><span class="lineCov">          1 :         if (pszLeftExpression) {</span>
<span class="lineNum">    5243 </span><span class="lineCov">          1 :           pszComparionValue = msSLDGetComparisonValue(pszLeftExpression);</span>
<span class="lineNum">    5244 </span><span class="lineCov">          1 :           pszAttibuteName = msSLDGetAttributeName(pszLeftExpression,</span>
<span class="lineNum">    5245 </span>            :                                                   pszComparionValue);
<span class="lineNum">    5246 </span><span class="lineCov">          1 :           pszAttibuteValue = msSLDGetAttributeValue(pszLeftExpression,</span>
<span class="lineNum">    5247 </span>            :                              pszComparionValue);
<span class="lineNum">    5248 </span>            : 
<span class="lineNum">    5249 </span><span class="lineCov">          1 :           if (pszComparionValue &amp;&amp; pszAttibuteName &amp;&amp; pszAttibuteValue) {</span>
<span class="lineNum">    5250 </span><span class="lineCov">          1 :             psNode-&gt;psLeftNode = FLTCreateFilterEncodingNode();</span>
<span class="lineNum">    5251 </span><span class="lineCov">          1 :             psNode-&gt;psLeftNode-&gt;eType = FILTER_NODE_TYPE_COMPARISON;</span>
<span class="lineNum">    5252 </span><span class="lineCov">          1 :             psNode-&gt;psLeftNode-&gt;pszValue = msStrdup(pszComparionValue);</span>
<span class="lineNum">    5253 </span>            : 
<span class="lineNum">    5254 </span><span class="lineCov">          1 :             psNode-&gt;psLeftNode-&gt;psLeftNode = FLTCreateFilterEncodingNode();</span>
<span class="lineNum">    5255 </span><span class="lineCov">          1 :             psNode-&gt;psLeftNode-&gt;psLeftNode-&gt;eType =</span>
<span class="lineNum">    5256 </span>            :               FILTER_NODE_TYPE_PROPERTYNAME;
<span class="lineNum">    5257 </span><span class="lineCov">          1 :             psNode-&gt;psLeftNode-&gt;psLeftNode-&gt;pszValue = msStrdup(pszAttibuteName);</span>
<span class="lineNum">    5258 </span>            : 
<span class="lineNum">    5259 </span><span class="lineCov">          1 :             psNode-&gt;psLeftNode-&gt;psRightNode = FLTCreateFilterEncodingNode();</span>
<span class="lineNum">    5260 </span><span class="lineCov">          1 :             psNode-&gt;psLeftNode-&gt;psRightNode-&gt;eType =</span>
<span class="lineNum">    5261 </span>            :               FILTER_NODE_TYPE_LITERAL;
<span class="lineNum">    5262 </span><span class="lineCov">          1 :             psNode-&gt;psLeftNode-&gt;psRightNode-&gt;pszValue =</span>
<span class="lineNum">    5263 </span><span class="lineCov">          1 :               msStrdup(pszAttibuteValue);</span>
<span class="lineNum">    5264 </span>            : 
<span class="lineNum">    5265 </span><span class="lineCov">          1 :             free(pszComparionValue);</span>
<span class="lineNum">    5266 </span><span class="lineCov">          1 :             free(pszAttibuteName);</span>
<span class="lineNum">    5267 </span><span class="lineCov">          1 :             free(pszAttibuteValue);</span>
<span class="lineNum">    5268 </span><span class="lineCov">          1 :             free(pszLeftExpression);</span>
<span class="lineNum">    5269 </span>            :           }
<span class="lineNum">    5270 </span>            :         }
<span class="lineNum">    5271 </span><span class="lineCov">          1 :         if (pszRightExpression) {</span>
<span class="lineNum">    5272 </span><span class="lineCov">          1 :           pszComparionValue = msSLDGetComparisonValue(pszRightExpression);</span>
<span class="lineNum">    5273 </span><span class="lineCov">          1 :           pszAttibuteName = msSLDGetAttributeName(pszRightExpression,</span>
<span class="lineNum">    5274 </span>            :                                                   pszComparionValue);
<span class="lineNum">    5275 </span><span class="lineCov">          1 :           pszAttibuteValue = msSLDGetAttributeValue(pszRightExpression,</span>
<span class="lineNum">    5276 </span>            :                              pszComparionValue);
<span class="lineNum">    5277 </span>            : 
<span class="lineNum">    5278 </span><span class="lineCov">          1 :           if (pszComparionValue &amp;&amp; pszAttibuteName &amp;&amp; pszAttibuteValue) {</span>
<span class="lineNum">    5279 </span><span class="lineCov">          1 :             psNode-&gt;psRightNode = FLTCreateFilterEncodingNode();</span>
<span class="lineNum">    5280 </span><span class="lineCov">          1 :             psNode-&gt;psRightNode-&gt;eType = FILTER_NODE_TYPE_COMPARISON;</span>
<span class="lineNum">    5281 </span><span class="lineCov">          1 :             psNode-&gt;psRightNode-&gt;pszValue = msStrdup(pszComparionValue);</span>
<span class="lineNum">    5282 </span>            : 
<span class="lineNum">    5283 </span><span class="lineCov">          1 :             psNode-&gt;psRightNode-&gt;psLeftNode =</span>
<span class="lineNum">    5284 </span><span class="lineCov">          1 :               FLTCreateFilterEncodingNode();</span>
<span class="lineNum">    5285 </span><span class="lineCov">          1 :             psNode-&gt;psRightNode-&gt;psLeftNode-&gt;eType =</span>
<span class="lineNum">    5286 </span>            :               FILTER_NODE_TYPE_PROPERTYNAME;
<span class="lineNum">    5287 </span><span class="lineCov">          1 :             psNode-&gt;psRightNode-&gt;psLeftNode-&gt;pszValue =</span>
<span class="lineNum">    5288 </span><span class="lineCov">          1 :               msStrdup(pszAttibuteName);</span>
<span class="lineNum">    5289 </span>            : 
<span class="lineNum">    5290 </span><span class="lineCov">          1 :             psNode-&gt;psRightNode-&gt;psRightNode =</span>
<span class="lineNum">    5291 </span><span class="lineCov">          1 :               FLTCreateFilterEncodingNode();</span>
<span class="lineNum">    5292 </span><span class="lineCov">          1 :             psNode-&gt;psRightNode-&gt;psRightNode-&gt;eType =</span>
<span class="lineNum">    5293 </span>            :               FILTER_NODE_TYPE_LITERAL;
<span class="lineNum">    5294 </span><span class="lineCov">          1 :             psNode-&gt;psRightNode-&gt;psRightNode-&gt;pszValue =</span>
<span class="lineNum">    5295 </span><span class="lineCov">          1 :               msStrdup(pszAttibuteValue);</span>
<span class="lineNum">    5296 </span>            : 
<span class="lineNum">    5297 </span><span class="lineCov">          1 :             free(pszComparionValue);</span>
<span class="lineNum">    5298 </span><span class="lineCov">          1 :             free(pszAttibuteName);</span>
<span class="lineNum">    5299 </span><span class="lineCov">          1 :             free(pszAttibuteValue);</span>
<span class="lineNum">    5300 </span><span class="lineCov">          1 :             free(pszRightExpression);</span>
<span class="lineNum">    5301 </span>            :           }
<span class="lineNum">    5302 </span>            :         }
<span class="lineNum">    5303 </span>            :       }
<span class="lineNum">    5304 </span>            :     }
<span class="lineNum">    5305 </span>            : 
<span class="lineNum">    5306 </span>            :     return psNode;
<span class="lineNum">    5307 </span>            :   } else {
<span class="lineNum">    5308 </span>            :     return NULL;
<span class="lineNum">    5309 </span>            :   }
<a name="5310"><span class="lineNum">    5310 </span>            : }</a>
<span class="lineNum">    5311 </span>            : 
<span class="lineNum">    5312 </span><span class="lineCov">          1 : char *msSLDBuildFilterEncoding(FilterEncodingNode *psNode)</span>
<span class="lineNum">    5313 </span>            : {
<span class="lineNum">    5314 </span>            :   char *pszTmp = NULL;
<span class="lineNum">    5315 </span>            :   char szTmp[200];
<span class="lineNum">    5316 </span>            :   char *pszExpression = NULL;
<span class="lineNum">    5317 </span>            : 
<span class="lineNum">    5318 </span><span class="lineCov">          1 :   if (!psNode)</span>
<span class="lineNum">    5319 </span>            :     return NULL;
<span class="lineNum">    5320 </span>            : 
<span class="lineNum">    5321 </span><span class="lineCov">          1 :   if (psNode-&gt;eType == FILTER_NODE_TYPE_COMPARISON &amp;&amp;</span>
<span class="lineNum">    5322 </span><span class="lineCov">          1 :       psNode-&gt;pszValue &amp;&amp; psNode-&gt;psLeftNode &amp;&amp; psNode-&gt;psLeftNode-&gt;pszValue &amp;&amp;</span>
<span class="lineNum">    5323 </span><span class="lineCov">          1 :       psNode-&gt;psRightNode &amp;&amp; psNode-&gt;psRightNode-&gt;pszValue) {</span>
<span class="lineNum">    5324 </span>            :     snprintf(szTmp, sizeof(szTmp), &quot;&lt;ogc:%s&gt;&lt;ogc:PropertyName&gt;%s&lt;/ogc:PropertyName&gt;&lt;ogc:Literal&gt;%s&lt;/ogc:Literal&gt;&lt;/ogc:%s&gt;&quot;,
<span class="lineNum">    5325 </span>            :              psNode-&gt;pszValue, psNode-&gt;psLeftNode-&gt;pszValue,
<span class="lineNum">    5326 </span>            :              psNode-&gt;psRightNode-&gt;pszValue, psNode-&gt;pszValue);
<span class="lineNum">    5327 </span><span class="lineCov">          1 :     pszExpression = msStrdup(szTmp);</span>
<span class="lineNum">    5328 </span><span class="lineCov">          1 :   } else if (psNode-&gt;eType == FILTER_NODE_TYPE_LOGICAL &amp;&amp;</span>
<span class="lineNum">    5329 </span><span class="lineCov">          1 :              psNode-&gt;pszValue &amp;&amp;</span>
<span class="lineNum">    5330 </span><span class="lineCov">          1 :              ((psNode-&gt;psLeftNode &amp;&amp; psNode-&gt;psLeftNode-&gt;pszValue) ||</span>
<span class="lineNum">    5331 </span><span class="lineCov">          1 :               (psNode-&gt;psRightNode &amp;&amp; psNode-&gt;psRightNode-&gt;pszValue))) {</span>
<span class="lineNum">    5332 </span>            :     snprintf(szTmp, sizeof(szTmp), &quot;&lt;ogc:%s&gt;&quot;, psNode-&gt;pszValue);
<span class="lineNum">    5333 </span><span class="lineCov">          1 :     pszExpression = msStringConcatenate(pszExpression, szTmp);</span>
<span class="lineNum">    5334 </span><span class="lineCov">          1 :     if (psNode-&gt;psLeftNode) {</span>
<span class="lineNum">    5335 </span><span class="lineCov">          1 :       pszTmp = msSLDBuildFilterEncoding(psNode-&gt;psLeftNode);</span>
<span class="lineNum">    5336 </span><span class="lineCov">          1 :       if (pszTmp) {</span>
<span class="lineNum">    5337 </span><span class="lineCov">          1 :         pszExpression = msStringConcatenate(pszExpression, pszTmp);</span>
<span class="lineNum">    5338 </span><span class="lineCov">          1 :         free(pszTmp);</span>
<span class="lineNum">    5339 </span>            :       }
<span class="lineNum">    5340 </span>            :     }
<span class="lineNum">    5341 </span><span class="lineCov">          1 :     if (psNode-&gt;psRightNode) {</span>
<span class="lineNum">    5342 </span><span class="lineCov">          1 :       pszTmp = msSLDBuildFilterEncoding(psNode-&gt;psRightNode);</span>
<span class="lineNum">    5343 </span><span class="lineCov">          1 :       if (pszTmp) {</span>
<span class="lineNum">    5344 </span><span class="lineCov">          1 :         pszExpression = msStringConcatenate(pszExpression, pszTmp);</span>
<span class="lineNum">    5345 </span><span class="lineCov">          1 :         free(pszTmp);</span>
<span class="lineNum">    5346 </span>            :       }
<span class="lineNum">    5347 </span>            :     }
<span class="lineNum">    5348 </span><span class="lineCov">          1 :     snprintf(szTmp,  sizeof(szTmp), &quot;&lt;/ogc:%s&gt;&quot;, psNode-&gt;pszValue);</span>
<span class="lineNum">    5349 </span><span class="lineCov">          1 :     pszExpression = msStringConcatenate(pszExpression, szTmp);</span>
<span class="lineNum">    5350 </span>            :   }
<span class="lineNum">    5351 </span>            :   return pszExpression;
<span class="lineNum">    5352 </span>            : }
<span class="lineNum">    5353 </span>            : 
<a name="5354"><span class="lineNum">    5354 </span>            : </a>
<span class="lineNum">    5355 </span>            : 
<span class="lineNum">    5356 </span><span class="lineCov">          1 : char *msSLDParseLogicalExpression(char *pszExpression, const char *pszWfsFilter)</span>
<span class="lineNum">    5357 </span>            : {
<span class="lineNum">    5358 </span>            :   FilterEncodingNode *psNode = NULL;
<span class="lineNum">    5359 </span>            :   char *pszFLTExpression = NULL;
<span class="lineNum">    5360 </span>            :   char *pszTmp = NULL;
<span class="lineNum">    5361 </span>            : 
<span class="lineNum">    5362 </span><span class="lineCov">          1 :   if (!pszExpression || strlen(pszExpression) &lt;=0)</span>
<span class="lineNum">    5363 </span>            :     return NULL;
<span class="lineNum">    5364 </span>            : 
<span class="lineNum">    5365 </span><span class="lineCov">          1 :   psNode = BuildExpressionTree(pszExpression, NULL);</span>
<span class="lineNum">    5366 </span>            : 
<span class="lineNum">    5367 </span><span class="lineCov">          1 :   if (psNode) {</span>
<span class="lineNum">    5368 </span><span class="lineCov">          1 :     pszFLTExpression = msSLDBuildFilterEncoding(psNode);</span>
<span class="lineNum">    5369 </span><span class="lineCov">          1 :     if (pszFLTExpression) {</span>
<span class="lineNum">    5370 </span><span class="lineCov">          1 :       pszTmp = msStringConcatenate(pszTmp, &quot;&lt;ogc:Filter&gt;&quot;);</span>
<span class="lineNum">    5371 </span><span class="lineCov">          1 :       if (pszWfsFilter) {</span>
<span class="lineNum">    5372 </span><span class="lineNoCov">          0 :         pszTmp = msStringConcatenate(pszTmp, &quot;&lt;ogc:And&gt;&quot;);</span>
<span class="lineNum">    5373 </span><span class="lineNoCov">          0 :         pszTmp = msStringConcatenate(pszTmp, (char *)pszWfsFilter);</span>
<span class="lineNum">    5374 </span>            :       }
<span class="lineNum">    5375 </span><span class="lineCov">          1 :       pszTmp = msStringConcatenate(pszTmp, pszFLTExpression);</span>
<span class="lineNum">    5376 </span>            : 
<span class="lineNum">    5377 </span><span class="lineCov">          1 :       if (pszWfsFilter)</span>
<span class="lineNum">    5378 </span><span class="lineNoCov">          0 :         pszTmp = msStringConcatenate(pszTmp, &quot;&lt;/ogc:And&gt;&quot;);</span>
<span class="lineNum">    5379 </span>            : 
<span class="lineNum">    5380 </span><span class="lineCov">          1 :       pszTmp = msStringConcatenate(pszTmp, &quot;&lt;/ogc:Filter&gt;\n&quot;);</span>
<span class="lineNum">    5381 </span>            : 
<span class="lineNum">    5382 </span><span class="lineCov">          1 :       free(pszFLTExpression);</span>
<span class="lineNum">    5383 </span>            :       pszFLTExpression = pszTmp;
<span class="lineNum">    5384 </span>            :     }
<span class="lineNum">    5385 </span><span class="lineCov">          1 :     FLTFreeFilterEncodingNode(psNode);</span>
<span class="lineNum">    5386 </span>            :   }
<span class="lineNum">    5387 </span>            : 
<span class="lineNum">    5388 </span>            :   return pszFLTExpression;
<span class="lineNum">    5389 </span>            : }
<span class="lineNum">    5390 </span>            : 
<span class="lineNum">    5391 </span>            : /************************************************************************/
<span class="lineNum">    5392 </span>            : /*             char *msSLDParseExpression(char *pszExpression)          */
<span class="lineNum">    5393 </span>            : /*                                                                      */
<span class="lineNum">    5394 </span>            : /*      Return an OGC filter for a mapserver logical expression.        */
<a name="5395"><span class="lineNum">    5395 </span>            : /*      TODO : move function to mapogcfilter.c                          */</a>
<span class="lineNum">    5396 </span>            : /************************************************************************/
<span class="lineNum">    5397 </span><span class="lineNoCov">          0 : char *msSLDParseExpression(char *pszExpression)</span>
<span class="lineNum">    5398 </span>            : {
<span class="lineNum">    5399 </span><span class="lineNoCov">          0 :   int nElements = 0;</span>
<span class="lineNum">    5400 </span>            :   char **aszElements = NULL;
<span class="lineNum">    5401 </span>            :   char szBuffer[500];
<span class="lineNum">    5402 </span>            :   char szFinalAtt[40];
<span class="lineNum">    5403 </span>            :   char szFinalValue[40];
<span class="lineNum">    5404 </span>            :   char szAttribute[40];
<span class="lineNum">    5405 </span>            :   char szValue[40];
<span class="lineNum">    5406 </span>            :   int i=0, nLength=0, iAtt=0, iVal=0;
<span class="lineNum">    5407 </span>            :   int bStartCopy=0, bSinglequote=0, bDoublequote=0;
<span class="lineNum">    5408 </span>            :   char *pszFilter = NULL;
<span class="lineNum">    5409 </span>            : 
<span class="lineNum">    5410 </span><span class="lineNoCov">          0 :   if (!pszExpression)</span>
<span class="lineNum">    5411 </span>            :     return NULL;
<span class="lineNum">    5412 </span>            : 
<span class="lineNum">    5413 </span>            :   nLength = strlen(pszExpression);
<span class="lineNum">    5414 </span>            : 
<span class="lineNum">    5415 </span><span class="lineNoCov">          0 :   aszElements = msStringSplit(pszExpression, ' ', &amp;nElements);</span>
<span class="lineNum">    5416 </span>            : 
<span class="lineNum">    5417 </span><span class="lineNoCov">          0 :   szFinalAtt[0] = '\0';</span>
<span class="lineNum">    5418 </span><span class="lineNoCov">          0 :   szFinalValue[0] = '\0';</span>
<span class="lineNum">    5419 </span><span class="lineNoCov">          0 :   for (i=0; i&lt;nElements; i++) {</span>
<span class="lineNum">    5420 </span><span class="lineNoCov">          0 :     if (strcasecmp(aszElements[i], &quot;=&quot;) == 0 ||</span>
<span class="lineNum">    5421 </span><span class="lineNoCov">          0 :         strcasecmp(aszElements[i], &quot;eq&quot;) == 0) {</span>
<span class="lineNum">    5422 </span><span class="lineNoCov">          0 :       if (i &gt; 0 &amp;&amp; i &lt; nElements-1) {</span>
<span class="lineNum">    5423 </span><span class="lineNoCov">          0 :         snprintf(szAttribute, sizeof(szAttribute), &quot;%s&quot;, aszElements[i-1]);</span>
<span class="lineNum">    5424 </span><span class="lineNoCov">          0 :         snprintf(szValue, sizeof(szValue), &quot;%s&quot;, aszElements[i+1]);</span>
<span class="lineNum">    5425 </span>            : 
<span class="lineNum">    5426 </span>            :         /* parse attribute */
<span class="lineNum">    5427 </span><span class="lineNoCov">          0 :         nLength = strlen(szAttribute);</span>
<span class="lineNum">    5428 </span><span class="lineNoCov">          0 :         if (nLength &gt; 0) {</span>
<span class="lineNum">    5429 </span>            :           iAtt = 0;
<span class="lineNum">    5430 </span><span class="lineNoCov">          0 :           for (i=0; i&lt;nLength; i++) {</span>
<span class="lineNum">    5431 </span><span class="lineNoCov">          0 :             if (szAttribute[i] == '[') {</span>
<span class="lineNum">    5432 </span>            :               bStartCopy = 1;
<span class="lineNum">    5433 </span><span class="lineNoCov">          0 :               continue;</span>
<span class="lineNum">    5434 </span>            :             }
<span class="lineNum">    5435 </span><span class="lineNoCov">          0 :             if (szAttribute[i] == ']')</span>
<span class="lineNum">    5436 </span>            :               break;
<span class="lineNum">    5437 </span><span class="lineNoCov">          0 :             if (bStartCopy) {</span>
<span class="lineNum">    5438 </span><span class="lineNoCov">          0 :               szFinalAtt[iAtt] = szAttribute[i];</span>
<span class="lineNum">    5439 </span><span class="lineNoCov">          0 :               iAtt++;</span>
<span class="lineNum">    5440 </span>            :             }
<span class="lineNum">    5441 </span><span class="lineNoCov">          0 :             szFinalAtt[iAtt] = '\0';</span>
<span class="lineNum">    5442 </span>            :           }
<span class="lineNum">    5443 </span>            :         }
<span class="lineNum">    5444 </span>            : 
<span class="lineNum">    5445 </span>            :         /* parse value */
<span class="lineNum">    5446 </span><span class="lineNoCov">          0 :         nLength = strlen(szValue);</span>
<span class="lineNum">    5447 </span><span class="lineNoCov">          0 :         if (nLength &gt; 0) {</span>
<span class="lineNum">    5448 </span><span class="lineNoCov">          0 :           if (szValue[0] == '\'')</span>
<span class="lineNum">    5449 </span>            :             bSinglequote = 1;
<span class="lineNum">    5450 </span><span class="lineNoCov">          0 :           else if (szValue[0] == '\&quot;')</span>
<span class="lineNum">    5451 </span>            :             bDoublequote = 1;
<span class="lineNum">    5452 </span>            :           else
<span class="lineNum">    5453 </span>            :             snprintf(szFinalValue, sizeof(szFinalValue), &quot;%s&quot;, szValue);
<span class="lineNum">    5454 </span>            : 
<span class="lineNum">    5455 </span>            :           iVal = 0;
<span class="lineNum">    5456 </span><span class="lineNoCov">          0 :           if (bSinglequote || bDoublequote) {</span>
<span class="lineNum">    5457 </span><span class="lineNoCov">          0 :             for (i=1; i&lt;nLength-1; i++)</span>
<span class="lineNum">    5458 </span><span class="lineNoCov">          0 :               szFinalValue[iVal++] = szValue[i];</span>
<span class="lineNum">    5459 </span>            : 
<span class="lineNum">    5460 </span><span class="lineNoCov">          0 :             szFinalValue[iVal] = '\0';</span>
<span class="lineNum">    5461 </span>            :           }
<span class="lineNum">    5462 </span>            :         }
<span class="lineNum">    5463 </span>            :       }
<span class="lineNum">    5464 </span><span class="lineNoCov">          0 :       if (strlen(szFinalAtt) &gt; 0 &amp;&amp; strlen(szFinalValue) &gt;0) {</span>
<span class="lineNum">    5465 </span>            :         snprintf(szBuffer, sizeof(szBuffer), &quot;&lt;ogc:Filter&gt;&lt;ogc:PropertyIsEqualTo&gt;&lt;ogc:PropertyName&gt;%s&lt;/ogc:PropertyName&gt;&lt;ogc:Literal&gt;%s&lt;/ogc:Literal&gt;&lt;/ogc:PropertyIsEqualTo&gt;&lt;/ogc:Filter&gt;&quot;,
<span class="lineNum">    5466 </span>            :                  szFinalAtt, szFinalValue);
<span class="lineNum">    5467 </span><span class="lineNoCov">          0 :         msFree(pszFilter); /*FIXME: we are possibly discarding a previously set pszFilter */</span>
<span class="lineNum">    5468 </span><span class="lineNoCov">          0 :         pszFilter = msStrdup(szBuffer);</span>
<span class="lineNum">    5469 </span>            :       }
<span class="lineNum">    5470 </span>            :     }
<span class="lineNum">    5471 </span>            :   }
<span class="lineNum">    5472 </span><span class="lineNoCov">          0 :   msFreeCharArray(aszElements, nElements);</span>
<span class="lineNum">    5473 </span>            : 
<span class="lineNum">    5474 </span><span class="lineNoCov">          0 :   return pszFilter;</span>
<span class="lineNum">    5475 </span>            : }
<span class="lineNum">    5476 </span>            : 
<span class="lineNum">    5477 </span>            : 
<span class="lineNum">    5478 </span>            : /************************************************************************/
<span class="lineNum">    5479 </span>            : /*                     msSLDConvertRegexExpToOgcIsLike                  */
<span class="lineNum">    5480 </span>            : /*                                                                      */
<span class="lineNum">    5481 </span>            : /*      Convert mapserver regex expression to ogc is like property      */
<span class="lineNum">    5482 </span>            : /*      expression.                                                     */
<span class="lineNum">    5483 </span>            : /*                                                                      */
<span class="lineNum">    5484 </span>            : /*      Review bug 1644 for details. Here are the current rules:        */
<span class="lineNum">    5485 </span>            : /*                                                                      */
<span class="lineNum">    5486 </span>            : /*       The filter encoding property like is more limited compared     */
<span class="lineNum">    5487 </span>            : /*      to regular expression that can be built in mapserver. I         */
<span class="lineNum">    5488 </span>            : /*      think we should define what is possible to convert properly     */
<span class="lineNum">    5489 </span>            : /*      and do those, and also identify potential problems.  Example :  */
<span class="lineNum">    5490 </span>            : /*        - any time there is a .* in the expression it will be         */
<span class="lineNum">    5491 </span>            : /*      converted to *                                                  */
<span class="lineNum">    5492 </span>            : /*        - any other character plus all the metacharacters . ^ $ * +   */
<span class="lineNum">    5493 </span>            : /*      ? { [ ] \ | ( ) would be outputted as is. (In case of           */
<span class="lineNum">    5494 </span>            : /*      mapserver, when we read the the ogc filter expression, we       */
<span class="lineNum">    5495 </span>            : /*      convert the wild card character to .*, and we convert the       */
<span class="lineNum">    5496 </span>            : /*      single character to .  and the escape character to \ all        */
<span class="lineNum">    5497 </span>            : /*      other are outputted as is)                                      */
<span class="lineNum">    5498 </span>            : /*        - the  ogc tag would look like &lt;ogc:PropertyIsLike            */
<span class="lineNum">    5499 </span>            : /*      wildCard=&quot;*&quot;  singleChar=&quot;.&quot; escape=&quot;\&quot;&gt;                        */
<span class="lineNum">    5500 </span>            : /*                                                                      */
<span class="lineNum">    5501 </span>            : /*        - type of potential problem :                                 */
<span class="lineNum">    5502 </span>            : /*           * if an expression is like /T (star)/ it will be           */
<span class="lineNum">    5503 </span>            : /*      converted to T* which is not correct.                           */
<a name="5504"><span class="lineNum">    5504 </span>            : /*                                                                      */</a>
<span class="lineNum">    5505 </span>            : /************************************************************************/
<span class="lineNum">    5506 </span><span class="lineNoCov">          0 : char *msSLDConvertRegexExpToOgcIsLike(char *pszRegex)</span>
<span class="lineNum">    5507 </span>            : {
<span class="lineNum">    5508 </span>            :   char szBuffer[1024];
<span class="lineNum">    5509 </span>            :   int iBuffer = 0, i=0;
<span class="lineNum">    5510 </span>            :   int nLength = 0;
<span class="lineNum">    5511 </span>            : 
<span class="lineNum">    5512 </span><span class="lineNoCov">          0 :   if (!pszRegex || strlen(pszRegex) == 0)</span>
<span class="lineNum">    5513 </span>            :     return NULL;
<span class="lineNum">    5514 </span>            : 
<span class="lineNum">    5515 </span><span class="lineNoCov">          0 :   szBuffer[0] = '\0';</span>
<span class="lineNum">    5516 </span><span class="lineNoCov">          0 :   nLength = strlen(pszRegex);</span>
<span class="lineNum">    5517 </span>            : 
<span class="lineNum">    5518 </span><span class="lineNoCov">          0 :   while (i &lt; nLength) {</span>
<span class="lineNum">    5519 </span><span class="lineNoCov">          0 :     if (pszRegex[i] != '.') {</span>
<span class="lineNum">    5520 </span><span class="lineNoCov">          0 :       szBuffer[iBuffer++] = pszRegex[i];</span>
<span class="lineNum">    5521 </span><span class="lineNoCov">          0 :       i++;</span>
<span class="lineNum">    5522 </span>            :     } else {
<span class="lineNum">    5523 </span><span class="lineNoCov">          0 :       if (i&lt;nLength-1 &amp;&amp; pszRegex[i+1] == '*') {</span>
<span class="lineNum">    5524 </span><span class="lineNoCov">          0 :         szBuffer[iBuffer++] = '*';</span>
<span class="lineNum">    5525 </span><span class="lineNoCov">          0 :         i = i+2;</span>
<span class="lineNum">    5526 </span>            :       } else {
<span class="lineNum">    5527 </span><span class="lineNoCov">          0 :         szBuffer[iBuffer++] =  pszRegex[i];</span>
<span class="lineNum">    5528 </span><span class="lineNoCov">          0 :         i++;</span>
<span class="lineNum">    5529 </span>            :       }
<span class="lineNum">    5530 </span>            :     }
<span class="lineNum">    5531 </span>            :   }
<span class="lineNum">    5532 </span><span class="lineNoCov">          0 :   szBuffer[iBuffer] = '\0';</span>
<span class="lineNum">    5533 </span>            : 
<span class="lineNum">    5534 </span><span class="lineNoCov">          0 :   return msStrdup(szBuffer);</span>
<span class="lineNum">    5535 </span>            : }
<span class="lineNum">    5536 </span>            : 
<span class="lineNum">    5537 </span>            : /************************************************************************/
<span class="lineNum">    5538 </span>            : /*                              msSLDGetFilter                          */
<span class="lineNum">    5539 </span>            : /*                                                                      */
<span class="lineNum">    5540 </span>            : /*      Get the corresponding ogc Filter based on the class             */
<span class="lineNum">    5541 </span>            : /*      expression. TODO : move function to mapogcfilter.c when         */
<a name="5542"><span class="lineNum">    5542 </span>            : /*      finished.                                                       */</a>
<span class="lineNum">    5543 </span>            : /************************************************************************/
<span class="lineNum">    5544 </span><span class="lineCov">          1 : char *msSLDGetFilter(classObj *psClass, const char *pszWfsFilter)</span>
<span class="lineNum">    5545 </span>            : {
<span class="lineNum">    5546 </span>            :   char *pszFilter = NULL;
<span class="lineNum">    5547 </span>            :   char szBuffer[500];
<span class="lineNum">    5548 </span>            :   char *pszOgcFilter = NULL;
<span class="lineNum">    5549 </span>            : 
<span class="lineNum">    5550 </span><span class="lineCov">          1 :   if (psClass &amp;&amp; psClass-&gt;expression.string) {</span>
<span class="lineNum">    5551 </span>            :     /* string expression */
<span class="lineNum">    5552 </span><span class="lineCov">          1 :     if (psClass-&gt;expression.type == MS_STRING) {</span>
<span class="lineNum">    5553 </span><span class="lineCov">          1 :       if (psClass-&gt;layer &amp;&amp; psClass-&gt;layer-&gt;classitem) {</span>
<span class="lineNum">    5554 </span><span class="lineCov">          1 :         if (pszWfsFilter)</span>
<span class="lineNum">    5555 </span>            :           snprintf(szBuffer, sizeof(szBuffer), &quot;&lt;ogc:Filter&gt;&lt;ogc:And&gt;%s&lt;ogc:PropertyIsEqualTo&gt;&lt;ogc:PropertyName&gt;%s&lt;/ogc:PropertyName&gt;&lt;ogc:Literal&gt;%s&lt;/ogc:Literal&gt;&lt;/ogc:PropertyIsEqualTo&gt;&lt;/ogc:And&gt;&lt;/ogc:Filter&gt;\n&quot;,
<span class="lineNum">    5556 </span>            :                    pszWfsFilter, psClass-&gt;layer-&gt;classitem, psClass-&gt;expression.string);
<span class="lineNum">    5557 </span>            :         else
<span class="lineNum">    5558 </span>            :           snprintf(szBuffer, sizeof(szBuffer), &quot;&lt;ogc:Filter&gt;&lt;ogc:PropertyIsEqualTo&gt;&lt;ogc:PropertyName&gt;%s&lt;/ogc:PropertyName&gt;&lt;ogc:Literal&gt;%s&lt;/ogc:Literal&gt;&lt;/ogc:PropertyIsEqualTo&gt;&lt;/ogc:Filter&gt;\n&quot;,
<span class="lineNum">    5559 </span>            :                    psClass-&gt;layer-&gt;classitem, psClass-&gt;expression.string);
<span class="lineNum">    5560 </span><span class="lineCov">          1 :         pszFilter = msStrdup(szBuffer);</span>
<span class="lineNum">    5561 </span>            :       }
<span class="lineNum">    5562 </span><span class="lineCov">          1 :     } else if (psClass-&gt;expression.type == MS_EXPRESSION) {</span>
<span class="lineNum">    5563 </span><span class="lineCov">          1 :       pszFilter = msSLDParseLogicalExpression(psClass-&gt;expression.string, pszWfsFilter);</span>
<span class="lineNum">    5564 </span><span class="lineNoCov">          0 :     } else if (psClass-&gt;expression.type == MS_REGEX) {</span>
<span class="lineNum">    5565 </span><span class="lineNoCov">          0 :       if (psClass-&gt;layer &amp;&amp; psClass-&gt;layer-&gt;classitem &amp;&amp; psClass-&gt;expression.string) {</span>
<span class="lineNum">    5566 </span><span class="lineNoCov">          0 :         pszOgcFilter = msSLDConvertRegexExpToOgcIsLike(psClass-&gt;expression.string);</span>
<span class="lineNum">    5567 </span>            : 
<span class="lineNum">    5568 </span><span class="lineNoCov">          0 :         if (pszWfsFilter)</span>
<span class="lineNum">    5569 </span><span class="lineNoCov">          0 :           snprintf(szBuffer, sizeof(szBuffer), &quot;&lt;ogc:Filter&gt;&lt;ogc:And&gt;%s&lt;ogc:PropertyIsLike wildCard=\&quot;*\&quot; singleChar=\&quot;.\&quot; escape=\&quot;\\\&quot;&gt;&lt;ogc:PropertyName&gt;%s&lt;/ogc:PropertyName&gt;&lt;ogc:Literal&gt;%s&lt;/ogc:Literal&gt;&lt;/ogc:PropertyIsLike&gt;&lt;/ogc:And&gt;&lt;/ogc:Filter&gt;\n&quot;,</span>
<span class="lineNum">    5570 </span><span class="lineNoCov">          0 :                    pszWfsFilter, psClass-&gt;layer-&gt;classitem, pszOgcFilter);</span>
<span class="lineNum">    5571 </span>            :         else
<span class="lineNum">    5572 </span><span class="lineNoCov">          0 :           snprintf(szBuffer, sizeof(szBuffer), &quot;&lt;ogc:Filter&gt;&lt;ogc:PropertyIsLike wildCard=\&quot;*\&quot; singleChar=\&quot;.\&quot; escape=\&quot;\\\&quot;&gt;&lt;ogc:PropertyName&gt;%s&lt;/ogc:PropertyName&gt;&lt;ogc:Literal&gt;%s&lt;/ogc:Literal&gt;&lt;/ogc:PropertyIsLike&gt;&lt;/ogc:Filter&gt;\n&quot;,</span>
<span class="lineNum">    5573 </span><span class="lineNoCov">          0 :                    psClass-&gt;layer-&gt;classitem, pszOgcFilter);</span>
<span class="lineNum">    5574 </span>            : 
<span class="lineNum">    5575 </span><span class="lineNoCov">          0 :         free(pszOgcFilter);</span>
<span class="lineNum">    5576 </span>            : 
<span class="lineNum">    5577 </span><span class="lineNoCov">          0 :         pszFilter = msStrdup(szBuffer);</span>
<span class="lineNum">    5578 </span>            :       }
<span class="lineNum">    5579 </span>            :     }
<span class="lineNum">    5580 </span><span class="lineCov">          1 :   } else if (pszWfsFilter) {</span>
<span class="lineNum">    5581 </span>            :     snprintf(szBuffer, sizeof(szBuffer), &quot;&lt;ogc:Filter&gt;%s&lt;/ogc:Filter&gt;\n&quot;, pszWfsFilter);
<span class="lineNum">    5582 </span><span class="lineNoCov">          0 :     pszFilter = msStrdup(szBuffer);</span>
<span class="lineNum">    5583 </span>            :   }
<span class="lineNum">    5584 </span><span class="lineCov">          1 :   return pszFilter;</span>
<span class="lineNum">    5585 </span>            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>

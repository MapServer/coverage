<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - mapserver.info - mapserver/mapraster.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">mapserver</a> - mapraster.c<span style="font-size: 80%;"> (source / <a href="mapraster.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">mapserver.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">231</td>
            <td class="headerCovTableEntry">416</td>
            <td class="headerCovTableEntryLo">55.5 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2020-07-31 13:04:15</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">15</td>
            <td class="headerCovTableEntry">17</td>
            <td class="headerCovTableEntryMed">88.2 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /******************************************************************************</a>
<span class="lineNum">       2 </span>            :  * $id: mapraster.c 10772 2010-11-29 18:27:02Z aboudreault $
<span class="lineNum">       3 </span>            :  *
<span class="lineNum">       4 </span>            :  * Project:  MapServer
<span class="lineNum">       5 </span>            :  * Purpose:  msDrawRasterLayer(): generic raster layer drawing.
<span class="lineNum">       6 </span>            :  * Author:   Frank Warmerdam, warmerdam@pobox.com
<span class="lineNum">       7 </span>            :  *           Pete Olson (LMIC)
<span class="lineNum">       8 </span>            :  *           Steve Lime
<span class="lineNum">       9 </span>            :  *
<span class="lineNum">      10 </span>            :  ******************************************************************************
<span class="lineNum">      11 </span>            :  * Copyright (c) 1996-2010 Regents of the University of Minnesota.
<span class="lineNum">      12 </span>            :  *
<span class="lineNum">      13 </span>            :  * Permission is hereby granted, free of charge, to any person obtaining a
<span class="lineNum">      14 </span>            :  * copy of this software and associated documentation files (the &quot;Software&quot;),
<span class="lineNum">      15 </span>            :  * to deal in the Software without restriction, including without limitation
<span class="lineNum">      16 </span>            :  * the rights to use, copy, modify, merge, publish, distribute, sublicense,
<span class="lineNum">      17 </span>            :  * and/or sell copies of the Software, and to permit persons to whom the
<span class="lineNum">      18 </span>            :  * Software is furnished to do so, subject to the following conditions:
<span class="lineNum">      19 </span>            :  *
<span class="lineNum">      20 </span>            :  * The above copyright notice and this permission notice shall be included in
<span class="lineNum">      21 </span>            :  * all copies of this Software or works derived from this Software.
<span class="lineNum">      22 </span>            :  *
<span class="lineNum">      23 </span>            :  * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS
<span class="lineNum">      24 </span>            :  * OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
<span class="lineNum">      25 </span>            :  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL
<span class="lineNum">      26 </span>            :  * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
<span class="lineNum">      27 </span>            :  * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
<span class="lineNum">      28 </span>            :  * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
<span class="lineNum">      29 </span>            :  * DEALINGS IN THE SOFTWARE.
<span class="lineNum">      30 </span>            :  ****************************************************************************/
<span class="lineNum">      31 </span>            : 
<span class="lineNum">      32 </span>            : #include &lt;assert.h&gt;
<span class="lineNum">      33 </span>            : #include &quot;mapserver.h&quot;
<span class="lineNum">      34 </span>            : #include &quot;mapfile.h&quot;
<span class="lineNum">      35 </span>            : #include &quot;mapresample.h&quot;
<span class="lineNum">      36 </span>            : #include &quot;mapthread.h&quot;
<span class="lineNum">      37 </span>            : 
<span class="lineNum">      38 </span>            : 
<span class="lineNum">      39 </span>            : 
<span class="lineNum">      40 </span>            : extern int msyylex_destroy(void);
<span class="lineNum">      41 </span>            : extern int yyparse(parseObj *);
<span class="lineNum">      42 </span>            : 
<span class="lineNum">      43 </span>            : extern parseResultObj yypresult; /* result of parsing, true/false */
<span class="lineNum">      44 </span>            : 
<span class="lineNum">      45 </span>            : #include &quot;gdal.h&quot;
<span class="lineNum">      46 </span>            : #include &quot;cpl_string.h&quot;
<span class="lineNum">      47 </span>            : #include &quot;mapraster.h&quot;
<span class="lineNum">      48 </span>            : 
<span class="lineNum">      49 </span>            : #define MAXCOLORS 256
<span class="lineNum">      50 </span>            : #define BUFLEN 1024
<span class="lineNum">      51 </span>            : #define HDRLEN 8
<span class="lineNum">      52 </span>            : 
<span class="lineNum">      53 </span>            : #define CVT(x) ((x) &gt;&gt; 8) /* converts to 8-bit color value */
<span class="lineNum">      54 </span>            : 
<span class="lineNum">      55 </span>            : #define NUMGRAYS 16
<span class="lineNum">      56 </span>            : 
<span class="lineNum">      57 </span>            : /************************************************************************/
<span class="lineNum">      58 </span>            : /*                         msGetClass_String()                          */
<a name="59"><span class="lineNum">      59 </span>            : /************************************************************************/</a>
<span class="lineNum">      60 </span>            : 
<span class="lineNum">      61 </span><span class="lineCov">          1 : static int msGetClass_String( layerObj *layer, colorObj *color, const char *pixel_value, int firstClassToTry )</span>
<span class="lineNum">      62 </span>            : 
<span class="lineNum">      63 </span>            : {
<span class="lineNum">      64 </span>            :   int i;
<span class="lineNum">      65 </span>            :   const char *tmpstr1=NULL;
<span class="lineNum">      66 </span>            :   int numitems;
<span class="lineNum">      67 </span><span class="lineCov">          1 :   char *item_names[4] = { &quot;pixel&quot;, &quot;red&quot;, &quot;green&quot;, &quot;blue&quot; };</span>
<span class="lineNum">      68 </span>            :   char *item_values[4];
<span class="lineNum">      69 </span>            :   char red_value[8], green_value[8], blue_value[8];
<span class="lineNum">      70 </span>            : 
<span class="lineNum">      71 </span>            :   /* -------------------------------------------------------------------- */
<span class="lineNum">      72 </span>            :   /*      No need to do a lookup in the case of one default class.        */
<span class="lineNum">      73 </span>            :   /* -------------------------------------------------------------------- */
<span class="lineNum">      74 </span><span class="lineCov">          1 :   if((layer-&gt;numclasses == 1) &amp;&amp; !(layer-&gt;class[0]-&gt;expression.string)) /* no need to do lookup */</span>
<span class="lineNum">      75 </span>            :     return(0);
<span class="lineNum">      76 </span>            : 
<span class="lineNum">      77 </span>            :   /* -------------------------------------------------------------------- */
<span class="lineNum">      78 </span>            :   /*      Setup values list for expressions.                              */
<span class="lineNum">      79 </span>            :   /* -------------------------------------------------------------------- */
<span class="lineNum">      80 </span><span class="lineCov">          1 :   numitems = 4;</span>
<span class="lineNum">      81 </span><span class="lineCov">          1 :   if( color-&gt;red == -1 &amp;&amp; color-&gt;green == -1 &amp;&amp; color-&gt;blue == -1 )</span>
<span class="lineNum">      82 </span>            :   {
<span class="lineNum">      83 </span>            :     strcpy(red_value, &quot;-1&quot;);
<span class="lineNum">      84 </span>            :     strcpy(green_value, &quot;-1&quot;);
<span class="lineNum">      85 </span>            :     strcpy(blue_value, &quot;-1&quot;);
<span class="lineNum">      86 </span>            :   }
<span class="lineNum">      87 </span>            :   else
<span class="lineNum">      88 </span>            :   {
<span class="lineNum">      89 </span>            :     sprintf( red_value, &quot;%d&quot;, color-&gt;red );
<span class="lineNum">      90 </span><span class="lineCov">          1 :     sprintf( green_value, &quot;%d&quot;, color-&gt;green );</span>
<span class="lineNum">      91 </span><span class="lineCov">          1 :     sprintf( blue_value, &quot;%d&quot;, color-&gt;blue );</span>
<span class="lineNum">      92 </span>            :   }
<span class="lineNum">      93 </span>            : 
<span class="lineNum">      94 </span><span class="lineCov">          1 :   item_values[0] = (char *)pixel_value;</span>
<span class="lineNum">      95 </span><span class="lineCov">          1 :   item_values[1] = red_value;</span>
<span class="lineNum">      96 </span><span class="lineCov">          1 :   item_values[2] = green_value;</span>
<span class="lineNum">      97 </span><span class="lineCov">          1 :   item_values[3] = blue_value;</span>
<span class="lineNum">      98 </span>            : 
<span class="lineNum">      99 </span>            :   /* -------------------------------------------------------------------- */
<span class="lineNum">     100 </span>            :   /*      Loop over classes till we find a match.                         */
<span class="lineNum">     101 </span>            :   /* -------------------------------------------------------------------- */
<span class="lineNum">     102 </span><span class="lineCov">          1 :   for(i= (firstClassToTry &lt; 0 ) ? 0 : -1; i&lt;layer-&gt;numclasses; i++) {</span>
<span class="lineNum">     103 </span>            : 
<span class="lineNum">     104 </span>            :     int idx = i;
<span class="lineNum">     105 </span><span class="lineCov">          1 :     if( i &lt; 0 )</span>
<span class="lineNum">     106 </span>            :         idx = firstClassToTry;
<span class="lineNum">     107 </span><span class="lineCov">          1 :     else if( i == firstClassToTry )</span>
<span class="lineNum">     108 </span><span class="lineCov">          1 :         continue;</span>
<span class="lineNum">     109 </span>            : 
<span class="lineNum">     110 </span>            :     /* check for correct classgroup, if set */
<span class="lineNum">     111 </span><span class="lineCov">          1 :     if ( layer-&gt;class[idx]-&gt;group &amp;&amp; layer-&gt;classgroup &amp;&amp;</span>
<span class="lineNum">     112 </span><span class="lineNoCov">          0 :          strcasecmp(layer-&gt;class[idx]-&gt;group, layer-&gt;classgroup) != 0 )</span>
<span class="lineNum">     113 </span><span class="lineNoCov">          0 :       continue;</span>
<span class="lineNum">     114 </span>            : 
<span class="lineNum">     115 </span>            :     /* Empty expression - always matches */
<span class="lineNum">     116 </span><span class="lineCov">          1 :     if (layer-&gt;class[idx]-&gt;expression.string == NULL)</span>
<span class="lineNum">     117 </span>            :       return(i);
<span class="lineNum">     118 </span>            : 
<span class="lineNum">     119 </span><span class="lineCov">          1 :     switch(layer-&gt;class[idx]-&gt;expression.type) {</span>
<span class="lineNum">     120 </span>            : 
<span class="lineNum">     121 </span>            :         /* -------------------------------------------------------------------- */
<span class="lineNum">     122 </span>            :         /*      Simple string match                                             */
<span class="lineNum">     123 </span>            :         /* -------------------------------------------------------------------- */
<span class="lineNum">     124 </span>            :       case(MS_STRING):
<span class="lineNum">     125 </span>            :         /* trim junk white space */
<span class="lineNum">     126 </span>            :         tmpstr1= pixel_value;
<span class="lineNum">     127 </span><span class="lineNoCov">          0 :         while( *tmpstr1 == ' ' )</span>
<span class="lineNum">     128 </span><span class="lineNoCov">          0 :           tmpstr1++;</span>
<span class="lineNum">     129 </span>            : 
<span class="lineNum">     130 </span><span class="lineNoCov">          0 :         if(strcmp(layer-&gt;class[idx]-&gt;expression.string, tmpstr1) == 0) return(idx); /* matched */</span>
<span class="lineNum">     131 </span>            :         break;
<span class="lineNum">     132 </span>            : 
<span class="lineNum">     133 </span>            :         /* -------------------------------------------------------------------- */
<span class="lineNum">     134 </span>            :         /*      Regular expression.  Rarely used for raster.                    */
<span class="lineNum">     135 </span>            :         /* -------------------------------------------------------------------- */
<span class="lineNum">     136 </span><span class="lineNoCov">          0 :       case(MS_REGEX):</span>
<span class="lineNum">     137 </span><span class="lineNoCov">          0 :         if(!layer-&gt;class[idx]-&gt;expression.compiled) {</span>
<span class="lineNum">     138 </span><span class="lineNoCov">          0 :           if(ms_regcomp(&amp;(layer-&gt;class[idx]-&gt;expression.regex), layer-&gt;class[idx]-&gt;expression.string, MS_REG_EXTENDED|MS_REG_NOSUB) != 0) { /* compile the expression  */</span>
<span class="lineNum">     139 </span><span class="lineNoCov">          0 :             msSetError(MS_REGEXERR, &quot;Invalid regular expression.&quot;, &quot;msGetClass()&quot;);</span>
<span class="lineNum">     140 </span><span class="lineNoCov">          0 :             return(-1);</span>
<span class="lineNum">     141 </span>            :           }
<span class="lineNum">     142 </span><span class="lineNoCov">          0 :           layer-&gt;class[idx]-&gt;expression.compiled = MS_TRUE;</span>
<span class="lineNum">     143 </span>            :         }
<span class="lineNum">     144 </span>            : 
<span class="lineNum">     145 </span><span class="lineNoCov">          0 :         if(ms_regexec(&amp;(layer-&gt;class[idx]-&gt;expression.regex), pixel_value, 0, NULL, 0) == 0) return(idx); /* got a match */</span>
<span class="lineNum">     146 </span>            :         break;
<span class="lineNum">     147 </span>            : 
<span class="lineNum">     148 </span>            :         /* -------------------------------------------------------------------- */
<span class="lineNum">     149 </span>            :         /*      Parsed expression.                                              */
<span class="lineNum">     150 </span>            :         /* -------------------------------------------------------------------- */
<span class="lineNum">     151 </span><span class="lineCov">          1 :       case(MS_EXPRESSION): {</span>
<span class="lineNum">     152 </span>            :         int status;
<span class="lineNum">     153 </span>            :         parseObj p;
<span class="lineNum">     154 </span>            :         shapeObj dummy_shape;
<span class="lineNum">     155 </span><span class="lineCov">          1 :         expressionObj *expression = &amp;(layer-&gt;class[idx]-&gt;expression);</span>
<span class="lineNum">     156 </span>            : 
<span class="lineNum">     157 </span><span class="lineCov">          1 :         dummy_shape.numvalues = numitems;</span>
<span class="lineNum">     158 </span><span class="lineCov">          1 :         dummy_shape.values = item_values;</span>
<span class="lineNum">     159 </span>            : 
<span class="lineNum">     160 </span><span class="lineCov">          1 :         if( expression-&gt;tokens == NULL )</span>
<span class="lineNum">     161 </span><span class="lineCov">          1 :           msTokenizeExpression( expression, item_names, &amp;numitems );</span>
<span class="lineNum">     162 </span>            : 
<span class="lineNum">     163 </span><span class="lineCov">          1 :         p.shape = &amp;dummy_shape;</span>
<span class="lineNum">     164 </span><span class="lineCov">          1 :         p.expr = expression;</span>
<span class="lineNum">     165 </span><span class="lineCov">          1 :         p.expr-&gt;curtoken = p.expr-&gt;tokens; /* reset */</span>
<span class="lineNum">     166 </span><span class="lineCov">          1 :         p.type = MS_PARSE_TYPE_BOOLEAN;</span>
<span class="lineNum">     167 </span>            : 
<span class="lineNum">     168 </span><span class="lineCov">          1 :         status = yyparse(&amp;p);</span>
<span class="lineNum">     169 </span>            : 
<span class="lineNum">     170 </span><span class="lineCov">          1 :         if (status != 0) {</span>
<span class="lineNum">     171 </span><span class="lineNoCov">          0 :           msSetError(MS_PARSEERR, &quot;Failed to parse expression: %s&quot;, &quot;msGetClass_FloatRGB&quot;, expression-&gt;string);</span>
<span class="lineNum">     172 </span><span class="lineCov">          1 :           return -1;</span>
<span class="lineNum">     173 </span>            :         }
<span class="lineNum">     174 </span>            : 
<span class="lineNum">     175 </span><span class="lineCov">          1 :         if( p.result.intval )</span>
<span class="lineNum">     176 </span>            :           return idx;
<span class="lineNum">     177 </span><span class="lineCov">          1 :         break;</span>
<span class="lineNum">     178 </span>            :       }
<span class="lineNum">     179 </span>            :     }
<span class="lineNum">     180 </span>            :   }
<span class="lineNum">     181 </span>            : 
<span class="lineNum">     182 </span>            :   return(-1); /* not found */
<span class="lineNum">     183 </span>            : }
<span class="lineNum">     184 </span>            : 
<span class="lineNum">     185 </span>            : /************************************************************************/
<span class="lineNum">     186 </span>            : /*                             msGetClass()                             */
<a name="187"><span class="lineNum">     187 </span>            : /************************************************************************/</a>
<span class="lineNum">     188 </span>            : 
<span class="lineNum">     189 </span><span class="lineCov">          1 : int msGetClass(layerObj *layer, colorObj *color, int colormap_index)</span>
<span class="lineNum">     190 </span>            : {
<span class="lineNum">     191 </span>            :   char pixel_value[12];
<span class="lineNum">     192 </span>            : 
<span class="lineNum">     193 </span>            :   snprintf( pixel_value, sizeof(pixel_value), &quot;%d&quot;, colormap_index );
<span class="lineNum">     194 </span>            : 
<span class="lineNum">     195 </span><span class="lineCov">          1 :   return msGetClass_String( layer, color, pixel_value, -1 );</span>
<span class="lineNum">     196 </span>            : }
<span class="lineNum">     197 </span>            : 
<span class="lineNum">     198 </span>            : /************************************************************************/
<span class="lineNum">     199 </span>            : /*                          msGetClass_FloatRGB()                       */
<span class="lineNum">     200 </span>            : /*                                                                      */
<span class="lineNum">     201 </span>            : /*      Returns the class based on classification of a floating         */
<span class="lineNum">     202 </span>            : /*      pixel value.                                                    */
<a name="203"><span class="lineNum">     203 </span>            : /************************************************************************/</a>
<span class="lineNum">     204 </span>            : 
<span class="lineNum">     205 </span><span class="lineCov">          1 : int msGetClass_FloatRGB(layerObj *layer, float fValue, int red, int green, int blue )</span>
<span class="lineNum">     206 </span>            : {
<span class="lineNum">     207 </span><span class="lineCov">          1 :     return msGetClass_FloatRGB_WithFirstClassToTry(</span>
<span class="lineNum">     208 </span>            :                 layer, fValue, red, green, blue, -1);
<span class="lineNum">     209 </span>            : }
<a name="210"><span class="lineNum">     210 </span>            : </a>
<span class="lineNum">     211 </span>            : 
<span class="lineNum">     212 </span><span class="lineCov">          1 : int msGetClass_FloatRGB_WithFirstClassToTry(layerObj *layer, float fValue, int red, int green, int blue, int firstClassToTry )</span>
<span class="lineNum">     213 </span>            : {
<span class="lineNum">     214 </span>            :   char pixel_value[100];
<span class="lineNum">     215 </span>            :   colorObj color;
<span class="lineNum">     216 </span>            : 
<span class="lineNum">     217 </span><span class="lineCov">          1 :   color.red = red;</span>
<span class="lineNum">     218 </span><span class="lineCov">          1 :   color.green = green;</span>
<span class="lineNum">     219 </span><span class="lineCov">          1 :   color.blue = blue;</span>
<span class="lineNum">     220 </span>            : 
<span class="lineNum">     221 </span><span class="lineCov">          1 :   snprintf( pixel_value, sizeof(pixel_value), &quot;%18g&quot;, fValue );</span>
<span class="lineNum">     222 </span>            : 
<span class="lineNum">     223 </span><span class="lineCov">          1 :   return msGetClass_String( layer, &amp;color, pixel_value, firstClassToTry );</span>
<span class="lineNum">     224 </span>            : }
<span class="lineNum">     225 </span>            : 
<span class="lineNum">     226 </span>            : /************************************************************************/
<span class="lineNum">     227 </span>            : /*                      msRasterSetupTileLayer()                        */
<span class="lineNum">     228 </span>            : /*                                                                      */
<span class="lineNum">     229 </span>            : /*      Setup the tile layer.                                           */
<a name="230"><span class="lineNum">     230 </span>            : /************************************************************************/</a>
<span class="lineNum">     231 </span>            : 
<span class="lineNum">     232 </span><span class="lineCov">          1 : int msDrawRasterSetupTileLayer(mapObj *map, layerObj *layer,</span>
<span class="lineNum">     233 </span>            :                                rectObj* psearchrect,
<span class="lineNum">     234 </span>            :                                int is_query,
<span class="lineNum">     235 </span>            :                                int* ptilelayerindex, /* output */
<span class="lineNum">     236 </span>            :                                int* ptileitemindex, /* output */
<span class="lineNum">     237 </span>            :                                int* ptilesrsindex, /* output */
<span class="lineNum">     238 </span>            :                                layerObj **ptlp  /* output */ )
<span class="lineNum">     239 </span>            : {
<span class="lineNum">     240 </span>            :     int i;
<span class="lineNum">     241 </span>            :     char* requested_fields;
<span class="lineNum">     242 </span>            :     int status;
<span class="lineNum">     243 </span>            :     layerObj* tlp = NULL;
<span class="lineNum">     244 </span>            : 
<span class="lineNum">     245 </span><span class="lineCov">          1 :     *ptilelayerindex = msGetLayerIndex(layer-&gt;map, layer-&gt;tileindex);</span>
<span class="lineNum">     246 </span><span class="lineCov">          1 :     if(*ptilelayerindex == -1) { /* the tileindex references a file, not a layer */</span>
<span class="lineNum">     247 </span>            : 
<span class="lineNum">     248 </span>            :       /* so we create a temporary layer */
<span class="lineNum">     249 </span><span class="lineCov">          1 :       tlp = (layerObj *) malloc(sizeof(layerObj));</span>
<span class="lineNum">     250 </span><span class="lineCov">          1 :       MS_CHECK_ALLOC(tlp, sizeof(layerObj), MS_FAILURE);</span>
<span class="lineNum">     251 </span>            : 
<span class="lineNum">     252 </span><span class="lineCov">          1 :       initLayer(tlp, map);</span>
<span class="lineNum">     253 </span><span class="lineCov">          1 :       *ptlp = tlp;</span>
<span class="lineNum">     254 </span>            : 
<span class="lineNum">     255 </span>            :       /* set a few parameters for a very basic shapefile-based layer */
<span class="lineNum">     256 </span><span class="lineCov">          1 :       tlp-&gt;name = msStrdup(&quot;TILE&quot;);</span>
<span class="lineNum">     257 </span><span class="lineCov">          1 :       tlp-&gt;type = MS_LAYER_TILEINDEX;</span>
<span class="lineNum">     258 </span><span class="lineCov">          1 :       tlp-&gt;data = msStrdup(layer-&gt;tileindex);</span>
<span class="lineNum">     259 </span>            : 
<span class="lineNum">     260 </span><span class="lineCov">          1 :       if( is_query )</span>
<span class="lineNum">     261 </span>            :       {
<span class="lineNum">     262 </span><span class="lineCov">          1 :         tlp-&gt;map = map;  /*needed when scaletokens are applied, to extract current map scale */</span>
<span class="lineNum">     263 </span><span class="lineCov">          1 :         for(i = 0; i &lt; layer-&gt;numscaletokens; i++) {</span>
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :           if(msGrowLayerScaletokens(tlp) == NULL) {</span>
<span class="lineNum">     265 </span>            :             return MS_FAILURE;
<span class="lineNum">     266 </span>            :           }
<span class="lineNum">     267 </span><span class="lineNoCov">          0 :           initScaleToken(&amp;tlp-&gt;scaletokens[i]);</span>
<span class="lineNum">     268 </span><span class="lineNoCov">          0 :           msCopyScaleToken(&amp;layer-&gt;scaletokens[i],&amp;tlp-&gt;scaletokens[i]);</span>
<span class="lineNum">     269 </span><span class="lineNoCov">          0 :           tlp-&gt;numscaletokens++;</span>
<span class="lineNum">     270 </span>            :         }
<span class="lineNum">     271 </span>            :       }
<span class="lineNum">     272 </span>            : 
<span class="lineNum">     273 </span><span class="lineCov">          1 :       if (layer-&gt;projection.numargs &gt; 0 &amp;&amp;</span>
<span class="lineNum">     274 </span><span class="lineCov">          1 :         EQUAL(layer-&gt;projection.args[0], &quot;auto&quot;))</span>
<span class="lineNum">     275 </span>            :       {
<span class="lineNum">     276 </span><span class="lineCov">          1 :           tlp-&gt;projection.numargs = 1;</span>
<span class="lineNum">     277 </span><span class="lineCov">          1 :           tlp-&gt;projection.args[0] = msStrdup(&quot;auto&quot;);</span>
<span class="lineNum">     278 </span>            :       }
<span class="lineNum">     279 </span>            : 
<span class="lineNum">     280 </span><span class="lineCov">          1 :       if (layer-&gt;filteritem)</span>
<span class="lineNum">     281 </span><span class="lineNoCov">          0 :         tlp-&gt;filteritem = msStrdup(layer-&gt;filteritem);</span>
<span class="lineNum">     282 </span><span class="lineCov">          1 :       if (layer-&gt;filter.string) {</span>
<span class="lineNum">     283 </span><span class="lineNoCov">          0 :         if (layer-&gt;filter.type == MS_EXPRESSION) {</span>
<span class="lineNum">     284 </span><span class="lineNoCov">          0 :           char* pszTmp =</span>
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :             (char *)msSmallMalloc(sizeof(char)*(strlen(layer-&gt;filter.string)+3));</span>
<span class="lineNum">     286 </span><span class="lineNoCov">          0 :           sprintf(pszTmp,&quot;(%s)&quot;,layer-&gt;filter.string);</span>
<span class="lineNum">     287 </span><span class="lineNoCov">          0 :           msLoadExpressionString(&amp;tlp-&gt;filter, pszTmp);</span>
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :           free(pszTmp);</span>
<span class="lineNum">     289 </span><span class="lineNoCov">          0 :         } else if (layer-&gt;filter.type == MS_REGEX ||</span>
<span class="lineNum">     290 </span>            :                    layer-&gt;filter.type == MS_IREGEX) {
<span class="lineNum">     291 </span><span class="lineNoCov">          0 :           char* pszTmp =</span>
<span class="lineNum">     292 </span><span class="lineNoCov">          0 :             (char *)msSmallMalloc(sizeof(char)*(strlen(layer-&gt;filter.string)+3));</span>
<span class="lineNum">     293 </span><span class="lineNoCov">          0 :           sprintf(pszTmp,&quot;/%s/&quot;,layer-&gt;filter.string);</span>
<span class="lineNum">     294 </span><span class="lineNoCov">          0 :           msLoadExpressionString(&amp;tlp-&gt;filter, pszTmp);</span>
<span class="lineNum">     295 </span><span class="lineNoCov">          0 :           free(pszTmp);</span>
<span class="lineNum">     296 </span>            :         } else
<span class="lineNum">     297 </span><span class="lineNoCov">          0 :           msLoadExpressionString(&amp;tlp-&gt;filter, layer-&gt;filter.string);</span>
<span class="lineNum">     298 </span>            : 
<span class="lineNum">     299 </span><span class="lineNoCov">          0 :         tlp-&gt;filter.type = layer-&gt;filter.type;</span>
<span class="lineNum">     300 </span>            :       }
<span class="lineNum">     301 </span>            : 
<span class="lineNum">     302 </span>            :     } else {
<span class="lineNum">     303 </span><span class="lineCov">          1 :       if ( msCheckParentPointer(layer-&gt;map,&quot;map&quot;)==MS_FAILURE )</span>
<span class="lineNum">     304 </span>            :         return MS_FAILURE;
<span class="lineNum">     305 </span><span class="lineCov">          1 :       tlp = (GET_LAYER(layer-&gt;map, *ptilelayerindex));</span>
<span class="lineNum">     306 </span><span class="lineCov">          1 :       *ptlp = tlp;</span>
<span class="lineNum">     307 </span>            :     }
<span class="lineNum">     308 </span><span class="lineCov">          1 :     status = msLayerOpen(tlp);</span>
<span class="lineNum">     309 </span><span class="lineCov">          1 :     if(status != MS_SUCCESS) {</span>
<span class="lineNum">     310 </span>            :       return status;
<span class="lineNum">     311 </span>            :     }
<span class="lineNum">     312 </span>            : 
<span class="lineNum">     313 </span>            :     /* fetch tileitem and tilesrs fields */
<span class="lineNum">     314 </span><span class="lineCov">          1 :     requested_fields = (char*) msSmallMalloc(sizeof(char)*(strlen(layer-&gt;tileitem)+1+</span>
<span class="lineNum">     315 </span><span class="lineCov">          1 :                                     (layer-&gt;tilesrs ? strlen(layer-&gt;tilesrs) : 0) + 1));</span>
<span class="lineNum">     316 </span><span class="lineCov">          1 :     if( layer-&gt;tilesrs != NULL )</span>
<span class="lineNum">     317 </span><span class="lineCov">          1 :         sprintf(requested_fields, &quot;%s,%s&quot;, layer-&gt;tileitem, layer-&gt;tilesrs);</span>
<span class="lineNum">     318 </span>            :     else
<span class="lineNum">     319 </span><span class="lineCov">          1 :         strcpy(requested_fields, layer-&gt;tileitem);</span>
<span class="lineNum">     320 </span><span class="lineCov">          1 :     status = msLayerWhichItems(tlp, MS_FALSE, requested_fields);</span>
<span class="lineNum">     321 </span><span class="lineCov">          1 :     msFree(requested_fields);</span>
<span class="lineNum">     322 </span><span class="lineCov">          1 :     if(status != MS_SUCCESS) {</span>
<span class="lineNum">     323 </span>            :       return status;
<span class="lineNum">     324 </span>            :     }
<span class="lineNum">     325 </span>            : 
<span class="lineNum">     326 </span>            :     /* get the tileitem and tilesrs index */
<span class="lineNum">     327 </span><span class="lineCov">          1 :     for(i=0; i&lt;tlp-&gt;numitems; i++) {</span>
<span class="lineNum">     328 </span><span class="lineCov">          1 :       if(strcasecmp(tlp-&gt;items[i], layer-&gt;tileitem) == 0) {</span>
<span class="lineNum">     329 </span><span class="lineCov">          1 :         *ptileitemindex = i;</span>
<span class="lineNum">     330 </span>            :       }
<span class="lineNum">     331 </span><span class="lineCov">          1 :       if(layer-&gt;tilesrs != NULL &amp;&amp;</span>
<span class="lineNum">     332 </span><span class="lineCov">          1 :          strcasecmp(tlp-&gt;items[i], layer-&gt;tilesrs) == 0) {</span>
<span class="lineNum">     333 </span><span class="lineCov">          1 :         *ptilesrsindex = i;</span>
<span class="lineNum">     334 </span>            :       }
<span class="lineNum">     335 </span>            :     }
<span class="lineNum">     336 </span><span class="lineCov">          1 :     if(*ptileitemindex &lt; 0) { /* didn't find it */</span>
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :       msSetError(MS_MEMERR,</span>
<span class="lineNum">     338 </span>            :                  &quot;Could not find attribute %s in tileindex.&quot;,
<span class="lineNum">     339 </span>            :                  &quot;msDrawRasterLayerLow()&quot;,
<span class="lineNum">     340 </span>            :                  layer-&gt;tileitem);
<span class="lineNum">     341 </span><span class="lineNoCov">          0 :       return MS_FAILURE;</span>
<span class="lineNum">     342 </span>            :     }
<span class="lineNum">     343 </span><span class="lineCov">          1 :     if(layer-&gt;tilesrs != NULL &amp;&amp; *ptilesrsindex &lt; 0) { /* didn't find it */</span>
<span class="lineNum">     344 </span><span class="lineNoCov">          0 :       msSetError(MS_MEMERR,</span>
<span class="lineNum">     345 </span>            :                  &quot;Could not find attribute %s in tileindex.&quot;,
<span class="lineNum">     346 </span>            :                  &quot;msDrawRasterLayerLow()&quot;,
<span class="lineNum">     347 </span>            :                  layer-&gt;tilesrs);
<span class="lineNum">     348 </span><span class="lineNoCov">          0 :       return MS_FAILURE;</span>
<span class="lineNum">     349 </span>            :     }
<span class="lineNum">     350 </span>            : 
<span class="lineNum">     351 </span>            :     /* if necessary, project the searchrect to source coords */
<span class="lineNum">     352 </span><span class="lineCov">          1 :     if((map-&gt;projection.numargs &gt; 0) &amp;&amp; (layer-&gt;projection.numargs &gt; 0) &amp;&amp;</span>
<span class="lineNum">     353 </span><span class="lineCov">          1 :         !EQUAL(layer-&gt;projection.args[0], &quot;auto&quot;)) {</span>
<span class="lineNum">     354 </span><span class="lineCov">          1 :       if( msProjectRect(&amp;map-&gt;projection, &amp;layer-&gt;projection, psearchrect)</span>
<span class="lineNum">     355 </span>            :           != MS_SUCCESS ) {
<span class="lineNum">     356 </span><span class="lineNoCov">          0 :         msDebug( &quot;msDrawRasterLayerLow(%s): unable to reproject map request rectangle into layer projection, canceling.\n&quot;, layer-&gt;name );</span>
<span class="lineNum">     357 </span><span class="lineNoCov">          0 :         return MS_FAILURE;</span>
<span class="lineNum">     358 </span>            :       }
<span class="lineNum">     359 </span>            :     }
<span class="lineNum">     360 </span><span class="lineCov">          1 :     else if((map-&gt;projection.numargs &gt; 0) &amp;&amp; (tlp-&gt;projection.numargs &gt; 0) &amp;&amp;</span>
<span class="lineNum">     361 </span><span class="lineCov">          1 :         !EQUAL(tlp-&gt;projection.args[0], &quot;auto&quot;)) {</span>
<span class="lineNum">     362 </span><span class="lineCov">          1 :       if( msProjectRect(&amp;map-&gt;projection, &amp;tlp-&gt;projection, psearchrect)</span>
<span class="lineNum">     363 </span>            :           != MS_SUCCESS ) {
<span class="lineNum">     364 </span><span class="lineNoCov">          0 :         msDebug( &quot;msDrawRasterLayerLow(%s): unable to reproject map request rectangle into layer projection, canceling.\n&quot;, layer-&gt;name );</span>
<span class="lineNum">     365 </span><span class="lineNoCov">          0 :         return MS_FAILURE;</span>
<span class="lineNum">     366 </span>            :       }
<span class="lineNum">     367 </span>            :     }
<span class="lineNum">     368 </span><span class="lineCov">          1 :     return msLayerWhichShapes(tlp, *psearchrect, MS_FALSE);</span>
<span class="lineNum">     369 </span>            : }
<span class="lineNum">     370 </span>            : 
<span class="lineNum">     371 </span>            : /************************************************************************/
<span class="lineNum">     372 </span>            : /*                msDrawRasterCleanupTileLayer()                        */
<span class="lineNum">     373 </span>            : /*                                                                      */
<span class="lineNum">     374 </span>            : /*      Cleanup the tile layer.                                         */
<a name="375"><span class="lineNum">     375 </span>            : /************************************************************************/</a>
<span class="lineNum">     376 </span>            : 
<span class="lineNum">     377 </span><span class="lineCov">          1 : void msDrawRasterCleanupTileLayer(layerObj* tlp,</span>
<span class="lineNum">     378 </span>            :                                   int tilelayerindex)
<span class="lineNum">     379 </span>            : {
<span class="lineNum">     380 </span><span class="lineCov">          1 :     msLayerClose(tlp);</span>
<span class="lineNum">     381 </span><span class="lineCov">          1 :     if(tilelayerindex == -1) {</span>
<span class="lineNum">     382 </span><span class="lineCov">          1 :       freeLayer(tlp);</span>
<span class="lineNum">     383 </span><span class="lineCov">          1 :       free(tlp);</span>
<span class="lineNum">     384 </span>            :     }
<span class="lineNum">     385 </span><span class="lineCov">          1 : }</span>
<span class="lineNum">     386 </span>            : 
<span class="lineNum">     387 </span>            : /************************************************************************/
<span class="lineNum">     388 </span>            : /*                   msDrawRasterIterateTileIndex()                     */
<span class="lineNum">     389 </span>            : /*                                                                      */
<span class="lineNum">     390 </span>            : /*      Iterate over the tile layer.                                    */
<a name="391"><span class="lineNum">     391 </span>            : /************************************************************************/</a>
<span class="lineNum">     392 </span>            : 
<span class="lineNum">     393 </span><span class="lineCov">          1 : int msDrawRasterIterateTileIndex(layerObj *layer,</span>
<span class="lineNum">     394 </span>            :                                  layerObj* tlp,
<span class="lineNum">     395 </span>            :                                  shapeObj* ptshp, /* input-output */
<span class="lineNum">     396 </span>            :                                  int tileitemindex,
<span class="lineNum">     397 </span>            :                                  int tilesrsindex,
<span class="lineNum">     398 </span>            :                                  char* tilename, /* output */
<span class="lineNum">     399 </span>            :                                  size_t sizeof_tilename,
<span class="lineNum">     400 </span>            :                                  char* tilesrsname, /* output */
<span class="lineNum">     401 </span>            :                                  size_t sizeof_tilesrsname)
<span class="lineNum">     402 </span>            : {
<span class="lineNum">     403 </span>            :       int status;
<span class="lineNum">     404 </span>            : 
<span class="lineNum">     405 </span><span class="lineCov">          1 :       status = msLayerNextShape(tlp, ptshp);</span>
<span class="lineNum">     406 </span><span class="lineCov">          1 :       if( status == MS_FAILURE || status == MS_DONE ) {</span>
<span class="lineNum">     407 </span>            :         return status;
<span class="lineNum">     408 </span>            :       }
<span class="lineNum">     409 </span>            : 
<span class="lineNum">     410 </span><span class="lineCov">          1 :       if(layer-&gt;data == NULL || strlen(layer-&gt;data) == 0 ) { /* assume whole filename is in attribute field */</span>
<span class="lineNum">     411 </span><span class="lineCov">          1 :         strlcpy( tilename, ptshp-&gt;values[tileitemindex], sizeof_tilename);</span>
<span class="lineNum">     412 </span>            :       } else
<span class="lineNum">     413 </span><span class="lineNoCov">          0 :         snprintf(tilename, sizeof_tilename, &quot;%s/%s&quot;, ptshp-&gt;values[tileitemindex], layer-&gt;data);</span>
<span class="lineNum">     414 </span>            : 
<span class="lineNum">     415 </span><span class="lineCov">          1 :       tilesrsname[0] = '\0';</span>
<span class="lineNum">     416 </span>            : 
<span class="lineNum">     417 </span><span class="lineCov">          1 :       if( tilesrsindex &gt;= 0 )</span>
<span class="lineNum">     418 </span>            :       {
<span class="lineNum">     419 </span><span class="lineCov">          1 :         if(ptshp-&gt;values[tilesrsindex] != NULL )</span>
<span class="lineNum">     420 </span><span class="lineCov">          1 :           strlcpy( tilesrsname, ptshp-&gt;values[tilesrsindex], sizeof_tilesrsname );</span>
<span class="lineNum">     421 </span>            :       }
<span class="lineNum">     422 </span>            : 
<span class="lineNum">     423 </span><span class="lineCov">          1 :       msFreeShape(ptshp); /* done with the shape */</span>
<span class="lineNum">     424 </span>            : 
<span class="lineNum">     425 </span><span class="lineCov">          1 :       return status;</span>
<span class="lineNum">     426 </span>            : }
<span class="lineNum">     427 </span>            : 
<span class="lineNum">     428 </span>            : /************************************************************************/
<span class="lineNum">     429 </span>            : /*                   msDrawRasterBuildRasterPath()                      */
<span class="lineNum">     430 </span>            : /*                                                                      */
<span class="lineNum">     431 </span>            : /*      Build the path of the raster to open.                           */
<a name="432"><span class="lineNum">     432 </span>            : /************************************************************************/</a>
<span class="lineNum">     433 </span>            : 
<span class="lineNum">     434 </span><span class="lineCov">          1 : int msDrawRasterBuildRasterPath(mapObj *map, layerObj *layer,</span>
<span class="lineNum">     435 </span>            :                                 const char* filename,
<span class="lineNum">     436 </span>            :                                 char szPath[MS_MAXPATHLEN] /* output */)
<span class="lineNum">     437 </span>            : {
<span class="lineNum">     438 </span>            :     /*
<span class="lineNum">     439 </span>            :     ** If using a tileindex then build the path relative to that file if SHAPEPATH is not set.
<span class="lineNum">     440 </span>            :     */
<span class="lineNum">     441 </span><span class="lineCov">          1 :     if(layer-&gt;tileindex &amp;&amp; !map-&gt;shapepath) {</span>
<span class="lineNum">     442 </span>            :       char tiAbsFilePath[MS_MAXPATHLEN];
<span class="lineNum">     443 </span>            :       char *tiAbsDirPath = NULL;
<span class="lineNum">     444 </span>            : 
<span class="lineNum">     445 </span><span class="lineCov">          1 :       msTryBuildPath(tiAbsFilePath, map-&gt;mappath, layer-&gt;tileindex); /* absolute path to tileindex file */</span>
<span class="lineNum">     446 </span><span class="lineCov">          1 :       tiAbsDirPath = msGetPath(tiAbsFilePath); /* tileindex file's directory */</span>
<span class="lineNum">     447 </span><span class="lineCov">          1 :       msBuildPath(szPath, tiAbsDirPath, filename);</span>
<span class="lineNum">     448 </span><span class="lineCov">          1 :       free(tiAbsDirPath);</span>
<span class="lineNum">     449 </span>            :     } else {
<span class="lineNum">     450 </span><span class="lineCov">          1 :       msTryBuildPath3(szPath, map-&gt;mappath, map-&gt;shapepath, filename);</span>
<span class="lineNum">     451 </span>            :     }
<span class="lineNum">     452 </span>            : 
<span class="lineNum">     453 </span><span class="lineCov">          1 :     return MS_SUCCESS;</span>
<span class="lineNum">     454 </span>            : }
<span class="lineNum">     455 </span>            : 
<span class="lineNum">     456 </span>            : /************************************************************************/
<span class="lineNum">     457 </span>            : /*                   msDrawRasterGetCPLErrorMsg()                       */
<span class="lineNum">     458 </span>            : /*                                                                      */
<span class="lineNum">     459 </span>            : /*      Return the CPL error message, and filter out sensitive info.    */
<a name="460"><span class="lineNum">     460 </span>            : /************************************************************************/</a>
<span class="lineNum">     461 </span>            : 
<span class="lineNum">     462 </span><span class="lineNoCov">          0 : const char* msDrawRasterGetCPLErrorMsg(const char* decrypted_path,</span>
<span class="lineNum">     463 </span>            :                                        const char* szPath)
<span class="lineNum">     464 </span>            : {
<span class="lineNum">     465 </span><span class="lineNoCov">          0 :       const char *cpl_error_msg = CPLGetLastErrorMsg();</span>
<span class="lineNum">     466 </span>            : 
<span class="lineNum">     467 </span>            :       /* we wish to avoid reporting decrypted paths */
<span class="lineNum">     468 </span><span class="lineNoCov">          0 :       if( cpl_error_msg != NULL</span>
<span class="lineNum">     469 </span><span class="lineNoCov">          0 :           &amp;&amp; strstr(cpl_error_msg,decrypted_path) != NULL</span>
<span class="lineNum">     470 </span><span class="lineNoCov">          0 :           &amp;&amp; strcmp(decrypted_path,szPath) != 0 )</span>
<span class="lineNum">     471 </span>            :         cpl_error_msg = NULL;
<span class="lineNum">     472 </span>            : 
<span class="lineNum">     473 </span>            :       /* we wish to avoid reporting the stock GDALOpen error messages */
<span class="lineNum">     474 </span><span class="lineNoCov">          0 :       if( cpl_error_msg != NULL</span>
<span class="lineNum">     475 </span><span class="lineNoCov">          0 :           &amp;&amp; (strstr(cpl_error_msg,&quot;not recognised as a supported&quot;) != NULL</span>
<span class="lineNum">     476 </span><span class="lineNoCov">          0 :               || strstr(cpl_error_msg,&quot;does not exist&quot;) != NULL) )</span>
<span class="lineNum">     477 </span>            :         cpl_error_msg = NULL;
<span class="lineNum">     478 </span>            : 
<span class="lineNum">     479 </span><span class="lineNoCov">          0 :       if( cpl_error_msg == NULL )</span>
<span class="lineNum">     480 </span>            :         cpl_error_msg = &quot;&quot;;
<span class="lineNum">     481 </span>            : 
<span class="lineNum">     482 </span><span class="lineNoCov">          0 :       return cpl_error_msg;</span>
<span class="lineNum">     483 </span>            : }
<span class="lineNum">     484 </span>            : 
<span class="lineNum">     485 </span>            : /************************************************************************/
<span class="lineNum">     486 </span>            : /*                   msDrawRasterLoadProjection()                       */
<span class="lineNum">     487 </span>            : /*                                                                      */
<span class="lineNum">     488 </span>            : /*      Handle TILESRS or PROJECTION AUTO for each tile.                */
<a name="489"><span class="lineNum">     489 </span>            : /************************************************************************/</a>
<span class="lineNum">     490 </span>            : 
<span class="lineNum">     491 </span><span class="lineCov">          1 : int msDrawRasterLoadProjection(layerObj *layer,</span>
<span class="lineNum">     492 </span>            :                                GDALDatasetH hDS,
<span class="lineNum">     493 </span>            :                                const char* filename,
<span class="lineNum">     494 </span>            :                                int tilesrsindex,
<span class="lineNum">     495 </span>            :                                const char* tilesrsname)
<span class="lineNum">     496 </span>            : {
<span class="lineNum">     497 </span>            :     /*
<span class="lineNum">     498 </span>            :     ** Generate the projection information if using TILESRS.
<span class="lineNum">     499 </span>            :     */
<span class="lineNum">     500 </span><span class="lineCov">          1 :     if( tilesrsindex &gt;= 0 )</span>
<span class="lineNum">     501 </span>            :     {
<span class="lineNum">     502 </span>            :         const char *pszWKT;
<span class="lineNum">     503 </span><span class="lineCov">          1 :         if( tilesrsname[0] != '\0' )</span>
<span class="lineNum">     504 </span>            :             pszWKT = tilesrsname;
<span class="lineNum">     505 </span>            :         else
<span class="lineNum">     506 </span><span class="lineCov">          1 :             pszWKT = GDALGetProjectionRef( hDS );</span>
<span class="lineNum">     507 </span><span class="lineCov">          1 :         if( pszWKT != NULL &amp;&amp; strlen(pszWKT) &gt; 0 ) {</span>
<span class="lineNum">     508 </span><span class="lineCov">          1 :           if( msOGCWKT2ProjectionObj(pszWKT, &amp;(layer-&gt;projection),</span>
<span class="lineNum">     509 </span>            :                                     layer-&gt;debug ) != MS_SUCCESS ) {
<span class="lineNum">     510 </span>            :           char  szLongMsg[MESSAGELENGTH*2];
<span class="lineNum">     511 </span><span class="lineNoCov">          0 :           errorObj *ms_error = msGetErrorObj();</span>
<span class="lineNum">     512 </span>            : 
<span class="lineNum">     513 </span>            :           snprintf( szLongMsg, sizeof(szLongMsg),
<span class="lineNum">     514 </span>            :                     &quot;%s\n&quot;
<span class="lineNum">     515 </span>            :                     &quot;PROJECTION '%s' cannot be used for this &quot;
<span class="lineNum">     516 </span>            :                     &quot;GDAL raster (`%s').&quot;,
<span class="lineNum">     517 </span><span class="lineNoCov">          0 :                     ms_error-&gt;message, pszWKT, filename);</span>
<span class="lineNum">     518 </span><span class="lineNoCov">          0 :           szLongMsg[MESSAGELENGTH-1] = '\0';</span>
<span class="lineNum">     519 </span>            : 
<span class="lineNum">     520 </span><span class="lineNoCov">          0 :           msSetError(MS_OGRERR, &quot;%s&quot;,&quot;msDrawRasterLayer()&quot;,</span>
<span class="lineNum">     521 </span>            :                      szLongMsg);
<span class="lineNum">     522 </span>            : 
<span class="lineNum">     523 </span>            :           return MS_FAILURE;
<span class="lineNum">     524 </span>            :         }
<span class="lineNum">     525 </span>            :       }
<span class="lineNum">     526 </span>            :     }
<span class="lineNum">     527 </span>            :     /*
<span class="lineNum">     528 </span>            :     ** Generate the projection information if using AUTO.
<span class="lineNum">     529 </span>            :     */
<span class="lineNum">     530 </span><span class="lineCov">          1 :     else if (layer-&gt;projection.numargs &gt; 0 &amp;&amp;</span>
<span class="lineNum">     531 </span><span class="lineCov">          1 :         EQUAL(layer-&gt;projection.args[0], &quot;auto&quot;)) {</span>
<span class="lineNum">     532 </span>            :       const char *pszWKT;
<span class="lineNum">     533 </span>            : 
<span class="lineNum">     534 </span><span class="lineCov">          1 :       pszWKT = GDALGetProjectionRef( hDS );</span>
<span class="lineNum">     535 </span>            : 
<span class="lineNum">     536 </span><span class="lineCov">          1 :       if( pszWKT != NULL &amp;&amp; strlen(pszWKT) &gt; 0 ) {</span>
<span class="lineNum">     537 </span><span class="lineCov">          1 :         if( msOGCWKT2ProjectionObj(pszWKT, &amp;(layer-&gt;projection),</span>
<span class="lineNum">     538 </span>            :                                    layer-&gt;debug ) != MS_SUCCESS ) {
<span class="lineNum">     539 </span>            :           char  szLongMsg[MESSAGELENGTH*2];
<span class="lineNum">     540 </span><span class="lineNoCov">          0 :           errorObj *ms_error = msGetErrorObj();</span>
<span class="lineNum">     541 </span>            : 
<span class="lineNum">     542 </span>            :           snprintf( szLongMsg, sizeof(szLongMsg),
<span class="lineNum">     543 </span>            :                     &quot;%s\n&quot;
<span class="lineNum">     544 </span>            :                     &quot;PROJECTION AUTO cannot be used for this &quot;
<span class="lineNum">     545 </span>            :                     &quot;GDAL raster (`%s').&quot;,
<span class="lineNum">     546 </span><span class="lineNoCov">          0 :                     ms_error-&gt;message, filename);</span>
<span class="lineNum">     547 </span><span class="lineNoCov">          0 :           szLongMsg[MESSAGELENGTH-1] = '\0';</span>
<span class="lineNum">     548 </span>            : 
<span class="lineNum">     549 </span><span class="lineNoCov">          0 :           msSetError(MS_OGRERR, &quot;%s&quot;,&quot;msDrawRasterLayer()&quot;,</span>
<span class="lineNum">     550 </span>            :                      szLongMsg);
<span class="lineNum">     551 </span>            : 
<span class="lineNum">     552 </span>            :           return MS_FAILURE;
<span class="lineNum">     553 </span>            :         }
<span class="lineNum">     554 </span>            :       }
<span class="lineNum">     555 </span>            :     }
<span class="lineNum">     556 </span>            : 
<span class="lineNum">     557 </span>            :     return MS_SUCCESS;
<span class="lineNum">     558 </span>            : }
<span class="lineNum">     559 </span>            : 
<span class="lineNum">     560 </span>            : typedef enum
<span class="lineNum">     561 </span>            : {
<span class="lineNum">     562 </span>            :     CDRT_OK,
<span class="lineNum">     563 </span>            :     CDRT_RETURN_MS_FAILURE,
<span class="lineNum">     564 </span>            :     CDRT_CONTINUE_NEXT_TILE
<span class="lineNum">     565 </span>            : } CheckDatasetReturnType;
<span class="lineNum">     566 </span>            : 
<span class="lineNum">     567 </span>            : /************************************************************************/
<span class="lineNum">     568 </span>            : /*              msDrawRasterLayerLowCheckDataset()                      */
<span class="lineNum">     569 </span>            : /************************************************************************/
<a name="570"><span class="lineNum">     570 </span>            : </a>
<span class="lineNum">     571 </span>            : static
<span class="lineNum">     572 </span><span class="lineCov">          1 : CheckDatasetReturnType msDrawRasterLayerLowCheckDataset(mapObj *map,</span>
<span class="lineNum">     573 </span>            :                                      layerObj *layer,
<span class="lineNum">     574 </span>            :                                      GDALDatasetH hDS,
<span class="lineNum">     575 </span>            :                                      const char* decrypted_path,
<span class="lineNum">     576 </span>            :                                      const char* szPath)
<span class="lineNum">     577 </span>            : {
<span class="lineNum">     578 </span>            :     /*
<span class="lineNum">     579 </span>            :     ** If GDAL doesn't recognise it, and it wasn't successfully opened
<span class="lineNum">     580 </span>            :     ** Generate an error.
<span class="lineNum">     581 </span>            :     */
<span class="lineNum">     582 </span><span class="lineCov">          1 :     if(hDS == NULL) {</span>
<span class="lineNum">     583 </span><span class="lineNoCov">          0 :       int ignore_missing = msMapIgnoreMissingData(map);</span>
<span class="lineNum">     584 </span><span class="lineNoCov">          0 :       const char *cpl_error_msg = msDrawRasterGetCPLErrorMsg(decrypted_path, szPath);</span>
<span class="lineNum">     585 </span>            : 
<span class="lineNum">     586 </span><span class="lineNoCov">          0 :       if(ignore_missing == MS_MISSING_DATA_FAIL) {</span>
<span class="lineNum">     587 </span><span class="lineNoCov">          0 :         msSetError(MS_IOERR, &quot;Corrupt, empty or missing file '%s' for layer '%s'. %s&quot;, &quot;msDrawRasterLayerLow()&quot;, szPath, layer-&gt;name, cpl_error_msg );</span>
<span class="lineNum">     588 </span><span class="lineNoCov">          0 :         return(CDRT_RETURN_MS_FAILURE);</span>
<span class="lineNum">     589 </span><span class="lineNoCov">          0 :       } else if( ignore_missing == MS_MISSING_DATA_LOG ) {</span>
<span class="lineNum">     590 </span><span class="lineNoCov">          0 :         if( layer-&gt;debug || layer-&gt;map-&gt;debug ) {</span>
<span class="lineNum">     591 </span><span class="lineNoCov">          0 :           msDebug( &quot;Corrupt, empty or missing file '%s' for layer '%s' ... ignoring this missing data.  %s\n&quot;, szPath, layer-&gt;name, cpl_error_msg );</span>
<span class="lineNum">     592 </span>            :         }
<span class="lineNum">     593 </span>            :         return(CDRT_CONTINUE_NEXT_TILE);
<span class="lineNum">     594 </span><span class="lineNoCov">          0 :       } else if( ignore_missing == MS_MISSING_DATA_IGNORE ) {</span>
<span class="lineNum">     595 </span>            :         return(CDRT_CONTINUE_NEXT_TILE);
<span class="lineNum">     596 </span>            :       } else {
<span class="lineNum">     597 </span>            :         /* never get here */
<span class="lineNum">     598 </span><span class="lineNoCov">          0 :         msSetError(MS_IOERR, &quot;msIgnoreMissingData returned unexpected value.&quot;, &quot;msDrawRasterLayerLow()&quot;);</span>
<span class="lineNum">     599 </span><span class="lineNoCov">          0 :         return(CDRT_RETURN_MS_FAILURE);</span>
<span class="lineNum">     600 </span>            :       }
<span class="lineNum">     601 </span>            :     }
<span class="lineNum">     602 </span>            : 
<span class="lineNum">     603 </span>            :     return CDRT_OK;
<span class="lineNum">     604 </span>            : }
<span class="lineNum">     605 </span>            : 
<span class="lineNum">     606 </span>            : /************************************************************************/
<span class="lineNum">     607 </span>            : /*              msDrawRasterLayerLowOpenDataset()                       */
<a name="608"><span class="lineNum">     608 </span>            : /************************************************************************/</a>
<span class="lineNum">     609 </span>            : 
<span class="lineNum">     610 </span><span class="lineCov">          1 : void* msDrawRasterLayerLowOpenDataset(mapObj *map, layerObj *layer,</span>
<span class="lineNum">     611 </span>            :                                       const char* filename,
<span class="lineNum">     612 </span>            :                                       char szPath[MS_MAXPATHLEN],
<span class="lineNum">     613 </span>            :                                       char** p_decrypted_path)
<span class="lineNum">     614 </span>            : {
<span class="lineNum">     615 </span>            :   const char* pszPath;
<span class="lineNum">     616 </span>            : 
<span class="lineNum">     617 </span><span class="lineCov">          1 :   msGDALInitialize();</span>
<span class="lineNum">     618 </span>            : 
<span class="lineNum">     619 </span><span class="lineCov">          1 :   if(layer-&gt;debug == MS_TRUE)</span>
<span class="lineNum">     620 </span><span class="lineCov">          1 :     msDebug( &quot;msDrawRasterLayerLow(%s): Filename is: %s\n&quot;, layer-&gt;name, filename);</span>
<span class="lineNum">     621 </span>            : 
<span class="lineNum">     622 </span><span class="lineCov">          1 :   if( strncmp(filename, &quot;&lt;VRTDataset&quot;, strlen(&quot;&lt;VRTDataset&quot;)) == 0 )</span>
<span class="lineNum">     623 </span>            :   {
<span class="lineNum">     624 </span>            :     pszPath = filename;
<span class="lineNum">     625 </span>            :   }
<span class="lineNum">     626 </span>            :   else
<span class="lineNum">     627 </span>            :   {
<span class="lineNum">     628 </span><span class="lineCov">          1 :     msDrawRasterBuildRasterPath(map, layer, filename, szPath);</span>
<span class="lineNum">     629 </span>            :     pszPath = szPath;
<span class="lineNum">     630 </span>            :   }
<span class="lineNum">     631 </span><span class="lineCov">          1 :   if(layer-&gt;debug == MS_TRUE)</span>
<span class="lineNum">     632 </span><span class="lineCov">          1 :     msDebug(&quot;msDrawRasterLayerLow(%s): Path is: %s\n&quot;, layer-&gt;name, pszPath);</span>
<span class="lineNum">     633 </span>            : 
<span class="lineNum">     634 </span>            :     /*
<span class="lineNum">     635 </span>            :     ** Note: because we do decryption after the above path expansion
<span class="lineNum">     636 </span>            :     ** which depends on actually finding a file, it essentially means that
<span class="lineNum">     637 </span>            :     ** fancy path manipulation is essentially disabled when using encrypted
<span class="lineNum">     638 </span>            :     ** components. But that is mostly ok, since stuff like sde,postgres and
<span class="lineNum">     639 </span>            :     ** oracle georaster do not use real paths.
<span class="lineNum">     640 </span>            :     */
<span class="lineNum">     641 </span><span class="lineCov">          1 :   *p_decrypted_path = msDecryptStringTokens( map, pszPath );</span>
<span class="lineNum">     642 </span><span class="lineCov">          1 :   if( *p_decrypted_path == NULL )</span>
<span class="lineNum">     643 </span>            :     return NULL;
<span class="lineNum">     644 </span>            : 
<span class="lineNum">     645 </span><span class="lineCov">          1 :   msAcquireLock( TLOCK_GDAL );</span>
<span class="lineNum">     646 </span><span class="lineCov">          1 :   if( !layer-&gt;tileindex )</span>
<span class="lineNum">     647 </span>            :   {
<span class="lineNum">     648 </span><span class="lineCov">          1 :     char** connectionoptions = msGetStringListFromHashTable(&amp;(layer-&gt;connectionoptions));</span>
<span class="lineNum">     649 </span><span class="lineCov">          1 :     GDALDatasetH hDS = GDALOpenEx( *p_decrypted_path,</span>
<span class="lineNum">     650 </span>            :                                    GDAL_OF_RASTER | GDAL_OF_SHARED,
<span class="lineNum">     651 </span>            :                                    NULL,
<span class="lineNum">     652 </span>            :                                    (const char* const*)connectionoptions,
<span class="lineNum">     653 </span>            :                                    NULL);
<span class="lineNum">     654 </span><span class="lineCov">          1 :     CSLDestroy(connectionoptions);</span>
<span class="lineNum">     655 </span><span class="lineCov">          1 :     return hDS;</span>
<span class="lineNum">     656 </span>            :   }
<span class="lineNum">     657 </span>            :   else
<span class="lineNum">     658 </span>            :   {
<span class="lineNum">     659 </span><span class="lineCov">          1 :     return GDALOpenShared( *p_decrypted_path, GA_ReadOnly );</span>
<span class="lineNum">     660 </span>            :   }
<span class="lineNum">     661 </span>            : }
<span class="lineNum">     662 </span>            : 
<span class="lineNum">     663 </span>            : /************************************************************************/
<span class="lineNum">     664 </span>            : /*                msDrawRasterLayerLowCloseDataset()                    */
<a name="665"><span class="lineNum">     665 </span>            : /************************************************************************/</a>
<span class="lineNum">     666 </span>            : 
<span class="lineNum">     667 </span><span class="lineCov">          1 : void msDrawRasterLayerLowCloseDataset(layerObj *layer, void* hDS)</span>
<span class="lineNum">     668 </span>            : {
<span class="lineNum">     669 </span><span class="lineCov">          1 :     if( hDS )</span>
<span class="lineNum">     670 </span>            :     {
<span class="lineNum">     671 </span>            :       const char *close_connection;
<span class="lineNum">     672 </span><span class="lineCov">          1 :       close_connection = msLayerGetProcessingKey( layer,</span>
<span class="lineNum">     673 </span>            :                        &quot;CLOSE_CONNECTION&quot; );
<span class="lineNum">     674 </span>            : 
<span class="lineNum">     675 </span><span class="lineCov">          1 :       if( close_connection == NULL &amp;&amp; layer-&gt;tileindex == NULL )</span>
<span class="lineNum">     676 </span>            :         close_connection = &quot;DEFER&quot;;
<span class="lineNum">     677 </span>            : 
<span class="lineNum">     678 </span>            :       {
<span class="lineNum">     679 </span>            :         /* Due to how GDAL processes OVERVIEW_LEVEL, datasets returned are */
<span class="lineNum">     680 </span>            :         /* not shared, despite being asked to, so close them for real */
<span class="lineNum">     681 </span><span class="lineCov">          1 :         char** connectionoptions = msGetStringListFromHashTable(&amp;(layer-&gt;connectionoptions));</span>
<span class="lineNum">     682 </span><span class="lineCov">          1 :         if( CSLFetchNameValue(connectionoptions, &quot;OVERVIEW_LEVEL&quot;) )</span>
<span class="lineNum">     683 </span>            :             close_connection = NULL;
<span class="lineNum">     684 </span><span class="lineCov">          1 :         CSLDestroy(connectionoptions);</span>
<span class="lineNum">     685 </span>            :       }
<span class="lineNum">     686 </span>            : 
<span class="lineNum">     687 </span><span class="lineCov">          1 :       if( close_connection != NULL</span>
<span class="lineNum">     688 </span><span class="lineCov">          1 :           &amp;&amp; strcasecmp(close_connection,&quot;DEFER&quot;) == 0 ) {</span>
<span class="lineNum">     689 </span><span class="lineCov">          1 :         GDALDereferenceDataset( (GDALDatasetH)hDS );</span>
<span class="lineNum">     690 </span>            :       } else {
<span class="lineNum">     691 </span><span class="lineCov">          1 :         GDALClose( (GDALDatasetH)hDS );</span>
<span class="lineNum">     692 </span>            :       }
<span class="lineNum">     693 </span><span class="lineCov">          1 :       msReleaseLock( TLOCK_GDAL );</span>
<span class="lineNum">     694 </span>            :     }
<span class="lineNum">     695 </span><span class="lineCov">          1 : }</span>
<span class="lineNum">     696 </span>            : 
<span class="lineNum">     697 </span>            : 
<span class="lineNum">     698 </span>            : /************************************************************************/
<span class="lineNum">     699 </span>            : /*                msDrawRasterLayerLowCheckIfMustDraw()                 */
<span class="lineNum">     700 </span>            : /*                                                                      */
<span class="lineNum">     701 </span>            : /*      Return 1 if the layer should be drawn.                          */
<a name="702"><span class="lineNum">     702 </span>            : /************************************************************************/</a>
<span class="lineNum">     703 </span>            : 
<span class="lineNum">     704 </span><span class="lineCov">          1 : int msDrawRasterLayerLowCheckIfMustDraw(mapObj *map, layerObj *layer)</span>
<span class="lineNum">     705 </span>            : {
<span class="lineNum">     706 </span><span class="lineCov">          1 :   if(!layer-&gt;data &amp;&amp; !layer-&gt;tileindex &amp;&amp; !(layer-&gt;connectiontype==MS_KERNELDENSITY)) {</span>
<span class="lineNum">     707 </span><span class="lineNoCov">          0 :     if(layer-&gt;debug == MS_TRUE)</span>
<span class="lineNum">     708 </span><span class="lineNoCov">          0 :       msDebug( &quot;msDrawRasterLayerLow(%s): layer data and tileindex NULL ... doing nothing.&quot;, layer-&gt;name );</span>
<span class="lineNum">     709 </span>            :     return(0);
<span class="lineNum">     710 </span>            :   }
<span class="lineNum">     711 </span>            : 
<span class="lineNum">     712 </span><span class="lineCov">          1 :   if((layer-&gt;status != MS_ON) &amp;&amp; (layer-&gt;status != MS_DEFAULT)) {</span>
<span class="lineNum">     713 </span><span class="lineNoCov">          0 :     if(layer-&gt;debug == MS_TRUE)</span>
<span class="lineNum">     714 </span><span class="lineNoCov">          0 :       msDebug( &quot;msDrawRasterLayerLow(%s): not status ON or DEFAULT, doing nothing.&quot;, layer-&gt;name );</span>
<span class="lineNum">     715 </span>            :     return(0);
<span class="lineNum">     716 </span>            :   }
<span class="lineNum">     717 </span>            : 
<span class="lineNum">     718 </span><span class="lineCov">          1 :   if(map-&gt;scaledenom &gt; 0) {</span>
<span class="lineNum">     719 </span><span class="lineCov">          1 :     if((layer-&gt;maxscaledenom &gt; 0) &amp;&amp; (map-&gt;scaledenom &gt; layer-&gt;maxscaledenom)) {</span>
<span class="lineNum">     720 </span><span class="lineNoCov">          0 :       if(layer-&gt;debug == MS_TRUE)</span>
<span class="lineNum">     721 </span><span class="lineNoCov">          0 :         msDebug( &quot;msDrawRasterLayerLow(%s): skipping, map scale %.2g &gt; MAXSCALEDENOM=%g\n&quot;,</span>
<span class="lineNum">     722 </span>            :                  layer-&gt;name, map-&gt;scaledenom, layer-&gt;maxscaledenom );
<span class="lineNum">     723 </span>            :       return(0);
<span class="lineNum">     724 </span>            :     }
<span class="lineNum">     725 </span><span class="lineCov">          1 :     if((layer-&gt;minscaledenom &gt; 0) &amp;&amp; (map-&gt;scaledenom &lt;= layer-&gt;minscaledenom)) {</span>
<span class="lineNum">     726 </span><span class="lineNoCov">          0 :       if(layer-&gt;debug == MS_TRUE)</span>
<span class="lineNum">     727 </span><span class="lineNoCov">          0 :         msDebug( &quot;msDrawRasterLayerLow(%s): skipping, map scale %.2g &lt; MINSCALEDENOM=%g\n&quot;,</span>
<span class="lineNum">     728 </span>            :                  layer-&gt;name, map-&gt;scaledenom, layer-&gt;minscaledenom );
<span class="lineNum">     729 </span>            :       return(0);
<span class="lineNum">     730 </span>            :     }
<span class="lineNum">     731 </span>            :   }
<span class="lineNum">     732 </span>            : 
<span class="lineNum">     733 </span><span class="lineCov">          1 :   if(layer-&gt;maxscaledenom &lt;= 0 &amp;&amp; layer-&gt;minscaledenom &lt;= 0) {</span>
<span class="lineNum">     734 </span><span class="lineCov">          1 :     if((layer-&gt;maxgeowidth &gt; 0) &amp;&amp; ((map-&gt;extent.maxx - map-&gt;extent.minx) &gt; layer-&gt;maxgeowidth)) {</span>
<span class="lineNum">     735 </span><span class="lineNoCov">          0 :       if(layer-&gt;debug == MS_TRUE)</span>
<span class="lineNum">     736 </span><span class="lineNoCov">          0 :         msDebug( &quot;msDrawRasterLayerLow(%s): skipping, map width %.2g &gt; MAXSCALEDENOM=%g\n&quot;, layer-&gt;name,</span>
<span class="lineNum">     737 </span>            :                  (map-&gt;extent.maxx - map-&gt;extent.minx), layer-&gt;maxgeowidth );
<span class="lineNum">     738 </span>            :       return(0);
<span class="lineNum">     739 </span>            :     }
<span class="lineNum">     740 </span><span class="lineCov">          1 :     if((layer-&gt;mingeowidth &gt; 0) &amp;&amp; ((map-&gt;extent.maxx - map-&gt;extent.minx) &lt; layer-&gt;mingeowidth)) {</span>
<span class="lineNum">     741 </span><span class="lineNoCov">          0 :       if(layer-&gt;debug == MS_TRUE)</span>
<span class="lineNum">     742 </span><span class="lineNoCov">          0 :         msDebug( &quot;msDrawRasterLayerLow(%s): skipping, map width %.2g &lt; MINSCALEDENOM=%g\n&quot;, layer-&gt;name,</span>
<span class="lineNum">     743 </span>            :                  (map-&gt;extent.maxx - map-&gt;extent.minx), layer-&gt;mingeowidth );
<span class="lineNum">     744 </span>            :       return(0);
<span class="lineNum">     745 </span>            :     }
<span class="lineNum">     746 </span>            :   }
<span class="lineNum">     747 </span>            : 
<span class="lineNum">     748 </span>            :   return 1;
<span class="lineNum">     749 </span>            : }
<span class="lineNum">     750 </span>            : 
<span class="lineNum">     751 </span>            : /************************************************************************/
<span class="lineNum">     752 </span>            : /*                        msDrawRasterLayerLow()                        */
<span class="lineNum">     753 </span>            : /*                                                                      */
<span class="lineNum">     754 </span>            : /*      Check for various file types and act appropriately.  Handle     */
<span class="lineNum">     755 </span>            : /*      tile indexing.                                                  */
<a name="756"><span class="lineNum">     756 </span>            : /************************************************************************/</a>
<span class="lineNum">     757 </span>            : 
<span class="lineNum">     758 </span><span class="lineCov">          1 : int msDrawRasterLayerLow(mapObj *map, layerObj *layer, imageObj *image,</span>
<span class="lineNum">     759 </span>            :                          rasterBufferObj *rb )
<span class="lineNum">     760 </span>            : {
<span class="lineNum">     761 </span><span class="lineCov">          1 :     return msDrawRasterLayerLowWithDataset(map, layer, image, rb, NULL);</span>
<a name="762"><span class="lineNum">     762 </span>            : }</a>
<span class="lineNum">     763 </span>            : 
<span class="lineNum">     764 </span><span class="lineCov">          1 : int msDrawRasterLayerLowWithDataset(mapObj *map, layerObj *layer, imageObj *image,</span>
<span class="lineNum">     765 </span>            :                                     rasterBufferObj *rb, void* hDatasetIn )
<span class="lineNum">     766 </span>            : {
<span class="lineNum">     767 </span>            :   /* -------------------------------------------------------------------- */
<span class="lineNum">     768 </span>            :   /*      As of MapServer 6.0 GDAL is required for rendering raster       */
<span class="lineNum">     769 </span>            :   /*      imagery.                                                        */
<span class="lineNum">     770 </span>            :   /* -------------------------------------------------------------------- */
<span class="lineNum">     771 </span>            :   int status, done;
<span class="lineNum">     772 </span>            :   char *filename=NULL, tilename[MS_MAXPATHLEN], tilesrsname[1024];
<span class="lineNum">     773 </span>            : 
<span class="lineNum">     774 </span><span class="lineCov">          1 :   layerObj *tlp=NULL; /* pointer to the tile layer either real or temporary */</span>
<span class="lineNum">     775 </span><span class="lineCov">          1 :   int tileitemindex=-1, tilelayerindex=-1, tilesrsindex=-1;</span>
<span class="lineNum">     776 </span>            :   shapeObj tshp;
<span class="lineNum">     777 </span>            : 
<span class="lineNum">     778 </span><span class="lineCov">          1 :   char szPath[MS_MAXPATHLEN] = { 0 };</span>
<span class="lineNum">     779 </span><span class="lineCov">          1 :   char *decrypted_path = NULL;</span>
<span class="lineNum">     780 </span>            :   int final_status = MS_SUCCESS;
<span class="lineNum">     781 </span>            : 
<span class="lineNum">     782 </span>            :   rectObj searchrect;
<span class="lineNum">     783 </span>            :   GDALDatasetH  hDS;
<span class="lineNum">     784 </span>            :   double  adfGeoTransform[6];
<span class="lineNum">     785 </span><span class="lineCov">          1 :   void *kernel_density_cleanup_ptr = NULL;</span>
<span class="lineNum">     786 </span>            : 
<span class="lineNum">     787 </span><span class="lineCov">          1 :   if(layer-&gt;debug &gt; 0 || map-&gt;debug &gt; 1)</span>
<span class="lineNum">     788 </span><span class="lineCov">          1 :     msDebug( &quot;msDrawRasterLayerLow(%s): entering.\n&quot;, layer-&gt;name );</span>
<span class="lineNum">     789 </span>            : 
<span class="lineNum">     790 </span><span class="lineCov">          1 :   if( hDatasetIn == NULL &amp;&amp;</span>
<span class="lineNum">     791 </span><span class="lineCov">          1 :       !msDrawRasterLayerLowCheckIfMustDraw(map, layer) ) {</span>
<span class="lineNum">     792 </span>            :     return MS_SUCCESS;
<span class="lineNum">     793 </span>            :   }
<span class="lineNum">     794 </span>            : 
<span class="lineNum">     795 </span><span class="lineCov">          1 :   msGDALInitialize();</span>
<span class="lineNum">     796 </span>            : 
<span class="lineNum">     797 </span><span class="lineCov">          1 :   if(layer-&gt;tileindex) { /* we have an index file */</span>
<span class="lineNum">     798 </span><span class="lineCov">          1 :     msInitShape(&amp;tshp);</span>
<span class="lineNum">     799 </span><span class="lineCov">          1 :     searchrect = map-&gt;extent;</span>
<span class="lineNum">     800 </span>            : 
<span class="lineNum">     801 </span><span class="lineCov">          1 :     status = msDrawRasterSetupTileLayer(map, layer,</span>
<span class="lineNum">     802 </span>            :                            &amp;searchrect,
<span class="lineNum">     803 </span>            :                            MS_FALSE,
<span class="lineNum">     804 </span>            :                            &amp;tilelayerindex,
<span class="lineNum">     805 </span>            :                            &amp;tileitemindex,
<span class="lineNum">     806 </span>            :                            &amp;tilesrsindex,
<span class="lineNum">     807 </span>            :                            &amp;tlp);
<span class="lineNum">     808 </span><span class="lineCov">          1 :     if(status != MS_SUCCESS) {</span>
<span class="lineNum">     809 </span><span class="lineNoCov">          0 :       if (status != MS_DONE)</span>
<span class="lineNum">     810 </span>            :         final_status = status;
<span class="lineNum">     811 </span>            :       goto cleanup;
<span class="lineNum">     812 </span>            :     }
<span class="lineNum">     813 </span>            :   }
<span class="lineNum">     814 </span>            : 
<span class="lineNum">     815 </span>            :   done = MS_FALSE;
<span class="lineNum">     816 </span><span class="lineCov">          1 :   while(done != MS_TRUE) {</span>
<span class="lineNum">     817 </span>            : 
<span class="lineNum">     818 </span><span class="lineCov">          1 :     if(layer-&gt;tileindex) {</span>
<span class="lineNum">     819 </span><span class="lineCov">          1 :       status = msDrawRasterIterateTileIndex(layer, tlp, &amp;tshp,</span>
<span class="lineNum">     820 </span>            :                                             tileitemindex, tilesrsindex,
<span class="lineNum">     821 </span>            :                                             tilename, sizeof(tilename),
<span class="lineNum">     822 </span>            :                                             tilesrsname, sizeof(tilesrsname));
<span class="lineNum">     823 </span><span class="lineCov">          1 :       if( status == MS_FAILURE) {</span>
<span class="lineNum">     824 </span>            :         final_status = MS_FAILURE;
<span class="lineNum">     825 </span>            :         break;
<span class="lineNum">     826 </span>            :       }
<span class="lineNum">     827 </span>            : 
<span class="lineNum">     828 </span><span class="lineCov">          1 :       if(status == MS_DONE) break; /* no more tiles/images */</span>
<span class="lineNum">     829 </span>            :       filename = tilename;
<span class="lineNum">     830 </span>            :     } else {
<span class="lineNum">     831 </span><span class="lineCov">          1 :       filename = layer-&gt;data;</span>
<span class="lineNum">     832 </span>            :       done = MS_TRUE; /* only one image so we're done after this */
<span class="lineNum">     833 </span>            :     }
<span class="lineNum">     834 </span>            :     
<span class="lineNum">     835 </span><span class="lineCov">          1 :     if(layer-&gt;connectiontype == MS_KERNELDENSITY) {</span>
<span class="lineNum">     836 </span><span class="lineCov">          1 :       msAcquireLock( TLOCK_GDAL );</span>
<span class="lineNum">     837 </span><span class="lineCov">          1 :       status = msComputeKernelDensityDataset(map, image, layer, &amp;hDS, &amp;kernel_density_cleanup_ptr);</span>
<span class="lineNum">     838 </span><span class="lineCov">          1 :       if(status != MS_SUCCESS) {</span>
<span class="lineNum">     839 </span><span class="lineNoCov">          0 :         msReleaseLock( TLOCK_GDAL );</span>
<span class="lineNum">     840 </span>            :         final_status = status;
<span class="lineNum">     841 </span><span class="lineNoCov">          0 :         goto cleanup;</span>
<span class="lineNum">     842 </span>            :       }
<span class="lineNum">     843 </span>            :       done = MS_TRUE;
<span class="lineNum">     844 </span><span class="lineCov">          1 :       if(msProjectionsDiffer(&amp;map-&gt;projection,&amp;layer-&gt;projection)) {</span>
<span class="lineNum">     845 </span><span class="lineCov">          1 :         char *mapProjStr = msGetProjectionString(&amp;(map-&gt;projection));</span>
<span class="lineNum">     846 </span>            : 
<span class="lineNum">     847 </span>            :         /* Set the projection to the map file projection */
<span class="lineNum">     848 </span><span class="lineCov">          1 :         if (msLoadProjectionString(&amp;(layer-&gt;projection), mapProjStr) != 0) {</span>
<span class="lineNum">     849 </span><span class="lineNoCov">          0 :           GDALClose( hDS );</span>
<span class="lineNum">     850 </span><span class="lineNoCov">          0 :           msReleaseLock( TLOCK_GDAL );</span>
<span class="lineNum">     851 </span><span class="lineNoCov">          0 :           msSetError(MS_CGIERR, &quot;Unable to set projection on interpolation layer.&quot;, &quot;msDrawRasterLayerLow()&quot;);</span>
<span class="lineNum">     852 </span><span class="lineNoCov">          0 :           return(MS_FAILURE);</span>
<span class="lineNum">     853 </span>            :         }
<span class="lineNum">     854 </span><span class="lineCov">          1 :         free(mapProjStr);</span>
<span class="lineNum">     855 </span>            :       }
<span class="lineNum">     856 </span>            :     } else {
<span class="lineNum">     857 </span><span class="lineCov">          1 :       if(strlen(filename) == 0) continue;</span>
<span class="lineNum">     858 </span><span class="lineCov">          1 :       if( hDatasetIn )</span>
<span class="lineNum">     859 </span>            :       {
<span class="lineNum">     860 </span><span class="lineCov">          1 :         hDS = (GDALDatasetH)hDatasetIn;</span>
<span class="lineNum">     861 </span>            :       }
<span class="lineNum">     862 </span>            :       else
<span class="lineNum">     863 </span>            :       {
<span class="lineNum">     864 </span><span class="lineCov">          1 :         hDS = (GDALDatasetH)msDrawRasterLayerLowOpenDataset(</span>
<span class="lineNum">     865 </span>            :                                 map, layer, filename, szPath, &amp;decrypted_path);
<span class="lineNum">     866 </span>            :       }
<span class="lineNum">     867 </span>            :     }
<span class="lineNum">     868 </span>            : 
<span class="lineNum">     869 </span><span class="lineCov">          1 :     if( hDatasetIn == NULL )</span>
<span class="lineNum">     870 </span>            :     {
<span class="lineNum">     871 </span><span class="lineCov">          1 :         CheckDatasetReturnType eRet =</span>
<span class="lineNum">     872 </span><span class="lineCov">          1 :             msDrawRasterLayerLowCheckDataset(map,layer,hDS,decrypted_path,szPath);</span>
<span class="lineNum">     873 </span>            : 
<span class="lineNum">     874 </span><span class="lineCov">          1 :         msFree( decrypted_path );</span>
<span class="lineNum">     875 </span><span class="lineCov">          1 :         decrypted_path = NULL;</span>
<span class="lineNum">     876 </span>            : 
<span class="lineNum">     877 </span><span class="lineCov">          1 :         if( eRet == CDRT_CONTINUE_NEXT_TILE )</span>
<span class="lineNum">     878 </span>            :         {
<span class="lineNum">     879 </span><span class="lineNoCov">          0 :             msReleaseLock( TLOCK_GDAL );</span>
<span class="lineNum">     880 </span><span class="lineNoCov">          0 :             continue;</span>
<span class="lineNum">     881 </span>            :         }
<span class="lineNum">     882 </span><span class="lineCov">          1 :         if( eRet == CDRT_RETURN_MS_FAILURE )</span>
<span class="lineNum">     883 </span>            :         {
<span class="lineNum">     884 </span><span class="lineNoCov">          0 :             msReleaseLock( TLOCK_GDAL );</span>
<span class="lineNum">     885 </span><span class="lineNoCov">          0 :             return MS_FAILURE;</span>
<span class="lineNum">     886 </span>            :         }
<span class="lineNum">     887 </span>            :     }
<span class="lineNum">     888 </span>            : 
<span class="lineNum">     889 </span><span class="lineCov">          1 :     if( msDrawRasterLoadProjection(layer, hDS, filename, tilesrsindex, tilesrsname) != MS_SUCCESS )</span>
<span class="lineNum">     890 </span>            :     {
<span class="lineNum">     891 </span><span class="lineNoCov">          0 :         if( hDatasetIn == NULL )</span>
<span class="lineNum">     892 </span>            :         {
<span class="lineNum">     893 </span><span class="lineNoCov">          0 :           GDALClose( hDS );</span>
<span class="lineNum">     894 </span><span class="lineNoCov">          0 :           msReleaseLock( TLOCK_GDAL );</span>
<span class="lineNum">     895 </span>            :         }
<span class="lineNum">     896 </span>            :         final_status = MS_FAILURE;
<span class="lineNum">     897 </span>            :         break;
<span class="lineNum">     898 </span>            :     }
<span class="lineNum">     899 </span>            : 
<span class="lineNum">     900 </span><span class="lineCov">          1 :     msGetGDALGeoTransform( hDS, map, layer, adfGeoTransform );</span>
<span class="lineNum">     901 </span>            : 
<span class="lineNum">     902 </span>            :     /*
<span class="lineNum">     903 </span>            :     ** We want to resample if the source image is rotated, if
<span class="lineNum">     904 </span>            :     ** the projections differ or if resampling has been explicitly
<span class="lineNum">     905 </span>            :     ** requested, or if the image has north-down instead of north-up.
<span class="lineNum">     906 </span>            :     */
<span class="lineNum">     907 </span>            : 
<span class="lineNum">     908 </span><span class="lineCov">          1 :     if( ((adfGeoTransform[2] != 0.0 || adfGeoTransform[4] != 0.0</span>
<span class="lineNum">     909 </span><span class="lineCov">          1 :           || adfGeoTransform[5] &gt; 0.0 || adfGeoTransform[1] &lt; 0.0 )</span>
<span class="lineNum">     910 </span><span class="lineCov">          1 :          &amp;&amp; layer-&gt;transform )</span>
<span class="lineNum">     911 </span><span class="lineCov">          1 :         || msProjectionsDiffer( &amp;(map-&gt;projection),</span>
<span class="lineNum">     912 </span>            :                                 &amp;(layer-&gt;projection) )
<span class="lineNum">     913 </span><span class="lineCov">          1 :         || CSLFetchNameValue( layer-&gt;processing, &quot;RESAMPLE&quot; ) != NULL ) {</span>
<span class="lineNum">     914 </span><span class="lineCov">          1 :       status = msResampleGDALToMap( map, layer, image, rb, hDS );</span>
<span class="lineNum">     915 </span>            :     }
<span class="lineNum">     916 </span>            :     else
<span class="lineNum">     917 </span>            :     {
<span class="lineNum">     918 </span><span class="lineCov">          1 :       if( adfGeoTransform[2] != 0.0 || adfGeoTransform[4] != 0.0 ) {</span>
<span class="lineNum">     919 </span><span class="lineNoCov">          0 :         if( layer-&gt;debug || map-&gt;debug )</span>
<span class="lineNum">     920 </span><span class="lineNoCov">          0 :           msDebug(</span>
<span class="lineNum">     921 </span>            :             &quot;Layer %s has rotational coefficients but we\n&quot;
<span class="lineNum">     922 </span>            :             &quot;are unable to use them, projections support\n&quot;
<span class="lineNum">     923 </span>            :             &quot;needs to be built in.&quot;,
<span class="lineNum">     924 </span>            :             layer-&gt;name );
<span class="lineNum">     925 </span>            : 
<span class="lineNum">     926 </span>            :       }
<span class="lineNum">     927 </span><span class="lineCov">          1 :       status = msDrawRasterLayerGDAL(map, layer, image, rb, hDS );</span>
<span class="lineNum">     928 </span>            :     }
<span class="lineNum">     929 </span>            : 
<span class="lineNum">     930 </span><span class="lineCov">          1 :     if( status == -1 ) {</span>
<span class="lineNum">     931 </span><span class="lineNoCov">          0 :       if( hDatasetIn == NULL )</span>
<span class="lineNum">     932 </span>            :       {
<span class="lineNum">     933 </span><span class="lineNoCov">          0 :         GDALClose( hDS );</span>
<span class="lineNum">     934 </span><span class="lineNoCov">          0 :         msReleaseLock( TLOCK_GDAL );</span>
<span class="lineNum">     935 </span>            :       }
<span class="lineNum">     936 </span>            :       final_status = MS_FAILURE;
<span class="lineNum">     937 </span>            :       break;
<span class="lineNum">     938 </span>            :     }
<span class="lineNum">     939 </span>            : 
<span class="lineNum">     940 </span>            :     /*
<span class="lineNum">     941 </span>            :     ** Should we keep this file open for future use?
<span class="lineNum">     942 </span>            :     ** default to keeping open for single data files, and
<span class="lineNum">     943 </span>            :     ** to closing for tile indexes
<span class="lineNum">     944 </span>            :     */
<span class="lineNum">     945 </span><span class="lineCov">          1 :     if(layer-&gt;connectiontype == MS_KERNELDENSITY) {</span>
<span class="lineNum">     946 </span>            :       /*
<span class="lineNum">     947 </span>            :       ** Fix issue #5330
<span class="lineNum">     948 </span>            :       ** The in-memory kernel density heatmap gdal dataset handle (hDS) gets re-used
<span class="lineNum">     949 </span>            :       ** but the associated rasterband cache doesn't get flushed, which causes old data
<span class="lineNum">     950 </span>            :       ** to be rendered instead of the newly generated imagery. To fix, simply close the
<span class="lineNum">     951 </span>            :       ** the handle and prevent further re-use.
<span class="lineNum">     952 </span>            :       ** Note that instead of this workaround, we could explicitely set 
<span class="lineNum">     953 </span>            :       ** CLOSE_CONNECTION=ALWAYS on the kerneldensity layer.
<span class="lineNum">     954 </span>            :       */
<span class="lineNum">     955 </span><span class="lineCov">          1 :       GDALClose( hDS );</span>
<span class="lineNum">     956 </span><span class="lineCov">          1 :       msReleaseLock( TLOCK_GDAL );</span>
<span class="lineNum">     957 </span>            :     }
<span class="lineNum">     958 </span>            :     else {
<span class="lineNum">     959 </span><span class="lineCov">          1 :       if( hDatasetIn == NULL)</span>
<span class="lineNum">     960 </span><span class="lineCov">          1 :         msDrawRasterLayerLowCloseDataset(layer, hDS);</span>
<span class="lineNum">     961 </span>            :     }
<span class="lineNum">     962 </span>            : 
<span class="lineNum">     963 </span>            :   } /* next tile */
<span class="lineNum">     964 </span>            : 
<span class="lineNum">     965 </span><span class="lineCov">          1 : cleanup:</span>
<span class="lineNum">     966 </span><span class="lineCov">          1 :   if(layer-&gt;tileindex) { /* tiling clean-up */</span>
<span class="lineNum">     967 </span><span class="lineCov">          1 :     msDrawRasterCleanupTileLayer(tlp, tilelayerindex);</span>
<span class="lineNum">     968 </span>            :   }
<span class="lineNum">     969 </span><span class="lineCov">          1 :   if(layer-&gt;connectiontype == MS_KERNELDENSITY &amp;&amp; kernel_density_cleanup_ptr) {</span>
<span class="lineNum">     970 </span><span class="lineCov">          1 :     msCleanupKernelDensityDataset(map, image, layer, kernel_density_cleanup_ptr);</span>
<span class="lineNum">     971 </span>            :   }
<span class="lineNum">     972 </span>            : 
<span class="lineNum">     973 </span>            :   return final_status;
<span class="lineNum">     974 </span>            : }
<span class="lineNum">     975 </span>            : 
<span class="lineNum">     976 </span>            : /************************************************************************/
<span class="lineNum">     977 </span>            : /*                         msDrawReferenceMap()                         */
<a name="978"><span class="lineNum">     978 </span>            : /************************************************************************/</a>
<span class="lineNum">     979 </span>            : 
<span class="lineNum">     980 </span><span class="lineNoCov">          0 : imageObj *msDrawReferenceMap(mapObj *map)</span>
<span class="lineNum">     981 </span>            : {
<span class="lineNum">     982 </span>            :   double cellsize;
<span class="lineNum">     983 </span>            :   int x1,y1,x2,y2;
<span class="lineNum">     984 </span>            :   char szPath[MS_MAXPATHLEN];
<span class="lineNum">     985 </span>            :   int status = MS_SUCCESS;
<span class="lineNum">     986 </span>            : 
<span class="lineNum">     987 </span>            :   imageObj   *image = NULL;
<span class="lineNum">     988 </span>            :   styleObj style;
<span class="lineNum">     989 </span>            : 
<span class="lineNum">     990 </span>            : 
<span class="lineNum">     991 </span><span class="lineNoCov">          0 :   rendererVTableObj *renderer = MS_MAP_RENDERER(map);</span>
<span class="lineNum">     992 </span><span class="lineNoCov">          0 :   rasterBufferObj *refImage = (rasterBufferObj*)calloc(1,sizeof(rasterBufferObj));</span>
<span class="lineNum">     993 </span><span class="lineNoCov">          0 :   MS_CHECK_ALLOC(refImage, sizeof(rasterBufferObj), NULL);</span>
<span class="lineNum">     994 </span>            : 
<span class="lineNum">     995 </span><span class="lineNoCov">          0 :   if(MS_SUCCESS != renderer-&gt;loadImageFromFile(msBuildPath(szPath, map-&gt;mappath, map-&gt;reference.image),refImage)) {</span>
<span class="lineNum">     996 </span><span class="lineNoCov">          0 :     msSetError(MS_MISCERR,&quot;error loading reference image %s&quot;,&quot;msDrawREferenceMap()&quot;,szPath);</span>
<span class="lineNum">     997 </span><span class="lineNoCov">          0 :     return NULL;</span>
<span class="lineNum">     998 </span>            :   }
<span class="lineNum">     999 </span>            : 
<span class="lineNum">    1000 </span><span class="lineNoCov">          0 :   image = msImageCreate(refImage-&gt;width, refImage-&gt;height, map-&gt;outputformat,</span>
<span class="lineNum">    1001 </span>            :                         map-&gt;web.imagepath, map-&gt;web.imageurl, map-&gt;resolution, map-&gt;defresolution, &amp;(map-&gt;reference.color));
<span class="lineNum">    1002 </span><span class="lineNoCov">          0 :   if(!image) return NULL;</span>
<span class="lineNum">    1003 </span>            : 
<span class="lineNum">    1004 </span><span class="lineNoCov">          0 :   status = renderer-&gt;mergeRasterBuffer(image,refImage,1.0,0,0,0,0,refImage-&gt;width, refImage-&gt;height);</span>
<span class="lineNum">    1005 </span><span class="lineNoCov">          0 :   msFreeRasterBuffer(refImage);</span>
<span class="lineNum">    1006 </span><span class="lineNoCov">          0 :   free(refImage);</span>
<span class="lineNum">    1007 </span><span class="lineNoCov">          0 :   if(UNLIKELY(status == MS_FAILURE))</span>
<span class="lineNum">    1008 </span>            :     return NULL;
<span class="lineNum">    1009 </span>            : 
<span class="lineNum">    1010 </span>            :   /* make sure the extent given in mapfile fits the image */
<span class="lineNum">    1011 </span><span class="lineNoCov">          0 :   cellsize = msAdjustExtent(&amp;(map-&gt;reference.extent),</span>
<span class="lineNum">    1012 </span>            :                             image-&gt;width, image-&gt;height);
<span class="lineNum">    1013 </span>            : 
<span class="lineNum">    1014 </span>            :   /* convert map extent to reference image coordinates */
<span class="lineNum">    1015 </span><span class="lineNoCov">          0 :   x1 = MS_MAP2IMAGE_X(map-&gt;extent.minx,  map-&gt;reference.extent.minx, cellsize);</span>
<span class="lineNum">    1016 </span><span class="lineNoCov">          0 :   x2 = MS_MAP2IMAGE_X(map-&gt;extent.maxx,  map-&gt;reference.extent.minx, cellsize);</span>
<span class="lineNum">    1017 </span><span class="lineNoCov">          0 :   y1 = MS_MAP2IMAGE_Y(map-&gt;extent.maxy,  map-&gt;reference.extent.maxy, cellsize);</span>
<span class="lineNum">    1018 </span><span class="lineNoCov">          0 :   y2 = MS_MAP2IMAGE_Y(map-&gt;extent.miny,  map-&gt;reference.extent.maxy, cellsize);</span>
<span class="lineNum">    1019 </span>            : 
<span class="lineNum">    1020 </span><span class="lineNoCov">          0 :   initStyle(&amp;style);</span>
<span class="lineNum">    1021 </span><span class="lineNoCov">          0 :   style.color = map-&gt;reference.color;</span>
<span class="lineNum">    1022 </span><span class="lineNoCov">          0 :   style.outlinecolor = map-&gt;reference.outlinecolor;</span>
<span class="lineNum">    1023 </span>            : 
<span class="lineNum">    1024 </span>            :   /* if extent are smaller than minbox size */
<span class="lineNum">    1025 </span>            :   /* draw that extent on the reference image */
<span class="lineNum">    1026 </span><span class="lineNoCov">          0 :   if( (abs(x2 - x1) &gt; map-&gt;reference.minboxsize) ||</span>
<span class="lineNum">    1027 </span><span class="lineNoCov">          0 :       (abs(y2 - y1) &gt; map-&gt;reference.minboxsize) ) {</span>
<span class="lineNum">    1028 </span>            :     shapeObj rect;
<span class="lineNum">    1029 </span>            :     lineObj line;
<span class="lineNum">    1030 </span>            :     pointObj points[5];
<span class="lineNum">    1031 </span><span class="lineNoCov">          0 :     msInitShape(&amp;rect);</span>
<span class="lineNum">    1032 </span>            : 
<span class="lineNum">    1033 </span><span class="lineNoCov">          0 :     line.point = points;</span>
<span class="lineNum">    1034 </span><span class="lineNoCov">          0 :     line.numpoints = 5;</span>
<span class="lineNum">    1035 </span><span class="lineNoCov">          0 :     rect.line = &amp;line;</span>
<span class="lineNum">    1036 </span><span class="lineNoCov">          0 :     rect.numlines = 1;</span>
<span class="lineNum">    1037 </span><span class="lineNoCov">          0 :     rect.type = MS_SHAPE_POLYGON;</span>
<span class="lineNum">    1038 </span>            : 
<span class="lineNum">    1039 </span><span class="lineNoCov">          0 :     line.point[0].x = x1;</span>
<span class="lineNum">    1040 </span><span class="lineNoCov">          0 :     line.point[0].y = y1;</span>
<span class="lineNum">    1041 </span><span class="lineNoCov">          0 :     line.point[1].x = x1;</span>
<span class="lineNum">    1042 </span><span class="lineNoCov">          0 :     line.point[1].y = y2;</span>
<span class="lineNum">    1043 </span><span class="lineNoCov">          0 :     line.point[2].x = x2;</span>
<span class="lineNum">    1044 </span><span class="lineNoCov">          0 :     line.point[2].y = y2;</span>
<span class="lineNum">    1045 </span><span class="lineNoCov">          0 :     line.point[3].x = x2;</span>
<span class="lineNum">    1046 </span><span class="lineNoCov">          0 :     line.point[3].y = y1;</span>
<span class="lineNum">    1047 </span><span class="lineNoCov">          0 :     line.point[4].x = line.point[0].x;</span>
<span class="lineNum">    1048 </span><span class="lineNoCov">          0 :     line.point[4].y = line.point[0].y;</span>
<span class="lineNum">    1049 </span>            : 
<span class="lineNum">    1050 </span>            :     line.numpoints = 5;
<span class="lineNum">    1051 </span>            : 
<span class="lineNum">    1052 </span><span class="lineNoCov">          0 :     if( map-&gt;reference.maxboxsize == 0 ||</span>
<span class="lineNum">    1053 </span><span class="lineNoCov">          0 :         ((abs(x2 - x1) &lt; map-&gt;reference.maxboxsize) &amp;&amp;</span>
<span class="lineNum">    1054 </span><span class="lineNoCov">          0 :          (abs(y2 - y1) &lt; map-&gt;reference.maxboxsize)) ) {</span>
<span class="lineNum">    1055 </span><span class="lineNoCov">          0 :       if(UNLIKELY(MS_FAILURE == msDrawShadeSymbol(map, image, &amp;rect, &amp;style, 1.0))) {</span>
<span class="lineNum">    1056 </span><span class="lineNoCov">          0 :         msFreeImage(image);</span>
<span class="lineNum">    1057 </span><span class="lineNoCov">          0 :         return NULL;</span>
<span class="lineNum">    1058 </span>            :       }
<span class="lineNum">    1059 </span>            :     }
<span class="lineNum">    1060 </span>            : 
<span class="lineNum">    1061 </span>            :   } else { /* else draw the marker symbol */
<span class="lineNum">    1062 </span><span class="lineNoCov">          0 :     if( map-&gt;reference.maxboxsize == 0 ||</span>
<span class="lineNum">    1063 </span><span class="lineNoCov">          0 :         ((abs(x2 - x1) &lt; map-&gt;reference.maxboxsize) &amp;&amp;</span>
<span class="lineNum">    1064 </span>            :          (abs(y2 - y1) &lt; map-&gt;reference.maxboxsize)) ) {
<span class="lineNum">    1065 </span><span class="lineNoCov">          0 :       style.size = map-&gt;reference.markersize;</span>
<span class="lineNum">    1066 </span>            : 
<span class="lineNum">    1067 </span>            :       /* if the marker symbol is specify draw this symbol else draw a cross */
<span class="lineNum">    1068 </span><span class="lineNoCov">          0 :       if(map-&gt;reference.marker || map-&gt;reference.markername) {</span>
<span class="lineNum">    1069 </span>            :         pointObj point;
<span class="lineNum">    1070 </span><span class="lineNoCov">          0 :         point.x = (double)(x1 + x2)/2;</span>
<span class="lineNum">    1071 </span><span class="lineNoCov">          0 :         point.y = (double)(y1 + y2)/2;</span>
<span class="lineNum">    1072 </span>            : 
<span class="lineNum">    1073 </span><span class="lineNoCov">          0 :         if(map-&gt;reference.marker) {</span>
<span class="lineNum">    1074 </span><span class="lineNoCov">          0 :           style.symbol = map-&gt;reference.marker;</span>
<span class="lineNum">    1075 </span>            :         } else {
<span class="lineNum">    1076 </span><span class="lineNoCov">          0 :           style.symbol = msGetSymbolIndex(&amp;map-&gt;symbolset,  map-&gt;reference.markername, MS_TRUE);</span>
<span class="lineNum">    1077 </span>            :         }
<span class="lineNum">    1078 </span>            : 
<span class="lineNum">    1079 </span><span class="lineNoCov">          0 :         if(UNLIKELY(MS_FAILURE == msDrawMarkerSymbol(map, image, &amp;point, &amp;style, 1.0))) {</span>
<span class="lineNum">    1080 </span><span class="lineNoCov">          0 :           msFreeImage(image);</span>
<span class="lineNum">    1081 </span><span class="lineNoCov">          0 :           return NULL;</span>
<span class="lineNum">    1082 </span>            :         }
<span class="lineNum">    1083 </span>            :       } else {
<span class="lineNum">    1084 </span>            :         int x21, y21;
<span class="lineNum">    1085 </span>            :         shapeObj cross;
<span class="lineNum">    1086 </span>            :         lineObj lines[4];
<span class="lineNum">    1087 </span>            :         pointObj point[8];
<span class="lineNum">    1088 </span>            :         int i;
<span class="lineNum">    1089 </span>            :         /* determine the center point */
<span class="lineNum">    1090 </span><span class="lineNoCov">          0 :         x21 = MS_NINT((x1 + x2)/2);</span>
<span class="lineNum">    1091 </span><span class="lineNoCov">          0 :         y21 = MS_NINT((y1 + y2)/2);</span>
<span class="lineNum">    1092 </span>            : 
<span class="lineNum">    1093 </span><span class="lineNoCov">          0 :         msInitShape(&amp;cross);</span>
<span class="lineNum">    1094 </span><span class="lineNoCov">          0 :         cross.numlines = 4;</span>
<span class="lineNum">    1095 </span><span class="lineNoCov">          0 :         cross.line = lines;</span>
<span class="lineNum">    1096 </span><span class="lineNoCov">          0 :         for(i=0; i&lt;4; i++) {</span>
<span class="lineNum">    1097 </span><span class="lineNoCov">          0 :           cross.line[i].numpoints = 2;</span>
<span class="lineNum">    1098 </span><span class="lineNoCov">          0 :           cross.line[i].point = &amp;(point[2*i]);</span>
<span class="lineNum">    1099 </span>            :         }
<span class="lineNum">    1100 </span>            :         /* draw a cross */
<span class="lineNum">    1101 </span><span class="lineNoCov">          0 :         cross.line[0].point[0].x = x21-8;</span>
<span class="lineNum">    1102 </span><span class="lineNoCov">          0 :         cross.line[0].point[0].y = y21;</span>
<span class="lineNum">    1103 </span><span class="lineNoCov">          0 :         cross.line[0].point[1].x = x21-3;</span>
<span class="lineNum">    1104 </span><span class="lineNoCov">          0 :         cross.line[0].point[1].y = y21;</span>
<span class="lineNum">    1105 </span><span class="lineNoCov">          0 :         cross.line[1].point[0].x = x21;</span>
<span class="lineNum">    1106 </span><span class="lineNoCov">          0 :         cross.line[1].point[0].y = y21-8;</span>
<span class="lineNum">    1107 </span><span class="lineNoCov">          0 :         cross.line[1].point[1].x = x21;</span>
<span class="lineNum">    1108 </span><span class="lineNoCov">          0 :         cross.line[1].point[1].y = y21-3;</span>
<span class="lineNum">    1109 </span><span class="lineNoCov">          0 :         cross.line[2].point[0].x = x21;</span>
<span class="lineNum">    1110 </span><span class="lineNoCov">          0 :         cross.line[2].point[0].y = y21+3;</span>
<span class="lineNum">    1111 </span><span class="lineNoCov">          0 :         cross.line[2].point[1].x = x21;</span>
<span class="lineNum">    1112 </span><span class="lineNoCov">          0 :         cross.line[2].point[1].y = y21+8;</span>
<span class="lineNum">    1113 </span><span class="lineNoCov">          0 :         cross.line[3].point[0].x = x21+3;</span>
<span class="lineNum">    1114 </span><span class="lineNoCov">          0 :         cross.line[3].point[0].y = y21;</span>
<span class="lineNum">    1115 </span><span class="lineNoCov">          0 :         cross.line[3].point[1].x = x21+8;</span>
<span class="lineNum">    1116 </span><span class="lineNoCov">          0 :         cross.line[3].point[1].y = y21;</span>
<span class="lineNum">    1117 </span>            : 
<span class="lineNum">    1118 </span><span class="lineNoCov">          0 :         if(UNLIKELY(MS_FAILURE == msDrawLineSymbol(map,image,&amp;cross,&amp;style,1.0))) {</span>
<span class="lineNum">    1119 </span><span class="lineNoCov">          0 :           msFreeImage(image);</span>
<span class="lineNum">    1120 </span><span class="lineNoCov">          0 :           return NULL;</span>
<span class="lineNum">    1121 </span>            :         }
<span class="lineNum">    1122 </span>            :       }
<span class="lineNum">    1123 </span>            :     }
<span class="lineNum">    1124 </span>            :   }
<span class="lineNum">    1125 </span>            : 
<span class="lineNum">    1126 </span>            :   return(image);
<span class="lineNum">    1127 </span>            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>

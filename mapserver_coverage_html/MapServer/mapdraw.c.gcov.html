<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - mapserver.info - MapServer/mapdraw.c</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">MapServer</a> - mapdraw.c<span style="font-size: 80%;"> (source / <a href="mapdraw.c.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">mapserver.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">1201</td>
            <td class="headerCovTableEntry">1627</td>
            <td class="headerCovTableEntryLo">73.8 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2020-10-04 12:47:00</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">29</td>
            <td class="headerCovTableEntry">32</td>
            <td class="headerCovTableEntryHi">90.6 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /******************************************************************************</a>
<span class="lineNum">       2 </span>            :  * $Id$
<span class="lineNum">       3 </span>            :  *
<span class="lineNum">       4 </span>            :  * Project:  MapServer
<span class="lineNum">       5 </span>            :  * Purpose:  High level msDrawMap() implementation and related functions.
<span class="lineNum">       6 </span>            :  * Author:   Steve Lime and the MapServer team.
<span class="lineNum">       7 </span>            :  *
<span class="lineNum">       8 </span>            :  ******************************************************************************
<span class="lineNum">       9 </span>            :  * Copyright (c) 1996-2005 Regents of the University of Minnesota.
<span class="lineNum">      10 </span>            :  *
<span class="lineNum">      11 </span>            :  * Permission is hereby granted, free of charge, to any person obtaining a
<span class="lineNum">      12 </span>            :  * copy of this software and associated documentation files (the &quot;Software&quot;),
<span class="lineNum">      13 </span>            :  * to deal in the Software without restriction, including without limitation
<span class="lineNum">      14 </span>            :  * the rights to use, copy, modify, merge, publish, distribute, sublicense,
<span class="lineNum">      15 </span>            :  * and/or sell copies of the Software, and to permit persons to whom the
<span class="lineNum">      16 </span>            :  * Software is furnished to do so, subject to the following conditions:
<span class="lineNum">      17 </span>            :  *
<span class="lineNum">      18 </span>            :  * The above copyright notice and this permission notice shall be included in
<span class="lineNum">      19 </span>            :  * all copies of this Software or works derived from this Software.
<span class="lineNum">      20 </span>            :  *
<span class="lineNum">      21 </span>            :  * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS
<span class="lineNum">      22 </span>            :  * OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
<span class="lineNum">      23 </span>            :  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL
<span class="lineNum">      24 </span>            :  * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
<span class="lineNum">      25 </span>            :  * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
<span class="lineNum">      26 </span>            :  * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
<span class="lineNum">      27 </span>            :  * DEALINGS IN THE SOFTWARE.
<span class="lineNum">      28 </span>            :  *****************************************************************************/
<span class="lineNum">      29 </span>            : 
<span class="lineNum">      30 </span>            : #include &lt;assert.h&gt;
<span class="lineNum">      31 </span>            : #include &lt;math.h&gt;
<span class="lineNum">      32 </span>            : #include &quot;mapserver.h&quot;
<span class="lineNum">      33 </span>            : #include &quot;maptime.h&quot;
<span class="lineNum">      34 </span>            : #include &quot;mapcopy.h&quot;
<span class="lineNum">      35 </span>            : #include &quot;mapfile.h&quot;
<span class="lineNum">      36 </span>            : #include &quot;mapows.h&quot;
<span class="lineNum">      37 </span>            : 
<span class="lineNum">      38 </span>            : 
<span class="lineNum">      39 </span>            : /* msPrepareImage()
<span class="lineNum">      40 </span>            :  *
<span class="lineNum">      41 </span>            :  * Returns a new imageObj ready for rendering the current map.
<span class="lineNum">      42 </span>            :  *
<span class="lineNum">      43 </span>            :  * If allow_nonsquare is set to MS_TRUE then the caller should call
<span class="lineNum">      44 </span>            :  * msMapRestoreRealExtent() once they are done with the image.
<a name="45"><span class="lineNum">      45 </span>            :  * This should be set to MS_TRUE only when called from msDrawMap(), see bug 945.</a>
<span class="lineNum">      46 </span>            :  */
<span class="lineNum">      47 </span><span class="lineCov">          1 : imageObj *msPrepareImage(mapObj *map, int allow_nonsquare)</span>
<span class="lineNum">      48 </span>            : {
<span class="lineNum">      49 </span>            :   int i, status;
<span class="lineNum">      50 </span>            :   imageObj *image=NULL;
<span class="lineNum">      51 </span>            :   double geo_cellsize;
<span class="lineNum">      52 </span>            : 
<span class="lineNum">      53 </span><span class="lineCov">          1 :   if(map-&gt;width == -1 || map-&gt;height == -1) {</span>
<span class="lineNum">      54 </span><span class="lineCov">          1 :     msSetError(MS_MISCERR, &quot;Image dimensions not specified.&quot;, &quot;msPrepareImage()&quot;);</span>
<span class="lineNum">      55 </span><span class="lineCov">          1 :     return(NULL);</span>
<span class="lineNum">      56 </span>            :   }
<span class="lineNum">      57 </span>            : 
<span class="lineNum">      58 </span><span class="lineCov">          1 :   msFreeLabelCache(&amp;(map-&gt;labelcache));</span>
<span class="lineNum">      59 </span><span class="lineCov">          1 :   msInitLabelCache(&amp;(map-&gt;labelcache)); /* this clears any previously allocated cache */</span>
<span class="lineNum">      60 </span>            : 
<span class="lineNum">      61 </span>            :   /* clear any previously created mask layer images */
<span class="lineNum">      62 </span><span class="lineCov">          1 :   for(i=0; i&lt;map-&gt;numlayers; i++) {</span>
<span class="lineNum">      63 </span><span class="lineCov">          1 :     if(GET_LAYER(map, i)-&gt;maskimage) {</span>
<span class="lineNum">      64 </span><span class="lineNoCov">          0 :       msFreeImage(GET_LAYER(map, i)-&gt;maskimage);</span>
<span class="lineNum">      65 </span><span class="lineNoCov">          0 :       GET_LAYER(map, i)-&gt;maskimage = NULL;</span>
<span class="lineNum">      66 </span>            :     }
<span class="lineNum">      67 </span>            :   }
<span class="lineNum">      68 </span>            : 
<span class="lineNum">      69 </span><span class="lineCov">          1 :   status = msValidateContexts(map); /* make sure there are no recursive REQUIRES or LABELREQUIRES expressions */</span>
<span class="lineNum">      70 </span><span class="lineCov">          1 :   if(status != MS_SUCCESS) return NULL;</span>
<span class="lineNum">      71 </span>            : 
<span class="lineNum">      72 </span><span class="lineCov">          1 :   if(!map-&gt;outputformat) {</span>
<span class="lineNum">      73 </span><span class="lineNoCov">          0 :     msSetError(MS_IMGERR, &quot;Map outputformat not set!&quot;, &quot;msPrepareImage()&quot;);</span>
<span class="lineNum">      74 </span><span class="lineNoCov">          0 :     return(NULL);</span>
<span class="lineNum">      75 </span><span class="lineCov">          1 :   } else if (MS_RENDERER_PLUGIN(map-&gt;outputformat)) {</span>
<span class="lineNum">      76 </span><span class="lineCov">          1 :     rendererVTableObj *renderer = map-&gt;outputformat-&gt;vtable;</span>
<span class="lineNum">      77 </span><span class="lineCov">          1 :     colorObj *bg = &amp;map-&gt;imagecolor;</span>
<span class="lineNum">      78 </span><span class="lineCov">          1 :     map-&gt;imagecolor.alpha=255;</span>
<span class="lineNum">      79 </span><span class="lineCov">          1 :     if(map-&gt;transparent == MS_TRUE) {</span>
<span class="lineNum">      80 </span>            :       /* don't set the image color */
<span class="lineNum">      81 </span>            :       bg = NULL;
<span class="lineNum">      82 </span>            :     }
<span class="lineNum">      83 </span>            : 
<span class="lineNum">      84 </span><span class="lineCov">          1 :   image = renderer-&gt;createImage(map-&gt;width, map-&gt;height, map-&gt;outputformat,bg);</span>
<span class="lineNum">      85 </span><span class="lineCov">          1 :   if (image == NULL)</span>
<span class="lineNum">      86 </span>            :     return(NULL);
<span class="lineNum">      87 </span><span class="lineCov">          1 :   image-&gt;format = map-&gt;outputformat;</span>
<span class="lineNum">      88 </span><span class="lineCov">          1 :   image-&gt;format-&gt;refcount++;</span>
<span class="lineNum">      89 </span><span class="lineCov">          1 :   image-&gt;width = map-&gt;width;</span>
<span class="lineNum">      90 </span><span class="lineCov">          1 :   image-&gt;height = map-&gt;height;</span>
<span class="lineNum">      91 </span>            : 
<span class="lineNum">      92 </span><span class="lineCov">          1 :   image-&gt;resolution = map-&gt;resolution;</span>
<span class="lineNum">      93 </span><span class="lineCov">          1 :   image-&gt;resolutionfactor = map-&gt;resolution/map-&gt;defresolution;</span>
<span class="lineNum">      94 </span><span class="lineCov">          1 :   if (map-&gt;web.imagepath)</span>
<span class="lineNum">      95 </span><span class="lineCov">          1 :     image-&gt;imagepath = msStrdup(map-&gt;web.imagepath);</span>
<span class="lineNum">      96 </span><span class="lineCov">          1 :   if (map-&gt;web.imageurl)</span>
<span class="lineNum">      97 </span><span class="lineCov">          1 :     image-&gt;imageurl = msStrdup(map-&gt;web.imageurl);</span>
<span class="lineNum">      98 </span>            : 
<span class="lineNum">      99 </span><span class="lineCov">          1 :   } else if( MS_RENDERER_IMAGEMAP(map-&gt;outputformat) ) {</span>
<span class="lineNum">     100 </span><span class="lineNoCov">          0 :     image = msImageCreateIM(map-&gt;width, map-&gt;height, map-&gt;outputformat,</span>
<span class="lineNum">     101 </span>            :                             map-&gt;web.imagepath, map-&gt;web.imageurl, map-&gt;resolution, map-&gt;defresolution);
<span class="lineNum">     102 </span><span class="lineCov">          1 :   } else if( MS_RENDERER_RAWDATA(map-&gt;outputformat) ) {</span>
<span class="lineNum">     103 </span><span class="lineCov">          1 :     image = msImageCreate(map-&gt;width, map-&gt;height, map-&gt;outputformat,</span>
<span class="lineNum">     104 </span>            :                           map-&gt;web.imagepath, map-&gt;web.imageurl, map-&gt;resolution, map-&gt;defresolution, &amp;map-&gt;imagecolor);
<span class="lineNum">     105 </span>            :   } else {
<span class="lineNum">     106 </span>            :     image = NULL;
<span class="lineNum">     107 </span>            :   }
<span class="lineNum">     108 </span>            :   
<span class="lineNum">     109 </span><span class="lineCov">          1 :   if(!image) {</span>
<span class="lineNum">     110 </span><span class="lineNoCov">          0 :     msSetError(MS_IMGERR, &quot;Unable to initialize image.&quot;, &quot;msPrepareImage()&quot;);</span>
<span class="lineNum">     111 </span><span class="lineNoCov">          0 :     return(NULL);</span>
<span class="lineNum">     112 </span>            :   }
<span class="lineNum">     113 </span>            :   
<span class="lineNum">     114 </span><span class="lineCov">          1 :   image-&gt;map = map;</span>
<span class="lineNum">     115 </span>            : 
<span class="lineNum">     116 </span>            :   /*
<span class="lineNum">     117 </span>            :    * If we want to support nonsquare pixels, note that now, otherwise
<span class="lineNum">     118 </span>            :    * adjust the extent size to have square pixels.
<span class="lineNum">     119 </span>            :    *
<span class="lineNum">     120 </span>            :    * If allow_nonsquare is set to MS_TRUE then the caller should call
<span class="lineNum">     121 </span>            :    * msMapRestoreRealExtent() once they are done with the image.
<span class="lineNum">     122 </span>            :    * This should be set to MS_TRUE only when called from msDrawMap(), see bug 945.
<span class="lineNum">     123 </span>            :    */
<span class="lineNum">     124 </span><span class="lineCov">          1 :   if( allow_nonsquare &amp;&amp; msTestConfigOption( map, &quot;MS_NONSQUARE&quot;, MS_FALSE ) ) {</span>
<span class="lineNum">     125 </span><span class="lineCov">          1 :     double cellsize_x = (map-&gt;extent.maxx - map-&gt;extent.minx)/map-&gt;width;</span>
<span class="lineNum">     126 </span><span class="lineCov">          1 :     double cellsize_y = (map-&gt;extent.maxy - map-&gt;extent.miny)/map-&gt;height;</span>
<span class="lineNum">     127 </span>            : 
<span class="lineNum">     128 </span><span class="lineCov">          1 :     if( cellsize_y != 0.0</span>
<span class="lineNum">     129 </span><span class="lineCov">          1 :         &amp;&amp; (fabs(cellsize_x/cellsize_y) &gt; 1.00001</span>
<span class="lineNum">     130 </span><span class="lineCov">          1 :             || fabs(cellsize_x/cellsize_y) &lt; 0.99999) ) {</span>
<span class="lineNum">     131 </span><span class="lineCov">          1 :       map-&gt;gt.need_geotransform = MS_TRUE;</span>
<span class="lineNum">     132 </span><span class="lineCov">          1 :       if (map-&gt;debug)</span>
<span class="lineNum">     133 </span><span class="lineNoCov">          0 :         msDebug( &quot;msDrawMap(): kicking into non-square pixel preserving mode.\n&quot; );</span>
<span class="lineNum">     134 </span>            :     }
<span class="lineNum">     135 </span><span class="lineCov">          1 :     map-&gt;cellsize = (cellsize_x*0.5 + cellsize_y*0.5);</span>
<span class="lineNum">     136 </span>            :   } else
<span class="lineNum">     137 </span><span class="lineCov">          1 :     map-&gt;cellsize = msAdjustExtent(&amp;(map-&gt;extent),map-&gt;width,map-&gt;height);</span>
<span class="lineNum">     138 </span>            : 
<span class="lineNum">     139 </span><span class="lineCov">          1 :   status = msCalculateScale(map-&gt;extent,map-&gt;units,map-&gt;width,map-&gt;height, map-&gt;resolution, &amp;map-&gt;scaledenom);</span>
<span class="lineNum">     140 </span><span class="lineCov">          1 :   if(status != MS_SUCCESS) {</span>
<span class="lineNum">     141 </span><span class="lineNoCov">          0 :     msFreeImage(image);</span>
<span class="lineNum">     142 </span><span class="lineNoCov">          0 :     return(NULL);</span>
<span class="lineNum">     143 </span>            :   }
<span class="lineNum">     144 </span>            : 
<span class="lineNum">     145 </span>            :   /* update geotransform based on adjusted extent. */
<span class="lineNum">     146 </span><span class="lineCov">          1 :   msMapComputeGeotransform( map );</span>
<span class="lineNum">     147 </span>            : 
<span class="lineNum">     148 </span>            :   /* Do we need to fake out stuff for rotated support? */
<span class="lineNum">     149 </span><span class="lineCov">          1 :   if( map-&gt;gt.need_geotransform )</span>
<span class="lineNum">     150 </span><span class="lineCov">          1 :     msMapSetFakedExtent( map );</span>
<span class="lineNum">     151 </span>            : 
<span class="lineNum">     152 </span>            :   /* We will need a cellsize that represents a real georeferenced */
<span class="lineNum">     153 </span>            :   /* coordinate cellsize here, so compute it from saved extents.   */
<span class="lineNum">     154 </span>            : 
<span class="lineNum">     155 </span><span class="lineCov">          1 :   geo_cellsize = map-&gt;cellsize;</span>
<span class="lineNum">     156 </span><span class="lineCov">          1 :   if( map-&gt;gt.need_geotransform == MS_TRUE ) {</span>
<span class="lineNum">     157 </span><span class="lineCov">          1 :     double cellsize_x = (map-&gt;saved_extent.maxx - map-&gt;saved_extent.minx)</span>
<span class="lineNum">     158 </span><span class="lineCov">          1 :                         / map-&gt;width;</span>
<span class="lineNum">     159 </span><span class="lineCov">          1 :     double cellsize_y = (map-&gt;saved_extent.maxy - map-&gt;saved_extent.miny)</span>
<span class="lineNum">     160 </span><span class="lineCov">          1 :                         / map-&gt;height;</span>
<span class="lineNum">     161 </span>            : 
<span class="lineNum">     162 </span><span class="lineCov">          1 :     geo_cellsize = sqrt(cellsize_x*cellsize_x + cellsize_y*cellsize_y)</span>
<span class="lineNum">     163 </span>            :                    / sqrt(2.0);
<span class="lineNum">     164 </span>            :   }
<span class="lineNum">     165 </span>            : 
<span class="lineNum">     166 </span>            :   /* compute layer/class/style/label scale factors now */
<span class="lineNum">     167 </span><span class="lineCov">          1 :   for(int lid=0; lid&lt;map-&gt;numlayers; lid++) {</span>
<span class="lineNum">     168 </span><span class="lineCov">          1 :     layerObj * layer = GET_LAYER(map, lid);</span>
<span class="lineNum">     169 </span><span class="lineCov">          1 :     if(layer-&gt;sizeunits != MS_PIXELS)</span>
<span class="lineNum">     170 </span><span class="lineNoCov">          0 :       layer-&gt;scalefactor = (msInchesPerUnit(layer-&gt;sizeunits,0)/msInchesPerUnit(map-&gt;units,0)) / geo_cellsize;</span>
<span class="lineNum">     171 </span><span class="lineCov">          1 :     else if(layer-&gt;symbolscaledenom &gt; 0 &amp;&amp; map-&gt;scaledenom &gt; 0)</span>
<span class="lineNum">     172 </span><span class="lineNoCov">          0 :       layer-&gt;scalefactor = layer-&gt;symbolscaledenom/map-&gt;scaledenom*map-&gt;resolution/map-&gt;defresolution;</span>
<span class="lineNum">     173 </span>            :     else
<span class="lineNum">     174 </span><span class="lineCov">          1 :       layer-&gt;scalefactor = map-&gt;resolution/map-&gt;defresolution;</span>
<span class="lineNum">     175 </span><span class="lineCov">          1 :     for (int cid=0 ; cid&lt;layer-&gt;numclasses ; cid++)</span>
<span class="lineNum">     176 </span>            :     {
<span class="lineNum">     177 </span><span class="lineCov">          1 :       classObj * class = GET_CLASS(map, lid, cid);</span>
<span class="lineNum">     178 </span><span class="lineCov">          1 :       if (class-&gt;sizeunits == MS_INHERIT)</span>
<span class="lineNum">     179 </span><span class="lineCov">          1 :         class-&gt;scalefactor = layer-&gt;scalefactor;</span>
<span class="lineNum">     180 </span><span class="lineNoCov">          0 :       else if (class-&gt;sizeunits != MS_PIXELS)</span>
<span class="lineNum">     181 </span><span class="lineNoCov">          0 :         class-&gt;scalefactor = (msInchesPerUnit(class-&gt;sizeunits,0)/msInchesPerUnit(map-&gt;units,0)) / geo_cellsize;</span>
<span class="lineNum">     182 </span><span class="lineNoCov">          0 :       else if (layer-&gt;symbolscaledenom &gt; 0 &amp;&amp; map-&gt;scaledenom &gt; 0)</span>
<span class="lineNum">     183 </span><span class="lineNoCov">          0 :         class-&gt;scalefactor = layer-&gt;symbolscaledenom/map-&gt;scaledenom*map-&gt;resolution/map-&gt;defresolution;</span>
<span class="lineNum">     184 </span>            :       else
<span class="lineNum">     185 </span><span class="lineNoCov">          0 :         class-&gt;scalefactor = map-&gt;resolution/map-&gt;defresolution;</span>
<span class="lineNum">     186 </span><span class="lineCov">          1 :       for (int sid=0 ; sid&lt;class-&gt;numstyles ; sid++)</span>
<span class="lineNum">     187 </span>            :       {
<span class="lineNum">     188 </span><span class="lineCov">          1 :         styleObj * style = class-&gt;styles[sid];</span>
<span class="lineNum">     189 </span><span class="lineCov">          1 :         if (style-&gt;sizeunits == MS_INHERIT)</span>
<span class="lineNum">     190 </span><span class="lineCov">          1 :           style-&gt;scalefactor = class-&gt;scalefactor;</span>
<span class="lineNum">     191 </span><span class="lineCov">          1 :         else if (style-&gt;sizeunits != MS_PIXELS)</span>
<span class="lineNum">     192 </span><span class="lineCov">          1 :           style-&gt;scalefactor = (msInchesPerUnit(style-&gt;sizeunits,0)/msInchesPerUnit(map-&gt;units,0)) / geo_cellsize;</span>
<span class="lineNum">     193 </span><span class="lineCov">          1 :         else if (layer-&gt;symbolscaledenom &gt; 0 &amp;&amp; map-&gt;scaledenom &gt; 0)</span>
<span class="lineNum">     194 </span><span class="lineNoCov">          0 :           style-&gt;scalefactor = layer-&gt;symbolscaledenom/map-&gt;scaledenom*map-&gt;resolution/map-&gt;defresolution;</span>
<span class="lineNum">     195 </span>            :         else
<span class="lineNum">     196 </span><span class="lineCov">          1 :           style-&gt;scalefactor = map-&gt;resolution/map-&gt;defresolution;</span>
<span class="lineNum">     197 </span>            :       }
<span class="lineNum">     198 </span><span class="lineCov">          1 :       for (int sid=0 ; sid&lt;class-&gt;numlabels ; sid++)</span>
<span class="lineNum">     199 </span>            :       {
<span class="lineNum">     200 </span><span class="lineCov">          1 :         labelObj * label = class-&gt;labels[sid];</span>
<span class="lineNum">     201 </span><span class="lineCov">          1 :         if (label-&gt;sizeunits == MS_INHERIT)</span>
<span class="lineNum">     202 </span><span class="lineCov">          1 :           label-&gt;scalefactor = class-&gt;scalefactor;</span>
<span class="lineNum">     203 </span><span class="lineNoCov">          0 :         else if (label-&gt;sizeunits != MS_PIXELS)</span>
<span class="lineNum">     204 </span><span class="lineNoCov">          0 :           label-&gt;scalefactor = (msInchesPerUnit(label-&gt;sizeunits,0)/msInchesPerUnit(map-&gt;units,0)) / geo_cellsize;</span>
<span class="lineNum">     205 </span><span class="lineNoCov">          0 :         else if (layer-&gt;symbolscaledenom &gt; 0 &amp;&amp; map-&gt;scaledenom &gt; 0)</span>
<span class="lineNum">     206 </span><span class="lineNoCov">          0 :           label-&gt;scalefactor = layer-&gt;symbolscaledenom/map-&gt;scaledenom*map-&gt;resolution/map-&gt;defresolution;</span>
<span class="lineNum">     207 </span>            :         else
<span class="lineNum">     208 </span><span class="lineNoCov">          0 :           label-&gt;scalefactor = map-&gt;resolution/map-&gt;defresolution;</span>
<span class="lineNum">     209 </span><span class="lineCov">          1 :         for (int lsid=0 ; lsid&lt;label-&gt;numstyles ; lsid++)</span>
<span class="lineNum">     210 </span>            :         {
<span class="lineNum">     211 </span><span class="lineCov">          1 :           styleObj * lstyle = label-&gt;styles[lsid];</span>
<span class="lineNum">     212 </span><span class="lineCov">          1 :           if (lstyle-&gt;sizeunits == MS_INHERIT)</span>
<span class="lineNum">     213 </span><span class="lineCov">          1 :             lstyle-&gt;scalefactor = label-&gt;scalefactor;</span>
<span class="lineNum">     214 </span><span class="lineNoCov">          0 :           else if (lstyle-&gt;sizeunits != MS_PIXELS)</span>
<span class="lineNum">     215 </span><span class="lineNoCov">          0 :             lstyle-&gt;scalefactor = (msInchesPerUnit(lstyle-&gt;sizeunits,0)/msInchesPerUnit(map-&gt;units,0)) / geo_cellsize;</span>
<span class="lineNum">     216 </span><span class="lineNoCov">          0 :           else if (layer-&gt;symbolscaledenom &gt; 0 &amp;&amp; map-&gt;scaledenom &gt; 0)</span>
<span class="lineNum">     217 </span><span class="lineNoCov">          0 :             lstyle-&gt;scalefactor = layer-&gt;symbolscaledenom/map-&gt;scaledenom*map-&gt;resolution/map-&gt;defresolution;</span>
<span class="lineNum">     218 </span>            :           else
<span class="lineNum">     219 </span><span class="lineNoCov">          0 :             lstyle-&gt;scalefactor = map-&gt;resolution/map-&gt;defresolution;</span>
<span class="lineNum">     220 </span>            :         }
<span class="lineNum">     221 </span>            :       }
<span class="lineNum">     222 </span>            :     }
<span class="lineNum">     223 </span>            :   }
<span class="lineNum">     224 </span>            : 
<span class="lineNum">     225 </span><span class="lineCov">          1 :   image-&gt;refpt.x = MS_MAP2IMAGE_X_IC_DBL(0, map-&gt;extent.minx, 1.0/map-&gt;cellsize);</span>
<span class="lineNum">     226 </span><span class="lineCov">          1 :   image-&gt;refpt.y = MS_MAP2IMAGE_Y_IC_DBL(0, map-&gt;extent.maxy, 1.0/map-&gt;cellsize);</span>
<span class="lineNum">     227 </span>            : 
<span class="lineNum">     228 </span><span class="lineCov">          1 :   return image;</span>
<span class="lineNum">     229 </span>            :   
<a name="230"><span class="lineNum">     230 </span>            : }</a>
<span class="lineNum">     231 </span>            : 
<span class="lineNum">     232 </span><span class="lineCov">          1 : static int msCompositeRasterBuffer(mapObj *map, imageObj *img, rasterBufferObj *rb, LayerCompositer *comp) {</span>
<span class="lineNum">     233 </span>            :   int ret = MS_SUCCESS;
<span class="lineNum">     234 </span><span class="lineCov">          1 :   if(MS_IMAGE_RENDERER(img)-&gt;compositeRasterBuffer) {</span>
<span class="lineNum">     235 </span><span class="lineCov">          1 :     while(comp &amp;&amp; ret == MS_SUCCESS) {</span>
<span class="lineNum">     236 </span>            :       rasterBufferObj *rb_ptr = rb;
<span class="lineNum">     237 </span><span class="lineCov">          1 :       CompositingFilter *filter = comp-&gt;filter;</span>
<span class="lineNum">     238 </span><span class="lineCov">          1 :       if(filter &amp;&amp; comp-&gt;next) {</span>
<span class="lineNum">     239 </span>            :        /* if we have another compositor to apply, then we need to copy the rasterBufferObj. Otherwise
<span class="lineNum">     240 </span>            :        * we can work on it directly */
<span class="lineNum">     241 </span><span class="lineNoCov">          0 :   rb_ptr = (rasterBufferObj*)msSmallCalloc(sizeof(rasterBufferObj),1);</span>
<span class="lineNum">     242 </span><span class="lineNoCov">          0 :   msCopyRasterBuffer(rb_ptr,rb);</span>
<span class="lineNum">     243 </span>            :       }
<span class="lineNum">     244 </span><span class="lineCov">          1 :       while(filter &amp;&amp; ret == MS_SUCCESS) {</span>
<span class="lineNum">     245 </span><span class="lineNoCov">          0 :         ret = msApplyCompositingFilter(map,rb_ptr,filter);</span>
<span class="lineNum">     246 </span><span class="lineNoCov">          0 :         filter = filter-&gt;next;</span>
<span class="lineNum">     247 </span>            :       }
<span class="lineNum">     248 </span><span class="lineCov">          1 :       if(ret == MS_SUCCESS)</span>
<span class="lineNum">     249 </span><span class="lineCov">          1 :         ret = MS_IMAGE_RENDERER(img)-&gt;compositeRasterBuffer(img,rb_ptr,comp-&gt;comp_op, comp-&gt;opacity);</span>
<span class="lineNum">     250 </span><span class="lineCov">          1 :       if(rb_ptr != rb) {</span>
<span class="lineNum">     251 </span><span class="lineNoCov">          0 :         msFreeRasterBuffer(rb_ptr);</span>
<span class="lineNum">     252 </span><span class="lineNoCov">          0 :         msFree(rb_ptr);</span>
<span class="lineNum">     253 </span>            :       }
<span class="lineNum">     254 </span><span class="lineCov">          1 :       comp = comp-&gt;next;</span>
<span class="lineNum">     255 </span>            :     }
<span class="lineNum">     256 </span>            :   } else {
<span class="lineNum">     257 </span>            :     ret = MS_FAILURE;
<span class="lineNum">     258 </span>            :   }
<span class="lineNum">     259 </span><span class="lineCov">          1 :   return ret;</span>
<span class="lineNum">     260 </span>            : }
<span class="lineNum">     261 </span>            : 
<span class="lineNum">     262 </span>            : /*
<span class="lineNum">     263 </span>            :  * Generic function to render the map file.
<span class="lineNum">     264 </span>            :  * The type of the image created is based on the imagetype parameter in the map file.
<span class="lineNum">     265 </span>            :  *
<span class="lineNum">     266 </span>            :  * mapObj *map - map object loaded in MapScript or via a mapfile to use
<a name="267"><span class="lineNum">     267 </span>            :  * int querymap - is this map the result of a query operation, MS_TRUE|MS_FALSE</a>
<span class="lineNum">     268 </span>            : */
<span class="lineNum">     269 </span><span class="lineCov">          1 : imageObj *msDrawMap(mapObj *map, int querymap)</span>
<span class="lineNum">     270 </span>            : {
<span class="lineNum">     271 </span>            :   int i;
<span class="lineNum">     272 </span>            :   layerObj *lp=NULL;
<span class="lineNum">     273 </span>            :   int status = MS_FAILURE;
<span class="lineNum">     274 </span>            :   imageObj *image = NULL;
<span class="lineNum">     275 </span><span class="lineCov">          1 :   struct mstimeval mapstarttime = {0}, mapendtime = {0};</span>
<span class="lineNum">     276 </span><span class="lineCov">          1 :   struct mstimeval starttime = {0}, endtime = {0};</span>
<span class="lineNum">     277 </span>            : 
<span class="lineNum">     278 </span>            : #if defined(USE_WMS_LYR) || defined(USE_WFS_LYR)
<span class="lineNum">     279 </span>            :   enum MS_CONNECTION_TYPE lastconnectiontype;
<span class="lineNum">     280 </span>            :   httpRequestObj *pasOWSReqInfo=NULL;
<span class="lineNum">     281 </span>            :   int numOWSLayers=0;
<span class="lineNum">     282 </span><span class="lineCov">          1 :   int numOWSRequests=0;</span>
<span class="lineNum">     283 </span>            :   wmsParamsObj sLastWMSParams;
<span class="lineNum">     284 </span>            : #endif
<span class="lineNum">     285 </span>            : 
<span class="lineNum">     286 </span><span class="lineCov">          1 :   if(map-&gt;debug &gt;= MS_DEBUGLEVEL_TUNING) msGettimeofday(&amp;mapstarttime, NULL);</span>
<span class="lineNum">     287 </span>            : 
<span class="lineNum">     288 </span><span class="lineCov">          1 :   if(querymap) { /* use queryMapObj image dimensions */</span>
<span class="lineNum">     289 </span><span class="lineCov">          1 :     if(map-&gt;querymap.width != -1) map-&gt;width = map-&gt;querymap.width;</span>
<span class="lineNum">     290 </span><span class="lineCov">          1 :     if(map-&gt;querymap.height != -1) map-&gt;height = map-&gt;querymap.height;</span>
<span class="lineNum">     291 </span>            :   }
<span class="lineNum">     292 </span>            : 
<span class="lineNum">     293 </span><span class="lineCov">          1 :   msApplyMapConfigOptions(map);</span>
<span class="lineNum">     294 </span><span class="lineCov">          1 :   image = msPrepareImage(map, MS_TRUE);</span>
<span class="lineNum">     295 </span>            : 
<span class="lineNum">     296 </span><span class="lineCov">          1 :   if(!image) {</span>
<span class="lineNum">     297 </span><span class="lineCov">          1 :     msSetError(MS_IMGERR, &quot;Unable to initialize image.&quot;, &quot;msDrawMap()&quot;);</span>
<span class="lineNum">     298 </span><span class="lineCov">          1 :     return(NULL);</span>
<span class="lineNum">     299 </span>            :   }
<span class="lineNum">     300 </span>            : 
<span class="lineNum">     301 </span><span class="lineCov">          1 :   if( map-&gt;debug &gt;= MS_DEBUGLEVEL_DEBUG )</span>
<span class="lineNum">     302 </span><span class="lineCov">          1 :     msDebug( &quot;msDrawMap(): rendering using outputformat named %s (%s).\n&quot;,</span>
<span class="lineNum">     303 </span>            :              map-&gt;outputformat-&gt;name,
<span class="lineNum">     304 </span><span class="lineCov">          1 :              map-&gt;outputformat-&gt;driver );</span>
<span class="lineNum">     305 </span>            : 
<span class="lineNum">     306 </span>            : #if defined(USE_WMS_LYR) || defined(USE_WFS_LYR)
<span class="lineNum">     307 </span>            : 
<span class="lineNum">     308 </span>            :   /* Time the OWS query phase */
<span class="lineNum">     309 </span><span class="lineCov">          1 :   if(map-&gt;debug &gt;= MS_DEBUGLEVEL_TUNING ) msGettimeofday(&amp;starttime, NULL);</span>
<span class="lineNum">     310 </span>            : 
<span class="lineNum">     311 </span>            :   /* How many OWS (WMS/WFS) layers do we have to draw?
<span class="lineNum">     312 </span>            :    * Note: numOWSLayers is the number of actual layers and numOWSRequests is
<span class="lineNum">     313 </span>            :    * the number of HTTP requests which could be lower if multiple layers
<span class="lineNum">     314 </span>            :    * are merged into the same request.
<span class="lineNum">     315 </span>            :    */
<span class="lineNum">     316 </span>            :   numOWSLayers=0;
<span class="lineNum">     317 </span><span class="lineCov">          1 :   for(i=0; i&lt;map-&gt;numlayers; i++) {</span>
<span class="lineNum">     318 </span><span class="lineCov">          1 :       if(map-&gt;layerorder[i] == -1 )</span>
<span class="lineNum">     319 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">     320 </span>            : 
<span class="lineNum">     321 </span><span class="lineCov">          1 :       lp = GET_LAYER(map,map-&gt;layerorder[i]);</span>
<span class="lineNum">     322 </span><span class="lineCov">          1 :       if( lp-&gt;connectiontype != MS_WMS &amp;&amp;</span>
<span class="lineNum">     323 </span>            :           lp-&gt;connectiontype != MS_WFS ) {
<span class="lineNum">     324 </span><span class="lineCov">          1 :         continue;</span>
<span class="lineNum">     325 </span>            :       }
<span class="lineNum">     326 </span><span class="lineCov">          1 :       numOWSLayers++;</span>
<span class="lineNum">     327 </span>            :   }
<span class="lineNum">     328 </span>            : 
<span class="lineNum">     329 </span><span class="lineCov">          1 :   if (numOWSLayers &gt; 0) {</span>
<span class="lineNum">     330 </span>            : 
<span class="lineNum">     331 </span>            :     /* Alloc and init pasOWSReqInfo...
<span class="lineNum">     332 </span>            :      */
<span class="lineNum">     333 </span><span class="lineCov">          1 :     pasOWSReqInfo = (httpRequestObj *)malloc(numOWSLayers*sizeof(httpRequestObj));</span>
<span class="lineNum">     334 </span><span class="lineCov">          1 :     if (pasOWSReqInfo == NULL) {</span>
<span class="lineNum">     335 </span><span class="lineNoCov">          0 :       msSetError(MS_MEMERR, &quot;Allocation of httpRequestObj failed.&quot;, &quot;msDrawMap()&quot;);</span>
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :       return NULL;</span>
<span class="lineNum">     337 </span>            :     }
<span class="lineNum">     338 </span><span class="lineCov">          1 :     msHTTPInitRequestObj(pasOWSReqInfo, numOWSLayers);</span>
<span class="lineNum">     339 </span><span class="lineCov">          1 :     msInitWmsParamsObj(&amp;sLastWMSParams);</span>
<span class="lineNum">     340 </span>            : 
<span class="lineNum">     341 </span>            :     /* Pre-download all WMS/WFS layers in parallel before starting to draw map */
<span class="lineNum">     342 </span>            :     lastconnectiontype = MS_SHAPEFILE;
<span class="lineNum">     343 </span><span class="lineCov">          1 :     for(i=0; i&lt;map-&gt;numlayers; i++) {</span>
<span class="lineNum">     344 </span><span class="lineCov">          1 :       if(map-&gt;layerorder[i] == -1 )</span>
<span class="lineNum">     345 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">     346 </span>            : 
<span class="lineNum">     347 </span><span class="lineCov">          1 :       lp = GET_LAYER(map,map-&gt;layerorder[i]);</span>
<span class="lineNum">     348 </span><span class="lineCov">          1 :       if( lp-&gt;connectiontype != MS_WMS &amp;&amp;</span>
<span class="lineNum">     349 </span>            :           lp-&gt;connectiontype != MS_WFS ) {
<span class="lineNum">     350 </span><span class="lineCov">          1 :         continue;</span>
<span class="lineNum">     351 </span>            :       }
<span class="lineNum">     352 </span>            : 
<span class="lineNum">     353 </span><span class="lineCov">          1 :       if( !msLayerIsVisible(map, lp) )</span>
<span class="lineNum">     354 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">     355 </span>            : 
<span class="lineNum">     356 </span>            : #ifdef USE_WMS_LYR
<span class="lineNum">     357 </span><span class="lineCov">          1 :       if(lp-&gt;connectiontype == MS_WMS) {</span>
<span class="lineNum">     358 </span><span class="lineCov">          1 :         if(msPrepareWMSLayerRequest(map-&gt;layerorder[i], map, lp, 1, lastconnectiontype, &amp;sLastWMSParams, 0, 0, 0, NULL, pasOWSReqInfo, &amp;numOWSRequests) == MS_FAILURE) {</span>
<span class="lineNum">     359 </span><span class="lineNoCov">          0 :           msFreeWmsParamsObj(&amp;sLastWMSParams);</span>
<span class="lineNum">     360 </span><span class="lineNoCov">          0 :           msFreeImage(image);</span>
<span class="lineNum">     361 </span><span class="lineNoCov">          0 :           msFree(pasOWSReqInfo);</span>
<span class="lineNum">     362 </span><span class="lineNoCov">          0 :           return NULL;</span>
<span class="lineNum">     363 </span>            :         }
<span class="lineNum">     364 </span>            :       }
<span class="lineNum">     365 </span>            : #endif
<span class="lineNum">     366 </span>            : 
<span class="lineNum">     367 </span>            : #ifdef USE_WFS_LYR
<span class="lineNum">     368 </span><span class="lineCov">          1 :       if(lp-&gt;connectiontype == MS_WFS) {</span>
<span class="lineNum">     369 </span><span class="lineNoCov">          0 :         if(msPrepareWFSLayerRequest(map-&gt;layerorder[i], map, lp, pasOWSReqInfo, &amp;numOWSRequests) == MS_FAILURE) {</span>
<span class="lineNum">     370 </span><span class="lineNoCov">          0 :           msFreeWmsParamsObj(&amp;sLastWMSParams);</span>
<span class="lineNum">     371 </span><span class="lineNoCov">          0 :           msFreeImage(image);</span>
<span class="lineNum">     372 </span><span class="lineNoCov">          0 :           msFree(pasOWSReqInfo);</span>
<span class="lineNum">     373 </span><span class="lineNoCov">          0 :           return NULL;</span>
<span class="lineNum">     374 </span>            :         }
<span class="lineNum">     375 </span>            :       }
<span class="lineNum">     376 </span>            : #endif
<span class="lineNum">     377 </span>            : 
<span class="lineNum">     378 </span><span class="lineCov">          1 :       lastconnectiontype = lp-&gt;connectiontype;</span>
<span class="lineNum">     379 </span>            :     }
<span class="lineNum">     380 </span>            : 
<span class="lineNum">     381 </span><span class="lineCov">          1 :     msFreeWmsParamsObj(&amp;sLastWMSParams);</span>
<span class="lineNum">     382 </span>            :   } /* if numOWSLayers &gt; 0 */
<span class="lineNum">     383 </span>            : 
<span class="lineNum">     384 </span><span class="lineCov">          1 :   if(numOWSRequests &amp;&amp; msOWSExecuteRequests(pasOWSReqInfo, numOWSRequests, map, MS_TRUE) == MS_FAILURE) {</span>
<span class="lineNum">     385 </span><span class="lineNoCov">          0 :     msFreeImage(image);</span>
<span class="lineNum">     386 </span><span class="lineNoCov">          0 :     msFree(pasOWSReqInfo);</span>
<span class="lineNum">     387 </span><span class="lineNoCov">          0 :     return NULL;</span>
<span class="lineNum">     388 </span>            :   }
<span class="lineNum">     389 </span>            : 
<span class="lineNum">     390 </span><span class="lineCov">          1 :   if(map-&gt;debug &gt;= MS_DEBUGLEVEL_TUNING) {</span>
<span class="lineNum">     391 </span><span class="lineCov">          1 :     msGettimeofday(&amp;endtime, NULL);</span>
<span class="lineNum">     392 </span><span class="lineCov">          1 :     msDebug(&quot;msDrawMap(): WMS/WFS set-up and query, %.3fs\n&quot;,</span>
<span class="lineNum">     393 </span><span class="lineCov">          1 :             (endtime.tv_sec+endtime.tv_usec/1.0e6)-</span>
<span class="lineNum">     394 </span><span class="lineCov">          1 :             (starttime.tv_sec+starttime.tv_usec/1.0e6) );</span>
<span class="lineNum">     395 </span>            :   }
<span class="lineNum">     396 </span>            : 
<span class="lineNum">     397 </span>            : #endif /* USE_WMS_LYR || USE_WFS_LYR */
<span class="lineNum">     398 </span>            : 
<span class="lineNum">     399 </span>            :   /* OK, now we can start drawing */
<span class="lineNum">     400 </span><span class="lineCov">          1 :   for(i=0; i&lt;map-&gt;numlayers; i++) {</span>
<span class="lineNum">     401 </span>            : 
<span class="lineNum">     402 </span><span class="lineCov">          1 :     if(map-&gt;layerorder[i] != -1) {</span>
<span class="lineNum">     403 </span>            :       char *force_draw_label_cache = NULL;
<span class="lineNum">     404 </span>            : 
<span class="lineNum">     405 </span><span class="lineCov">          1 :       lp = (GET_LAYER(map,  map-&gt;layerorder[i]));</span>
<span class="lineNum">     406 </span>            : 
<span class="lineNum">     407 </span><span class="lineCov">          1 :       if(lp-&gt;postlabelcache) /* wait to draw */</span>
<span class="lineNum">     408 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">     409 </span>            : 
<span class="lineNum">     410 </span><span class="lineCov">          1 :       if(map-&gt;debug &gt;= MS_DEBUGLEVEL_TUNING || lp-&gt;debug &gt;= MS_DEBUGLEVEL_TUNING ) msGettimeofday(&amp;starttime, NULL);</span>
<span class="lineNum">     411 </span>            : 
<span class="lineNum">     412 </span><span class="lineCov">          1 :       if(!msLayerIsVisible(map, lp)) continue;</span>
<span class="lineNum">     413 </span>            : 
<span class="lineNum">     414 </span><span class="lineCov">          1 :       if(lp-&gt;connectiontype == MS_WMS) {</span>
<span class="lineNum">     415 </span>            : #ifdef USE_WMS_LYR
<span class="lineNum">     416 </span><span class="lineCov">          1 :         if(MS_RENDERER_PLUGIN(image-&gt;format) || MS_RENDERER_RAWDATA(image-&gt;format))</span>
<span class="lineNum">     417 </span><span class="lineCov">          1 :           status = msDrawWMSLayerLow(map-&gt;layerorder[i], pasOWSReqInfo, numOWSRequests,  map, lp, image);</span>
<span class="lineNum">     418 </span>            :         else {
<span class="lineNum">     419 </span><span class="lineNoCov">          0 :           msSetError(MS_WMSCONNERR, &quot;Output format '%s' doesn't support WMS layers.&quot;, &quot;msDrawMap()&quot;, image-&gt;format-&gt;name);</span>
<span class="lineNum">     420 </span>            :           status = MS_FAILURE;
<span class="lineNum">     421 </span>            :         }
<span class="lineNum">     422 </span>            : 
<span class="lineNum">     423 </span><span class="lineCov">          1 :         if(status == MS_FAILURE) {</span>
<span class="lineNum">     424 </span><span class="lineNoCov">          0 :           msSetError(MS_WMSCONNERR,</span>
<span class="lineNum">     425 </span>            :                      &quot;Failed to draw WMS layer named '%s'. This most likely happened because &quot;
<span class="lineNum">     426 </span>            :                      &quot;the remote WMS server returned an invalid image, and XML exception &quot;
<span class="lineNum">     427 </span>            :                      &quot;or another unexpected result in response to the GetMap request. Also check &quot;
<span class="lineNum">     428 </span>            :                      &quot;and make sure that the layer's connection URL is valid.&quot;,
<span class="lineNum">     429 </span>            :                      &quot;msDrawMap()&quot;, lp-&gt;name);
<span class="lineNum">     430 </span><span class="lineNoCov">          0 :           msFreeImage(image);</span>
<span class="lineNum">     431 </span><span class="lineNoCov">          0 :           msHTTPFreeRequestObj(pasOWSReqInfo, numOWSRequests);</span>
<span class="lineNum">     432 </span><span class="lineNoCov">          0 :           msFree(pasOWSReqInfo);</span>
<span class="lineNum">     433 </span><span class="lineNoCov">          0 :           return(NULL);</span>
<span class="lineNum">     434 </span>            :         }
<span class="lineNum">     435 </span>            : 
<span class="lineNum">     436 </span>            : 
<span class="lineNum">     437 </span>            : #else /* ndef USE_WMS_LYR */
<span class="lineNum">     438 </span>            :         msSetError(MS_WMSCONNERR, &quot;MapServer not built with WMS Client support, unable to render layer '%s'.&quot;, &quot;msDrawMap()&quot;, lp-&gt;name);
<span class="lineNum">     439 </span>            :         msFreeImage(image);
<span class="lineNum">     440 </span>            :         return(NULL);
<span class="lineNum">     441 </span>            : #endif
<span class="lineNum">     442 </span>            :       } else { /* Default case: anything but WMS layers */
<span class="lineNum">     443 </span><span class="lineCov">          1 :         if(querymap)</span>
<span class="lineNum">     444 </span><span class="lineCov">          1 :           status = msDrawQueryLayer(map, lp, image);</span>
<span class="lineNum">     445 </span>            :         else
<span class="lineNum">     446 </span><span class="lineCov">          1 :           status = msDrawLayer(map, lp, image);</span>
<span class="lineNum">     447 </span><span class="lineCov">          1 :         if(status == MS_FAILURE) {</span>
<span class="lineNum">     448 </span><span class="lineCov">          1 :           msSetError(MS_IMGERR, &quot;Failed to draw layer named '%s'.&quot;, &quot;msDrawMap()&quot;, lp-&gt;name);</span>
<span class="lineNum">     449 </span><span class="lineCov">          1 :           msFreeImage(image);</span>
<span class="lineNum">     450 </span>            : #if defined(USE_WMS_LYR) || defined(USE_WFS_LYR)
<span class="lineNum">     451 </span><span class="lineCov">          1 :           if (pasOWSReqInfo) {</span>
<span class="lineNum">     452 </span><span class="lineNoCov">          0 :             msHTTPFreeRequestObj(pasOWSReqInfo, numOWSRequests);</span>
<span class="lineNum">     453 </span><span class="lineNoCov">          0 :             msFree(pasOWSReqInfo);</span>
<span class="lineNum">     454 </span>            :           }
<span class="lineNum">     455 </span>            : #endif /* USE_WMS_LYR || USE_WFS_LYR */
<span class="lineNum">     456 </span>            :           return(NULL);
<span class="lineNum">     457 </span>            :         }
<span class="lineNum">     458 </span>            :       }
<span class="lineNum">     459 </span><span class="lineCov">          1 :       if(map-&gt;debug &gt;= MS_DEBUGLEVEL_TUNING || lp-&gt;debug &gt;= MS_DEBUGLEVEL_TUNING) {</span>
<span class="lineNum">     460 </span><span class="lineCov">          1 :         msGettimeofday(&amp;endtime, NULL);</span>
<span class="lineNum">     461 </span><span class="lineCov">          1 :         msDebug(&quot;msDrawMap(): Layer %d (%s), %.3fs\n&quot;,</span>
<span class="lineNum">     462 </span><span class="lineCov">          1 :                 map-&gt;layerorder[i], lp-&gt;name?lp-&gt;name:&quot;(null)&quot;,</span>
<span class="lineNum">     463 </span><span class="lineCov">          1 :                 (endtime.tv_sec+endtime.tv_usec/1.0e6)-</span>
<span class="lineNum">     464 </span><span class="lineCov">          1 :                 (starttime.tv_sec+starttime.tv_usec/1.0e6) );</span>
<span class="lineNum">     465 </span>            :       }
<span class="lineNum">     466 </span>            : 
<span class="lineNum">     467 </span>            :       /* Flush layer cache in-between layers if requested by PROCESSING directive*/
<span class="lineNum">     468 </span><span class="lineCov">          1 :       force_draw_label_cache = msLayerGetProcessingKey(lp, &quot;FORCE_DRAW_LABEL_CACHE&quot;);</span>
<span class="lineNum">     469 </span><span class="lineCov">          1 :       if (force_draw_label_cache &amp;&amp;</span>
<span class="lineNum">     470 </span><span class="lineNoCov">          0 :     strncasecmp(force_draw_label_cache,&quot;FLUSH&quot;,5)==0) {</span>
<span class="lineNum">     471 </span><span class="lineNoCov">          0 :   if(map-&gt;debug &gt;= MS_DEBUGLEVEL_V)</span>
<span class="lineNum">     472 </span><span class="lineNoCov">          0 :     msDebug(&quot;msDrawMap(): PROCESSING FORCE_DRAW_LABEL_CACHE=FLUSH found.\n&quot;);</span>
<span class="lineNum">     473 </span><span class="lineNoCov">          0 :   if(msDrawLabelCache(map, image) != MS_SUCCESS) {</span>
<span class="lineNum">     474 </span><span class="lineNoCov">          0 :     msFreeImage(image);</span>
<span class="lineNum">     475 </span>            : #if defined(USE_WMS_LYR) || defined(USE_WFS_LYR)
<span class="lineNum">     476 </span><span class="lineNoCov">          0 :     if (pasOWSReqInfo) {</span>
<span class="lineNum">     477 </span><span class="lineNoCov">          0 :       msHTTPFreeRequestObj(pasOWSReqInfo, numOWSRequests);</span>
<span class="lineNum">     478 </span><span class="lineNoCov">          0 :       msFree(pasOWSReqInfo);</span>
<span class="lineNum">     479 </span>            :     }
<span class="lineNum">     480 </span>            : #endif /* USE_WMS_LYR || USE_WFS_LYR */
<span class="lineNum">     481 </span>            :     return(NULL);
<span class="lineNum">     482 </span>            :   }
<span class="lineNum">     483 </span><span class="lineNoCov">          0 :   msFreeLabelCache(&amp;(map-&gt;labelcache));</span>
<span class="lineNum">     484 </span><span class="lineNoCov">          0 :   msInitLabelCache(&amp;(map-&gt;labelcache));</span>
<span class="lineNum">     485 </span>            :       } /* PROCESSING FORCE_DRAW_LABEL_CACHE */
<span class="lineNum">     486 </span>            : 
<span class="lineNum">     487 </span>            :     }
<span class="lineNum">     488 </span>            :   }
<span class="lineNum">     489 </span>            : 
<span class="lineNum">     490 </span><span class="lineCov">          1 :   if(map-&gt;scalebar.status == MS_EMBED &amp;&amp; !map-&gt;scalebar.postlabelcache) {</span>
<span class="lineNum">     491 </span>            : 
<span class="lineNum">     492 </span>            :     /* We need to temporarily restore the original extent for drawing */
<span class="lineNum">     493 </span>            :     /* the scalebar as it uses the extent to recompute cellsize. */
<span class="lineNum">     494 </span><span class="lineCov">          1 :     if(map-&gt;gt.need_geotransform)</span>
<span class="lineNum">     495 </span><span class="lineCov">          1 :       msMapRestoreRealExtent(map);</span>
<span class="lineNum">     496 </span>            : 
<span class="lineNum">     497 </span>            : 
<span class="lineNum">     498 </span><span class="lineCov">          1 :     if(MS_SUCCESS != msEmbedScalebar(map, image)) {</span>
<span class="lineNum">     499 </span><span class="lineNoCov">          0 :       msFreeImage( image );</span>
<span class="lineNum">     500 </span>            : #if defined(USE_WMS_LYR) || defined(USE_WFS_LYR)
<span class="lineNum">     501 </span>            :       /* Cleanup WMS/WFS Request stuff */
<span class="lineNum">     502 </span><span class="lineNoCov">          0 :       if (pasOWSReqInfo) {</span>
<span class="lineNum">     503 </span><span class="lineNoCov">          0 :          msHTTPFreeRequestObj(pasOWSReqInfo, numOWSRequests);</span>
<span class="lineNum">     504 </span><span class="lineNoCov">          0 :          msFree(pasOWSReqInfo);</span>
<span class="lineNum">     505 </span>            :       }
<span class="lineNum">     506 </span>            : #endif
<span class="lineNum">     507 </span>            :       return NULL;
<span class="lineNum">     508 </span>            :     }
<span class="lineNum">     509 </span>            : 
<span class="lineNum">     510 </span>            : 
<span class="lineNum">     511 </span><span class="lineCov">          1 :     if(map-&gt;gt.need_geotransform)</span>
<span class="lineNum">     512 </span><span class="lineCov">          1 :       msMapSetFakedExtent(map);</span>
<span class="lineNum">     513 </span>            :   }
<span class="lineNum">     514 </span>            : 
<span class="lineNum">     515 </span><span class="lineCov">          1 :   if(map-&gt;legend.status == MS_EMBED &amp;&amp; !map-&gt;legend.postlabelcache) {</span>
<span class="lineNum">     516 </span><span class="lineCov">          1 :     if( msEmbedLegend(map, image) != MS_SUCCESS ) {</span>
<span class="lineNum">     517 </span><span class="lineNoCov">          0 :       msFreeImage( image );</span>
<span class="lineNum">     518 </span>            : #if defined(USE_WMS_LYR) || defined(USE_WFS_LYR)
<span class="lineNum">     519 </span>            :       /* Cleanup WMS/WFS Request stuff */
<span class="lineNum">     520 </span><span class="lineNoCov">          0 :       if (pasOWSReqInfo) {</span>
<span class="lineNum">     521 </span><span class="lineNoCov">          0 :          msHTTPFreeRequestObj(pasOWSReqInfo, numOWSRequests);</span>
<span class="lineNum">     522 </span><span class="lineNoCov">          0 :          msFree(pasOWSReqInfo);</span>
<span class="lineNum">     523 </span>            :       }
<span class="lineNum">     524 </span>            : #endif
<span class="lineNum">     525 </span>            :       return NULL;
<span class="lineNum">     526 </span>            :     }
<span class="lineNum">     527 </span>            :   }
<span class="lineNum">     528 </span>            : 
<span class="lineNum">     529 </span><span class="lineCov">          1 :   if(msDrawLabelCache(map, image) != MS_SUCCESS) {</span>
<span class="lineNum">     530 </span><span class="lineCov">          1 :     msFreeImage(image);</span>
<span class="lineNum">     531 </span>            : #if defined(USE_WMS_LYR) || defined(USE_WFS_LYR)
<span class="lineNum">     532 </span><span class="lineCov">          1 :     if (pasOWSReqInfo) {</span>
<span class="lineNum">     533 </span><span class="lineNoCov">          0 :       msHTTPFreeRequestObj(pasOWSReqInfo, numOWSRequests);</span>
<span class="lineNum">     534 </span><span class="lineNoCov">          0 :       msFree(pasOWSReqInfo);</span>
<span class="lineNum">     535 </span>            :     }
<span class="lineNum">     536 </span>            : #endif /* USE_WMS_LYR || USE_WFS_LYR */
<span class="lineNum">     537 </span>            :     return(NULL);
<span class="lineNum">     538 </span>            :   }
<span class="lineNum">     539 </span>            : 
<span class="lineNum">     540 </span>            : 
<span class="lineNum">     541 </span><span class="lineCov">          1 :   for(i=0; i&lt;map-&gt;numlayers; i++) { /* for each layer, check for postlabelcache layers */</span>
<span class="lineNum">     542 </span>            : 
<span class="lineNum">     543 </span><span class="lineCov">          1 :     lp = (GET_LAYER(map, map-&gt;layerorder[i]));</span>
<span class="lineNum">     544 </span>            : 
<span class="lineNum">     545 </span><span class="lineCov">          1 :     if(!lp-&gt;postlabelcache) continue;</span>
<span class="lineNum">     546 </span><span class="lineNoCov">          0 :     if(!msLayerIsVisible(map, lp)) continue;</span>
<span class="lineNum">     547 </span>            : 
<span class="lineNum">     548 </span><span class="lineNoCov">          0 :     if(map-&gt;debug &gt;= MS_DEBUGLEVEL_TUNING || lp-&gt;debug &gt;= MS_DEBUGLEVEL_TUNING) msGettimeofday(&amp;starttime, NULL);</span>
<span class="lineNum">     549 </span>            : 
<span class="lineNum">     550 </span><span class="lineNoCov">          0 :     if(lp-&gt;connectiontype == MS_WMS) {</span>
<span class="lineNum">     551 </span>            : #ifdef USE_WMS_LYR
<span class="lineNum">     552 </span><span class="lineNoCov">          0 :       if(MS_RENDERER_PLUGIN(image-&gt;format) || MS_RENDERER_RAWDATA(image-&gt;format))</span>
<span class="lineNum">     553 </span><span class="lineNoCov">          0 :         status = msDrawWMSLayerLow(map-&gt;layerorder[i], pasOWSReqInfo, numOWSRequests, map, lp, image);</span>
<span class="lineNum">     554 </span>            : 
<span class="lineNum">     555 </span>            : #else
<span class="lineNum">     556 </span>            :       status = MS_FAILURE;
<span class="lineNum">     557 </span>            : #endif
<span class="lineNum">     558 </span>            :     } else {
<span class="lineNum">     559 </span><span class="lineNoCov">          0 :       if(querymap)</span>
<span class="lineNum">     560 </span><span class="lineNoCov">          0 :         status = msDrawQueryLayer(map, lp, image);</span>
<span class="lineNum">     561 </span>            :       else
<span class="lineNum">     562 </span><span class="lineNoCov">          0 :         status = msDrawLayer(map, lp, image);</span>
<span class="lineNum">     563 </span>            :     }
<span class="lineNum">     564 </span>            : 
<span class="lineNum">     565 </span><span class="lineNoCov">          0 :     if(status == MS_FAILURE) {</span>
<span class="lineNum">     566 </span><span class="lineNoCov">          0 :       msFreeImage(image);</span>
<span class="lineNum">     567 </span>            : #if defined(USE_WMS_LYR) || defined(USE_WFS_LYR)
<span class="lineNum">     568 </span><span class="lineNoCov">          0 :       if (pasOWSReqInfo) {</span>
<span class="lineNum">     569 </span><span class="lineNoCov">          0 :         msHTTPFreeRequestObj(pasOWSReqInfo, numOWSRequests);</span>
<span class="lineNum">     570 </span><span class="lineNoCov">          0 :         msFree(pasOWSReqInfo);</span>
<span class="lineNum">     571 </span>            :       }
<span class="lineNum">     572 </span>            : #endif /* USE_WMS_LYR || USE_WFS_LYR */
<span class="lineNum">     573 </span>            :       return(NULL);
<span class="lineNum">     574 </span>            :     }
<span class="lineNum">     575 </span>            : 
<span class="lineNum">     576 </span><span class="lineNoCov">          0 :     if(map-&gt;debug &gt;= MS_DEBUGLEVEL_TUNING || lp-&gt;debug &gt;= MS_DEBUGLEVEL_TUNING) {</span>
<span class="lineNum">     577 </span><span class="lineNoCov">          0 :       msGettimeofday(&amp;endtime, NULL);</span>
<span class="lineNum">     578 </span><span class="lineNoCov">          0 :       msDebug(&quot;msDrawMap(): Layer %d (%s), %.3fs\n&quot;,</span>
<span class="lineNum">     579 </span><span class="lineNoCov">          0 :               map-&gt;layerorder[i], lp-&gt;name?lp-&gt;name:&quot;(null)&quot;,</span>
<span class="lineNum">     580 </span><span class="lineNoCov">          0 :               (endtime.tv_sec+endtime.tv_usec/1.0e6)-</span>
<span class="lineNum">     581 </span><span class="lineNoCov">          0 :               (starttime.tv_sec+starttime.tv_usec/1.0e6) );</span>
<span class="lineNum">     582 </span>            :     }
<span class="lineNum">     583 </span>            : 
<span class="lineNum">     584 </span>            :   }
<span class="lineNum">     585 </span>            : 
<span class="lineNum">     586 </span>            :   /* Do we need to fake out stuff for rotated support? */
<span class="lineNum">     587 </span>            :   /* This really needs to be done on every preceeding exit point too... */
<span class="lineNum">     588 </span><span class="lineCov">          1 :   if(map-&gt;gt.need_geotransform)</span>
<span class="lineNum">     589 </span><span class="lineCov">          1 :     msMapRestoreRealExtent(map);</span>
<span class="lineNum">     590 </span>            : 
<span class="lineNum">     591 </span><span class="lineCov">          1 :   if(map-&gt;legend.status == MS_EMBED &amp;&amp; map-&gt;legend.postlabelcache)</span>
<span class="lineNum">     592 </span><span class="lineCov">          1 :     if(UNLIKELY(MS_FAILURE == msEmbedLegend(map, image))) {</span>
<span class="lineNum">     593 </span><span class="lineNoCov">          0 :       msFreeImage( image );</span>
<span class="lineNum">     594 </span><span class="lineNoCov">          0 :       return NULL;</span>
<span class="lineNum">     595 </span>            :     }
<span class="lineNum">     596 </span>            : 
<span class="lineNum">     597 </span><span class="lineCov">          1 :   if(map-&gt;scalebar.status == MS_EMBED &amp;&amp; map-&gt;scalebar.postlabelcache) {</span>
<span class="lineNum">     598 </span>            : 
<span class="lineNum">     599 </span>            :     /* We need to temporarily restore the original extent for drawing */
<span class="lineNum">     600 </span>            :     /* the scalebar as it uses the extent to recompute cellsize. */
<span class="lineNum">     601 </span><span class="lineCov">          1 :     if(map-&gt;gt.need_geotransform)</span>
<span class="lineNum">     602 </span><span class="lineNoCov">          0 :       msMapRestoreRealExtent(map);</span>
<span class="lineNum">     603 </span>            : 
<span class="lineNum">     604 </span>            : 
<span class="lineNum">     605 </span><span class="lineCov">          1 :     if(MS_SUCCESS != msEmbedScalebar(map, image)) {</span>
<span class="lineNum">     606 </span><span class="lineNoCov">          0 :       msFreeImage( image );</span>
<span class="lineNum">     607 </span>            : #if defined(USE_WMS_LYR) || defined(USE_WFS_LYR)
<span class="lineNum">     608 </span>            :       /* Cleanup WMS/WFS Request stuff */
<span class="lineNum">     609 </span><span class="lineNoCov">          0 :       if (pasOWSReqInfo) {</span>
<span class="lineNum">     610 </span><span class="lineNoCov">          0 :          msHTTPFreeRequestObj(pasOWSReqInfo, numOWSRequests);</span>
<span class="lineNum">     611 </span><span class="lineNoCov">          0 :          msFree(pasOWSReqInfo);</span>
<span class="lineNum">     612 </span>            :       }
<span class="lineNum">     613 </span>            : #endif
<span class="lineNum">     614 </span>            :       return NULL;
<span class="lineNum">     615 </span>            :     }
<span class="lineNum">     616 </span>            : 
<span class="lineNum">     617 </span>            : 
<span class="lineNum">     618 </span><span class="lineCov">          1 :     if(map-&gt;gt.need_geotransform)</span>
<span class="lineNum">     619 </span><span class="lineNoCov">          0 :       msMapSetFakedExtent(map);</span>
<span class="lineNum">     620 </span>            :   }
<span class="lineNum">     621 </span>            : 
<span class="lineNum">     622 </span>            : #if defined(USE_WMS_LYR) || defined(USE_WFS_LYR)
<span class="lineNum">     623 </span>            :   /* Cleanup WMS/WFS Request stuff */
<span class="lineNum">     624 </span><span class="lineCov">          1 :   if (pasOWSReqInfo) {</span>
<span class="lineNum">     625 </span><span class="lineCov">          1 :     msHTTPFreeRequestObj(pasOWSReqInfo, numOWSRequests);</span>
<span class="lineNum">     626 </span><span class="lineCov">          1 :     msFree(pasOWSReqInfo);</span>
<span class="lineNum">     627 </span>            :   }
<span class="lineNum">     628 </span>            : #endif
<span class="lineNum">     629 </span>            : 
<span class="lineNum">     630 </span><span class="lineCov">          1 :   if(map-&gt;debug &gt;= MS_DEBUGLEVEL_TUNING) {</span>
<span class="lineNum">     631 </span><span class="lineCov">          1 :     msGettimeofday(&amp;mapendtime, NULL);</span>
<span class="lineNum">     632 </span><span class="lineCov">          1 :     msDebug(&quot;msDrawMap() total time: %.3fs\n&quot;,</span>
<span class="lineNum">     633 </span><span class="lineCov">          1 :             (mapendtime.tv_sec+mapendtime.tv_usec/1.0e6)-</span>
<span class="lineNum">     634 </span><span class="lineCov">          1 :             (mapstarttime.tv_sec+mapstarttime.tv_usec/1.0e6) );</span>
<span class="lineNum">     635 </span>            :   }
<span class="lineNum">     636 </span>            : 
<span class="lineNum">     637 </span>            :   return(image);
<span class="lineNum">     638 </span>            : }
<span class="lineNum">     639 </span>            : 
<span class="lineNum">     640 </span>            : /*
<span class="lineNum">     641 </span>            :  * Test whether a layer should be drawn or not in the current map view and
<span class="lineNum">     642 </span>            :  * at the current scale.
<a name="643"><span class="lineNum">     643 </span>            :  * Returns TRUE if layer is visible, FALSE if not.</a>
<span class="lineNum">     644 </span>            : */
<span class="lineNum">     645 </span><span class="lineCov">          1 : int msLayerIsVisible(mapObj *map, layerObj *layer)</span>
<span class="lineNum">     646 </span>            : {
<span class="lineNum">     647 </span>            :   int i;
<span class="lineNum">     648 </span>            : 
<span class="lineNum">     649 </span><span class="lineCov">          1 :   if(!layer-&gt;data &amp;&amp; !layer-&gt;tileindex &amp;&amp; !layer-&gt;connection &amp;&amp; !layer-&gt;features &amp;&amp; !layer-&gt;grid)</span>
<span class="lineNum">     650 </span>            :     return(MS_FALSE); /* no data associated with this layer, not an error since layer may be used as a template from MapScript */
<span class="lineNum">     651 </span>            : 
<span class="lineNum">     652 </span><span class="lineCov">          1 :   if(layer-&gt;type == MS_LAYER_QUERY || layer-&gt;type == MS_LAYER_TILEINDEX) return(MS_FALSE);</span>
<span class="lineNum">     653 </span><span class="lineCov">          1 :   if((layer-&gt;status != MS_ON) &amp;&amp; (layer-&gt;status != MS_DEFAULT)) return(MS_FALSE);</span>
<span class="lineNum">     654 </span>            : 
<span class="lineNum">     655 </span>            :   /* Do comparisons of layer scale vs map scale now, since msExtentsOverlap() */
<span class="lineNum">     656 </span>            :   /* can be slow */
<span class="lineNum">     657 </span><span class="lineCov">          1 :   if(map-&gt;scaledenom &gt; 0) {</span>
<span class="lineNum">     658 </span>            : 
<span class="lineNum">     659 </span>            :     /* layer scale boundaries should be checked first */
<span class="lineNum">     660 </span><span class="lineCov">          1 :     if((layer-&gt;maxscaledenom &gt; 0) &amp;&amp; (map-&gt;scaledenom &gt; layer-&gt;maxscaledenom)) {</span>
<span class="lineNum">     661 </span><span class="lineCov">          1 :       if( layer-&gt;debug &gt;= MS_DEBUGLEVEL_V ) {</span>
<span class="lineNum">     662 </span><span class="lineNoCov">          0 :         msDebug(&quot;msLayerIsVisible(): Skipping layer (%s) because LAYER.MAXSCALE is too small for this MAP scale\n&quot;, layer-&gt;name);</span>
<span class="lineNum">     663 </span>            :       }
<span class="lineNum">     664 </span>            :       return(MS_FALSE);
<span class="lineNum">     665 </span>            :     }
<span class="lineNum">     666 </span><span class="lineCov">          1 :     if(/*(layer-&gt;minscaledenom &gt; 0) &amp;&amp;*/ (map-&gt;scaledenom &lt;= layer-&gt;minscaledenom)) {</span>
<span class="lineNum">     667 </span><span class="lineNoCov">          0 :       if( layer-&gt;debug &gt;= MS_DEBUGLEVEL_V ) {</span>
<span class="lineNum">     668 </span><span class="lineNoCov">          0 :         msDebug(&quot;msLayerIsVisible(): Skipping layer (%s) because LAYER.MINSCALE is too large for this MAP scale\n&quot;, layer-&gt;name);</span>
<span class="lineNum">     669 </span>            :       }
<span class="lineNum">     670 </span>            :       return(MS_FALSE);
<span class="lineNum">     671 </span>            :     }
<span class="lineNum">     672 </span>            :   }
<span class="lineNum">     673 </span>            : 
<span class="lineNum">     674 </span>            :   /* Only return MS_FALSE if it is definitely false. Sometimes it will return MS_UNKNOWN, which we
<span class="lineNum">     675 </span>            :   ** consider true, for this use case (it might be visible, try and draw it, see what happens). */
<span class="lineNum">     676 </span><span class="lineCov">          1 :   if ( msExtentsOverlap(map, layer) == MS_FALSE ) {</span>
<span class="lineNum">     677 </span><span class="lineCov">          1 :     if( layer-&gt;debug &gt;= MS_DEBUGLEVEL_V ) {</span>
<span class="lineNum">     678 </span><span class="lineNoCov">          0 :       msDebug(&quot;msLayerIsVisible(): Skipping layer (%s) because LAYER.EXTENT does not intersect MAP.EXTENT\n&quot;, layer-&gt;name);</span>
<span class="lineNum">     679 </span>            :     }
<span class="lineNum">     680 </span>            :     return(MS_FALSE);
<span class="lineNum">     681 </span>            :   }
<span class="lineNum">     682 </span>            : 
<span class="lineNum">     683 </span><span class="lineCov">          1 :   if(msEvalContext(map, layer, layer-&gt;requires) == MS_FALSE) return(MS_FALSE);</span>
<span class="lineNum">     684 </span>            : 
<span class="lineNum">     685 </span><span class="lineCov">          1 :   if(map-&gt;scaledenom &gt; 0) {</span>
<span class="lineNum">     686 </span>            : 
<span class="lineNum">     687 </span>            :     /* now check class scale boundaries (all layers *must* pass these tests) */
<span class="lineNum">     688 </span><span class="lineCov">          1 :     if(layer-&gt;numclasses &gt; 0) {</span>
<span class="lineNum">     689 </span><span class="lineNoCov">          0 :       for(i=0; i&lt;layer-&gt;numclasses; i++) {</span>
<span class="lineNum">     690 </span><span class="lineCov">          1 :         if((layer-&gt;class[i]-&gt;maxscaledenom &gt; 0) &amp;&amp; (map-&gt;scaledenom &gt; layer-&gt;class[i]-&gt;maxscaledenom))</span>
<span class="lineNum">     691 </span><span class="lineNoCov">          0 :           continue; /* can skip this one, next class */</span>
<span class="lineNum">     692 </span><span class="lineCov">          1 :         if((layer-&gt;class[i]-&gt;minscaledenom &gt; 0) &amp;&amp; (map-&gt;scaledenom &lt;= layer-&gt;class[i]-&gt;minscaledenom))</span>
<span class="lineNum">     693 </span><span class="lineNoCov">          0 :           continue; /* can skip this one, next class */</span>
<span class="lineNum">     694 </span>            : 
<span class="lineNum">     695 </span>            :         break; /* can't skip this class (or layer for that matter) */
<span class="lineNum">     696 </span>            :       }
<span class="lineNum">     697 </span><span class="lineCov">          1 :       if(i == layer-&gt;numclasses) {</span>
<span class="lineNum">     698 </span><span class="lineNoCov">          0 :         if( layer-&gt;debug &gt;= MS_DEBUGLEVEL_V ) {</span>
<span class="lineNum">     699 </span><span class="lineNoCov">          0 :           msDebug(&quot;msLayerIsVisible(): Skipping layer (%s) because no CLASS in the layer is in-scale for this MAP scale\n&quot;, layer-&gt;name);</span>
<span class="lineNum">     700 </span>            :         }
<span class="lineNum">     701 </span>            :         return(MS_FALSE);
<span class="lineNum">     702 </span>            :       }
<span class="lineNum">     703 </span>            :     }
<span class="lineNum">     704 </span>            : 
<span class="lineNum">     705 </span>            :   }
<span class="lineNum">     706 </span>            : 
<span class="lineNum">     707 </span><span class="lineCov">          1 :   if (layer-&gt;maxscaledenom &lt;= 0 &amp;&amp; layer-&gt;minscaledenom &lt;= 0) {</span>
<span class="lineNum">     708 </span><span class="lineCov">          1 :     if((layer-&gt;maxgeowidth &gt; 0) &amp;&amp; ((map-&gt;extent.maxx - map-&gt;extent.minx) &gt; layer-&gt;maxgeowidth)) {</span>
<span class="lineNum">     709 </span><span class="lineNoCov">          0 :       if( layer-&gt;debug &gt;= MS_DEBUGLEVEL_V ) {</span>
<span class="lineNum">     710 </span><span class="lineNoCov">          0 :         msDebug(&quot;msLayerIsVisible(): Skipping layer (%s) because LAYER width is much smaller than map width\n&quot;, layer-&gt;name);</span>
<span class="lineNum">     711 </span>            :       }
<span class="lineNum">     712 </span>            :       return(MS_FALSE);
<span class="lineNum">     713 </span>            :     }
<span class="lineNum">     714 </span><span class="lineCov">          1 :     if((layer-&gt;mingeowidth &gt; 0) &amp;&amp; ((map-&gt;extent.maxx - map-&gt;extent.minx) &lt; layer-&gt;mingeowidth)) {</span>
<span class="lineNum">     715 </span><span class="lineNoCov">          0 :       if( layer-&gt;debug &gt;= MS_DEBUGLEVEL_V ) {</span>
<span class="lineNum">     716 </span><span class="lineNoCov">          0 :         msDebug(&quot;msLayerIsVisible(): Skipping layer (%s) because LAYER width is much larger than map width\n&quot;, layer-&gt;name);</span>
<span class="lineNum">     717 </span>            :       }
<span class="lineNum">     718 </span>            :       return(MS_FALSE);
<span class="lineNum">     719 </span>            :     }
<span class="lineNum">     720 </span>            :   }
<span class="lineNum">     721 </span>            : 
<span class="lineNum">     722 </span>            :   return MS_TRUE;  /* All tests passed.  Layer is visible. */
<span class="lineNum">     723 </span>            : }
<span class="lineNum">     724 </span>            : 
<span class="lineNum">     725 </span>            : 
<span class="lineNum">     726 </span>            : #define LAYER_NEEDS_COMPOSITING(layer) (((layer)-&gt;compositer != NULL) &amp;&amp; ((layer)-&gt;compositer-&gt;next || (layer)-&gt;compositor-&gt;opacity &lt; 100 || (layer)-&gt;compositor-&gt;compop != MS_COMPOP_SRC_OVER || (layer)-&gt;compositer-&gt;filter ))
<span class="lineNum">     727 </span>            : /*
<a name="728"><span class="lineNum">     728 </span>            :  * Generic function to render a layer object.</a>
<span class="lineNum">     729 </span>            : */
<span class="lineNum">     730 </span><span class="lineCov">          1 : int msDrawLayer(mapObj *map, layerObj *layer, imageObj *image)</span>
<span class="lineNum">     731 </span>            : {
<span class="lineNum">     732 </span>            :   imageObj *image_draw = image;
<span class="lineNum">     733 </span>            :   outputFormatObj *altFormat=NULL;
<span class="lineNum">     734 </span>            :   int retcode=MS_SUCCESS;
<span class="lineNum">     735 </span>            :   const char *alternativeFomatString = NULL;
<span class="lineNum">     736 </span>            :   layerObj *maskLayer = NULL;
<span class="lineNum">     737 </span>            : 
<span class="lineNum">     738 </span><span class="lineCov">          1 :   if(!msLayerIsVisible(map, layer))</span>
<span class="lineNum">     739 </span>            :     return MS_SUCCESS;
<span class="lineNum">     740 </span>            : 
<span class="lineNum">     741 </span><span class="lineCov">          1 :   if(layer-&gt;compositer &amp;&amp; !layer-&gt;compositer-&gt;next &amp;&amp; layer-&gt;compositer-&gt;opacity == 0) return MS_SUCCESS; /* layer is completely transparent, skip it */</span>
<span class="lineNum">     742 </span>            :   
<span class="lineNum">     743 </span>            : 
<span class="lineNum">     744 </span>            :   /* conditions may have changed since this layer last drawn, so retest
<span class="lineNum">     745 </span>            :      layer-&gt;project (Bug #673) */
<span class="lineNum">     746 </span><span class="lineCov">          1 :   layer-&gt;project = msProjectionsDiffer(&amp;(layer-&gt;projection),&amp;(map-&gt;projection));</span>
<span class="lineNum">     747 </span>            : 
<span class="lineNum">     748 </span>            :   /* make sure labelcache setting is set correctly if postlabelcache is set. This is done by the parser but
<span class="lineNum">     749 </span>            :      may have been altered by a mapscript. see #5142 */
<span class="lineNum">     750 </span><span class="lineCov">          1 :   if(layer-&gt;postlabelcache) {</span>
<span class="lineNum">     751 </span><span class="lineNoCov">          0 :     layer-&gt;labelcache = MS_FALSE;</span>
<span class="lineNum">     752 </span>            :   }
<span class="lineNum">     753 </span>            : 
<span class="lineNum">     754 </span><span class="lineCov">          1 :   if(layer-&gt;mask) {</span>
<span class="lineNum">     755 </span>            :     int maskLayerIdx;
<span class="lineNum">     756 </span>            :     /* render the mask layer in its own imageObj */
<span class="lineNum">     757 </span><span class="lineCov">          1 :     if(!MS_IMAGE_RENDERER(image)-&gt;supports_pixel_buffer) {</span>
<span class="lineNum">     758 </span><span class="lineNoCov">          0 :       msSetError(MS_MISCERR, &quot;Layer (%s) references references a mask layer, but the selected renderer does not support them&quot;, &quot;msDrawLayer()&quot;,</span>
<span class="lineNum">     759 </span>            :                  layer-&gt;name);
<span class="lineNum">     760 </span><span class="lineNoCov">          0 :       return (MS_FAILURE);</span>
<span class="lineNum">     761 </span>            :     }
<span class="lineNum">     762 </span><span class="lineCov">          1 :     maskLayerIdx = msGetLayerIndex(map,layer-&gt;mask);</span>
<span class="lineNum">     763 </span><span class="lineCov">          1 :     if(maskLayerIdx == -1) {</span>
<span class="lineNum">     764 </span><span class="lineNoCov">          0 :       msSetError(MS_MISCERR, &quot;Layer (%s) references unknown mask layer (%s)&quot;, &quot;msDrawLayer()&quot;,</span>
<span class="lineNum">     765 </span>            :                  layer-&gt;name,layer-&gt;mask);
<span class="lineNum">     766 </span><span class="lineNoCov">          0 :       return (MS_FAILURE);</span>
<span class="lineNum">     767 </span>            :     }
<span class="lineNum">     768 </span><span class="lineCov">          1 :     maskLayer = GET_LAYER(map, maskLayerIdx);</span>
<span class="lineNum">     769 </span><span class="lineCov">          1 :     if(!maskLayer-&gt;maskimage) {</span>
<span class="lineNum">     770 </span>            :       int i;
<span class="lineNum">     771 </span>            :       int origstatus, origlabelcache;
<span class="lineNum">     772 </span><span class="lineCov">          1 :       altFormat =  msSelectOutputFormat(map, &quot;png24&quot;);</span>
<span class="lineNum">     773 </span><span class="lineCov">          1 :       msInitializeRendererVTable(altFormat);</span>
<span class="lineNum">     774 </span>            :       /* TODO: check the png24 format hasn't been tampered with, i.e. it's agg */
<span class="lineNum">     775 </span><span class="lineCov">          1 :       maskLayer-&gt;maskimage= msImageCreate(image-&gt;width, image-&gt;height,altFormat,</span>
<span class="lineNum">     776 </span>            :                                           image-&gt;imagepath, image-&gt;imageurl, map-&gt;resolution, map-&gt;defresolution, NULL);
<span class="lineNum">     777 </span><span class="lineCov">          1 :       if (!maskLayer-&gt;maskimage) {</span>
<span class="lineNum">     778 </span><span class="lineNoCov">          0 :         msSetError(MS_MISCERR, &quot;Unable to initialize mask image.&quot;, &quot;msDrawLayer()&quot;);</span>
<span class="lineNum">     779 </span><span class="lineNoCov">          0 :         return (MS_FAILURE);</span>
<span class="lineNum">     780 </span>            :       }
<span class="lineNum">     781 </span>            : 
<span class="lineNum">     782 </span>            :       /*
<span class="lineNum">     783 </span>            :        * force the masked layer to status on, and turn off the labelcache so that
<span class="lineNum">     784 </span>            :        * eventual labels are added to the temporary image instead of being added
<span class="lineNum">     785 </span>            :        * to the labelcache
<span class="lineNum">     786 </span>            :        */
<span class="lineNum">     787 </span><span class="lineCov">          1 :       origstatus = maskLayer-&gt;status;</span>
<span class="lineNum">     788 </span><span class="lineCov">          1 :       origlabelcache = maskLayer-&gt;labelcache;</span>
<span class="lineNum">     789 </span><span class="lineCov">          1 :       maskLayer-&gt;status = MS_ON;</span>
<span class="lineNum">     790 </span><span class="lineCov">          1 :       maskLayer-&gt;labelcache = MS_OFF;</span>
<span class="lineNum">     791 </span>            : 
<span class="lineNum">     792 </span>            :       /* draw the mask layer in the temporary image */
<span class="lineNum">     793 </span><span class="lineCov">          1 :       retcode = msDrawLayer(map, maskLayer, maskLayer-&gt;maskimage);</span>
<span class="lineNum">     794 </span><span class="lineCov">          1 :       maskLayer-&gt;status = origstatus;</span>
<span class="lineNum">     795 </span><span class="lineCov">          1 :       maskLayer-&gt;labelcache = origlabelcache;</span>
<span class="lineNum">     796 </span><span class="lineCov">          1 :       if(retcode != MS_SUCCESS) {</span>
<span class="lineNum">     797 </span>            :         return MS_FAILURE;
<span class="lineNum">     798 </span>            :       }
<span class="lineNum">     799 </span>            :       /*
<span class="lineNum">     800 </span>            :        * hack to work around bug #3834: if we have use an alternate renderer, the symbolset may contain
<span class="lineNum">     801 </span>            :        * symbols that reference it. We want to remove those references before the altFormat is destroyed
<span class="lineNum">     802 </span>            :        * to avoid a segfault and/or a leak, and so the the main renderer doesn't pick the cache up thinking
<span class="lineNum">     803 </span>            :        * it's for him.
<span class="lineNum">     804 </span>            :        */
<span class="lineNum">     805 </span><span class="lineCov">          1 :       for(i=0; i&lt;map-&gt;symbolset.numsymbols; i++) {</span>
<span class="lineNum">     806 </span><span class="lineCov">          1 :         if (map-&gt;symbolset.symbol[i]!=NULL) {</span>
<span class="lineNum">     807 </span>            :           symbolObj *s = map-&gt;symbolset.symbol[i];
<span class="lineNum">     808 </span><span class="lineCov">          1 :           if(s-&gt;renderer == MS_IMAGE_RENDERER(maskLayer-&gt;maskimage)) {</span>
<span class="lineNum">     809 </span><span class="lineNoCov">          0 :             MS_IMAGE_RENDERER(maskLayer-&gt;maskimage)-&gt;freeSymbol(s);</span>
<span class="lineNum">     810 </span><span class="lineNoCov">          0 :             s-&gt;renderer = NULL;</span>
<span class="lineNum">     811 </span>            :           }
<span class="lineNum">     812 </span>            :         }
<span class="lineNum">     813 </span>            :       }
<span class="lineNum">     814 </span>            :       /* set the imagetype from the original outputformat back (it was removed by msSelectOutputFormat() */
<span class="lineNum">     815 </span><span class="lineCov">          1 :       msFree(map-&gt;imagetype);</span>
<span class="lineNum">     816 </span><span class="lineCov">          1 :       map-&gt;imagetype = msStrdup(image-&gt;format-&gt;name);</span>
<span class="lineNum">     817 </span>            :     }
<span class="lineNum">     818 </span>            : 
<span class="lineNum">     819 </span>            :   }
<span class="lineNum">     820 </span>            :   altFormat = NULL;
<span class="lineNum">     821 </span>            :   /* inform the rendering device that layer draw is starting. */
<span class="lineNum">     822 </span><span class="lineCov">          1 :   msImageStartLayer(map, layer, image);</span>
<span class="lineNum">     823 </span>            : 
<span class="lineNum">     824 </span>            : 
<span class="lineNum">     825 </span>            :   /*check if an alternative renderer should be used for this layer*/
<span class="lineNum">     826 </span><span class="lineCov">          1 :   alternativeFomatString = msLayerGetProcessingKey( layer, &quot;RENDERER&quot;);</span>
<span class="lineNum">     827 </span><span class="lineCov">          1 :   if (MS_RENDERER_PLUGIN(image_draw-&gt;format) &amp;&amp; alternativeFomatString!=NULL &amp;&amp;</span>
<span class="lineNum">     828 </span><span class="lineNoCov">          0 :       (altFormat=  msSelectOutputFormat(map, alternativeFomatString))) {</span>
<span class="lineNum">     829 </span>            :     rendererVTableObj *renderer=NULL;
<span class="lineNum">     830 </span><span class="lineNoCov">          0 :     msInitializeRendererVTable(altFormat);</span>
<span class="lineNum">     831 </span>            : 
<span class="lineNum">     832 </span><span class="lineNoCov">          0 :     image_draw = msImageCreate(image-&gt;width, image-&gt;height,</span>
<span class="lineNum">     833 </span>            :                                altFormat, image-&gt;imagepath, image-&gt;imageurl, map-&gt;resolution, map-&gt;defresolution, &amp;map-&gt;imagecolor);
<span class="lineNum">     834 </span><span class="lineNoCov">          0 :     renderer = MS_IMAGE_RENDERER(image_draw);</span>
<span class="lineNum">     835 </span><span class="lineNoCov">          0 :     renderer-&gt;startLayer(image_draw,map,layer);</span>
<span class="lineNum">     836 </span><span class="lineCov">          1 :   } else if (MS_RENDERER_PLUGIN(image_draw-&gt;format)) {</span>
<span class="lineNum">     837 </span><span class="lineCov">          1 :     rendererVTableObj *renderer = MS_IMAGE_RENDERER(image_draw);</span>
<span class="lineNum">     838 </span><span class="lineCov">          1 :     if ((layer-&gt;mask &amp;&amp; layer-&gt;connectiontype!=MS_WMS &amp;&amp; layer-&gt;type != MS_LAYER_RASTER) || layer-&gt;compositer) {</span>
<span class="lineNum">     839 </span>            :       /* masking occurs at the pixel/layer level for raster images, so we don't need to create a temporary image
<span class="lineNum">     840 </span>            :        in these cases
<span class="lineNum">     841 </span>            :        */
<span class="lineNum">     842 </span><span class="lineCov">          1 :       if (layer-&gt;mask || renderer-&gt;compositeRasterBuffer) {</span>
<span class="lineNum">     843 </span><span class="lineCov">          1 :         image_draw = msImageCreate(image-&gt;width, image-&gt;height,</span>
<span class="lineNum">     844 </span>            :                                    image-&gt;format, image-&gt;imagepath, image-&gt;imageurl, map-&gt;resolution, map-&gt;defresolution, NULL);
<span class="lineNum">     845 </span><span class="lineCov">          1 :         if (!image_draw) {</span>
<span class="lineNum">     846 </span><span class="lineNoCov">          0 :           msSetError(MS_MISCERR, &quot;Unable to initialize temporary transparent image.&quot;,</span>
<span class="lineNum">     847 </span>            :                      &quot;msDrawLayer()&quot;);
<span class="lineNum">     848 </span><span class="lineNoCov">          0 :           return (MS_FAILURE);</span>
<span class="lineNum">     849 </span>            :         }
<span class="lineNum">     850 </span><span class="lineCov">          1 :         image_draw-&gt;map = map;</span>
<span class="lineNum">     851 </span><span class="lineCov">          1 :         renderer-&gt;startLayer(image_draw,map,layer);</span>
<span class="lineNum">     852 </span>            :       }
<span class="lineNum">     853 </span>            :     }
<span class="lineNum">     854 </span>            :   }
<span class="lineNum">     855 </span>            :   /*
<span class="lineNum">     856 </span>            :   ** redirect procesing of some layer types.
<span class="lineNum">     857 </span>            :   */
<span class="lineNum">     858 </span><span class="lineCov">          1 :   if(layer-&gt;connectiontype == MS_WMS) {</span>
<span class="lineNum">     859 </span>            : #ifdef USE_WMS_LYR
<span class="lineNum">     860 </span><span class="lineNoCov">          0 :     retcode = msDrawWMSLayer(map, layer, image_draw);</span>
<span class="lineNum">     861 </span>            : #else
<span class="lineNum">     862 </span>            :     retcode = MS_FAILURE;
<span class="lineNum">     863 </span>            : #endif
<span class="lineNum">     864 </span><span class="lineCov">          1 :   } else if(layer-&gt;type == MS_LAYER_RASTER) {</span>
<span class="lineNum">     865 </span><span class="lineCov">          1 :     retcode = msDrawRasterLayer(map, layer, image_draw);</span>
<span class="lineNum">     866 </span><span class="lineCov">          1 :   } else if(layer-&gt;type == MS_LAYER_CHART) {</span>
<span class="lineNum">     867 </span><span class="lineCov">          1 :     retcode = msDrawChartLayer(map, layer, image_draw);</span>
<span class="lineNum">     868 </span>            :   } else {   /* must be a Vector layer */
<span class="lineNum">     869 </span><span class="lineCov">          1 :     retcode = msDrawVectorLayer(map, layer, image_draw);</span>
<span class="lineNum">     870 </span>            :   }
<span class="lineNum">     871 </span>            : 
<span class="lineNum">     872 </span><span class="lineCov">          1 :   if (altFormat) {</span>
<span class="lineNum">     873 </span><span class="lineNoCov">          0 :     rendererVTableObj *renderer = MS_IMAGE_RENDERER(image);</span>
<span class="lineNum">     874 </span><span class="lineNoCov">          0 :     rendererVTableObj *altrenderer = MS_IMAGE_RENDERER(image_draw);</span>
<span class="lineNum">     875 </span>            :     rasterBufferObj rb;
<span class="lineNum">     876 </span>            :     int i;
<span class="lineNum">     877 </span>            :     memset(&amp;rb,0,sizeof(rasterBufferObj));
<span class="lineNum">     878 </span>            : 
<span class="lineNum">     879 </span><span class="lineNoCov">          0 :     altrenderer-&gt;endLayer(image_draw,map,layer);</span>
<span class="lineNum">     880 </span>            : 
<span class="lineNum">     881 </span><span class="lineNoCov">          0 :     retcode = altrenderer-&gt;getRasterBufferHandle(image_draw,&amp;rb);</span>
<span class="lineNum">     882 </span><span class="lineNoCov">          0 :     if(UNLIKELY(retcode == MS_FAILURE)) {</span>
<span class="lineNum">     883 </span>            :       goto altformat_cleanup;
<span class="lineNum">     884 </span>            :     }
<span class="lineNum">     885 </span><span class="lineNoCov">          0 :     retcode = renderer-&gt;mergeRasterBuffer(image,&amp;rb,((layer-&gt;compositer)?(layer-&gt;compositer-&gt;opacity*0.01):(1.0)),0,0,0,0,rb.width,rb.height);</span>
<span class="lineNum">     886 </span>            :     if(UNLIKELY(retcode == MS_FAILURE)) {
<span class="lineNum">     887 </span>            :       goto altformat_cleanup;
<span class="lineNum">     888 </span>            :     }
<span class="lineNum">     889 </span>            : 
<span class="lineNum">     890 </span><span class="lineNoCov">          0 : altformat_cleanup:</span>
<span class="lineNum">     891 </span>            :     /*
<span class="lineNum">     892 </span>            :      * hack to work around bug #3834: if we have use an alternate renderer, the symbolset may contain
<span class="lineNum">     893 </span>            :      * symbols that reference it. We want to remove those references before the altFormat is destroyed
<span class="lineNum">     894 </span>            :      * to avoid a segfault and/or a leak, and so the the main renderer doesn't pick the cache up thinking
<span class="lineNum">     895 </span>            :      * it's for him.
<span class="lineNum">     896 </span>            :      */
<span class="lineNum">     897 </span><span class="lineNoCov">          0 :     for(i=0; i&lt;map-&gt;symbolset.numsymbols; i++) {</span>
<span class="lineNum">     898 </span><span class="lineNoCov">          0 :       if (map-&gt;symbolset.symbol[i]!=NULL) {</span>
<span class="lineNum">     899 </span>            :         symbolObj *s = map-&gt;symbolset.symbol[i];
<span class="lineNum">     900 </span><span class="lineNoCov">          0 :         if(s-&gt;renderer == altrenderer) {</span>
<span class="lineNum">     901 </span><span class="lineNoCov">          0 :           altrenderer-&gt;freeSymbol(s);</span>
<span class="lineNum">     902 </span><span class="lineNoCov">          0 :           s-&gt;renderer = NULL;</span>
<span class="lineNum">     903 </span>            :         }
<span class="lineNum">     904 </span>            :       }
<span class="lineNum">     905 </span>            :     }
<span class="lineNum">     906 </span><span class="lineNoCov">          0 :     msFreeImage(image_draw);</span>
<span class="lineNum">     907 </span>            :     /* set the imagetype from the original outputformat back (it was removed by msSelectOutputFormat() */
<span class="lineNum">     908 </span><span class="lineNoCov">          0 :     msFree(map-&gt;imagetype);</span>
<span class="lineNum">     909 </span><span class="lineNoCov">          0 :     map-&gt;imagetype = msStrdup(image-&gt;format-&gt;name);</span>
<span class="lineNum">     910 </span><span class="lineCov">          1 :   } else if( image != image_draw) {</span>
<span class="lineNum">     911 </span><span class="lineCov">          1 :     rendererVTableObj *renderer = MS_IMAGE_RENDERER(image_draw);</span>
<span class="lineNum">     912 </span>            :     rasterBufferObj rb;
<span class="lineNum">     913 </span>            :     memset(&amp;rb,0,sizeof(rasterBufferObj));
<span class="lineNum">     914 </span>            : 
<span class="lineNum">     915 </span><span class="lineCov">          1 :     renderer-&gt;endLayer(image_draw,map,layer);</span>
<span class="lineNum">     916 </span>            : 
<span class="lineNum">     917 </span><span class="lineCov">          1 :     retcode = renderer-&gt;getRasterBufferHandle(image_draw,&amp;rb);</span>
<span class="lineNum">     918 </span><span class="lineCov">          1 :     if(UNLIKELY(retcode == MS_FAILURE)) {</span>
<span class="lineNum">     919 </span>            :       goto imagedraw_cleanup;
<span class="lineNum">     920 </span>            :     }
<span class="lineNum">     921 </span><span class="lineCov">          1 :     if(maskLayer &amp;&amp; maskLayer-&gt;maskimage) {</span>
<span class="lineNum">     922 </span>            :       rasterBufferObj mask;
<span class="lineNum">     923 </span>            :       unsigned int row,col;
<span class="lineNum">     924 </span>            :       memset(&amp;mask,0,sizeof(rasterBufferObj));
<span class="lineNum">     925 </span><span class="lineCov">          1 :       retcode = MS_IMAGE_RENDERER(maskLayer-&gt;maskimage)-&gt;getRasterBufferHandle(maskLayer-&gt;maskimage,&amp;mask);</span>
<span class="lineNum">     926 </span><span class="lineCov">          1 :       if(UNLIKELY(retcode == MS_FAILURE)) {</span>
<span class="lineNum">     927 </span>            :         goto imagedraw_cleanup;
<span class="lineNum">     928 </span>            :       }
<span class="lineNum">     929 </span>            :       /* modify the pixels of the overlay */
<span class="lineNum">     930 </span>            : 
<span class="lineNum">     931 </span><span class="lineCov">          1 :       if(rb.type == MS_BUFFER_BYTE_RGBA) {</span>
<span class="lineNum">     932 </span><span class="lineCov">          1 :         for(row=0; row&lt;rb.height; row++) {</span>
<span class="lineNum">     933 </span>            :           unsigned char *ma,*a,*r,*g,*b;
<span class="lineNum">     934 </span><span class="lineCov">          1 :           r=rb.data.rgba.r+row*rb.data.rgba.row_step;</span>
<span class="lineNum">     935 </span><span class="lineCov">          1 :           g=rb.data.rgba.g+row*rb.data.rgba.row_step;</span>
<span class="lineNum">     936 </span><span class="lineCov">          1 :           b=rb.data.rgba.b+row*rb.data.rgba.row_step;</span>
<span class="lineNum">     937 </span><span class="lineCov">          1 :           a=rb.data.rgba.a+row*rb.data.rgba.row_step;</span>
<span class="lineNum">     938 </span><span class="lineCov">          1 :           ma=mask.data.rgba.a+row*mask.data.rgba.row_step;</span>
<span class="lineNum">     939 </span><span class="lineCov">          1 :           for(col=0; col&lt;rb.width; col++) {</span>
<span class="lineNum">     940 </span><span class="lineCov">          1 :             if(*ma == 0) {</span>
<span class="lineNum">     941 </span><span class="lineCov">          1 :               *a = *r = *g = *b = 0;</span>
<span class="lineNum">     942 </span>            :             }
<span class="lineNum">     943 </span><span class="lineCov">          1 :             a+=rb.data.rgba.pixel_step;</span>
<span class="lineNum">     944 </span><span class="lineCov">          1 :             r+=rb.data.rgba.pixel_step;</span>
<span class="lineNum">     945 </span><span class="lineCov">          1 :             g+=rb.data.rgba.pixel_step;</span>
<span class="lineNum">     946 </span><span class="lineCov">          1 :             b+=rb.data.rgba.pixel_step;</span>
<span class="lineNum">     947 </span><span class="lineCov">          1 :             ma+=mask.data.rgba.pixel_step;</span>
<span class="lineNum">     948 </span>            :           }
<span class="lineNum">     949 </span>            :         }
<span class="lineNum">     950 </span>            :       }
<span class="lineNum">     951 </span>            :     }
<span class="lineNum">     952 </span><span class="lineCov">          1 :     if(!layer-&gt;compositer) {</span>
<span class="lineNum">     953 </span>            :       /*we have a mask layer with no composition configured, do a nomral blend */
<span class="lineNum">     954 </span><span class="lineCov">          1 :       retcode = renderer-&gt;mergeRasterBuffer(image,&amp;rb,1.0,0,0,0,0,rb.width,rb.height);</span>
<span class="lineNum">     955 </span>            :     } else {
<span class="lineNum">     956 </span><span class="lineCov">          1 :       retcode = msCompositeRasterBuffer(map,image,&amp;rb,layer-&gt;compositer);</span>
<span class="lineNum">     957 </span>            :     }
<span class="lineNum">     958 </span>            :     if(UNLIKELY(retcode == MS_FAILURE)) {
<span class="lineNum">     959 </span>            :       goto imagedraw_cleanup;
<span class="lineNum">     960 </span>            :     }
<span class="lineNum">     961 </span>            : 
<span class="lineNum">     962 </span><span class="lineCov">          1 : imagedraw_cleanup:</span>
<span class="lineNum">     963 </span><span class="lineCov">          1 :     msFreeImage(image_draw);</span>
<span class="lineNum">     964 </span>            :   }
<span class="lineNum">     965 </span>            : 
<span class="lineNum">     966 </span><span class="lineCov">          1 :   msImageEndLayer(map,layer,image);</span>
<span class="lineNum">     967 </span><span class="lineCov">          1 :   return(retcode);</span>
<a name="968"><span class="lineNum">     968 </span>            : }</a>
<span class="lineNum">     969 </span>            : 
<span class="lineNum">     970 </span><span class="lineCov">          1 : int msDrawVectorLayer(mapObj *map, layerObj *layer, imageObj *image)</span>
<span class="lineNum">     971 </span>            : {
<span class="lineNum">     972 </span>            :   int         status, retcode=MS_SUCCESS;
<span class="lineNum">     973 </span>            :   int         drawmode=MS_DRAWMODE_FEATURES;
<span class="lineNum">     974 </span>            :   char        annotate=MS_TRUE;
<span class="lineNum">     975 </span>            :   shapeObj    shape;
<span class="lineNum">     976 </span>            :   shapeObj    savedShape;
<span class="lineNum">     977 </span>            :   rectObj     searchrect;
<span class="lineNum">     978 </span>            :   char        cache=MS_FALSE;
<span class="lineNum">     979 </span>            :   int         maxnumstyles=1;
<span class="lineNum">     980 </span><span class="lineCov">          1 :   featureListNodeObjPtr shpcache=NULL, current=NULL;</span>
<span class="lineNum">     981 </span><span class="lineCov">          1 :   int nclasses = 0;</span>
<span class="lineNum">     982 </span>            :   int *classgroup = NULL;
<span class="lineNum">     983 </span>            :   double minfeaturesize = -1;
<span class="lineNum">     984 </span>            :   int maxfeatures=-1;
<span class="lineNum">     985 </span>            :   int featuresdrawn=0;
<span class="lineNum">     986 </span>            : 
<span class="lineNum">     987 </span><span class="lineCov">          1 :   if (image)</span>
<span class="lineNum">     988 </span><span class="lineCov">          1 :     maxfeatures=msLayerGetMaxFeaturesToDraw(layer, image-&gt;format);</span>
<span class="lineNum">     989 </span>            : 
<span class="lineNum">     990 </span>            :   /* TODO TBT: draw as raster layer in vector renderers */
<span class="lineNum">     991 </span>            : 
<span class="lineNum">     992 </span><span class="lineCov">          1 :   annotate = msEvalContext(map, layer, layer-&gt;labelrequires);</span>
<span class="lineNum">     993 </span><span class="lineCov">          1 :   if(map-&gt;scaledenom &gt; 0) {</span>
<span class="lineNum">     994 </span><span class="lineCov">          1 :     if((layer-&gt;labelmaxscaledenom != -1) &amp;&amp; (map-&gt;scaledenom &gt;= layer-&gt;labelmaxscaledenom)) annotate = MS_FALSE;</span>
<span class="lineNum">     995 </span><span class="lineCov">          1 :     if((layer-&gt;labelminscaledenom != -1) &amp;&amp; (map-&gt;scaledenom &lt; layer-&gt;labelminscaledenom)) annotate = MS_FALSE;</span>
<span class="lineNum">     996 </span>            :   }
<span class="lineNum">     997 </span>            : 
<span class="lineNum">     998 </span>            :   /* open this layer */
<span class="lineNum">     999 </span><span class="lineCov">          1 :   status = msLayerOpen(layer);</span>
<span class="lineNum">    1000 </span><span class="lineCov">          1 :   if(status != MS_SUCCESS) return MS_FAILURE;</span>
<span class="lineNum">    1001 </span>            : 
<span class="lineNum">    1002 </span>            :   /* build item list. STYLEITEM javascript needs the shape attributes */
<span class="lineNum">    1003 </span><span class="lineCov">          1 :   if (layer-&gt;styleitem &amp;&amp; (strncasecmp(layer-&gt;styleitem, &quot;javascript://&quot;, 13) == 0)) {  </span>
<span class="lineNum">    1004 </span><span class="lineNoCov">          0 :     status = msLayerWhichItems(layer, MS_TRUE, NULL);</span>
<span class="lineNum">    1005 </span>            :   } else {
<span class="lineNum">    1006 </span><span class="lineCov">          1 :     status = msLayerWhichItems(layer, MS_FALSE, NULL);</span>
<span class="lineNum">    1007 </span>            :   }
<span class="lineNum">    1008 </span>            : 
<span class="lineNum">    1009 </span><span class="lineCov">          1 :   if(status != MS_SUCCESS) {</span>
<span class="lineNum">    1010 </span><span class="lineNoCov">          0 :     msLayerClose(layer);</span>
<span class="lineNum">    1011 </span><span class="lineNoCov">          0 :     return MS_FAILURE;</span>
<span class="lineNum">    1012 </span>            :   }
<span class="lineNum">    1013 </span>            : 
<span class="lineNum">    1014 </span>            :   /* identify target shapes */
<span class="lineNum">    1015 </span><span class="lineCov">          1 :   if(layer-&gt;transform == MS_TRUE) {</span>
<span class="lineNum">    1016 </span><span class="lineCov">          1 :     searchrect = map-&gt;extent;</span>
<span class="lineNum">    1017 </span>            : 
<span class="lineNum">    1018 </span><span class="lineCov">          1 :     if((map-&gt;projection.numargs &gt; 0) &amp;&amp; (layer-&gt;projection.numargs &gt; 0)) {</span>
<span class="lineNum">    1019 </span>            :       int bDone = MS_FALSE;
<span class="lineNum">    1020 </span>            : 
<span class="lineNum">    1021 </span><span class="lineCov">          1 :       if( layer-&gt;connectiontype == MS_UVRASTER )</span>
<span class="lineNum">    1022 </span>            :       {
<span class="lineNum">    1023 </span>            :           /* Nasty hack to make msUVRASTERLayerWhichShapes() aware that the */
<span class="lineNum">    1024 </span>            :           /* original area of interest is (map-&gt;extent, map-&gt;projection)... */
<span class="lineNum">    1025 </span>            :           /* Useful when dealin with UVRASTER that extend beyond 180 deg */
<span class="lineNum">    1026 </span><span class="lineCov">          1 :           msUVRASTERLayerUseMapExtentAndProjectionForNextWhichShapes( layer, map );</span>
<span class="lineNum">    1027 </span>            : 
<span class="lineNum">    1028 </span><span class="lineCov">          1 :           searchrect = msUVRASTERGetSearchRect( layer, map );</span>
<span class="lineNum">    1029 </span>            :           bDone = MS_TRUE;
<span class="lineNum">    1030 </span>            :       }
<span class="lineNum">    1031 </span>            : 
<span class="lineNum">    1032 </span>            :       if( !bDone )
<span class="lineNum">    1033 </span><span class="lineCov">          1 :         msProjectRect(&amp;map-&gt;projection, &amp;layer-&gt;projection, &amp;searchrect); /* project the searchrect to source coords */</span>
<span class="lineNum">    1034 </span>            :     }
<span class="lineNum">    1035 </span>            : 
<span class="lineNum">    1036 </span>            :   } else {
<span class="lineNum">    1037 </span><span class="lineCov">          1 :     searchrect.minx = searchrect.miny = 0;</span>
<span class="lineNum">    1038 </span><span class="lineCov">          1 :     searchrect.maxx = map-&gt;width-1;</span>
<span class="lineNum">    1039 </span><span class="lineCov">          1 :     searchrect.maxy = map-&gt;height-1;</span>
<span class="lineNum">    1040 </span>            :   }
<span class="lineNum">    1041 </span>            : 
<span class="lineNum">    1042 </span><span class="lineCov">          1 :   status = msLayerWhichShapes(layer, searchrect, MS_FALSE);</span>
<span class="lineNum">    1043 </span>            : 
<span class="lineNum">    1044 </span><span class="lineCov">          1 :   if( layer-&gt;connectiontype == MS_UVRASTER )</span>
<span class="lineNum">    1045 </span>            :   {
<span class="lineNum">    1046 </span><span class="lineCov">          1 :     msUVRASTERLayerUseMapExtentAndProjectionForNextWhichShapes( layer, NULL );</span>
<span class="lineNum">    1047 </span>            :   }
<span class="lineNum">    1048 </span>            : 
<span class="lineNum">    1049 </span><span class="lineCov">          1 :   if(status == MS_DONE) { /* no overlap */</span>
<span class="lineNum">    1050 </span><span class="lineCov">          1 :     msLayerClose(layer);</span>
<span class="lineNum">    1051 </span><span class="lineCov">          1 :     return MS_SUCCESS;</span>
<span class="lineNum">    1052 </span><span class="lineCov">          1 :   } else if(status != MS_SUCCESS) {</span>
<span class="lineNum">    1053 </span><span class="lineNoCov">          0 :     msLayerClose(layer);</span>
<span class="lineNum">    1054 </span><span class="lineNoCov">          0 :     return MS_FAILURE;</span>
<span class="lineNum">    1055 </span>            :   }
<span class="lineNum">    1056 </span>            : 
<span class="lineNum">    1057 </span><span class="lineCov">          1 :   nclasses = 0;</span>
<span class="lineNum">    1058 </span>            :   classgroup = NULL;
<span class="lineNum">    1059 </span><span class="lineCov">          1 :   if(layer-&gt;classgroup &amp;&amp; layer-&gt;numclasses &gt; 0)</span>
<span class="lineNum">    1060 </span><span class="lineCov">          1 :     classgroup = msAllocateValidClassGroups(layer, &amp;nclasses);</span>
<span class="lineNum">    1061 </span>            : 
<span class="lineNum">    1062 </span><span class="lineCov">          1 :   if(layer-&gt;minfeaturesize &gt; 0)</span>
<span class="lineNum">    1063 </span><span class="lineNoCov">          0 :     minfeaturesize = Pix2LayerGeoref(map, layer, layer-&gt;minfeaturesize);</span>
<span class="lineNum">    1064 </span>            : 
<span class="lineNum">    1065 </span>            :   // Select how to render classes
<span class="lineNum">    1066 </span>            :   //    MS_FIRST_MATCHING_CLASS: Default and historic MapServer behavior
<span class="lineNum">    1067 </span>            :   //    MS_ALL_MATCHING_CLASSES: SLD behavior
<span class="lineNum">    1068 </span>            :   int ref_rendermode;
<span class="lineNum">    1069 </span><span class="lineCov">          1 :   char * rendermodestr = msLayerGetProcessingKey(layer, &quot;RENDERMODE&quot;);</span>
<span class="lineNum">    1070 </span><span class="lineCov">          1 :   if (layer-&gt;rendermode == MS_ALL_MATCHING_CLASSES)</span>
<span class="lineNum">    1071 </span>            :   {
<span class="lineNum">    1072 </span>            :     // SLD takes precedence
<span class="lineNum">    1073 </span>            :     ref_rendermode = MS_ALL_MATCHING_CLASSES;
<span class="lineNum">    1074 </span>            :   }
<span class="lineNum">    1075 </span><span class="lineCov">          1 :   else if (!rendermodestr)</span>
<span class="lineNum">    1076 </span>            :   {
<span class="lineNum">    1077 </span>            :     // Default Mapfile
<span class="lineNum">    1078 </span>            :     ref_rendermode = MS_FIRST_MATCHING_CLASS;
<span class="lineNum">    1079 </span>            :   }
<span class="lineNum">    1080 </span><span class="lineCov">          1 :   else if (!strcmp(rendermodestr,&quot;FIRST_MATCHING_CLASS&quot;))</span>
<span class="lineNum">    1081 </span>            :   {
<span class="lineNum">    1082 </span>            :     // Explicit default Mapfile
<span class="lineNum">    1083 </span>            :     ref_rendermode = MS_FIRST_MATCHING_CLASS;
<span class="lineNum">    1084 </span>            :   }
<span class="lineNum">    1085 </span><span class="lineCov">          1 :   else if (!strcmp(rendermodestr,&quot;ALL_MATCHING_CLASSES&quot;))</span>
<span class="lineNum">    1086 </span>            :   {
<span class="lineNum">    1087 </span>            :     // SLD-like Mapfile
<span class="lineNum">    1088 </span>            :     ref_rendermode = MS_ALL_MATCHING_CLASSES;
<span class="lineNum">    1089 </span>            :   }
<span class="lineNum">    1090 </span>            :   else
<span class="lineNum">    1091 </span>            :   {
<span class="lineNum">    1092 </span><span class="lineNoCov">          0 :     msLayerClose(layer);</span>
<span class="lineNum">    1093 </span><span class="lineNoCov">          0 :     msSetError(MS_MISCERR,</span>
<span class="lineNum">    1094 </span>            :     &quot;Unknown RENDERMODE: %s, should be one of: FIRST_MATCHING_CLASS, ALL_MATCHING_CLASSES.&quot;,
<span class="lineNum">    1095 </span>            :     &quot;msDrawVectorLayer()&quot;,
<span class="lineNum">    1096 </span>            :     rendermodestr);
<span class="lineNum">    1097 </span><span class="lineNoCov">          0 :     return MS_FAILURE;</span>
<span class="lineNum">    1098 </span>            :   }
<span class="lineNum">    1099 </span>            : 
<span class="lineNum">    1100 </span>            :   /* step through the target shapes and their classes */
<span class="lineNum">    1101 </span><span class="lineCov">          1 :   msInitShape(&amp;shape);</span>
<span class="lineNum">    1102 </span>            :   int classindex = -1;
<span class="lineNum">    1103 </span>            :   int classcount = 0;
<span class="lineNum">    1104 </span>            :   for (;;) {
<span class="lineNum">    1105 </span>            :     int rendermode;
<span class="lineNum">    1106 </span><span class="lineCov">          1 :     if (classindex == -1) {</span>
<span class="lineNum">    1107 </span><span class="lineCov">          1 :       msFreeShape(&amp;shape);</span>
<span class="lineNum">    1108 </span><span class="lineCov">          1 :       status = msLayerNextShape(layer, &amp;shape);</span>
<span class="lineNum">    1109 </span><span class="lineCov">          1 :       if (status != MS_SUCCESS) {</span>
<span class="lineNum">    1110 </span>            :         break;
<span class="lineNum">    1111 </span>            :       }
<span class="lineNum">    1112 </span>            : 
<span class="lineNum">    1113 </span>            :       /* Check if the shape size is ok to be drawn */
<span class="lineNum">    1114 </span><span class="lineCov">          1 :       if((shape.type == MS_SHAPE_LINE || shape.type == MS_SHAPE_POLYGON) &amp;&amp; (minfeaturesize &gt; 0) &amp;&amp; (msShapeCheckSize(&amp;shape, minfeaturesize) == MS_FALSE)) {</span>
<span class="lineNum">    1115 </span><span class="lineNoCov">          0 :         if(layer-&gt;debug &gt;= MS_DEBUGLEVEL_V)</span>
<span class="lineNum">    1116 </span><span class="lineNoCov">          0 :           msDebug(&quot;msDrawVectorLayer(): Skipping shape (%ld) because LAYER::MINFEATURESIZE is bigger than shape size\n&quot;, shape.index);</span>
<span class="lineNum">    1117 </span><span class="lineNoCov">          0 :         continue;</span>
<span class="lineNum">    1118 </span>            :       }
<span class="lineNum">    1119 </span>            :       classcount = 0;
<span class="lineNum">    1120 </span>            :     }
<span class="lineNum">    1121 </span>            : 
<span class="lineNum">    1122 </span><span class="lineCov">          1 :     classindex = msShapeGetNextClass(classindex, layer, map, &amp;shape, classgroup, nclasses);</span>
<span class="lineNum">    1123 </span><span class="lineCov">          1 :     if((classindex == -1) || (layer-&gt;class[classindex]-&gt;status == MS_OFF)) {</span>
<span class="lineNum">    1124 </span><span class="lineCov">          1 :       continue;</span>
<span class="lineNum">    1125 </span>            :     }
<span class="lineNum">    1126 </span><span class="lineCov">          1 :     shape.classindex = classindex;</span>
<span class="lineNum">    1127 </span>            : 
<span class="lineNum">    1128 </span>            :     // When only one class is applicable, rendering mode is forced to its default,
<span class="lineNum">    1129 </span>            :     // i.e. only the first applicable class is actually applied. As a consequence,
<span class="lineNum">    1130 </span>            :     // cache can be enabled when relevant.
<span class="lineNum">    1131 </span><span class="lineCov">          1 :     classcount++;</span>
<span class="lineNum">    1132 </span>            :     rendermode = ref_rendermode;
<span class="lineNum">    1133 </span><span class="lineCov">          1 :     if ((classcount == 1) &amp;&amp; (msShapeGetNextClass(classindex, layer, map, &amp;shape, classgroup, nclasses) == -1))</span>
<span class="lineNum">    1134 </span>            :     {
<span class="lineNum">    1135 </span>            :       rendermode = MS_FIRST_MATCHING_CLASS;
<span class="lineNum">    1136 </span>            :     }
<span class="lineNum">    1137 </span>            : 
<span class="lineNum">    1138 </span><span class="lineCov">          1 :     if (rendermode == MS_FIRST_MATCHING_CLASS)</span>
<span class="lineNum">    1139 </span>            :     {
<span class="lineNum">    1140 </span>            :       classindex = -1;
<span class="lineNum">    1141 </span>            :     }
<span class="lineNum">    1142 </span>            : 
<span class="lineNum">    1143 </span><span class="lineCov">          1 :     if(maxfeatures &gt;=0 &amp;&amp; featuresdrawn &gt;= maxfeatures) {</span>
<span class="lineNum">    1144 </span>            :       status = MS_DONE;
<span class="lineNum">    1145 </span>            :       break;
<span class="lineNum">    1146 </span>            :     }
<span class="lineNum">    1147 </span><span class="lineCov">          1 :     featuresdrawn++;</span>
<span class="lineNum">    1148 </span>            : 
<span class="lineNum">    1149 </span>            :     cache = MS_FALSE;
<span class="lineNum">    1150 </span><span class="lineCov">          1 :     if(layer-&gt;type == MS_LAYER_LINE &amp;&amp; (layer-&gt;class[shape.classindex]-&gt;numstyles &gt; 1 || (layer-&gt;class[shape.classindex]-&gt;numstyles == 1 &amp;&amp; layer-&gt;class[shape.classindex]-&gt;styles[0]-&gt;outlinewidth &gt; 0))) {</span>
<span class="lineNum">    1151 </span>            :       int i;
<span class="lineNum">    1152 </span>            :       cache = MS_TRUE; /* only line layers with multiple styles need be cached (I don't think POLYLINE layers need caching - SDL) */
<span class="lineNum">    1153 </span>            : 
<span class="lineNum">    1154 </span>            :       /* we can't handle caching with attribute binding other than for the first style (#3976) */
<span class="lineNum">    1155 </span><span class="lineCov">          1 :       for(i=1; i&lt;layer-&gt;class[shape.classindex]-&gt;numstyles; i++) {</span>
<span class="lineNum">    1156 </span><span class="lineCov">          1 :         if(layer-&gt;class[shape.classindex]-&gt;styles[i]-&gt;numbindings &gt; 0) cache = MS_FALSE;</span>
<span class="lineNum">    1157 </span>            :       }
<span class="lineNum">    1158 </span>            :     }
<span class="lineNum">    1159 </span>            : 
<span class="lineNum">    1160 </span>            :     /* With 'STYLEITEM AUTO', we will have the datasource fill the class' */
<span class="lineNum">    1161 </span>            :     /* style parameters for this shape. */
<span class="lineNum">    1162 </span><span class="lineCov">          1 :     if(layer-&gt;styleitem) {</span>
<span class="lineNum">    1163 </span><span class="lineCov">          1 :       if(strcasecmp(layer-&gt;styleitem, &quot;AUTO&quot;) == 0) {</span>
<span class="lineNum">    1164 </span><span class="lineCov">          1 :         if(msLayerGetAutoStyle(map, layer, layer-&gt;class[shape.classindex], &amp;shape) != MS_SUCCESS) {</span>
<span class="lineNum">    1165 </span>            :           retcode = MS_FAILURE;
<span class="lineNum">    1166 </span>            :           break;
<span class="lineNum">    1167 </span>            :         }
<span class="lineNum">    1168 </span>            :       } else {
<span class="lineNum">    1169 </span>            :         /* Generic feature style handling as per RFC-61 */
<span class="lineNum">    1170 </span><span class="lineNoCov">          0 :         if(msLayerGetFeatureStyle(map, layer, layer-&gt;class[shape.classindex], &amp;shape) != MS_SUCCESS) {</span>
<span class="lineNum">    1171 </span>            :           retcode = MS_FAILURE;
<span class="lineNum">    1172 </span>            :           break;
<span class="lineNum">    1173 </span>            :         }
<span class="lineNum">    1174 </span>            :       }
<span class="lineNum">    1175 </span>            : 
<span class="lineNum">    1176 </span>            :       /* __TODO__ For now, we can't cache features with 'AUTO' style */
<span class="lineNum">    1177 </span>            :       cache = MS_FALSE;
<span class="lineNum">    1178 </span>            :     }
<span class="lineNum">    1179 </span>            : 
<span class="lineNum">    1180 </span><span class="lineCov">          1 :     if (rendermode == MS_ALL_MATCHING_CLASSES)</span>
<span class="lineNum">    1181 </span>            :     {
<span class="lineNum">    1182 </span>            :       // Cache is designed to handle only one class. Therefore it is
<span class="lineNum">    1183 </span>            :       // disabled when using SLD &quot;painters model&quot; rendering mode.
<span class="lineNum">    1184 </span>            :       cache = MS_FALSE;
<span class="lineNum">    1185 </span>            :     }
<span class="lineNum">    1186 </span>            : 
<span class="lineNum">    1187 </span>            :     /* RFC77 TODO: check return value, may need a more sophisticated if-then test. */
<span class="lineNum">    1188 </span><span class="lineCov">          1 :     if(annotate &amp;&amp; layer-&gt;class[shape.classindex]-&gt;numlabels &gt; 0) {</span>
<span class="lineNum">    1189 </span><span class="lineCov">          1 :       drawmode |= MS_DRAWMODE_LABELS;</span>
<span class="lineNum">    1190 </span><span class="lineCov">          1 :       if (msLayerGetProcessingKey(layer, &quot;LABEL_NO_CLIP&quot;)) {</span>
<span class="lineNum">    1191 </span><span class="lineCov">          1 :         drawmode |= MS_DRAWMODE_UNCLIPPEDLABELS;</span>
<span class="lineNum">    1192 </span>            :       }
<span class="lineNum">    1193 </span>            :     }
<span class="lineNum">    1194 </span>            : 
<span class="lineNum">    1195 </span><span class="lineCov">          1 :     if (layer-&gt;type == MS_LAYER_LINE &amp;&amp; msLayerGetProcessingKey(layer, &quot;POLYLINE_NO_CLIP&quot;)) {</span>
<span class="lineNum">    1196 </span><span class="lineCov">          1 :       drawmode |= MS_DRAWMODE_UNCLIPPEDLINES;</span>
<span class="lineNum">    1197 </span>            :     }
<span class="lineNum">    1198 </span>            : 
<span class="lineNum">    1199 </span><span class="lineCov">          1 :     if (rendermode == MS_ALL_MATCHING_CLASSES)</span>
<span class="lineNum">    1200 </span>            :     {
<span class="lineNum">    1201 </span>            :       // In SLD &quot;painters model&quot; rendering mode, all applicable classes are actually applied.
<span class="lineNum">    1202 </span>            :       // Coordinates stored in the shape must keep their original values for
<span class="lineNum">    1203 </span>            :       // the shape to be drawn multiple times.
<span class="lineNum">    1204 </span>            :       // Here the original shape is saved.
<span class="lineNum">    1205 </span><span class="lineCov">          1 :       msInitShape(&amp;savedShape);</span>
<span class="lineNum">    1206 </span><span class="lineCov">          1 :       msCopyShape(&amp;shape, &amp;savedShape);</span>
<span class="lineNum">    1207 </span>            :     }
<span class="lineNum">    1208 </span>            : 
<span class="lineNum">    1209 </span><span class="lineCov">          1 :     if (cache) {</span>
<span class="lineNum">    1210 </span><span class="lineCov">          1 :       styleObj *pStyle = layer-&gt;class[shape.classindex]-&gt;styles[0];</span>
<span class="lineNum">    1211 </span><span class="lineCov">          1 :       if (pStyle-&gt;outlinewidth &gt; 0) {</span>
<span class="lineNum">    1212 </span>            :         /*
<span class="lineNum">    1213 </span>            :          * RFC 49 implementation
<span class="lineNum">    1214 </span>            :          * if an outlinewidth is used:
<span class="lineNum">    1215 </span>            :          *  - augment the style's width to account for the outline width
<span class="lineNum">    1216 </span>            :          *  - swap the style color and outlinecolor
<span class="lineNum">    1217 </span>            :          *  - draw the shape (the outline) in the first pass of the
<span class="lineNum">    1218 </span>            :          *    caching mechanism
<span class="lineNum">    1219 </span>            :          */
<span class="lineNum">    1220 </span><span class="lineNoCov">          0 :   msOutlineRenderingPrepareStyle(pStyle, map, layer, image);</span>
<span class="lineNum">    1221 </span>            :       }
<span class="lineNum">    1222 </span><span class="lineCov">          1 :       status = msDrawShape(map, layer, &amp;shape, image, 0, drawmode|MS_DRAWMODE_SINGLESTYLE); /* draw a single style */</span>
<span class="lineNum">    1223 </span><span class="lineCov">          1 :       if (pStyle-&gt;outlinewidth &gt; 0) {</span>
<span class="lineNum">    1224 </span>            :         /*
<span class="lineNum">    1225 </span>            :          * RFC 49 implementation: switch back the styleobj to its
<span class="lineNum">    1226 </span>            :          * original state, so the line fill will be drawn in the
<span class="lineNum">    1227 </span>            :          * second pass of the caching mechanism
<span class="lineNum">    1228 </span>            :          */
<span class="lineNum">    1229 </span><span class="lineNoCov">          0 :   msOutlineRenderingRestoreStyle(pStyle, map, layer, image);</span>
<span class="lineNum">    1230 </span>            :       }
<span class="lineNum">    1231 </span>            :     }
<span class="lineNum">    1232 </span>            : 
<span class="lineNum">    1233 </span>            :     else
<span class="lineNum">    1234 </span><span class="lineCov">          1 :       status = msDrawShape(map, layer, &amp;shape, image, -1, drawmode); /* all styles  */</span>
<span class="lineNum">    1235 </span>            : 
<span class="lineNum">    1236 </span><span class="lineCov">          1 :     if (rendermode == MS_ALL_MATCHING_CLASSES)</span>
<span class="lineNum">    1237 </span>            :     {
<span class="lineNum">    1238 </span>            :       // In SLD &quot;painters model&quot; rendering mode, all applicable classes are actually applied.
<span class="lineNum">    1239 </span>            :       // Coordinates stored in the shape must keep their original values for
<span class="lineNum">    1240 </span>            :       // the shape to be drawn multiple times.
<span class="lineNum">    1241 </span>            :       // Here the original shape is restored.
<span class="lineNum">    1242 </span><span class="lineCov">          1 :       msFreeShape(&amp;shape);</span>
<span class="lineNum">    1243 </span><span class="lineCov">          1 :       msCopyShape(&amp;savedShape, &amp;shape);</span>
<span class="lineNum">    1244 </span><span class="lineCov">          1 :       msFreeShape(&amp;savedShape);</span>
<span class="lineNum">    1245 </span>            :     }
<span class="lineNum">    1246 </span>            : 
<span class="lineNum">    1247 </span><span class="lineCov">          1 :     if(status != MS_SUCCESS) {</span>
<span class="lineNum">    1248 </span>            :       retcode = MS_FAILURE;
<span class="lineNum">    1249 </span>            :       break;
<span class="lineNum">    1250 </span>            :     }
<span class="lineNum">    1251 </span>            :     
<span class="lineNum">    1252 </span><span class="lineCov">          1 :     if(shape.numlines == 0) { /* once clipped the shape didn't need to be drawn */</span>
<span class="lineNum">    1253 </span><span class="lineCov">          1 :       continue;</span>
<span class="lineNum">    1254 </span>            :     }
<span class="lineNum">    1255 </span>            : 
<span class="lineNum">    1256 </span><span class="lineCov">          1 :     if(cache) {</span>
<span class="lineNum">    1257 </span><span class="lineCov">          1 :       if(insertFeatureList(&amp;shpcache, &amp;shape) == NULL) {</span>
<span class="lineNum">    1258 </span>            :         retcode = MS_FAILURE; /* problem adding to the cache */
<span class="lineNum">    1259 </span>            :         break;
<span class="lineNum">    1260 </span>            :       }
<span class="lineNum">    1261 </span>            :     }
<span class="lineNum">    1262 </span>            : 
<span class="lineNum">    1263 </span><span class="lineCov">          1 :     maxnumstyles = MS_MAX(maxnumstyles, layer-&gt;class[shape.classindex]-&gt;numstyles);</span>
<span class="lineNum">    1264 </span>            : 
<span class="lineNum">    1265 </span>            :   }
<span class="lineNum">    1266 </span><span class="lineCov">          1 :   msFreeShape(&amp;shape);</span>
<span class="lineNum">    1267 </span>            : 
<span class="lineNum">    1268 </span><span class="lineCov">          1 :   if (classgroup)</span>
<span class="lineNum">    1269 </span><span class="lineCov">          1 :     msFree(classgroup);</span>
<span class="lineNum">    1270 </span>            : 
<span class="lineNum">    1271 </span><span class="lineCov">          1 :   if(status != MS_DONE || retcode == MS_FAILURE) {</span>
<span class="lineNum">    1272 </span><span class="lineNoCov">          0 :     msLayerClose(layer);</span>
<span class="lineNum">    1273 </span><span class="lineNoCov">          0 :     if(shpcache) {</span>
<span class="lineNum">    1274 </span><span class="lineNoCov">          0 :       freeFeatureList(shpcache);</span>
<span class="lineNum">    1275 </span>            :       shpcache = NULL;
<span class="lineNum">    1276 </span>            :     }
<span class="lineNum">    1277 </span>            :     return MS_FAILURE;
<span class="lineNum">    1278 </span>            :   }
<span class="lineNum">    1279 </span>            : 
<span class="lineNum">    1280 </span><span class="lineCov">          1 :   if(shpcache &amp;&amp; MS_DRAW_FEATURES(drawmode)) {</span>
<span class="lineNum">    1281 </span>            :     int s;
<span class="lineNum">    1282 </span><span class="lineCov">          1 :     for(s=0; s&lt;maxnumstyles; s++) {</span>
<span class="lineNum">    1283 </span><span class="lineCov">          1 :       for(current=shpcache; current; current=current-&gt;next) {</span>
<span class="lineNum">    1284 </span><span class="lineCov">          1 :         if(layer-&gt;class[current-&gt;shape.classindex]-&gt;numstyles &gt; s) {</span>
<span class="lineNum">    1285 </span><span class="lineCov">          1 :           styleObj *pStyle = layer-&gt;class[current-&gt;shape.classindex]-&gt;styles[s];</span>
<span class="lineNum">    1286 </span><span class="lineCov">          1 :           if(pStyle-&gt;_geomtransform.type != MS_GEOMTRANSFORM_NONE)</span>
<span class="lineNum">    1287 </span><span class="lineCov">          1 :             continue; /*skip this as it has already been rendered*/</span>
<span class="lineNum">    1288 </span><span class="lineCov">          1 :           if(map-&gt;scaledenom &gt; 0) {</span>
<span class="lineNum">    1289 </span><span class="lineCov">          1 :             if((pStyle-&gt;maxscaledenom != -1) &amp;&amp; (map-&gt;scaledenom &gt;= pStyle-&gt;maxscaledenom))</span>
<span class="lineNum">    1290 </span><span class="lineNoCov">          0 :               continue;</span>
<span class="lineNum">    1291 </span><span class="lineCov">          1 :             if((pStyle-&gt;minscaledenom != -1) &amp;&amp; (map-&gt;scaledenom &lt; pStyle-&gt;minscaledenom))</span>
<span class="lineNum">    1292 </span><span class="lineNoCov">          0 :               continue;</span>
<span class="lineNum">    1293 </span>            :           }
<span class="lineNum">    1294 </span><span class="lineCov">          1 :           if(s==0 &amp;&amp; pStyle-&gt;outlinewidth&gt;0 &amp;&amp; MS_VALID_COLOR(pStyle-&gt;color)) {</span>
<span class="lineNum">    1295 </span><span class="lineNoCov">          0 :             if(UNLIKELY(MS_FAILURE == msDrawLineSymbol(map, image, &amp;current-&gt;shape, pStyle, pStyle-&gt;scalefactor))) {</span>
<span class="lineNum">    1296 </span>            :               return MS_FAILURE;
<span class="lineNum">    1297 </span>            :             }
<span class="lineNum">    1298 </span><span class="lineCov">          1 :           } else if(s&gt;0) {</span>
<span class="lineNum">    1299 </span><span class="lineCov">          1 :             if (pStyle-&gt;outlinewidth &gt; 0 &amp;&amp; MS_VALID_COLOR(pStyle-&gt;outlinecolor)) {</span>
<span class="lineNum">    1300 </span>            :               /*
<span class="lineNum">    1301 </span>            :                * RFC 49 implementation
<span class="lineNum">    1302 </span>            :                * if an outlinewidth is used:
<span class="lineNum">    1303 </span>            :                *  - augment the style's width to account for the outline width
<span class="lineNum">    1304 </span>            :                *  - swap the style color and outlinecolor
<span class="lineNum">    1305 </span>            :                *  - draw the shape (the outline) in the first pass of the
<span class="lineNum">    1306 </span>            :                *    caching mechanism
<span class="lineNum">    1307 </span>            :                */
<span class="lineNum">    1308 </span><span class="lineNoCov">          0 :         msOutlineRenderingPrepareStyle(pStyle, map, layer, image);</span>
<span class="lineNum">    1309 </span><span class="lineNoCov">          0 :               if(UNLIKELY(MS_FAILURE == msDrawLineSymbol(map, image, &amp;current-&gt;shape, pStyle, pStyle-&gt;scalefactor))) {</span>
<span class="lineNum">    1310 </span>            :                 return MS_FAILURE;
<span class="lineNum">    1311 </span>            :               }
<span class="lineNum">    1312 </span>            :               /*
<span class="lineNum">    1313 </span>            :                * RFC 49 implementation: switch back the styleobj to its
<span class="lineNum">    1314 </span>            :                * original state, so the line fill will be drawn in the
<span class="lineNum">    1315 </span>            :                * second pass of the caching mechanism
<span class="lineNum">    1316 </span>            :                */
<span class="lineNum">    1317 </span><span class="lineNoCov">          0 :         msOutlineRenderingRestoreStyle(pStyle, map, layer, image);</span>
<span class="lineNum">    1318 </span>            :             }
<span class="lineNum">    1319 </span>            :             /* draw a valid line, i.e. one with a color defined or of type pixmap*/
<span class="lineNum">    1320 </span><span class="lineCov">          1 :             if(MS_VALID_COLOR(pStyle-&gt;color) || </span>
<span class="lineNum">    1321 </span>            :                     (
<span class="lineNum">    1322 </span><span class="lineCov">          1 :                       pStyle-&gt;symbol&lt;map-&gt;symbolset.numsymbols &amp;&amp;</span>
<span class="lineNum">    1323 </span>            :                       ( 
<span class="lineNum">    1324 </span><span class="lineCov">          1 :                         map-&gt;symbolset.symbol[pStyle-&gt;symbol]-&gt;type == MS_SYMBOL_PIXMAP ||</span>
<span class="lineNum">    1325 </span>            :                         map-&gt;symbolset.symbol[pStyle-&gt;symbol]-&gt;type == MS_SYMBOL_SVG
<span class="lineNum">    1326 </span>            :                       )
<span class="lineNum">    1327 </span>            :                     )
<span class="lineNum">    1328 </span>            :               ) {
<span class="lineNum">    1329 </span><span class="lineCov">          1 :               if(UNLIKELY(MS_FAILURE == msDrawLineSymbol(map, image, &amp;current-&gt;shape, pStyle, pStyle-&gt;scalefactor)))</span>
<span class="lineNum">    1330 </span>            :                 return MS_FAILURE;
<span class="lineNum">    1331 </span>            :             }
<span class="lineNum">    1332 </span>            :           }
<span class="lineNum">    1333 </span>            :         }
<span class="lineNum">    1334 </span>            :       }
<span class="lineNum">    1335 </span>            :     }
<span class="lineNum">    1336 </span>            : 
<span class="lineNum">    1337 </span><span class="lineCov">          1 :     freeFeatureList(shpcache);</span>
<span class="lineNum">    1338 </span><span class="lineCov">          1 :     shpcache = NULL;</span>
<span class="lineNum">    1339 </span>            :   }
<span class="lineNum">    1340 </span>            : 
<span class="lineNum">    1341 </span><span class="lineCov">          1 :   msLayerClose(layer);</span>
<span class="lineNum">    1342 </span><span class="lineCov">          1 :   return MS_SUCCESS;</span>
<span class="lineNum">    1343 </span>            : 
<span class="lineNum">    1344 </span>            : }
<span class="lineNum">    1345 </span>            : 
<span class="lineNum">    1346 </span>            : /*
<a name="1347"><span class="lineNum">    1347 </span>            : ** Function to draw a layer IF it already has a result cache associated with it. Called by msDrawMap and via MapScript.</a>
<span class="lineNum">    1348 </span>            : */
<span class="lineNum">    1349 </span><span class="lineCov">          1 : int msDrawQueryLayer(mapObj *map, layerObj *layer, imageObj *image)</span>
<span class="lineNum">    1350 </span>            : {
<span class="lineNum">    1351 </span>            :   int i, status;
<span class="lineNum">    1352 </span>            :   char annotate=MS_TRUE, cache=MS_FALSE;
<span class="lineNum">    1353 </span>            :   int drawmode = MS_DRAWMODE_FEATURES|MS_DRAWMODE_QUERY;
<span class="lineNum">    1354 </span>            :   shapeObj shape;
<span class="lineNum">    1355 </span>            :   int maxnumstyles=1;
<span class="lineNum">    1356 </span>            : 
<span class="lineNum">    1357 </span><span class="lineCov">          1 :   featureListNodeObjPtr shpcache=NULL, current=NULL;</span>
<span class="lineNum">    1358 </span>            : 
<span class="lineNum">    1359 </span>            :   colorObj *colorbuffer = NULL;
<span class="lineNum">    1360 </span>            :   int *mindistancebuffer = NULL;
<span class="lineNum">    1361 </span>            : 
<span class="lineNum">    1362 </span><span class="lineCov">          1 :   if(!layer-&gt;resultcache) return(msDrawLayer(map, layer, image));</span>
<span class="lineNum">    1363 </span>            : 
<span class="lineNum">    1364 </span><span class="lineCov">          1 :   if(!msLayerIsVisible(map, layer)) return(MS_SUCCESS); /* not an error, just nothing to do */</span>
<span class="lineNum">    1365 </span>            : 
<span class="lineNum">    1366 </span>            :   /* conditions may have changed since this layer last drawn, so reset
<span class="lineNum">    1367 </span>            :      layer-&gt;project to recheck projection needs (Bug #673) */
<span class="lineNum">    1368 </span><span class="lineCov">          1 :   layer-&gt;project = msProjectionsDiffer(&amp;(layer-&gt;projection),&amp;(map-&gt;projection));</span>
<span class="lineNum">    1369 </span>            : 
<span class="lineNum">    1370 </span>            :   /* set annotation status */
<span class="lineNum">    1371 </span><span class="lineCov">          1 :   annotate = msEvalContext(map, layer, layer-&gt;labelrequires);</span>
<span class="lineNum">    1372 </span><span class="lineCov">          1 :   if(map-&gt;scaledenom &gt; 0) {</span>
<span class="lineNum">    1373 </span><span class="lineCov">          1 :     if((layer-&gt;labelmaxscaledenom != -1) &amp;&amp; (map-&gt;scaledenom &gt;= layer-&gt;labelmaxscaledenom)) annotate = MS_FALSE;</span>
<span class="lineNum">    1374 </span><span class="lineCov">          1 :     if((layer-&gt;labelminscaledenom != -1) &amp;&amp; (map-&gt;scaledenom &lt; layer-&gt;labelminscaledenom)) annotate = MS_FALSE;</span>
<span class="lineNum">    1375 </span>            :   }
<span class="lineNum">    1376 </span>            : 
<span class="lineNum">    1377 </span>            :   /*
<span class="lineNum">    1378 </span>            :   ** Certain query map styles require us to render all features only (MS_NORMAL) or first (MS_HILITE). With
<span class="lineNum">    1379 </span>            :   ** single-pass queries we have to make a copy of the layer and work from it instead.
<span class="lineNum">    1380 </span>            :   */
<span class="lineNum">    1381 </span><span class="lineCov">          1 :   if(map-&gt;querymap.style == MS_NORMAL || map-&gt;querymap.style == MS_HILITE) {</span>
<span class="lineNum">    1382 </span>            :     layerObj tmp_layer;
<span class="lineNum">    1383 </span>            : 
<span class="lineNum">    1384 </span><span class="lineCov">          1 :     if(initLayer(&amp;tmp_layer, map) == -1)</span>
<span class="lineNum">    1385 </span><span class="lineNoCov">          0 :       return(MS_FAILURE);</span>
<span class="lineNum">    1386 </span>            : 
<span class="lineNum">    1387 </span><span class="lineCov">          1 :     if (msCopyLayer(&amp;tmp_layer, layer) != MS_SUCCESS)</span>
<span class="lineNum">    1388 </span>            :       return(MS_FAILURE);
<span class="lineNum">    1389 </span>            : 
<span class="lineNum">    1390 </span>            :     /* disable the connection pool for this layer */
<span class="lineNum">    1391 </span><span class="lineCov">          1 :     msLayerSetProcessingKey(&amp;tmp_layer, &quot;CLOSE_CONNECTION&quot;, &quot;ALWAYS&quot;);</span>
<span class="lineNum">    1392 </span>            : 
<span class="lineNum">    1393 </span><span class="lineCov">          1 :     status = msDrawLayer(map, &amp;tmp_layer, image);</span>
<span class="lineNum">    1394 </span>            : 
<span class="lineNum">    1395 </span><span class="lineCov">          1 :     freeLayer(&amp;tmp_layer);</span>
<span class="lineNum">    1396 </span>            : 
<span class="lineNum">    1397 </span><span class="lineCov">          1 :     if(map-&gt;querymap.style == MS_NORMAL || status != MS_SUCCESS) return(status);</span>
<span class="lineNum">    1398 </span>            :   }
<span class="lineNum">    1399 </span>            : 
<span class="lineNum">    1400 </span>            :   /* if MS_HILITE, alter the one style (always at least 1 style), and set a MINDISTANCE for the labelObj to avoid duplicates */
<span class="lineNum">    1401 </span><span class="lineCov">          1 :   if(map-&gt;querymap.style == MS_HILITE) {</span>
<span class="lineNum">    1402 </span><span class="lineCov">          1 :     if (layer-&gt;numclasses &gt; 0) {</span>
<span class="lineNum">    1403 </span><span class="lineCov">          1 :       colorbuffer = (colorObj*)msSmallMalloc(layer-&gt;numclasses*sizeof(colorObj));</span>
<span class="lineNum">    1404 </span><span class="lineCov">          1 :       mindistancebuffer = (int*)msSmallMalloc(layer-&gt;numclasses*sizeof(int));</span>
<span class="lineNum">    1405 </span>            :     }
<span class="lineNum">    1406 </span>            : 
<span class="lineNum">    1407 </span><span class="lineCov">          1 :     for(i=0; i&lt;layer-&gt;numclasses; i++) {</span>
<span class="lineNum">    1408 </span><span class="lineCov">          1 :       if(layer-&gt;type == MS_LAYER_POLYGON) { /* alter BOTTOM style since that's almost always the fill */</span>
<span class="lineNum">    1409 </span><span class="lineNoCov">          0 :         if (layer-&gt;class[i]-&gt;styles == NULL) {</span>
<span class="lineNum">    1410 </span><span class="lineNoCov">          0 :           msSetError(MS_MISCERR, &quot;Don't know how to draw class %s of layer %s without a style definition.&quot;, &quot;msDrawQueryLayer()&quot;, layer-&gt;class[i]-&gt;name, layer-&gt;name);</span>
<span class="lineNum">    1411 </span><span class="lineNoCov">          0 :           msFree(colorbuffer);</span>
<span class="lineNum">    1412 </span><span class="lineNoCov">          0 :           msFree(mindistancebuffer);</span>
<span class="lineNum">    1413 </span><span class="lineNoCov">          0 :           return(MS_FAILURE);</span>
<span class="lineNum">    1414 </span>            :         }
<span class="lineNum">    1415 </span><span class="lineNoCov">          0 :         if(MS_VALID_COLOR(layer-&gt;class[i]-&gt;styles[0]-&gt;color)) {</span>
<span class="lineNum">    1416 </span><span class="lineNoCov">          0 :           colorbuffer[i] = layer-&gt;class[i]-&gt;styles[0]-&gt;color; /* save the color from the BOTTOM style */</span>
<span class="lineNum">    1417 </span><span class="lineNoCov">          0 :           layer-&gt;class[i]-&gt;styles[0]-&gt;color = map-&gt;querymap.color;</span>
<span class="lineNum">    1418 </span><span class="lineNoCov">          0 :         } else if(MS_VALID_COLOR(layer-&gt;class[i]-&gt;styles[0]-&gt;outlinecolor)) {</span>
<span class="lineNum">    1419 </span><span class="lineNoCov">          0 :           colorbuffer[i] = layer-&gt;class[i]-&gt;styles[0]-&gt;outlinecolor; /* if no color, save the outlinecolor from the BOTTOM style */</span>
<span class="lineNum">    1420 </span><span class="lineNoCov">          0 :           layer-&gt;class[i]-&gt;styles[0]-&gt;outlinecolor = map-&gt;querymap.color;</span>
<span class="lineNum">    1421 </span>            :         }
<span class="lineNum">    1422 </span><span class="lineCov">          1 :       } else if (layer-&gt;type == MS_LAYER_LINE &amp;&amp; layer-&gt;class[i]-&gt;numstyles &gt; 0 &amp;&amp; layer-&gt;class[i]-&gt;styles[0]-&gt;outlinewidth &gt; 0) { /* alter BOTTOM style for lines with outlines */</span>
<span class="lineNum">    1423 </span><span class="lineNoCov">          0 :   if(MS_VALID_COLOR(layer-&gt;class[i]-&gt;styles[0]-&gt;color)) {</span>
<span class="lineNum">    1424 </span><span class="lineNoCov">          0 :           colorbuffer[i] = layer-&gt;class[i]-&gt;styles[0]-&gt;color; /* save the color from the BOTTOM style */</span>
<span class="lineNum">    1425 </span><span class="lineNoCov">          0 :           layer-&gt;class[i]-&gt;styles[0]-&gt;color = map-&gt;querymap.color;</span>
<span class="lineNum">    1426 </span>            :         } /* else ??? */
<span class="lineNum">    1427 </span><span class="lineCov">          1 :       } else if (layer-&gt;class[i]-&gt;numstyles &gt; 0) {</span>
<span class="lineNum">    1428 </span><span class="lineCov">          1 :         if(MS_VALID_COLOR(layer-&gt;class[i]-&gt;styles[layer-&gt;class[i]-&gt;numstyles-1]-&gt;color)) {</span>
<span class="lineNum">    1429 </span><span class="lineCov">          1 :           colorbuffer[i] = layer-&gt;class[i]-&gt;styles[layer-&gt;class[i]-&gt;numstyles-1]-&gt;color; /* save the color from the TOP style */</span>
<span class="lineNum">    1430 </span><span class="lineCov">          1 :           layer-&gt;class[i]-&gt;styles[layer-&gt;class[i]-&gt;numstyles-1]-&gt;color = map-&gt;querymap.color;</span>
<span class="lineNum">    1431 </span><span class="lineNoCov">          0 :         } else if(MS_VALID_COLOR(layer-&gt;class[i]-&gt;styles[layer-&gt;class[i]-&gt;numstyles-1]-&gt;outlinecolor)) {</span>
<span class="lineNum">    1432 </span><span class="lineNoCov">          0 :           colorbuffer[i] = layer-&gt;class[i]-&gt;styles[layer-&gt;class[i]-&gt;numstyles-1]-&gt;outlinecolor; /* if no color, save the outlinecolor from the TOP style */</span>
<span class="lineNum">    1433 </span><span class="lineNoCov">          0 :           layer-&gt;class[i]-&gt;styles[layer-&gt;class[i]-&gt;numstyles-1]-&gt;outlinecolor = map-&gt;querymap.color;</span>
<span class="lineNum">    1434 </span>            :         }
<span class="lineNum">    1435 </span><span class="lineNoCov">          0 :       } else if (layer-&gt;class[i]-&gt;numlabels &gt; 0) {</span>
<span class="lineNum">    1436 </span><span class="lineNoCov">          0 :           colorbuffer[i] = layer-&gt;class[i]-&gt;labels[0]-&gt;color;</span>
<span class="lineNum">    1437 </span><span class="lineNoCov">          0 :           layer-&gt;class[i]-&gt;labels[0]-&gt;color = map-&gt;querymap.color;</span>
<span class="lineNum">    1438 </span>            :       } /* else ??? */
<span class="lineNum">    1439 </span>            : 
<span class="lineNum">    1440 </span><span class="lineCov">          1 :       mindistancebuffer[i] = -1; /* RFC77 TODO: only using the first label, is that cool? */</span>
<span class="lineNum">    1441 </span><span class="lineCov">          1 :       if(layer-&gt;class[i]-&gt;numlabels &gt; 0) {</span>
<span class="lineNum">    1442 </span><span class="lineNoCov">          0 :         mindistancebuffer[i] = layer-&gt;class[i]-&gt;labels[0]-&gt;mindistance;</span>
<span class="lineNum">    1443 </span><span class="lineNoCov">          0 :         layer-&gt;class[i]-&gt;labels[0]-&gt;mindistance = MS_MAX(0, layer-&gt;class[i]-&gt;labels[0]-&gt;mindistance);</span>
<span class="lineNum">    1444 </span>            :       }
<span class="lineNum">    1445 </span>            :     }
<span class="lineNum">    1446 </span>            :   }
<span class="lineNum">    1447 </span>            : 
<span class="lineNum">    1448 </span>            :   /*
<span class="lineNum">    1449 </span>            :   ** Layer was opened as part of the query process, msLayerWhichItems() has also been run, shapes have been classified - start processing!
<span class="lineNum">    1450 </span>            :   */
<span class="lineNum">    1451 </span>            : 
<span class="lineNum">    1452 </span><span class="lineCov">          1 :   msInitShape(&amp;shape);</span>
<span class="lineNum">    1453 </span>            : 
<span class="lineNum">    1454 </span><span class="lineCov">          1 :   for(i=0; i&lt;layer-&gt;resultcache-&gt;numresults; i++) {</span>
<span class="lineNum">    1455 </span><span class="lineCov">          1 :     status = msLayerGetShape(layer, &amp;shape, &amp;(layer-&gt;resultcache-&gt;results[i]));</span>
<span class="lineNum">    1456 </span><span class="lineCov">          1 :     if(status != MS_SUCCESS) {</span>
<span class="lineNum">    1457 </span><span class="lineNoCov">          0 :       msFree(colorbuffer);</span>
<span class="lineNum">    1458 </span><span class="lineNoCov">          0 :       msFree(mindistancebuffer);</span>
<span class="lineNum">    1459 </span><span class="lineNoCov">          0 :       return(MS_FAILURE);</span>
<span class="lineNum">    1460 </span>            :     }
<span class="lineNum">    1461 </span>            : 
<span class="lineNum">    1462 </span><span class="lineCov">          1 :     shape.classindex = layer-&gt;resultcache-&gt;results[i].classindex;</span>
<span class="lineNum">    1463 </span>            :     /* classindex may be -1 here if there was a template at the top level
<span class="lineNum">    1464 </span>            :      * in this layer and the current shape selected even if it didn't
<span class="lineNum">    1465 </span>            :      * match any class
<span class="lineNum">    1466 </span>            :      *
<span class="lineNum">    1467 </span>            :      * FrankW: classindex is also sometimes 0 even if there are no classes, so
<span class="lineNum">    1468 </span>            :      * we are careful not to use out of range class values as an index.
<span class="lineNum">    1469 </span>            :      */
<span class="lineNum">    1470 </span><span class="lineCov">          1 :     if(shape.classindex==-1</span>
<span class="lineNum">    1471 </span><span class="lineCov">          1 :         || shape.classindex &gt;= layer-&gt;numclasses</span>
<span class="lineNum">    1472 </span><span class="lineCov">          1 :         || layer-&gt;class[shape.classindex]-&gt;status == MS_OFF) {</span>
<span class="lineNum">    1473 </span><span class="lineCov">          1 :       msFreeShape(&amp;shape);</span>
<span class="lineNum">    1474 </span><span class="lineCov">          1 :       continue;</span>
<span class="lineNum">    1475 </span>            :     }
<span class="lineNum">    1476 </span>            : 
<span class="lineNum">    1477 </span>            :     cache = MS_FALSE;
<span class="lineNum">    1478 </span><span class="lineCov">          1 :     if(layer-&gt;type == MS_LAYER_LINE &amp;&amp; (layer-&gt;class[shape.classindex]-&gt;numstyles &gt; 1 || (layer-&gt;class[shape.classindex]-&gt;numstyles == 1 &amp;&amp; layer-&gt;class[shape.classindex]-&gt;styles[0]-&gt;outlinewidth &gt; 0))) {</span>
<span class="lineNum">    1479 </span>            :       int i;
<span class="lineNum">    1480 </span>            :       cache = MS_TRUE; /* only line layers with multiple styles need be cached (I don't think POLYLINE layers need caching - SDL) */
<span class="lineNum">    1481 </span>            : 
<span class="lineNum">    1482 </span>            :       /* we can't handle caching with attribute binding other than for the first style (#3976) */
<span class="lineNum">    1483 </span><span class="lineNoCov">          0 :       for(i=1; i&lt;layer-&gt;class[shape.classindex]-&gt;numstyles; i++) {</span>
<span class="lineNum">    1484 </span><span class="lineNoCov">          0 :         if(layer-&gt;class[shape.classindex]-&gt;styles[i]-&gt;numbindings &gt; 0) cache = MS_FALSE;</span>
<span class="lineNum">    1485 </span>            :       }
<span class="lineNum">    1486 </span>            :     }
<span class="lineNum">    1487 </span>            : 
<span class="lineNum">    1488 </span><span class="lineCov">          1 :     if(annotate &amp;&amp; layer-&gt;class[shape.classindex]-&gt;numlabels &gt; 0) {</span>
<span class="lineNum">    1489 </span>            :       drawmode |= MS_DRAWMODE_LABELS;
<span class="lineNum">    1490 </span>            :     }
<span class="lineNum">    1491 </span>            : 
<span class="lineNum">    1492 </span><span class="lineCov">          1 :     if(cache) {</span>
<span class="lineNum">    1493 </span><span class="lineNoCov">          0 :       styleObj *pStyle = layer-&gt;class[shape.classindex]-&gt;styles[0];</span>
<span class="lineNum">    1494 </span><span class="lineNoCov">          0 :       if (pStyle-&gt;outlinewidth &gt; 0) msOutlineRenderingPrepareStyle(pStyle, map, layer, image);</span>
<span class="lineNum">    1495 </span><span class="lineNoCov">          0 :       status = msDrawShape(map, layer, &amp;shape, image, 0, drawmode|MS_DRAWMODE_SINGLESTYLE); /* draw only the first style */</span>
<span class="lineNum">    1496 </span><span class="lineNoCov">          0 :       if (pStyle-&gt;outlinewidth &gt; 0) msOutlineRenderingRestoreStyle(pStyle, map, layer, image);</span>
<span class="lineNum">    1497 </span>            :     } else {
<span class="lineNum">    1498 </span><span class="lineCov">          1 :       status = msDrawShape(map, layer, &amp;shape, image, -1, drawmode); /* all styles  */</span>
<span class="lineNum">    1499 </span>            :     }
<span class="lineNum">    1500 </span><span class="lineCov">          1 :     if(status != MS_SUCCESS) {</span>
<span class="lineNum">    1501 </span><span class="lineNoCov">          0 :       msLayerClose(layer);</span>
<span class="lineNum">    1502 </span><span class="lineNoCov">          0 :       msFree(colorbuffer);</span>
<span class="lineNum">    1503 </span><span class="lineNoCov">          0 :       msFree(mindistancebuffer);</span>
<span class="lineNum">    1504 </span><span class="lineNoCov">          0 :       return(MS_FAILURE);</span>
<span class="lineNum">    1505 </span>            :     }
<span class="lineNum">    1506 </span>            : 
<span class="lineNum">    1507 </span><span class="lineCov">          1 :     if(shape.numlines == 0) { /* once clipped the shape didn't need to be drawn */</span>
<span class="lineNum">    1508 </span><span class="lineCov">          1 :       msFreeShape(&amp;shape);</span>
<span class="lineNum">    1509 </span><span class="lineCov">          1 :       continue;</span>
<span class="lineNum">    1510 </span>            :     }
<span class="lineNum">    1511 </span>            : 
<span class="lineNum">    1512 </span><span class="lineCov">          1 :     if(cache) {</span>
<span class="lineNum">    1513 </span><span class="lineNoCov">          0 :       if(insertFeatureList(&amp;shpcache, &amp;shape) == NULL) {</span>
<span class="lineNum">    1514 </span><span class="lineNoCov">          0 :         msFree(colorbuffer);</span>
<span class="lineNum">    1515 </span><span class="lineNoCov">          0 :         msFree(mindistancebuffer);</span>
<span class="lineNum">    1516 </span><span class="lineNoCov">          0 :         return(MS_FAILURE); /* problem adding to the cache */</span>
<span class="lineNum">    1517 </span>            :       }
<span class="lineNum">    1518 </span>            :     }
<span class="lineNum">    1519 </span>            : 
<span class="lineNum">    1520 </span><span class="lineCov">          1 :     maxnumstyles = MS_MAX(maxnumstyles, layer-&gt;class[shape.classindex]-&gt;numstyles);</span>
<span class="lineNum">    1521 </span><span class="lineCov">          1 :     msFreeShape(&amp;shape);</span>
<span class="lineNum">    1522 </span>            :   }
<span class="lineNum">    1523 </span>            : 
<span class="lineNum">    1524 </span><span class="lineCov">          1 :   if(shpcache) {</span>
<span class="lineNum">    1525 </span>            :     int s;
<span class="lineNum">    1526 </span><span class="lineNoCov">          0 :     for(s=0; s&lt;maxnumstyles; s++) {</span>
<span class="lineNum">    1527 </span><span class="lineNoCov">          0 :       for(current=shpcache; current; current=current-&gt;next) {</span>
<span class="lineNum">    1528 </span><span class="lineNoCov">          0 :         if(layer-&gt;class[current-&gt;shape.classindex]-&gt;numstyles &gt; s) {</span>
<span class="lineNum">    1529 </span><span class="lineNoCov">          0 :           styleObj *pStyle = layer-&gt;class[current-&gt;shape.classindex]-&gt;styles[s];</span>
<span class="lineNum">    1530 </span><span class="lineNoCov">          0 :           if(pStyle-&gt;_geomtransform.type != MS_GEOMTRANSFORM_NONE)</span>
<span class="lineNum">    1531 </span><span class="lineNoCov">          0 :             continue; /* skip this as it has already been rendered */</span>
<span class="lineNum">    1532 </span><span class="lineNoCov">          0 :           if(map-&gt;scaledenom &gt; 0) {</span>
<span class="lineNum">    1533 </span><span class="lineNoCov">          0 :             if((pStyle-&gt;maxscaledenom != -1) &amp;&amp; (map-&gt;scaledenom &gt;= pStyle-&gt;maxscaledenom))</span>
<span class="lineNum">    1534 </span><span class="lineNoCov">          0 :               continue;</span>
<span class="lineNum">    1535 </span><span class="lineNoCov">          0 :             if((pStyle-&gt;minscaledenom != -1) &amp;&amp; (map-&gt;scaledenom &lt; pStyle-&gt;minscaledenom))</span>
<span class="lineNum">    1536 </span><span class="lineNoCov">          0 :               continue;</span>
<span class="lineNum">    1537 </span>            :           }
<span class="lineNum">    1538 </span><span class="lineNoCov">          0 :           if(s==0 &amp;&amp; pStyle-&gt;outlinewidth&gt;0 &amp;&amp; MS_VALID_COLOR(pStyle-&gt;color)) {</span>
<span class="lineNum">    1539 </span><span class="lineNoCov">          0 :             if(UNLIKELY(MS_FAILURE == msDrawLineSymbol(map, image, &amp;current-&gt;shape, pStyle, pStyle-&gt;scalefactor))) {</span>
<span class="lineNum">    1540 </span>            :               return MS_FAILURE;
<span class="lineNum">    1541 </span>            :             }
<span class="lineNum">    1542 </span><span class="lineNoCov">          0 :           } else if(s&gt;0) {</span>
<span class="lineNum">    1543 </span><span class="lineNoCov">          0 :             if (pStyle-&gt;outlinewidth &gt; 0 &amp;&amp; MS_VALID_COLOR(pStyle-&gt;outlinecolor)) {</span>
<span class="lineNum">    1544 </span><span class="lineNoCov">          0 :               msOutlineRenderingPrepareStyle(pStyle, map, layer, image);</span>
<span class="lineNum">    1545 </span><span class="lineNoCov">          0 :               if(UNLIKELY(MS_FAILURE == msDrawLineSymbol(map, image, &amp;current-&gt;shape, pStyle, pStyle-&gt;scalefactor))) {</span>
<span class="lineNum">    1546 </span>            :                 return MS_FAILURE;
<span class="lineNum">    1547 </span>            :               }
<span class="lineNum">    1548 </span><span class="lineNoCov">          0 :               msOutlineRenderingRestoreStyle(pStyle, map, layer, image);</span>
<span class="lineNum">    1549 </span>            :             }
<span class="lineNum">    1550 </span>            :             /* draw a valid line, i.e. one with a color defined or of type pixmap */
<span class="lineNum">    1551 </span><span class="lineNoCov">          0 :             if(MS_VALID_COLOR(pStyle-&gt;color) || (pStyle-&gt;symbol&lt;map-&gt;symbolset.numsymbols &amp;&amp; (map-&gt;symbolset.symbol[pStyle-&gt;symbol]-&gt;type == MS_SYMBOL_PIXMAP || map-&gt;symbolset.symbol[pStyle-&gt;symbol]-&gt;type == MS_SYMBOL_SVG))) {</span>
<span class="lineNum">    1552 </span><span class="lineNoCov">          0 :               if(UNLIKELY(MS_FAILURE == msDrawLineSymbol(map, image, &amp;current-&gt;shape, pStyle, pStyle-&gt;scalefactor)))</span>
<span class="lineNum">    1553 </span>            :                 return MS_FAILURE;
<span class="lineNum">    1554 </span>            :             }
<span class="lineNum">    1555 </span>            :           }
<span class="lineNum">    1556 </span>            :         }
<span class="lineNum">    1557 </span>            :       }
<span class="lineNum">    1558 </span>            :     }
<span class="lineNum">    1559 </span>            : 
<span class="lineNum">    1560 </span><span class="lineNoCov">          0 :     freeFeatureList(shpcache);</span>
<span class="lineNum">    1561 </span><span class="lineNoCov">          0 :     shpcache = NULL;</span>
<span class="lineNum">    1562 </span>            :   }
<span class="lineNum">    1563 </span>            : 
<span class="lineNum">    1564 </span>            :   /* if MS_HILITE, restore color and mindistance values */
<span class="lineNum">    1565 </span><span class="lineCov">          1 :   if(map-&gt;querymap.style == MS_HILITE) {</span>
<span class="lineNum">    1566 </span><span class="lineCov">          1 :     for(i=0; i&lt;layer-&gt;numclasses; i++) {</span>
<span class="lineNum">    1567 </span><span class="lineCov">          1 :       if(layer-&gt;type == MS_LAYER_POLYGON) {</span>
<span class="lineNum">    1568 </span><span class="lineNoCov">          0 :         if(MS_VALID_COLOR(layer-&gt;class[i]-&gt;styles[0]-&gt;color))</span>
<span class="lineNum">    1569 </span><span class="lineNoCov">          0 :           layer-&gt;class[i]-&gt;styles[0]-&gt;color = colorbuffer[i];</span>
<span class="lineNum">    1570 </span><span class="lineNoCov">          0 :         else if(MS_VALID_COLOR(layer-&gt;class[i]-&gt;styles[0]-&gt;outlinecolor))</span>
<span class="lineNum">    1571 </span><span class="lineNoCov">          0 :           layer-&gt;class[i]-&gt;styles[0]-&gt;outlinecolor = colorbuffer[i]; /* if no color, restore outlinecolor for the BOTTOM style */</span>
<span class="lineNum">    1572 </span><span class="lineCov">          1 :       } else if (layer-&gt;type == MS_LAYER_LINE &amp;&amp; layer-&gt;class[i]-&gt;numstyles &gt; 0 &amp;&amp; layer-&gt;class[i]-&gt;styles[0]-&gt;outlinewidth &gt; 0) {</span>
<span class="lineNum">    1573 </span><span class="lineNoCov">          0 :         if(MS_VALID_COLOR(layer-&gt;class[i]-&gt;styles[0]-&gt;color))</span>
<span class="lineNum">    1574 </span><span class="lineNoCov">          0 :     layer-&gt;class[i]-&gt;styles[0]-&gt;color = colorbuffer[i];</span>
<span class="lineNum">    1575 </span><span class="lineCov">          1 :       } else if (layer-&gt;class[i]-&gt;numstyles &gt; 0) {</span>
<span class="lineNum">    1576 </span><span class="lineCov">          1 :         if(MS_VALID_COLOR(layer-&gt;class[i]-&gt;styles[layer-&gt;class[i]-&gt;numstyles-1]-&gt;color))</span>
<span class="lineNum">    1577 </span><span class="lineCov">          1 :           layer-&gt;class[i]-&gt;styles[layer-&gt;class[i]-&gt;numstyles-1]-&gt;color = colorbuffer[i];</span>
<span class="lineNum">    1578 </span><span class="lineNoCov">          0 :         else if(MS_VALID_COLOR(layer-&gt;class[i]-&gt;styles[layer-&gt;class[i]-&gt;numstyles-1]-&gt;outlinecolor))</span>
<span class="lineNum">    1579 </span><span class="lineNoCov">          0 :           layer-&gt;class[i]-&gt;styles[layer-&gt;class[i]-&gt;numstyles-1]-&gt;outlinecolor = colorbuffer[i]; /* if no color, restore outlinecolor for the TOP style */</span>
<span class="lineNum">    1580 </span><span class="lineNoCov">          0 :       } else if (layer-&gt;class[i]-&gt;numlabels &gt; 0) {</span>
<span class="lineNum">    1581 </span><span class="lineNoCov">          0 :         if(MS_VALID_COLOR(layer-&gt;class[i]-&gt;labels[0]-&gt;color))</span>
<span class="lineNum">    1582 </span><span class="lineNoCov">          0 :           layer-&gt;class[i]-&gt;labels[0]-&gt;color = colorbuffer[i];</span>
<span class="lineNum">    1583 </span>            :       }
<span class="lineNum">    1584 </span>            : 
<span class="lineNum">    1585 </span><span class="lineCov">          1 :       if(layer-&gt;class[i]-&gt;numlabels &gt; 0)</span>
<span class="lineNum">    1586 </span><span class="lineNoCov">          0 :         layer-&gt;class[i]-&gt;labels[0]-&gt;mindistance = mindistancebuffer[i]; /* RFC77 TODO: again, only using the first label, is that cool? */</span>
<span class="lineNum">    1587 </span>            :     }
<span class="lineNum">    1588 </span>            : 
<span class="lineNum">    1589 </span><span class="lineCov">          1 :     msFree(colorbuffer);</span>
<span class="lineNum">    1590 </span><span class="lineCov">          1 :     msFree(mindistancebuffer);</span>
<span class="lineNum">    1591 </span>            :   }
<span class="lineNum">    1592 </span>            : 
<span class="lineNum">    1593 </span>            :   return(MS_SUCCESS);
<span class="lineNum">    1594 </span>            : }
<span class="lineNum">    1595 </span>            : 
<span class="lineNum">    1596 </span>            : /**
<span class="lineNum">    1597 </span>            :  * msDrawRasterLayerPlugin()
<span class="lineNum">    1598 </span>            :  */
<a name="1599"><span class="lineNum">    1599 </span>            : </a>
<span class="lineNum">    1600 </span>            : static int
<span class="lineNum">    1601 </span><span class="lineCov">          1 : msDrawRasterLayerPlugin( mapObj *map, layerObj *layer, imageObj *image)</span>
<span class="lineNum">    1602 </span>            : 
<span class="lineNum">    1603 </span>            : {
<span class="lineNum">    1604 </span><span class="lineCov">          1 :   rendererVTableObj *renderer = MS_IMAGE_RENDERER(image);</span>
<span class="lineNum">    1605 </span><span class="lineCov">          1 :   rasterBufferObj  *rb = msSmallCalloc(1,sizeof(rasterBufferObj));</span>
<span class="lineNum">    1606 </span>            :   int ret;
<span class="lineNum">    1607 </span><span class="lineCov">          1 :   if( renderer-&gt;supports_pixel_buffer ) {</span>
<span class="lineNum">    1608 </span><span class="lineCov">          1 :     if (MS_SUCCESS != renderer-&gt;getRasterBufferHandle( image, rb )) {</span>
<span class="lineNum">    1609 </span><span class="lineNoCov">          0 :       msSetError(MS_MISCERR,&quot;renderer failed to extract raster buffer&quot;,&quot;msDrawRasterLayer()&quot;);</span>
<span class="lineNum">    1610 </span><span class="lineNoCov">          0 :       return MS_FAILURE;</span>
<span class="lineNum">    1611 </span>            :     }
<span class="lineNum">    1612 </span><span class="lineCov">          1 :     ret = msDrawRasterLayerLow( map, layer, image, rb );</span>
<span class="lineNum">    1613 </span>            :   } else {
<span class="lineNum">    1614 </span><span class="lineCov">          1 :     if (MS_SUCCESS != renderer-&gt;initializeRasterBuffer( rb, image-&gt;width, image-&gt;height, MS_IMAGEMODE_RGBA )) {</span>
<span class="lineNum">    1615 </span><span class="lineNoCov">          0 :       msSetError(MS_MISCERR,&quot;renderer failed to create raster buffer&quot;,&quot;msDrawRasterLayer()&quot;);</span>
<span class="lineNum">    1616 </span><span class="lineNoCov">          0 :       return MS_FAILURE;</span>
<span class="lineNum">    1617 </span>            :     }
<span class="lineNum">    1618 </span>            : 
<span class="lineNum">    1619 </span><span class="lineCov">          1 :     ret = msDrawRasterLayerLow( map, layer, image, rb );</span>
<span class="lineNum">    1620 </span>            : 
<span class="lineNum">    1621 </span><span class="lineCov">          1 :     if( ret == 0 ) {</span>
<span class="lineNum">    1622 </span><span class="lineCov">          1 :       ret = renderer-&gt;mergeRasterBuffer( image, rb, 1.0, 0, 0, 0, 0, rb-&gt;width, rb-&gt;height );</span>
<span class="lineNum">    1623 </span>            :     }
<span class="lineNum">    1624 </span>            : 
<span class="lineNum">    1625 </span><span class="lineCov">          1 :     msFreeRasterBuffer(rb);</span>
<span class="lineNum">    1626 </span>            :   }
<span class="lineNum">    1627 </span>            : #define RB_GET_R(rb,x,y) *((rb)-&gt;data.rgba.r + (x) * (rb)-&gt;data.rgba.pixel_step + (y) * (rb)-&gt;data.rgba.row_step)
<span class="lineNum">    1628 </span>            : #define RB_GET_G(rb,x,y) *((rb)-&gt;data.rgba.g + (x) * (rb)-&gt;data.rgba.pixel_step + (y) * (rb)-&gt;data.rgba.row_step)
<span class="lineNum">    1629 </span>            : #define RB_GET_B(rb,x,y) *((rb)-&gt;data.rgba.b + (x) * (rb)-&gt;data.rgba.pixel_step + (y) * (rb)-&gt;data.rgba.row_step)
<span class="lineNum">    1630 </span>            : #define RB_GET_A(rb,x,y) *((rb)-&gt;data.rgba.a + (x) * (rb)-&gt;data.rgba.pixel_step + (y) * (rb)-&gt;data.rgba.row_step)
<span class="lineNum">    1631 </span>            : 
<span class="lineNum">    1632 </span><span class="lineCov">          1 :   free(rb);</span>
<span class="lineNum">    1633 </span>            : 
<span class="lineNum">    1634 </span><span class="lineCov">          1 :   return ret;</span>
<span class="lineNum">    1635 </span>            : }
<span class="lineNum">    1636 </span>            : 
<span class="lineNum">    1637 </span>            : /**
<a name="1638"><span class="lineNum">    1638 </span>            :  * Generic function to render raster layers.</a>
<span class="lineNum">    1639 </span>            :  */
<span class="lineNum">    1640 </span><span class="lineCov">          1 : int msDrawRasterLayer(mapObj *map, layerObj *layer, imageObj *image)</span>
<span class="lineNum">    1641 </span>            : {
<span class="lineNum">    1642 </span>            :   
<span class="lineNum">    1643 </span>            :   int rv = MS_FAILURE;
<span class="lineNum">    1644 </span><span class="lineCov">          1 :   if (!image || !map || !layer) {</span>
<span class="lineNum">    1645 </span>            :     return rv;
<span class="lineNum">    1646 </span>            :   }
<span class="lineNum">    1647 </span>            : 
<span class="lineNum">    1648 </span>            :   /* RFC-86 Scale dependant token replacements*/
<span class="lineNum">    1649 </span><span class="lineCov">          1 :   rv = msLayerApplyScaletokens(layer,(layer-&gt;map)?layer-&gt;map-&gt;scaledenom:-1);</span>
<span class="lineNum">    1650 </span><span class="lineCov">          1 :   if (rv != MS_SUCCESS) return rv;</span>
<span class="lineNum">    1651 </span><span class="lineCov">          1 :   if( MS_RENDERER_PLUGIN(image-&gt;format) )</span>
<span class="lineNum">    1652 </span><span class="lineCov">          1 :     rv = msDrawRasterLayerPlugin(map, layer, image);</span>
<span class="lineNum">    1653 </span><span class="lineCov">          1 :   else if( MS_RENDERER_RAWDATA(image-&gt;format) )</span>
<span class="lineNum">    1654 </span><span class="lineCov">          1 :     rv = msDrawRasterLayerLow(map, layer, image, NULL);</span>
<span class="lineNum">    1655 </span><span class="lineCov">          1 :   msLayerRestoreFromScaletokens(layer);</span>
<span class="lineNum">    1656 </span><span class="lineCov">          1 :   return rv;</span>
<span class="lineNum">    1657 </span>            : }
<span class="lineNum">    1658 </span>            : 
<span class="lineNum">    1659 </span>            : /**
<span class="lineNum">    1660 </span>            :  * msDrawWMSLayer()
<span class="lineNum">    1661 </span>            :  *
<span class="lineNum">    1662 </span>            :  * Draw a single WMS layer.
<span class="lineNum">    1663 </span>            :  * Multiple WMS layers in a map are preloaded and then drawn using
<span class="lineNum">    1664 </span>            :  * msDrawWMSLayerLow()
<span class="lineNum">    1665 </span>            :  */
<a name="1666"><span class="lineNum">    1666 </span>            : </a>
<span class="lineNum">    1667 </span>            : #ifdef USE_WMS_LYR
<span class="lineNum">    1668 </span><span class="lineNoCov">          0 : int msDrawWMSLayer(mapObj *map, layerObj *layer, imageObj *image)</span>
<span class="lineNum">    1669 </span>            : {
<span class="lineNum">    1670 </span>            :   int nStatus = MS_FAILURE;
<span class="lineNum">    1671 </span>            : 
<span class="lineNum">    1672 </span><span class="lineNoCov">          0 :   if (image &amp;&amp; map &amp;&amp; layer) {</span>
<span class="lineNum">    1673 </span>            :     /* ------------------------------------------------------------------
<span class="lineNum">    1674 </span>            :      * Start by downloading the layer
<span class="lineNum">    1675 </span>            :      * ------------------------------------------------------------------ */
<span class="lineNum">    1676 </span>            :     httpRequestObj asReqInfo[2];
<span class="lineNum">    1677 </span><span class="lineNoCov">          0 :     int numReq = 0;</span>
<span class="lineNum">    1678 </span>            : 
<span class="lineNum">    1679 </span><span class="lineNoCov">          0 :     msHTTPInitRequestObj(asReqInfo, 2);</span>
<span class="lineNum">    1680 </span>            : 
<span class="lineNum">    1681 </span><span class="lineNoCov">          0 :     if ( msPrepareWMSLayerRequest(1, map, layer, 1,</span>
<span class="lineNum">    1682 </span>            :                                   0, NULL, 0, 0, 0, NULL,
<span class="lineNum">    1683 </span><span class="lineNoCov">          0 :                                   asReqInfo, &amp;numReq) == MS_FAILURE  ||</span>
<span class="lineNum">    1684 </span><span class="lineNoCov">          0 :          msOWSExecuteRequests(asReqInfo, numReq, map, MS_TRUE) == MS_FAILURE ) {</span>
<span class="lineNum">    1685 </span><span class="lineNoCov">          0 :       return MS_FAILURE;</span>
<span class="lineNum">    1686 </span>            :     }
<span class="lineNum">    1687 </span>            : 
<span class="lineNum">    1688 </span>            :     /* ------------------------------------------------------------------
<span class="lineNum">    1689 </span>            :      * Then draw layer based on output format
<span class="lineNum">    1690 </span>            :      * ------------------------------------------------------------------ */
<span class="lineNum">    1691 </span><span class="lineNoCov">          0 :     if( MS_RENDERER_PLUGIN(image-&gt;format) )</span>
<span class="lineNum">    1692 </span><span class="lineNoCov">          0 :       nStatus = msDrawWMSLayerLow(1, asReqInfo, numReq,</span>
<span class="lineNum">    1693 </span>            :                                   map, layer, image) ;
<span class="lineNum">    1694 </span><span class="lineNoCov">          0 :     else if( MS_RENDERER_RAWDATA(image-&gt;format) )</span>
<span class="lineNum">    1695 </span><span class="lineNoCov">          0 :       nStatus = msDrawWMSLayerLow(1, asReqInfo, numReq,</span>
<span class="lineNum">    1696 </span>            :                                   map, layer, image) ;
<span class="lineNum">    1697 </span>            : 
<span class="lineNum">    1698 </span>            :     else {
<span class="lineNum">    1699 </span><span class="lineNoCov">          0 :       msSetError(MS_WMSCONNERR,</span>
<span class="lineNum">    1700 </span>            :                  &quot;Output format '%s' doesn't support WMS layers.&quot;,
<span class="lineNum">    1701 </span>            :                  &quot;msDrawWMSLayer()&quot;, image-&gt;format-&gt;name);
<span class="lineNum">    1702 </span>            :       nStatus = MS_SUCCESS; /* Should we fail if output doesn't support WMS? */
<span class="lineNum">    1703 </span>            :     }
<span class="lineNum">    1704 </span>            :     /* Cleanup */
<span class="lineNum">    1705 </span><span class="lineNoCov">          0 :     msHTTPFreeRequestObj(asReqInfo, numReq);</span>
<span class="lineNum">    1706 </span>            :   }
<span class="lineNum">    1707 </span>            : 
<span class="lineNum">    1708 </span>            :   return nStatus;
<span class="lineNum">    1709 </span>            : }
<a name="1710"><span class="lineNum">    1710 </span>            : #endif</a>
<span class="lineNum">    1711 </span>            : 
<span class="lineNum">    1712 </span><span class="lineCov">          1 : int circleLayerDrawShape(mapObj *map, imageObj *image, layerObj *layer, shapeObj *shape)</span>
<span class="lineNum">    1713 </span>            : {
<span class="lineNum">    1714 </span>            :   pointObj center;
<span class="lineNum">    1715 </span>            :   double r;
<span class="lineNum">    1716 </span>            :   int s;
<span class="lineNum">    1717 </span><span class="lineCov">          1 :   int c = shape-&gt;classindex;</span>
<span class="lineNum">    1718 </span>            : 
<span class="lineNum">    1719 </span><span class="lineCov">          1 :   if (shape-&gt;numlines != 1) return (MS_SUCCESS); /* invalid shape */</span>
<span class="lineNum">    1720 </span><span class="lineCov">          1 :   if (shape-&gt;line[0].numpoints != 2) return (MS_SUCCESS); /* invalid shape */</span>
<span class="lineNum">    1721 </span>            : 
<span class="lineNum">    1722 </span><span class="lineCov">          1 :   center.x = (shape-&gt;line[0].point[0].x + shape-&gt;line[0].point[1].x) / 2.0;</span>
<span class="lineNum">    1723 </span><span class="lineCov">          1 :   center.y = (shape-&gt;line[0].point[0].y + shape-&gt;line[0].point[1].y) / 2.0;</span>
<span class="lineNum">    1724 </span><span class="lineCov">          1 :   r = MS_ABS(center.x - shape-&gt;line[0].point[0].x);</span>
<span class="lineNum">    1725 </span><span class="lineCov">          1 :   if (r == 0)</span>
<span class="lineNum">    1726 </span><span class="lineNoCov">          0 :     r = MS_ABS(center.y - shape-&gt;line[0].point[0].y);</span>
<span class="lineNum">    1727 </span><span class="lineCov">          1 :   if (r == 0)</span>
<span class="lineNum">    1728 </span>            :     return (MS_SUCCESS);
<span class="lineNum">    1729 </span>            : 
<span class="lineNum">    1730 </span><span class="lineCov">          1 :   if (layer-&gt;transform == MS_TRUE) {</span>
<span class="lineNum">    1731 </span>            : 
<span class="lineNum">    1732 </span><span class="lineCov">          1 :     if (layer-&gt;project)</span>
<span class="lineNum">    1733 </span><span class="lineNoCov">          0 :       msProjectPoint(&amp;layer-&gt;projection, &amp;map-&gt;projection, &amp;center);</span>
<span class="lineNum">    1734 </span>            : 
<span class="lineNum">    1735 </span><span class="lineCov">          1 :     center.x = MS_MAP2IMAGE_X(center.x, map-&gt;extent.minx, map-&gt;cellsize);</span>
<span class="lineNum">    1736 </span><span class="lineCov">          1 :     center.y = MS_MAP2IMAGE_Y(center.y, map-&gt;extent.maxy, map-&gt;cellsize);</span>
<span class="lineNum">    1737 </span><span class="lineCov">          1 :     r /= map-&gt;cellsize;</span>
<span class="lineNum">    1738 </span>            :   } else
<span class="lineNum">    1739 </span><span class="lineNoCov">          0 :     msOffsetPointRelativeTo(&amp;center, layer);</span>
<span class="lineNum">    1740 </span>            : 
<span class="lineNum">    1741 </span><span class="lineCov">          1 :   for (s = 0; s &lt; layer-&gt;class[c]-&gt;numstyles; s++) {</span>
<span class="lineNum">    1742 </span><span class="lineCov">          1 :     if (msScaleInBounds(map-&gt;scaledenom,</span>
<span class="lineNum">    1743 </span>            :                         layer-&gt;class[c]-&gt;styles[s]-&gt;minscaledenom,
<span class="lineNum">    1744 </span><span class="lineCov">          1 :                         layer-&gt;class[c]-&gt;styles[s]-&gt;maxscaledenom))</span>
<span class="lineNum">    1745 </span><span class="lineCov">          1 :       if(UNLIKELY(MS_FAILURE == msCircleDrawShadeSymbol(map, image, &amp;center, r,</span>
<span class="lineNum">    1746 </span>            :                               layer-&gt;class[c]-&gt;styles[s], layer-&gt;class[c]-&gt;styles[s]-&gt;scalefactor))) {
<span class="lineNum">    1747 </span>            :         return MS_FAILURE;
<span class="lineNum">    1748 </span>            :       }
<span class="lineNum">    1749 </span>            :   }
<span class="lineNum">    1750 </span>            :   return MS_SUCCESS;
<span class="lineNum">    1751 </span>            :   /* TODO: need to handle circle annotation */
<span class="lineNum">    1752 </span>            : }
<a name="1753"><span class="lineNum">    1753 </span>            : </a>
<span class="lineNum">    1754 </span>            : static
<span class="lineNum">    1755 </span><span class="lineCov">          1 : int pointLayerDrawShape(mapObj *map, imageObj *image, layerObj *layer, shapeObj *shape, int drawmode)</span>
<span class="lineNum">    1756 </span>            : {
<span class="lineNum">    1757 </span><span class="lineCov">          1 :   int l, c = shape-&gt;classindex, j, i, s;</span>
<span class="lineNum">    1758 </span>            :   pointObj *point;
<span class="lineNum">    1759 </span>            :   int ret = MS_FAILURE;
<span class="lineNum">    1760 </span>            : 
<span class="lineNum">    1761 </span><span class="lineCov">          1 :   if (layer-&gt;project &amp;&amp; layer-&gt;transform == MS_TRUE)</span>
<span class="lineNum">    1762 </span>            :   {
<span class="lineNum">    1763 </span><span class="lineCov">          1 :       if( layer-&gt;reprojectorLayerToMap == NULL )</span>
<span class="lineNum">    1764 </span>            :       {
<span class="lineNum">    1765 </span><span class="lineCov">          1 :           layer-&gt;reprojectorLayerToMap = msProjectCreateReprojector(</span>
<span class="lineNum">    1766 </span>            :               &amp;layer-&gt;projection, &amp;map-&gt;projection);
<span class="lineNum">    1767 </span><span class="lineCov">          1 :         if( layer-&gt;reprojectorLayerToMap == NULL )</span>
<span class="lineNum">    1768 </span>            :         {
<span class="lineNum">    1769 </span>            :             return MS_FAILURE;
<span class="lineNum">    1770 </span>            :         }
<span class="lineNum">    1771 </span>            :       }
<span class="lineNum">    1772 </span><span class="lineCov">          1 :       msProjectShapeEx(layer-&gt;reprojectorLayerToMap, shape);</span>
<span class="lineNum">    1773 </span>            :   }
<span class="lineNum">    1774 </span>            : 
<span class="lineNum">    1775 </span>            :   // Only take into account map rotation if the label and style angles are
<span class="lineNum">    1776 </span>            :   // non-zero.
<span class="lineNum">    1777 </span><span class="lineCov">          1 :   if( map-&gt;gt.rotation_angle )</span>
<span class="lineNum">    1778 </span>            :   {
<span class="lineNum">    1779 </span><span class="lineCov">          1 :     for (l = 0; l &lt; layer-&gt;class[c]-&gt;numlabels; l++)</span>
<span class="lineNum">    1780 </span>            :     {
<span class="lineNum">    1781 </span><span class="lineCov">          1 :         if( layer-&gt;class[c]-&gt;labels[l]-&gt;angle != 0 )</span>
<span class="lineNum">    1782 </span><span class="lineCov">          1 :             layer-&gt;class[c]-&gt;labels[l]-&gt;angle -= map-&gt;gt.rotation_angle;</span>
<span class="lineNum">    1783 </span>            :     }
<span class="lineNum">    1784 </span>            : 
<span class="lineNum">    1785 </span><span class="lineCov">          1 :     for (s = 0; s &lt; layer-&gt;class[c]-&gt;numstyles; s++)</span>
<span class="lineNum">    1786 </span>            :     {
<span class="lineNum">    1787 </span><span class="lineCov">          1 :         if( layer-&gt;class[c]-&gt;styles[s]-&gt;angle != 0 )</span>
<span class="lineNum">    1788 </span><span class="lineCov">          1 :             layer-&gt;class[c]-&gt;styles[s]-&gt;angle -= map-&gt;gt.rotation_angle;</span>
<span class="lineNum">    1789 </span>            :     }
<span class="lineNum">    1790 </span>            :   }
<span class="lineNum">    1791 </span>            : 
<span class="lineNum">    1792 </span><span class="lineCov">          1 :   for (j = 0; j &lt; shape-&gt;numlines; j++) {</span>
<span class="lineNum">    1793 </span><span class="lineCov">          1 :     for (i = 0; i &lt; shape-&gt;line[j].numpoints; i++) {</span>
<span class="lineNum">    1794 </span><span class="lineCov">          1 :       point = &amp;(shape-&gt;line[j].point[i]);</span>
<span class="lineNum">    1795 </span><span class="lineCov">          1 :       if (layer-&gt;transform == MS_TRUE) {</span>
<span class="lineNum">    1796 </span><span class="lineCov">          1 :         if (!msPointInRect(point, &amp;map-&gt;extent)) continue; /* next point */</span>
<span class="lineNum">    1797 </span><span class="lineCov">          1 :         msTransformPoint(point, &amp;map-&gt;extent, map-&gt;cellsize, image);</span>
<span class="lineNum">    1798 </span>            :       } else
<span class="lineNum">    1799 </span><span class="lineCov">          1 :         msOffsetPointRelativeTo(point, layer);</span>
<span class="lineNum">    1800 </span>            : 
<span class="lineNum">    1801 </span><span class="lineCov">          1 :       if(MS_DRAW_FEATURES(drawmode)) {</span>
<span class="lineNum">    1802 </span><span class="lineCov">          1 :         for (s = 0; s &lt; layer-&gt;class[c]-&gt;numstyles; s++) {</span>
<span class="lineNum">    1803 </span><span class="lineCov">          1 :           if (msScaleInBounds(map-&gt;scaledenom,</span>
<span class="lineNum">    1804 </span>            :               layer-&gt;class[c]-&gt;styles[s]-&gt;minscaledenom,
<span class="lineNum">    1805 </span><span class="lineCov">          1 :               layer-&gt;class[c]-&gt;styles[s]-&gt;maxscaledenom))</span>
<span class="lineNum">    1806 </span><span class="lineCov">          1 :             if(UNLIKELY(MS_FAILURE == msDrawMarkerSymbol(map, image, point, layer-&gt;class[c]-&gt;styles[s], layer-&gt;class[c]-&gt;styles[s]-&gt;scalefactor))) {</span>
<span class="lineNum">    1807 </span>            :               goto end;
<span class="lineNum">    1808 </span>            :             }
<span class="lineNum">    1809 </span>            :         }
<span class="lineNum">    1810 </span>            :       }
<span class="lineNum">    1811 </span><span class="lineCov">          1 :       if(MS_DRAW_LABELS(drawmode)) {</span>
<span class="lineNum">    1812 </span><span class="lineCov">          1 :         if (layer-&gt;labelcache) {</span>
<span class="lineNum">    1813 </span><span class="lineCov">          1 :           if (msAddLabelGroup(map, image, layer, c, shape, point, -1) != MS_SUCCESS) goto end;</span>
<span class="lineNum">    1814 </span>            :         } else {
<span class="lineNum">    1815 </span><span class="lineCov">          1 :           for (l = 0; l &lt; layer-&gt;class[c]-&gt;numlabels; l++)</span>
<span class="lineNum">    1816 </span><span class="lineCov">          1 :             if(msGetLabelStatus(map,layer,shape,layer-&gt;class[c]-&gt;labels[l]) == MS_ON) {</span>
<span class="lineNum">    1817 </span><span class="lineCov">          1 :               char *annotext = msShapeGetLabelAnnotation(layer,shape,layer-&gt;class[c]-&gt;labels[l]);</span>
<span class="lineNum">    1818 </span><span class="lineCov">          1 :               if(UNLIKELY(MS_FAILURE == msDrawLabel(map, image, *point, annotext, layer-&gt;class[c]-&gt;labels[l], layer-&gt;class[c]-&gt;labels[l]-&gt;scalefactor))) {</span>
<span class="lineNum">    1819 </span>            :                 goto end;
<span class="lineNum">    1820 </span>            :               }
<span class="lineNum">    1821 </span>            :             }
<span class="lineNum">    1822 </span>            :         }
<span class="lineNum">    1823 </span>            :       }
<span class="lineNum">    1824 </span>            :     }
<span class="lineNum">    1825 </span>            :   }
<span class="lineNum">    1826 </span>            :   ret = MS_SUCCESS;
<span class="lineNum">    1827 </span>            : 
<span class="lineNum">    1828 </span><span class="lineCov">          1 : end:</span>
<span class="lineNum">    1829 </span><span class="lineCov">          1 :   if( map-&gt;gt.rotation_angle )</span>
<span class="lineNum">    1830 </span>            :   {
<span class="lineNum">    1831 </span><span class="lineCov">          1 :     for (l = 0; l &lt; layer-&gt;class[c]-&gt;numlabels; l++)</span>
<span class="lineNum">    1832 </span>            :     {
<span class="lineNum">    1833 </span><span class="lineCov">          1 :         if( layer-&gt;class[c]-&gt;labels[l]-&gt;angle != 0 )</span>
<span class="lineNum">    1834 </span><span class="lineCov">          1 :             layer-&gt;class[c]-&gt;labels[l]-&gt;angle += map-&gt;gt.rotation_angle;</span>
<span class="lineNum">    1835 </span>            :     }
<span class="lineNum">    1836 </span>            : 
<span class="lineNum">    1837 </span><span class="lineCov">          1 :     for (s = 0; s &lt; layer-&gt;class[c]-&gt;numstyles; s++)</span>
<span class="lineNum">    1838 </span>            :     {
<span class="lineNum">    1839 </span><span class="lineCov">          1 :         if( layer-&gt;class[c]-&gt;styles[s]-&gt;angle != 0 )</span>
<span class="lineNum">    1840 </span><span class="lineCov">          1 :             layer-&gt;class[c]-&gt;styles[s]-&gt;angle += map-&gt;gt.rotation_angle;</span>
<span class="lineNum">    1841 </span>            :     }
<span class="lineNum">    1842 </span>            :   }
<span class="lineNum">    1843 </span>            : 
<span class="lineNum">    1844 </span>            :   return ret;
<a name="1845"><span class="lineNum">    1845 </span>            : }</a>
<span class="lineNum">    1846 </span>            : 
<span class="lineNum">    1847 </span><span class="lineCov">          1 : int lineLayerDrawShape(mapObj *map, imageObj *image, layerObj *layer, shapeObj *shape,</span>
<span class="lineNum">    1848 </span>            :                        shapeObj *anno_shape, shapeObj *unclipped_shape, int style, int drawmode)
<span class="lineNum">    1849 </span>            : {
<span class="lineNum">    1850 </span><span class="lineCov">          1 :   int c = shape-&gt;classindex;</span>
<span class="lineNum">    1851 </span>            :   int ret = MS_SUCCESS;
<span class="lineNum">    1852 </span>            :   int i, s, l = 0;
<span class="lineNum">    1853 </span>            : 
<span class="lineNum">    1854 </span>            :   /* RFC48: loop through the styles, and pass off to the type-specific
<span class="lineNum">    1855 </span>            :   function if the style has an appropriate type */
<span class="lineNum">    1856 </span><span class="lineCov">          1 :   if(MS_DRAW_FEATURES(drawmode)) {</span>
<span class="lineNum">    1857 </span><span class="lineCov">          1 :     for (s = 0; s &lt; layer-&gt;class[c]-&gt;numstyles; s++) {</span>
<span class="lineNum">    1858 </span><span class="lineCov">          1 :       if (msScaleInBounds(map-&gt;scaledenom,</span>
<span class="lineNum">    1859 </span>            :           layer-&gt;class[c]-&gt;styles[s]-&gt;minscaledenom,
<span class="lineNum">    1860 </span><span class="lineCov">          1 :           layer-&gt;class[c]-&gt;styles[s]-&gt;maxscaledenom)) {</span>
<span class="lineNum">    1861 </span><span class="lineCov">          1 :         if (layer-&gt;class[c]-&gt;styles[s]-&gt;_geomtransform.type != MS_GEOMTRANSFORM_NONE) {</span>
<span class="lineNum">    1862 </span><span class="lineCov">          1 :           if(UNLIKELY(MS_FAILURE == msDrawTransformedShape(map, image, unclipped_shape, layer-&gt;class[c]-&gt;styles[s], layer-&gt;class[c]-&gt;styles[s]-&gt;scalefactor))) {</span>
<span class="lineNum">    1863 </span>            :             return MS_FAILURE;
<span class="lineNum">    1864 </span>            :           }
<span class="lineNum">    1865 </span>            :         }
<span class="lineNum">    1866 </span><span class="lineCov">          1 :         else if (!MS_DRAW_SINGLESTYLE(drawmode) || s == style) {</span>
<span class="lineNum">    1867 </span><span class="lineCov">          1 :           if(UNLIKELY(MS_FAILURE == msDrawLineSymbol(map, image, shape, layer-&gt;class[c]-&gt;styles[s], layer-&gt;class[c]-&gt;styles[s]-&gt;scalefactor))) {</span>
<span class="lineNum">    1868 </span>            :             return MS_FAILURE;
<span class="lineNum">    1869 </span>            :           }
<span class="lineNum">    1870 </span>            :         }
<span class="lineNum">    1871 </span>            :       }
<span class="lineNum">    1872 </span>            :     }
<span class="lineNum">    1873 </span>            :   }
<span class="lineNum">    1874 </span>            :   
<span class="lineNum">    1875 </span><span class="lineCov">          1 :   if(MS_DRAW_LABELS(drawmode)) {</span>
<span class="lineNum">    1876 </span><span class="lineCov">          1 :     for (l = 0; l &lt; layer-&gt;class[c]-&gt;numlabels; l++) {</span>
<span class="lineNum">    1877 </span><span class="lineCov">          1 :       labelObj *label = layer-&gt;class[c]-&gt;labels[l];</span>
<span class="lineNum">    1878 </span>            :       textSymbolObj ts;
<span class="lineNum">    1879 </span>            :       char *annotext;
<span class="lineNum">    1880 </span><span class="lineCov">          1 :       if(!msGetLabelStatus(map,layer,shape,label)) {</span>
<span class="lineNum">    1881 </span><span class="lineCov">          1 :         continue;</span>
<span class="lineNum">    1882 </span>            :       }
<span class="lineNum">    1883 </span>            : 
<span class="lineNum">    1884 </span><span class="lineCov">          1 :       annotext = msShapeGetLabelAnnotation(layer,anno_shape,label);</span>
<span class="lineNum">    1885 </span><span class="lineCov">          1 :       if(!annotext) continue;</span>
<span class="lineNum">    1886 </span><span class="lineCov">          1 :       initTextSymbol(&amp;ts);</span>
<span class="lineNum">    1887 </span><span class="lineCov">          1 :       msPopulateTextSymbolForLabelAndString(&amp;ts,label,annotext,label-&gt;scalefactor,image-&gt;resolutionfactor, layer-&gt;labelcache);</span>
<span class="lineNum">    1888 </span>            :       
<span class="lineNum">    1889 </span>            :       
<span class="lineNum">    1890 </span><span class="lineCov">          1 :       if (label-&gt;anglemode == MS_FOLLOW) { /* bug #1620 implementation */</span>
<span class="lineNum">    1891 </span>            :         struct label_follow_result lfr;
<span class="lineNum">    1892 </span>            :         
<span class="lineNum">    1893 </span><span class="lineCov">          1 :         if (!layer-&gt;labelcache) {</span>
<span class="lineNum">    1894 </span><span class="lineNoCov">          0 :           msSetError(MS_MISCERR, &quot;Angle mode 'FOLLOW' is supported only with labelcache on&quot;, &quot;msDrawShape()&quot;);</span>
<span class="lineNum">    1895 </span>            :           ret = MS_FAILURE;
<span class="lineNum">    1896 </span><span class="lineNoCov">          0 :           goto line_cleanup;</span>
<span class="lineNum">    1897 </span>            :         }
<span class="lineNum">    1898 </span>            :         
<span class="lineNum">    1899 </span>            :         memset(&amp;lfr,0,sizeof(lfr));
<span class="lineNum">    1900 </span><span class="lineCov">          1 :         msPolylineLabelPath(map, image, anno_shape, &amp;ts, label, &amp;lfr);</span>
<span class="lineNum">    1901 </span>            : 
<span class="lineNum">    1902 </span><span class="lineCov">          1 :         for (i = 0; i &lt; lfr.num_follow_labels; i++) {</span>
<span class="lineNum">    1903 </span><span class="lineCov">          1 :           if (msAddLabel(map, image, label, layer-&gt;index, c, anno_shape, NULL, -1, lfr.follow_labels[i]) != MS_SUCCESS) {</span>
<span class="lineNum">    1904 </span>            :             ret = MS_FAILURE;
<span class="lineNum">    1905 </span>            :             goto line_cleanup;
<span class="lineNum">    1906 </span>            :           }
<span class="lineNum">    1907 </span>            :         }
<span class="lineNum">    1908 </span><span class="lineCov">          1 :         free(lfr.follow_labels);</span>
<span class="lineNum">    1909 </span><span class="lineCov">          1 :         for(i=0; i&lt;lfr.lar.num_label_points; i++) {</span>
<span class="lineNum">    1910 </span><span class="lineCov">          1 :           textSymbolObj *ts_auto = msSmallMalloc(sizeof(textSymbolObj));</span>
<span class="lineNum">    1911 </span><span class="lineCov">          1 :           initTextSymbol(ts_auto);</span>
<span class="lineNum">    1912 </span><span class="lineCov">          1 :           msCopyTextSymbol(ts_auto,&amp;ts);</span>
<span class="lineNum">    1913 </span><span class="lineCov">          1 :           ts_auto-&gt;rotation = lfr.lar.angles[i];</span>
<span class="lineNum">    1914 </span><span class="lineCov">          1 :           if (layer-&gt;labelcache) {</span>
<span class="lineNum">    1915 </span><span class="lineCov">          1 :             if (msAddLabel(map, image, label, layer-&gt;index, c, anno_shape, &amp;lfr.lar.label_points[i], -1, ts_auto) != MS_SUCCESS) {</span>
<span class="lineNum">    1916 </span>            :               ret = MS_FAILURE;
<span class="lineNum">    1917 </span><span class="lineNoCov">          0 :               free(lfr.lar.angles);</span>
<span class="lineNum">    1918 </span><span class="lineNoCov">          0 :               free(lfr.lar.label_points);</span>
<span class="lineNum">    1919 </span>            :               goto line_cleanup;
<span class="lineNum">    1920 </span>            :             }
<span class="lineNum">    1921 </span>            :           } else {
<span class="lineNum">    1922 </span><span class="lineNoCov">          0 :             ret = msDrawTextSymbol(map,image,lfr.lar.label_points[i],ts_auto);</span>
<span class="lineNum">    1923 </span><span class="lineNoCov">          0 :             freeTextSymbol(ts_auto);</span>
<span class="lineNum">    1924 </span><span class="lineNoCov">          0 :             free(ts_auto); /* TODO RFC98: could we not re-use the original ts instead of duplicating into ts_auto ?</span>
<span class="lineNum">    1925 </span>            :                             * we cannot for now, as the rendering code will modify the glyph positions to apply
<span class="lineNum">    1926 </span>            :                             * the labelpoint and rotation offsets */
<span class="lineNum">    1927 </span><span class="lineNoCov">          0 :             if(UNLIKELY(MS_FAILURE == ret)) goto line_cleanup;</span>
<span class="lineNum">    1928 </span>            :           }
<span class="lineNum">    1929 </span>            :           
<span class="lineNum">    1930 </span>            :         }
<span class="lineNum">    1931 </span><span class="lineCov">          1 :         free(lfr.lar.angles);</span>
<span class="lineNum">    1932 </span><span class="lineCov">          1 :         free(lfr.lar.label_points);</span>
<span class="lineNum">    1933 </span>            :       } else {
<span class="lineNum">    1934 </span>            :         struct label_auto_result lar;
<span class="lineNum">    1935 </span>            :         memset(&amp;lar,0,sizeof(struct label_auto_result));
<span class="lineNum">    1936 </span><span class="lineCov">          1 :         ret = msPolylineLabelPoint(map, anno_shape, &amp;ts, label, &amp;lar, image-&gt;resolutionfactor);</span>
<span class="lineNum">    1937 </span><span class="lineCov">          1 :         if(UNLIKELY(MS_FAILURE == ret)) goto line_cleanup;</span>
<span class="lineNum">    1938 </span>            : 
<span class="lineNum">    1939 </span><span class="lineCov">          1 :         if (label-&gt;angle != 0)</span>
<span class="lineNum">    1940 </span><span class="lineCov">          1 :           label-&gt;angle -= map-&gt;gt.rotation_angle; /* apply rotation angle */</span>
<span class="lineNum">    1941 </span>            : 
<span class="lineNum">    1942 </span><span class="lineCov">          1 :         for(i=0; i&lt;lar.num_label_points; i++) {</span>
<span class="lineNum">    1943 </span><span class="lineCov">          1 :           textSymbolObj *ts_auto = msSmallMalloc(sizeof(textSymbolObj));</span>
<span class="lineNum">    1944 </span><span class="lineCov">          1 :           initTextSymbol(ts_auto);</span>
<span class="lineNum">    1945 </span><span class="lineCov">          1 :           msCopyTextSymbol(ts_auto,&amp;ts);</span>
<span class="lineNum">    1946 </span><span class="lineCov">          1 :           ts_auto-&gt;rotation = lar.angles[i];</span>
<span class="lineNum">    1947 </span><span class="lineCov">          1 :           if (layer-&gt;labelcache) {</span>
<span class="lineNum">    1948 </span><span class="lineCov">          1 :             if (msAddLabel(map, image, label, layer-&gt;index, c, anno_shape, &amp;lar.label_points[i], -1, ts_auto) != MS_SUCCESS) {</span>
<span class="lineNum">    1949 </span>            :               ret = MS_FAILURE;
<span class="lineNum">    1950 </span><span class="lineNoCov">          0 :               free(lar.angles);</span>
<span class="lineNum">    1951 </span><span class="lineNoCov">          0 :               free(lar.label_points);</span>
<span class="lineNum">    1952 </span><span class="lineNoCov">          0 :               freeTextSymbol(ts_auto);</span>
<span class="lineNum">    1953 </span><span class="lineNoCov">          0 :               free(ts_auto);</span>
<span class="lineNum">    1954 </span>            :               goto line_cleanup;
<span class="lineNum">    1955 </span>            :             }
<span class="lineNum">    1956 </span>            :           } else {
<span class="lineNum">    1957 </span><span class="lineCov">          1 :             if(!ts_auto-&gt;textpath) {</span>
<span class="lineNum">    1958 </span><span class="lineCov">          1 :               if(UNLIKELY(MS_FAILURE == msComputeTextPath(map,ts_auto))) {</span>
<span class="lineNum">    1959 </span>            :                 ret = MS_FAILURE;
<span class="lineNum">    1960 </span><span class="lineNoCov">          0 :                 free(lar.angles);</span>
<span class="lineNum">    1961 </span><span class="lineNoCov">          0 :                 free(lar.label_points);</span>
<span class="lineNum">    1962 </span><span class="lineNoCov">          0 :                 freeTextSymbol(ts_auto);</span>
<span class="lineNum">    1963 </span><span class="lineNoCov">          0 :                 free(ts_auto);</span>
<span class="lineNum">    1964 </span>            :                 goto line_cleanup;
<span class="lineNum">    1965 </span>            :               }
<span class="lineNum">    1966 </span>            :             }
<span class="lineNum">    1967 </span><span class="lineCov">          1 :             ret = msDrawTextSymbol(map,image,lar.label_points[i],ts_auto);</span>
<span class="lineNum">    1968 </span><span class="lineCov">          1 :             freeTextSymbol(ts_auto);</span>
<span class="lineNum">    1969 </span><span class="lineCov">          1 :             free(ts_auto); /* TODO RFC98: could we not re-use the original ts instead of duplicating into ts_auto ?</span>
<span class="lineNum">    1970 </span>            :                             * we cannot for now, as the rendering code will modify the glyph positions to apply
<span class="lineNum">    1971 </span>            :                             * the labelpoint and rotation offsets */
<span class="lineNum">    1972 </span>            :             ts_auto = NULL;
<span class="lineNum">    1973 </span><span class="lineCov">          1 :             if(UNLIKELY(MS_FAILURE == ret)) goto line_cleanup;</span>
<span class="lineNum">    1974 </span>            :           }
<span class="lineNum">    1975 </span>            :           
<span class="lineNum">    1976 </span>            :         }
<span class="lineNum">    1977 </span><span class="lineCov">          1 :         free(lar.angles);</span>
<span class="lineNum">    1978 </span><span class="lineCov">          1 :         free(lar.label_points);</span>
<span class="lineNum">    1979 </span>            :       }
<span class="lineNum">    1980 </span>            : 
<span class="lineNum">    1981 </span><span class="lineCov">          1 : line_cleanup:</span>
<span class="lineNum">    1982 </span>            :       /* clean up and reset */
<span class="lineNum">    1983 </span><span class="lineCov">          1 :       if (ret == MS_FAILURE) {</span>
<span class="lineNum">    1984 </span>            :         break; /* from the label looping */
<span class="lineNum">    1985 </span>            :       }
<span class="lineNum">    1986 </span><span class="lineCov">          1 :       freeTextSymbol(&amp;ts);</span>
<span class="lineNum">    1987 </span>            :     } /* next label */
<span class="lineNum">    1988 </span>            :   }
<span class="lineNum">    1989 </span>            : 
<span class="lineNum">    1990 </span>            :   return ret;
<span class="lineNum">    1991 </span>            : 
<a name="1992"><span class="lineNum">    1992 </span>            : }</a>
<span class="lineNum">    1993 </span>            : 
<span class="lineNum">    1994 </span><span class="lineCov">          1 : int polygonLayerDrawShape(mapObj *map, imageObj *image, layerObj *layer,</span>
<span class="lineNum">    1995 </span>            :                           shapeObj *shape, shapeObj *anno_shape, shapeObj *unclipped_shape, int drawmode)
<span class="lineNum">    1996 </span>            : {
<span class="lineNum">    1997 </span>            : 
<span class="lineNum">    1998 </span><span class="lineCov">          1 :   int c = shape-&gt;classindex;</span>
<span class="lineNum">    1999 </span>            :   pointObj annopnt;
<span class="lineNum">    2000 </span>            :   int i;
<span class="lineNum">    2001 </span>            : 
<span class="lineNum">    2002 </span><span class="lineCov">          1 :   if(MS_DRAW_FEATURES(drawmode)) {</span>
<span class="lineNum">    2003 </span><span class="lineCov">          1 :     for (i = 0; i &lt; layer-&gt;class[c]-&gt;numstyles; i++) {</span>
<span class="lineNum">    2004 </span><span class="lineCov">          1 :       if (msScaleInBounds(map-&gt;scaledenom, layer-&gt;class[c]-&gt;styles[i]-&gt;minscaledenom,</span>
<span class="lineNum">    2005 </span><span class="lineCov">          1 :                           layer-&gt;class[c]-&gt;styles[i]-&gt;maxscaledenom)) {</span>
<span class="lineNum">    2006 </span><span class="lineCov">          1 :         if (layer-&gt;class[c]-&gt;styles[i]-&gt;_geomtransform.type == MS_GEOMTRANSFORM_NONE) {</span>
<span class="lineNum">    2007 </span><span class="lineCov">          1 :           if(UNLIKELY(MS_FAILURE == msDrawShadeSymbol(map, image, shape, layer-&gt;class[c]-&gt;styles[i], layer-&gt;class[c]-&gt;styles[i]-&gt;scalefactor))) {</span>
<span class="lineNum">    2008 </span>            :             return MS_FAILURE;
<span class="lineNum">    2009 </span>            :           }
<span class="lineNum">    2010 </span>            :         }
<span class="lineNum">    2011 </span>            :         else {
<span class="lineNum">    2012 </span><span class="lineCov">          1 :           if(UNLIKELY(MS_FAILURE == msDrawTransformedShape(map, image, unclipped_shape,</span>
<span class="lineNum">    2013 </span>            :                                  layer-&gt;class[c]-&gt;styles[i], layer-&gt;class[c]-&gt;styles[i]-&gt;scalefactor))) {
<span class="lineNum">    2014 </span>            :             return MS_FAILURE;
<span class="lineNum">    2015 </span>            :           }
<span class="lineNum">    2016 </span>            :         }
<span class="lineNum">    2017 </span>            :       }
<span class="lineNum">    2018 </span>            :     }
<span class="lineNum">    2019 </span>            :   }
<span class="lineNum">    2020 </span>            : 
<span class="lineNum">    2021 </span><span class="lineCov">          1 :   if(MS_DRAW_LABELS(drawmode)) {</span>
<span class="lineNum">    2022 </span><span class="lineCov">          1 :     if (layer-&gt;class[c]-&gt;numlabels &gt; 0) {</span>
<span class="lineNum">    2023 </span><span class="lineCov">          1 :       double minfeaturesize = layer-&gt;class[c]-&gt;labels[0]-&gt;minfeaturesize * image-&gt;resolutionfactor;</span>
<span class="lineNum">    2024 </span><span class="lineCov">          1 :       if (msPolygonLabelPoint(anno_shape, &amp;annopnt, minfeaturesize) == MS_SUCCESS) {</span>
<span class="lineNum">    2025 </span><span class="lineCov">          1 :         for (i = 0; i &lt; layer-&gt;class[c]-&gt;numlabels; i++)</span>
<span class="lineNum">    2026 </span><span class="lineCov">          1 :           if (layer-&gt;class[c]-&gt;labels[i]-&gt;angle != 0) layer-&gt;class[c]-&gt;labels[i]-&gt;angle -= map-&gt;gt.rotation_angle; /* TODO: is this correct ??? */</span>
<span class="lineNum">    2027 </span><span class="lineCov">          1 :         if (layer-&gt;labelcache) {</span>
<span class="lineNum">    2028 </span><span class="lineCov">          1 :           if (msAddLabelGroup(map, image, layer, c, anno_shape, &amp;annopnt,</span>
<span class="lineNum">    2029 </span><span class="lineCov">          1 :                               MS_MIN(shape-&gt;bounds.maxx - shape-&gt;bounds.minx, shape-&gt;bounds.maxy - shape-&gt;bounds.miny)) != MS_SUCCESS) {</span>
<span class="lineNum">    2030 </span>            :             return MS_FAILURE;
<span class="lineNum">    2031 </span>            :           }
<span class="lineNum">    2032 </span>            :         } else {
<span class="lineNum">    2033 </span><span class="lineCov">          1 :           for (i = 0; i &lt; layer-&gt;class[c]-&gt;numlabels; i++)</span>
<span class="lineNum">    2034 </span><span class="lineCov">          1 :             if(msGetLabelStatus(map,layer,shape,layer-&gt;class[c]-&gt;labels[i]) == MS_ON) {</span>
<span class="lineNum">    2035 </span><span class="lineCov">          1 :               char *annotext = msShapeGetLabelAnnotation(layer,shape,layer-&gt;class[c]-&gt;labels[i]); /*ownership taken by msDrawLabel, no need to free */</span>
<span class="lineNum">    2036 </span><span class="lineCov">          1 :               if(UNLIKELY(MS_FAILURE == msDrawLabel(map, image, annopnt, annotext, layer-&gt;class[c]-&gt;labels[i], layer-&gt;class[c]-&gt;labels[i]-&gt;scalefactor))) {</span>
<span class="lineNum">    2037 </span>            :                 return MS_FAILURE;
<span class="lineNum">    2038 </span>            :               }
<span class="lineNum">    2039 </span>            :             }
<span class="lineNum">    2040 </span>            :         }
<span class="lineNum">    2041 </span>            :       }
<span class="lineNum">    2042 </span>            :     }
<span class="lineNum">    2043 </span>            :   }
<span class="lineNum">    2044 </span>            :   return MS_SUCCESS;
<span class="lineNum">    2045 </span>            : }
<span class="lineNum">    2046 </span>            : 
<span class="lineNum">    2047 </span>            : /*
<span class="lineNum">    2048 </span>            : ** Function to render an individual shape, the style variable enables/disables the drawing of a single style
<span class="lineNum">    2049 </span>            : ** versus a single style. This is necessary when drawing entire layers as proper overlay can only be achived
<span class="lineNum">    2050 </span>            : ** through caching. &quot;querymapMode&quot; parameter is used to tell msBindLayerToShape to not override the
<a name="2051"><span class="lineNum">    2051 </span>            : ** QUERYMAP HILITE color.</a>
<span class="lineNum">    2052 </span>            : */
<span class="lineNum">    2053 </span><span class="lineCov">          1 : int msDrawShape(mapObj *map, layerObj *layer, shapeObj *shape, imageObj *image, int style, int drawmode)</span>
<span class="lineNum">    2054 </span>            : {
<span class="lineNum">    2055 </span>            :   int c,s,ret=MS_SUCCESS;
<span class="lineNum">    2056 </span>            :   shapeObj *anno_shape, *unclipped_shape = shape;
<span class="lineNum">    2057 </span>            :   int bNeedUnclippedShape = MS_FALSE;
<span class="lineNum">    2058 </span>            :   int bNeedUnclippedAnnoShape = MS_FALSE;
<span class="lineNum">    2059 </span>            :   int bShapeNeedsClipping = MS_TRUE;
<span class="lineNum">    2060 </span>            : 
<span class="lineNum">    2061 </span><span class="lineCov">          1 :   if(shape-&gt;numlines == 0 || shape-&gt;type == MS_SHAPE_NULL) return MS_SUCCESS;</span>
<span class="lineNum">    2062 </span>            : 
<span class="lineNum">    2063 </span><span class="lineCov">          1 :   c = shape-&gt;classindex;</span>
<span class="lineNum">    2064 </span>            : 
<span class="lineNum">    2065 </span>            :   /* Before we do anything else, we will check for a rangeitem.
<span class="lineNum">    2066 </span>            :      If its there, we need to change the style's color to map
<span class="lineNum">    2067 </span>            :      the range to the shape */
<span class="lineNum">    2068 </span><span class="lineCov">          1 :   for(s=0; s&lt;layer-&gt;class[c]-&gt;numstyles; s++) {</span>
<span class="lineNum">    2069 </span><span class="lineCov">          1 :     styleObj *style = layer-&gt;class[c]-&gt;styles[s];</span>
<span class="lineNum">    2070 </span><span class="lineCov">          1 :     if(style-&gt;rangeitem !=  NULL)</span>
<span class="lineNum">    2071 </span><span class="lineNoCov">          0 :       msShapeToRange((layer-&gt;class[c]-&gt;styles[s]), shape);</span>
<span class="lineNum">    2072 </span>            :   }
<span class="lineNum">    2073 </span>            : 
<span class="lineNum">    2074 </span>            :   /* circle and point layers go through their own treatment */
<span class="lineNum">    2075 </span><span class="lineCov">          1 :   if(layer-&gt;type == MS_LAYER_CIRCLE) {</span>
<span class="lineNum">    2076 </span><span class="lineCov">          1 :     if(msBindLayerToShape(layer, shape, drawmode) != MS_SUCCESS) return MS_FAILURE;</span>
<span class="lineNum">    2077 </span><span class="lineCov">          1 :     msDrawStartShape(map, layer, image, shape);</span>
<span class="lineNum">    2078 </span><span class="lineCov">          1 :     ret = circleLayerDrawShape(map,image,layer,shape);</span>
<span class="lineNum">    2079 </span><span class="lineCov">          1 :     msDrawEndShape(map,layer,image,shape);</span>
<span class="lineNum">    2080 </span><span class="lineCov">          1 :     return ret;</span>
<span class="lineNum">    2081 </span><span class="lineCov">          1 :   } else if(layer-&gt;type == MS_LAYER_POINT || layer-&gt;type == MS_LAYER_RASTER) {</span>
<span class="lineNum">    2082 </span><span class="lineCov">          1 :     if(msBindLayerToShape(layer, shape, drawmode) != MS_SUCCESS) return MS_FAILURE;</span>
<span class="lineNum">    2083 </span><span class="lineCov">          1 :     msDrawStartShape(map, layer, image, shape);</span>
<span class="lineNum">    2084 </span><span class="lineCov">          1 :     ret = pointLayerDrawShape(map,image,layer,shape,drawmode);</span>
<span class="lineNum">    2085 </span><span class="lineCov">          1 :     msDrawEndShape(map,layer,image,shape);</span>
<span class="lineNum">    2086 </span><span class="lineCov">          1 :     return ret;</span>
<span class="lineNum">    2087 </span>            :   }
<span class="lineNum">    2088 </span>            : 
<span class="lineNum">    2089 </span><span class="lineCov">          1 :   if (layer-&gt;type == MS_LAYER_POLYGON &amp;&amp; shape-&gt;type != MS_SHAPE_POLYGON) {</span>
<span class="lineNum">    2090 </span><span class="lineNoCov">          0 :     msSetError(MS_MISCERR, &quot;Only polygon shapes can be drawn using a polygon layer definition.&quot;, &quot;polygonLayerDrawShape()&quot;);</span>
<span class="lineNum">    2091 </span><span class="lineNoCov">          0 :     return (MS_FAILURE);</span>
<span class="lineNum">    2092 </span>            :   }
<span class="lineNum">    2093 </span><span class="lineCov">          1 :   if (layer-&gt;type == MS_LAYER_LINE &amp;&amp; shape-&gt;type != MS_SHAPE_POLYGON &amp;&amp; shape-&gt;type != MS_SHAPE_LINE) {</span>
<span class="lineNum">    2094 </span><span class="lineNoCov">          0 :     msSetError(MS_MISCERR, &quot;Only polygon or line shapes can be drawn using a line layer definition.&quot;, &quot;msDrawShape()&quot;);</span>
<span class="lineNum">    2095 </span><span class="lineNoCov">          0 :     return (MS_FAILURE);</span>
<span class="lineNum">    2096 </span>            :   }
<span class="lineNum">    2097 </span>            : 
<span class="lineNum">    2098 </span><span class="lineCov">          1 :   if (layer-&gt;project &amp;&amp; layer-&gt;transform == MS_TRUE)</span>
<span class="lineNum">    2099 </span>            :   {
<span class="lineNum">    2100 </span><span class="lineCov">          1 :       if( layer-&gt;reprojectorLayerToMap == NULL )</span>
<span class="lineNum">    2101 </span>            :       {
<span class="lineNum">    2102 </span><span class="lineCov">          1 :           layer-&gt;reprojectorLayerToMap = msProjectCreateReprojector(</span>
<span class="lineNum">    2103 </span>            :               &amp;layer-&gt;projection, &amp;map-&gt;projection);
<span class="lineNum">    2104 </span><span class="lineCov">          1 :         if( layer-&gt;reprojectorLayerToMap == NULL )</span>
<span class="lineNum">    2105 </span>            :         {
<span class="lineNum">    2106 </span>            :             return MS_FAILURE;
<span class="lineNum">    2107 </span>            :         }
<span class="lineNum">    2108 </span>            :       }
<span class="lineNum">    2109 </span><span class="lineCov">          1 :       msProjectShapeEx(layer-&gt;reprojectorLayerToMap, shape);</span>
<span class="lineNum">    2110 </span>            :   }
<span class="lineNum">    2111 </span>            : 
<span class="lineNum">    2112 </span>            :   /* check if we'll need the unclipped shape */
<span class="lineNum">    2113 </span><span class="lineCov">          1 :   if (shape-&gt;type != MS_SHAPE_POINT) {</span>
<span class="lineNum">    2114 </span><span class="lineCov">          1 :     if(MS_DRAW_FEATURES(drawmode)) {</span>
<span class="lineNum">    2115 </span><span class="lineCov">          1 :       for (s = 0; s &lt; layer-&gt;class[c]-&gt;numstyles; s++) {</span>
<span class="lineNum">    2116 </span><span class="lineCov">          1 :         styleObj *style = layer-&gt;class[c]-&gt;styles[s];</span>
<span class="lineNum">    2117 </span><span class="lineCov">          1 :         if (style-&gt;_geomtransform.type != MS_GEOMTRANSFORM_NONE)</span>
<span class="lineNum">    2118 </span>            :           bNeedUnclippedShape = MS_TRUE;
<span class="lineNum">    2119 </span>            :       }
<span class="lineNum">    2120 </span>            :     }
<span class="lineNum">    2121 </span>            :     /* check if we need to clip the shape */
<span class="lineNum">    2122 </span>            :     if (shape-&gt;bounds.minx &lt; map-&gt;extent.minx ||
<span class="lineNum">    2123 </span>            :         shape-&gt;bounds.miny &lt; map-&gt;extent.miny ||
<span class="lineNum">    2124 </span>            :         shape-&gt;bounds.maxx &gt; map-&gt;extent.maxx ||
<span class="lineNum">    2125 </span>            :         shape-&gt;bounds.maxy &gt; map-&gt;extent.maxy) {
<span class="lineNum">    2126 </span>            :       bShapeNeedsClipping = MS_TRUE;
<span class="lineNum">    2127 </span>            :     }
<span class="lineNum">    2128 </span>            :    
<span class="lineNum">    2129 </span><span class="lineCov">          1 :     if(MS_DRAW_LABELS(drawmode) &amp;&amp; MS_DRAW_UNCLIPPED_LABELS(drawmode)) {</span>
<span class="lineNum">    2130 </span>            :       bNeedUnclippedAnnoShape = MS_TRUE;
<span class="lineNum">    2131 </span>            :       bNeedUnclippedShape = MS_TRUE;
<span class="lineNum">    2132 </span>            :     }
<span class="lineNum">    2133 </span>            : 
<span class="lineNum">    2134 </span><span class="lineCov">          1 :     if(MS_DRAW_UNCLIPPED_LINES(drawmode)) {</span>
<span class="lineNum">    2135 </span>            :       bShapeNeedsClipping = MS_FALSE;
<span class="lineNum">    2136 </span>            :     }
<span class="lineNum">    2137 </span>            :   } else {
<span class="lineNum">    2138 </span>            :     bShapeNeedsClipping = MS_FALSE;
<span class="lineNum">    2139 </span>            :   }
<span class="lineNum">    2140 </span>            : 
<span class="lineNum">    2141 </span><span class="lineCov">          1 :   if(layer-&gt;transform == MS_TRUE &amp;&amp; bShapeNeedsClipping) {</span>
<span class="lineNum">    2142 </span>            :     /* compute the size of the clipping buffer, in pixels. This buffer must account
<span class="lineNum">    2143 </span>            :      for the size of symbols drawn to avoid artifacts around the image edges */
<span class="lineNum">    2144 </span>            :     int clip_buf = 0;
<span class="lineNum">    2145 </span>            :     int s;
<span class="lineNum">    2146 </span>            :     rectObj cliprect;
<span class="lineNum">    2147 </span><span class="lineCov">          1 :     for (s=0;s&lt;layer-&gt;class[c]-&gt;numstyles;s++) {</span>
<span class="lineNum">    2148 </span>            :       double maxsize, maxunscaledsize;
<span class="lineNum">    2149 </span>            :       symbolObj *symbol;
<span class="lineNum">    2150 </span><span class="lineCov">          1 :       styleObj *style = layer-&gt;class[c]-&gt;styles[s];</span>
<span class="lineNum">    2151 </span><span class="lineCov">          1 :       if (!MS_IS_VALID_ARRAY_INDEX(style-&gt;symbol, map-&gt;symbolset.numsymbols)) {</span>
<span class="lineNum">    2152 </span><span class="lineNoCov">          0 :         msSetError(MS_SYMERR, &quot;Invalid symbol index: %d&quot;, &quot;msDrawShape()&quot;, style-&gt;symbol);</span>
<span class="lineNum">    2153 </span><span class="lineNoCov">          0 :         return MS_FAILURE;</span>
<span class="lineNum">    2154 </span>            :       }
<span class="lineNum">    2155 </span><span class="lineCov">          1 :       symbol = map-&gt;symbolset.symbol[style-&gt;symbol];</span>
<span class="lineNum">    2156 </span><span class="lineCov">          1 :       if (symbol-&gt;type == MS_SYMBOL_PIXMAP) {</span>
<span class="lineNum">    2157 </span><span class="lineCov">          1 :         if (MS_SUCCESS != msPreloadImageSymbol(MS_MAP_RENDERER(map), symbol))</span>
<span class="lineNum">    2158 </span>            :           return MS_FAILURE;
<span class="lineNum">    2159 </span><span class="lineCov">          1 :       } else if (symbol-&gt;type == MS_SYMBOL_SVG) {</span>
<span class="lineNum">    2160 </span>            : #if defined(USE_SVG_CAIRO) || defined(USE_RSVG)
<span class="lineNum">    2161 </span><span class="lineCov">          1 :         if (MS_SUCCESS != msPreloadSVGSymbol(symbol))</span>
<span class="lineNum">    2162 </span>            :           return MS_FAILURE;
<span class="lineNum">    2163 </span>            : #else
<span class="lineNum">    2164 </span>            :         msSetError(MS_SYMERR, &quot;SVG symbol support is not enabled.&quot;, &quot;msDrawShape()&quot;);
<span class="lineNum">    2165 </span>            :         return MS_FAILURE;
<span class="lineNum">    2166 </span>            : #endif
<span class="lineNum">    2167 </span>            :       }
<span class="lineNum">    2168 </span><span class="lineCov">          1 :       maxsize = MS_MAX(msSymbolGetDefaultSize(symbol), MS_MAX(style-&gt;size, style-&gt;width));</span>
<span class="lineNum">    2169 </span><span class="lineCov">          1 :       maxunscaledsize = MS_MAX(style-&gt;minsize*image-&gt;resolutionfactor, style-&gt;minwidth*image-&gt;resolutionfactor);</span>
<span class="lineNum">    2170 </span><span class="lineCov">          1 :       if(shape-&gt;type == MS_SHAPE_POLYGON &amp;&amp; !IS_PARALLEL_OFFSET(style-&gt;offsety)) {</span>
<span class="lineNum">    2171 </span><span class="lineCov">          1 :          maxsize += MS_MAX(fabs(style-&gt;offsety),fabs(style-&gt;offsetx));</span>
<span class="lineNum">    2172 </span>            :       }
<span class="lineNum">    2173 </span><span class="lineCov">          1 :       clip_buf = MS_MAX(clip_buf,MS_NINT(MS_MAX(maxsize * style-&gt;scalefactor, maxunscaledsize) + 1));</span>
<span class="lineNum">    2174 </span>            :     }
<span class="lineNum">    2175 </span>            : 
<span class="lineNum">    2176 </span>            : 
<span class="lineNum">    2177 </span>            :     /* if we need a copy of the unclipped shape, transform first, then clip to avoid transforming twice */
<span class="lineNum">    2178 </span><span class="lineCov">          1 :     if(bNeedUnclippedShape) {</span>
<span class="lineNum">    2179 </span><span class="lineCov">          1 :       msTransformShape(shape, map-&gt;extent, map-&gt;cellsize, image);</span>
<span class="lineNum">    2180 </span><span class="lineCov">          1 :       if(shape-&gt;numlines == 0) return MS_SUCCESS;</span>
<span class="lineNum">    2181 </span><span class="lineCov">          1 :       msComputeBounds(shape);</span>
<span class="lineNum">    2182 </span>            : 
<span class="lineNum">    2183 </span>            :       /* TODO: there's an optimization here that can be implemented:
<span class="lineNum">    2184 </span>            :          - no need to allocate unclipped_shape for each call to this function
<span class="lineNum">    2185 </span>            :          - the calls to msClipXXXRect will discard the original lineObjs, whereas
<span class="lineNum">    2186 </span>            :            we have just copied them because they where needed. These two functions
<span class="lineNum">    2187 </span>            :            could be changed so they are instructed not to free the original lineObjs. */
<span class="lineNum">    2188 </span><span class="lineCov">          1 :       unclipped_shape = (shapeObj *) msSmallMalloc(sizeof (shapeObj));</span>
<span class="lineNum">    2189 </span><span class="lineCov">          1 :       msInitShape(unclipped_shape);</span>
<span class="lineNum">    2190 </span><span class="lineCov">          1 :       msCopyShape(shape, unclipped_shape);</span>
<span class="lineNum">    2191 </span><span class="lineCov">          1 :       if(shape-&gt;type == MS_SHAPE_POLYGON) {</span>
<span class="lineNum">    2192 </span>            :          /* #179: additional buffer for polygons */
<span class="lineNum">    2193 </span><span class="lineCov">          1 :          clip_buf += 2;</span>
<span class="lineNum">    2194 </span>            :       }
<span class="lineNum">    2195 </span>            : 
<span class="lineNum">    2196 </span><span class="lineCov">          1 :       cliprect.minx = cliprect.miny = -clip_buf;</span>
<span class="lineNum">    2197 </span><span class="lineCov">          1 :       cliprect.maxx = image-&gt;width + clip_buf;</span>
<span class="lineNum">    2198 </span><span class="lineCov">          1 :       cliprect.maxy = image-&gt;height + clip_buf;</span>
<span class="lineNum">    2199 </span><span class="lineCov">          1 :       if(shape-&gt;type == MS_SHAPE_POLYGON) {</span>
<span class="lineNum">    2200 </span><span class="lineCov">          1 :         msClipPolygonRect(shape, cliprect);</span>
<span class="lineNum">    2201 </span>            :       } else {
<span class="lineNum">    2202 </span>            :         assert(shape-&gt;type == MS_SHAPE_LINE);
<span class="lineNum">    2203 </span><span class="lineCov">          1 :         msClipPolylineRect(shape, cliprect);</span>
<span class="lineNum">    2204 </span>            :       }
<span class="lineNum">    2205 </span><span class="lineCov">          1 :       if(bNeedUnclippedAnnoShape) {</span>
<span class="lineNum">    2206 </span>            :         anno_shape = unclipped_shape;
<span class="lineNum">    2207 </span>            :       } else {
<span class="lineNum">    2208 </span>            :         anno_shape = shape;
<span class="lineNum">    2209 </span>            :       }
<span class="lineNum">    2210 </span>            :     } else {
<span class="lineNum">    2211 </span>            :       /* clip first, then transform. This means we are clipping in geographical space */
<span class="lineNum">    2212 </span>            :       double clip_buf_d;
<span class="lineNum">    2213 </span><span class="lineCov">          1 :       if(shape-&gt;type == MS_SHAPE_POLYGON) {</span>
<span class="lineNum">    2214 </span>            :          /*
<span class="lineNum">    2215 </span>            :           * add a small buffer around the cliping rectangle to
<span class="lineNum">    2216 </span>            :           * avoid lines around the edges : #179
<span class="lineNum">    2217 </span>            :           */
<span class="lineNum">    2218 </span><span class="lineCov">          1 :          clip_buf += 2;</span>
<span class="lineNum">    2219 </span>            :       }
<span class="lineNum">    2220 </span><span class="lineCov">          1 :       clip_buf_d = clip_buf * map-&gt;cellsize;</span>
<span class="lineNum">    2221 </span><span class="lineCov">          1 :       cliprect.minx = map-&gt;extent.minx - clip_buf_d;</span>
<span class="lineNum">    2222 </span><span class="lineCov">          1 :       cliprect.miny = map-&gt;extent.miny - clip_buf_d;</span>
<span class="lineNum">    2223 </span><span class="lineCov">          1 :       cliprect.maxx = map-&gt;extent.maxx + clip_buf_d;</span>
<span class="lineNum">    2224 </span><span class="lineCov">          1 :       cliprect.maxy = map-&gt;extent.maxy + clip_buf_d;</span>
<span class="lineNum">    2225 </span><span class="lineCov">          1 :       if(shape-&gt;type == MS_SHAPE_POLYGON) {</span>
<span class="lineNum">    2226 </span><span class="lineCov">          1 :         msClipPolygonRect(shape, cliprect);</span>
<span class="lineNum">    2227 </span>            :       } else {
<span class="lineNum">    2228 </span>            :         assert(shape-&gt;type == MS_SHAPE_LINE);
<span class="lineNum">    2229 </span><span class="lineCov">          1 :         msClipPolylineRect(shape, cliprect);</span>
<span class="lineNum">    2230 </span>            :       }
<span class="lineNum">    2231 </span><span class="lineCov">          1 :       msTransformShape(shape, map-&gt;extent, map-&gt;cellsize, image);</span>
<span class="lineNum">    2232 </span><span class="lineCov">          1 :       msComputeBounds(shape);</span>
<span class="lineNum">    2233 </span>            :       anno_shape = shape;
<span class="lineNum">    2234 </span>            :     }
<span class="lineNum">    2235 </span>            : 
<span class="lineNum">    2236 </span>            :   } else {
<span class="lineNum">    2237 </span>            :     /* the shape is fully in the map extent,
<span class="lineNum">    2238 </span>            :      * or is a point type layer where out of bounds points are treated differently*/
<span class="lineNum">    2239 </span><span class="lineCov">          1 :     if (layer-&gt;transform == MS_TRUE) {</span>
<span class="lineNum">    2240 </span><span class="lineCov">          1 :       msTransformShape(shape, map-&gt;extent, map-&gt;cellsize, image);</span>
<span class="lineNum">    2241 </span><span class="lineCov">          1 :       msComputeBounds(shape);</span>
<span class="lineNum">    2242 </span>            :     } else {
<span class="lineNum">    2243 </span><span class="lineNoCov">          0 :       msOffsetShapeRelativeTo(shape, layer);</span>
<span class="lineNum">    2244 </span>            :     }
<span class="lineNum">    2245 </span>            :     anno_shape = shape;
<span class="lineNum">    2246 </span>            :   }
<span class="lineNum">    2247 </span><span class="lineCov">          1 :   if(shape-&gt;numlines == 0) {</span>
<span class="lineNum">    2248 </span>            :     ret = MS_SUCCESS; /* error message is set in msBindLayerToShape() */
<span class="lineNum">    2249 </span>            :     goto draw_shape_cleanup;
<span class="lineNum">    2250 </span>            :   }
<span class="lineNum">    2251 </span>            : 
<span class="lineNum">    2252 </span><span class="lineCov">          1 :   if(msBindLayerToShape(layer, shape, drawmode) != MS_SUCCESS) {</span>
<span class="lineNum">    2253 </span>            :     ret = MS_FAILURE; /* error message is set in msBindLayerToShape() */
<span class="lineNum">    2254 </span>            :     goto draw_shape_cleanup;
<span class="lineNum">    2255 </span>            :   }
<span class="lineNum">    2256 </span>            : 
<span class="lineNum">    2257 </span><span class="lineCov">          1 :   switch(layer-&gt;type) {</span>
<span class="lineNum">    2258 </span><span class="lineCov">          1 :     case MS_LAYER_LINE:</span>
<span class="lineNum">    2259 </span><span class="lineCov">          1 :       msDrawStartShape(map, layer, image, shape);</span>
<span class="lineNum">    2260 </span><span class="lineCov">          1 :       ret = lineLayerDrawShape(map, image, layer, shape, anno_shape, unclipped_shape, style, drawmode);</span>
<span class="lineNum">    2261 </span><span class="lineCov">          1 :       break;</span>
<span class="lineNum">    2262 </span><span class="lineCov">          1 :     case MS_LAYER_POLYGON:</span>
<span class="lineNum">    2263 </span><span class="lineCov">          1 :       msDrawStartShape(map, layer, image, shape);</span>
<span class="lineNum">    2264 </span><span class="lineCov">          1 :       ret = polygonLayerDrawShape(map, image, layer, shape, anno_shape, unclipped_shape, drawmode);</span>
<span class="lineNum">    2265 </span><span class="lineCov">          1 :       break;</span>
<span class="lineNum">    2266 </span><span class="lineNoCov">          0 :     case MS_LAYER_POINT:</span>
<span class="lineNum">    2267 </span>            :     case MS_LAYER_RASTER:
<span class="lineNum">    2268 </span>            :       assert(0); //bug !
<span class="lineNum">    2269 </span>            :     default:
<span class="lineNum">    2270 </span><span class="lineNoCov">          0 :       msSetError(MS_MISCERR, &quot;Unknown layer type.&quot;, &quot;msDrawShape()&quot;);</span>
<span class="lineNum">    2271 </span>            :       ret = MS_FAILURE;
<span class="lineNum">    2272 </span>            :   }
<span class="lineNum">    2273 </span>            : 
<span class="lineNum">    2274 </span><span class="lineCov">          1 : draw_shape_cleanup:</span>
<span class="lineNum">    2275 </span><span class="lineCov">          1 :   msDrawEndShape(map,layer,image,shape);</span>
<span class="lineNum">    2276 </span><span class="lineCov">          1 :   if(unclipped_shape != shape) {</span>
<span class="lineNum">    2277 </span><span class="lineCov">          1 :     msFreeShape(unclipped_shape);</span>
<span class="lineNum">    2278 </span><span class="lineCov">          1 :     msFree(unclipped_shape);</span>
<span class="lineNum">    2279 </span>            :   }
<span class="lineNum">    2280 </span>            :   return ret;
<span class="lineNum">    2281 </span>            : }
<span class="lineNum">    2282 </span>            : 
<span class="lineNum">    2283 </span>            : /*
<span class="lineNum">    2284 </span>            : ** Function to render an individual point, used as a helper function for mapscript only. Since a point
<a name="2285"><span class="lineNum">    2285 </span>            : ** can't carry attributes you can't do attribute based font size or angle.</a>
<span class="lineNum">    2286 </span>            : */
<span class="lineNum">    2287 </span><span class="lineCov">          1 : int msDrawPoint(mapObj *map, layerObj *layer, pointObj *point, imageObj *image, int classindex, char *labeltext)</span>
<span class="lineNum">    2288 </span>            : {
<span class="lineNum">    2289 </span>            :   int s,ret;
<span class="lineNum">    2290 </span>            :   classObj *theclass=NULL;
<span class="lineNum">    2291 </span>            :   labelObj *label=NULL;
<span class="lineNum">    2292 </span>            : 
<span class="lineNum">    2293 </span><span class="lineCov">          1 :   if(layer-&gt;transform == MS_TRUE &amp;&amp; layer-&gt;project &amp;&amp; msProjectionsDiffer(&amp;(layer-&gt;projection), &amp;(map-&gt;projection))) {</span>
<span class="lineNum">    2294 </span><span class="lineNoCov">          0 :     msProjectPoint(&amp;(layer-&gt;projection), &amp;(map-&gt;projection), point);</span>
<span class="lineNum">    2295 </span>            :   }
<span class="lineNum">    2296 </span>            :   
<span class="lineNum">    2297 </span><span class="lineCov">          1 :   if(classindex &gt; layer-&gt;numclasses) {</span>
<span class="lineNum">    2298 </span><span class="lineNoCov">          0 :     msSetError(MS_MISCERR, &quot;Invalid classindex (%d)&quot;, &quot;msDrawPoint()&quot;, classindex);</span>
<span class="lineNum">    2299 </span><span class="lineNoCov">          0 :     return MS_FAILURE; </span>
<span class="lineNum">    2300 </span>            :   }
<span class="lineNum">    2301 </span><span class="lineCov">          1 :   theclass = layer-&gt;class[classindex];</span>
<span class="lineNum">    2302 </span>            :   
<span class="lineNum">    2303 </span><span class="lineCov">          1 :   if(labeltext &amp;&amp; theclass-&gt;numlabels &gt; 0) {</span>
<span class="lineNum">    2304 </span><span class="lineCov">          1 :     label = theclass-&gt;labels[0];</span>
<span class="lineNum">    2305 </span>            :   }
<span class="lineNum">    2306 </span>            :   
<span class="lineNum">    2307 </span><span class="lineCov">          1 :   switch(layer-&gt;type) {</span>
<span class="lineNum">    2308 </span><span class="lineCov">          1 :     case MS_LAYER_POINT:</span>
<span class="lineNum">    2309 </span><span class="lineCov">          1 :       if(layer-&gt;transform == MS_TRUE) {</span>
<span class="lineNum">    2310 </span><span class="lineCov">          1 :         if(!msPointInRect(point, &amp;map-&gt;extent)) return(0);</span>
<span class="lineNum">    2311 </span><span class="lineCov">          1 :         point-&gt;x = MS_MAP2IMAGE_X(point-&gt;x, map-&gt;extent.minx, map-&gt;cellsize);</span>
<span class="lineNum">    2312 </span><span class="lineCov">          1 :         point-&gt;y = MS_MAP2IMAGE_Y(point-&gt;y, map-&gt;extent.maxy, map-&gt;cellsize);</span>
<span class="lineNum">    2313 </span>            :       } else
<span class="lineNum">    2314 </span><span class="lineNoCov">          0 :         msOffsetPointRelativeTo(point, layer);</span>
<span class="lineNum">    2315 </span>            : 
<span class="lineNum">    2316 </span><span class="lineCov">          1 :       for(s=0; s&lt;theclass-&gt;numstyles; s++) {</span>
<span class="lineNum">    2317 </span><span class="lineCov">          1 :         if(msScaleInBounds(map-&gt;scaledenom, theclass-&gt;styles[s]-&gt;minscaledenom, theclass-&gt;styles[s]-&gt;maxscaledenom))</span>
<span class="lineNum">    2318 </span><span class="lineCov">          1 :           if(UNLIKELY(MS_FAILURE == msDrawMarkerSymbol(map, image, point, theclass-&gt;styles[s], theclass-&gt;styles[s]-&gt;scalefactor))) {</span>
<span class="lineNum">    2319 </span>            :             return MS_FAILURE;
<span class="lineNum">    2320 </span>            :           }
<span class="lineNum">    2321 </span>            :       }
<span class="lineNum">    2322 </span><span class="lineCov">          1 :       if(label &amp;&amp; labeltext &amp;&amp; *labeltext) {</span>
<span class="lineNum">    2323 </span><span class="lineCov">          1 :         textSymbolObj *ts = msSmallMalloc(sizeof(textSymbolObj));</span>
<span class="lineNum">    2324 </span><span class="lineCov">          1 :         initTextSymbol(ts);</span>
<span class="lineNum">    2325 </span><span class="lineCov">          1 :         msPopulateTextSymbolForLabelAndString(ts, label, msStrdup(labeltext), label-&gt;scalefactor, image-&gt;resolutionfactor, layer-&gt;labelcache);</span>
<span class="lineNum">    2326 </span><span class="lineCov">          1 :         if(layer-&gt;labelcache) {</span>
<span class="lineNum">    2327 </span><span class="lineCov">          1 :           if(msAddLabel(map, image, label, layer-&gt;index, classindex, NULL, point, -1, ts) != MS_SUCCESS) {</span>
<span class="lineNum">    2328 </span>            :             return(MS_FAILURE);
<span class="lineNum">    2329 </span>            :           }
<span class="lineNum">    2330 </span>            :         } else {
<span class="lineNum">    2331 </span><span class="lineNoCov">          0 :           if(UNLIKELY(MS_FAILURE == msComputeTextPath(map,ts))) {</span>
<span class="lineNum">    2332 </span><span class="lineNoCov">          0 :             freeTextSymbol(ts);</span>
<span class="lineNum">    2333 </span><span class="lineNoCov">          0 :             free(ts);</span>
<span class="lineNum">    2334 </span><span class="lineNoCov">          0 :             return MS_FAILURE;</span>
<span class="lineNum">    2335 </span>            :           }
<span class="lineNum">    2336 </span><span class="lineNoCov">          0 :           ret = msDrawTextSymbol(map,image,*point,ts);</span>
<span class="lineNum">    2337 </span><span class="lineNoCov">          0 :           freeTextSymbol(ts);</span>
<span class="lineNum">    2338 </span><span class="lineNoCov">          0 :           free(ts); </span>
<span class="lineNum">    2339 </span><span class="lineNoCov">          0 :           if(UNLIKELY(ret == MS_FAILURE)) return MS_FAILURE;</span>
<span class="lineNum">    2340 </span>            :         }
<span class="lineNum">    2341 </span>            :       }
<span class="lineNum">    2342 </span>            :       break;
<span class="lineNum">    2343 </span>            :     default:
<span class="lineNum">    2344 </span>            :       break; /* don't do anything with layer of other types */
<span class="lineNum">    2345 </span>            :   }
<span class="lineNum">    2346 </span>            : 
<span class="lineNum">    2347 </span>            :   return(MS_SUCCESS); /* all done, no cleanup */
<span class="lineNum">    2348 </span>            : }
<span class="lineNum">    2349 </span>            : 
<span class="lineNum">    2350 </span>            : /*
<a name="2351"><span class="lineNum">    2351 </span>            : ** Draws a single label independently of the label cache. No collision avoidance is performed.</a>
<span class="lineNum">    2352 </span>            : */
<span class="lineNum">    2353 </span><span class="lineCov">          1 : int msDrawLabel(mapObj *map, imageObj *image, pointObj labelPnt, char *string, labelObj *label, double scalefactor)</span>
<span class="lineNum">    2354 </span>            : {
<span class="lineNum">    2355 </span>            :   shapeObj labelPoly;
<span class="lineNum">    2356 </span><span class="lineCov">          1 :   label_bounds lbounds = {0};</span>
<span class="lineNum">    2357 </span>            :   lineObj labelPolyLine;
<span class="lineNum">    2358 </span>            :   pointObj labelPolyPoints[5];
<span class="lineNum">    2359 </span><span class="lineCov">          1 :   textSymbolObj ts = {0};</span>
<span class="lineNum">    2360 </span>            :   int needLabelPoly=MS_TRUE;
<span class="lineNum">    2361 </span>            :   int needLabelPoint=MS_TRUE;
<span class="lineNum">    2362 </span>            :   int haveLabelText=MS_TRUE;
<span class="lineNum">    2363 </span>            : 
<span class="lineNum">    2364 </span><span class="lineCov">          1 :   if(!string || !*string)</span>
<span class="lineNum">    2365 </span>            :     haveLabelText = MS_FALSE;
<span class="lineNum">    2366 </span>            : 
<span class="lineNum">    2367 </span>            :   if(haveLabelText) {
<span class="lineNum">    2368 </span><span class="lineCov">          1 :     initTextSymbol(&amp;ts);</span>
<span class="lineNum">    2369 </span><span class="lineCov">          1 :     msPopulateTextSymbolForLabelAndString(&amp;ts, label, string, scalefactor, image-&gt;resolutionfactor, 0);</span>
<span class="lineNum">    2370 </span><span class="lineCov">          1 :     if(UNLIKELY(MS_FAILURE == msComputeTextPath(map,&amp;ts))) {</span>
<span class="lineNum">    2371 </span><span class="lineNoCov">          0 :       freeTextSymbol(&amp;ts);</span>
<span class="lineNum">    2372 </span><span class="lineNoCov">          0 :       return MS_FAILURE;</span>
<span class="lineNum">    2373 </span>            :     }
<span class="lineNum">    2374 </span>            :   }
<span class="lineNum">    2375 </span>            : 
<span class="lineNum">    2376 </span><span class="lineCov">          1 :   labelPoly.line = &amp;labelPolyLine; /* setup the label polygon structure */</span>
<span class="lineNum">    2377 </span><span class="lineCov">          1 :   labelPoly.numlines = 1;</span>
<span class="lineNum">    2378 </span><span class="lineCov">          1 :   lbounds.poly = &amp;labelPolyLine; /* setup the label polygon structure */</span>
<span class="lineNum">    2379 </span><span class="lineCov">          1 :   labelPoly.line-&gt;point = labelPolyPoints;</span>
<span class="lineNum">    2380 </span><span class="lineCov">          1 :   labelPoly.line-&gt;numpoints = 5;</span>
<span class="lineNum">    2381 </span>            : 
<span class="lineNum">    2382 </span><span class="lineCov">          1 :   if(label-&gt;position != MS_XY) {</span>
<span class="lineNum">    2383 </span><span class="lineCov">          1 :     pointObj p = {0};</span>
<span class="lineNum">    2384 </span>            : 
<span class="lineNum">    2385 </span><span class="lineCov">          1 :     if(label-&gt;numstyles &gt; 0) {</span>
<span class="lineNum">    2386 </span>            :       int i;
<span class="lineNum">    2387 </span>            : 
<span class="lineNum">    2388 </span><span class="lineCov">          1 :       for(i=0; i&lt;label-&gt;numstyles; i++) {</span>
<span class="lineNum">    2389 </span><span class="lineCov">          1 :         if(label-&gt;styles[i]-&gt;_geomtransform.type == MS_GEOMTRANSFORM_LABELPOINT || label-&gt;styles[i]-&gt;_geomtransform.type == MS_GEOMTRANSFORM_NONE) {</span>
<span class="lineNum">    2390 </span><span class="lineCov">          1 :           if(UNLIKELY(MS_FAILURE == msDrawMarkerSymbol(map, image, &amp;labelPnt, label-&gt;styles[i], scalefactor))) {</span>
<span class="lineNum">    2391 </span><span class="lineNoCov">          0 :             if(haveLabelText)</span>
<span class="lineNum">    2392 </span><span class="lineNoCov">          0 :               freeTextSymbol(&amp;ts);</span>
<span class="lineNum">    2393 </span><span class="lineNoCov">          0 :             return MS_FAILURE;</span>
<span class="lineNum">    2394 </span>            :           }
<span class="lineNum">    2395 </span><span class="lineCov">          1 :         } else if(haveLabelText &amp;&amp; (label-&gt;styles[i]-&gt;_geomtransform.type == MS_GEOMTRANSFORM_LABELPOLY || label-&gt;styles[i]-&gt;_geomtransform.type == MS_GEOMTRANSFORM_LABELCENTER)) {</span>
<span class="lineNum">    2396 </span><span class="lineCov">          1 :           if(needLabelPoly) {</span>
<span class="lineNum">    2397 </span><span class="lineCov">          1 :             p = get_metrics(&amp;labelPnt, label-&gt;position, ts.textpath, label-&gt;offsetx * ts.scalefactor,</span>
<span class="lineNum">    2398 </span><span class="lineCov">          1 :                     label-&gt;offsety * ts.scalefactor, ts.rotation, 1, &amp;lbounds);</span>
<span class="lineNum">    2399 </span><span class="lineCov">          1 :             if(!lbounds.poly) {</span>
<span class="lineNum">    2400 </span>            :               /* we need the full shape to draw the label background */
<span class="lineNum">    2401 </span><span class="lineCov">          1 :               labelPolyPoints[0].x = labelPolyPoints[4].x = lbounds.bbox.minx;</span>
<span class="lineNum">    2402 </span><span class="lineCov">          1 :               labelPolyPoints[0].y = labelPolyPoints[4].y = lbounds.bbox.miny;</span>
<span class="lineNum">    2403 </span><span class="lineCov">          1 :               labelPolyPoints[1].x = lbounds.bbox.minx;</span>
<span class="lineNum">    2404 </span><span class="lineCov">          1 :               labelPolyPoints[1].y = lbounds.bbox.maxy;</span>
<span class="lineNum">    2405 </span><span class="lineCov">          1 :               labelPolyPoints[2].x = lbounds.bbox.maxx;</span>
<span class="lineNum">    2406 </span><span class="lineCov">          1 :               labelPolyPoints[2].y = lbounds.bbox.maxy;</span>
<span class="lineNum">    2407 </span><span class="lineCov">          1 :               labelPolyPoints[3].x = lbounds.bbox.maxx;</span>
<span class="lineNum">    2408 </span><span class="lineCov">          1 :               labelPolyPoints[3].y = lbounds.bbox.miny;</span>
<span class="lineNum">    2409 </span>            :             }
<span class="lineNum">    2410 </span>            :             needLabelPoint = MS_FALSE; /* don't re-compute */
<span class="lineNum">    2411 </span>            :             needLabelPoly = MS_FALSE;
<span class="lineNum">    2412 </span>            :           }
<span class="lineNum">    2413 </span><span class="lineCov">          1 :           if(label-&gt;styles[i]-&gt;_geomtransform.type == MS_GEOMTRANSFORM_LABELPOLY) {</span>
<span class="lineNum">    2414 </span><span class="lineCov">          1 :             if(UNLIKELY(MS_FAILURE == msDrawShadeSymbol(map, image, &amp;labelPoly, label-&gt;styles[i], ts.scalefactor))) {</span>
<span class="lineNum">    2415 </span><span class="lineNoCov">          0 :               freeTextSymbol(&amp;ts);</span>
<span class="lineNum">    2416 </span><span class="lineNoCov">          0 :               return MS_FAILURE;</span>
<span class="lineNum">    2417 </span>            :             }
<span class="lineNum">    2418 </span>            :           } else {
<span class="lineNum">    2419 </span>            :             pointObj labelCenter;
<span class="lineNum">    2420 </span><span class="lineNoCov">          0 :             labelCenter.x = (lbounds.bbox.maxx + lbounds.bbox.minx)/2;</span>
<span class="lineNum">    2421 </span><span class="lineNoCov">          0 :             labelCenter.y = (lbounds.bbox.maxy + lbounds.bbox.miny)/2;</span>
<span class="lineNum">    2422 </span><span class="lineNoCov">          0 :             if(UNLIKELY(MS_FAILURE == msDrawMarkerSymbol(map, image, &amp;labelCenter, label-&gt;styles[i], scalefactor))) {</span>
<span class="lineNum">    2423 </span><span class="lineNoCov">          0 :               freeTextSymbol(&amp;ts);</span>
<span class="lineNum">    2424 </span><span class="lineNoCov">          0 :               return MS_FAILURE;</span>
<span class="lineNum">    2425 </span>            :             }
<span class="lineNum">    2426 </span>            :           }
<span class="lineNum">    2427 </span>            :         } else {
<span class="lineNum">    2428 </span><span class="lineNoCov">          0 :           msSetError(MS_MISCERR,&quot;Unknown label geomtransform %s&quot;, &quot;msDrawLabel()&quot;,label-&gt;styles[i]-&gt;_geomtransform.string);</span>
<span class="lineNum">    2429 </span><span class="lineNoCov">          0 :           if(haveLabelText)</span>
<span class="lineNum">    2430 </span><span class="lineNoCov">          0 :             freeTextSymbol(&amp;ts);</span>
<span class="lineNum">    2431 </span>            :           return MS_FAILURE;
<span class="lineNum">    2432 </span>            :         }
<span class="lineNum">    2433 </span>            :       }
<span class="lineNum">    2434 </span>            :     }
<span class="lineNum">    2435 </span>            : 
<span class="lineNum">    2436 </span><span class="lineCov">          1 :     if(haveLabelText) {</span>
<span class="lineNum">    2437 </span><span class="lineCov">          1 :       if(needLabelPoint)</span>
<span class="lineNum">    2438 </span><span class="lineCov">          1 :         p = get_metrics(&amp;labelPnt, label-&gt;position, ts.textpath, label-&gt;offsetx * ts.scalefactor,</span>
<span class="lineNum">    2439 </span><span class="lineCov">          1 :                         label-&gt;offsety * ts.scalefactor, ts.rotation, 0, &amp;lbounds);</span>
<span class="lineNum">    2440 </span>            : 
<span class="lineNum">    2441 </span>            :       /* draw the label text */
<span class="lineNum">    2442 </span><span class="lineCov">          1 :       if(UNLIKELY(MS_FAILURE == msDrawTextSymbol(map,image,p,&amp;ts))) {</span>
<span class="lineNum">    2443 </span><span class="lineNoCov">          0 :         freeTextSymbol(&amp;ts);</span>
<span class="lineNum">    2444 </span><span class="lineNoCov">          0 :         return MS_FAILURE;</span>
<span class="lineNum">    2445 </span>            :       }
<span class="lineNum">    2446 </span>            :     }
<span class="lineNum">    2447 </span>            :   } else {
<span class="lineNum">    2448 </span><span class="lineNoCov">          0 :     labelPnt.x += label-&gt;offsetx * ts.scalefactor;</span>
<span class="lineNum">    2449 </span><span class="lineNoCov">          0 :     labelPnt.y += label-&gt;offsety * ts.scalefactor;</span>
<span class="lineNum">    2450 </span>            : 
<span class="lineNum">    2451 </span><span class="lineNoCov">          0 :     if(label-&gt;numstyles &gt; 0) {</span>
<span class="lineNum">    2452 </span>            :       int i;
<span class="lineNum">    2453 </span>            : 
<span class="lineNum">    2454 </span><span class="lineNoCov">          0 :       for(i=0; i&lt;label-&gt;numstyles; i++) {</span>
<span class="lineNum">    2455 </span><span class="lineNoCov">          0 :         if(label-&gt;styles[i]-&gt;_geomtransform.type == MS_GEOMTRANSFORM_LABELPOINT ||</span>
<span class="lineNum">    2456 </span>            :            label-&gt;styles[i]-&gt;_geomtransform.type == MS_GEOMTRANSFORM_NONE) {
<span class="lineNum">    2457 </span><span class="lineNoCov">          0 :           if(UNLIKELY(MS_FAILURE == msDrawMarkerSymbol(map, image, &amp;labelPnt, label-&gt;styles[i], scalefactor))) {</span>
<span class="lineNum">    2458 </span><span class="lineNoCov">          0 :             freeTextSymbol(&amp;ts);</span>
<span class="lineNum">    2459 </span><span class="lineNoCov">          0 :             return MS_FAILURE;</span>
<span class="lineNum">    2460 </span>            :           }
<span class="lineNum">    2461 </span><span class="lineNoCov">          0 :         } else if(haveLabelText &amp;&amp; (label-&gt;styles[i]-&gt;_geomtransform.type == MS_GEOMTRANSFORM_LABELPOLY || label-&gt;styles[i]-&gt;_geomtransform.type == MS_GEOMTRANSFORM_LABELCENTER)) {</span>
<span class="lineNum">    2462 </span><span class="lineNoCov">          0 :           if(needLabelPoly) {</span>
<span class="lineNum">    2463 </span><span class="lineNoCov">          0 :             get_metrics(&amp;labelPnt, label-&gt;position, ts.textpath, label-&gt;offsetx * ts.scalefactor,</span>
<span class="lineNum">    2464 </span><span class="lineNoCov">          0 :                     label-&gt;offsety * ts.scalefactor, ts.rotation, 1, &amp;lbounds);</span>
<span class="lineNum">    2465 </span>            :             needLabelPoly = MS_FALSE; /* don't re-compute */
<span class="lineNum">    2466 </span><span class="lineNoCov">          0 :             if(!lbounds.poly) {</span>
<span class="lineNum">    2467 </span>            :               /* we need the full shape to draw the label background */
<span class="lineNum">    2468 </span><span class="lineNoCov">          0 :               labelPolyPoints[0].x = labelPolyPoints[4].x = lbounds.bbox.minx;</span>
<span class="lineNum">    2469 </span><span class="lineNoCov">          0 :               labelPolyPoints[0].y = labelPolyPoints[4].y = lbounds.bbox.miny;</span>
<span class="lineNum">    2470 </span><span class="lineNoCov">          0 :               labelPolyPoints[1].x = lbounds.bbox.minx;</span>
<span class="lineNum">    2471 </span><span class="lineNoCov">          0 :               labelPolyPoints[1].y = lbounds.bbox.maxy;</span>
<span class="lineNum">    2472 </span><span class="lineNoCov">          0 :               labelPolyPoints[2].x = lbounds.bbox.maxx;</span>
<span class="lineNum">    2473 </span><span class="lineNoCov">          0 :               labelPolyPoints[2].y = lbounds.bbox.maxy;</span>
<span class="lineNum">    2474 </span><span class="lineNoCov">          0 :               labelPolyPoints[3].x = lbounds.bbox.maxx;</span>
<span class="lineNum">    2475 </span><span class="lineNoCov">          0 :               labelPolyPoints[3].y = lbounds.bbox.miny;</span>
<span class="lineNum">    2476 </span>            :             }
<span class="lineNum">    2477 </span>            :           }
<span class="lineNum">    2478 </span><span class="lineNoCov">          0 :           if(label-&gt;styles[i]-&gt;_geomtransform.type == MS_GEOMTRANSFORM_LABELPOLY) {</span>
<span class="lineNum">    2479 </span><span class="lineNoCov">          0 :             if(UNLIKELY(MS_FAILURE == msDrawShadeSymbol(map, image, &amp;labelPoly, label-&gt;styles[i], scalefactor))) {</span>
<span class="lineNum">    2480 </span><span class="lineNoCov">          0 :               freeTextSymbol(&amp;ts);</span>
<span class="lineNum">    2481 </span><span class="lineNoCov">          0 :               return MS_FAILURE;</span>
<span class="lineNum">    2482 </span>            :             }
<span class="lineNum">    2483 </span>            :           } else {
<span class="lineNum">    2484 </span>            :       pointObj labelCenter;
<span class="lineNum">    2485 </span><span class="lineNoCov">          0 :             labelCenter.x = (lbounds.bbox.maxx + lbounds.bbox.minx)/2;</span>
<span class="lineNum">    2486 </span><span class="lineNoCov">          0 :             labelCenter.y = (lbounds.bbox.maxy + lbounds.bbox.miny)/2;</span>
<span class="lineNum">    2487 </span><span class="lineNoCov">          0 :             if(UNLIKELY(MS_FAILURE == msDrawMarkerSymbol(map, image, &amp;labelCenter, label-&gt;styles[i], scalefactor))) {</span>
<span class="lineNum">    2488 </span><span class="lineNoCov">          0 :               freeTextSymbol(&amp;ts);</span>
<span class="lineNum">    2489 </span><span class="lineNoCov">          0 :               return MS_FAILURE;</span>
<span class="lineNum">    2490 </span>            :             }
<span class="lineNum">    2491 </span>            :           }
<span class="lineNum">    2492 </span>            :         } else {
<span class="lineNum">    2493 </span><span class="lineNoCov">          0 :           msSetError(MS_MISCERR,&quot;Unknown label geomtransform %s&quot;, &quot;msDrawLabel()&quot;,label-&gt;styles[i]-&gt;_geomtransform.string);</span>
<span class="lineNum">    2494 </span><span class="lineNoCov">          0 :           if(haveLabelText)</span>
<span class="lineNum">    2495 </span><span class="lineNoCov">          0 :             freeTextSymbol(&amp;ts);</span>
<span class="lineNum">    2496 </span>            :           return MS_FAILURE;
<span class="lineNum">    2497 </span>            :         }
<span class="lineNum">    2498 </span>            :       }
<span class="lineNum">    2499 </span>            :     }
<span class="lineNum">    2500 </span>            : 
<span class="lineNum">    2501 </span><span class="lineNoCov">          0 :     if(haveLabelText) {</span>
<span class="lineNum">    2502 </span>            :       /* draw the label text */
<span class="lineNum">    2503 </span><span class="lineNoCov">          0 :       if(UNLIKELY(MS_FAILURE == msDrawTextSymbol(map,image,labelPnt,&amp;ts))) {</span>
<span class="lineNum">    2504 </span><span class="lineNoCov">          0 :         freeTextSymbol(&amp;ts);</span>
<span class="lineNum">    2505 </span><span class="lineNoCov">          0 :         return MS_FAILURE;</span>
<span class="lineNum">    2506 </span>            :       }
<span class="lineNum">    2507 </span>            :     }
<span class="lineNum">    2508 </span>            :   }
<span class="lineNum">    2509 </span><span class="lineCov">          1 :   if(haveLabelText)</span>
<span class="lineNum">    2510 </span><span class="lineCov">          1 :     freeTextSymbol(&amp;ts);</span>
<span class="lineNum">    2511 </span>            : 
<span class="lineNum">    2512 </span>            :   return MS_SUCCESS;
<span class="lineNum">    2513 </span>            : }
<span class="lineNum">    2514 </span>            : 
<span class="lineNum">    2515 </span>            : static inline void offset_bbox(const rectObj *from, rectObj *to, double ox, double oy) {
<span class="lineNum">    2516 </span><span class="lineCov">          1 :   to-&gt;minx = from-&gt;minx + ox;</span>
<span class="lineNum">    2517 </span><span class="lineCov">          1 :   to-&gt;miny = from-&gt;miny + oy;</span>
<span class="lineNum">    2518 </span><span class="lineCov">          1 :   to-&gt;maxx = from-&gt;maxx + ox;</span>
<span class="lineNum">    2519 </span><span class="lineCov">          1 :   to-&gt;maxy = from-&gt;maxy + oy;</span>
<a name="2520"><span class="lineNum">    2520 </span>            : }</a>
<span class="lineNum">    2521 </span>            : 
<span class="lineNum">    2522 </span><span class="lineCov">          1 : static inline void offset_label_bounds(const label_bounds *from, label_bounds *to, double ox, double oy) {</span>
<span class="lineNum">    2523 </span><span class="lineCov">          1 :   if(from-&gt;poly) {</span>
<span class="lineNum">    2524 </span>            :     int i;
<span class="lineNum">    2525 </span><span class="lineCov">          1 :     for(i=0; i&lt;from-&gt;poly-&gt;numpoints; i++) {</span>
<span class="lineNum">    2526 </span><span class="lineCov">          1 :       to-&gt;poly-&gt;point[i].x = from-&gt;poly-&gt;point[i].x + ox;</span>
<span class="lineNum">    2527 </span><span class="lineCov">          1 :       to-&gt;poly-&gt;point[i].y = from-&gt;poly-&gt;point[i].y + oy;</span>
<span class="lineNum">    2528 </span>            :     }
<span class="lineNum">    2529 </span><span class="lineCov">          1 :     to-&gt;poly-&gt;numpoints = from-&gt;poly-&gt;numpoints;</span>
<span class="lineNum">    2530 </span>            :   } else {
<span class="lineNum">    2531 </span><span class="lineCov">          1 :     to-&gt;poly = NULL;</span>
<span class="lineNum">    2532 </span>            :   }
<span class="lineNum">    2533 </span>            :   offset_bbox(&amp;from-&gt;bbox, &amp;to-&gt;bbox, ox, oy);
<span class="lineNum">    2534 </span><span class="lineCov">          1 : }</span>
<span class="lineNum">    2535 </span>            : 
<span class="lineNum">    2536 </span>            : /* private shortcut function to try a leader offsetted label
<a name="2537"><span class="lineNum">    2537 </span>            :  * the caller must ensure that scratch-&gt;poly-&gt;points has been sufficiently allocated</a>
<span class="lineNum">    2538 </span>            :  * to hold the points from the cachePtr's label_bounds */
<span class="lineNum">    2539 </span><span class="lineCov">          1 : void offsetAndTest(mapObj *map, labelCacheMemberObj *cachePtr, double ox, double oy,</span>
<span class="lineNum">    2540 </span>            :                    int priority, int label_idx, label_bounds *scratch)
<span class="lineNum">    2541 </span>            : {
<span class="lineNum">    2542 </span>            :   int i,j,status;
<span class="lineNum">    2543 </span>            :   pointObj leaderpt;
<span class="lineNum">    2544 </span><span class="lineCov">          1 :   lineObj *scratch_line = scratch-&gt;poly;</span>
<span class="lineNum">    2545 </span>            : 
<span class="lineNum">    2546 </span><span class="lineCov">          1 :   for(i=0; i&lt;cachePtr-&gt;numtextsymbols; i++) {</span>
<span class="lineNum">    2547 </span><span class="lineCov">          1 :     textSymbolObj *ts = cachePtr-&gt;textsymbols[i];</span>
<span class="lineNum">    2548 </span><span class="lineCov">          1 :     if(ts-&gt;textpath) {</span>
<span class="lineNum">    2549 </span><span class="lineCov">          1 :       offset_label_bounds(&amp;ts-&gt;textpath-&gt;bounds, scratch, ox, oy);</span>
<span class="lineNum">    2550 </span><span class="lineCov">          1 :       status = msTestLabelCacheCollisions(map, cachePtr, scratch, priority, label_idx);</span>
<span class="lineNum">    2551 </span><span class="lineCov">          1 :       if(!status) {</span>
<span class="lineNum">    2552 </span><span class="lineCov">          1 :         return;</span>
<span class="lineNum">    2553 </span>            :       }
<span class="lineNum">    2554 </span>            :     }
<span class="lineNum">    2555 </span><span class="lineCov">          1 :     for(j=0; j&lt;ts-&gt;label-&gt;numstyles; j++) {</span>
<span class="lineNum">    2556 </span><span class="lineCov">          1 :       if(ts-&gt;label-&gt;styles[j]-&gt;_geomtransform.type == MS_GEOMTRANSFORM_LABELPOINT) {</span>
<span class="lineNum">    2557 </span><span class="lineCov">          1 :         scratch-&gt;poly = scratch_line;</span>
<span class="lineNum">    2558 </span><span class="lineCov">          1 :         offset_label_bounds(ts-&gt;style_bounds[j], scratch, ox, oy);</span>
<span class="lineNum">    2559 </span><span class="lineCov">          1 :         status = msTestLabelCacheCollisions(map, cachePtr, scratch, priority, label_idx);</span>
<span class="lineNum">    2560 </span><span class="lineCov">          1 :         if(!status) {</span>
<span class="lineNum">    2561 </span>            :           return;
<span class="lineNum">    2562 </span>            :         }
<span class="lineNum">    2563 </span>            :       }
<span class="lineNum">    2564 </span>            :     }
<span class="lineNum">    2565 </span>            :   }
<span class="lineNum">    2566 </span>            : 
<span class="lineNum">    2567 </span><span class="lineCov">          1 :   leaderpt.x = cachePtr-&gt;point.x + ox;</span>
<span class="lineNum">    2568 </span><span class="lineCov">          1 :   leaderpt.y = cachePtr-&gt;point.y + oy;</span>
<span class="lineNum">    2569 </span>            : 
<span class="lineNum">    2570 </span><span class="lineCov">          1 :   status = msTestLabelCacheLeaderCollision(map, &amp;cachePtr-&gt;point, &amp;leaderpt);</span>
<span class="lineNum">    2571 </span><span class="lineCov">          1 :   if(!status) {</span>
<span class="lineNum">    2572 </span>            :     return;
<span class="lineNum">    2573 </span>            :   }
<span class="lineNum">    2574 </span>            : 
<span class="lineNum">    2575 </span>            : 
<span class="lineNum">    2576 </span>            :   /* the current offset is ok */
<span class="lineNum">    2577 </span><span class="lineCov">          1 :   cachePtr-&gt;leaderbbox = msSmallMalloc(sizeof(rectObj));</span>
<span class="lineNum">    2578 </span><span class="lineCov">          1 :   cachePtr-&gt;leaderline = msSmallMalloc(sizeof(lineObj));</span>
<span class="lineNum">    2579 </span><span class="lineCov">          1 :   cachePtr-&gt;leaderline-&gt;point = msSmallMalloc(2 * sizeof(pointObj));</span>
<span class="lineNum">    2580 </span><span class="lineCov">          1 :   cachePtr-&gt;leaderline-&gt;numpoints = 2;</span>
<span class="lineNum">    2581 </span><span class="lineCov">          1 :   cachePtr-&gt;leaderline-&gt;point[0] = cachePtr-&gt;point;</span>
<span class="lineNum">    2582 </span><span class="lineCov">          1 :   cachePtr-&gt;leaderline-&gt;point[1] = leaderpt;</span>
<span class="lineNum">    2583 </span><span class="lineCov">          1 :   cachePtr-&gt;leaderbbox-&gt;minx = MS_MIN(leaderpt.x,cachePtr-&gt;point.x);</span>
<span class="lineNum">    2584 </span><span class="lineCov">          1 :   cachePtr-&gt;leaderbbox-&gt;maxx = MS_MAX(leaderpt.x,cachePtr-&gt;point.x);</span>
<span class="lineNum">    2585 </span><span class="lineCov">          1 :   cachePtr-&gt;leaderbbox-&gt;miny = MS_MIN(leaderpt.y,cachePtr-&gt;point.y);</span>
<span class="lineNum">    2586 </span><span class="lineCov">          1 :   cachePtr-&gt;leaderbbox-&gt;maxy = MS_MAX(leaderpt.y,cachePtr-&gt;point.y);</span>
<span class="lineNum">    2587 </span><span class="lineCov">          1 :   cachePtr-&gt;status = MS_ON;</span>
<span class="lineNum">    2588 </span>            : 
<span class="lineNum">    2589 </span>            :   offset_bbox(&amp;cachePtr-&gt;bbox,&amp;cachePtr-&gt;bbox,ox,oy);
<span class="lineNum">    2590 </span>            : 
<span class="lineNum">    2591 </span><span class="lineCov">          1 :   for(i=0; i&lt;cachePtr-&gt;numtextsymbols; i++) {</span>
<span class="lineNum">    2592 </span><span class="lineCov">          1 :     textSymbolObj *ts = cachePtr-&gt;textsymbols[i];</span>
<span class="lineNum">    2593 </span><span class="lineCov">          1 :     if(ts-&gt;textpath) {</span>
<span class="lineNum">    2594 </span><span class="lineCov">          1 :       offset_label_bounds(&amp;ts-&gt;textpath-&gt;bounds, &amp;ts-&gt;textpath-&gt;bounds, ox, oy);</span>
<span class="lineNum">    2595 </span><span class="lineCov">          1 :       ts-&gt;annopoint.x += ox;</span>
<span class="lineNum">    2596 </span><span class="lineCov">          1 :       ts-&gt;annopoint.y += oy;</span>
<span class="lineNum">    2597 </span>            :     }
<span class="lineNum">    2598 </span><span class="lineCov">          1 :     if(ts-&gt;style_bounds) {</span>
<span class="lineNum">    2599 </span><span class="lineCov">          1 :       for(j=0; j&lt;ts-&gt;label-&gt;numstyles; j++) {</span>
<span class="lineNum">    2600 </span><span class="lineCov">          1 :         if(ts-&gt;label-&gt;styles[j]-&gt;_geomtransform.type != MS_GEOMTRANSFORM_NONE)</span>
<span class="lineNum">    2601 </span><span class="lineCov">          1 :           offset_label_bounds(ts-&gt;style_bounds[j], ts-&gt;style_bounds[j], ox, oy);</span>
<span class="lineNum">    2602 </span>            :       }
<span class="lineNum">    2603 </span>            :     }
<span class="lineNum">    2604 </span>            :   }
<a name="2605"><span class="lineNum">    2605 </span>            : }</a>
<span class="lineNum">    2606 </span>            : 
<span class="lineNum">    2607 </span><span class="lineCov">          1 : int msDrawOffsettedLabels(imageObj *image, mapObj *map, int priority)</span>
<span class="lineNum">    2608 </span>            : {
<span class="lineNum">    2609 </span>            :   int retval = MS_SUCCESS;
<span class="lineNum">    2610 </span>            :   int l;
<span class="lineNum">    2611 </span>            :   labelCacheObj *labelcache = &amp;(map-&gt;labelcache);
<span class="lineNum">    2612 </span>            :   labelCacheSlotObj *cacheslot;
<span class="lineNum">    2613 </span>            :   labelCacheMemberObj *cachePtr;
<span class="lineNum">    2614 </span>            :   label_bounds scratch;
<span class="lineNum">    2615 </span>            :   lineObj scratch_line;
<span class="lineNum">    2616 </span>            :   pointObj *scratch_points = NULL;
<span class="lineNum">    2617 </span>            :   int num_allocated_scratch_points = 0;
<span class="lineNum">    2618 </span>            :   assert(MS_RENDERER_PLUGIN(image-&gt;format));
<span class="lineNum">    2619 </span>            :   cacheslot = &amp;(labelcache-&gt;slots[priority]);
<span class="lineNum">    2620 </span><span class="lineCov">          1 :   scratch.poly = &amp;scratch_line;</span>
<span class="lineNum">    2621 </span>            : 
<span class="lineNum">    2622 </span><span class="lineCov">          1 :   for(l=cacheslot-&gt;numlabels-1; l&gt;=0; l--) {</span>
<span class="lineNum">    2623 </span><span class="lineCov">          1 :     cachePtr = &amp;(cacheslot-&gt;labels[l]); /* point to right spot in the label cache */</span>
<span class="lineNum">    2624 </span><span class="lineCov">          1 :     if(cachePtr-&gt;status == MS_OFF) {</span>
<span class="lineNum">    2625 </span>            :       /* only test regular labels that have had their bounding box computed
<span class="lineNum">    2626 </span>            :        and that haven't been rendered  */
<span class="lineNum">    2627 </span><span class="lineCov">          1 :       classObj *classPtr = (GET_CLASS(map,cachePtr-&gt;layerindex,cachePtr-&gt;classindex));</span>
<span class="lineNum">    2628 </span>            :       layerObj *layerPtr = (GET_LAYER(map,cachePtr-&gt;layerindex));
<span class="lineNum">    2629 </span>            :       int steps,i,num_scratch_points_to_allocate = 0;
<span class="lineNum">    2630 </span>            : 
<span class="lineNum">    2631 </span>            :       assert(classPtr-&gt;leader); /* cachePtrs that don't need to be tested have been marked as status on or delete */
<span class="lineNum">    2632 </span>            : 
<span class="lineNum">    2633 </span><span class="lineCov">          1 :       if(cachePtr-&gt;point.x &lt; labelcache-&gt;gutter ||</span>
<span class="lineNum">    2634 </span><span class="lineCov">          1 :           cachePtr-&gt;point.y &lt; labelcache-&gt;gutter ||</span>
<span class="lineNum">    2635 </span><span class="lineCov">          1 :           cachePtr-&gt;point.x &gt;= image-&gt;width - labelcache-&gt;gutter ||</span>
<span class="lineNum">    2636 </span><span class="lineCov">          1 :           cachePtr-&gt;point.y &gt;= image-&gt;height - labelcache-&gt;gutter) {</span>
<span class="lineNum">    2637 </span>            :         /* don't look for leaders if point is in edge buffer as the leader line would end up chopped off */
<span class="lineNum">    2638 </span><span class="lineCov">          1 :         continue;</span>
<span class="lineNum">    2639 </span>            :       }
<span class="lineNum">    2640 </span>            : 
<span class="lineNum">    2641 </span><span class="lineCov">          1 :       for(i=0; i&lt;cachePtr-&gt;numtextsymbols; i++) {</span>
<span class="lineNum">    2642 </span>            :         int j;
<span class="lineNum">    2643 </span><span class="lineCov">          1 :         textSymbolObj *ts = cachePtr-&gt;textsymbols[i];</span>
<span class="lineNum">    2644 </span><span class="lineCov">          1 :         if(ts-&gt;textpath &amp;&amp; ts-&gt;textpath-&gt;bounds.poly) {</span>
<span class="lineNum">    2645 </span><span class="lineNoCov">          0 :           num_scratch_points_to_allocate = MS_MAX(num_scratch_points_to_allocate, ts-&gt;textpath-&gt;bounds.poly-&gt;numpoints);</span>
<span class="lineNum">    2646 </span>            :         }
<span class="lineNum">    2647 </span><span class="lineCov">          1 :         if(ts-&gt;style_bounds) {</span>
<span class="lineNum">    2648 </span><span class="lineCov">          1 :           for(j=0;j&lt;ts-&gt;label-&gt;numstyles; j++) {</span>
<span class="lineNum">    2649 </span><span class="lineCov">          1 :             if(ts-&gt;label-&gt;styles[j]-&gt;_geomtransform.type == MS_GEOMTRANSFORM_LABELPOINT &amp;&amp;</span>
<span class="lineNum">    2650 </span><span class="lineCov">          1 :                 ts-&gt;style_bounds[j]-&gt;poly) {</span>
<span class="lineNum">    2651 </span><span class="lineCov">          1 :               num_scratch_points_to_allocate = MS_MAX(num_scratch_points_to_allocate, ts-&gt;style_bounds[j]-&gt;poly-&gt;numpoints);</span>
<span class="lineNum">    2652 </span>            :             }
<span class="lineNum">    2653 </span>            :           }
<span class="lineNum">    2654 </span>            :         }
<span class="lineNum">    2655 </span>            :       }
<span class="lineNum">    2656 </span><span class="lineCov">          1 :       if(num_scratch_points_to_allocate &gt; num_allocated_scratch_points) {</span>
<span class="lineNum">    2657 </span><span class="lineCov">          1 :         scratch_points = msSmallRealloc(scratch_points, num_scratch_points_to_allocate * sizeof(pointObj));</span>
<span class="lineNum">    2658 </span>            :         num_allocated_scratch_points = num_scratch_points_to_allocate;
<span class="lineNum">    2659 </span>            :       }
<span class="lineNum">    2660 </span>            : 
<span class="lineNum">    2661 </span>            : 
<span class="lineNum">    2662 </span><span class="lineCov">          1 :       steps = classPtr-&gt;leader-&gt;maxdistance / classPtr-&gt;leader-&gt;gridstep;</span>
<span class="lineNum">    2663 </span>            : 
<span class="lineNum">    2664 </span>            : #define x0 (cachePtr-&gt;point.x)
<span class="lineNum">    2665 </span>            : #define y0 (cachePtr-&gt;point.y)
<span class="lineNum">    2666 </span>            : #define gridstepsc (classPtr-&gt;leader-&gt;gridstep)
<span class="lineNum">    2667 </span>            : 
<span class="lineNum">    2668 </span>            : 
<span class="lineNum">    2669 </span>            : #define otest(ox,oy) if((x0+(ox)) &gt;= labelcache-&gt;gutter &amp;&amp;\
<span class="lineNum">    2670 </span>            :                 (y0+(oy)) &gt;= labelcache-&gt;gutter &amp;&amp;\
<span class="lineNum">    2671 </span>            :                 (x0+(ox)) &lt; image-&gt;width - labelcache-&gt;gutter &amp;&amp;\
<span class="lineNum">    2672 </span>            :                 (y0+(oy)) &lt; image-&gt;height - labelcache-&gt;gutter) {\
<span class="lineNum">    2673 </span>            :                    scratch_line.point = scratch_points;\
<span class="lineNum">    2674 </span>            :                    scratch.poly = &amp;scratch_line; \
<span class="lineNum">    2675 </span>            :                    offsetAndTest(map,cachePtr,(ox),(oy),priority,l,&amp;scratch); \
<span class="lineNum">    2676 </span>            :                    if(cachePtr-&gt;status == MS_ON) break;\
<span class="lineNum">    2677 </span>            :                 }
<span class="lineNum">    2678 </span>            : 
<span class="lineNum">    2679 </span>            :       /* loop through possible offsetted positions */
<span class="lineNum">    2680 </span><span class="lineCov">          1 :       for(i=1; i&lt;=steps; i++) {</span>
<span class="lineNum">    2681 </span>            : 
<span class="lineNum">    2682 </span>            : 
<span class="lineNum">    2683 </span>            : 
<span class="lineNum">    2684 </span>            : 
<span class="lineNum">    2685 </span>            :         /* test the intermediate points on the ring */
<span class="lineNum">    2686 </span>            : 
<span class="lineNum">    2687 </span>            :         /* (points marked &quot;0&quot; are the ones being tested)
<span class="lineNum">    2688 </span>            : 
<span class="lineNum">    2689 </span>            :            X00X00X
<span class="lineNum">    2690 </span>            :            0XXXXX0
<span class="lineNum">    2691 </span>            :            0XXXXX0
<span class="lineNum">    2692 </span>            :            XXX.XXX
<span class="lineNum">    2693 </span>            :            0XXXXX0
<span class="lineNum">    2694 </span>            :            0XXXXX0
<span class="lineNum">    2695 </span>            :            X00X00X
<span class="lineNum">    2696 </span>            :         */
<span class="lineNum">    2697 </span>            :         int j;
<span class="lineNum">    2698 </span><span class="lineCov">          1 :         for(j=1; j&lt;i-1; j++) {</span>
<span class="lineNum">    2699 </span>            :           /* test the right positions */
<span class="lineNum">    2700 </span><span class="lineCov">          1 :           otest(i*gridstepsc,j * gridstepsc);</span>
<span class="lineNum">    2701 </span><span class="lineCov">          1 :           otest(i*gridstepsc,- j * gridstepsc);</span>
<span class="lineNum">    2702 </span>            :           /* test the left positions */
<span class="lineNum">    2703 </span><span class="lineCov">          1 :           otest(- i*gridstepsc,j * gridstepsc);</span>
<span class="lineNum">    2704 </span><span class="lineCov">          1 :           otest(- i*gridstepsc,- j * gridstepsc);</span>
<span class="lineNum">    2705 </span>            :           /* test the top positions */
<span class="lineNum">    2706 </span><span class="lineCov">          1 :           otest(j*gridstepsc,- i * gridstepsc);</span>
<span class="lineNum">    2707 </span><span class="lineCov">          1 :           otest(- j *gridstepsc,- i * gridstepsc);</span>
<span class="lineNum">    2708 </span>            :           /* test the bottom positions */
<span class="lineNum">    2709 </span><span class="lineCov">          1 :           otest(j*gridstepsc,i * gridstepsc);</span>
<span class="lineNum">    2710 </span><span class="lineCov">          1 :           otest(- j *gridstepsc,i * gridstepsc);</span>
<span class="lineNum">    2711 </span>            :         }
<span class="lineNum">    2712 </span><span class="lineCov">          1 :         if(j&lt;(i-1)) break;</span>
<span class="lineNum">    2713 </span>            : 
<span class="lineNum">    2714 </span><span class="lineCov">          1 :         otest(i*gridstepsc,i*gridstepsc);</span>
<span class="lineNum">    2715 </span><span class="lineCov">          1 :         otest(-i*gridstepsc,-i*gridstepsc);</span>
<span class="lineNum">    2716 </span><span class="lineCov">          1 :         otest(i*gridstepsc,-i*gridstepsc);</span>
<span class="lineNum">    2717 </span><span class="lineCov">          1 :         otest(-i*gridstepsc,i*gridstepsc);</span>
<span class="lineNum">    2718 </span>            : 
<span class="lineNum">    2719 </span>            : 
<span class="lineNum">    2720 </span>            :         /* test the intermediate points on the ring */
<span class="lineNum">    2721 </span>            : 
<span class="lineNum">    2722 </span>            :         /* (points marked &quot;0&quot; are the ones being tested)
<span class="lineNum">    2723 </span>            : 
<span class="lineNum">    2724 </span>            :            X00X00X
<span class="lineNum">    2725 </span>            :            0XXXXX0
<span class="lineNum">    2726 </span>            :            0XXXXX0
<span class="lineNum">    2727 </span>            :            XXX.XXX
<span class="lineNum">    2728 </span>            :            0XXXXX0
<span class="lineNum">    2729 </span>            :            0XXXXX0
<span class="lineNum">    2730 </span>            :            X00X00X
<span class="lineNum">    2731 </span>            : 
<span class="lineNum">    2732 </span>            :         */
<span class="lineNum">    2733 </span>            : 
<span class="lineNum">    2734 </span>            :         /* test the extreme diagonal points */
<span class="lineNum">    2735 </span>            : 
<span class="lineNum">    2736 </span>            :         /* (points marked &quot;0&quot; are the ones being tested)
<span class="lineNum">    2737 </span>            : 
<span class="lineNum">    2738 </span>            :            0XXXXX0
<span class="lineNum">    2739 </span>            :            XXXXXXX
<span class="lineNum">    2740 </span>            :            XXXXXXX
<span class="lineNum">    2741 </span>            :            XXX.XXX
<span class="lineNum">    2742 </span>            :            XXXXXXX
<span class="lineNum">    2743 </span>            :            XXXXXXX
<span class="lineNum">    2744 </span>            :            0XXXXX0
<span class="lineNum">    2745 </span>            : 
<span class="lineNum">    2746 </span>            :            (x0+i*gridstep, y0+i*gridstep), pos lr
<span class="lineNum">    2747 </span>            :            (x0-i*gridstep, y0-i*gridstep), pos ul
<span class="lineNum">    2748 </span>            :            (x0+i*gridstep, y0-i*gridstep), pos ur
<span class="lineNum">    2749 </span>            :            (x0-i*gridstep, y0+i*gridstep), pos ll
<span class="lineNum">    2750 </span>            : 
<span class="lineNum">    2751 </span>            :         */
<span class="lineNum">    2752 </span>            : 
<span class="lineNum">    2753 </span>            :         /* test the 4 cardinal points on the ring */
<span class="lineNum">    2754 </span>            : 
<span class="lineNum">    2755 </span>            :         /* (points marked &quot;0&quot; are the ones being tested)
<span class="lineNum">    2756 </span>            : 
<span class="lineNum">    2757 </span>            :            XXX0XXX
<span class="lineNum">    2758 </span>            :            XXXXXXX
<span class="lineNum">    2759 </span>            :            XXXXXXX
<span class="lineNum">    2760 </span>            :            0XX.XX0
<span class="lineNum">    2761 </span>            :            XXXXXXX
<span class="lineNum">    2762 </span>            :            XXXXXXX
<span class="lineNum">    2763 </span>            :            XXX0XXX
<span class="lineNum">    2764 </span>            : 
<span class="lineNum">    2765 </span>            :          * (x0+i*gridtep,y0), pos cr
<span class="lineNum">    2766 </span>            : 
<span class="lineNum">    2767 </span>            :          * (x0-i*gridstep,y0), pos cl
<span class="lineNum">    2768 </span>            :          * (x0,y0-i*gridstep), pos uc
<span class="lineNum">    2769 </span>            :          * (x0,y0+i*gridstep), pos lc
<span class="lineNum">    2770 </span>            :          */
<span class="lineNum">    2771 </span><span class="lineCov">          1 :         otest(i*gridstepsc,0);</span>
<span class="lineNum">    2772 </span><span class="lineCov">          1 :         otest(-i*gridstepsc,0);</span>
<span class="lineNum">    2773 </span><span class="lineCov">          1 :         otest(0,-i*gridstepsc);</span>
<span class="lineNum">    2774 </span><span class="lineCov">          1 :         otest(0,i*gridstepsc);</span>
<span class="lineNum">    2775 </span>            :       }
<span class="lineNum">    2776 </span><span class="lineCov">          1 :       if(cachePtr-&gt;status == MS_ON) {</span>
<span class="lineNum">    2777 </span>            :         int ll;
<span class="lineNum">    2778 </span>            :         shapeObj labelLeader; /* label polygon (bounding box, possibly rotated) */
<span class="lineNum">    2779 </span><span class="lineCov">          1 :         labelLeader.line = cachePtr-&gt;leaderline; /* setup the label polygon structure */</span>
<span class="lineNum">    2780 </span><span class="lineCov">          1 :         labelLeader.numlines = 1;</span>
<span class="lineNum">    2781 </span><span class="lineCov">          1 :         insertRenderedLabelMember(map, cachePtr);</span>
<span class="lineNum">    2782 </span>            : 
<span class="lineNum">    2783 </span><span class="lineCov">          1 :         for(ll=0; ll&lt;classPtr-&gt;leader-&gt;numstyles; ll++) {</span>
<span class="lineNum">    2784 </span><span class="lineCov">          1 :           retval = msDrawLineSymbol(map, image,&amp;labelLeader , classPtr-&gt;leader-&gt;styles[ll], layerPtr-&gt;scalefactor);</span>
<span class="lineNum">    2785 </span><span class="lineCov">          1 :           if(UNLIKELY(retval == MS_FAILURE)) {</span>
<span class="lineNum">    2786 </span>            :             goto offset_cleanup;
<span class="lineNum">    2787 </span>            :           }
<span class="lineNum">    2788 </span>            :         }
<span class="lineNum">    2789 </span><span class="lineCov">          1 :         for(ll=0; ll&lt;cachePtr-&gt;numtextsymbols; ll++) {</span>
<span class="lineNum">    2790 </span><span class="lineCov">          1 :           textSymbolObj *ts = cachePtr-&gt;textsymbols[ll];</span>
<span class="lineNum">    2791 </span>            : 
<span class="lineNum">    2792 </span><span class="lineCov">          1 :           if(ts-&gt;style_bounds) {</span>
<span class="lineNum">    2793 </span>            :             /* here's where we draw the label styles */
<span class="lineNum">    2794 </span><span class="lineCov">          1 :             for(i=0; i&lt;ts-&gt;label-&gt;numstyles; i++) {</span>
<span class="lineNum">    2795 </span><span class="lineCov">          1 :               if(ts-&gt;label-&gt;styles[i]-&gt;_geomtransform.type == MS_GEOMTRANSFORM_LABELPOINT) {</span>
<span class="lineNum">    2796 </span><span class="lineCov">          1 :                 retval = msDrawMarkerSymbol(map, image, &amp;(labelLeader.line-&gt;point[1]), ts-&gt;label-&gt;styles[i], layerPtr-&gt;scalefactor);</span>
<span class="lineNum">    2797 </span><span class="lineCov">          1 :                 if(UNLIKELY(retval == MS_FAILURE)) {</span>
<span class="lineNum">    2798 </span>            :                   goto offset_cleanup;
<span class="lineNum">    2799 </span>            :                 }
<span class="lineNum">    2800 </span><span class="lineCov">          1 :               } else if(ts-&gt;label-&gt;styles[i]-&gt;_geomtransform.type == MS_GEOMTRANSFORM_LABELPOLY) {</span>
<span class="lineNum">    2801 </span><span class="lineCov">          1 :                 retval = msDrawLabelBounds(map,image,ts-&gt;style_bounds[i],ts-&gt;label-&gt;styles[i], ts-&gt;scalefactor);</span>
<span class="lineNum">    2802 </span><span class="lineCov">          1 :                 if(UNLIKELY(retval == MS_FAILURE)) {</span>
<span class="lineNum">    2803 </span>            :                   goto offset_cleanup;
<span class="lineNum">    2804 </span>            :                 }
<span class="lineNum">    2805 </span><span class="lineNoCov">          0 :         } else if(ts-&gt;label-&gt;styles[i]-&gt;_geomtransform.type == MS_GEOMTRANSFORM_LABELCENTER) {</span>
<span class="lineNum">    2806 </span>            :                 pointObj labelCenter;
<span class="lineNum">    2807 </span><span class="lineNoCov">          0 :                 labelCenter.x = (ts-&gt;style_bounds[i]-&gt;bbox.maxx + ts-&gt;style_bounds[i]-&gt;bbox.minx)/2;</span>
<span class="lineNum">    2808 </span><span class="lineNoCov">          0 :                 labelCenter.y = (ts-&gt;style_bounds[i]-&gt;bbox.maxy + ts-&gt;style_bounds[i]-&gt;bbox.miny)/2;</span>
<span class="lineNum">    2809 </span><span class="lineNoCov">          0 :                 retval = msDrawMarkerSymbol(map, image, &amp;labelCenter, ts-&gt;label-&gt;styles[i], layerPtr-&gt;scalefactor);</span>
<span class="lineNum">    2810 </span><span class="lineNoCov">          0 :                 if(UNLIKELY(retval == MS_FAILURE)) {</span>
<span class="lineNum">    2811 </span>            :                   goto offset_cleanup;
<span class="lineNum">    2812 </span>            :                 }
<span class="lineNum">    2813 </span>            :               } else {
<span class="lineNum">    2814 </span><span class="lineNoCov">          0 :                 msSetError(MS_MISCERR,&quot;Labels only support LABELPNT, LABELPOLY and LABELCENTER GEOMTRANSFORMS&quot;, &quot;msDrawOffsettedLabels()&quot;);</span>
<span class="lineNum">    2815 </span>            :                 retval = MS_FAILURE;
<span class="lineNum">    2816 </span>            :               }
<span class="lineNum">    2817 </span>            :             }
<span class="lineNum">    2818 </span>            :           }
<span class="lineNum">    2819 </span><span class="lineCov">          1 :           if(ts-&gt;annotext) {</span>
<span class="lineNum">    2820 </span><span class="lineCov">          1 :             retval = msDrawTextSymbol(map,image,ts-&gt;annopoint,ts);</span>
<span class="lineNum">    2821 </span><span class="lineCov">          1 :             if(UNLIKELY(retval == MS_FAILURE)) {</span>
<span class="lineNum">    2822 </span>            :               goto offset_cleanup;
<span class="lineNum">    2823 </span>            :             }
<span class="lineNum">    2824 </span>            :           }
<span class="lineNum">    2825 </span>            :         }
<span class="lineNum">    2826 </span>            :         /* TODO: draw cachePtr-&gt;marker, but where ? */
<span class="lineNum">    2827 </span>            : 
<span class="lineNum">    2828 </span>            :         /*
<span class="lineNum">    2829 </span>            :          styleObj tstyle;
<span class="lineNum">    2830 </span>            :          static int foo =0;
<span class="lineNum">    2831 </span>            :          if(!foo) {
<span class="lineNum">    2832 </span>            :             srand(time(NULL));
<span class="lineNum">    2833 </span>            :             foo = 1;
<span class="lineNum">    2834 </span>            :             initStyle(&amp;tstyle);
<span class="lineNum">    2835 </span>            :             tstyle.width = 1;
<span class="lineNum">    2836 </span>            :             tstyle.color.alpha = 255;
<span class="lineNum">    2837 </span>            :          }
<span class="lineNum">    2838 </span>            :          tstyle.color.red = random()%255;
<span class="lineNum">    2839 </span>            :          tstyle.color.green = random()%255;
<span class="lineNum">    2840 </span>            :          tstyle.color.blue =random()%255;
<span class="lineNum">    2841 </span>            :          msDrawLineSymbol(&amp;map-&gt;symbolset, image, cachePtr-&gt;poly, &amp;tstyle, layerPtr-&gt;scalefactor);
<span class="lineNum">    2842 </span>            :         */
<span class="lineNum">    2843 </span>            : 
<span class="lineNum">    2844 </span>            :       }
<span class="lineNum">    2845 </span>            :     }
<span class="lineNum">    2846 </span>            :   }
<span class="lineNum">    2847 </span>            : 
<span class="lineNum">    2848 </span><span class="lineCov">          1 : offset_cleanup:</span>
<span class="lineNum">    2849 </span>            : 
<span class="lineNum">    2850 </span><span class="lineCov">          1 :   free(scratch_points);</span>
<span class="lineNum">    2851 </span>            : 
<span class="lineNum">    2852 </span>            : 
<span class="lineNum">    2853 </span><span class="lineCov">          1 :   return retval;</span>
<a name="2854"><span class="lineNum">    2854 </span>            : }</a>
<span class="lineNum">    2855 </span>            : 
<span class="lineNum">    2856 </span><span class="lineCov">          1 : void fastComputeBounds(lineObj *line, rectObj *bounds)</span>
<span class="lineNum">    2857 </span>            : {
<span class="lineNum">    2858 </span>            :   int j;
<span class="lineNum">    2859 </span><span class="lineCov">          1 :   bounds-&gt;minx = bounds-&gt;maxx = line-&gt;point[0].x;</span>
<span class="lineNum">    2860 </span><span class="lineCov">          1 :   bounds-&gt;miny = bounds-&gt;maxy = line-&gt;point[0].y;</span>
<span class="lineNum">    2861 </span>            : 
<span class="lineNum">    2862 </span>            : 
<span class="lineNum">    2863 </span><span class="lineCov">          1 :   for( j=0; j&lt;line-&gt;numpoints; j++ ) {</span>
<span class="lineNum">    2864 </span><span class="lineCov">          1 :     bounds-&gt;minx = MS_MIN(bounds-&gt;minx, line-&gt;point[j].x);</span>
<span class="lineNum">    2865 </span><span class="lineCov">          1 :     bounds-&gt;maxx = MS_MAX(bounds-&gt;maxx, line-&gt;point[j].x);</span>
<span class="lineNum">    2866 </span><span class="lineCov">          1 :     bounds-&gt;miny = MS_MIN(bounds-&gt;miny, line-&gt;point[j].y);</span>
<span class="lineNum">    2867 </span><span class="lineCov">          1 :     bounds-&gt;maxy = MS_MAX(bounds-&gt;maxy, line-&gt;point[j].y);</span>
<span class="lineNum">    2868 </span>            :   }
<a name="2869"><span class="lineNum">    2869 </span><span class="lineCov">          1 : }</span></a>
<span class="lineNum">    2870 </span>            : 
<span class="lineNum">    2871 </span><span class="lineCov">          1 : int computeMarkerBounds(mapObj *map, pointObj *annopoint, textSymbolObj *ts, label_bounds *poly)</span>
<span class="lineNum">    2872 </span>            : {
<span class="lineNum">    2873 </span>            :   int i;
<span class="lineNum">    2874 </span><span class="lineCov">          1 :   for (i=0; i&lt;ts-&gt;label-&gt;numstyles; i++) {</span>
<span class="lineNum">    2875 </span><span class="lineCov">          1 :     styleObj *style = ts-&gt;label-&gt;styles[i];</span>
<span class="lineNum">    2876 </span><span class="lineCov">          1 :     if(style-&gt;_geomtransform.type == MS_GEOMTRANSFORM_LABELPOINT &amp;&amp;</span>
<span class="lineNum">    2877 </span><span class="lineCov">          1 :         style-&gt;symbol &lt; map-&gt;symbolset.numsymbols &amp;&amp; style-&gt;symbol &gt;= 0) {</span>
<span class="lineNum">    2878 </span>            :       double sx,sy;
<span class="lineNum">    2879 </span>            :       int p;
<span class="lineNum">    2880 </span>            :       double aox,aoy;
<span class="lineNum">    2881 </span><span class="lineCov">          1 :       symbolObj *symbol = map-&gt;symbolset.symbol[style-&gt;symbol];</span>
<span class="lineNum">    2882 </span><span class="lineCov">          1 :       if(msGetMarkerSize(map, style, &amp;sx, &amp;sy, ts-&gt;scalefactor) != MS_SUCCESS)</span>
<span class="lineNum">    2883 </span><span class="lineNoCov">          0 :         return MS_FALSE;</span>
<span class="lineNum">    2884 </span><span class="lineCov">          1 :       if(style-&gt;angle) {</span>
<span class="lineNum">    2885 </span><span class="lineCov">          1 :         pointObj *point = poly-&gt;poly-&gt;point;</span>
<span class="lineNum">    2886 </span><span class="lineCov">          1 :         point[0].x = sx / 2.0;</span>
<span class="lineNum">    2887 </span><span class="lineCov">          1 :         point[0].y = sy / 2.0;</span>
<span class="lineNum">    2888 </span><span class="lineCov">          1 :         point[1].x =  point[0].x;</span>
<span class="lineNum">    2889 </span><span class="lineCov">          1 :         point[1].y = -point[0].y;</span>
<span class="lineNum">    2890 </span><span class="lineCov">          1 :         point[2].x = -point[0].x;</span>
<span class="lineNum">    2891 </span><span class="lineCov">          1 :         point[2].y = -point[0].y;</span>
<span class="lineNum">    2892 </span><span class="lineCov">          1 :         point[3].x = -point[0].x;</span>
<span class="lineNum">    2893 </span><span class="lineCov">          1 :         point[3].y =  point[0].y;</span>
<span class="lineNum">    2894 </span><span class="lineCov">          1 :         point[4].x =  point[0].x;</span>
<span class="lineNum">    2895 </span><span class="lineCov">          1 :         point[4].y =  point[0].y;</span>
<span class="lineNum">    2896 </span><span class="lineCov">          1 :         if(symbol-&gt;anchorpoint_x != 0.5 || symbol-&gt;anchorpoint_y != 0.5) {</span>
<span class="lineNum">    2897 </span><span class="lineCov">          1 :           aox = (0.5 - symbol-&gt;anchorpoint_x) * sx;</span>
<span class="lineNum">    2898 </span><span class="lineCov">          1 :           aoy = (0.5 - symbol-&gt;anchorpoint_y) * sy;</span>
<span class="lineNum">    2899 </span><span class="lineCov">          1 :           for(p=0; p&lt;5; p++) {</span>
<span class="lineNum">    2900 </span><span class="lineCov">          1 :             point[p].x += aox;</span>
<span class="lineNum">    2901 </span><span class="lineCov">          1 :             point[p].y += aoy;</span>
<span class="lineNum">    2902 </span>            :           }
<span class="lineNum">    2903 </span>            :         }
<span class="lineNum">    2904 </span>            :         if(style-&gt;angle) {
<span class="lineNum">    2905 </span><span class="lineCov">          1 :           double rot = -style-&gt;angle * MS_DEG_TO_RAD;</span>
<span class="lineNum">    2906 </span><span class="lineCov">          1 :           double sina = sin(rot);</span>
<span class="lineNum">    2907 </span><span class="lineCov">          1 :           double cosa = cos(rot);</span>
<span class="lineNum">    2908 </span><span class="lineCov">          1 :           for(p=0; p&lt;5; p++) {</span>
<span class="lineNum">    2909 </span><span class="lineCov">          1 :             double tmpx = point[p].x;</span>
<span class="lineNum">    2910 </span><span class="lineCov">          1 :             point[p].x = point[p].x * cosa - point[p].y * sina;</span>
<span class="lineNum">    2911 </span><span class="lineCov">          1 :             point[p].y = tmpx * sina + point[p].y * cosa;</span>
<span class="lineNum">    2912 </span>            :           }
<span class="lineNum">    2913 </span>            :         }
<span class="lineNum">    2914 </span><span class="lineCov">          1 :         aox = annopoint-&gt;x + style-&gt;offsetx * ts-&gt;scalefactor;</span>
<span class="lineNum">    2915 </span><span class="lineCov">          1 :         aoy = annopoint-&gt;y + style-&gt;offsety * ts-&gt;scalefactor;</span>
<span class="lineNum">    2916 </span><span class="lineCov">          1 :         for(p=0; p&lt;5; p++) {</span>
<span class="lineNum">    2917 </span><span class="lineCov">          1 :           point[p].x += aox;</span>
<span class="lineNum">    2918 </span><span class="lineCov">          1 :           point[p].y += aoy;</span>
<span class="lineNum">    2919 </span>            :         }
<span class="lineNum">    2920 </span><span class="lineCov">          1 :         fastComputeBounds(poly-&gt;poly,&amp;poly-&gt;bbox);</span>
<span class="lineNum">    2921 </span>            :       } else {
<span class="lineNum">    2922 </span><span class="lineCov">          1 :         double aox = (0.5 - symbol-&gt;anchorpoint_x)*sx + annopoint-&gt;x + style-&gt;offsetx * ts-&gt;scalefactor;</span>
<span class="lineNum">    2923 </span><span class="lineCov">          1 :         double aoy = (0.5 - symbol-&gt;anchorpoint_y)*sy + annopoint-&gt;y + style-&gt;offsety * ts-&gt;scalefactor;</span>
<span class="lineNum">    2924 </span><span class="lineCov">          1 :         poly-&gt;poly = NULL;</span>
<span class="lineNum">    2925 </span><span class="lineCov">          1 :         poly-&gt;bbox.maxx = sx/2.0 + aox; </span>
<span class="lineNum">    2926 </span><span class="lineCov">          1 :         poly-&gt;bbox.minx = -sx/2.0 + aox; </span>
<span class="lineNum">    2927 </span><span class="lineCov">          1 :         poly-&gt;bbox.maxy = sy/2.0 + aoy;</span>
<span class="lineNum">    2928 </span><span class="lineCov">          1 :         poly-&gt;bbox.miny = -sy/2.0 + aoy;</span>
<span class="lineNum">    2929 </span>            :       }
<span class="lineNum">    2930 </span><span class="lineCov">          1 :       break;</span>
<span class="lineNum">    2931 </span>            :     }
<span class="lineNum">    2932 </span>            :   }
<span class="lineNum">    2933 </span><span class="lineCov">          1 :   if(i == ts-&gt;label-&gt;numstyles)</span>
<span class="lineNum">    2934 </span>            :     return MS_FALSE; /* the label has no marker styles */
<span class="lineNum">    2935 </span>            :   else
<span class="lineNum">    2936 </span><span class="lineCov">          1 :     return MS_TRUE;</span>
<span class="lineNum">    2937 </span>            : }
<span class="lineNum">    2938 </span>            : 
<span class="lineNum">    2939 </span>            : 
<span class="lineNum">    2940 </span>            : /* check that the current entry does not fall close to a label with identical text, if configured so.
<a name="2941"><span class="lineNum">    2941 </span>            :  * Currently only checks the first label/text */</a>
<span class="lineNum">    2942 </span>            : 
<span class="lineNum">    2943 </span><span class="lineCov">          1 : int msCheckLabelMinDistance(mapObj *map, labelCacheMemberObj *lc)</span>
<span class="lineNum">    2944 </span>            : {
<span class="lineNum">    2945 </span>            :   int i;
<span class="lineNum">    2946 </span>            :   textSymbolObj *s; /* shortcut */
<span class="lineNum">    2947 </span>            :   textSymbolObj *ts;
<span class="lineNum">    2948 </span>            :   rectObj buffered;
<span class="lineNum">    2949 </span><span class="lineCov">          1 :   if (lc-&gt;numtextsymbols == 0)</span>
<span class="lineNum">    2950 </span>            :     return MS_FALSE; /* no label with text */
<span class="lineNum">    2951 </span><span class="lineCov">          1 :   s = lc-&gt;textsymbols[0];</span>
<span class="lineNum">    2952 </span>            : 
<span class="lineNum">    2953 </span><span class="lineCov">          1 :   if (!s-&gt;annotext || s-&gt;label-&gt;mindistance &lt;= 0.0 || s-&gt;label-&gt;force == MS_TRUE)</span>
<span class="lineNum">    2954 </span>            :     return MS_FALSE; /*  min distance is not checked */
<span class="lineNum">    2955 </span>            : 
<span class="lineNum">    2956 </span>            :   /* we buffer the label and check for intersection instead of calculating
<span class="lineNum">    2957 </span>            :      the distance of two textpaths. we also buffer only the bbox of lc for 
<span class="lineNum">    2958 </span>            :      faster computation (it is still compared to the full textpath
<span class="lineNum">    2959 </span>            :      of the label cache members). 
<span class="lineNum">    2960 </span>            :   */
<span class="lineNum">    2961 </span><span class="lineCov">          1 :   buffered = lc-&gt;bbox;</span>
<span class="lineNum">    2962 </span><span class="lineCov">          1 :   buffered.minx -= s-&gt;label-&gt;mindistance * s-&gt;resolutionfactor;</span>
<span class="lineNum">    2963 </span><span class="lineCov">          1 :   buffered.miny -= s-&gt;label-&gt;mindistance * s-&gt;resolutionfactor;</span>
<span class="lineNum">    2964 </span><span class="lineCov">          1 :   buffered.maxx += s-&gt;label-&gt;mindistance * s-&gt;resolutionfactor;</span>
<span class="lineNum">    2965 </span><span class="lineCov">          1 :   buffered.maxy += s-&gt;label-&gt;mindistance * s-&gt;resolutionfactor;</span>
<span class="lineNum">    2966 </span>            : 
<span class="lineNum">    2967 </span><span class="lineCov">          1 :   for (i = 0; i &lt; map-&gt;labelcache.num_rendered_members; i++) {</span>
<span class="lineNum">    2968 </span><span class="lineCov">          1 :     labelCacheMemberObj *ilc = map-&gt;labelcache.rendered_text_symbols[i];</span>
<span class="lineNum">    2969 </span><span class="lineCov">          1 :     if (ilc-&gt;numtextsymbols == 0 || !ilc-&gt;textsymbols[0]-&gt;annotext)</span>
<span class="lineNum">    2970 </span><span class="lineNoCov">          0 :        continue;</span>
<span class="lineNum">    2971 </span>            : 
<span class="lineNum">    2972 </span>            :     ts = ilc-&gt;textsymbols[0];
<span class="lineNum">    2973 </span><span class="lineCov">          1 :     if (strcmp(s-&gt;annotext, ts-&gt;annotext) != 0) {</span>
<span class="lineNum">    2974 </span>            :       /* only check min distance against same label */
<span class="lineNum">    2975 </span><span class="lineCov">          1 :       continue;</span>
<span class="lineNum">    2976 </span>            :     }
<span class="lineNum">    2977 </span>            : 
<span class="lineNum">    2978 </span><span class="lineCov">          1 :     if (msPointInRect(&amp;ilc-&gt;point, &amp;buffered) == MS_TRUE) {</span>
<span class="lineNum">    2979 </span>            :       return MS_TRUE;
<span class="lineNum">    2980 </span>            :     }
<span class="lineNum">    2981 </span>            : 
<span class="lineNum">    2982 </span><span class="lineCov">          1 :     if(ts-&gt;textpath &amp;&amp; ts-&gt;textpath-&gt;absolute) {</span>
<span class="lineNum">    2983 </span><span class="lineCov">          1 :       if (intersectLabelPolygons(ts-&gt;textpath-&gt;bounds.poly, &amp;ilc-&gt;bbox, NULL, &amp;buffered) == MS_TRUE) {</span>
<span class="lineNum">    2984 </span>            :         return MS_TRUE;
<span class="lineNum">    2985 </span>            :       }
<span class="lineNum">    2986 </span><span class="lineCov">          1 :       continue;</span>
<span class="lineNum">    2987 </span>            :     }
<span class="lineNum">    2988 </span>            : 
<span class="lineNum">    2989 </span>            : 
<span class="lineNum">    2990 </span><span class="lineCov">          1 :     if (intersectLabelPolygons(NULL, &amp;ilc-&gt;bbox, NULL, &amp;buffered) == MS_TRUE) {</span>
<span class="lineNum">    2991 </span>            :         return MS_TRUE;
<span class="lineNum">    2992 </span>            :     }
<span class="lineNum">    2993 </span>            : 
<span class="lineNum">    2994 </span>            :   }
<span class="lineNum">    2995 </span>            :   return MS_FALSE;
<a name="2996"><span class="lineNum">    2996 </span>            : }</a>
<span class="lineNum">    2997 </span>            : 
<span class="lineNum">    2998 </span><span class="lineCov">          1 : void copyLabelBounds(label_bounds *dst, label_bounds *src) {</span>
<span class="lineNum">    2999 </span><span class="lineCov">          1 :   *dst = *src;</span>
<span class="lineNum">    3000 </span><span class="lineCov">          1 :   if(src-&gt;poly) {</span>
<span class="lineNum">    3001 </span>            :     int i;
<span class="lineNum">    3002 </span><span class="lineCov">          1 :     dst-&gt;poly = msSmallMalloc(sizeof(lineObj));</span>
<span class="lineNum">    3003 </span><span class="lineCov">          1 :     dst-&gt;poly-&gt;numpoints = src-&gt;poly-&gt;numpoints;</span>
<span class="lineNum">    3004 </span><span class="lineCov">          1 :     dst-&gt;poly-&gt;point = msSmallMalloc(dst-&gt;poly-&gt;numpoints * sizeof(pointObj));</span>
<span class="lineNum">    3005 </span><span class="lineCov">          1 :     for(i=0; i&lt;dst-&gt;poly-&gt;numpoints; i++) {</span>
<span class="lineNum">    3006 </span><span class="lineCov">          1 :       dst-&gt;poly-&gt;point[i] = src-&gt;poly-&gt;point[i];</span>
<span class="lineNum">    3007 </span>            :     }
<span class="lineNum">    3008 </span>            :   }
<a name="3009"><span class="lineNum">    3009 </span><span class="lineCov">          1 : }</span></a>
<span class="lineNum">    3010 </span>            : 
<span class="lineNum">    3011 </span><span class="lineNoCov">          0 : static int getLabelPositionFromString(char *pszString) {</span>
<span class="lineNum">    3012 </span><span class="lineNoCov">          0 :   if (strcasecmp(pszString, &quot;UL&quot;)==0) return MS_UL;</span>
<span class="lineNum">    3013 </span><span class="lineNoCov">          0 :   else if (strcasecmp(pszString, &quot;LR&quot;)==0) return MS_LR;</span>
<span class="lineNum">    3014 </span><span class="lineNoCov">          0 :   else if (strcasecmp(pszString, &quot;UR&quot;)==0) return MS_UR;</span>
<span class="lineNum">    3015 </span><span class="lineNoCov">          0 :   else if (strcasecmp(pszString, &quot;LL&quot;)==0) return MS_LL;</span>
<span class="lineNum">    3016 </span><span class="lineNoCov">          0 :   else if (strcasecmp(pszString, &quot;CR&quot;)==0) return MS_CR;</span>
<span class="lineNum">    3017 </span><span class="lineNoCov">          0 :   else if (strcasecmp(pszString, &quot;CL&quot;)==0) return MS_CL;</span>
<span class="lineNum">    3018 </span><span class="lineNoCov">          0 :   else if (strcasecmp(pszString, &quot;UC&quot;)==0) return MS_UC;</span>
<span class="lineNum">    3019 </span><span class="lineNoCov">          0 :   else if (strcasecmp(pszString, &quot;LC&quot;)==0) return MS_LC;</span>
<span class="lineNum">    3020 </span><span class="lineNoCov">          0 :   else return MS_CC;</span>
<a name="3021"><span class="lineNum">    3021 </span>            : }</a>
<span class="lineNum">    3022 </span>            : 
<span class="lineNum">    3023 </span><span class="lineCov">          1 : int msDrawLabelCache(mapObj *map, imageObj *image)</span>
<span class="lineNum">    3024 </span>            : {
<span class="lineNum">    3025 </span>            :   int nReturnVal = MS_SUCCESS;
<span class="lineNum">    3026 </span><span class="lineCov">          1 :   struct mstimeval starttime={0}, endtime={0};</span>
<span class="lineNum">    3027 </span>            : 
<span class="lineNum">    3028 </span><span class="lineCov">          1 :   if(map-&gt;debug &gt;= MS_DEBUGLEVEL_TUNING) msGettimeofday(&amp;starttime, NULL);</span>
<span class="lineNum">    3029 </span>            : 
<span class="lineNum">    3030 </span><span class="lineCov">          1 :   if(image) {</span>
<span class="lineNum">    3031 </span><span class="lineCov">          1 :     if(MS_RENDERER_PLUGIN(image-&gt;format)) {</span>
<span class="lineNum">    3032 </span>            :       int i, l, ll, priority, its;
<span class="lineNum">    3033 </span>            : 
<span class="lineNum">    3034 </span>            :       double marker_offset_x, marker_offset_y;
<span class="lineNum">    3035 </span>            :       int label_offset_x, label_offset_y;
<span class="lineNum">    3036 </span>            :       const char *value;
<span class="lineNum">    3037 </span>            : 
<span class="lineNum">    3038 </span>            :       labelCacheMemberObj *cachePtr=NULL;
<span class="lineNum">    3039 </span>            :       layerObj *layerPtr=NULL;
<span class="lineNum">    3040 </span>            :       classObj *classPtr=NULL;
<span class="lineNum">    3041 </span>            :       textSymbolObj *textSymbolPtr=NULL;
<span class="lineNum">    3042 </span>            : 
<span class="lineNum">    3043 </span>            :       /*
<span class="lineNum">    3044 </span>            :        * some statically allocated containers for storing label bounds before
<span class="lineNum">    3045 </span>            :        * copying them into the cachePtr: we avoid allocating these structures
<span class="lineNum">    3046 </span>            :        * at runtime, except for the labels that are actually rendered.
<span class="lineNum">    3047 </span>            :        */
<span class="lineNum">    3048 </span>            :       lineObj labelpoly_line;
<span class="lineNum">    3049 </span>            :       pointObj labelpoly_points[5];
<span class="lineNum">    3050 </span><span class="lineCov">          1 :       label_bounds labelpoly_bounds = {0};</span>
<span class="lineNum">    3051 </span>            :       lineObj  label_marker_line;
<span class="lineNum">    3052 </span>            :       pointObj label_marker_points[5];
<span class="lineNum">    3053 </span>            :       label_bounds label_marker_bounds;
<span class="lineNum">    3054 </span>            :       lineObj metrics_line;
<span class="lineNum">    3055 </span>            :       pointObj metrics_points[5];
<span class="lineNum">    3056 </span>            :       label_bounds metrics_bounds;
<span class="lineNum">    3057 </span>            : 
<span class="lineNum">    3058 </span><span class="lineCov">          1 :       label_marker_line.point = label_marker_points;</span>
<span class="lineNum">    3059 </span><span class="lineCov">          1 :       label_marker_line.numpoints = 5;</span>
<span class="lineNum">    3060 </span><span class="lineCov">          1 :       metrics_line.point = metrics_points;</span>
<span class="lineNum">    3061 </span><span class="lineCov">          1 :       metrics_line.numpoints = 5;</span>
<span class="lineNum">    3062 </span><span class="lineCov">          1 :       labelpoly_line.point = labelpoly_points;</span>
<span class="lineNum">    3063 </span><span class="lineCov">          1 :       labelpoly_line.numpoints = 5;</span>
<span class="lineNum">    3064 </span>            : 
<span class="lineNum">    3065 </span>            :       /* Look for labelcache_map_edge_buffer map metadata
<span class="lineNum">    3066 </span>            :        * If set then the value defines a buffer (in pixels) along the edge of the
<span class="lineNum">    3067 </span>            :        * map image where labels can't fall
<span class="lineNum">    3068 </span>            :        */
<span class="lineNum">    3069 </span><span class="lineCov">          1 :       if((value = msLookupHashTable(&amp;(map-&gt;web.metadata), &quot;labelcache_map_edge_buffer&quot;)) != NULL) {</span>
<span class="lineNum">    3070 </span><span class="lineCov">          1 :         map-&gt;labelcache.gutter = MS_ABS(atoi(value));</span>
<span class="lineNum">    3071 </span><span class="lineCov">          1 :         if(map-&gt;debug) msDebug(&quot;msDrawLabelCache(): labelcache_map_edge_buffer = %d\n&quot;, map-&gt;labelcache.gutter);</span>
<span class="lineNum">    3072 </span>            :       }
<span class="lineNum">    3073 </span>            : 
<span class="lineNum">    3074 </span><span class="lineCov">          1 :       for(priority=MS_MAX_LABEL_PRIORITY-1; priority&gt;=0; priority--) {</span>
<span class="lineNum">    3075 </span>            :         labelCacheSlotObj *cacheslot;
<span class="lineNum">    3076 </span>            :         cacheslot = &amp;(map-&gt;labelcache.slots[priority]);
<span class="lineNum">    3077 </span>            : 
<span class="lineNum">    3078 </span><span class="lineCov">          1 :         for(l=cacheslot-&gt;numlabels-1; l&gt;=0; l--) {</span>
<span class="lineNum">    3079 </span><span class="lineCov">          1 :           cachePtr = &amp;(cacheslot-&gt;labels[l]); /* point to right spot in the label cache */</span>
<span class="lineNum">    3080 </span>            : 
<span class="lineNum">    3081 </span><span class="lineCov">          1 :           layerPtr = (GET_LAYER(map, cachePtr-&gt;layerindex)); /* set a couple of other pointers, avoids nasty references */</span>
<span class="lineNum">    3082 </span><span class="lineCov">          1 :           classPtr = (GET_CLASS(map, cachePtr-&gt;layerindex, cachePtr-&gt;classindex));</span>
<span class="lineNum">    3083 </span>            : 
<span class="lineNum">    3084 </span><span class="lineCov">          1 :           if(cachePtr-&gt;textsymbols[0]-&gt;textpath &amp;&amp; cachePtr-&gt;textsymbols[0]-&gt;textpath-&gt;absolute) {</span>
<span class="lineNum">    3085 </span>            :             /* we have an angle follow label */
<span class="lineNum">    3086 </span><span class="lineCov">          1 :             cachePtr-&gt;bbox = cachePtr-&gt;textsymbols[0]-&gt;textpath-&gt;bounds.bbox;</span>
<span class="lineNum">    3087 </span>            : 
<span class="lineNum">    3088 </span>            :             /* before going any futher, check that mindistance is respected */
<span class="lineNum">    3089 </span><span class="lineCov">          1 :             if (cachePtr-&gt;numtextsymbols &amp;&amp; cachePtr-&gt;textsymbols[0]-&gt;label-&gt;mindistance &gt; 0.0 &amp;&amp; cachePtr-&gt;textsymbols[0]-&gt;annotext) {</span>
<span class="lineNum">    3090 </span><span class="lineCov">          1 :               if (msCheckLabelMinDistance(map, cachePtr) == MS_TRUE) {</span>
<span class="lineNum">    3091 </span><span class="lineCov">          1 :                 cachePtr-&gt;status = MS_DELETE;</span>
<span class="lineNum">    3092 </span>            :                 MS_DEBUG(MS_DEBUGLEVEL_DEVDEBUG, map,
<span class="lineNum">    3093 </span>            :                           &quot;Skipping labelgroup %d \&quot;%s\&quot; in layer \&quot;%s\&quot;: too close to an identical label (mindistance)\n&quot;,
<span class="lineNum">    3094 </span>            :                           l, cachePtr-&gt;textsymbols[0]-&gt;annotext, layerPtr-&gt;name);
<span class="lineNum">    3095 </span><span class="lineCov">          1 :                 continue; /* move on to next entry, this one is too close to an already placed one */</span>
<span class="lineNum">    3096 </span>            :               }
<span class="lineNum">    3097 </span>            :             }
<span class="lineNum">    3098 </span>            : 
<span class="lineNum">    3099 </span><span class="lineCov">          1 :             if(!cachePtr-&gt;textsymbols[0]-&gt;label-&gt;force)</span>
<span class="lineNum">    3100 </span><span class="lineCov">          1 :               cachePtr-&gt;status = msTestLabelCacheCollisions(map,cachePtr,&amp;cachePtr-&gt;textsymbols[0]-&gt;textpath-&gt;bounds, priority, l);</span>
<span class="lineNum">    3101 </span>            :             else
<span class="lineNum">    3102 </span><span class="lineCov">          1 :               cachePtr-&gt;status = MS_ON;</span>
<span class="lineNum">    3103 </span><span class="lineCov">          1 :             if(cachePtr-&gt;status) {</span>
<span class="lineNum">    3104 </span>            : 
<span class="lineNum">    3105 </span>            : 
<span class="lineNum">    3106 </span><span class="lineCov">          1 :               if (UNLIKELY(MS_FAILURE == msDrawTextSymbol(map, image, cachePtr-&gt;textsymbols[0]-&gt;annopoint /*not used*/, cachePtr-&gt;textsymbols[0])))</span>
<span class="lineNum">    3107 </span>            :               {
<span class="lineNum">    3108 </span><span class="lineCov">          1 :                 return MS_FAILURE;</span>
<span class="lineNum">    3109 </span>            :               }
<span class="lineNum">    3110 </span><span class="lineCov">          1 :               insertRenderedLabelMember(map, cachePtr);</span>
<span class="lineNum">    3111 </span>            :             } else {
<span class="lineNum">    3112 </span>            :               MS_DEBUG(MS_DEBUGLEVEL_DEVDEBUG,map,
<span class="lineNum">    3113 </span>            :                   &quot;Skipping follow labelgroup %d \&quot;%s\&quot; in layer \&quot;%s\&quot;: text collided\n&quot;,
<span class="lineNum">    3114 </span>            :                   l, cachePtr-&gt;textsymbols[0]-&gt;annotext, layerPtr-&gt;name);
<span class="lineNum">    3115 </span>            :             }
<span class="lineNum">    3116 </span><span class="lineCov">          1 :             cachePtr-&gt;status = MS_DELETE; /* we're done with this label, it won't even have a second chance in the leader phase */</span>
<span class="lineNum">    3117 </span>            :           } else {
<span class="lineNum">    3118 </span>            :             marker_offset_x = marker_offset_y = 0; /* assume no marker */
<span class="lineNum">    3119 </span>            :             
<span class="lineNum">    3120 </span><span class="lineCov">          1 :             if (layerPtr-&gt;type == MS_LAYER_POINT &amp;&amp; cachePtr-&gt;markerid!=-1) { /* there is a marker already in the image that we need to account for */</span>
<span class="lineNum">    3121 </span><span class="lineCov">          1 :               markerCacheMemberObj *markerPtr = &amp;(cacheslot-&gt;markers[cachePtr-&gt;markerid]); /* point to the right spot in the marker cache*/</span>
<span class="lineNum">    3122 </span><span class="lineCov">          1 :               marker_offset_x = (markerPtr-&gt;bounds.maxx-markerPtr-&gt;bounds.minx)/2.0;</span>
<span class="lineNum">    3123 </span><span class="lineCov">          1 :               marker_offset_y = (markerPtr-&gt;bounds.maxy-markerPtr-&gt;bounds.miny)/2.0;</span>
<span class="lineNum">    3124 </span>            :             }
<span class="lineNum">    3125 </span>            : 
<span class="lineNum">    3126 </span>            : 
<span class="lineNum">    3127 </span>            :             /*
<span class="lineNum">    3128 </span>            :             ** all other cases *could* have multiple labels defined
<span class="lineNum">    3129 </span>            :             */
<span class="lineNum">    3130 </span><span class="lineCov">          1 :             cachePtr-&gt;status = MS_ON; /* assume this cache element can be placed */</span>
<span class="lineNum">    3131 </span><span class="lineCov">          1 :             for(ll=0; ll&lt;cachePtr-&gt;numtextsymbols; ll++) { /* RFC 77 TODO: Still may want to step through backwards... */</span>
<span class="lineNum">    3132 </span>            :               int label_marker_status = MS_ON, have_label_marker, metrics_status = MS_ON;
<span class="lineNum">    3133 </span>            :               int need_labelpoly = 0;
<span class="lineNum">    3134 </span>            :               
<span class="lineNum">    3135 </span>            :               /* reset the lineObj which may have been unset by a previous call to get_metrics() */
<span class="lineNum">    3136 </span><span class="lineCov">          1 :               label_marker_bounds.poly = &amp;label_marker_line;</span>
<span class="lineNum">    3137 </span><span class="lineCov">          1 :               labelpoly_bounds.poly = &amp;labelpoly_line;</span>
<span class="lineNum">    3138 </span>            : 
<span class="lineNum">    3139 </span><span class="lineCov">          1 :               textSymbolPtr = cachePtr-&gt;textsymbols[ll];</span>
<span class="lineNum">    3140 </span><span class="lineCov">          1 :               for(i=0; i&lt;textSymbolPtr-&gt;label-&gt;numstyles; i++) {</span>
<span class="lineNum">    3141 </span><span class="lineCov">          1 :                 if(textSymbolPtr-&gt;label-&gt;styles[i]-&gt;_geomtransform.type == MS_GEOMTRANSFORM_LABELPOLY || </span>
<span class="lineNum">    3142 </span>            :                    textSymbolPtr-&gt;label-&gt;styles[i]-&gt;_geomtransform.type == MS_GEOMTRANSFORM_LABELCENTER) {
<span class="lineNum">    3143 </span>            :                   need_labelpoly = 1;
<span class="lineNum">    3144 </span>            :                   break;
<span class="lineNum">    3145 </span>            :                 }
<span class="lineNum">    3146 </span>            :               }
<span class="lineNum">    3147 </span>            : 
<span class="lineNum">    3148 </span>            :               /* compute the poly of the label styles */
<span class="lineNum">    3149 </span><span class="lineCov">          1 :               if((have_label_marker = computeMarkerBounds(map,&amp;cachePtr-&gt;point,textSymbolPtr, &amp;label_marker_bounds)) == MS_TRUE) {</span>
<span class="lineNum">    3150 </span><span class="lineCov">          1 :                 if(cachePtr-&gt;numtextsymbols &gt; 1) { /* FIXME this test doesn't seem right, should probably check if we have an annotation layer with a regular style defined */</span>
<span class="lineNum">    3151 </span><span class="lineCov">          1 :                   marker_offset_x = (label_marker_bounds.bbox.maxx-label_marker_bounds.bbox.minx)/2.0;</span>
<span class="lineNum">    3152 </span><span class="lineCov">          1 :                   marker_offset_y = (label_marker_bounds.bbox.maxy-label_marker_bounds.bbox.miny)/2.0;</span>
<span class="lineNum">    3153 </span>            :                 } else {
<span class="lineNum">    3154 </span>            :                   /* we might be using an old style behavior with a markerPtr */
<span class="lineNum">    3155 </span><span class="lineCov">          1 :                   marker_offset_x = MS_MAX(marker_offset_x,(label_marker_bounds.bbox.maxx-label_marker_bounds.bbox.minx)/2.0);</span>
<span class="lineNum">    3156 </span><span class="lineCov">          1 :                   marker_offset_y = MS_MAX(marker_offset_y,(label_marker_bounds.bbox.maxy-label_marker_bounds.bbox.miny)/2.0);</span>
<span class="lineNum">    3157 </span>            :                 }
<span class="lineNum">    3158 </span>            :                 /* add marker to cachePtr-&gt;poly */
<span class="lineNum">    3159 </span><span class="lineCov">          1 :                 if(textSymbolPtr-&gt;label-&gt;force != MS_TRUE) {</span>
<span class="lineNum">    3160 </span><span class="lineCov">          1 :                   label_marker_status = msTestLabelCacheCollisions(map, cachePtr, &amp;label_marker_bounds ,priority, l);</span>
<span class="lineNum">    3161 </span>            :                 }
<span class="lineNum">    3162 </span><span class="lineCov">          1 :                 if(label_marker_status == MS_OFF &amp;&amp;</span>
<span class="lineNum">    3163 </span><span class="lineCov">          1 :                     !(textSymbolPtr-&gt;label-&gt;force==MS_ON || classPtr-&gt;leader)) {</span>
<span class="lineNum">    3164 </span><span class="lineCov">          1 :                   cachePtr-&gt;status = MS_DELETE;</span>
<span class="lineNum">    3165 </span>            :                   MS_DEBUG(MS_DEBUGLEVEL_DEVDEBUG, map,
<span class="lineNum">    3166 </span>            :                       &quot;Skipping label %d of labelgroup %d of class %d in layer \&quot;%s\&quot;: marker collided\n&quot;,
<span class="lineNum">    3167 </span>            :                       ll, l, cachePtr-&gt;classindex, layerPtr-&gt;name);
<span class="lineNum">    3168 </span><span class="lineCov">          1 :                   break; /* the marker collided, break from multi-label loop */</span>
<span class="lineNum">    3169 </span>            :                 }
<span class="lineNum">    3170 </span>            :               }
<span class="lineNum">    3171 </span>            : 
<span class="lineNum">    3172 </span><span class="lineCov">          1 :               if(textSymbolPtr-&gt;annotext) {</span>
<span class="lineNum">    3173 </span>            :                 /*
<span class="lineNum">    3174 </span>            :                  * if we don't have an offset defined, first check that the labelpoint itself does not collide
<span class="lineNum">    3175 </span>            :                  * this helps speed things up in dense labelling, as if the labelpoint collides there's
<span class="lineNum">    3176 </span>            :                  * no use in computing the labeltext bounds (i.e. going into shaping+freetype).
<span class="lineNum">    3177 </span>            :                  * We do however skip collision testing against the marker cache, as we want to allow rendering
<span class="lineNum">    3178 </span>            :                  * a label for points that overlap each other: this is done by setting priority to MAX_PRIORITY
<span class="lineNum">    3179 </span>            :                  * in the call to msTestLabelCacheCollisions (which is a hack!!)
<span class="lineNum">    3180 </span>            :                  */
<span class="lineNum">    3181 </span><span class="lineCov">          1 :                 if(!have_label_marker &amp;&amp; textSymbolPtr-&gt;label-&gt;force != MS_TRUE &amp;&amp; !classPtr-&gt;leader &amp;&amp;</span>
<span class="lineNum">    3182 </span><span class="lineCov">          1 :                     !textSymbolPtr-&gt;label-&gt;offsetx &amp;&amp; !textSymbolPtr-&gt;label-&gt;offsety) {</span>
<span class="lineNum">    3183 </span>            :                   label_bounds labelpoint_bounds;
<span class="lineNum">    3184 </span><span class="lineCov">          1 :                   labelpoint_bounds.poly = NULL;</span>
<span class="lineNum">    3185 </span><span class="lineCov">          1 :                   labelpoint_bounds.bbox.minx = cachePtr-&gt;point.x - 0.1;</span>
<span class="lineNum">    3186 </span><span class="lineCov">          1 :                   labelpoint_bounds.bbox.maxx = cachePtr-&gt;point.x + 0.1;</span>
<span class="lineNum">    3187 </span><span class="lineCov">          1 :                   labelpoint_bounds.bbox.miny = cachePtr-&gt;point.y - 0.1;</span>
<span class="lineNum">    3188 </span><span class="lineCov">          1 :                   labelpoint_bounds.bbox.maxy = cachePtr-&gt;point.y + 0.1;</span>
<span class="lineNum">    3189 </span><span class="lineCov">          1 :                   if(MS_OFF == msTestLabelCacheCollisions(map, cachePtr, &amp;labelpoint_bounds, MS_MAX_LABEL_PRIORITY, l)) {</span>
<span class="lineNum">    3190 </span><span class="lineCov">          1 :                     cachePtr-&gt;status = MS_DELETE; /* we won't check for leader offseted positions, as the anchor point colided */</span>
<span class="lineNum">    3191 </span>            :                     MS_DEBUG(MS_DEBUGLEVEL_DEVDEBUG, map,
<span class="lineNum">    3192 </span>            :                         &quot;Skipping label %d \&quot;%s\&quot; of labelgroup %d of class %d in layer \&quot;%s\&quot;: labelpoint collided\n&quot;,
<span class="lineNum">    3193 </span>            :                         ll, textSymbolPtr-&gt;annotext, l, cachePtr-&gt;classindex, layerPtr-&gt;name);
<span class="lineNum">    3194 </span><span class="lineCov">          1 :                     break;</span>
<span class="lineNum">    3195 </span>            :                   }
<span class="lineNum">    3196 </span>            :                 }
<span class="lineNum">    3197 </span>            : 
<span class="lineNum">    3198 </span>            :                 /* compute label size */
<span class="lineNum">    3199 </span><span class="lineCov">          1 :                 if(!textSymbolPtr-&gt;textpath) {</span>
<span class="lineNum">    3200 </span><span class="lineCov">          1 :                   if(UNLIKELY(MS_FAILURE == msComputeTextPath(map,textSymbolPtr))) {</span>
<span class="lineNum">    3201 </span>            :                     return MS_FAILURE;
<span class="lineNum">    3202 </span>            :                   }
<span class="lineNum">    3203 </span>            :                 }
<span class="lineNum">    3204 </span>            : 
<span class="lineNum">    3205 </span>            :                 /* if our label has an outline, adjust the marker offset so the outlinecolor does
<span class="lineNum">    3206 </span>            :                  * not bleed into the marker */
<span class="lineNum">    3207 </span><span class="lineCov">          1 :                 if(marker_offset_x &amp;&amp; MS_VALID_COLOR(textSymbolPtr-&gt;label-&gt;outlinecolor)) {</span>
<span class="lineNum">    3208 </span><span class="lineCov">          1 :                   marker_offset_x += textSymbolPtr-&gt;label-&gt;outlinewidth/2.0 * textSymbolPtr-&gt;scalefactor;</span>
<span class="lineNum">    3209 </span><span class="lineCov">          1 :                   marker_offset_y += textSymbolPtr-&gt;label-&gt;outlinewidth/2.0 * textSymbolPtr-&gt;scalefactor;</span>
<span class="lineNum">    3210 </span>            :                 }
<span class="lineNum">    3211 </span>            :                 
<span class="lineNum">    3212 </span>            :                 /* apply offset and buffer settings */
<span class="lineNum">    3213 </span><span class="lineCov">          1 :                 if(textSymbolPtr-&gt;label-&gt;anglemode != MS_FOLLOW) {</span>
<span class="lineNum">    3214 </span><span class="lineCov">          1 :                   label_offset_x = textSymbolPtr-&gt;label-&gt;offsetx * textSymbolPtr-&gt;scalefactor;</span>
<span class="lineNum">    3215 </span><span class="lineCov">          1 :                   label_offset_y = textSymbolPtr-&gt;label-&gt;offsety * textSymbolPtr-&gt; scalefactor;</span>
<span class="lineNum">    3216 </span>            :                 } else {
<span class="lineNum">    3217 </span>            :                   label_offset_x = 0;
<span class="lineNum">    3218 </span>            :                   label_offset_y = 0;
<span class="lineNum">    3219 </span>            :                 }
<span class="lineNum">    3220 </span>            : 
<span class="lineNum">    3221 </span><span class="lineCov">          1 :                 if(textSymbolPtr-&gt;label-&gt;position == MS_AUTO) {</span>
<span class="lineNum">    3222 </span>            :                   /* no point in using auto positionning if the marker cannot be placed */
<span class="lineNum">    3223 </span>            :                   int positions[MS_POSITIONS_LENGTH], npositions=0;
<span class="lineNum">    3224 </span>            :       
<span class="lineNum">    3225 </span>            :                   /*
<span class="lineNum">    3226 </span>            :                   **   (Note: might be able to re-order this for more speed.)
<span class="lineNum">    3227 </span>            :                   */
<span class="lineNum">    3228 </span><span class="lineCov">          1 :       if(msLayerGetProcessingKey(layerPtr, &quot;LABEL_POSITIONS&quot;)) {</span>
<span class="lineNum">    3229 </span><span class="lineNoCov">          0 :                     int p, ncustom_positions=0;</span>
<span class="lineNum">    3230 </span><span class="lineNoCov">          0 :                     char **custom_positions = msStringSplitComplex(msLayerGetProcessingKey(layerPtr, &quot;LABEL_POSITIONS&quot;), &quot;,&quot;, &amp;ncustom_positions, MS_STRIPLEADSPACES|MS_STRIPENDSPACES);</span>
<span class="lineNum">    3231 </span><span class="lineNoCov">          0 :                     for(p=0; p&lt;MS_MIN(9,ncustom_positions); p++)</span>
<span class="lineNum">    3232 </span><span class="lineNoCov">          0 :                       positions[p] = getLabelPositionFromString(custom_positions[p]);</span>
<span class="lineNum">    3233 </span>            :                     npositions = p;
<span class="lineNum">    3234 </span><span class="lineNoCov">          0 :                     msFree(custom_positions);</span>
<span class="lineNum">    3235 </span><span class="lineCov">          1 :       } else if(layerPtr-&gt;type == MS_LAYER_POLYGON &amp;&amp; marker_offset_x==0 ) {</span>
<span class="lineNum">    3236 </span><span class="lineNoCov">          0 :                     positions[0]=MS_CC;</span>
<span class="lineNum">    3237 </span><span class="lineNoCov">          0 :                     positions[1]=MS_UC;</span>
<span class="lineNum">    3238 </span><span class="lineNoCov">          0 :                     positions[2]=MS_LC;</span>
<span class="lineNum">    3239 </span><span class="lineNoCov">          0 :                     positions[3]=MS_CL;</span>
<span class="lineNum">    3240 </span><span class="lineNoCov">          0 :                     positions[4]=MS_CR;</span>
<span class="lineNum">    3241 </span><span class="lineNoCov">          0 :                     npositions = 5;</span>
<span class="lineNum">    3242 </span><span class="lineCov">          1 :                   } else if(layerPtr-&gt;type == MS_LAYER_LINE &amp;&amp; marker_offset_x == 0) {</span>
<span class="lineNum">    3243 </span><span class="lineCov">          1 :                     positions[0]=MS_UC;</span>
<span class="lineNum">    3244 </span><span class="lineCov">          1 :                     positions[1]=MS_LC;</span>
<span class="lineNum">    3245 </span><span class="lineCov">          1 :                     positions[2]=MS_CC;</span>
<span class="lineNum">    3246 </span><span class="lineCov">          1 :                     npositions = 3;</span>
<span class="lineNum">    3247 </span>            :                   } else {
<span class="lineNum">    3248 </span><span class="lineCov">          1 :                     positions[0]=MS_UL;</span>
<span class="lineNum">    3249 </span><span class="lineCov">          1 :                     positions[1]=MS_LR;</span>
<span class="lineNum">    3250 </span><span class="lineCov">          1 :                     positions[2]=MS_UR;</span>
<span class="lineNum">    3251 </span><span class="lineCov">          1 :                     positions[3]=MS_LL;</span>
<span class="lineNum">    3252 </span><span class="lineCov">          1 :                     positions[4]=MS_CR;</span>
<span class="lineNum">    3253 </span><span class="lineCov">          1 :                     positions[5]=MS_CL;</span>
<span class="lineNum">    3254 </span><span class="lineCov">          1 :                     positions[6]=MS_UC;</span>
<span class="lineNum">    3255 </span><span class="lineCov">          1 :                     positions[7]=MS_LC;</span>
<span class="lineNum">    3256 </span>            :                     npositions = 8;
<span class="lineNum">    3257 </span>            :                   }
<span class="lineNum">    3258 </span>            : 
<span class="lineNum">    3259 </span><span class="lineCov">          1 :                   for(i=0; i&lt;npositions; i++) {</span>
<span class="lineNum">    3260 </span>            :                     // RFC 77 TODO: take label_marker_offset_x/y into account
<span class="lineNum">    3261 </span><span class="lineCov">          1 :                     metrics_bounds.poly = &amp;metrics_line;</span>
<span class="lineNum">    3262 </span><span class="lineCov">          1 :                     textSymbolPtr-&gt;annopoint = get_metrics(&amp;(cachePtr-&gt;point), positions[i], textSymbolPtr-&gt;textpath,</span>
<span class="lineNum">    3263 </span><span class="lineCov">          1 :                                                            marker_offset_x + label_offset_x, marker_offset_y + label_offset_y,</span>
<span class="lineNum">    3264 </span><span class="lineCov">          1 :                                                            textSymbolPtr-&gt;rotation, textSymbolPtr-&gt;label-&gt;buffer * textSymbolPtr-&gt;scalefactor, &amp;metrics_bounds);</span>
<span class="lineNum">    3265 </span><span class="lineCov">          1 :                     if(textSymbolPtr-&gt;label-&gt;force == MS_OFF) {</span>
<span class="lineNum">    3266 </span><span class="lineNoCov">          0 :                       for(its=0;its&lt;ll;its++) {</span>
<span class="lineNum">    3267 </span>            :                         /* check for collisions inside the label group */
<span class="lineNum">    3268 </span><span class="lineNoCov">          0 :                         if(intersectTextSymbol(cachePtr-&gt;textsymbols[its],&amp;metrics_bounds) == MS_TRUE) {</span>
<span class="lineNum">    3269 </span>            :                           /* there was a self intersection */
<span class="lineNum">    3270 </span>            :                           break; /* next position, will break out to next position in containing loop*/
<span class="lineNum">    3271 </span>            :                         }
<span class="lineNum">    3272 </span>            :                         if(its != ll)
<span class="lineNum">    3273 </span><span class="lineNoCov">          0 :                           continue; /* goto next position, this one had an intersection with our own label group */</span>
<span class="lineNum">    3274 </span>            :                       }
<span class="lineNum">    3275 </span>            :                     }
<span class="lineNum">    3276 </span>            : 
<span class="lineNum">    3277 </span><span class="lineCov">          1 :                     metrics_status = msTestLabelCacheCollisions(map, cachePtr,&amp;metrics_bounds, priority, l);</span>
<span class="lineNum">    3278 </span>            : 
<span class="lineNum">    3279 </span>            :                     /* found a suitable place for this label */
<span class="lineNum">    3280 </span><span class="lineCov">          1 :                     if(metrics_status == MS_TRUE || (i==(npositions-1) &amp;&amp; textSymbolPtr-&gt;label-&gt;force == MS_ON)) {</span>
<span class="lineNum">    3281 </span>            :                       metrics_status = MS_TRUE; /* set to true in case we are forcing it */
<span class="lineNum">    3282 </span>            :                       /* compute anno poly for label background if needed */
<span class="lineNum">    3283 </span><span class="lineCov">          1 :                       if(need_labelpoly) get_metrics(&amp;(cachePtr-&gt;point), positions[i], textSymbolPtr-&gt;textpath,</span>
<span class="lineNum">    3284 </span>            :                                                                 marker_offset_x + label_offset_x, marker_offset_y + label_offset_y,
<span class="lineNum">    3285 </span>            :                                                                 textSymbolPtr-&gt;rotation, 1, &amp;labelpoly_bounds);
<span class="lineNum">    3286 </span>            : 
<span class="lineNum">    3287 </span>            :                       break; /* ...out of position loop */
<span class="lineNum">    3288 </span>            :                     }
<span class="lineNum">    3289 </span>            :                   } /* next position */
<span class="lineNum">    3290 </span>            : 
<span class="lineNum">    3291 </span>            :                   /* if position auto didn't manage to find a position, but we have leader configured
<span class="lineNum">    3292 </span>            :                    * for the class, then we want to compute the label poly anyway, placed as MS_CC */
<span class="lineNum">    3293 </span><span class="lineCov">          1 :                   if(classPtr-&gt;leader &amp;&amp; metrics_status == MS_FALSE) {</span>
<span class="lineNum">    3294 </span><span class="lineNoCov">          0 :                     metrics_bounds.poly = &amp;metrics_line;</span>
<span class="lineNum">    3295 </span><span class="lineNoCov">          0 :                     textSymbolPtr-&gt;annopoint = get_metrics(&amp;(cachePtr-&gt;point), MS_CC, textSymbolPtr-&gt;textpath, label_offset_x, label_offset_y,</span>
<span class="lineNum">    3296 </span><span class="lineNoCov">          0 :                                                            textSymbolPtr-&gt;rotation, textSymbolPtr-&gt;label-&gt;buffer * textSymbolPtr-&gt;scalefactor,</span>
<span class="lineNum">    3297 </span>            :                                                            &amp;metrics_bounds);
<span class="lineNum">    3298 </span><span class="lineNoCov">          0 :                     if(need_labelpoly) get_metrics(&amp;(cachePtr-&gt;point), MS_CC, textSymbolPtr-&gt;textpath,</span>
<span class="lineNum">    3299 </span>            :                                                               label_offset_x, label_offset_y,
<span class="lineNum">    3300 </span>            :                                                               textSymbolPtr-&gt;rotation, 1, &amp;labelpoly_bounds);
<span class="lineNum">    3301 </span>            :                   }
<span class="lineNum">    3302 </span>            :                 } else { /* explicit position */
<span class="lineNum">    3303 </span><span class="lineCov">          1 :                   if(textSymbolPtr-&gt;label-&gt;position == MS_CC) { /* don't need the marker_offset */</span>
<span class="lineNum">    3304 </span><span class="lineCov">          1 :                     metrics_bounds.poly = &amp;metrics_line;</span>
<span class="lineNum">    3305 </span><span class="lineCov">          1 :                     textSymbolPtr-&gt;annopoint = get_metrics(&amp;(cachePtr-&gt;point), MS_CC, textSymbolPtr-&gt;textpath, label_offset_x, label_offset_y,</span>
<span class="lineNum">    3306 </span><span class="lineCov">          1 :                             textSymbolPtr-&gt;rotation, textSymbolPtr-&gt;label-&gt;buffer * textSymbolPtr-&gt;scalefactor, &amp;metrics_bounds);</span>
<span class="lineNum">    3307 </span><span class="lineCov">          1 :                     if(need_labelpoly) get_metrics(&amp;(cachePtr-&gt;point), MS_CC, textSymbolPtr-&gt;textpath,</span>
<span class="lineNum">    3308 </span>            :                                                               label_offset_x, label_offset_y, textSymbolPtr-&gt;rotation, 1, &amp;labelpoly_bounds);
<span class="lineNum">    3309 </span>            :                   } else {
<span class="lineNum">    3310 </span><span class="lineCov">          1 :                     metrics_bounds.poly = &amp;metrics_line;</span>
<span class="lineNum">    3311 </span><span class="lineCov">          1 :                     textSymbolPtr-&gt;annopoint = get_metrics(&amp;(cachePtr-&gt;point), textSymbolPtr-&gt;label-&gt;position, textSymbolPtr-&gt;textpath,</span>
<span class="lineNum">    3312 </span><span class="lineCov">          1 :                                                            marker_offset_x + label_offset_x, marker_offset_y + label_offset_y,</span>
<span class="lineNum">    3313 </span><span class="lineCov">          1 :                                                            textSymbolPtr-&gt;rotation, textSymbolPtr-&gt;label-&gt;buffer * textSymbolPtr-&gt;scalefactor,</span>
<span class="lineNum">    3314 </span>            :                                                            &amp;metrics_bounds);
<span class="lineNum">    3315 </span><span class="lineCov">          1 :                     if(need_labelpoly) get_metrics(&amp;(cachePtr-&gt;point), textSymbolPtr-&gt;label-&gt;position, textSymbolPtr-&gt;textpath,</span>
<span class="lineNum">    3316 </span>            :                                                               marker_offset_x + label_offset_x, marker_offset_y + label_offset_y, textSymbolPtr-&gt;rotation, 1, &amp;labelpoly_bounds);
<span class="lineNum">    3317 </span>            :                   }
<span class="lineNum">    3318 </span>            : 
<span class="lineNum">    3319 </span><span class="lineCov">          1 :                   if(textSymbolPtr-&gt;label-&gt;force == MS_ON) {</span>
<span class="lineNum">    3320 </span>            :                     metrics_status = MS_ON;
<span class="lineNum">    3321 </span>            :                   } else {
<span class="lineNum">    3322 </span><span class="lineCov">          1 :                     if(textSymbolPtr-&gt;label-&gt;force == MS_OFF) {</span>
<span class="lineNum">    3323 </span>            :                       /* check for collisions inside the label group unless the label is FORCE GROUP */
<span class="lineNum">    3324 </span><span class="lineCov">          1 :                       for(its=0;its&lt;ll;its++) {</span>
<span class="lineNum">    3325 </span>            :                         /* check for collisions inside the label group */
<span class="lineNum">    3326 </span><span class="lineCov">          1 :                         if(intersectTextSymbol(cachePtr-&gt;textsymbols[its],&amp;metrics_bounds) == MS_TRUE) {</span>
<span class="lineNum">    3327 </span>            :                           /* there was a self intersection */
<span class="lineNum">    3328 </span>            :                           break; /* will break out to next position in containing loop*/
<span class="lineNum">    3329 </span>            :                         }
<span class="lineNum">    3330 </span>            :                         if(its != ll) {
<span class="lineNum">    3331 </span><span class="lineNoCov">          0 :                           cachePtr-&gt;status = MS_DELETE; /* TODO RFC98: check if this is correct */</span>
<span class="lineNum">    3332 </span>            :                           MS_DEBUG(MS_DEBUGLEVEL_DEVDEBUG,map,
<span class="lineNum">    3333 </span>            :                               &quot;Skipping label %d (\&quot;%s\&quot;) of labelgroup %d of class %d in layer \&quot;%s\&quot;: intercollision with label text inside labelgroup\n&quot;,
<span class="lineNum">    3334 </span>            :                               ll, textSymbolPtr-&gt;annotext, l,cachePtr-&gt;classindex, layerPtr-&gt;name);
<span class="lineNum">    3335 </span><span class="lineNoCov">          0 :                           break; /* collision within the group, break out of textSymbol loop */</span>
<span class="lineNum">    3336 </span>            :                         }
<span class="lineNum">    3337 </span>            :                       }
<span class="lineNum">    3338 </span>            :                     }
<span class="lineNum">    3339 </span>            :                     /* TODO: in case we have leader lines and multiple labels, there's no use in testing for labelcache collisions
<span class="lineNum">    3340 </span>            :                     * once a first collision has been found. we only need to know that the label group has collided, and the
<span class="lineNum">    3341 </span>            :                     * poly of the whole label group: if(label_group) testLabelCacheCollisions */
<span class="lineNum">    3342 </span><span class="lineCov">          1 :                     metrics_status = msTestLabelCacheCollisions(map, cachePtr,&amp;metrics_bounds, priority, l);</span>
<span class="lineNum">    3343 </span>            :                   }
<span class="lineNum">    3344 </span>            :                 } /* end POSITION AUTO vs Fixed POSITION */
<span class="lineNum">    3345 </span>            : 
<span class="lineNum">    3346 </span><span class="lineCov">          1 :                 if(!metrics_status &amp;&amp; classPtr-&gt;leader == 0) {</span>
<span class="lineNum">    3347 </span><span class="lineCov">          1 :                   cachePtr-&gt;status = MS_DELETE;</span>
<span class="lineNum">    3348 </span>            :                   MS_DEBUG(MS_DEBUGLEVEL_DEVDEBUG,map,
<span class="lineNum">    3349 </span>            :                       &quot;Skipping label %d \&quot;%s\&quot; of labelgroup %d of class %d in layer \&quot;%s\&quot;: text collided\n&quot;,
<span class="lineNum">    3350 </span>            :                       ll, textSymbolPtr-&gt;annotext, l, cachePtr-&gt;classindex, layerPtr-&gt;name);
<span class="lineNum">    3351 </span><span class="lineCov">          1 :                   break; /* no point looking at more labels, unless their is a leader defined */</span>
<span class="lineNum">    3352 </span>            :                 }
<span class="lineNum">    3353 </span>            :               }
<span class="lineNum">    3354 </span>            : 
<span class="lineNum">    3355 </span>            :               /* if we're here, we can either fit the label directly, or we need to put it in the leader queue */
<span class="lineNum">    3356 </span>            :               assert((metrics_status &amp;&amp; label_marker_status) || classPtr-&gt;leader);
<span class="lineNum">    3357 </span>            : 
<span class="lineNum">    3358 </span><span class="lineCov">          1 :               if(textSymbolPtr-&gt;annotext) {</span>
<span class="lineNum">    3359 </span><span class="lineCov">          1 :                 copyLabelBounds(&amp;textSymbolPtr-&gt;textpath-&gt;bounds, &amp;metrics_bounds);</span>
<span class="lineNum">    3360 </span>            :               }
<span class="lineNum">    3361 </span><span class="lineCov">          1 :               if(have_label_marker) {</span>
<span class="lineNum">    3362 </span><span class="lineCov">          1 :                 if(!textSymbolPtr-&gt;style_bounds)</span>
<span class="lineNum">    3363 </span><span class="lineCov">          1 :                   textSymbolPtr-&gt;style_bounds = msSmallCalloc(textSymbolPtr-&gt;label-&gt;numstyles, sizeof(label_bounds*));</span>
<span class="lineNum">    3364 </span><span class="lineCov">          1 :                 for(its=0;its&lt;textSymbolPtr-&gt;label-&gt;numstyles; its++) {</span>
<span class="lineNum">    3365 </span><span class="lineCov">          1 :                   if(textSymbolPtr-&gt;label-&gt;styles[its]-&gt;_geomtransform.type == MS_GEOMTRANSFORM_LABELPOINT) {</span>
<span class="lineNum">    3366 </span><span class="lineCov">          1 :                     textSymbolPtr-&gt;style_bounds[its] = msSmallMalloc(sizeof(label_bounds));</span>
<span class="lineNum">    3367 </span><span class="lineCov">          1 :                     copyLabelBounds(textSymbolPtr-&gt;style_bounds[its], &amp;label_marker_bounds);</span>
<span class="lineNum">    3368 </span>            :                   }
<span class="lineNum">    3369 </span>            :                 }
<span class="lineNum">    3370 </span>            :               }
<span class="lineNum">    3371 </span><span class="lineCov">          1 :               if(!label_marker_status || ! metrics_status) {</span>
<span class="lineNum">    3372 </span>            :                 MS_DEBUG(MS_DEBUGLEVEL_DEVDEBUG, map,
<span class="lineNum">    3373 </span>            :                     &quot;Putting label %d of labelgroup %d of class %d , layer \&quot;%s\&quot; in leader queue\n&quot;,
<span class="lineNum">    3374 </span>            :                     ll, l, cachePtr-&gt;classindex, layerPtr-&gt;name);
<span class="lineNum">    3375 </span><span class="lineCov">          1 :                 cachePtr-&gt;status = MS_OFF; /* we have a collision, but this entry is a candidate for leader testing */</span>
<span class="lineNum">    3376 </span>            :               }
<span class="lineNum">    3377 </span>            : 
<span class="lineNum">    3378 </span>            :               /* do we need to copy the labelpoly, or can we use the static one ?*/
<span class="lineNum">    3379 </span><span class="lineCov">          1 :               if(cachePtr-&gt;numtextsymbols &gt; 1 || (cachePtr-&gt;status == MS_OFF &amp;&amp; classPtr-&gt;leader)) {</span>
<span class="lineNum">    3380 </span>            :                 /*
<span class="lineNum">    3381 </span>            :                  * if we have more than one label, or if we have a single one which didn't fit but needs
<span class="lineNum">    3382 </span>            :                  * to go through leader offset testing
<span class="lineNum">    3383 </span>            :                  */
<span class="lineNum">    3384 </span><span class="lineCov">          1 :                 if(!textSymbolPtr-&gt;style_bounds)</span>
<span class="lineNum">    3385 </span><span class="lineCov">          1 :                   textSymbolPtr-&gt;style_bounds = msSmallCalloc(textSymbolPtr-&gt;label-&gt;numstyles, sizeof(label_bounds*));</span>
<span class="lineNum">    3386 </span><span class="lineCov">          1 :                 for(its=0;its&lt;textSymbolPtr-&gt;label-&gt;numstyles; its++) {</span>
<span class="lineNum">    3387 </span><span class="lineCov">          1 :                   if(textSymbolPtr-&gt;label-&gt;styles[its]-&gt;_geomtransform.type == MS_GEOMTRANSFORM_LABELPOLY || </span>
<span class="lineNum">    3388 </span>            :                      textSymbolPtr-&gt;label-&gt;styles[its]-&gt;_geomtransform.type == MS_GEOMTRANSFORM_LABELCENTER) {
<span class="lineNum">    3389 </span><span class="lineCov">          1 :                     textSymbolPtr-&gt;style_bounds[its] = msSmallMalloc(sizeof(label_bounds));</span>
<span class="lineNum">    3390 </span><span class="lineCov">          1 :                     copyLabelBounds(textSymbolPtr-&gt;style_bounds[its], &amp;labelpoly_bounds);</span>
<span class="lineNum">    3391 </span>            :                   }
<span class="lineNum">    3392 </span>            :                 }
<span class="lineNum">    3393 </span>            : 
<span class="lineNum">    3394 </span>            :               } /* else: we'll use labelpoly_bounds directly below */
<span class="lineNum">    3395 </span>            :             } /* next label in the group */
<span class="lineNum">    3396 </span>            : 
<span class="lineNum">    3397 </span><span class="lineCov">          1 :             if(cachePtr-&gt;status != MS_DELETE) {</span>
<span class="lineNum">    3398 </span>            :               /* compute the global label bbox */
<span class="lineNum">    3399 </span>            :               int inited = 0,s;
<span class="lineNum">    3400 </span><span class="lineCov">          1 :               for(its=0;its&lt;cachePtr-&gt;numtextsymbols;its++) {</span>
<span class="lineNum">    3401 </span><span class="lineCov">          1 :                 if(cachePtr-&gt;textsymbols[its]-&gt;annotext) {</span>
<span class="lineNum">    3402 </span><span class="lineCov">          1 :                   if(inited == 0) {</span>
<span class="lineNum">    3403 </span><span class="lineCov">          1 :                     cachePtr-&gt;bbox = cachePtr-&gt;textsymbols[its]-&gt;textpath-&gt;bounds.bbox;</span>
<span class="lineNum">    3404 </span>            :                     inited = 1;
<span class="lineNum">    3405 </span>            :                   } else {
<span class="lineNum">    3406 </span><span class="lineCov">          1 :                     cachePtr-&gt;bbox.minx = MS_MIN(cachePtr-&gt;bbox.minx, cachePtr-&gt;textsymbols[its]-&gt;textpath-&gt;bounds.bbox.minx);</span>
<span class="lineNum">    3407 </span><span class="lineCov">          1 :                     cachePtr-&gt;bbox.miny = MS_MIN(cachePtr-&gt;bbox.miny, cachePtr-&gt;textsymbols[its]-&gt;textpath-&gt;bounds.bbox.miny);</span>
<span class="lineNum">    3408 </span><span class="lineCov">          1 :                     cachePtr-&gt;bbox.maxx = MS_MAX(cachePtr-&gt;bbox.maxx, cachePtr-&gt;textsymbols[its]-&gt;textpath-&gt;bounds.bbox.maxx);</span>
<span class="lineNum">    3409 </span><span class="lineCov">          1 :                     cachePtr-&gt;bbox.maxy = MS_MAX(cachePtr-&gt;bbox.maxy, cachePtr-&gt;textsymbols[its]-&gt;textpath-&gt;bounds.bbox.maxy);</span>
<span class="lineNum">    3410 </span>            :                   }
<span class="lineNum">    3411 </span>            :                 }
<span class="lineNum">    3412 </span><span class="lineCov">          1 :                 for(s=0; s&lt;cachePtr-&gt;textsymbols[its]-&gt;label-&gt;numstyles; s++) {</span>
<span class="lineNum">    3413 </span><span class="lineCov">          1 :                   if(cachePtr-&gt;textsymbols[its]-&gt;label-&gt;styles[s]-&gt;_geomtransform.type == MS_GEOMTRANSFORM_LABELPOINT) {</span>
<span class="lineNum">    3414 </span><span class="lineCov">          1 :                     if(inited == 0) {</span>
<span class="lineNum">    3415 </span><span class="lineCov">          1 :                       cachePtr-&gt;bbox = cachePtr-&gt;textsymbols[its]-&gt;style_bounds[s]-&gt;bbox;</span>
<span class="lineNum">    3416 </span>            :                       inited = 1;
<span class="lineNum">    3417 </span><span class="lineCov">          1 :                       break;</span>
<span class="lineNum">    3418 </span>            :                     } else {
<span class="lineNum">    3419 </span><span class="lineCov">          1 :                       cachePtr-&gt;bbox.minx = MS_MIN(cachePtr-&gt;bbox.minx, cachePtr-&gt;textsymbols[its]-&gt;style_bounds[s]-&gt;bbox.minx);</span>
<span class="lineNum">    3420 </span><span class="lineCov">          1 :                       cachePtr-&gt;bbox.miny = MS_MIN(cachePtr-&gt;bbox.miny, cachePtr-&gt;textsymbols[its]-&gt;style_bounds[s]-&gt;bbox.miny);</span>
<span class="lineNum">    3421 </span><span class="lineCov">          1 :                       cachePtr-&gt;bbox.maxx = MS_MAX(cachePtr-&gt;bbox.maxx, cachePtr-&gt;textsymbols[its]-&gt;style_bounds[s]-&gt;bbox.maxx);</span>
<span class="lineNum">    3422 </span><span class="lineCov">          1 :                       cachePtr-&gt;bbox.maxy = MS_MAX(cachePtr-&gt;bbox.maxy, cachePtr-&gt;textsymbols[its]-&gt;style_bounds[s]-&gt;bbox.maxy);</span>
<span class="lineNum">    3423 </span><span class="lineCov">          1 :                       break; </span>
<span class="lineNum">    3424 </span>            :                     }
<span class="lineNum">    3425 </span>            :                   }
<span class="lineNum">    3426 </span>            :                 }
<span class="lineNum">    3427 </span>            :               }
<span class="lineNum">    3428 </span>            :             }
<span class="lineNum">    3429 </span>            : 
<span class="lineNum">    3430 </span>            :             /* check that mindistance is respected */
<span class="lineNum">    3431 </span><span class="lineCov">          1 :             if (cachePtr-&gt;numtextsymbols &amp;&amp; cachePtr-&gt;textsymbols[0]-&gt;label-&gt;mindistance &gt; 0.0 &amp;&amp; cachePtr-&gt;textsymbols[0]-&gt;annotext) {</span>
<span class="lineNum">    3432 </span><span class="lineCov">          1 :               if (msCheckLabelMinDistance(map, cachePtr) == MS_TRUE) {</span>
<span class="lineNum">    3433 </span><span class="lineCov">          1 :                 cachePtr-&gt;status = MS_DELETE;</span>
<span class="lineNum">    3434 </span>            :                 MS_DEBUG(MS_DEBUGLEVEL_DEVDEBUG, map,
<span class="lineNum">    3435 </span>            :                          &quot;Skipping labelgroup %d \&quot;%s\&quot; in layer \&quot;%s\&quot;: too close to an identical label (mindistance)\n&quot;,
<span class="lineNum">    3436 </span>            :                          l, cachePtr-&gt;textsymbols[0]-&gt;annotext, layerPtr-&gt;name);
<span class="lineNum">    3437 </span>            :               }
<span class="lineNum">    3438 </span>            :             }
<span class="lineNum">    3439 </span>            : 
<span class="lineNum">    3440 </span><span class="lineCov">          1 :             if(cachePtr-&gt;status == MS_OFF || cachePtr-&gt;status == MS_DELETE)</span>
<span class="lineNum">    3441 </span><span class="lineCov">          1 :               continue; /* next labelCacheMemberObj, as we had a collision */</span>
<span class="lineNum">    3442 </span>            : 
<span class="lineNum">    3443 </span>            :             /* insert the rendered label */
<span class="lineNum">    3444 </span><span class="lineCov">          1 :             insertRenderedLabelMember(map, cachePtr);</span>
<span class="lineNum">    3445 </span>            : 
<span class="lineNum">    3446 </span><span class="lineCov">          1 :             for(ll=0; ll&lt;cachePtr-&gt;numtextsymbols; ll++) {</span>
<span class="lineNum">    3447 </span><span class="lineCov">          1 :               textSymbolPtr = cachePtr-&gt;textsymbols[ll];</span>
<span class="lineNum">    3448 </span>            : 
<span class="lineNum">    3449 </span>            :               /* here's where we draw the label styles */
<span class="lineNum">    3450 </span><span class="lineCov">          1 :                 for(i=0; i&lt;textSymbolPtr-&gt;label-&gt;numstyles; i++) {</span>
<span class="lineNum">    3451 </span><span class="lineCov">          1 :                   if(textSymbolPtr-&gt;label-&gt;styles[i]-&gt;_geomtransform.type == MS_GEOMTRANSFORM_LABELPOINT) {</span>
<span class="lineNum">    3452 </span><span class="lineCov">          1 :                     if(UNLIKELY(MS_FAILURE == msDrawMarkerSymbol(map, image, &amp;(cachePtr-&gt;point), textSymbolPtr-&gt;label-&gt;styles[i], textSymbolPtr-&gt;scalefactor))) {</span>
<span class="lineNum">    3453 </span>            :                       return MS_FAILURE;
<span class="lineNum">    3454 </span>            :                     }
<span class="lineNum">    3455 </span><span class="lineCov">          1 :                   } else if(textSymbolPtr-&gt;annotext &amp;&amp; textSymbolPtr-&gt;label-&gt;styles[i]-&gt;_geomtransform.type == MS_GEOMTRANSFORM_LABELPOLY) {</span>
<span class="lineNum">    3456 </span><span class="lineCov">          1 :                     if(textSymbolPtr-&gt;style_bounds &amp;&amp; textSymbolPtr-&gt;style_bounds[i]) {</span>
<span class="lineNum">    3457 </span><span class="lineCov">          1 :                       if(UNLIKELY(MS_FAILURE == msDrawLabelBounds(map,image,textSymbolPtr-&gt;style_bounds[i],textSymbolPtr-&gt;label-&gt;styles[i], textSymbolPtr-&gt;scalefactor))) {</span>
<span class="lineNum">    3458 </span>            :                         return MS_FAILURE;
<span class="lineNum">    3459 </span>            :                       }
<span class="lineNum">    3460 </span>            :                     } else {
<span class="lineNum">    3461 </span><span class="lineCov">          1 :                       if(UNLIKELY(MS_FAILURE == msDrawLabelBounds(map,image,&amp;labelpoly_bounds,textSymbolPtr-&gt;label-&gt;styles[i], textSymbolPtr-&gt;scalefactor))) {</span>
<span class="lineNum">    3462 </span>            :                         return MS_FAILURE;
<span class="lineNum">    3463 </span>            :                       }
<span class="lineNum">    3464 </span>            :                     }
<span class="lineNum">    3465 </span><span class="lineNoCov">          0 :       } else if(textSymbolPtr-&gt;annotext &amp;&amp; textSymbolPtr-&gt;label-&gt;styles[i]-&gt;_geomtransform.type == MS_GEOMTRANSFORM_LABELCENTER) {</span>
<span class="lineNum">    3466 </span>            :                     pointObj labelCenter;
<span class="lineNum">    3467 </span>            : 
<span class="lineNum">    3468 </span><span class="lineNoCov">          0 :                     if(textSymbolPtr-&gt;style_bounds &amp;&amp; textSymbolPtr-&gt;style_bounds[i]) {</span>
<span class="lineNum">    3469 </span><span class="lineNoCov">          0 :                       labelCenter.x = (textSymbolPtr-&gt;style_bounds[i]-&gt;bbox.maxx + textSymbolPtr-&gt;style_bounds[i]-&gt;bbox.minx)/2;</span>
<span class="lineNum">    3470 </span><span class="lineNoCov">          0 :                       labelCenter.y = (textSymbolPtr-&gt;style_bounds[i]-&gt;bbox.maxy + textSymbolPtr-&gt;style_bounds[i]-&gt;bbox.miny)/2;</span>
<span class="lineNum">    3471 </span><span class="lineNoCov">          0 :                       if(UNLIKELY(MS_FAILURE == msDrawMarkerSymbol(map,image,&amp;labelCenter,textSymbolPtr-&gt;label-&gt;styles[i], textSymbolPtr-&gt;scalefactor))) {</span>
<span class="lineNum">    3472 </span><span class="lineNoCov">          0 :                         return MS_FAILURE;</span>
<span class="lineNum">    3473 </span>            :                       }
<span class="lineNum">    3474 </span>            :                     } else {
<span class="lineNum">    3475 </span><span class="lineNoCov">          0 :                       labelCenter.x = (labelpoly_bounds.bbox.maxx + labelpoly_bounds.bbox.minx)/2;</span>
<span class="lineNum">    3476 </span><span class="lineNoCov">          0 :                       labelCenter.y = (labelpoly_bounds.bbox.maxy + labelpoly_bounds.bbox.miny)/2;</span>
<span class="lineNum">    3477 </span><span class="lineNoCov">          0 :                       if(UNLIKELY(MS_FAILURE == msDrawMarkerSymbol(map,image,&amp;labelCenter,textSymbolPtr-&gt;label-&gt;styles[i], textSymbolPtr-&gt;scalefactor))) {</span>
<span class="lineNum">    3478 </span>            :                         return MS_FAILURE;
<span class="lineNum">    3479 </span>            :                       }
<span class="lineNum">    3480 </span>            :                     }
<span class="lineNum">    3481 </span>            : 
<span class="lineNum">    3482 </span>            :                   } else {
<span class="lineNum">    3483 </span><span class="lineNoCov">          0 :                     msSetError(MS_MISCERR,&quot;Labels only support LABELPNT, LABELPOLY and LABELCENTER GEOMTRANSFORMS&quot;, &quot;msDrawLabelCache()&quot;);</span>
<span class="lineNum">    3484 </span><span class="lineNoCov">          0 :                     return MS_FAILURE;</span>
<span class="lineNum">    3485 </span>            :                   }
<span class="lineNum">    3486 </span>            :                 }
<span class="lineNum">    3487 </span>            :               
<span class="lineNum">    3488 </span><span class="lineCov">          1 :               if(textSymbolPtr-&gt;annotext) {</span>
<span class="lineNum">    3489 </span><span class="lineCov">          1 :                 if(UNLIKELY(MS_FAILURE == msDrawTextSymbol(map,image,textSymbolPtr-&gt;annopoint,textSymbolPtr))) {</span>
<span class="lineNum">    3490 </span>            :                   return MS_FAILURE;
<span class="lineNum">    3491 </span>            :                 }
<span class="lineNum">    3492 </span>            :               }
<span class="lineNum">    3493 </span>            :             }
<span class="lineNum">    3494 </span>            :           }
<span class="lineNum">    3495 </span>            :         } /* next label(group) from cacheslot */
<span class="lineNum">    3496 </span><span class="lineCov">          1 :         if(UNLIKELY(MS_FAILURE == msDrawOffsettedLabels(image, map, priority))) {</span>
<span class="lineNum">    3497 </span>            :           return MS_FAILURE;
<span class="lineNum">    3498 </span>            :         }
<span class="lineNum">    3499 </span>            :       } /* next priority */
<span class="lineNum">    3500 </span>            : #ifdef TBDEBUG
<span class="lineNum">    3501 </span>            :       styleObj tstyle;
<span class="lineNum">    3502 </span>            :       initStyle(&amp;tstyle);
<span class="lineNum">    3503 </span>            :       tstyle.width = 1;
<span class="lineNum">    3504 </span>            :       tstyle.color.alpha = 255;
<span class="lineNum">    3505 </span>            :       tstyle.color.red = 255;
<span class="lineNum">    3506 </span>            :       tstyle.color.green = 0;
<span class="lineNum">    3507 </span>            :       tstyle.color.blue = 0;
<span class="lineNum">    3508 </span>            :       for(priority=MS_MAX_LABEL_PRIORITY-1; priority&gt;=0; priority--) {
<span class="lineNum">    3509 </span>            :         labelCacheSlotObj *cacheslot;
<span class="lineNum">    3510 </span>            :         cacheslot = &amp;(map-&gt;labelcache.slots[priority]);
<span class="lineNum">    3511 </span>            : 
<span class="lineNum">    3512 </span>            :         for(l=cacheslot-&gt;numlabels-1; l&gt;=0; l--) {
<span class="lineNum">    3513 </span>            :           cachePtr = &amp;(cacheslot-&gt;labels[l]); /* point to right spot in the label cache */
<span class="lineNum">    3514 </span>            :           /*
<span class="lineNum">    3515 </span>            :           assert((cachePtr-&gt;poly == NULL &amp;&amp; cachePtr-&gt;status == MS_OFF) ||
<span class="lineNum">    3516 </span>            :                   (cachePtr-&gt;poly &amp;&amp; (cachePtr-&gt;status == MS_ON));
<span class="lineNum">    3517 </span>            :            */
<span class="lineNum">    3518 </span>            :           if(cachePtr-&gt;status) {
<span class="lineNum">    3519 </span>            :             msDrawLineSymbol(map, image, cachePtr-&gt;poly, &amp;tstyle, layerPtr-&gt;scalefactor);
<span class="lineNum">    3520 </span>            :           }
<span class="lineNum">    3521 </span>            :         }
<span class="lineNum">    3522 </span>            :       }
<span class="lineNum">    3523 </span>            : #endif
<span class="lineNum">    3524 </span>            : 
<span class="lineNum">    3525 </span>            :       nReturnVal = MS_SUCCESS; /* necessary? */
<span class="lineNum">    3526 </span>            :     }
<span class="lineNum">    3527 </span>            :   }
<span class="lineNum">    3528 </span>            : 
<span class="lineNum">    3529 </span><span class="lineCov">          1 :   if(map-&gt;debug &gt;= MS_DEBUGLEVEL_TUNING) {</span>
<span class="lineNum">    3530 </span><span class="lineCov">          1 :     msGettimeofday(&amp;endtime, NULL);</span>
<span class="lineNum">    3531 </span><span class="lineCov">          1 :     msDebug(&quot;msDrawMap(): Drawing Label Cache, %.3fs\n&quot;,</span>
<span class="lineNum">    3532 </span><span class="lineCov">          1 :             (endtime.tv_sec+endtime.tv_usec/1.0e6)-</span>
<span class="lineNum">    3533 </span><span class="lineCov">          1 :             (starttime.tv_sec+starttime.tv_usec/1.0e6) );</span>
<span class="lineNum">    3534 </span>            :   }
<span class="lineNum">    3535 </span>            : 
<span class="lineNum">    3536 </span>            :   return nReturnVal;
<span class="lineNum">    3537 </span>            : }
<span class="lineNum">    3538 </span>            : 
<span class="lineNum">    3539 </span>            : 
<span class="lineNum">    3540 </span>            : /**
<span class="lineNum">    3541 </span>            :  * Generic function to tell the underline device that layer
<span class="lineNum">    3542 </span>            :  * drawing is stating
<a name="3543"><span class="lineNum">    3543 </span>            :  */</a>
<span class="lineNum">    3544 </span>            : 
<span class="lineNum">    3545 </span><span class="lineCov">          1 : void msImageStartLayer(mapObj *map, layerObj *layer, imageObj *image)</span>
<span class="lineNum">    3546 </span>            : {
<span class="lineNum">    3547 </span><span class="lineCov">          1 :   if (image) {</span>
<span class="lineNum">    3548 </span><span class="lineCov">          1 :     if( MS_RENDERER_PLUGIN(image-&gt;format) ) {</span>
<span class="lineNum">    3549 </span><span class="lineCov">          1 :       char *approximation_scale = msLayerGetProcessingKey( layer, &quot;APPROXIMATION_SCALE&quot; );</span>
<span class="lineNum">    3550 </span><span class="lineCov">          1 :       if(approximation_scale) {</span>
<span class="lineNum">    3551 </span><span class="lineNoCov">          0 :         if(!strncasecmp(approximation_scale,&quot;ROUND&quot;,5)) {</span>
<span class="lineNum">    3552 </span><span class="lineNoCov">          0 :           MS_IMAGE_RENDERER(image)-&gt;transform_mode = MS_TRANSFORM_ROUND;</span>
<span class="lineNum">    3553 </span><span class="lineNoCov">          0 :         } else if(!strncasecmp(approximation_scale,&quot;FULL&quot;,4)) {</span>
<span class="lineNum">    3554 </span><span class="lineNoCov">          0 :           MS_IMAGE_RENDERER(image)-&gt;transform_mode = MS_TRANSFORM_FULLRESOLUTION;</span>
<span class="lineNum">    3555 </span><span class="lineNoCov">          0 :         } else if(!strncasecmp(approximation_scale,&quot;SIMPLIFY&quot;,8)) {</span>
<span class="lineNum">    3556 </span><span class="lineNoCov">          0 :           MS_IMAGE_RENDERER(image)-&gt;transform_mode = MS_TRANSFORM_SIMPLIFY;</span>
<span class="lineNum">    3557 </span>            :         } else {
<span class="lineNum">    3558 </span><span class="lineNoCov">          0 :           MS_IMAGE_RENDERER(image)-&gt;transform_mode = MS_TRANSFORM_SNAPTOGRID;</span>
<span class="lineNum">    3559 </span><span class="lineNoCov">          0 :           MS_IMAGE_RENDERER(image)-&gt;approximation_scale = atof(approximation_scale);</span>
<span class="lineNum">    3560 </span>            :         }
<span class="lineNum">    3561 </span>            :       } else {
<span class="lineNum">    3562 </span><span class="lineCov">          1 :         MS_IMAGE_RENDERER(image)-&gt;transform_mode = MS_IMAGE_RENDERER(image)-&gt;default_transform_mode;</span>
<span class="lineNum">    3563 </span><span class="lineCov">          1 :         MS_IMAGE_RENDERER(image)-&gt;approximation_scale = MS_IMAGE_RENDERER(image)-&gt;default_approximation_scale;</span>
<span class="lineNum">    3564 </span>            :       }
<span class="lineNum">    3565 </span><span class="lineCov">          1 :       MS_IMAGE_RENDERER(image)-&gt;startLayer(image, map, layer);</span>
<span class="lineNum">    3566 </span><span class="lineCov">          1 :     } else if( MS_RENDERER_IMAGEMAP(image-&gt;format) )</span>
<span class="lineNum">    3567 </span><span class="lineNoCov">          0 :       msImageStartLayerIM(map, layer, image);</span>
<span class="lineNum">    3568 </span>            : 
<span class="lineNum">    3569 </span>            :   }
<span class="lineNum">    3570 </span><span class="lineCov">          1 : }</span>
<span class="lineNum">    3571 </span>            : 
<span class="lineNum">    3572 </span>            : 
<span class="lineNum">    3573 </span>            : /**
<span class="lineNum">    3574 </span>            :  * Generic function to tell the underline device that layer
<span class="lineNum">    3575 </span>            :  * drawing is ending
<a name="3576"><span class="lineNum">    3576 </span>            :  */</a>
<span class="lineNum">    3577 </span>            : 
<span class="lineNum">    3578 </span><span class="lineCov">          1 : void msImageEndLayer(mapObj *map, layerObj *layer, imageObj *image)</span>
<span class="lineNum">    3579 </span>            : {
<span class="lineNum">    3580 </span><span class="lineCov">          1 :   if(image) {</span>
<span class="lineNum">    3581 </span><span class="lineCov">          1 :     if( MS_RENDERER_PLUGIN(image-&gt;format) ) {</span>
<span class="lineNum">    3582 </span><span class="lineCov">          1 :       MS_IMAGE_RENDERER(image)-&gt;endLayer(image,map,layer);</span>
<span class="lineNum">    3583 </span>            :     }
<span class="lineNum">    3584 </span>            :   }
<span class="lineNum">    3585 </span><span class="lineCov">          1 : }</span>
<span class="lineNum">    3586 </span>            : 
<span class="lineNum">    3587 </span>            : /**
<span class="lineNum">    3588 </span>            :  * Generic function to tell the underline device that shape
<span class="lineNum">    3589 </span>            :  * drawing is starting
<a name="3590"><span class="lineNum">    3590 </span>            :  */</a>
<span class="lineNum">    3591 </span>            : 
<span class="lineNum">    3592 </span><span class="lineCov">          1 : void msDrawStartShape(mapObj *map, layerObj *layer, imageObj *image,</span>
<span class="lineNum">    3593 </span>            :                       shapeObj *shape)
<span class="lineNum">    3594 </span>            : {
<span class="lineNum">    3595 </span><span class="lineCov">          1 :   if (image) {</span>
<span class="lineNum">    3596 </span><span class="lineCov">          1 :     if(MS_RENDERER_PLUGIN(image-&gt;format)) {</span>
<span class="lineNum">    3597 </span><span class="lineCov">          1 :       if (image-&gt;format-&gt;vtable-&gt;startShape)</span>
<span class="lineNum">    3598 </span><span class="lineCov">          1 :         image-&gt;format-&gt;vtable-&gt;startShape(image, shape);</span>
<span class="lineNum">    3599 </span>            :     }
<span class="lineNum">    3600 </span>            : 
<span class="lineNum">    3601 </span>            : 
<span class="lineNum">    3602 </span>            :   }
<span class="lineNum">    3603 </span><span class="lineCov">          1 : }</span>
<span class="lineNum">    3604 </span>            : 
<span class="lineNum">    3605 </span>            : 
<span class="lineNum">    3606 </span>            : /**
<span class="lineNum">    3607 </span>            :  * Generic function to tell the underline device that shape
<span class="lineNum">    3608 </span>            :  * drawing is ending
<a name="3609"><span class="lineNum">    3609 </span>            :  */</a>
<span class="lineNum">    3610 </span>            : 
<span class="lineNum">    3611 </span><span class="lineCov">          1 : void msDrawEndShape(mapObj *map, layerObj *layer, imageObj *image,</span>
<span class="lineNum">    3612 </span>            :                     shapeObj *shape)
<span class="lineNum">    3613 </span>            : {
<span class="lineNum">    3614 </span><span class="lineCov">          1 :   if(MS_RENDERER_PLUGIN(image-&gt;format)) {</span>
<span class="lineNum">    3615 </span><span class="lineCov">          1 :     if (image-&gt;format-&gt;vtable-&gt;endShape)</span>
<span class="lineNum">    3616 </span><span class="lineCov">          1 :       image-&gt;format-&gt;vtable-&gt;endShape(image, shape);</span>
<span class="lineNum">    3617 </span>            :   }
<span class="lineNum">    3618 </span><span class="lineCov">          1 : }</span>
<span class="lineNum">    3619 </span>            : /**
<span class="lineNum">    3620 </span>            :  * take the value from the shape and use it to change the
<a name="3621"><span class="lineNum">    3621 </span>            :  * color in the style to match the range map</a>
<span class="lineNum">    3622 </span>            :  */
<span class="lineNum">    3623 </span><span class="lineNoCov">          0 : int msShapeToRange(styleObj *style, shapeObj *shape)</span>
<span class="lineNum">    3624 </span>            : {
<span class="lineNum">    3625 </span>            :   double fieldVal;
<span class="lineNum">    3626 </span>            :   char* fieldStr;
<span class="lineNum">    3627 </span>            : 
<span class="lineNum">    3628 </span>            :   /*first, get the value of the rangeitem, which should*/
<span class="lineNum">    3629 </span>            :   /*evaluate to a double*/
<span class="lineNum">    3630 </span><span class="lineNoCov">          0 :   fieldStr = shape-&gt;values[style-&gt;rangeitemindex];</span>
<span class="lineNum">    3631 </span><span class="lineNoCov">          0 :   if (fieldStr == NULL) { /*if there's not value, bail*/</span>
<span class="lineNum">    3632 </span>            :     return MS_FAILURE;
<span class="lineNum">    3633 </span>            :   }
<span class="lineNum">    3634 </span>            :   fieldVal = 0.0;
<span class="lineNum">    3635 </span>            :   fieldVal = atof(fieldStr); /*faith that it's ok -- */
<span class="lineNum">    3636 </span>            :   /*should switch to strtod*/
<span class="lineNum">    3637 </span><span class="lineNoCov">          0 :   return msValueToRange(style, fieldVal, MS_COLORSPACE_RGB);</span>
<span class="lineNum">    3638 </span>            : }
<span class="lineNum">    3639 </span>            : 
<span class="lineNum">    3640 </span>            : /**
<span class="lineNum">    3641 </span>            :  * Allow direct mapping of a value so that mapscript can use the
<span class="lineNum">    3642 </span>            :  * Ranges.  The styls passed in is updated to reflect the right color
<a name="3643"><span class="lineNum">    3643 </span>            :  * based on the fieldVal</a>
<span class="lineNum">    3644 </span>            :  */
<span class="lineNum">    3645 </span><span class="lineCov">          1 : int msValueToRange(styleObj *style, double fieldVal, colorspace cs)</span>
<span class="lineNum">    3646 </span>            : {
<span class="lineNum">    3647 </span>            :   double range;
<span class="lineNum">    3648 </span>            :   double scaledVal;
<span class="lineNum">    3649 </span>            : 
<span class="lineNum">    3650 </span><span class="lineCov">          1 :   range = style-&gt;maxvalue - style-&gt;minvalue;</span>
<span class="lineNum">    3651 </span><span class="lineCov">          1 :   scaledVal = (fieldVal - style-&gt;minvalue)/range;</span>
<span class="lineNum">    3652 </span>            : 
<span class="lineNum">    3653 </span><span class="lineCov">          1 :   if(cs == MS_COLORSPACE_RGB) {</span>
<span class="lineNum">    3654 </span>            :     /*At this point, we know where on the range we need to be*/
<span class="lineNum">    3655 </span>            :     /*However, we don't know how to map it yet, since RGB(A) can */
<span class="lineNum">    3656 </span>            :     /*Go up or down*/
<span class="lineNum">    3657 </span><span class="lineCov">          1 :     style-&gt;color.red = (int)(MS_MAX(0,(MS_MIN(255, (style-&gt;mincolor.red + ((style-&gt;maxcolor.red - style-&gt;mincolor.red) * scaledVal))))));</span>
<span class="lineNum">    3658 </span><span class="lineCov">          1 :     style-&gt;color.green = (int)(MS_MAX(0,(MS_MIN(255,(style-&gt;mincolor.green + ((style-&gt;maxcolor.green - style-&gt;mincolor.green) * scaledVal))))));</span>
<span class="lineNum">    3659 </span><span class="lineCov">          1 :     style-&gt;color.blue = (int)(MS_MAX(0,(MS_MIN(255,(style-&gt;mincolor.blue + ((style-&gt;maxcolor.blue - style-&gt;mincolor.blue) * scaledVal))))));</span>
<span class="lineNum">    3660 </span><span class="lineCov">          1 :     style-&gt;color.alpha = (int)(MS_MAX(0,(MS_MIN(255,(style-&gt;mincolor.alpha + ((style-&gt;maxcolor.alpha - style-&gt;mincolor.alpha) * scaledVal))))));</span>
<span class="lineNum">    3661 </span>            :   } else {
<span class="lineNum">    3662 </span>            :     /* HSL */
<span class="lineNum">    3663 </span>            :     assert(cs == MS_COLORSPACE_HSL);
<span class="lineNum">    3664 </span><span class="lineCov">          1 :     if(fieldVal &lt;= style-&gt;minvalue) style-&gt;color = style-&gt;mincolor;</span>
<span class="lineNum">    3665 </span><span class="lineCov">          1 :     else if(fieldVal &gt;= style-&gt;maxvalue) style-&gt;color = style-&gt;maxcolor;</span>
<span class="lineNum">    3666 </span>            :     else {
<span class="lineNum">    3667 </span>            :       double mh,ms,ml,Mh,Ms,Ml;
<span class="lineNum">    3668 </span><span class="lineCov">          1 :       msRGBtoHSL(&amp;style-&gt;mincolor,&amp;mh,&amp;ms,&amp;ml);</span>
<span class="lineNum">    3669 </span><span class="lineCov">          1 :       msRGBtoHSL(&amp;style-&gt;maxcolor,&amp;Mh,&amp;Ms,&amp;Ml);</span>
<span class="lineNum">    3670 </span><span class="lineCov">          1 :       mh+=(Mh-mh)*scaledVal;</span>
<span class="lineNum">    3671 </span><span class="lineCov">          1 :       ms+=(Ms-ms)*scaledVal;</span>
<span class="lineNum">    3672 </span><span class="lineCov">          1 :       ml+=(Ml-ml)*scaledVal;</span>
<span class="lineNum">    3673 </span><span class="lineCov">          1 :       msHSLtoRGB(mh,ms,ml,&amp;style-&gt;color);</span>
<span class="lineNum">    3674 </span><span class="lineCov">          1 :       style-&gt;color.alpha = style-&gt;mincolor.alpha + (style-&gt;maxcolor.alpha - style-&gt;mincolor.alpha)*scaledVal;</span>
<span class="lineNum">    3675 </span>            :     }
<span class="lineNum">    3676 </span>            :   }
<span class="lineNum">    3677 </span>            :   /*( &quot;msMapRange(): %i %i %i&quot;, style-&gt;color.red , style-&gt;color.green, style-&gt;color.blue);*/
<span class="lineNum">    3678 </span>            : 
<span class="lineNum">    3679 </span>            : #if ALPHACOLOR_ENABLED
<span class="lineNum">    3680 </span>            :   /*NO ALPHA RANGE YET  style-&gt;color.alpha = style-&gt;mincolor.alpha + ((style-&gt;maxcolor.alpha - style-&gt;mincolor.alpha) * scaledVal);*/
<span class="lineNum">    3681 </span>            : #endif
<span class="lineNum">    3682 </span>            : 
<span class="lineNum">    3683 </span><span class="lineCov">          1 :   return MS_SUCCESS;</span>
<span class="lineNum">    3684 </span>            : }
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>

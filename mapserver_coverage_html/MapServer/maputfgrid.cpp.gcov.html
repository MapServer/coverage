<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - mapserver.info - MapServer/maputfgrid.cpp</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">MapServer</a> - maputfgrid.cpp<span style="font-size: 80%;"> (source / <a href="maputfgrid.cpp.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">mapserver.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">304</td>
            <td class="headerCovTableEntry">329</td>
            <td class="headerCovTableEntryHi">92.4 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2020-10-12 19:53:14</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">30</td>
            <td class="headerCovTableEntry">34</td>
            <td class="headerCovTableEntryMed">88.2 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /******************************************************************************</a>
<span class="lineNum">       2 </span>            :  * $Id$
<span class="lineNum">       3 </span>            :  *
<span class="lineNum">       4 </span>            :  * Project:  MapServer
<span class="lineNum">       5 </span>            :  * Purpose:  UTFGrid rendering functions (using AGG)
<span class="lineNum">       6 </span>            :  * Author:   Francois Desjarlais
<span class="lineNum">       7 </span>            :  *
<span class="lineNum">       8 </span>            :  ******************************************************************************
<span class="lineNum">       9 </span>            :  * Copyright (c) 1996-2007 Regents of the University of Minnesota.
<span class="lineNum">      10 </span>            :  *
<span class="lineNum">      11 </span>            :  * Permission is hereby granted, free of charge, to any person obtaining a
<span class="lineNum">      12 </span>            :  * copy of this software and associated documentation files (the &quot;Software&quot;),
<span class="lineNum">      13 </span>            :  * to deal in the Software without restriction, including without limitation
<span class="lineNum">      14 </span>            :  * the rights to use, copy, modify, merge, publish, distribute, sublicense,
<span class="lineNum">      15 </span>            :  * and/or sell copies of the Software, and to permit persons to whom the
<span class="lineNum">      16 </span>            :  * Software is furnished to do so, subject to the following conditions:
<span class="lineNum">      17 </span>            :  *
<span class="lineNum">      18 </span>            :  * The above copyright notice and this permission notice shall be included in
<span class="lineNum">      19 </span>            :  * all copies of this Software or works derived from this Software.
<span class="lineNum">      20 </span>            :  *
<span class="lineNum">      21 </span>            :  * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS
<span class="lineNum">      22 </span>            :  * OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
<span class="lineNum">      23 </span>            :  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL
<span class="lineNum">      24 </span>            :  * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
<span class="lineNum">      25 </span>            :  * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
<span class="lineNum">      26 </span>            :  * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
<span class="lineNum">      27 </span>            :  * DEALINGS IN THE SOFTWARE.
<span class="lineNum">      28 </span>            :  *****************************************************************************/
<span class="lineNum">      29 </span>            : 
<span class="lineNum">      30 </span>            : 
<span class="lineNum">      31 </span>            : #include &quot;mapserver.h&quot;
<span class="lineNum">      32 </span>            : #include &quot;maputfgrid.h&quot;
<span class="lineNum">      33 </span>            : #include &quot;mapagg.h&quot;
<span class="lineNum">      34 </span>            : #include &quot;renderers/agg/include/agg_rasterizer_scanline_aa.h&quot;
<span class="lineNum">      35 </span>            : #include &quot;renderers/agg/include/agg_basics.h&quot;
<span class="lineNum">      36 </span>            : #include &quot;renderers/agg/include/agg_renderer_scanline.h&quot;
<span class="lineNum">      37 </span>            : #include &quot;renderers/agg/include/agg_scanline_bin.h&quot;
<span class="lineNum">      38 </span>            : #include &quot;renderers/agg/include/agg_gamma_functions.h&quot;
<span class="lineNum">      39 </span>            : #include &quot;renderers/agg/include/agg_conv_stroke.h&quot;
<span class="lineNum">      40 </span>            : #include &quot;renderers/agg/include/agg_ellipse.h&quot;
<span class="lineNum">      41 </span>            : 
<span class="lineNum">      42 </span>            : typedef mapserver::int32u band_type;
<span class="lineNum">      43 </span>            : typedef mapserver::row_ptr_cache&lt;band_type&gt; rendering_buffer;
<span class="lineNum">      44 </span>            : typedef pixfmt_utf&lt;utfpix32, rendering_buffer&gt; pixfmt_utf32;
<span class="lineNum">      45 </span>            : typedef mapserver::renderer_base&lt;pixfmt_utf32&gt; renderer_base;
<span class="lineNum">      46 </span>            : typedef mapserver::rasterizer_scanline_aa&lt;&gt; rasterizer_scanline;
<span class="lineNum">      47 </span>            : typedef mapserver::renderer_scanline_bin_solid&lt;renderer_base&gt; renderer_scanline;
<span class="lineNum">      48 </span>            : 
<span class="lineNum">      49 </span>            : static utfpix32 UTF_WATER = utfpix32(32);
<span class="lineNum">      50 </span>            : 
<span class="lineNum">      51 </span>            : #define utfitem(c) utfpix32(c)
<span class="lineNum">      52 </span>            : 
<span class="lineNum">      53 </span>            : struct shapeData
<span class="lineNum">      54 </span>            : {
<span class="lineNum">      55 </span>            :   char *datavalues;
<span class="lineNum">      56 </span>            :   char *itemvalue;
<span class="lineNum">      57 </span>            :   band_type utfvalue;
<span class="lineNum">      58 </span>            :   int serialid;
<span class="lineNum">      59 </span>            : };
<span class="lineNum">      60 </span>            : 
<span class="lineNum">      61 </span>            : class lookupTable {
<span class="lineNum">      62 </span>            : public:
<span class="lineNum">      63 </span>            :   lookupTable()
<span class="lineNum">      64 </span><span class="lineCov">          1 :   {</span>
<span class="lineNum">      65 </span><span class="lineCov">          1 :     table = (shapeData*) msSmallMalloc(sizeof(shapeData));</span>
<span class="lineNum">      66 </span><span class="lineCov">          1 :     table-&gt;datavalues = NULL;</span>
<span class="lineNum">      67 </span><span class="lineCov">          1 :     table-&gt;itemvalue = NULL;</span>
<span class="lineNum">      68 </span><span class="lineCov">          1 :     table-&gt;utfvalue = 0;</span>
<span class="lineNum">      69 </span><span class="lineCov">          1 :     table-&gt;serialid = 0;</span>
<span class="lineNum">      70 </span><span class="lineCov">          1 :     size = 1;</span>
<span class="lineNum">      71 </span><span class="lineCov">          1 :     counter = 0;</span>
<a name="72"><span class="lineNum">      72 </span>            :   }</a>
<span class="lineNum">      73 </span>            : 
<span class="lineNum">      74 </span><span class="lineCov">          1 :   ~lookupTable()</span>
<span class="lineNum">      75 </span><span class="lineCov">          1 :   {</span>
<span class="lineNum">      76 </span>            :     int i;
<span class="lineNum">      77 </span>            : 
<span class="lineNum">      78 </span><span class="lineCov">          1 :     for(i=0; i&lt;size; i++)</span>
<span class="lineNum">      79 </span>            :     {
<span class="lineNum">      80 </span><span class="lineCov">          1 :       if(table[i].datavalues)</span>
<span class="lineNum">      81 </span><span class="lineCov">          1 :         msFree(table[i].datavalues);</span>
<span class="lineNum">      82 </span><span class="lineCov">          1 :       if(table[i].itemvalue)</span>
<span class="lineNum">      83 </span><span class="lineCov">          1 :         msFree(table[i].itemvalue);</span>
<span class="lineNum">      84 </span>            :     }
<span class="lineNum">      85 </span><span class="lineCov">          1 :     msFree(table);</span>
<span class="lineNum">      86 </span><span class="lineCov">          1 :   }</span>
<span class="lineNum">      87 </span>            : 
<span class="lineNum">      88 </span>            :   shapeData  *table;
<span class="lineNum">      89 </span>            :   int size;
<span class="lineNum">      90 </span>            :   int counter;
<span class="lineNum">      91 </span>            : };
<span class="lineNum">      92 </span>            : 
<span class="lineNum">      93 </span>            : /*
<a name="94"><span class="lineNum">      94 </span>            :  * UTFGrid specific polygon adaptor.</a>
<span class="lineNum">      95 </span>            :  */
<span class="lineNum">      96 </span><span class="lineNoCov">          0 : class polygon_adaptor_utf:public polygon_adaptor</span>
<span class="lineNum">      97 </span>            : {
<span class="lineNum">      98 </span>            : public:
<span class="lineNum">      99 </span><span class="lineCov">          1 :   polygon_adaptor_utf(shapeObj *shape,int utfres_in):polygon_adaptor(shape)</span>
<span class="lineNum">     100 </span>            :   {
<span class="lineNum">     101 </span><span class="lineCov">          1 :     utfresolution = utfres_in;</span>
<a name="102"><span class="lineNum">     102 </span>            :   }</a>
<span class="lineNum">     103 </span>            : 
<span class="lineNum">     104 </span><span class="lineCov">          1 :   virtual unsigned vertex(double* x, double* y)</span>
<span class="lineNum">     105 </span>            :   {
<span class="lineNum">     106 </span><span class="lineCov">          1 :     if(m_point &lt; m_pend) {</span>
<span class="lineNum">     107 </span><span class="lineCov">          1 :       bool first = m_point == m_line-&gt;point;</span>
<span class="lineNum">     108 </span><span class="lineCov">          1 :       *x = m_point-&gt;x/utfresolution;</span>
<span class="lineNum">     109 </span><span class="lineCov">          1 :       *y = m_point-&gt;y/utfresolution;</span>
<span class="lineNum">     110 </span><span class="lineCov">          1 :       m_point++;</span>
<span class="lineNum">     111 </span><span class="lineCov">          1 :       return first ? mapserver::path_cmd_move_to : mapserver::path_cmd_line_to;</span>
<span class="lineNum">     112 </span>            :     }
<span class="lineNum">     113 </span><span class="lineCov">          1 :     *x = *y = 0.0;</span>
<span class="lineNum">     114 </span><span class="lineCov">          1 :     if(!m_stop) {</span>
<span class="lineNum">     115 </span>            : 
<span class="lineNum">     116 </span><span class="lineCov">          1 :       m_line++;</span>
<span class="lineNum">     117 </span><span class="lineCov">          1 :       if(m_line&gt;=m_lend) {</span>
<span class="lineNum">     118 </span><span class="lineCov">          1 :         m_stop=true;</span>
<span class="lineNum">     119 </span><span class="lineCov">          1 :         return mapserver::path_cmd_end_poly;</span>
<span class="lineNum">     120 </span>            :       }
<span class="lineNum">     121 </span>            : 
<span class="lineNum">     122 </span><span class="lineCov">          1 :       m_point=m_line-&gt;point;</span>
<span class="lineNum">     123 </span><span class="lineCov">          1 :       m_pend=&amp;(m_line-&gt;point[m_line-&gt;numpoints]);</span>
<span class="lineNum">     124 </span><span class="lineCov">          1 :       return mapserver::path_cmd_end_poly;</span>
<span class="lineNum">     125 </span>            :     }
<span class="lineNum">     126 </span>            :     return mapserver::path_cmd_stop;
<span class="lineNum">     127 </span>            :   }
<span class="lineNum">     128 </span>            : 
<span class="lineNum">     129 </span>            : private:
<span class="lineNum">     130 </span>            :   int utfresolution;
<span class="lineNum">     131 </span>            : };
<span class="lineNum">     132 </span>            : 
<span class="lineNum">     133 </span>            : /*
<a name="134"><span class="lineNum">     134 </span>            :  * UTFGrid specific line adaptor.</a>
<span class="lineNum">     135 </span>            :  */
<span class="lineNum">     136 </span><span class="lineNoCov">          0 : class line_adaptor_utf:public line_adaptor</span>
<span class="lineNum">     137 </span>            : {
<span class="lineNum">     138 </span>            : public:
<span class="lineNum">     139 </span><span class="lineCov">          1 :   line_adaptor_utf(shapeObj *shape,int utfres_in):line_adaptor(shape)</span>
<span class="lineNum">     140 </span>            :   {
<span class="lineNum">     141 </span><span class="lineCov">          1 :     utfresolution = utfres_in;</span>
<a name="142"><span class="lineNum">     142 </span>            :   }</a>
<span class="lineNum">     143 </span>            : 
<span class="lineNum">     144 </span><span class="lineCov">          1 :   virtual unsigned vertex(double* x, double* y)</span>
<span class="lineNum">     145 </span>            :   {
<span class="lineNum">     146 </span><span class="lineCov">          1 :     if(m_point &lt; m_pend) {</span>
<span class="lineNum">     147 </span><span class="lineCov">          1 :       bool first = m_point == m_line-&gt;point;</span>
<span class="lineNum">     148 </span><span class="lineCov">          1 :       *x = m_point-&gt;x/utfresolution;</span>
<span class="lineNum">     149 </span><span class="lineCov">          1 :       *y = m_point-&gt;y/utfresolution;</span>
<span class="lineNum">     150 </span><span class="lineCov">          1 :       m_point++;</span>
<span class="lineNum">     151 </span><span class="lineCov">          1 :       return first ? mapserver::path_cmd_move_to : mapserver::path_cmd_line_to;</span>
<span class="lineNum">     152 </span>            :     }
<span class="lineNum">     153 </span><span class="lineCov">          1 :     m_line++;</span>
<span class="lineNum">     154 </span><span class="lineCov">          1 :     *x = *y = 0.0;</span>
<span class="lineNum">     155 </span><span class="lineCov">          1 :     if(m_line&gt;=m_lend)</span>
<span class="lineNum">     156 </span>            :       return mapserver::path_cmd_stop;
<span class="lineNum">     157 </span>            : 
<span class="lineNum">     158 </span><span class="lineNoCov">          0 :     m_point=m_line-&gt;point;</span>
<span class="lineNum">     159 </span><span class="lineNoCov">          0 :     m_pend=&amp;(m_line-&gt;point[m_line-&gt;numpoints]);</span>
<span class="lineNum">     160 </span>            : 
<span class="lineNum">     161 </span><span class="lineNoCov">          0 :     return vertex(x,y);</span>
<span class="lineNum">     162 </span>            :   }
<span class="lineNum">     163 </span>            : 
<span class="lineNum">     164 </span>            : private:
<span class="lineNum">     165 </span>            :   int utfresolution;
<span class="lineNum">     166 </span>            : };
<span class="lineNum">     167 </span>            : 
<a name="168"><span class="lineNum">     168 </span>            : class UTFGridRenderer {</a>
<span class="lineNum">     169 </span>            : public:
<span class="lineNum">     170 </span><span class="lineCov">          1 :   UTFGridRenderer()</span>
<span class="lineNum">     171 </span><span class="lineCov">          1 :   {</span>
<a name="172"><span class="lineNum">     172 </span><span class="lineCov">          1 :     stroke = NULL;</span></a>
<span class="lineNum">     173 </span><span class="lineCov">          1 :   }</span>
<span class="lineNum">     174 </span><span class="lineCov">          1 :   ~UTFGridRenderer()</span>
<span class="lineNum">     175 </span><span class="lineCov">          1 :   {</span>
<span class="lineNum">     176 </span><span class="lineCov">          1 :     if(stroke)</span>
<span class="lineNum">     177 </span><span class="lineCov">          1 :       delete stroke;</span>
<span class="lineNum">     178 </span><span class="lineCov">          1 :     delete data;</span>
<span class="lineNum">     179 </span><span class="lineCov">          1 :   }</span>
<span class="lineNum">     180 </span>            : 
<span class="lineNum">     181 </span>            :   lookupTable *data;
<span class="lineNum">     182 </span>            :   int utfresolution;
<span class="lineNum">     183 </span>            :   int layerwatch;
<span class="lineNum">     184 </span>            :   int renderlayer;
<span class="lineNum">     185 </span>            :   int useutfitem;
<span class="lineNum">     186 </span>            :   int useutfdata;
<span class="lineNum">     187 </span>            :   int duplicates;
<span class="lineNum">     188 </span>            :   band_type utfvalue;
<span class="lineNum">     189 </span>            :   layerObj *utflayer;
<span class="lineNum">     190 </span>            :   band_type *buffer;
<span class="lineNum">     191 </span>            :   rendering_buffer m_rendering_buffer;
<span class="lineNum">     192 </span>            :   pixfmt_utf32 m_pixel_format;
<span class="lineNum">     193 </span>            :   renderer_base m_renderer_base;
<span class="lineNum">     194 </span>            :   rasterizer_scanline m_rasterizer;
<span class="lineNum">     195 </span>            :   renderer_scanline m_renderer_scanline;
<span class="lineNum">     196 </span>            :   mapserver::scanline_bin sl_utf;
<span class="lineNum">     197 </span>            :   mapserver::conv_stroke&lt;line_adaptor_utf&gt; *stroke;
<span class="lineNum">     198 </span>            : };
<span class="lineNum">     199 </span>            : 
<span class="lineNum">     200 </span>            : #define UTFGRID_RENDERER(image) ((UTFGridRenderer*) (image)-&gt;img.plugin)
<span class="lineNum">     201 </span>            : 
<span class="lineNum">     202 </span>            : /*
<a name="203"><span class="lineNum">     203 </span>            :  * Encode to avoid unavailable char in the JSON</a>
<span class="lineNum">     204 </span>            :  */
<span class="lineNum">     205 </span><span class="lineCov">          1 : unsigned int encodeForRendering(unsigned int toencode)</span>
<span class="lineNum">     206 </span>            : {
<span class="lineNum">     207 </span>            :   unsigned int encoded;
<span class="lineNum">     208 </span><span class="lineCov">          1 :   encoded = toencode + 32;</span>
<span class="lineNum">     209 </span>            :   /* 34 =&gt; &quot; */
<span class="lineNum">     210 </span><span class="lineCov">          1 :   if(encoded &gt;= 34) {</span>
<span class="lineNum">     211 </span><span class="lineCov">          1 :     encoded = encoded +1;</span>
<span class="lineNum">     212 </span>            :   }
<span class="lineNum">     213 </span>            :   /* 92 =&gt; \ */
<span class="lineNum">     214 </span><span class="lineCov">          1 :   if (encoded &gt;= 92) {</span>
<span class="lineNum">     215 </span><span class="lineNoCov">          0 :     encoded = encoded +1;</span>
<span class="lineNum">     216 </span>            :   }
<span class="lineNum">     217 </span><span class="lineCov">          1 :   return encoded;</span>
<span class="lineNum">     218 </span>            : }
<span class="lineNum">     219 </span>            : 
<span class="lineNum">     220 </span>            : /*
<a name="221"><span class="lineNum">     221 </span>            :  * Decode value to have the initial one</a>
<span class="lineNum">     222 </span>            :  */
<span class="lineNum">     223 </span><span class="lineCov">          1 : unsigned int decodeRendered(unsigned int todecode)</span>
<span class="lineNum">     224 </span>            : {
<span class="lineNum">     225 </span>            :   unsigned int decoded;
<span class="lineNum">     226 </span>            :   
<span class="lineNum">     227 </span><span class="lineCov">          1 :   if(todecode &gt;= 92)</span>
<span class="lineNum">     228 </span><span class="lineNoCov">          0 :     todecode --;</span>
<span class="lineNum">     229 </span>            : 
<span class="lineNum">     230 </span><span class="lineCov">          1 :   if(todecode &gt;= 34)</span>
<span class="lineNum">     231 </span><span class="lineCov">          1 :     todecode --;</span>
<span class="lineNum">     232 </span>            : 
<span class="lineNum">     233 </span><span class="lineCov">          1 :   decoded = todecode-32;</span>
<span class="lineNum">     234 </span>            : 
<span class="lineNum">     235 </span><span class="lineCov">          1 :   return decoded;</span>
<span class="lineNum">     236 </span>            : }
<span class="lineNum">     237 </span>            : 
<span class="lineNum">     238 </span>            : /*
<a name="239"><span class="lineNum">     239 </span>            :  * Allocate more memory to the table if necessary.</a>
<span class="lineNum">     240 </span>            :  */
<span class="lineNum">     241 </span><span class="lineCov">          1 : int growTable(lookupTable *data)</span>
<span class="lineNum">     242 </span>            : {
<span class="lineNum">     243 </span>            :   int i;
<span class="lineNum">     244 </span>            : 
<span class="lineNum">     245 </span><span class="lineCov">          1 :   data-&gt;table = (shapeData*) msSmallRealloc(data-&gt;table,sizeof(*data-&gt;table)*data-&gt;size*2);</span>
<span class="lineNum">     246 </span><span class="lineCov">          1 :   data-&gt;size = data-&gt;size*2;</span>
<span class="lineNum">     247 </span>            : 
<span class="lineNum">     248 </span><span class="lineCov">          1 :   for(i=data-&gt;counter; i&lt;data-&gt;size; i++)</span>
<span class="lineNum">     249 </span>            :   {
<span class="lineNum">     250 </span><span class="lineCov">          1 :     data-&gt;table[i].datavalues = NULL;</span>
<span class="lineNum">     251 </span><span class="lineCov">          1 :     data-&gt;table[i].itemvalue = NULL;</span>
<span class="lineNum">     252 </span><span class="lineCov">          1 :     data-&gt;table[i].utfvalue = 0;</span>
<span class="lineNum">     253 </span><span class="lineCov">          1 :     data-&gt;table[i].serialid = 0;</span>
<span class="lineNum">     254 </span>            :   }
<span class="lineNum">     255 </span><span class="lineCov">          1 :   return MS_SUCCESS;</span>
<span class="lineNum">     256 </span>            : }
<span class="lineNum">     257 </span>            : 
<span class="lineNum">     258 </span>            : /*
<a name="259"><span class="lineNum">     259 </span>            :  * Add the shapeObj UTFDATA and UTFITEM to the lookup table.</a>
<span class="lineNum">     260 </span>            :  */
<span class="lineNum">     261 </span><span class="lineCov">          1 : band_type addToTable(UTFGridRenderer *r, shapeObj *p)</span>
<span class="lineNum">     262 </span>            : {
<span class="lineNum">     263 </span>            :   band_type utfvalue;
<span class="lineNum">     264 </span>            : 
<span class="lineNum">     265 </span>            :   /* Looks for duplicates. */
<span class="lineNum">     266 </span><span class="lineCov">          1 :   if(r-&gt;duplicates==0 &amp;&amp; r-&gt;useutfitem==1) {</span>
<span class="lineNum">     267 </span>            :     int i;
<span class="lineNum">     268 </span><span class="lineNoCov">          0 :     for(i=0; i&lt;r-&gt;data-&gt;counter; i++) {</span>
<span class="lineNum">     269 </span><span class="lineNoCov">          0 :       if(!strcmp(p-&gt;values[r-&gt;utflayer-&gt;utfitemindex],r-&gt;data-&gt;table[i].itemvalue)) {</span>
<span class="lineNum">     270 </span>            :         /* Found a copy of the values in the table. */
<span class="lineNum">     271 </span><span class="lineNoCov">          0 :         utfvalue = r-&gt;data-&gt;table[i].utfvalue;</span>
<span class="lineNum">     272 </span>            : 
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :         return utfvalue;</span>
<span class="lineNum">     274 </span>            :       }
<span class="lineNum">     275 </span>            :     }
<span class="lineNum">     276 </span>            :   }
<span class="lineNum">     277 </span>            : 
<span class="lineNum">     278 </span>            :   /* Grow size of table if necessary */
<span class="lineNum">     279 </span><span class="lineCov">          1 :   if(r-&gt;data-&gt;size == r-&gt;data-&gt;counter)</span>
<span class="lineNum">     280 </span><span class="lineCov">          1 :     growTable(r-&gt;data);</span>
<span class="lineNum">     281 </span>            : 
<span class="lineNum">     282 </span><span class="lineCov">          1 :   utfvalue = (r-&gt;data-&gt;counter+1);</span>
<span class="lineNum">     283 </span>            : 
<span class="lineNum">     284 </span>            :   /* Simple operation so we don't have unavailable char in the JSON */
<span class="lineNum">     285 </span><span class="lineCov">          1 :   utfvalue = encodeForRendering(utfvalue);</span>
<span class="lineNum">     286 </span>            : 
<span class="lineNum">     287 </span>            :   /* Data added to the table */
<span class="lineNum">     288 </span><span class="lineCov">          1 :   r-&gt;data-&gt;table[r-&gt;data-&gt;counter].datavalues = msEvalTextExpressionJSonEscape(&amp;r-&gt;utflayer-&gt;utfdata, p);</span>
<span class="lineNum">     289 </span>            : 
<span class="lineNum">     290 </span>            :   /* If UTFITEM is set in the mapfile we add its value to the table */
<span class="lineNum">     291 </span><span class="lineCov">          1 :   if(r-&gt;useutfitem)</span>
<span class="lineNum">     292 </span><span class="lineCov">          1 :     r-&gt;data-&gt;table[r-&gt;data-&gt;counter].itemvalue =  msStrdup(p-&gt;values[r-&gt;utflayer-&gt;utfitemindex]);</span>
<span class="lineNum">     293 </span>            : 
<span class="lineNum">     294 </span><span class="lineCov">          1 :   r-&gt;data-&gt;table[r-&gt;data-&gt;counter].serialid = r-&gt;data-&gt;counter+1;</span>
<span class="lineNum">     295 </span>            : 
<span class="lineNum">     296 </span><span class="lineCov">          1 :   r-&gt;data-&gt;table[r-&gt;data-&gt;counter].utfvalue = utfvalue;</span>
<span class="lineNum">     297 </span>            : 
<span class="lineNum">     298 </span><span class="lineCov">          1 :   r-&gt;data-&gt;counter++;</span>
<span class="lineNum">     299 </span>            : 
<span class="lineNum">     300 </span><span class="lineCov">          1 :   return utfvalue;</span>
<span class="lineNum">     301 </span>            : }
<span class="lineNum">     302 </span>            : 
<span class="lineNum">     303 </span>            : /*
<span class="lineNum">     304 </span>            :  * Use AGG to render any path.
<a name="305"><span class="lineNum">     305 </span>            :  */</a>
<span class="lineNum">     306 </span>            : template&lt;class vertex_source&gt;
<span class="lineNum">     307 </span><span class="lineCov">          1 : int utfgridRenderPath(imageObj *img, vertex_source &amp;path)</span>
<span class="lineNum">     308 </span>            : {
<span class="lineNum">     309 </span><span class="lineCov">          1 :   UTFGridRenderer *r = UTFGRID_RENDERER(img);</span>
<span class="lineNum">     310 </span><span class="lineCov">          1 :   r-&gt;m_rasterizer.reset();</span>
<span class="lineNum">     311 </span>            :   r-&gt;m_rasterizer.filling_rule(mapserver::fill_even_odd);
<span class="lineNum">     312 </span><span class="lineCov">          1 :   r-&gt;m_rasterizer.add_path(path);</span>
<span class="lineNum">     313 </span><span class="lineCov">          1 :   r-&gt;m_renderer_scanline.color(utfitem(r-&gt;utfvalue));</span>
<span class="lineNum">     314 </span><span class="lineCov">          1 :   mapserver::render_scanlines(r-&gt;m_rasterizer, r-&gt;sl_utf, r-&gt;m_renderer_scanline);</span>
<span class="lineNum">     315 </span><span class="lineCov">          1 :   return MS_SUCCESS;</span>
<span class="lineNum">     316 </span>            : }
<span class="lineNum">     317 </span>            : 
<span class="lineNum">     318 </span>            : /*
<a name="319"><span class="lineNum">     319 </span>            :  * Initialize the renderer, create buffer, allocate memory.</a>
<span class="lineNum">     320 </span>            :  */
<span class="lineNum">     321 </span><span class="lineCov">          1 : imageObj *utfgridCreateImage(int width, int height, outputFormatObj *format, colorObj * bg)</span>
<span class="lineNum">     322 </span>            : {
<span class="lineNum">     323 </span>            :   UTFGridRenderer *r;
<span class="lineNum">     324 </span><span class="lineCov">          1 :   r = new UTFGridRenderer;</span>
<span class="lineNum">     325 </span>            : 
<span class="lineNum">     326 </span><span class="lineCov">          1 :   r-&gt;data = new lookupTable;</span>
<span class="lineNum">     327 </span>            : 
<span class="lineNum">     328 </span><span class="lineCov">          1 :   r-&gt;utfresolution = atof(msGetOutputFormatOption(format, &quot;UTFRESOLUTION&quot;, &quot;4&quot;));</span>
<span class="lineNum">     329 </span><span class="lineCov">          1 :   if(r-&gt;utfresolution &lt; 1) {</span>
<span class="lineNum">     330 </span><span class="lineNoCov">          0 :     msSetError(MS_MISCERR, &quot;UTFRESOLUTION smaller that 1 in the mapfile.&quot;, &quot;utfgridCreateImage()&quot;);</span>
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :     return NULL;</span>
<span class="lineNum">     332 </span>            :   }
<span class="lineNum">     333 </span>            : 
<span class="lineNum">     334 </span><span class="lineCov">          1 :   r-&gt;layerwatch = 0;</span>
<span class="lineNum">     335 </span>            : 
<span class="lineNum">     336 </span><span class="lineCov">          1 :   r-&gt;renderlayer = 0;</span>
<span class="lineNum">     337 </span>            : 
<span class="lineNum">     338 </span><span class="lineCov">          1 :   r-&gt;useutfitem = 0;</span>
<span class="lineNum">     339 </span>            : 
<span class="lineNum">     340 </span><span class="lineCov">          1 :   r-&gt;useutfdata = 0;</span>
<span class="lineNum">     341 </span>            : 
<span class="lineNum">     342 </span><span class="lineCov">          1 :   r-&gt;duplicates = EQUAL(&quot;true&quot;, msGetOutputFormatOption(format, &quot;DUPLICATES&quot;, &quot;true&quot;));</span>
<span class="lineNum">     343 </span>            : 
<span class="lineNum">     344 </span><span class="lineCov">          1 :   r-&gt;utfvalue = 0;</span>
<span class="lineNum">     345 </span>            : 
<span class="lineNum">     346 </span><span class="lineCov">          1 :   r-&gt;buffer = (band_type*)msSmallMalloc(width/r-&gt;utfresolution * height/r-&gt;utfresolution * sizeof(band_type));</span>
<span class="lineNum">     347 </span>            : 
<span class="lineNum">     348 </span>            :   /* AGG specific operations */
<span class="lineNum">     349 </span><span class="lineCov">          1 :   r-&gt;m_rendering_buffer.attach(r-&gt;buffer, width/r-&gt;utfresolution, height/r-&gt;utfresolution, width/r-&gt;utfresolution);</span>
<span class="lineNum">     350 </span>            :   r-&gt;m_pixel_format.attach(r-&gt;m_rendering_buffer);
<span class="lineNum">     351 </span><span class="lineCov">          1 :   r-&gt;m_renderer_base.attach(r-&gt;m_pixel_format);</span>
<span class="lineNum">     352 </span>            :   r-&gt;m_renderer_scanline.attach(r-&gt;m_renderer_base);
<span class="lineNum">     353 </span><span class="lineCov">          1 :   r-&gt;m_renderer_base.clear(UTF_WATER);</span>
<span class="lineNum">     354 </span>            :   r-&gt;m_rasterizer.gamma(mapserver::gamma_none());
<span class="lineNum">     355 </span>            : 
<span class="lineNum">     356 </span><span class="lineCov">          1 :   r-&gt;utflayer = NULL;</span>
<span class="lineNum">     357 </span>            : 
<span class="lineNum">     358 </span>            :   imageObj *image = NULL;
<span class="lineNum">     359 </span><span class="lineCov">          1 :   image = (imageObj *) msSmallCalloc(1,sizeof(imageObj));</span>
<span class="lineNum">     360 </span><span class="lineCov">          1 :   image-&gt;img.plugin = (void*) r;</span>
<span class="lineNum">     361 </span>            : 
<span class="lineNum">     362 </span><span class="lineCov">          1 :   return image;</span>
<span class="lineNum">     363 </span>            : }
<span class="lineNum">     364 </span>            : 
<span class="lineNum">     365 </span>            : /*
<a name="366"><span class="lineNum">     366 </span>            :  * Free all the memory used by the renderer.</a>
<span class="lineNum">     367 </span>            :  */
<span class="lineNum">     368 </span><span class="lineCov">          1 : int utfgridFreeImage(imageObj *img)</span>
<span class="lineNum">     369 </span>            : {
<span class="lineNum">     370 </span><span class="lineCov">          1 :   UTFGridRenderer *r = UTFGRID_RENDERER(img);</span>
<span class="lineNum">     371 </span>            : 
<span class="lineNum">     372 </span><span class="lineCov">          1 :   msFree(r-&gt;buffer);</span>
<span class="lineNum">     373 </span><span class="lineCov">          1 :   delete r;</span>
<span class="lineNum">     374 </span>            : 
<span class="lineNum">     375 </span><span class="lineCov">          1 :   img-&gt;img.plugin = NULL;</span>
<span class="lineNum">     376 </span>            : 
<span class="lineNum">     377 </span><span class="lineCov">          1 :   return MS_SUCCESS;</span>
<span class="lineNum">     378 </span>            : }
<span class="lineNum">     379 </span>            : 
<span class="lineNum">     380 </span>            : /*
<span class="lineNum">     381 </span>            :  * Update a character in the utfgrid.
<a name="382"><span class="lineNum">     382 </span>            : */</a>
<span class="lineNum">     383 </span>            : 
<span class="lineNum">     384 </span><span class="lineCov">          1 : int utfgridUpdateChar(imageObj *img, band_type oldChar, band_type newChar)</span>
<span class="lineNum">     385 </span>            : {
<span class="lineNum">     386 </span><span class="lineCov">          1 :   UTFGridRenderer *r = UTFGRID_RENDERER(img);</span>
<span class="lineNum">     387 </span>            :   int i,bufferLength;
<span class="lineNum">     388 </span>            : 
<span class="lineNum">     389 </span><span class="lineCov">          1 :   bufferLength = (img-&gt;height/r-&gt;utfresolution) * (img-&gt;width/r-&gt;utfresolution);</span>
<span class="lineNum">     390 </span>            : 
<span class="lineNum">     391 </span><span class="lineCov">          1 :   for(i=0;i&lt;bufferLength;i++){</span>
<span class="lineNum">     392 </span><span class="lineCov">          1 :     if(r-&gt;buffer[i] == oldChar)</span>
<span class="lineNum">     393 </span><span class="lineCov">          1 :       r-&gt;buffer[i] = newChar;</span>
<span class="lineNum">     394 </span>            :   }
<span class="lineNum">     395 </span>            : 
<span class="lineNum">     396 </span><span class="lineCov">          1 :   return MS_SUCCESS;</span>
<span class="lineNum">     397 </span>            : }
<span class="lineNum">     398 </span>            : 
<span class="lineNum">     399 </span>            : /*
<span class="lineNum">     400 </span>            :  * Remove unnecessary data that didn't made it to the final grid.
<a name="401"><span class="lineNum">     401 </span>            :  */</a>
<span class="lineNum">     402 </span>            : 
<span class="lineNum">     403 </span><span class="lineCov">          1 : int utfgridCleanData(imageObj *img)</span>
<span class="lineNum">     404 </span>            : {
<span class="lineNum">     405 </span><span class="lineCov">          1 :   UTFGridRenderer *r = UTFGRID_RENDERER(img);</span>
<span class="lineNum">     406 </span>            :   unsigned char* usedChar;
<span class="lineNum">     407 </span>            :   int i,bufferLength,itemFound,dataCounter;
<span class="lineNum">     408 </span>            :   shapeData* updatedData;
<span class="lineNum">     409 </span>            :   band_type utfvalue;
<span class="lineNum">     410 </span>            : 
<span class="lineNum">     411 </span><span class="lineCov">          1 :   bufferLength = (img-&gt;height/r-&gt;utfresolution) * (img-&gt;width/r-&gt;utfresolution);</span>
<span class="lineNum">     412 </span>            : 
<span class="lineNum">     413 </span><span class="lineCov">          1 :   usedChar =(unsigned char*) msSmallMalloc(r-&gt;data-&gt;counter*sizeof(unsigned char));</span>
<span class="lineNum">     414 </span>            : 
<span class="lineNum">     415 </span><span class="lineCov">          1 :   for(i=0;i&lt;r-&gt;data-&gt;counter;i++){</span>
<span class="lineNum">     416 </span><span class="lineCov">          1 :     usedChar[i]=0;</span>
<span class="lineNum">     417 </span>            :   }
<span class="lineNum">     418 </span>            : 
<span class="lineNum">     419 </span>            :   itemFound=0;
<span class="lineNum">     420 </span>            : 
<span class="lineNum">     421 </span><span class="lineCov">          1 :   for(i=0;i&lt;bufferLength;i++)</span>
<span class="lineNum">     422 </span>            :   {
<span class="lineNum">     423 </span><span class="lineCov">          1 :     if(decodeRendered(r-&gt;buffer[i]) != 0 &amp;&amp; usedChar[decodeRendered(r-&gt;buffer[i])-1]==0)</span>
<span class="lineNum">     424 </span>            :     {
<span class="lineNum">     425 </span><span class="lineCov">          1 :       itemFound++;</span>
<span class="lineNum">     426 </span><span class="lineCov">          1 :       usedChar[decodeRendered(r-&gt;buffer[i])-1] = 1;</span>
<span class="lineNum">     427 </span>            :     }
<span class="lineNum">     428 </span>            :   }
<span class="lineNum">     429 </span>            : 
<span class="lineNum">     430 </span><span class="lineCov">          1 :   updatedData = (shapeData*) msSmallMalloc(itemFound * sizeof(shapeData));</span>
<span class="lineNum">     431 </span>            :   dataCounter = 0;
<span class="lineNum">     432 </span>            : 
<span class="lineNum">     433 </span><span class="lineCov">          1 :   for(i=0; i&lt; r-&gt;data-&gt;counter; i++){</span>
<span class="lineNum">     434 </span><span class="lineCov">          1 :     if(usedChar[decodeRendered(r-&gt;data-&gt;table[i].utfvalue)-1]==1){</span>
<span class="lineNum">     435 </span><span class="lineCov">          1 :         updatedData[dataCounter] = r-&gt;data-&gt;table[i];</span>
<span class="lineNum">     436 </span>            : 
<span class="lineNum">     437 </span><span class="lineCov">          1 :         updatedData[dataCounter].serialid=dataCounter+1;</span>
<span class="lineNum">     438 </span>            : 
<span class="lineNum">     439 </span><span class="lineCov">          1 :         utfvalue=encodeForRendering(dataCounter+1);</span>
<span class="lineNum">     440 </span>            : 
<span class="lineNum">     441 </span><span class="lineCov">          1 :         utfgridUpdateChar(img,updatedData[dataCounter].utfvalue,utfvalue);</span>
<span class="lineNum">     442 </span><span class="lineCov">          1 :         updatedData[dataCounter].utfvalue = utfvalue;</span>
<span class="lineNum">     443 </span>            : 
<span class="lineNum">     444 </span>            :       dataCounter++;
<span class="lineNum">     445 </span>            :     }
<span class="lineNum">     446 </span>            :     else {
<span class="lineNum">     447 </span><span class="lineNoCov">          0 :       if(r-&gt;data-&gt;table[i].datavalues)</span>
<span class="lineNum">     448 </span><span class="lineNoCov">          0 :         msFree(r-&gt;data-&gt;table[i].datavalues);</span>
<span class="lineNum">     449 </span><span class="lineNoCov">          0 :       if(r-&gt;data-&gt;table[i].itemvalue)</span>
<span class="lineNum">     450 </span><span class="lineNoCov">          0 :         msFree(r-&gt;data-&gt;table[i].itemvalue);</span>
<span class="lineNum">     451 </span>            :     }
<span class="lineNum">     452 </span>            :   }
<span class="lineNum">     453 </span>            : 
<span class="lineNum">     454 </span><span class="lineCov">          1 :   msFree(usedChar);</span>
<span class="lineNum">     455 </span>            : 
<span class="lineNum">     456 </span><span class="lineCov">          1 :   msFree(r-&gt;data-&gt;table);</span>
<span class="lineNum">     457 </span>            : 
<span class="lineNum">     458 </span><span class="lineCov">          1 :   r-&gt;data-&gt;table = updatedData;</span>
<span class="lineNum">     459 </span><span class="lineCov">          1 :   r-&gt;data-&gt;counter = dataCounter;</span>
<span class="lineNum">     460 </span><span class="lineCov">          1 :   r-&gt;data-&gt;size = dataCounter;</span>
<span class="lineNum">     461 </span>            : 
<span class="lineNum">     462 </span><span class="lineCov">          1 :   return MS_SUCCESS;</span>
<span class="lineNum">     463 </span>            : }
<span class="lineNum">     464 </span>            : 
<span class="lineNum">     465 </span>            : /*
<a name="466"><span class="lineNum">     466 </span>            :  * Print the renderer data as JSON.</a>
<span class="lineNum">     467 </span>            :  */
<span class="lineNum">     468 </span><span class="lineCov">          1 : int utfgridSaveImage(imageObj *img, mapObj *map, FILE *fp, outputFormatObj *format)</span>
<span class="lineNum">     469 </span>            : {
<span class="lineNum">     470 </span>            :   int row, col, i, imgheight, imgwidth;
<span class="lineNum">     471 </span>            :   band_type pixelid;
<span class="lineNum">     472 </span>            :   char* pszEscaped;
<span class="lineNum">     473 </span>            : 
<span class="lineNum">     474 </span><span class="lineCov">          1 :   utfgridCleanData(img);</span>
<span class="lineNum">     475 </span>            : 
<span class="lineNum">     476 </span><span class="lineCov">          1 :   UTFGridRenderer *renderer = UTFGRID_RENDERER(img);</span>
<span class="lineNum">     477 </span>            : 
<span class="lineNum">     478 </span><span class="lineCov">          1 :   if(renderer-&gt;layerwatch&gt;1)</span>
<span class="lineNum">     479 </span>            :     return MS_FAILURE;
<span class="lineNum">     480 </span>            : 
<span class="lineNum">     481 </span><span class="lineCov">          1 :   imgheight = img-&gt;height/renderer-&gt;utfresolution;</span>
<span class="lineNum">     482 </span><span class="lineCov">          1 :   imgwidth = img-&gt;width/renderer-&gt;utfresolution;</span>
<span class="lineNum">     483 </span>            : 
<span class="lineNum">     484 </span><span class="lineCov">          1 :   msIO_fprintf(fp,&quot;{\&quot;grid\&quot;:[&quot;);</span>
<span class="lineNum">     485 </span>            : 
<span class="lineNum">     486 </span>            :   /* Print the buffer */
<span class="lineNum">     487 </span><span class="lineCov">          1 :   for(row=0; row&lt;imgheight; row++) {</span>
<span class="lineNum">     488 </span>            : 
<span class="lineNum">     489 </span><span class="lineCov">          1 :     wchar_t *string = (wchar_t*) msSmallMalloc ((imgwidth + 1) * sizeof(wchar_t));</span>
<span class="lineNum">     490 </span>            :     wchar_t *stringptr;
<span class="lineNum">     491 </span>            :     stringptr = string;
<span class="lineNum">     492 </span>            :     /* Need a comma between each line but JSON must not start with a comma. */
<span class="lineNum">     493 </span><span class="lineCov">          1 :     if(row!=0)</span>
<span class="lineNum">     494 </span><span class="lineCov">          1 :       msIO_fprintf(fp,&quot;,&quot;);</span>
<span class="lineNum">     495 </span><span class="lineCov">          1 :     msIO_fprintf(fp,&quot;\&quot;&quot;);</span>
<span class="lineNum">     496 </span><span class="lineCov">          1 :     for(col=0; col&lt;img-&gt;width/renderer-&gt;utfresolution; col++) {</span>
<span class="lineNum">     497 </span>            :       /* Get the data from buffer. */
<span class="lineNum">     498 </span><span class="lineCov">          1 :       pixelid = renderer-&gt;buffer[(row*imgwidth)+col];</span>
<span class="lineNum">     499 </span>            : 
<span class="lineNum">     500 </span><span class="lineCov">          1 :       *stringptr = pixelid;</span>
<span class="lineNum">     501 </span><span class="lineCov">          1 :       stringptr++;</span>
<span class="lineNum">     502 </span>            :     }
<span class="lineNum">     503 </span>            : 
<span class="lineNum">     504 </span>            :     /* Conversion to UTF-8 encoding */
<span class="lineNum">     505 </span><span class="lineCov">          1 :     *stringptr = '\0';</span>
<span class="lineNum">     506 </span>            :     char * utf8;
<span class="lineNum">     507 </span>            : #if defined(_WIN32) &amp;&amp; !defined(__CYGWIN__)
<span class="lineNum">     508 </span>            :   const char* encoding = &quot;UCS-2LE&quot;;
<span class="lineNum">     509 </span>            : #else
<span class="lineNum">     510 </span>            :   const char* encoding = &quot;UCS-4LE&quot;;
<span class="lineNum">     511 </span>            : #endif
<span class="lineNum">     512 </span>            : 
<span class="lineNum">     513 </span><span class="lineCov">          1 :     utf8 = msConvertWideStringToUTF8(string, encoding);</span>
<span class="lineNum">     514 </span><span class="lineCov">          1 :     msIO_fprintf(fp,&quot;%s&quot;, utf8);</span>
<span class="lineNum">     515 </span><span class="lineCov">          1 :     msFree(utf8);</span>
<span class="lineNum">     516 </span><span class="lineCov">          1 :     msFree(string);</span>
<span class="lineNum">     517 </span><span class="lineCov">          1 :     msIO_fprintf(fp,&quot;\&quot;&quot;);</span>
<span class="lineNum">     518 </span>            :   }
<span class="lineNum">     519 </span>            : 
<span class="lineNum">     520 </span><span class="lineCov">          1 :   msIO_fprintf(fp,&quot;],\&quot;keys\&quot;:[\&quot;\&quot;&quot;);</span>
<span class="lineNum">     521 </span>            : 
<span class="lineNum">     522 </span>            :   /* Print the specified key */
<span class="lineNum">     523 </span><span class="lineCov">          1 :   for(i=0;i&lt;renderer-&gt;data-&gt;counter;i++) {</span>
<span class="lineNum">     524 </span><span class="lineCov">          1 :       msIO_fprintf(fp,&quot;,&quot;);</span>
<span class="lineNum">     525 </span>            : 
<span class="lineNum">     526 </span><span class="lineCov">          1 :     if(renderer-&gt;useutfitem)</span>
<span class="lineNum">     527 </span>            :     {
<span class="lineNum">     528 </span><span class="lineCov">          1 :       pszEscaped = msEscapeJSonString(renderer-&gt;data-&gt;table[i].itemvalue);</span>
<span class="lineNum">     529 </span><span class="lineCov">          1 :       msIO_fprintf(fp,&quot;\&quot;%s\&quot;&quot;, pszEscaped);</span>
<span class="lineNum">     530 </span><span class="lineCov">          1 :       msFree(pszEscaped);</span>
<span class="lineNum">     531 </span>            :     }
<span class="lineNum">     532 </span>            :     /* If no UTFITEM specified use the serial ID as the key */
<span class="lineNum">     533 </span>            :     else
<span class="lineNum">     534 </span><span class="lineCov">          1 :       msIO_fprintf(fp,&quot;\&quot;%i\&quot;&quot;, renderer-&gt;data-&gt;table[i].serialid);</span>
<span class="lineNum">     535 </span>            :   }
<span class="lineNum">     536 </span>            : 
<span class="lineNum">     537 </span><span class="lineCov">          1 :   msIO_fprintf(fp,&quot;],\&quot;data\&quot;:{&quot;);</span>
<span class="lineNum">     538 </span>            : 
<span class="lineNum">     539 </span>            :   /* Print the data */
<span class="lineNum">     540 </span><span class="lineCov">          1 :   if(renderer-&gt;useutfdata) {</span>
<span class="lineNum">     541 </span><span class="lineCov">          1 :     for(i=0;i&lt;renderer-&gt;data-&gt;counter;i++) {</span>
<span class="lineNum">     542 </span><span class="lineCov">          1 :       if(i!=0)</span>
<span class="lineNum">     543 </span><span class="lineCov">          1 :         msIO_fprintf(fp,&quot;,&quot;);</span>
<span class="lineNum">     544 </span>            : 
<span class="lineNum">     545 </span><span class="lineCov">          1 :       if(renderer-&gt;useutfitem)</span>
<span class="lineNum">     546 </span>            :       {
<span class="lineNum">     547 </span><span class="lineCov">          1 :         pszEscaped = msEscapeJSonString(renderer-&gt;data-&gt;table[i].itemvalue);</span>
<span class="lineNum">     548 </span><span class="lineCov">          1 :         msIO_fprintf(fp,&quot;\&quot;%s\&quot;:&quot;, pszEscaped);</span>
<span class="lineNum">     549 </span><span class="lineCov">          1 :         msFree(pszEscaped);</span>
<span class="lineNum">     550 </span>            :       }
<span class="lineNum">     551 </span>            :       /* If no UTFITEM specified use the serial ID as the key */
<span class="lineNum">     552 </span>            :       else
<span class="lineNum">     553 </span><span class="lineNoCov">          0 :         msIO_fprintf(fp,&quot;\&quot;%i\&quot;:&quot;, renderer-&gt;data-&gt;table[i].serialid);</span>
<span class="lineNum">     554 </span>            : 
<span class="lineNum">     555 </span><span class="lineCov">          1 :       msIO_fprintf(fp,&quot;%s&quot;, renderer-&gt;data-&gt;table[i].datavalues);</span>
<span class="lineNum">     556 </span>            :     }
<span class="lineNum">     557 </span>            :   }
<span class="lineNum">     558 </span><span class="lineCov">          1 :   msIO_fprintf(fp,&quot;}}&quot;);</span>
<span class="lineNum">     559 </span>            : 
<span class="lineNum">     560 </span><span class="lineCov">          1 :   return MS_SUCCESS;</span>
<span class="lineNum">     561 </span>            : }
<span class="lineNum">     562 </span>            : 
<span class="lineNum">     563 </span>            : /*
<a name="564"><span class="lineNum">     564 </span>            :  * Starts a layer for UTFGrid renderer.</a>
<span class="lineNum">     565 </span>            :  */
<span class="lineNum">     566 </span><span class="lineCov">          1 : int utfgridStartLayer(imageObj *img, mapObj *map, layerObj *layer)</span>
<span class="lineNum">     567 </span>            : {
<span class="lineNum">     568 </span><span class="lineCov">          1 :   UTFGridRenderer *r = UTFGRID_RENDERER(img);</span>
<span class="lineNum">     569 </span>            : 
<span class="lineNum">     570 </span>            :   /* Look if the layer uses the UTFGrid output format */
<span class="lineNum">     571 </span><span class="lineCov">          1 :   if(layer-&gt;utfdata.string!=0) {</span>
<span class="lineNum">     572 </span><span class="lineCov">          1 :     r-&gt;useutfdata = 1;</span>
<span class="lineNum">     573 </span>            :   }
<span class="lineNum">     574 </span>            : 
<span class="lineNum">     575 </span>            :     /* layerwatch is set to 1 on first layer treated. Doesn't allow multiple layers. */
<span class="lineNum">     576 </span><span class="lineCov">          1 :     if(!r-&gt;layerwatch) {</span>
<span class="lineNum">     577 </span><span class="lineCov">          1 :       r-&gt;layerwatch++;</span>
<span class="lineNum">     578 </span>            : 
<span class="lineNum">     579 </span><span class="lineCov">          1 :       r-&gt;renderlayer = 1;</span>
<span class="lineNum">     580 </span><span class="lineCov">          1 :       r-&gt;utflayer = layer;</span>
<span class="lineNum">     581 </span><span class="lineCov">          1 :       layer-&gt;refcount++;</span>
<span class="lineNum">     582 </span>            : 
<span class="lineNum">     583 </span>            :       /* Verify if renderer needs to use UTFITEM */
<span class="lineNum">     584 </span><span class="lineCov">          1 :       if(r-&gt;utflayer-&gt;utfitem)</span>
<span class="lineNum">     585 </span><span class="lineCov">          1 :         r-&gt;useutfitem = 1;</span>
<span class="lineNum">     586 </span>            :     }
<span class="lineNum">     587 </span>            :     /* If multiple layers, send error */
<span class="lineNum">     588 </span>            :     else {
<span class="lineNum">     589 </span><span class="lineNoCov">          0 :       r-&gt;layerwatch++;</span>
<span class="lineNum">     590 </span><span class="lineNoCov">          0 :       msSetError(MS_MISCERR, &quot;MapServer does not support multiple UTFGrid layers rendering simultaneously.&quot;, &quot;utfgridStartLayer()&quot;);</span>
<span class="lineNum">     591 </span><span class="lineNoCov">          0 :       return MS_FAILURE;</span>
<span class="lineNum">     592 </span>            :     }
<span class="lineNum">     593 </span>            : 
<span class="lineNum">     594 </span>            :   return MS_SUCCESS;
<span class="lineNum">     595 </span>            : }
<span class="lineNum">     596 </span>            : 
<span class="lineNum">     597 </span>            : /*
<a name="598"><span class="lineNum">     598 </span>            :  * Tell renderer the layer is done.</a>
<span class="lineNum">     599 </span>            :  */
<span class="lineNum">     600 </span><span class="lineCov">          1 : int utfgridEndLayer(imageObj *img, mapObj *map, layerObj *layer)</span>
<span class="lineNum">     601 </span>            : {
<span class="lineNum">     602 </span><span class="lineCov">          1 :   UTFGridRenderer *r = UTFGRID_RENDERER(img);</span>
<span class="lineNum">     603 </span>            : 
<span class="lineNum">     604 </span>            :   /* Look if the layer was rendered, if it was then turn off rendering. */
<span class="lineNum">     605 </span><span class="lineCov">          1 :   if(r-&gt;renderlayer) {</span>
<span class="lineNum">     606 </span><span class="lineCov">          1 :     r-&gt;utflayer = NULL;</span>
<span class="lineNum">     607 </span><span class="lineCov">          1 :     layer-&gt;refcount--;</span>
<span class="lineNum">     608 </span><span class="lineCov">          1 :     r-&gt;renderlayer = 0;</span>
<span class="lineNum">     609 </span>            :   }
<span class="lineNum">     610 </span>            : 
<span class="lineNum">     611 </span><span class="lineCov">          1 :   return MS_SUCCESS;</span>
<span class="lineNum">     612 </span>            : }
<span class="lineNum">     613 </span>            : 
<span class="lineNum">     614 </span>            : /*
<a name="615"><span class="lineNum">     615 </span>            :  * Do the table operations on the shapes. Allow multiple types of data to be rendered.</a>
<span class="lineNum">     616 </span>            :  */
<span class="lineNum">     617 </span><span class="lineCov">          1 : int utfgridStartShape(imageObj *img, shapeObj *shape)</span>
<span class="lineNum">     618 </span>            : {
<span class="lineNum">     619 </span><span class="lineCov">          1 :   UTFGridRenderer *r = UTFGRID_RENDERER(img);</span>
<span class="lineNum">     620 </span>            : 
<span class="lineNum">     621 </span><span class="lineCov">          1 :   if(!r-&gt;renderlayer)</span>
<span class="lineNum">     622 </span>            :     return MS_FAILURE;
<span class="lineNum">     623 </span>            : 
<span class="lineNum">     624 </span>            :   /* Table operations */
<span class="lineNum">     625 </span><span class="lineCov">          1 :   r-&gt;utfvalue = addToTable(r, shape);</span>
<span class="lineNum">     626 </span>            : 
<span class="lineNum">     627 </span><span class="lineCov">          1 :   return MS_SUCCESS;</span>
<span class="lineNum">     628 </span>            : }
<span class="lineNum">     629 </span>            : 
<span class="lineNum">     630 </span>            : /*
<a name="631"><span class="lineNum">     631 </span>            :  * Tells the renderer that the shape's rendering is done.</a>
<span class="lineNum">     632 </span>            :  */
<span class="lineNum">     633 </span><span class="lineCov">          1 : int utfgridEndShape(imageObj *img, shapeObj *shape)</span>
<span class="lineNum">     634 </span>            : {
<span class="lineNum">     635 </span><span class="lineCov">          1 :   UTFGridRenderer *r = UTFGRID_RENDERER(img);</span>
<span class="lineNum">     636 </span>            : 
<span class="lineNum">     637 </span><span class="lineCov">          1 :   r-&gt;utfvalue = 0;</span>
<span class="lineNum">     638 </span><span class="lineCov">          1 :   return MS_SUCCESS;</span>
<span class="lineNum">     639 </span>            : }
<span class="lineNum">     640 </span>            : 
<span class="lineNum">     641 </span>            : /*
<a name="642"><span class="lineNum">     642 </span>            :  * Function that renders polygons into UTFGrid.</a>
<span class="lineNum">     643 </span>            :  */
<span class="lineNum">     644 </span><span class="lineCov">          1 : int utfgridRenderPolygon(imageObj *img, shapeObj *polygonshape, colorObj *color)</span>
<span class="lineNum">     645 </span>            : {
<span class="lineNum">     646 </span><span class="lineCov">          1 :   UTFGridRenderer *r = UTFGRID_RENDERER(img);</span>
<span class="lineNum">     647 </span>            : 
<span class="lineNum">     648 </span>            :   /* utfvalue is set to 0 if the shape isn't in the table. */
<span class="lineNum">     649 </span><span class="lineCov">          1 :   if(r-&gt;utfvalue == 0) {</span>
<span class="lineNum">     650 </span>            :     return MS_FAILURE;
<span class="lineNum">     651 </span>            :   }
<span class="lineNum">     652 </span>            : 
<span class="lineNum">     653 </span>            :   /* Render the polygon */
<span class="lineNum">     654 </span><span class="lineCov">          1 :   polygon_adaptor_utf polygons(polygonshape, r-&gt;utfresolution);</span>
<span class="lineNum">     655 </span><span class="lineCov">          1 :   utfgridRenderPath(img, polygons);</span>
<span class="lineNum">     656 </span>            : 
<span class="lineNum">     657 </span>            :   return MS_SUCCESS;
<span class="lineNum">     658 </span>            : }
<span class="lineNum">     659 </span>            : 
<span class="lineNum">     660 </span>            : /*
<span class="lineNum">     661 </span>            :  * Function that renders lines into UTFGrid. Starts by looking if the line is a polygon
<a name="662"><span class="lineNum">     662 </span>            :  * outline, draw it if it's not.</a>
<span class="lineNum">     663 </span>            :  */
<span class="lineNum">     664 </span><span class="lineCov">          1 : int utfgridRenderLine(imageObj *img, shapeObj *lineshape, strokeStyleObj *linestyle)</span>
<span class="lineNum">     665 </span>            : {
<span class="lineNum">     666 </span><span class="lineCov">          1 :   UTFGridRenderer *r = UTFGRID_RENDERER(img);</span>
<span class="lineNum">     667 </span>            : 
<span class="lineNum">     668 </span>            :   /* utfvalue is set to 0 if the shape isn't in the table. */
<span class="lineNum">     669 </span><span class="lineCov">          1 :   if(r-&gt;utfvalue == 0) {</span>
<span class="lineNum">     670 </span>            :     return MS_SUCCESS;
<span class="lineNum">     671 </span>            :     /* If we dont get a caracter to draw we just skip execution
<span class="lineNum">     672 </span>            :      * instead of failing
<span class="lineNum">     673 </span>            :      */
<span class="lineNum">     674 </span>            :   }
<span class="lineNum">     675 </span>            : 
<span class="lineNum">     676 </span>            :   /* Render the line */
<span class="lineNum">     677 </span><span class="lineCov">          1 :   line_adaptor_utf lines(lineshape, r-&gt;utfresolution);</span>
<span class="lineNum">     678 </span>            : 
<span class="lineNum">     679 </span><span class="lineCov">          1 :   if(!r-&gt;stroke) {</span>
<span class="lineNum">     680 </span><span class="lineCov">          1 :     r-&gt;stroke = new mapserver::conv_stroke&lt;line_adaptor_utf&gt;(lines);</span>
<span class="lineNum">     681 </span>            :   } else {
<span class="lineNum">     682 </span>            :     r-&gt;stroke-&gt;attach(lines);
<span class="lineNum">     683 </span>            :   }
<span class="lineNum">     684 </span><span class="lineCov">          1 :   r-&gt;stroke-&gt;width(linestyle-&gt;width/r-&gt;utfresolution);</span>
<span class="lineNum">     685 </span><span class="lineCov">          1 :   utfgridRenderPath(img, *r-&gt;stroke);</span>
<span class="lineNum">     686 </span>            : 
<span class="lineNum">     687 </span>            :   return MS_SUCCESS;
<span class="lineNum">     688 </span>            : }
<span class="lineNum">     689 </span>            : 
<span class="lineNum">     690 </span>            : /*
<a name="691"><span class="lineNum">     691 </span>            :  * Function that render vector type symbols into UTFGrid.</a>
<span class="lineNum">     692 </span>            :  */
<span class="lineNum">     693 </span><span class="lineCov">          1 : int utfgridRenderVectorSymbol(imageObj *img, double x, double y, symbolObj *symbol, symbolStyleObj * style)</span>
<span class="lineNum">     694 </span>            : {
<span class="lineNum">     695 </span><span class="lineCov">          1 :   UTFGridRenderer *r = UTFGRID_RENDERER(img);</span>
<span class="lineNum">     696 </span><span class="lineCov">          1 :   double ox = symbol-&gt;sizex * 0.5;</span>
<span class="lineNum">     697 </span><span class="lineCov">          1 :   double oy = symbol-&gt;sizey * 0.5;</span>
<span class="lineNum">     698 </span>            : 
<span class="lineNum">     699 </span>            :   /* utfvalue is set to 0 if the shape isn't in the table. */
<span class="lineNum">     700 </span><span class="lineCov">          1 :   if(r-&gt;utfvalue == 0) {</span>
<span class="lineNum">     701 </span>            :     return MS_FAILURE;
<span class="lineNum">     702 </span>            :   }
<span class="lineNum">     703 </span>            : 
<span class="lineNum">     704 </span>            :   /* Pathing the symbol */
<span class="lineNum">     705 </span><span class="lineCov">          1 :   mapserver::path_storage path = imageVectorSymbol(symbol);</span>
<span class="lineNum">     706 </span>            : 
<span class="lineNum">     707 </span>            :   /* Transformation to the right size/scale. */
<span class="lineNum">     708 </span>            :   mapserver::trans_affine mtx;
<span class="lineNum">     709 </span><span class="lineCov">          1 :   mtx *= mapserver::trans_affine_translation(-ox,-oy);</span>
<span class="lineNum">     710 </span><span class="lineCov">          1 :   mtx *= mapserver::trans_affine_scaling(style-&gt;scale/r-&gt;utfresolution);</span>
<span class="lineNum">     711 </span><span class="lineCov">          1 :   mtx *= mapserver::trans_affine_rotation(-style-&gt;rotation);</span>
<span class="lineNum">     712 </span><span class="lineCov">          1 :   mtx *= mapserver::trans_affine_translation(x/r-&gt;utfresolution, y/r-&gt;utfresolution);</span>
<span class="lineNum">     713 </span><span class="lineCov">          1 :   path.transform(mtx);</span>
<span class="lineNum">     714 </span>            : 
<span class="lineNum">     715 </span>            :   /* Rendering the symbol. */
<span class="lineNum">     716 </span><span class="lineCov">          1 :   utfgridRenderPath(img, path);</span>
<span class="lineNum">     717 </span>            : 
<span class="lineNum">     718 </span>            :   return MS_SUCCESS;
<span class="lineNum">     719 </span>            : }
<span class="lineNum">     720 </span>            : 
<span class="lineNum">     721 </span>            : /*
<a name="722"><span class="lineNum">     722 </span>            :  * Function that renders Pixmap type symbols into UTFGrid.</a>
<span class="lineNum">     723 </span>            :  */
<span class="lineNum">     724 </span><span class="lineCov">          1 : int utfgridRenderPixmapSymbol(imageObj *img, double x, double y, symbolObj *symbol, symbolStyleObj * style)</span>
<span class="lineNum">     725 </span>            : {
<span class="lineNum">     726 </span><span class="lineCov">          1 :   UTFGridRenderer *r = UTFGRID_RENDERER(img);</span>
<span class="lineNum">     727 </span><span class="lineCov">          1 :   rasterBufferObj *pixmap = symbol-&gt;pixmap_buffer;</span>
<span class="lineNum">     728 </span>            : 
<span class="lineNum">     729 </span>            :   /* utfvalue is set to 0 if the shape isn't in the table. */
<span class="lineNum">     730 </span><span class="lineCov">          1 :   if(r-&gt;utfvalue == 0) {</span>
<span class="lineNum">     731 </span>            :     return MS_FAILURE;
<span class="lineNum">     732 </span>            :   }
<span class="lineNum">     733 </span>            : 
<span class="lineNum">     734 </span>            :   /* Pathing the symbol BBox */
<span class="lineNum">     735 </span>            :   mapserver::path_storage pixmap_bbox;
<span class="lineNum">     736 </span>            :   double w, h;
<span class="lineNum">     737 </span><span class="lineCov">          1 :   w = pixmap-&gt;width*style-&gt;scale/(2.0);</span>
<span class="lineNum">     738 </span><span class="lineCov">          1 :   h= pixmap-&gt;height*style-&gt;scale/(2.0);</span>
<span class="lineNum">     739 </span><span class="lineCov">          1 :   pixmap_bbox.move_to((x-w)/r-&gt;utfresolution,(y-h)/r-&gt;utfresolution);</span>
<span class="lineNum">     740 </span><span class="lineCov">          1 :   pixmap_bbox.line_to((x+w)/r-&gt;utfresolution,(y-h)/r-&gt;utfresolution);</span>
<span class="lineNum">     741 </span><span class="lineCov">          1 :   pixmap_bbox.line_to((x+w)/r-&gt;utfresolution,(y+h)/r-&gt;utfresolution);</span>
<span class="lineNum">     742 </span><span class="lineCov">          1 :   pixmap_bbox.line_to((x-w)/r-&gt;utfresolution,(y+h)/r-&gt;utfresolution);</span>
<span class="lineNum">     743 </span>            : 
<span class="lineNum">     744 </span>            :   /* Rendering the symbol */
<span class="lineNum">     745 </span><span class="lineCov">          1 :   utfgridRenderPath(img, pixmap_bbox);</span>
<span class="lineNum">     746 </span>            : 
<span class="lineNum">     747 </span>            :   return MS_SUCCESS;
<span class="lineNum">     748 </span>            : }
<span class="lineNum">     749 </span>            : 
<span class="lineNum">     750 </span>            : /*
<a name="751"><span class="lineNum">     751 </span>            :  * Function that render ellipse type symbols into UTFGrid.</a>
<span class="lineNum">     752 </span>            :  */
<span class="lineNum">     753 </span><span class="lineCov">          1 : int utfgridRenderEllipseSymbol(imageObj *img, double x, double y, symbolObj *symbol, symbolStyleObj * style)</span>
<span class="lineNum">     754 </span>            : {
<span class="lineNum">     755 </span><span class="lineCov">          1 :   UTFGridRenderer *r = UTFGRID_RENDERER(img);</span>
<span class="lineNum">     756 </span>            : 
<span class="lineNum">     757 </span>            :   /* utfvalue is set to 0 if the shape isn't in the table. */
<span class="lineNum">     758 </span><span class="lineCov">          1 :   if(r-&gt;utfvalue == 0) {</span>
<span class="lineNum">     759 </span>            :     return MS_FAILURE;
<span class="lineNum">     760 </span>            :   }
<span class="lineNum">     761 </span>            : 
<span class="lineNum">     762 </span>            :   /* Pathing the symbol. */
<span class="lineNum">     763 </span>            :   mapserver::path_storage path;
<span class="lineNum">     764 </span><span class="lineCov">          1 :   mapserver::ellipse ellipse(x/r-&gt;utfresolution,y/r-&gt;utfresolution,symbol-&gt;sizex*style-&gt;scale/2/r-&gt;utfresolution,symbol-&gt;sizey*style-&gt;scale/2/r-&gt;utfresolution);</span>
<span class="lineNum">     765 </span><span class="lineCov">          1 :   path.concat_path(ellipse);</span>
<span class="lineNum">     766 </span>            : 
<span class="lineNum">     767 </span>            :   /* Rotation if necessary. */
<span class="lineNum">     768 </span><span class="lineCov">          1 :   if( style-&gt;rotation != 0) {</span>
<span class="lineNum">     769 </span>            :     mapserver::trans_affine mtx;
<span class="lineNum">     770 </span><span class="lineNoCov">          0 :     mtx *= mapserver::trans_affine_translation(-x/r-&gt;utfresolution,-y/r-&gt;utfresolution);</span>
<span class="lineNum">     771 </span><span class="lineNoCov">          0 :     mtx *= mapserver::trans_affine_rotation(-style-&gt;rotation);</span>
<span class="lineNum">     772 </span><span class="lineNoCov">          0 :     mtx *= mapserver::trans_affine_translation(x/r-&gt;utfresolution,y/r-&gt;utfresolution);</span>
<span class="lineNum">     773 </span><span class="lineNoCov">          0 :     path.transform(mtx);</span>
<span class="lineNum">     774 </span>            :   }
<span class="lineNum">     775 </span>            : 
<span class="lineNum">     776 </span>            :   /* Rendering the symbol. */
<span class="lineNum">     777 </span><span class="lineCov">          1 :   utfgridRenderPath(img, path);</span>
<span class="lineNum">     778 </span>            : 
<span class="lineNum">     779 </span>            :   return MS_SUCCESS;
<a name="780"><span class="lineNum">     780 </span>            : }</a>
<span class="lineNum">     781 </span>            : 
<span class="lineNum">     782 </span><span class="lineCov">          1 : int utfgridRenderGlyphs(imageObj *img, textPathObj *tp, colorObj *c, colorObj *oc, int ow, int isMarker) {</span>
<span class="lineNum">     783 </span>            : 
<span class="lineNum">     784 </span><span class="lineCov">          1 :   UTFGridRenderer *r = UTFGRID_RENDERER(img);</span>
<span class="lineNum">     785 </span>            : 
<span class="lineNum">     786 </span>            :   /* If it's not a marker then it's a label or other thing and we dont
<span class="lineNum">     787 </span>            :    *  want to draw it on the map
<span class="lineNum">     788 </span>            :    */
<span class="lineNum">     789 </span><span class="lineCov">          1 :   if(!isMarker) {</span>
<span class="lineNum">     790 </span>            :     return MS_SUCCESS; //Stop the rendering with no errors
<span class="lineNum">     791 </span>            :   }
<span class="lineNum">     792 </span>            : 
<span class="lineNum">     793 </span>            :   /* utfvalue is set to 0 if the shape isn't in the table. */
<span class="lineNum">     794 </span><span class="lineCov">          1 :   if(r-&gt;utfvalue == 0) {</span>
<span class="lineNum">     795 </span>            :     return MS_SUCCESS; //Stop the rendering with no errors
<span class="lineNum">     796 </span>            :   }
<span class="lineNum">     797 </span>            : 
<span class="lineNum">     798 </span>            :   /* Pathing the symbol BBox */
<span class="lineNum">     799 </span>            :   mapserver::path_storage box;
<span class="lineNum">     800 </span>            :   double size, x, y;
<span class="lineNum">     801 </span>            :   
<span class="lineNum">     802 </span><span class="lineCov">          1 :   size = tp-&gt;glyph_size;;</span>
<span class="lineNum">     803 </span><span class="lineCov">          1 :   x = tp-&gt;glyphs-&gt;pnt.x;</span>
<span class="lineNum">     804 </span><span class="lineCov">          1 :   y = tp-&gt;glyphs-&gt;pnt.y;</span>
<span class="lineNum">     805 </span>            :   
<span class="lineNum">     806 </span><span class="lineCov">          1 :   box.move_to((x)/r-&gt;utfresolution,(y)/r-&gt;utfresolution);</span>
<span class="lineNum">     807 </span><span class="lineCov">          1 :   box.line_to((x+size)/r-&gt;utfresolution,(y)/r-&gt;utfresolution);</span>
<span class="lineNum">     808 </span><span class="lineCov">          1 :   box.line_to((x+size)/r-&gt;utfresolution,(y-size)/r-&gt;utfresolution);</span>
<span class="lineNum">     809 </span><span class="lineCov">          1 :   box.line_to((x)/r-&gt;utfresolution,(y-size)/r-&gt;utfresolution);</span>
<span class="lineNum">     810 </span>            : 
<span class="lineNum">     811 </span>            :      /* Rotation if necessary. */
<span class="lineNum">     812 </span><span class="lineCov">          1 :   if( tp-&gt;glyphs-&gt;rot != 0) {</span>
<span class="lineNum">     813 </span>            :     mapserver::trans_affine mtx;
<span class="lineNum">     814 </span><span class="lineCov">          1 :     mtx *= mapserver::trans_affine_translation(-x/r-&gt;utfresolution,-y/r-&gt;utfresolution);</span>
<span class="lineNum">     815 </span><span class="lineCov">          1 :     mtx *= mapserver::trans_affine_rotation(-tp-&gt;glyphs-&gt;rot);</span>
<span class="lineNum">     816 </span><span class="lineCov">          1 :     mtx *= mapserver::trans_affine_translation(x/r-&gt;utfresolution,y/r-&gt;utfresolution);</span>
<span class="lineNum">     817 </span><span class="lineCov">          1 :     box.transform(mtx);</span>
<span class="lineNum">     818 </span>            :   } 
<span class="lineNum">     819 </span>            : 
<span class="lineNum">     820 </span>            : 
<span class="lineNum">     821 </span>            :   /* Rendering the symbol */
<span class="lineNum">     822 </span><span class="lineCov">          1 :   utfgridRenderPath(img, box);</span>
<span class="lineNum">     823 </span>            : 
<span class="lineNum">     824 </span>            :   return MS_SUCCESS;
<a name="825"><span class="lineNum">     825 </span>            : }</a>
<span class="lineNum">     826 </span>            : 
<span class="lineNum">     827 </span><span class="lineCov">          1 : int utfgridFreeSymbol(symbolObj * symbol)</span>
<span class="lineNum">     828 </span>            : {
<span class="lineNum">     829 </span><span class="lineCov">          1 :   return MS_SUCCESS;</span>
<span class="lineNum">     830 </span>            : }
<span class="lineNum">     831 </span>            : 
<span class="lineNum">     832 </span>            : /*
<a name="833"><span class="lineNum">     833 </span>            :  * Add the necessary functions for UTFGrid to the renderer VTable.</a>
<span class="lineNum">     834 </span>            :  */
<span class="lineNum">     835 </span><span class="lineCov">          1 : int msPopulateRendererVTableUTFGrid( rendererVTableObj *renderer )</span>
<span class="lineNum">     836 </span>            : {
<span class="lineNum">     837 </span><span class="lineCov">          1 :   renderer-&gt;default_transform_mode = MS_TRANSFORM_SIMPLIFY;</span>
<span class="lineNum">     838 </span>            : 
<span class="lineNum">     839 </span><span class="lineCov">          1 :   renderer-&gt;createImage = &amp;utfgridCreateImage;</span>
<span class="lineNum">     840 </span><span class="lineCov">          1 :   renderer-&gt;freeImage = &amp;utfgridFreeImage;</span>
<span class="lineNum">     841 </span><span class="lineCov">          1 :   renderer-&gt;saveImage = &amp;utfgridSaveImage;</span>
<span class="lineNum">     842 </span>            : 
<span class="lineNum">     843 </span><span class="lineCov">          1 :   renderer-&gt;startLayer = &amp;utfgridStartLayer;</span>
<span class="lineNum">     844 </span><span class="lineCov">          1 :   renderer-&gt;endLayer = &amp;utfgridEndLayer;</span>
<span class="lineNum">     845 </span>            : 
<span class="lineNum">     846 </span><span class="lineCov">          1 :   renderer-&gt;startShape = &amp;utfgridStartShape;</span>
<span class="lineNum">     847 </span><span class="lineCov">          1 :   renderer-&gt;endShape = &amp;utfgridEndShape;</span>
<span class="lineNum">     848 </span>            : 
<span class="lineNum">     849 </span><span class="lineCov">          1 :   renderer-&gt;renderPolygon = &amp;utfgridRenderPolygon;</span>
<span class="lineNum">     850 </span><span class="lineCov">          1 :   renderer-&gt;renderGlyphs = &amp;utfgridRenderGlyphs;</span>
<span class="lineNum">     851 </span><span class="lineCov">          1 :   renderer-&gt;renderLine = &amp;utfgridRenderLine;</span>
<span class="lineNum">     852 </span><span class="lineCov">          1 :   renderer-&gt;renderVectorSymbol = &amp;utfgridRenderVectorSymbol;</span>
<span class="lineNum">     853 </span><span class="lineCov">          1 :   renderer-&gt;renderPixmapSymbol = &amp;utfgridRenderPixmapSymbol;</span>
<span class="lineNum">     854 </span><span class="lineCov">          1 :   renderer-&gt;renderEllipseSymbol = &amp;utfgridRenderEllipseSymbol;</span>
<span class="lineNum">     855 </span>            : 
<span class="lineNum">     856 </span><span class="lineCov">          1 :   renderer-&gt;freeSymbol = &amp;utfgridFreeSymbol;</span>
<span class="lineNum">     857 </span>            : 
<span class="lineNum">     858 </span><span class="lineCov">          1 :   renderer-&gt;loadImageFromFile = msLoadMSRasterBufferFromFile;</span>
<a name="859"><span class="lineNum">     859 </span>            : </a>
<span class="lineNum">     860 </span><span class="lineCov">          1 :   return MS_SUCCESS;</span>
<span class="lineNum">     861 </span><span class="lineCov">          1 : }</span>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>
